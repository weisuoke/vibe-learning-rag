# 双重类比

> **用 TypeScript/Node.js 和日常生活类比理解 Provider 切换**

---

## 类比 1：Provider = 数据库驱动

### TypeScript/Node.js 类比

```typescript
// 不同数据库驱动，统一接口
interface DatabaseDriver {
  connect(): Promise<void>;
  query(sql: string): Promise<any>;
  disconnect(): Promise<void>;
}

class PostgresDriver implements DatabaseDriver {
  async connect() { /* Postgres 连接逻辑 */ }
  async query(sql: string) { /* Postgres 查询逻辑 */ }
  async disconnect() { /* Postgres 断开逻辑 */ }
}

class MySQLDriver implements DatabaseDriver {
  async connect() { /* MySQL 连接逻辑 */ }
  async query(sql: string) { /* MySQL 查询逻辑 */ }
  async disconnect() { /* MySQL 断开逻辑 */ }
}

// 应用代码不关心具体驱动
async function fetchUsers(driver: DatabaseDriver) {
  await driver.connect();
  const users = await driver.query('SELECT * FROM users');
  await driver.disconnect();
  return users;
}
```

**对应 Pi 的 Provider**：

```typescript
// 不同 LLM Provider，统一接口
interface LLMProvider {
  call(prompt: string): Promise<string>;
}

class AnthropicProvider implements LLMProvider {
  async call(prompt: string) { /* Anthropic API 调用 */ }
}

class OpenAIProvider implements LLMProvider {
  async call(prompt: string) { /* OpenAI API 调用 */ }
}

// 应用代码不关心具体 Provider
async function generateCode(provider: LLMProvider, spec: string) {
  return await provider.call(`Generate code: ${spec}`);
}
```

### 日常生活类比

**Provider 就像不同品牌的电源插座**：
- 美国插座（110V）= Anthropic
- 欧洲插座（220V）= OpenAI
- 中国插座（220V）= xAI

**转换器（Adapter）= Pi 的抽象层**：
- 统一接口，任何设备都能用
- 切换插座不需要换设备

---

## 类比 2：Scoped Models = npm scripts

### TypeScript/Node.js 类比

```json
// package.json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "test": "vitest"
  }
}
```

**快速执行**：

```bash
npm run dev    # 开发
npm run build  # 构建
npm run test   # 测试
```

**对应 Pi 的 Scoped Models**：

```json
// .pi/settings.json
{
  "scopedModels": [
    "claude-3-5-haiku-20241022",    // 快速开发
    "claude-3-5-sonnet-20241022",   // 正式构建
    "claude-opus-4-20250514"        // 测试验证
  ]
}
```

**快速切换**：

```bash
Ctrl+P         # 切换到 Sonnet
Ctrl+P         # 切换到 Opus
Shift+Ctrl+P   # 切回 Haiku
```

### 日常生活类比

**Scoped Models 就像电视遥控器的频道收藏**：
- 预设 3-5 个常看频道
- 按"收藏"键快速切换
- 不用每次输入频道号

---

## 类比 3：models.json = package.json

### TypeScript/Node.js 类比

```json
// package.json：定义项目依赖
{
  "dependencies": {
    "react": "^18.2.0",
    "typescript": "^5.0.0"
  },
  "devDependencies": {
    "vite": "^5.0.0"
  }
}
```

**对应 Pi 的 models.json**：

```json
// models.json：定义可用模型
{
  "providers": {
    "anthropic": {
      "models": {
        "claude-3-5-sonnet-20241022": { ... },
        "claude-3-5-haiku-20241022": { ... }
      }
    }
  }
}
```

### 日常生活类比

**models.json 就像通讯录**：
- 存储所有联系人信息
- 需要时快速查找
- 可以添加新联系人

---

## 类比 4：/model 命令 = 环境切换器

### TypeScript/Node.js 类比

```bash
# Node.js 版本切换
nvm use 18     # 切换到 Node 18
nvm use 20     # 切换到 Node 20

# 或使用交互式选择
nvm list
# 选择版本
```

**对应 Pi 的 /model 命令**：

```bash
> /model
# 显示所有可用模型
# 选择想要的模型
```

### 日常生活类比

**/model 命令就像换电视频道**：
- 打开频道列表
- 浏览所有频道
- 选择想看的频道

---

## 类比 5：配置优先级 = CSS 优先级

### TypeScript/Node.js 类比

```css
/* CSS 优先级 */
p { color: blue; }              /* 元素选择器 */
.text { color: green; }         /* 类选择器 */
#title { color: red; }          /* ID 选择器 */
p { color: yellow !important; } /* !important */

/* 优先级：!important > ID > 类 > 元素 */
```

**对应 Pi 的配置优先级**：

```
运行时命令 (/model)           > !important
CLI 参数 (--model)            > ID 选择器
项目配置 (.pi/settings.json) > 类选择器
全局配置 (~/.pi/agent/)       > 元素选择器
```

### 日常生活类比

**配置优先级就像穿衣服的层次**：
- 外套（运行时命令）：最外层，最优先
- 毛衣（CLI 参数）：第二层
- 衬衫（项目配置）：第三层
- 内衣（全局配置）：最内层

---

## 类比 6：热重载 = nodemon

### TypeScript/Node.js 类比

```bash
# nodemon：文件变化自动重启
nodemon server.ts

# 修改 server.ts
# nodemon 自动检测并重启
```

**对应 Pi 的热重载**：

```bash
# Pi 运行中
pi

# 修改 models.json
vim ~/.pi/agent/models.json

# 重载配置（无需重启）
> /reload
```

### 日常生活类比

**热重载就像更新手机通讯录**：
- 添加新联系人
- 不需要重启手机
- 立即生效

---

## 类比 7：Fallback 链 = try-catch 链

### TypeScript/Node.js 类比

```typescript
async function fetchData(url: string): Promise<any> {
  try {
    // 主服务器
    return await fetch('https://api.primary.com');
  } catch (error) {
    try {
      // 备用服务器 1
      return await fetch('https://api.backup1.com');
    } catch (error) {
      try {
        // 备用服务器 2
        return await fetch('https://api.backup2.com');
      } catch (error) {
        // 本地缓存
        return loadFromCache();
      }
    }
  }
}
```

**对应 Pi 的 Fallback 链**：

```typescript
const fallbackChain = [
  'claude-3-5-sonnet-20241022',  // 主模型
  'gpt-4o',                       // 备用 1
  'claude-3-5-haiku-20241022',    // 备用 2
  'llama3.1:8b'                   // 本地备用
];
```

### 日常生活类比

**Fallback 链就像出行方式选择**：
- 首选：打车（快但贵）
- 备选 1：地铁（平衡）
- 备选 2：公交（慢但便宜）
- 最后：步行（免费）

---

## 类比 8：成本优化 = 云服务器选型

### TypeScript/Node.js 类比

```typescript
// AWS EC2 实例选型
const instanceTypes = {
  t2.micro: { cpu: 1, ram: 1, cost: 0.0116 },   // 开发测试
  t2.medium: { cpu: 2, ram: 4, cost: 0.0464 },  // 小型应用
  c5.xlarge: { cpu: 4, ram: 8, cost: 0.17 }     // 生产环境
};

// 根据负载选择实例
function selectInstance(load: 'low' | 'medium' | 'high') {
  if (load === 'low') return 't2.micro';
  if (load === 'medium') return 't2.medium';
  return 'c5.xlarge';
}
```

**对应 Pi 的成本优化**：

```typescript
const modelCosts = {
  haiku: { performance: 'good', cost: 0.8 },
  sonnet: { performance: 'better', cost: 3.0 },
  opus: { performance: 'best', cost: 15.0 }
};

function selectModel(complexity: 'simple' | 'medium' | 'complex') {
  if (complexity === 'simple') return 'haiku';
  if (complexity === 'medium') return 'sonnet';
  return 'opus';
}
```

### 日常生活类比

**成本优化就像选择交通工具**：
- 去楼下便利店：步行（免费）
- 去市区办事：地铁（便宜）
- 去机场赶飞机：打车（贵但快）

---

## 类比 9：CLI 参数 = 命令行参数

### TypeScript/Node.js 类比

```bash
# Node.js 启动参数
node server.js --port 3000 --env production

# TypeScript 编译参数
tsc --target ES2020 --module commonjs
```

**对应 Pi 的 CLI 参数**：

```bash
# Pi 启动参数
pi --provider anthropic --model claude-3-5-sonnet-20241022
```

### 日常生活类比

**CLI 参数就像点餐时的特殊要求**：
- 基础：一杯咖啡
- 参数：大杯、少糖、加冰

---

## 类比 10：项目配置 = .env 文件

### TypeScript/Node.js 类比

```bash
# .env：项目特定配置
DATABASE_URL=postgresql://localhost/mydb
API_KEY=secret123
NODE_ENV=development
```

**对应 Pi 的项目配置**：

```json
// .pi/settings.json：项目特定配置
{
  "defaultModel": "llama3.1:8b",
  "scopedModels": [
    "llama3.1:8b",
    "claude-3-5-haiku-20241022"
  ]
}
```

### 日常生活类比

**项目配置就像房间的个性化设置**：
- 卧室：暖色灯光、柔和音乐
- 书房：白色灯光、安静环境
- 客厅：明亮灯光、背景音乐

---

## 综合类比：完整工作流

### TypeScript/Node.js 类比

```typescript
// 1. 安装依赖（配置 Provider）
npm install

// 2. 配置环境（设置 API Key）
cp .env.example .env

// 3. 启动开发服务器（启动 Pi）
npm run dev

// 4. 切换环境（切换模型）
export NODE_ENV=production

// 5. 热重载（重载配置）
# nodemon 自动重启
```

### 日常生活类比

**完整工作流就像开车**：
1. **上车**：启动 Pi
2. **选择目的地**：选择模型
3. **导航**：Scoped Models 快速切换
4. **路况调整**：根据任务复杂度切换模型
5. **加油**：监控成本
6. **到达**：完成任务

---

## 记忆技巧

### 技巧 1：联想记忆

- **Provider** → 数据库驱动 → 不同品牌插座
- **Scoped Models** → npm scripts → 电视频道收藏
- **models.json** → package.json → 通讯录

### 技巧 2：场景记忆

**开发场景**：
```
启动项目 (npm run dev) = 启动 Pi
切换环境 (NODE_ENV) = 切换模型
热重载 (nodemon) = /reload
```

**日常场景**：
```
换电视频道 = /model
频道收藏 = Scoped Models
遥控器 = Ctrl+P
```

---

## 下一步

- **反直觉点**：阅读 [06_反直觉点.md](./06_反直觉点.md)
- **实战代码**：阅读 [07_实战代码_01_基础Provider配置.md](./07_实战代码_01_基础Provider配置.md)

---

**记住**：类比是理解工具，理解原理后要回到实际使用。
