# 实战代码2：健康检查实现

> 完整的 Milvus 健康检查实现，包括 Liveness 和 Readiness 探针

---

## 场景说明

本示例演示如何为 Milvus 实现完整的健康检查系统：
- Liveness 探针（检测进程是否存活）
- Readiness 探针（检测服务是否就绪）
- 自定义健康检查逻辑
- Kubernetes 集成
- 健康检查监控

---

## 完整代码

### 1. 健康检查服务实现

**health_check_server.py：**

```python
"""
Milvus 健康检查服务
提供 Liveness 和 Readiness 探针端点
"""

from flask import Flask, jsonify, Response
from pymilvus import connections, utility, Collection
import psutil
import time
import threading
import logging

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# ===== 全局状态 =====
class HealthStatus:
    def __init__(self):
        self.is_alive = True
        self.is_ready = False
        self.last_check_time = 0
        self.check_interval = 10  # 缓存 10 秒
        self.dependencies = {
            "milvus": "unknown",
            "collections": []
        }
        self.system_resources = {
            "memory_percent": 0,
            "cpu_percent": 0,
            "disk_percent": 0
        }

health_status = HealthStatus()

# ===== Liveness 探针 =====
@app.route('/healthz', methods=['GET'])
def liveness():
    """
    Liveness 探针：检查进程是否存活

    只检查进程本身，不检查依赖服务
    失败 → 容器重启
    """
    if health_status.is_alive:
        return Response("OK", status=200, mimetype='text/plain')
    else:
        return Response("Service is dead", status=500, mimetype='text/plain')

# ===== Readiness 探针 =====
@app.route('/readyz', methods=['GET'])
def readiness():
    """
    Readiness 探针：检查服务是否就绪

    检查依赖服务和资源状态
    失败 → 停止流量，但不重启
    """
    # 使用缓存避免频繁检查
    current_time = time.time()
    if current_time - health_status.last_check_time < health_status.check_interval:
        if health_status.is_ready:
            return jsonify({
                "status": "ready",
                "dependencies": health_status.dependencies,
                "resources": health_status.system_resources,
                "cached": True
            }), 200
        else:
            return jsonify({
                "status": "not_ready",
                "dependencies": health_status.dependencies,
                "resources": health_status.system_resources,
                "cached": True
            }), 503

    # 执行健康检查
    check_result = perform_readiness_check()
    health_status.last_check_time = current_time

    if check_result["ready"]:
        health_status.is_ready = True
        return jsonify({
            "status": "ready",
            "dependencies": check_result["dependencies"],
            "resources": check_result["resources"],
            "cached": False
        }), 200
    else:
        health_status.is_ready = False
        return jsonify({
            "status": "not_ready",
            "reason": check_result["reason"],
            "dependencies": check_result["dependencies"],
            "resources": check_result["resources"],
            "cached": False
        }), 503

# ===== 详细健康状态 =====
@app.route('/health', methods=['GET'])
def health():
    """
    详细健康状态端点
    返回完整的健康检查信息
    """
    check_result = perform_readiness_check()

    return jsonify({
        "liveness": health_status.is_alive,
        "readiness": check_result["ready"],
        "dependencies": check_result["dependencies"],
        "resources": check_result["resources"],
        "timestamp": time.time()
    }), 200

# ===== 健康检查逻辑 =====
def perform_readiness_check():
    """
    执行 Readiness 检查

    检查项：
    1. Milvus 连接
    2. Collection 状态
    3. 系统资源
    """
    result = {
        "ready": True,
        "reason": None,
        "dependencies": {},
        "resources": {}
    }

    # 1. 检查 Milvus 连接
    milvus_status = check_milvus_connection()
    result["dependencies"]["milvus"] = milvus_status

    if milvus_status["status"] != "healthy":
        result["ready"] = False
        result["reason"] = f"Milvus connection failed: {milvus_status.get('error', 'unknown')}"
        return result

    # 2. 检查 Collection 状态
    collections_status = check_collections()
    result["dependencies"]["collections"] = collections_status

    # 3. 检查系统资源
    resources_status = check_system_resources()
    result["resources"] = resources_status

    # 检查资源是否充足
    if resources_status["memory_percent"] > 90:
        result["ready"] = False
        result["reason"] = f"Memory usage too high: {resources_status['memory_percent']}%"
        return result

    if resources_status["disk_percent"] > 95:
        result["ready"] = False
        result["reason"] = f"Disk usage too high: {resources_status['disk_percent']}%"
        return result

    # 更新全局状态
    health_status.dependencies = result["dependencies"]
    health_status.system_resources = result["resources"]

    return result

def check_milvus_connection():
    """检查 Milvus 连接"""
    try:
        # 尝试连接 Milvus
        connections.connect(
            alias="health_check",
            host="localhost",
            port="19530",
            timeout=3
        )

        # 测试连接是否可用
        collections = utility.list_collections()

        # 断开连接
        connections.disconnect("health_check")

        return {
            "status": "healthy",
            "collections_count": len(collections)
        }

    except Exception as e:
        logger.error(f"Milvus connection check failed: {e}")
        return {
            "status": "unhealthy",
            "error": str(e)
        }

def check_collections():
    """检查 Collection 状态"""
    try:
        connections.connect(
            alias="health_check",
            host="localhost",
            port="19530",
            timeout=3
        )

        collections = utility.list_collections()
        collection_status = []

        for collection_name in collections:
            try:
                collection = Collection(collection_name)
                load_state = utility.load_state(collection_name)

                collection_status.append({
                    "name": collection_name,
                    "loaded": load_state.name == "Loaded",
                    "num_entities": collection.num_entities
                })
            except Exception as e:
                collection_status.append({
                    "name": collection_name,
                    "error": str(e)
                })

        connections.disconnect("health_check")

        return {
            "total": len(collections),
            "collections": collection_status
        }

    except Exception as e:
        logger.error(f"Collections check failed: {e}")
        return {
            "error": str(e)
        }

def check_system_resources():
    """检查系统资源"""
    try:
        # 内存使用
        memory = psutil.virtual_memory()

        # CPU 使用（1 秒采样）
        cpu_percent = psutil.cpu_percent(interval=1)

        # 磁盘使用
        disk = psutil.disk_usage('/')

        return {
            "memory_percent": round(memory.percent, 2),
            "memory_available_gb": round(memory.available / (1024**3), 2),
            "cpu_percent": round(cpu_percent, 2),
            "disk_percent": round(disk.percent, 2),
            "disk_free_gb": round(disk.free / (1024**3), 2)
        }

    except Exception as e:
        logger.error(f"System resources check failed: {e}")
        return {
            "error": str(e)
        }

# ===== 后台健康检查线程 =====
def background_health_check():
    """
    后台线程定期执行健康检查
    更新全局状态
    """
    while True:
        try:
            # 执行健康检查
            check_result = perform_readiness_check()

            # 更新全局状态
            health_status.is_ready = check_result["ready"]

            # 记录日志
            if check_result["ready"]:
                logger.info("Health check passed")
            else:
                logger.warning(f"Health check failed: {check_result['reason']}")

        except Exception as e:
            logger.error(f"Background health check error: {e}")
            health_status.is_ready = False

        # 等待下一次检查
        time.sleep(30)

# ===== 启动服务 =====
if __name__ == '__main__':
    # 启动后台健康检查线程
    health_thread = threading.Thread(target=background_health_check, daemon=True)
    health_thread.start()

    logger.info("Health check server starting on :9091")

    # 启动 Flask 服务
    app.run(host='0.0.0.0', port=9091, debug=False)
```

---

### 2. Kubernetes 健康检查配置

**kubernetes/milvus-deployment.yaml：**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: milvus-standalone
  labels:
    app: milvus
    component: standalone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: milvus
      component: standalone
  template:
    metadata:
      labels:
        app: milvus
        component: standalone
    spec:
      containers:
      - name: milvus
        image: milvusdb/milvus:v2.3.3
        command: ["milvus", "run", "standalone"]
        ports:
        - containerPort: 19530
          name: grpc
        - containerPort: 9091
          name: metrics

        # ===== Liveness 探针 =====
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9091
            scheme: HTTP
          initialDelaySeconds: 90   # 启动后等待 90 秒
          periodSeconds: 30          # 每 30 秒检查一次
          timeoutSeconds: 10         # 超时 10 秒
          successThreshold: 1        # 成功 1 次即为健康
          failureThreshold: 3        # 连续失败 3 次才重启

        # ===== Readiness 探针 =====
        readinessProbe:
          httpGet:
            path: /readyz
            port: 9091
            scheme: HTTP
          initialDelaySeconds: 30    # 启动后等待 30 秒
          periodSeconds: 10          # 每 10 秒检查一次
          timeoutSeconds: 5          # 超时 5 秒
          successThreshold: 1        # 成功 1 次即为就绪
          failureThreshold: 2        # 连续失败 2 次才停止流量

        # ===== 启动探针（可选）=====
        # 用于慢启动的应用
        startupProbe:
          httpGet:
            path: /healthz
            port: 9091
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 30       # 最多等待 300 秒（30 * 10）

        # 资源限制
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"

        # 环境变量
        env:
        - name: ETCD_ENDPOINTS
          value: "etcd:2379"
        - name: MINIO_ADDRESS
          value: "minio:9000"

        # 卷挂载
        volumeMounts:
        - name: milvus-data
          mountPath: /var/lib/milvus

      volumes:
      - name: milvus-data
        persistentVolumeClaim:
          claimName: milvus-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: milvus
  labels:
    app: milvus
spec:
  type: ClusterIP
  ports:
  - port: 19530
    targetPort: 19530
    name: grpc
  - port: 9091
    targetPort: 9091
    name: metrics
  selector:
    app: milvus
    component: standalone
```

---

### 3. Docker Compose 健康检查配置

**docker-compose-health.yml：**

```yaml
version: '3.8'

services:
  milvus:
    image: milvusdb/milvus:v2.3.3
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus-data:/var/lib/milvus
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000

    # ===== Docker 健康检查 =====
    healthcheck:
      # 检查命令
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]

      # 启动后等待时间
      start_period: 90s

      # 检查间隔
      interval: 30s

      # 超时时间
      timeout: 10s

      # 失败重试次数
      retries: 3

    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
    volumes:
      - etcd-data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/minio_data
    command: minio server /minio_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  milvus-data:
  etcd-data:
  minio-data:
```

---

### 4. 健康检查测试脚本

**test_health_check.py：**

```python
"""
健康检查测试脚本
验证 Liveness 和 Readiness 探针是否正常工作
"""

import requests
import time
import json

def test_liveness():
    """测试 Liveness 探针"""
    print("=== 测试 Liveness 探针 ===")

    try:
        response = requests.get("http://localhost:9091/healthz", timeout=5)

        if response.status_code == 200:
            print("✅ Liveness 探针正常")
            print(f"   响应: {response.text}")
            return True
        else:
            print(f"❌ Liveness 探针失败: {response.status_code}")
            return False

    except Exception as e:
        print(f"❌ 无法连接 Liveness 端点: {e}")
        return False

def test_readiness():
    """测试 Readiness 探针"""
    print("\n=== 测试 Readiness 探针 ===")

    try:
        response = requests.get("http://localhost:9091/readyz", timeout=5)

        if response.status_code == 200:
            print("✅ Readiness 探针正常")
            data = response.json()
            print(f"   状态: {data['status']}")
            print(f"   依赖服务:")
            print(f"     - Milvus: {data['dependencies']['milvus']['status']}")
            print(f"   系统资源:")
            print(f"     - 内存使用: {data['resources']['memory_percent']}%")
            print(f"     - CPU 使用: {data['resources']['cpu_percent']}%")
            print(f"     - 磁盘使用: {data['resources']['disk_percent']}%")
            return True
        elif response.status_code == 503:
            print("⚠️ Readiness 探针未就绪")
            data = response.json()
            print(f"   原因: {data.get('reason', 'unknown')}")
            return False
        else:
            print(f"❌ Readiness 探针失败: {response.status_code}")
            return False

    except Exception as e:
        print(f"❌ 无法连接 Readiness 端点: {e}")
        return False

def test_detailed_health():
    """测试详细健康状态端点"""
    print("\n=== 测试详细健康状态 ===")

    try:
        response = requests.get("http://localhost:9091/health", timeout=5)

        if response.status_code == 200:
            data = response.json()
            print("✅ 详细健康状态:")
            print(json.dumps(data, indent=2))
            return True
        else:
            print(f"❌ 详细健康状态失败: {response.status_code}")
            return False

    except Exception as e:
        print(f"❌ 无法连接健康状态端点: {e}")
        return False

def test_health_check_caching():
    """测试健康检查缓存"""
    print("\n=== 测试健康检查缓存 ===")

    # 第一次请求
    start_time = time.time()
    response1 = requests.get("http://localhost:9091/readyz")
    duration1 = time.time() - start_time

    # 第二次请求（应该使用缓存）
    start_time = time.time()
    response2 = requests.get("http://localhost:9091/readyz")
    duration2 = time.time() - start_time

    print(f"第一次请求耗时: {duration1:.3f} 秒")
    print(f"第二次请求耗时: {duration2:.3f} 秒")

    if response2.json().get('cached'):
        print("✅ 缓存机制正常工作")
        return True
    else:
        print("⚠️ 缓存未生效")
        return False

def test_failure_scenario():
    """测试故障场景"""
    print("\n=== 测试故障场景 ===")

    # 模拟 Milvus 不可用（需要手动停止 Milvus）
    print("请手动停止 Milvus 服务，然后按 Enter 继续...")
    input()

    # 测试 Readiness 探针
    response = requests.get("http://localhost:9091/readyz")

    if response.status_code == 503:
        print("✅ Readiness 探针正确检测到 Milvus 不可用")
        data = response.json()
        print(f"   原因: {data.get('reason', 'unknown')}")
        return True
    else:
        print("❌ Readiness 探针未能检测到 Milvus 不可用")
        return False

def main():
    """主函数"""
    print("=" * 60)
    print("健康检查测试脚本")
    print("=" * 60)

    results = []

    # 1. 测试 Liveness 探针
    results.append(("Liveness", test_liveness()))

    # 2. 测试 Readiness 探针
    results.append(("Readiness", test_readiness()))

    # 3. 测试详细健康状态
    results.append(("Detailed Health", test_detailed_health()))

    # 4. 测试缓存机制
    results.append(("Caching", test_health_check_caching()))

    # 5. 测试故障场景（可选）
    print("\n是否测试故障场景？(y/n)")
    if input().lower() == 'y':
        results.append(("Failure Scenario", test_failure_scenario()))

    # 总结
    print("\n" + "=" * 60)
    print("测试总结")
    print("=" * 60)

    for name, result in results:
        status = "✅ 通过" if result else "❌ 失败"
        print(f"{name}: {status}")

    passed = sum(1 for _, result in results if result)
    total = len(results)
    print(f"\n通过率: {passed}/{total} ({passed/total*100:.1f}%)")

if __name__ == "__main__":
    main()
```

---

## 部署和测试

### 步骤1：启动健康检查服务

```bash
# 安装依赖
pip install flask pymilvus psutil requests

# 启动健康检查服务
python health_check_server.py
```

---

### 步骤2：测试健康检查

```bash
# 在另一个终端运行测试
python test_health_check.py
```

---

### 步骤3：查看 Docker 健康状态

```bash
# 启动 Docker Compose
docker-compose -f docker-compose-health.yml up -d

# 查看容器健康状态
docker ps

# 输出示例：
# CONTAINER ID   STATUS
# abc123         Up 5 minutes (healthy)

# 查看健康检查日志
docker inspect --format='{{json .State.Health}}' <container_id> | jq
```

---

## 预期输出

```
============================================================
健康检查测试脚本
============================================================
=== 测试 Liveness 探针 ===
✅ Liveness 探针正常
   响应: OK

=== 测试 Readiness 探针 ===
✅ Readiness 探针正常
   状态: ready
   依赖服务:
     - Milvus: healthy
   系统资源:
     - 内存使用: 45.2%
     - CPU 使用: 12.5%
     - 磁盘使用: 35.8%

=== 测试详细健康状态 ===
✅ 详细健康状态:
{
  "liveness": true,
  "readiness": true,
  "dependencies": {
    "milvus": {
      "status": "healthy",
      "collections_count": 3
    },
    "collections": {
      "total": 3,
      "collections": [
        {
          "name": "knowledge_base",
          "loaded": true,
          "num_entities": 10000
        }
      ]
    }
  },
  "resources": {
    "memory_percent": 45.2,
    "memory_available_gb": 8.5,
    "cpu_percent": 12.5,
    "disk_percent": 35.8,
    "disk_free_gb": 120.3
  },
  "timestamp": 1707567890.123
}

=== 测试健康检查缓存 ===
第一次请求耗时: 0.234 秒
第二次请求耗时: 0.012 秒
✅ 缓存机制正常工作

============================================================
测试总结
============================================================
Liveness: ✅ 通过
Readiness: ✅ 通过
Detailed Health: ✅ 通过
Caching: ✅ 通过

通过率: 4/4 (100.0%)
```

---

## 在 RAG 系统中的应用

### RAG 服务健康检查

```python
"""
RAG 服务的健康检查实现
"""

from flask import Flask, jsonify
from pymilvus import connections, Collection
import openai

app = Flask(__name__)

@app.route('/healthz')
def liveness():
    """Liveness 探针"""
    return "OK", 200

@app.route('/readyz')
def readiness():
    """Readiness 探针"""
    checks = {}

    # 检查 Milvus
    try:
        connections.connect(host="localhost", port="19530", timeout=3)
        collection = Collection("knowledge_base")
        checks["milvus"] = {
            "status": "healthy",
            "loaded": collection.is_loaded,
            "num_entities": collection.num_entities
        }
        connections.disconnect()
    except Exception as e:
        checks["milvus"] = {"status": "unhealthy", "error": str(e)}

    # 检查 OpenAI API
    try:
        openai.Embedding.create(model="text-embedding-3-small", input="test")
        checks["openai"] = {"status": "healthy"}
    except Exception as e:
        checks["openai"] = {"status": "unhealthy", "error": str(e)}

    # 判断整体状态
    all_healthy = all(c["status"] == "healthy" for c in checks.values())

    if all_healthy:
        return jsonify({"status": "ready", "checks": checks}), 200
    else:
        return jsonify({"status": "not_ready", "checks": checks}), 503

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
```

---

## 小结

本实战示例展示了：

1. **完整的健康检查服务**：Liveness + Readiness + 详细状态
2. **Kubernetes 集成**：完整的探针配置
3. **Docker Compose 集成**：健康检查和依赖管理
4. **自动化测试**：验证健康检查是否正常工作
5. **RAG 集成**：为 RAG 服务添加健康检查

**关键要点：**
- Liveness 只检查进程本身
- Readiness 检查依赖服务和资源
- 使用缓存避免频繁检查
- 合理配置检查频率和阈值

---

**下一步：** [07_实战代码_03_Grafana仪表盘配置](./07_实战代码_03_Grafana仪表盘配置.md)
