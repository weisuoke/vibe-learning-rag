# 双重类比

用前端开发和日常生活的熟悉概念，理解检索器设计。

---

## 类比1：检索器 = 搜索引擎

### 前端类比：搜索框组件

```
RAG 检索器                    前端搜索框
─────────────────────────────────────────
用户查询                      用户输入关键词
向量化查询                    解析搜索词
相似度匹配                    模糊匹配/过滤
Top-K 结果                    搜索结果列表
相似度分数                    匹配度/相关性分数
```

```javascript
// 前端搜索框的工作方式
function searchProducts(query, products) {
  // 1. 解析查询
  const keywords = query.toLowerCase().split(' ');

  // 2. 计算匹配分数
  const results = products.map(product => ({
    product,
    score: calculateMatchScore(keywords, product)
  }));

  // 3. 排序并返回 Top-K
  return results
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);  // Top-10
}
```

```python
# RAG 检索器的工作方式（几乎一样！）
def retrieve(query, documents, k=10):
    # 1. 向量化查询
    query_vec = embed(query)

    # 2. 计算相似度分数
    results = []
    for doc in documents:
        score = cosine_similarity(query_vec, doc.vector)
        results.append({"doc": doc, "score": score})

    # 3. 排序并返回 Top-K
    results.sort(key=lambda x: x["score"], reverse=True)
    return results[:k]
```

### 日常生活类比：图书馆找书

```
场景：你去图书馆找"Python 编程"相关的书

你（用户）："我想找 Python 编程的书"
    ↓
图书管理员（检索器）：
    1. 理解你的需求（查询理解）
    2. 在书架上找相关的书（相似度匹配）
    3. 挑出最相关的 5 本（Top-K）
    4. 按相关性排序推荐给你（结果排序）
    ↓
你拿到 5 本最相关的书（检索结果）
```

---

## 类比2：向量检索 vs 关键词检索

### 前端类比：模糊搜索 vs 精确搜索

```javascript
// 精确搜索（类似关键词检索）
function exactSearch(query, items) {
  return items.filter(item =>
    item.name.includes(query)  // 必须包含完全相同的词
  );
}

// 模糊搜索（类似向量检索）
function fuzzySearch(query, items) {
  return items.filter(item =>
    levenshteinDistance(query, item.name) < 3  // 允许一定的差异
  );
}
```

| 搜索类型 | 查询 "休假" | 结果 |
|----------|-------------|------|
| 精确搜索 | "休假" | 只匹配包含"休假"的文档 |
| 模糊搜索 | "休假" | 匹配"年假"、"请假"、"假期"等语义相近的文档 |

### 日常生活类比：找餐厅

```
场景：你想吃"意大利面"

关键词检索（精确匹配）：
- 只找菜单上写着"意大利面"的餐厅
- 可能错过写着"Pasta"、"通心粉"的餐厅

向量检索（语义匹配）：
- 找所有"意大利面类"的餐厅
- 包括 Pasta、通心粉、千层面、意面等
- 甚至可能推荐"西餐厅"（因为语义相关）
```

---

## 类比3：Top-K 参数

### 前端类比：分页 pageSize

```javascript
// 前端分页
const pageSize = 10;  // 每页显示 10 条
const results = searchResults.slice(0, pageSize);

// RAG Top-K
const k = 10;  // 返回 Top-10
const results = retriever.retrieve(query, k);
```

| 前端分页 | RAG Top-K |
|----------|-----------|
| pageSize = 5 | k = 5 |
| 显示前 5 条结果 | 返回最相关的 5 个文档 |
| 太少：用户可能找不到想要的 | 太少：可能漏掉相关内容 |
| 太多：页面加载慢 | 太多：消耗更多 Token |

### 日常生活类比：面试筛选简历

```
场景：HR 筛选简历

Top-K = 3（太少）：
- 只面试 3 个人
- 可能错过优秀候选人

Top-K = 100（太多）：
- 面试 100 个人
- 浪费大量时间和资源

Top-K = 10（合适）：
- 面试 10 个最匹配的候选人
- 平衡效率和覆盖率
```

---

## 类比4：相似度阈值

### 前端类比：表单验证

```javascript
// 前端表单验证：分数必须 >= 60 才及格
function validateScore(score) {
  const threshold = 60;
  return score >= threshold;
}

// RAG 相似度阈值：相似度必须 >= 0.7 才返回
function filterByThreshold(results, threshold = 0.7) {
  return results.filter(r => r.score >= threshold);
}
```

### 日常生活类比：考试及格线

```
场景：考试成绩筛选

没有及格线：
- 所有人都"通过"
- 包括 10 分、20 分的人
- 质量无法保证

有及格线（60分）：
- 只有 >= 60 分的人通过
- 保证了基本质量

RAG 相似度阈值同理：
- 阈值 0.7 = 只返回相似度 >= 70% 的结果
- 过滤掉不相关的内容
```

---

## 类比5：MMR 多样性

### 前端类比：推荐系统去重

```javascript
// 电商推荐：避免推荐太相似的商品
function diverseRecommendations(products, k) {
  const selected = [];

  for (const product of products) {
    // 检查是否与已选商品太相似
    const tooSimilar = selected.some(
      p => similarity(p, product) > 0.9
    );

    if (!tooSimilar) {
      selected.push(product);
    }

    if (selected.length >= k) break;
  }

  return selected;
}
```

### 日常生活类比：点菜多样性

```
场景：在餐厅点 5 道菜

没有多样性考虑：
1. 红烧肉
2. 梅菜扣肉（和红烧肉很像）
3. 东坡肉（还是肉）
4. 糖醋排骨（又是肉）
5. 酱肘子（全是肉！）

有多样性考虑（MMR）：
1. 红烧肉（肉类）
2. 清蒸鱼（海鲜）
3. 蒜蓉西兰花（蔬菜）
4. 番茄蛋汤（汤类）
5. 米饭（主食）

MMR 就是确保检索结果覆盖不同方面，而不是返回一堆重复内容。
```

---

## 类比6：混合检索

### 前端类比：多条件筛选

```javascript
// 电商搜索：同时考虑关键词匹配和用户偏好
function hybridSearch(query, products, userPreferences) {
  return products
    .map(product => ({
      product,
      // 混合分数 = 关键词匹配 + 用户偏好
      score: 0.5 * keywordMatch(query, product) +
             0.5 * preferenceMatch(userPreferences, product)
    }))
    .sort((a, b) => b.score - a.score);
}
```

### 日常生活类比：找对象

```
场景：相亲找对象

只看"硬条件"（关键词检索）：
- 身高 175+、学历本科+、有房有车
- 可能错过其他方面很合适的人

只看"感觉"（向量检索）：
- 聊得来、有眼缘、三观合
- 可能忽略重要的现实条件

混合考虑（混合检索）：
- 硬条件占 50%
- 感觉占 50%
- 综合评分最高的优先考虑
```

---

## 类比总结表

| RAG 概念 | 前端类比 | 日常生活类比 |
|----------|----------|--------------|
| 检索器 | 搜索框组件 | 图书管理员 |
| 向量检索 | 模糊搜索 | 找"意思相近"的东西 |
| 关键词检索 | 精确搜索 | 找"词一样"的东西 |
| 混合检索 | 多条件筛选 | 综合考虑多个因素 |
| Top-K | 分页 pageSize | 面试筛选人数 |
| 相似度阈值 | 表单验证阈值 | 考试及格线 |
| MMR | 推荐去重 | 点菜要多样化 |

---

## 完整流程类比

```
RAG 检索流程                    找工作流程
─────────────────────────────────────────────────────
用户提问                        求职者投简历
    ↓                              ↓
查询向量化                      HR 理解求职意向
    ↓                              ↓
向量检索                        按技能匹配岗位
    ↓                              ↓
关键词检索                      按关键词筛选（学历、经验）
    ↓                              ↓
混合融合                        综合评分
    ↓                              ↓
Top-K 筛选                      选出 Top-10 候选人
    ↓                              ↓
相似度阈值                      淘汰不达标的
    ↓                              ↓
MMR 多样性                      确保不同部门都有候选人
    ↓                              ↓
返回结果                        发面试邀请
```

---

**下一步：** [06_反直觉点](./06_反直觉点.md) - 避免检索器设计中的常见误区
