# 实战代码3：工具调用实现

> 实现完整的工具调用系统

---

## 目标

使用 TypeBox 定义工具 Schema，实现参数验证和工具执行。

---

## 完整代码

```typescript
/**
 * 工具调用实现
 * 演示：TypeBox Schema + 参数验证 + 工具执行
 */

import { Type, Static } from '@sinclair/typebox';
import { Value } from '@sinclair/typebox/value';

// ===== 1. 定义工具 =====

const weatherTool = {
  name: 'get_weather',
  description: 'Get current weather for a location',
  parameters: Type.Object({
    location: Type.String({ description: 'City name' }),
    unit: Type.Optional(Type.Union([
      Type.Literal('celsius'),
      Type.Literal('fahrenheit')
    ], { default: 'celsius' }))
  }),
  execute: async (input: any) => {
    // 模拟 API 调用
    return {
      location: input.location,
      temperature: 22,
      unit: input.unit || 'celsius',
      condition: 'sunny'
    };
  }
};

const calculatorTool = {
  name: 'calculate',
  description: 'Perform basic arithmetic',
  parameters: Type.Object({
    operation: Type.Union([
      Type.Literal('add'),
      Type.Literal('subtract'),
      Type.Literal('multiply'),
      Type.Literal('divide')
    ]),
    a: Type.Number(),
    b: Type.Number()
  }),
  execute: async (input: any) => {
    const { operation, a, b } = input;
    switch (operation) {
      case 'add': return { result: a + b };
      case 'subtract': return { result: a - b };
      case 'multiply': return { result: a * b };
      case 'divide': return { result: a / b };
    }
  }
};

// ===== 2. 工具执行器 =====

class ToolExecutor {
  private tools = new Map<string, any>();

  register(tool: any): void {
    this.tools.set(tool.name, tool);
  }

  validate(toolName: string, input: any): { valid: boolean; errors?: any[] } {
    const tool = this.tools.get(toolName);
    if (!tool) {
      return { valid: false, errors: [{ message: `Tool ${toolName} not found` }] };
    }

    const valid = Value.Check(tool.parameters, input);
    if (!valid) {
      const errors = [...Value.Errors(tool.parameters, input)];
      return { valid: false, errors };
    }

    return { valid: true };
  }

  async execute(toolName: string, input: any): Promise<any> {
    // 验证参数
    const validation = this.validate(toolName, input);
    if (!validation.valid) {
      throw new Error(`Invalid parameters: ${JSON.stringify(validation.errors)}`);
    }

    // 执行工具
    const tool = this.tools.get(toolName)!;
    return await tool.execute(input);
  }
}

// ===== 3. 使用示例 =====

async function main() {
  const executor = new ToolExecutor();
  executor.register(weatherTool);
  executor.register(calculatorTool);

  console.log('=== 工具调用示例 ===\n');

  // 示例1：有效的工具调用
  console.log('1. 查询天气（有效）');
  try {
    const result = await executor.execute('get_weather', {
      location: 'Tokyo',
      unit: 'celsius'
    });
    console.log('结果:', JSON.stringify(result, null, 2));
  } catch (error) {
    console.error('错误:', error.message);
  }

  // 示例2：无效的参数（错误的 unit）
  console.log('\n2. 查询天气（无效 unit）');
  try {
    const result = await executor.execute('get_weather', {
      location: 'Tokyo',
      unit: 'kelvin'  // ❌ 不是 celsius 或 fahrenheit
    });
    console.log('结果:', JSON.stringify(result, null, 2));
  } catch (error) {
    console.error('错误:', error.message);
  }

  // 示例3：缺少必填参数
  console.log('\n3. 查询天气（缺少 location）');
  try {
    const result = await executor.execute('get_weather', {
      unit: 'celsius'
    });
    console.log('结果:', JSON.stringify(result, null, 2));
  } catch (error) {
    console.error('错误:', error.message);
  }

  // 示例4：计算器工具
  console.log('\n4. 计算器（有效）');
  try {
    const result = await executor.execute('calculate', {
      operation: 'multiply',
      a: 6,
      b: 7
    });
    console.log('结果:', JSON.stringify(result, null, 2));
  } catch (error) {
    console.error('错误:', error.message);
  }
}

main().catch(console.error);
```

---

## 运行输出

```
=== 工具调用示例 ===

1. 查询天气（有效）
结果: {
  "location": "Tokyo",
  "temperature": 22,
  "unit": "celsius",
  "condition": "sunny"
}

2. 查询天气（无效 unit）
错误: Invalid parameters: [{"type":42,"schema":{"anyOf":[{"const":"celsius"},{"const":"fahrenheit"}]},"path":"/unit","value":"kelvin","message":"Expected union value"}]

3. 查询天气（缺少 location）
错误: Invalid parameters: [{"type":54,"schema":{"type":"string","description":"City name"},"path":"/location","message":"Required property"}]

4. 计算器（有效）
结果: {
  "result": 42
}
```

---

## 关键点

### 1. TypeBox Schema
自动生成 JSON Schema 和 TypeScript 类型。

### 2. 参数验证
运行时验证参数类型、必填字段、枚举值。

### 3. 错误处理
清晰的错误信息，便于调试。

---

**版本：** v1.0
**最后更新：** 2026-02-19
