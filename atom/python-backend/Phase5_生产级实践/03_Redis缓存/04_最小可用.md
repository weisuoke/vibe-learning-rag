# æœ€å°å¯ç”¨

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½å¼€å§‹åœ¨AI Agenté¡¹ç›®ä¸­ä½¿ç”¨Redisç¼“å­˜ï¼š

## 4.1 RedisåŸºç¡€æ“ä½œï¼ˆStringç±»å‹ï¼‰

**æ ¸å¿ƒï¼š** ä½¿ç”¨Stringç±»å‹å­˜å‚¨ç®€å•çš„é”®å€¼å¯¹ï¼Œæ”¯æŒTTLè¿‡æœŸ

```python
import redis
from typing import Optional

# è¿æ¥Redis
client = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)

# è®¾ç½®ç¼“å­˜ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
client.setex("user:1001", 3600, "John Doe")  # 1å°æ—¶åè¿‡æœŸ

# è·å–ç¼“å­˜
value = client.get("user:1001")
print(value)  # "John Doe"

# æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
exists = client.exists("user:1001")
print(exists)  # 1 (å­˜åœ¨) æˆ– 0 (ä¸å­˜åœ¨)
```

**åœ¨AI Agentä¸­çš„åº”ç”¨ï¼š**
- ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
- ç¼“å­˜API token
- ç¼“å­˜é…ç½®æ•°æ®

---

## 4.2 LLMå“åº”ç²¾ç¡®ç¼“å­˜

**æ ¸å¿ƒï¼š** ä½¿ç”¨promptçš„hashä½œä¸ºkeyï¼Œç¼“å­˜LLMçš„å®Œæ•´å“åº”

```python
import hashlib
import json

def cache_llm_response(prompt: str, response: str, ttl: int = 3600):
    """ç¼“å­˜LLMå“åº”"""
    # ç”Ÿæˆç¼“å­˜keyï¼ˆpromptçš„hashï¼‰
    cache_key = f"llm:{hashlib.md5(prompt.encode()).hexdigest()}"

    # å­˜å‚¨å“åº”ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
    client.setex(cache_key, ttl, response)
    print(f"âœ… ç¼“å­˜LLMå“åº”: {cache_key[:20]}...")

def get_cached_response(prompt: str) -> Optional[str]:
    """è·å–ç¼“å­˜çš„LLMå“åº”"""
    cache_key = f"llm:{hashlib.md5(prompt.encode()).hexdigest()}"
    response = client.get(cache_key)

    if response:
        print(f"ğŸ¯ å‘½ä¸­ç¼“å­˜: {cache_key[:20]}...")
    else:
        print(f"âŒ æœªå‘½ä¸­ç¼“å­˜: {cache_key[:20]}...")

    return response

# ä½¿ç”¨ç¤ºä¾‹
prompt = "What is the capital of France?"

# ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šæœªå‘½ä¸­ç¼“å­˜ï¼Œè°ƒç”¨LLM
cached = get_cached_response(prompt)
if not cached:
    response = "Paris"  # æ¨¡æ‹ŸLLMè°ƒç”¨
    cache_llm_response(prompt, response)

# ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šå‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å›
cached = get_cached_response(prompt)
print(f"å“åº”: {cached}")
```

**åœ¨AI Agentä¸­çš„åº”ç”¨ï¼š**
- ç¼“å­˜å¸¸è§é—®é¢˜çš„å›ç­”
- é¿å…é‡å¤è°ƒç”¨LLM API
- é™ä½APIæˆæœ¬

---

## 4.3 Hashç±»å‹å­˜å‚¨ç»“æ„åŒ–æ•°æ®

**æ ¸å¿ƒï¼š** ä½¿ç”¨Hashç±»å‹å­˜å‚¨å¯¹è±¡çš„å¤šä¸ªå­—æ®µ

```python
# å­˜å‚¨ç”¨æˆ·å¯¹è±¡
client.hset("user:1001", mapping={
    "name": "John Doe",
    "email": "john@example.com",
    "role": "admin"
})

# è·å–å•ä¸ªå­—æ®µ
name = client.hget("user:1001", "name")
print(name)  # "John Doe"

# è·å–æ‰€æœ‰å­—æ®µ
user = client.hgetall("user:1001")
print(user)  # {'name': 'John Doe', 'email': 'john@example.com', 'role': 'admin'}

# è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¯¹æ•´ä¸ªHashï¼‰
client.expire("user:1001", 3600)
```

**åœ¨AI Agentä¸­çš„åº”ç”¨ï¼š**
- ç¼“å­˜ç”¨æˆ·ä¼šè¯ä¿¡æ¯
- ç¼“å­˜Agentæ‰§è¡ŒçŠ¶æ€
- ç¼“å­˜æ–‡æ¡£å…ƒæ•°æ®

---

## 4.4 è¿æ¥æ± ç®¡ç†

**æ ¸å¿ƒï¼š** ä½¿ç”¨è¿æ¥æ± å¤ç”¨Redisè¿æ¥ï¼Œæå‡æ€§èƒ½

```python
from redis import ConnectionPool

# åˆ›å»ºè¿æ¥æ± ï¼ˆå…¨å±€å•ä¾‹ï¼‰
pool = ConnectionPool(
    host='localhost',
    port=6379,
    db=0,
    max_connections=10,  # æœ€å¤§è¿æ¥æ•°
    decode_responses=True
)

# ä»è¿æ¥æ± è·å–å®¢æˆ·ç«¯
client = redis.Redis(connection_pool=pool)

# ä½¿ç”¨å®¢æˆ·ç«¯ï¼ˆè¿æ¥ä¼šè‡ªåŠ¨å¤ç”¨ï¼‰
client.set("key1", "value1")
value = client.get("key1")
```

**åœ¨AI Agentä¸­çš„åº”ç”¨ï¼š**
- FastAPIåº”ç”¨ä¸­å¤ç”¨Redisè¿æ¥
- é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥
- æå‡å¹¶å‘æ€§èƒ½

---

## 4.5 ç¼“å­˜å¤±æ•ˆç­–ç•¥

**æ ¸å¿ƒï¼š** è®¾ç½®åˆç†çš„TTLï¼Œé¿å…ç¼“å­˜è¿‡æœŸå’Œç¼“å­˜é›ªå´©

```python
from datetime import timedelta

# ä¸åŒç±»å‹æ•°æ®çš„TTLç­–ç•¥
TTL_CONFIG = {
    "llm_response": 3600,        # LLMå“åº”ï¼š1å°æ—¶
    "embedding": 86400,          # Embeddingï¼š24å°æ—¶
    "user_session": 1800,        # ç”¨æˆ·ä¼šè¯ï¼š30åˆ†é’Ÿ
    "config": 300,               # é…ç½®æ•°æ®ï¼š5åˆ†é’Ÿ
}

def set_cache_with_ttl(key: str, value: str, cache_type: str):
    """æ ¹æ®ç¼“å­˜ç±»å‹è®¾ç½®TTL"""
    ttl = TTL_CONFIG.get(cache_type, 3600)  # é»˜è®¤1å°æ—¶
    client.setex(key, ttl, value)
    print(f"âœ… ç¼“å­˜è®¾ç½®æˆåŠŸï¼ŒTTL={ttl}ç§’")

# ä½¿ç”¨ç¤ºä¾‹
set_cache_with_ttl("llm:abc123", "Paris", "llm_response")
set_cache_with_ttl("user:session:xyz", '{"user_id": 1001}', "user_session")
```

**åœ¨AI Agentä¸­çš„åº”ç”¨ï¼š**
- æ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®ä¸åŒTTL
- é¿å…ç¼“å­˜æ•°æ®è¿‡æœŸå¯¼è‡´çš„æ€§èƒ½é—®é¢˜
- å¹³è¡¡ç¼“å­˜å‘½ä¸­ç‡å’Œæ•°æ®æ–°é²œåº¦

---

## è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š

- âœ… åœ¨FastAPIé¡¹ç›®ä¸­é›†æˆRedisç¼“å­˜
- âœ… ç¼“å­˜LLMå“åº”ï¼Œé™ä½APIè°ƒç”¨æˆæœ¬
- âœ… ä½¿ç”¨Hashå­˜å‚¨ç»“æ„åŒ–æ•°æ®
- âœ… ç®¡ç†è¿æ¥æ± ï¼Œæå‡å¹¶å‘æ€§èƒ½
- âœ… è®¾ç½®åˆç†çš„TTLç­–ç•¥
- âœ… ä¸ºåç»­å­¦ä¹ è¯­ä¹‰ç¼“å­˜ã€Embeddingç¼“å­˜æ‰“åŸºç¡€

---

## å¿«é€Ÿä¸Šæ‰‹æ£€æŸ¥æ¸…å•

- [ ] å®‰è£…Redisï¼š`brew install redis`ï¼ˆmacOSï¼‰æˆ– `apt install redis`ï¼ˆLinuxï¼‰
- [ ] å¯åŠ¨Redisï¼š`redis-server`
- [ ] å®‰è£…Pythonå®¢æˆ·ç«¯ï¼š`uv add redis`
- [ ] æµ‹è¯•è¿æ¥ï¼š`redis-cli ping`ï¼ˆè¿”å›PONGè¡¨ç¤ºæˆåŠŸï¼‰
- [ ] å®ç°ç¬¬ä¸€ä¸ªLLMå“åº”ç¼“å­˜
- [ ] è®¾ç½®åˆç†çš„TTLç­–ç•¥
- [ ] åœ¨FastAPIä¸­ä½¿ç”¨è¿æ¥æ± 

---

**è®°ä½ï¼š** è¿™5ä¸ªçŸ¥è¯†ç‚¹æ˜¯Redisç¼“å­˜çš„æ ¸å¿ƒåŸºç¡€ï¼ŒæŒæ¡å®ƒä»¬å°±èƒ½åœ¨AI Agenté¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½ï¼
