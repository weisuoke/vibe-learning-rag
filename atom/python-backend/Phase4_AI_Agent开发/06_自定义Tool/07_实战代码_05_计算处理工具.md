# 自定义Tool - 实战代码05：计算处理工具

> 完整可运行的计算处理Tool示例，涵盖数学计算、数据转换、文本处理等场景

---

## 概述

计算处理Tool让Agent能够执行精确的数学计算和数据处理。本文提供安全的计算实现。

**技术要点：**
- 安全的表达式求值（不用eval）
- 数学计算（ast模块）
- 数据格式转换
- 文本处理

---

## 示例1：数学计算Tool

```python
"""
数学计算Tool示例
演示：安全地计算数学表达式
"""

import ast
import operator
from langchain.tools import tool
from pydantic import BaseModel, Field

# ===== 1. 安全的表达式求值 =====
class SafeEvaluator:
    """安全的数学表达式求值器"""

    # 支持的运算符
    operators = {
        ast.Add: operator.add,
        ast.Sub: operator.sub,
        ast.Mult: operator.mul,
        ast.Div: operator.truediv,
        ast.Pow: operator.pow,
        ast.Mod: operator.mod,
        ast.FloorDiv: operator.floordiv,
        ast.UAdd: operator.pos,
        ast.USub: operator.neg,
    }

    def eval_expr(self, node):
        """递归求值表达式"""
        if isinstance(node, ast.Num):  # 数字
            return node.n
        elif isinstance(node, ast.BinOp):  # 二元运算
            left = self.eval_expr(node.left)
            right = self.eval_expr(node.right)
            op = self.operators.get(type(node.op))
            if op is None:
                raise ValueError(f"不支持的运算符：{type(node.op).__name__}")
            return op(left, right)
        elif isinstance(node, ast.UnaryOp):  # 一元运算
            operand = self.eval_expr(node.operand)
            op = self.operators.get(type(node.op))
            if op is None:
                raise ValueError(f"不支持的运算符：{type(node.op).__name__}")
            return op(operand)
        else:
            raise ValueError(f"不支持的表达式类型：{type(node).__name__}")

    def evaluate(self, expression: str) -> float:
        """求值数学表达式"""
        try:
            tree = ast.parse(expression, mode='eval')
            return self.eval_expr(tree.body)
        except SyntaxError:
            raise ValueError(f"表达式语法错误：{expression}")

# ===== 2. 定义参数Schema =====
class CalcInput(BaseModel):
    """计算参数"""
    expression: str = Field(
        description="数学表达式，如'2 + 3 * 4'、'(100 + 50) / 2'",
        max_length=200
    )

# ===== 3. 定义Tool =====
@tool(args_schema=CalcInput)
def calculate(expression: str) -> str:
    """计算数学表达式

    安全地计算数学表达式的结果。

    支持的运算：
    - 加减乘除：+, -, *, /
    - 幂运算：**
    - 取模：%
    - 整除：//
    - 括号：()

    适用场景：
    - 用户询问"125 * 48等于多少？"
    - 用户询问"计算一下(100 + 50) * 2"
    - 用户询问"15的平方是多少？"

    Args:
        expression: 数学表达式

    Returns:
        计算结果

    注意事项：
    - 不支持eval()，使用安全的解析器
    - 不支持变量和函数调用
    - 只支持基本数学运算
    """
    try:
        evaluator = SafeEvaluator()
        result = evaluator.evaluate(expression)

        # 格式化结果
        if isinstance(result, float) and result.is_integer():
            result = int(result)

        return f"{expression} = {result}"

    except ValueError as e:
        return f"计算错误：{str(e)}。建议：检查表达式是否正确。"

    except ZeroDivisionError:
        return f"计算错误：除数不能为0。"

    except Exception as e:
        return f"计算失败：{str(e)}。建议：请简化表达式或联系技术支持。"

# ===== 4. 测试 =====
async def test_calculator():
    """测试计算器"""
    print("=== 测试计算器 ===\n")

    test_cases = [
        "2 + 3",
        "10 * 5",
        "(100 + 50) / 2",
        "2 ** 10",
        "17 % 5",
        "17 // 5",
    ]

    for expr in test_cases:
        result = await calculate.ainvoke({"expression": expr})
        print(result)

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_calculator())
```

---

## 示例2：数据转换Tool

```python
"""
数据转换Tool示例
演示：JSON、CSV、XML格式转换
"""

import json
import csv
from io import StringIO
from langchain.tools import tool

@tool
def json_to_csv(json_data: str) -> str:
    """JSON转CSV

    将JSON数组转换为CSV格式。

    Args:
        json_data: JSON字符串（数组格式）

    Returns:
        CSV格式的字符串
    """
    try:
        # 解析JSON
        data = json.loads(json_data)

        if not isinstance(data, list):
            return "错误：JSON必须是数组格式。"

        if not data:
            return "错误：JSON数组为空。"

        # 转换为CSV
        output = StringIO()
        writer = csv.DictWriter(output, fieldnames=data[0].keys())
        writer.writeheader()
        writer.writerows(data)

        return f"CSV格式：\n{output.getvalue()}"

    except json.JSONDecodeError as e:
        return f"JSON解析错误：{str(e)}"

    except Exception as e:
        return f"转换失败：{str(e)}"

@tool
def csv_to_json(csv_data: str) -> str:
    """CSV转JSON

    将CSV格式转换为JSON数组。

    Args:
        csv_data: CSV字符串

    Returns:
        JSON格式的字符串
    """
    try:
        # 解析CSV
        input_stream = StringIO(csv_data)
        reader = csv.DictReader(input_stream)
        data = list(reader)

        # 转换为JSON
        json_str = json.dumps(data, indent=2, ensure_ascii=False)

        return f"JSON格式：\n{json_str}"

    except Exception as e:
        return f"转换失败：{str(e)}"
```

---

## 示例3：文本处理Tool

```python
"""
文本处理Tool示例
演示：文本统计、格式化、提取
"""

from langchain.tools import tool
import re

@tool
def count_words(text: str) -> str:
    """统计文本

    统计文本的字数、行数、字符数。

    Args:
        text: 文本内容

    Returns:
        统计结果
    """
    try:
        # 统计
        lines = text.split('\n')
        words = text.split()
        chars = len(text)
        chars_no_space = len(text.replace(' ', '').replace('\n', ''))

        return f"""文本统计：
行数：{len(lines)}
词数：{len(words)}
字符数：{chars}（不含空格：{chars_no_space}）
"""

    except Exception as e:
        return f"统计失败：{str(e)}"

@tool
def extract_emails(text: str) -> str:
    """提取邮箱

    从文本中提取所有邮箱地址。

    Args:
        text: 文本内容

    Returns:
        邮箱列表
    """
    try:
        # 邮箱正则
        pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
        emails = re.findall(pattern, text)

        if not emails:
            return "未找到邮箱地址。"

        # 去重
        emails = list(set(emails))

        return f"找到{len(emails)}个邮箱：\n" + "\n".join(f"- {email}" for email in emails)

    except Exception as e:
        return f"提取失败：{str(e)}"

@tool
def extract_urls(text: str) -> str:
    """提取URL

    从文本中提取所有URL。

    Args:
        text: 文本内容

    Returns:
        URL列表
    """
    try:
        # URL正则
        pattern = r'https?://[^\s<>"{}|\\^`\[\]]+'
        urls = re.findall(pattern, text)

        if not urls:
            return "未找到URL。"

        # 去重
        urls = list(set(urls))

        return f"找到{len(urls)}个URL：\n" + "\n".join(f"- {url}" for url in urls)

    except Exception as e:
        return f"提取失败：{str(e)}"
```

---

## 最佳实践

### 1. 安全的表达式求值

```python
# ❌ 危险：使用eval
result = eval(expression)  # 可能执行任意代码

# ✅ 安全：使用ast解析
tree = ast.parse(expression, mode='eval')
result = safe_eval(tree.body)
```

### 2. 错误处理

```python
try:
    result = calculate(expression)
except ZeroDivisionError:
    return "除数不能为0"
except ValueError as e:
    return f"表达式错误：{e}"
```

### 3. 结果格式化

```python
# 整数结果不显示小数点
if isinstance(result, float) and result.is_integer():
    result = int(result)
```

---

## 总结

计算处理Tool的核心：
1. **安全求值**：使用ast模块，不用eval
2. **错误处理**：友好的错误提示
3. **结果格式化**：易读的输出格式

**记住：** 永远不要使用eval()执行用户输入的表达式！
