# 核心概念2：多阶段构建与镜像优化

## 概述

多阶段构建是 Docker 的一项强大特性，允许在一个 Dockerfile 中使用多个 FROM 指令，将构建环境和运行环境分离，从而大幅减小最终镜像体积。

**核心价值：** 镜像体积从 1GB 优化到 200MB

---

## 1. 为什么需要多阶段构建？

### 单阶段构建的问题

```dockerfile
# 单阶段构建
FROM python:3.13-slim
WORKDIR /app

# 安装构建工具
RUN pip install uv

# 安装依赖
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen

# 复制应用代码
COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
```

**问题：**
- ❌ uv 只在构建时需要，运行时不需要，但被打包进镜像
- ❌ 构建缓存和临时文件也被打包进镜像
- ❌ 镜像体积：1GB

### 多阶段构建的解决方案

```dockerfile
# ===== 构建阶段 =====
FROM python:3.13-slim AS builder
WORKDIR /app
RUN pip install uv
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen

# ===== 运行阶段 =====
FROM python:3.13-slim
WORKDIR /app
COPY --from=builder /app/.venv /app/.venv  # 只复制依赖
COPY app/ app/  # 只复制应用代码
ENV PATH="/app/.venv/bin:$PATH"
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
```

**优势：**
- ✅ 构建工具（uv）不会进入最终镜像
- ✅ 只复制必要的文件（依赖 + 代码）
- ✅ 镜像体积：200MB（减少 80%）

---

## 2. 多阶段构建原理

### 工作流程

```
阶段1：Builder（构建环境）
├── 基础镜像：python:3.13-slim
├── 安装构建工具：uv
├── 安装依赖：uv sync
└── 产出：/app/.venv/（依赖库）

阶段2：Runtime（运行环境）
├── 基础镜像：python:3.13-slim（全新的）
├── 从 Builder 复制：/app/.venv/
├── 复制应用代码：app/
└── 产出：最终镜像（200MB）
```

### 关键语法

```dockerfile
# AS <name> - 为阶段命名
FROM python:3.13-slim AS builder

# COPY --from=<stage> - 从指定阶段复制文件
COPY --from=builder /app/.venv /app/.venv
```

---

## 3. 基础镜像选择

### Python 官方镜像对比

| 镜像 | 体积 | 包含内容 | 推荐场景 |
|-----|------|---------|---------|
| python:3.13 | 1GB | 完整的 Debian + Python + 编译工具 | 需要编译 C 扩展 |
| python:3.13-slim | 200MB | 精简的 Debian + Python | ✅ 推荐（AI Agent API） |
| python:3.13-alpine | 150MB | Alpine Linux + Python | ⚠️ 兼容性问题 |

### 推荐选择：slim 版本

```dockerfile
# ✅ 推荐：slim 版本
FROM python:3.13-slim AS builder
# 优势：
# - 体积适中（200MB）
# - 兼容性好（基于 Debian）
# - 构建快速（2分钟）

# ⚠️ 不推荐：alpine 版本
FROM python:3.13-alpine AS builder
# 问题：
# - 缺少编译依赖（gcc、musl-dev）
# - psycopg2-binary 等包编译失败
# - 需要手动安装大量依赖
# - 构建时间长（7分钟）
```

---

## 4. 镜像体积优化技巧

### 技巧1：清理 pip 缓存

```dockerfile
# ❌ 不清理缓存
RUN pip install -r requirements.txt
# 镜像体积：500MB

# ✅ 清理缓存
RUN pip install --no-cache-dir -r requirements.txt
# 镜像体积：300MB（减少 200MB）
```

### 技巧2：合并 RUN 指令

```dockerfile
# ❌ 多个 RUN 指令（创建多个层）
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get clean
# 镜像体积：350MB

# ✅ 合并 RUN 指令（创建一个层）
RUN apt-get update && \
    apt-get install -y curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
# 镜像体积：300MB（减少 50MB）
```

### 技巧3：使用 .dockerignore

```
# .dockerignore
__pycache__/
*.pyc
.git/
.env
.venv/
tests/
docs/
*.md
```

```dockerfile
COPY . /app/
# 会自动忽略 .dockerignore 中的文件
# 减少构建上下文体积
```

### 技巧4：只复制必要的文件

```dockerfile
# ❌ 复制所有文件
COPY . /app/
# 包含：tests/、docs/、.git/、README.md 等

# ✅ 只复制必要的文件
COPY app/ /app/app/
COPY requirements.txt /app/
# 只包含：应用代码 + 依赖文件
```

### 技巧5：利用层缓存

```dockerfile
# ✅ 先复制依赖文件，再复制代码
COPY requirements.txt .
RUN pip install -r requirements.txt  # 依赖不变时，缓存命中
COPY . .  # 代码修改，只重新执行这一步

# ❌ 先复制代码，再安装依赖
COPY . .
RUN pip install -r requirements.txt  # 代码修改，依赖重新安装
```

---

## 5. 完整示例：AI Agent API 多阶段构建

### 单阶段构建（优化前）

```dockerfile
FROM python:3.13-slim
WORKDIR /app
RUN pip install uv
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen
COPY . .
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
```

**镜像体积：** 1GB

### 多阶段构建（优化后）

```dockerfile
# ===== 构建阶段 =====
FROM python:3.13-slim AS builder

WORKDIR /app

# 安装构建工具
RUN pip install --no-cache-dir uv

# 复制依赖文件
COPY pyproject.toml uv.lock ./

# 安装依赖（不包含开发依赖）
RUN uv sync --frozen --no-dev

# ===== 运行阶段 =====
FROM python:3.13-slim

# 创建非 root 用户
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# 从构建阶段复制依赖
COPY --from=builder /app/.venv /app/.venv

# 复制应用代码
COPY --chown=appuser:appuser app/ app/

# 设置环境变量
ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 切换到非 root 用户
USER appuser

# 声明端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**镜像体积：** 200MB（减少 80%）

---

## 6. 镜像层分析工具：dive

### 安装 dive

```bash
# macOS
brew install dive

# Linux
wget https://github.com/wagoodman/dive/releases/download/v0.11.0/dive_0.11.0_linux_amd64.deb
sudo dpkg -i dive_0.11.0_linux_amd64.deb
```

### 使用 dive 分析镜像

```bash
# 构建镜像
docker build -t ai-agent-api:v1.0 .

# 分析镜像
dive ai-agent-api:v1.0
```

**dive 界面：**
```
┌─ Layers ────────────────────────────────────────┐
│ Cmp   Size  Command                             │
│     200 MB  FROM python:3.13-slim               │
│      50 MB  COPY --from=builder /app/.venv      │
│       5 MB  COPY app/ app/                      │
│       0 B   ENV PATH="/app/.venv/bin:$PATH"     │
│       0 B   USER appuser                        │
│       0 B   CMD ["uvicorn", "app.main:app"]     │
└─────────────────────────────────────────────────┘

Total Image size: 255 MB
Potential wasted space: 0 MB
Image efficiency score: 100%
```

---

## 7. 构建缓存策略

### 缓存机制

Docker 构建镜像时，每条指令创建一个层。如果指令和上下文没有变化，会复用缓存。

```dockerfile
FROM python:3.13-slim          # 层1（缓存）
COPY requirements.txt .        # 层2（缓存）
RUN pip install -r requirements.txt  # 层3（缓存）
COPY . .                       # 层4（重新执行）
```

### 优化构建速度

```dockerfile
# ✅ 推荐：利用缓存
COPY requirements.txt .
RUN pip install -r requirements.txt  # 依赖不变时，缓存命中（节省 2 分钟）
COPY . .

# ❌ 不推荐：缓存失效
COPY . .
RUN pip install -r requirements.txt  # 代码修改，依赖重新安装（浪费 2 分钟）
```

---

## 8. 实际应用：对比测试

### 测试场景

```bash
# 项目结构
ai-agent-api/
├── app/
│   ├── main.py
│   ├── models/
│   └── services/
├── pyproject.toml
├── uv.lock
└── Dockerfile
```

### 单阶段构建

```bash
$ docker build -t ai-agent-api:single -f Dockerfile.single .
[+] Building 120.5s
 => [1/5] FROM python:3.13-slim
 => [2/5] RUN pip install uv
 => [3/5] COPY pyproject.toml uv.lock ./
 => [4/5] RUN uv sync --frozen
 => [5/5] COPY . .

$ docker images ai-agent-api:single
REPOSITORY       TAG      SIZE
ai-agent-api     single   1.02GB
```

### 多阶段构建

```bash
$ docker build -t ai-agent-api:multi -f Dockerfile.multi .
[+] Building 125.3s
 => [builder 1/4] FROM python:3.13-slim
 => [builder 2/4] RUN pip install uv
 => [builder 3/4] COPY pyproject.toml uv.lock ./
 => [builder 4/4] RUN uv sync --frozen
 => [stage-1 1/3] FROM python:3.13-slim
 => [stage-1 2/3] COPY --from=builder /app/.venv /app/.venv
 => [stage-1 3/3] COPY app/ app/

$ docker images ai-agent-api:multi
REPOSITORY       TAG      SIZE
ai-agent-api     multi    215MB
```

### 对比结果

| 指标 | 单阶段构建 | 多阶段构建 | 优化效果 |
|-----|-----------|-----------|---------|
| 镜像体积 | 1.02GB | 215MB | ✅ 减少 79% |
| 构建时间 | 120s | 125s | ⚠️ 增加 4% |
| 启动时间 | 3s | 2s | ✅ 减少 33% |
| 下载时间 | 60s | 15s | ✅ 减少 75% |

---

## 9. 常见问题

### Q1: 多阶段构建会增加构建时间吗？

**答：** 略微增加（约 5%），但可以通过缓存优化。

```bash
# 第一次构建（完整构建）
$ docker build -t my-app .
[+] Building 125s

# 修改代码后第二次构建（利用缓存）
$ docker build -t my-app .
[+] Building 5s  # 只重新执行代码复制步骤
```

### Q2: 如何选择基础镜像？

**推荐：** python:3.13-slim

```dockerfile
# ✅ 推荐：slim 版本
FROM python:3.13-slim
# 优势：体积适中、兼容性好、构建快速

# ⚠️ 不推荐：alpine 版本
FROM python:3.13-alpine
# 问题：兼容性差、构建时间长
```

### Q3: 如何验证镜像优化效果？

```bash
# 方法1：查看镜像体积
docker images my-app

# 方法2：使用 dive 分析
dive my-app:v1.0

# 方法3：查看镜像历史
docker history my-app:v1.0
```

---

## 10. 最佳实践总结

**多阶段构建：**
1. ✅ 使用 AS 为阶段命名
2. ✅ Builder 阶段安装构建工具和依赖
3. ✅ Runtime 阶段只复制必要文件
4. ✅ 使用 COPY --from 从 Builder 复制

**镜像优化：**
1. ✅ 使用 python:3.13-slim 基础镜像
2. ✅ 清理 pip 缓存（--no-cache-dir）
3. ✅ 合并 RUN 指令减少层数
4. ✅ 使用 .dockerignore 减小构建上下文
5. ✅ 只复制必要的文件

**构建缓存：**
1. ✅ 先复制依赖文件，再复制代码
2. ✅ 不常变化的指令放前面
3. ✅ 常变化的指令放后面

---

**版本：** v1.0
**最后更新：** 2026-02-12
**适用于：** Python 3.13+ / FastAPI / AI Agent 后端开发
