# 化骨绵掌

将长文档处理策略拆成 10 个 2 分钟能看完的知识卡片。

---

## 卡片1：分层索引 - 直觉理解

**一句话：** 分层索引就像图书馆找书，从楼层→书架→分类→具体书，逐层缩小范围。

**核心思想：**
- 构建树形结构：根节点 → 章节 → 段落 → 原文
- 逐层检索：先在章节层找，再在段落层找
- 剪枝优化：父节点不相关，子节点不检索

**代码示例：**
```python
# 第1层：在章节中检索
relevant_chapters = search_in_chapters(query)

# 第2层：在选中章节的段落中检索
relevant_paragraphs = search_in_paragraphs(query, relevant_chapters)

# 返回段落内容
return relevant_paragraphs
```

**应用：** 技术文档检索（"如何配置网络策略？"）

---

## 卡片2：分层索引 - 实现原理

**一句话：** 为每个层级生成摘要和 Embedding，逐层计算相似度。

**实现步骤：**
1. 提取文档结构（章节、段落）
2. 为每个节点生成摘要
3. 为每个摘要生成 Embedding
4. 检索时逐层计算相似度

**关键代码：**
```python
# 构建索引
for chapter in chapters:
    chapter.embedding = embedding_func(chapter.summary)

# 检索
query_embedding = embedding_func(query)
for chapter in chapters:
    score = cosine_similarity(query_embedding, chapter.embedding)
```

**优势：** 检索效率高（30 vs 1000 个节点）

---

## 卡片3：分层索引 - 适用场景

**一句话：** 适合需要快速定位具体章节的问题。

**适用场景：**
- ✅ "第3章第2节的公式是什么？"
- ✅ "如何配置 Kubernetes 的网络策略？"
- ✅ 文档有清晰的章节结构

**不适用场景：**
- ❌ "这篇论文的核心创新是什么？"（需要全文理解）
- ❌ 无结构的文档（聊天记录）

**决策规则：**
```
需要精确定位？ → 分层索引
需要全文理解？ → 摘要链
```

---

## 卡片4：摘要链 - 直觉理解

**一句话：** 摘要链就像读书笔记，把 500 页的书总结成 10 页笔记，再总结成 1 页。

**核心思想：**
- 递归总结：原文 → 段落摘要 → 章节摘要 → 全文摘要
- 信息压缩：每层压缩 10:1
- 层次保留：所有层的摘要都保留

**压缩示例：**
```
原文：500,000 字
段落摘要：50,000 字（10:1）
章节摘要：5,000 字（10:1）
全文摘要：500 字（10:1）

总压缩比：1000:1
```

**应用：** 学术论文问答（"核心创新是什么？"）

---

## 卡片5：摘要链 - 实现原理

**一句话：** 用 LLM 递归总结，直到可以放入 Context Window。

**实现步骤：**
1. 将文档分成 N 个片段
2. 用 LLM 总结每个片段
3. 将 N 个摘要再总结成 N/10 个摘要
4. 重复直到只剩 1 个摘要

**关键代码：**
```python
current_layer = chunks
while len(current_layer) > 1:
    next_layer = []
    for i in range(0, len(current_layer), 10):
        batch = current_layer[i:i+10]
        summary = llm_summarize(batch)
        next_layer.append(summary)
    current_layer = next_layer
```

**成本：** 需要多次调用 LLM（离线预生成）

---

## 卡片6：摘要链 - 适用场景

**一句话：** 适合需要全文理解的问题。

**适用场景：**
- ✅ "这篇论文的核心创新是什么？"
- ✅ "论文的整体逻辑结构"
- ✅ 需要理解全文大意

**不适用场景：**
- ❌ "第3章第2节的公式是什么？"（需要精确信息）
- ❌ 需要所有细节的场景

**信息损失：**
```
摘要会丢失细节：
- 保留：核心观点、主要方法、关键结论
- 丢失：具体公式、详细步骤、边缘案例
```

---

## 卡片7：Map-Reduce - 直觉理解

**一句话：** Map-Reduce 就像团队分工，10 个人同时数书中的词频，最后汇总。

**核心思想：**
- Map 阶段：并行处理每个文档片段
- Reduce 阶段：聚合所有结果
- 独立子问题：每个片段的处理不依赖其他片段

**加速示例：**
```
串行：10 个文档 × 1 秒 = 10 秒
并行：1 秒（同时处理）+ 1 秒（聚合）= 2 秒
加速比：10 / 2 = 5 倍
```

**应用：** 多文档对比（"对比 3 篇论文的方法"）

---

## 卡片8：Map-Reduce - 实现原理

**一句话：** 使用 ThreadPoolExecutor 或 asyncio 并行处理。

**实现步骤：**
1. 定义 Map 函数（处理单个文档）
2. 定义 Reduce 函数（聚合结果）
3. 并行执行所有 Map 任务
4. 串行执行 Reduce 任务

**关键代码：**
```python
# 线程池版本
with ThreadPoolExecutor(max_workers=5) as executor:
    map_results = list(executor.map(map_func, documents))

# 异步版本
map_results = await asyncio.gather(*[map_func(doc) for doc in documents])

# Reduce
final_result = reduce_func(map_results)
```

**性能：** I/O 密集型任务（LLM API 调用）效果最好

---

## 卡片9：Map-Reduce - 适用场景

**一句话：** 适合可以分解为独立子问题的场景。

**适用场景：**
- ✅ "每章的核心观点是什么？"
- ✅ "对比 3 篇论文的方法"
- ✅ 批量文档处理

**不适用场景：**
- ❌ "论文的整体逻辑结构"（需要全局理解）
- ❌ 文档数量很少（< 5）
- ❌ 片段间有强依赖

**决策规则：**
```
问题可以分解？ → Map-Reduce
任务数量 > 5？ → Map-Reduce
否则 → 串行处理
```

---

## 卡片10：三种策略对比与选择

**一句话：** 根据问题类型选择策略，或组合使用。

**快速决策表：**

| 问题类型 | 策略 | 原因 |
|---------|------|------|
| "第3章的公式" | 分层索引 | 需要精确定位 |
| "核心创新" | 摘要链 | 需要全文理解 |
| "每章观点" | Map-Reduce | 可以分解 |
| "如何配置" | 分层索引 | 快速定位 |

**组合使用：**
```python
# 学术论文问答
if "核心" in question:
    # 用摘要链理解全文
    summary = summary_chain.get_summary()
    return llm(f"{summary}\n\n{question}")
elif "每章" in question:
    # 用 Map-Reduce 并行处理
    return map_reduce.process(chapters, extract_func, aggregate_func)
else:
    # 用分层索引快速定位
    relevant = index.search(question)
    return llm(f"{relevant}\n\n{question}")
```

**记忆口诀：**
- 分层索引 = 快速定位
- 摘要链 = 全文理解
- Map-Reduce = 并行处理

---

## 知识卡片总结

### 分层索引（卡片1-3）
- **核心**：树形结构 + 逐层检索
- **适用**：快速定位具体章节
- **类比**：图书馆找书

### 摘要链（卡片4-6）
- **核心**：递归总结 + 信息压缩
- **适用**：全文理解
- **类比**：读书笔记

### Map-Reduce（卡片7-9）
- **核心**：并行处理 + 结果聚合
- **适用**：独立子问题
- **类比**：团队分工

### 策略选择（卡片10）
- **决策树**：问题类型 → 策略选择
- **组合使用**：根据场景灵活组合
- **性能优化**：并行 + 缓存 + 剪枝

---

## 2分钟速记版

### 30秒版（核心要点）
```
分层索引 = 树形导航，快速定位
摘要链 = 递归总结，全文理解
Map-Reduce = 并行处理，独立子问题
```

### 1分钟版（决策规则）
```
需要精确定位？ → 分层索引
需要全文理解？ → 摘要链
可以分解任务？ → Map-Reduce
```

### 2分钟版（完整理解）
```
1. 分层索引：
   - 构建树形索引（章节 → 段落）
   - 逐层检索缩小范围
   - 适合技术文档检索

2. 摘要链：
   - 递归总结压缩信息
   - 保留核心内容
   - 适合学术论文理解

3. Map-Reduce：
   - 并行处理多个文档
   - 最后聚合结果
   - 适合多文档对比

选择策略：根据问题类型决定
组合使用：灵活搭配效果更好
```

---

**下一步：** [12_一句话总结.md](./12_一句话总结.md) - 用一句话总结整个知识点
