# 第一性原理

### 什么是第一性原理？

**第一性原理**：回到事物最基本的真理，从源头思考问题

### Query改写的第一性原理

#### 1. 最基础的定义

**Query改写 = 将用户意图转换为检索系统能理解的形式**

仅此而已！没有更基础的了。

用户说的话 → 转换 → 检索系统能匹配的表达

#### 2. 为什么需要 Query改写？

**核心问题：用户表达与文档表达之间存在语义鸿沟**

```
用户的表达方式：
┌─────────────────────────────────────────────────────────────┐
│  "代码跑不动了"                                               │
│  "Python 咋异步"                                              │
│  "数据库太慢怎么办"                                            │
│  "这个 bug 怎么修"                                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
                         语义鸿沟
                              ↓
文档的表达方式：
┌─────────────────────────────────────────────────────────────┐
│  "Python 程序运行时异常处理指南"                               │
│  "asyncio 异步编程最佳实践"                                    │
│  "MySQL 查询性能优化方法"                                      │
│  "常见错误排查与调试技巧"                                       │
└─────────────────────────────────────────────────────────────┘
```

**语义鸿沟的三个来源：**

| 来源 | 用户表达 | 文档表达 |
|------|---------|---------|
| **词汇差异** | "跑不动" | "运行异常" |
| **抽象层次** | "太慢" | "性能优化" |
| **完整度** | "咋异步" | "asyncio 异步编程" |

#### 3. Query改写的三层价值

##### 价值1：弥补词汇差异

用户使用口语化、非专业的表达，文档使用专业术语。

```python
# 用户查询
user_query = "代码跑不动了"

# 改写后
rewritten_query = "程序运行错误 异常处理 调试方法"

# 现在可以匹配到：
# - "Python 异常处理指南"
# - "程序调试技巧"
# - "常见运行时错误解决方案"
```

##### 价值2：补充隐含信息

用户查询往往不完整，缺少必要的上下文。

```python
# 用户查询（不完整）
user_query = "怎么排序"

# 改写后（补充上下文）
rewritten_queries = [
    "Python 列表排序方法 sort sorted",
    "数据库 SQL ORDER BY 排序",
    "算法 排序算法 快速排序 归并排序"
]
```

##### 价值3：对齐语义空间

用户查询和文档在 Embedding 空间中可能距离较远，改写可以拉近距离。

```
Embedding 空间示意：

改写前：
    用户查询 "代码跑不动"  ●─────────────────────● 文档 "异常处理指南"
                              距离较远

改写后：
    改写查询 "程序异常处理"  ●────● 文档 "异常处理指南"
                              距离较近
```

#### 4. 从第一性原理推导 Query改写策略

**推理链：**

```
1. 用户查询可能不完美（口语化、模糊、不完整）
   ↓
2. 直接用原始查询检索，可能找不到最相关的文档
   ↓
3. 需要将用户意图转换为更适合检索的形式
   ↓
4. 如何转换？有几种思路：
   ↓
   ├─→ 思路A：让 LLM 先"回答"问题，用答案去检索
   │           → 这就是 HyDE（假设文档嵌入）
   │
   ├─→ 思路B：让 LLM 生成多个查询变体，扩大搜索范围
   │           → 这就是 Multi-Query（多查询）
   │
   ├─→ 思路C：添加同义词、相关词，丰富查询内容
   │           → 这就是 Query Expansion（查询扩展）
   │
   ├─→ 思路D：将复杂问题拆解为多个简单子问题
   │           → 这就是 Query Decomposition（查询分解）
   │
   └─→ 思路E：先问更抽象的问题获取背景知识
             → 这就是 Step-back Prompting（后退提问）
```

#### 5. 为什么 HyDE 有效？（第一性原理解释）

```
传统检索的问题：
┌─────────────────────────────────────────────────────────────┐
│  用户查询（问题形式）: "Python 怎么实现异步？"                   │
│         ↓                                                   │
│  Embedding: [0.12, -0.34, 0.56, ...]  ← 问题的向量表示        │
│         ↓                                                   │
│  检索文档（答案形式）: "使用 asyncio 库可以实现异步..."          │
│         ↓                                                   │
│  Embedding: [0.45, 0.23, -0.12, ...]  ← 答案的向量表示        │
│                                                             │
│  问题：问题和答案在向量空间中可能距离较远！                      │
└─────────────────────────────────────────────────────────────┘

HyDE 的解决方案：
┌─────────────────────────────────────────────────────────────┐
│  用户查询: "Python 怎么实现异步？"                              │
│         ↓                                                   │
│  LLM 生成假设答案: "Python 可以使用 asyncio 库实现异步..."      │
│         ↓                                                   │
│  用假设答案的 Embedding 去检索                                 │
│         ↓                                                   │
│  假设答案和真实文档都是"答案形式"，向量空间距离更近！             │
└─────────────────────────────────────────────────────────────┘
```

**核心洞察：用答案找答案，比用问题找答案更准确。**

#### 6. 一句话总结第一性原理

**Query改写的本质是"翻译"——将用户的自然表达翻译成检索系统能理解的语言，核心价值是弥补语义鸿沟。**

---

## 第一性原理的实践指导

基于第一性原理，我们可以推导出以下实践原则：

| 原则 | 推导过程 | 实践建议 |
|------|---------|---------|
| **不是所有查询都需要改写** | 如果用户查询已经很精确，改写可能引入噪音 | 对精确查询（如错误码）跳过改写 |
| **改写要保持语义一致** | 改写的目的是更好地表达用户意图，不是改变意图 | 验证改写后的语义是否偏离 |
| **多种策略可以组合** | 不同策略解决不同类型的语义鸿沟 | 根据查询类型选择合适的策略 |
| **改写质量依赖 LLM** | LLM 的语言理解能力决定改写质量 | 使用高质量的 LLM 进行改写 |

---

**下一步：** [03_核心概念](./03_核心概念.md) - 深入理解 HyDE、Multi-Query 等核心技术
