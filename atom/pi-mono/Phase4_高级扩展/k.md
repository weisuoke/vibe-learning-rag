# Phase 4: 高级扩展

> 第 9-10 周 | 6个知识点 | 目标：实现高级功能，如自定义 Provider、MCP 集成、Sub-Agents

---

## 知识点清单

| 编号 | 知识点名称 | 核心概念 | 应用场景 | 学习时长 |
|------|-----------|---------|---------|---------|
| 19 | 自定义 Provider 集成 | models.json 配置、自定义 OAuth、API 适配器 | 私有模型、自建服务 | 2.5小时 |
| 20 | MCP Server 集成 | Model Context Protocol、MCP 工具注册、集成 | 外部服务、工具扩展 | 2小时 |
| 21 | Sub-Agents 子代理实现 | 子代理架构、代理间通信、任务委托 | 多 Agent 协作、任务分解 | 2.5小时 |
| 22 | Plan Mode 计划模式 | 计划生成、步骤执行、进度跟踪 | 复杂任务、多步骤流程 | 2小时 |
| 23 | 权限控制与沙箱 | 路径保护、权限门控、沙箱执行 | 安全控制、权限管理 | 1.5小时 |
| 24 | Git 集成与自动提交 | Git 检查点、自动提交策略、分支管理 | 版本控制、自动化 | 1.5小时 |

**总学习时长：** 约 12 小时

---

## 学习顺序建议

### 高级扩展路径（核心）
按编号顺序学习，掌握 pi-mono 的高级功能：
1. **19 - 自定义 Provider 集成**（私有模型）
2. **20 - MCP Server 集成**（外部服务）
3. **21 - Sub-Agents 子代理实现**（多 Agent）
4. **22 - Plan Mode 计划模式**（复杂任务）
5. **23 - 权限控制与沙箱**（安全控制）
6. **24 - Git 集成与自动提交**（自动化）

### 快速扩展路径（4小时）
适合想快速实现高级功能的开发者：
1. **20 - MCP Server 集成**（最实用）
2. **21 - Sub-Agents 子代理实现**（最强大）
3. **22 - Plan Mode 计划模式**（最有用）

### 实战项目驱动路径
边学边用，推荐顺序：
1. 20 - 集成 MCP Server（如数据库、API）
2. 21 - 实现 Sub-Agents（任务分解）
3. 22 - 使用 Plan Mode（复杂流程）
4. 19 - 集成自定义 Provider（可选）
5. 23 - 添加权限控制（安全）
6. 24 - 配置 Git 自动提交（自动化）

---

## 与 AI Agent 开发的关系

### 高级功能
- **19**：集成私有模型或自建服务
- **20**：扩展 Agent 的工具能力
- **21**：实现多 Agent 协作
- **22**：处理复杂的多步骤任务

### 为后续学习打基础
- **Phase 5**：基于高级功能构建实战项目
- **Phase 6**：为 pi-mono 贡献高级功能

### 构建者视角
- 理解 pi-mono 的高级扩展机制
- 掌握多 Agent 协作的设计模式
- 为构建生产级 Agent 打基础

---

## 学习检查清单

完成本 Phase 后，你应该能够：

### 自定义 Provider
- [ ] 配置 models.json 添加自定义 Provider
- [ ] 实现自定义 OAuth 流程
- [ ] 编写 API 适配器
- [ ] 测试自定义 Provider
- [ ] 理解 Provider 的认证机制

### MCP Server 集成
- [ ] 理解 Model Context Protocol
- [ ] 注册 MCP 工具
- [ ] 与 pi 工具系统集成
- [ ] 调试 MCP 集成
- [ ] 使用 MCP Server 扩展功能

### Sub-Agents
- [ ] 设计子代理架构
- [ ] 实现代理间通信
- [ ] 实现任务委托
- [ ] 处理子代理错误
- [ ] 优化多 Agent 性能

### Plan Mode
- [ ] 生成执行计划
- [ ] 执行计划步骤
- [ ] 跟踪执行进度
- [ ] 处理计划失败
- [ ] 优化计划生成

### 权限控制
- [ ] 配置路径保护
- [ ] 实现权限门控
- [ ] 配置沙箱执行
- [ ] 处理权限错误
- [ ] 审计权限使用

### Git 集成
- [ ] 配置 Git 检查点
- [ ] 实现自动提交策略
- [ ] 管理分支
- [ ] 处理 Git 冲突
- [ ] 优化提交信息

### 实战能力
- [ ] 集成至少一个自定义 Provider
- [ ] 集成至少一个 MCP Server
- [ ] 实现至少一个 Sub-Agent
- [ ] 使用 Plan Mode 处理复杂任务
- [ ] 配置权限控制
- [ ] 配置 Git 自动提交

---

## 双重类比速查表

| Pi-mono 概念 | TypeScript/Node.js 类比 | 日常生活类比 |
|-------------|------------------------|--------------|
| **自定义 Provider** |
| models.json | 数据库配置 | 服务商列表 |
| OAuth 流程 | Passport.js | 登录授权 |
| API 适配器 | Axios 拦截器 | 翻译器 |
| **MCP Server** |
| MCP | GraphQL | 外部服务接口 |
| MCP 工具 | REST API | 远程工具 |
| 集成 | API 集成 | 连接外部服务 |
| **Sub-Agents** |
| 子代理 | 微服务 | 分包商 |
| 代理间通信 | RPC/消息队列 | 对讲机 |
| 任务委托 | 任务分发 | 分配工作 |
| **Plan Mode** |
| 计划生成 | 任务分解 | 制定计划 |
| 步骤执行 | 流程引擎 | 按步骤执行 |
| 进度跟踪 | 进度条 | 检查清单 |
| **权限控制** |
| 路径保护 | 文件权限 | 门禁系统 |
| 权限门控 | 中间件 | 安检 |
| 沙箱 | Docker 容器 | 隔离环境 |
| **Git 集成** |
| 检查点 | Git commit | 保存进度 |
| 自动提交 | Git hooks | 自动保存 |
| 分支管理 | Git flow | 版本管理 |

---

## 高级扩展最佳实践

### 自定义 Provider
- **安全性**：妥善保管 API key 和 OAuth 凭证
- **错误处理**：处理网络错误和 API 限流
- **测试**：充分测试自定义 Provider
- **文档**：记录 Provider 的配置和使用

### MCP Server 集成
- **协议遵循**：严格遵循 MCP 协议规范
- **工具注册**：清晰定义工具的 schema
- **错误处理**：处理 MCP Server 的错误
- **性能**：优化 MCP 调用的性能

### Sub-Agents
- **架构设计**：合理设计子代理的职责
- **通信协议**：定义清晰的通信协议
- **错误处理**：处理子代理的失败
- **性能优化**：避免过多的代理间通信

### Plan Mode
- **计划质量**：生成清晰可执行的计划
- **步骤粒度**：合理控制步骤的粒度
- **错误恢复**：处理步骤执行失败
- **进度反馈**：提供清晰的进度反馈

---

## 常见问题

### Q1: 自定义 Provider 需要修改 pi 源码吗？
**A:** 不需要。通过 models.json 配置即可添加自定义 Provider，无需修改源码。

### Q2: MCP Server 和 Extension 有什么区别？
**A:** MCP Server 是外部服务，通过 MCP 协议与 pi 通信；Extension 是 pi 的内部扩展，直接访问 ExtensionAPI。

### Q3: Sub-Agents 会增加成本吗？
**A:** 会。每个子代理都会调用 LLM API，成本会增加。需要合理设计子代理的数量和职责。

### Q4: Plan Mode 适合什么场景？
**A:** 适合复杂的多步骤任务，如重构代码、迁移项目、生成文档等。

### Q5: 权限控制会影响性能吗？
**A:** 会有轻微影响，但安全性更重要。可以通过合理配置权限规则来优化性能。

### Q6: Git 自动提交会提交所有更改吗？
**A:** 不会。可以配置自动提交策略，只提交特定的文件或目录。

---

## 下一步学习

完成 Phase 4 后，你已经掌握了 pi-mono 的高级扩展。接下来：

- **Phase 5: 实战项目** - 基于 pi-mono 构建实际应用
- **Phase 6: 贡献与优化** - 为 pi-mono 贡献代码

---

## 参考资源

- **MCP 协议**: https://modelcontextprotocol.io
- **Provider 配置**: https://github.com/badlogic/pi-mono/tree/main/packages/pi-ai
- **Sub-Agents 示例**: https://github.com/badlogic/pi-mono/tree/main/examples/sub-agents
- **Discord 社区**: https://discord.gg/pi-mono

---

**版本：** v1.0
**最后更新：** 2026-02-17
**维护者：** Claude Code
