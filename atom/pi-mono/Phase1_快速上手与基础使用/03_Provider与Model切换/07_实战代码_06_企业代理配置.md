# 实战代码 06：企业代理配置

> **企业环境下的代理、认证与安全配置**

---

## 企业代理基础

### HTTP 代理配置

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "baseUrl": "https://corporate-proxy.com/anthropic",
      "headers": {
        "X-Corporate-Auth": "${CORPORATE_TOKEN}"
      }
    }
  }
}
```

### 环境变量配置

```bash
# ~/.bashrc or ~/.zshrc
export HTTP_PROXY="http://proxy.company.com:8080"
export HTTPS_PROXY="http://proxy.company.com:8080"
export NO_PROXY="localhost,127.0.0.1,.company.com"

# 企业认证
export CORPORATE_TOKEN="your-token"
```

---

## 认证代理配置

### 基本认证

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "baseUrl": "https://proxy.company.com/anthropic",
      "headers": {
        "Proxy-Authorization": "Basic ${PROXY_AUTH}"
      }
    }
  }
}
```

### 生成认证 Token

```bash
#!/bin/bash
# generate-proxy-auth.sh

USERNAME="your-username"
PASSWORD="your-password"

# 生成 Base64 编码
AUTH=$(echo -n "$USERNAME:$PASSWORD" | base64)

echo "export PROXY_AUTH=\"$AUTH\""
```

---

## AWS Secrets Manager 集成

### 配置

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "auth": {
        "type": "shell",
        "command": "aws secretsmanager get-secret-value --secret-id anthropic-api-key --query SecretString --output text"
      }
    }
  }
}
```

### 设置脚本

```bash
#!/bin/bash
# setup-aws-secrets.sh

SECRET_NAME="anthropic-api-key"
API_KEY="sk-ant-api03-..."

# 创建密钥
aws secretsmanager create-secret \
  --name "$SECRET_NAME" \
  --secret-string "$API_KEY"

echo "✅ Secret created: $SECRET_NAME"
```

---

## HashiCorp Vault 集成

### 配置

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "auth": {
        "type": "shell",
        "command": "vault kv get -field=api_key secret/anthropic"
      }
    }
  }
}
```

### 设置脚本

```bash
#!/bin/bash
# setup-vault.sh

# 登录 Vault
vault login

# 存储密钥
vault kv put secret/anthropic api_key="sk-ant-api03-..."

echo "✅ Secret stored in Vault"
```

---

## 1Password CLI 集成

### 配置

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "auth": {
        "type": "shell",
        "command": "op read 'op://Private/Anthropic API Key/credential'"
      }
    }
  }
}
```

### 设置脚本

```bash
#!/bin/bash
# setup-1password.sh

# 登录 1Password
eval $(op signin)

# 创建项目
op item create \
  --category=login \
  --title="Anthropic API Key" \
  --vault=Private \
  credential="sk-ant-api03-..."

echo "✅ API Key stored in 1Password"
```

---

## 自定义 Headers

### 完整配置

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "baseUrl": "https://api.anthropic.com",
      "headers": {
        "X-Corporate-ID": "${CORPORATE_ID}",
        "X-Department": "Engineering",
        "X-Cost-Center": "R&D",
        "User-Agent": "CompanyName-Pi/1.0"
      }
    }
  }
}
```

---

## SSL 证书配置

### 自签名证书

```bash
# 添加证书到系统
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain company-ca.crt

# 设置环境变量
export NODE_EXTRA_CA_CERTS="/path/to/company-ca.crt"
```

### 禁用 SSL 验证（仅开发环境）

```bash
# ⚠️ 仅用于开发环境
export NODE_TLS_REJECT_UNAUTHORIZED=0
```

---

## 完整企业配置模板

```json
// ~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "baseUrl": "https://corporate-proxy.com/anthropic",
      "headers": {
        "X-Corporate-Auth": "${CORPORATE_TOKEN}",
        "X-Department": "Engineering",
        "X-Cost-Center": "${COST_CENTER}"
      },
      "auth": {
        "type": "shell",
        "command": "aws secretsmanager get-secret-value --secret-id anthropic-api-key --query SecretString --output text"
      },
      "models": {
        "claude-3-5-sonnet-20241022": {
          "id": "claude-3-5-sonnet-20241022",
          "name": "Claude 3.5 Sonnet",
          "contextWindow": 200000,
          "maxOutput": 8192,
          "cost": { "input": 3.0, "output": 15.0 }
        }
      }
    }
  }
}
```

---

## 合规性配置

### 数据驻留

```json
// 欧盟数据驻留
{
  "providers": {
    "anthropic": {
      "baseUrl": "https://api.eu.anthropic.com",
      "headers": {
        "X-Data-Region": "EU"
      }
    }
  }
}
```

### 审计日志

```typescript
// audit-logger.ts
import { writeFileSync, appendFileSync } from 'fs';

interface AuditLog {
  timestamp: Date;
  user: string;
  provider: string;
  model: string;
  prompt: string;
  response: string;
}

class AuditLogger {
  private logFile: string;

  constructor(logFile: string = '/var/log/pi-audit.log') {
    this.logFile = logFile;
  }

  log(entry: AuditLog) {
    const line = JSON.stringify({
      ...entry,
      timestamp: entry.timestamp.toISOString()
    });

    appendFileSync(this.logFile, line + '\n');
  }
}
```

---

## 故障排查

### 代理连接测试

```bash
#!/bin/bash
# test-proxy.sh

echo "Testing proxy connection..."

# 测试 HTTP 代理
if curl -x "$HTTP_PROXY" -I https://api.anthropic.com 2>/dev/null; then
  echo "✅ HTTP proxy working"
else
  echo "❌ HTTP proxy failed"
fi

# 测试认证
if curl -H "Proxy-Authorization: Basic $PROXY_AUTH" \
     -x "$HTTP_PROXY" \
     -I https://api.anthropic.com 2>/dev/null; then
  echo "✅ Proxy authentication working"
else
  echo "❌ Proxy authentication failed"
fi
```

### 证书验证

```bash
#!/bin/bash
# verify-cert.sh

echo "Verifying SSL certificate..."

# 检查证书
openssl s_client -connect api.anthropic.com:443 \
  -CAfile /path/to/company-ca.crt \
  </dev/null 2>/dev/null | grep "Verify return code"
```

---

## 安全最佳实践

### 1. 密钥轮换

```bash
#!/bin/bash
# rotate-keys.sh

# 1. 生成新密钥（在 Provider 控制台）
NEW_KEY="sk-ant-api03-new..."

# 2. 更新 Secrets Manager
aws secretsmanager update-secret \
  --secret-id anthropic-api-key \
  --secret-string "$NEW_KEY"

# 3. 重载 Pi 配置
pi --reload

echo "✅ Key rotated"
```

### 2. 最小权限原则

```json
// IAM 策略示例
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:anthropic-api-key-*"
    }
  ]
}
```

### 3. 网络隔离

```bash
# 仅允许特定 IP 访问
iptables -A OUTPUT -d api.anthropic.com -j ACCEPT
iptables -A OUTPUT -j DROP
```

---

**记住**：企业环境安全第一，遵循公司安全政策和合规要求。
