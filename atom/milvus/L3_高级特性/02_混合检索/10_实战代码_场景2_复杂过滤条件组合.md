# 实战代码 - 场景2：复杂过滤条件组合

演示各种复杂的过滤表达式组合，包括 AND、OR、IN、范围查询等。

---

## 场景描述

**目标**：测试各种复杂的过滤条件组合

**测试内容**：
- AND 逻辑组合
- OR 逻辑组合
- IN 操作符
- 范围查询
- 复杂嵌套条件

---

## 完整代码

```python
"""
场景2：复杂过滤条件组合
演示：AND/OR/IN/范围查询等复杂表达式
"""

from pymilvus import connections, Collection, utility
import numpy as np
import time

# ===== 1. 连接并加载 Collection =====
print("=== 1. 连接并加载 Collection ===")

connections.connect("default", host="localhost", port="19530")

# 使用场景1创建的 Collection
collection_name = "documents_basic"

if not utility.has_collection(collection_name):
    print(f"❌ Collection {collection_name} 不存在")
    print("请先运行场景1创建 Collection")
    exit(1)

collection = Collection(collection_name)
collection.load()

print(f"✓ Collection 加载成功: {collection_name}")
print(f"  - 数据量: {collection.num_entities}")

# ===== 2. 准备查询向量 =====
print("\n=== 2. 准备查询向量 ===")

query_vector = np.random.rand(768).tolist()

print("✓ 查询向量准备完成")

# ===== 3. AND 逻辑组合 =====
print("\n=== 3. AND 逻辑组合 ===")

# 3.1 两个条件
print("  3.1 两个条件: year == 2024 AND category == 'tutorial'")

expr = "year == 2024 and category == 'tutorial'"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

if len(results[0]) > 0:
    # 验证结果
    all_match = all(
        hit.entity.get('year') == 2024 and
        hit.entity.get('category') == 'tutorial'
        for hit in results[0]
    )
    print(f"  ✓ 所有结果都满足条件: {all_match}")

# 3.2 三个条件
print("\n  3.2 三个条件: year == 2024 AND category == 'tutorial' AND rating >= 4.5")

expr = "year == 2024 and category == 'tutorial' and rating >= 4.5"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# ===== 4. OR 逻辑组合 =====
print("\n=== 4. OR 逻辑组合 ===")

# 4.1 两个条件
print("  4.1 两个条件: year == 2024 OR year == 2023")

expr = "year == 2024 or year == 2023"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

if len(results[0]) > 0:
    # 验证结果
    all_match = all(
        hit.entity.get('year') in [2024, 2023]
        for hit in results[0]
    )
    print(f"  ✓ 所有结果都满足条件: {all_match}")

# 4.2 类别 OR
print("\n  4.2 类别 OR: category == 'tutorial' OR category == 'guide'")

expr = "category == 'tutorial' or category == 'guide'"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# ===== 5. IN 操作符 =====
print("\n=== 5. IN 操作符 ===")

# 5.1 年份 IN
print("  5.1 年份 IN: year in [2023, 2024]")

expr = "year in [2023, 2024]"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# 5.2 类别 IN
print("\n  5.2 类别 IN: category in ['tutorial', 'guide', 'documentation']")

expr = "category in ['tutorial', 'guide', 'documentation']"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

if len(results[0]) > 0:
    # 验证结果
    all_match = all(
        hit.entity.get('category') in ['tutorial', 'guide', 'documentation']
        for hit in results[0]
    )
    print(f"  ✓ 所有结果都满足条件: {all_match}")

# ===== 6. 范围查询 =====
print("\n=== 6. 范围查询 ===")

# 6.1 评分范围
print("  6.1 评分范围: rating >= 4.0 AND rating <= 5.0")

expr = "rating >= 4.0 and rating <= 5.0"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# 6.2 年份范围
print("\n  6.2 年份范围: year >= 2022 AND year <= 2024")

expr = "year >= 2022 and year <= 2024"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# ===== 7. 复杂嵌套条件 =====
print("\n=== 7. 复杂嵌套条件 ===")

# 7.1 AND + OR 组合
print("  7.1 AND + OR: (year == 2024 OR year == 2023) AND rating >= 4.5")

expr = "(year == 2024 or year == 2023) and rating >= 4.5"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# 7.2 IN + AND 组合
print("\n  7.2 IN + AND: year in [2023, 2024] AND category in ['tutorial', 'guide'] AND rating >= 4.0")

expr = "year in [2023, 2024] and category in ['tutorial', 'guide'] and rating >= 4.0"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# 7.3 复杂嵌套
print("\n  7.3 复杂嵌套: ((year == 2024 AND category == 'tutorial') OR (year == 2023 AND category == 'guide')) AND rating >= 4.5")

expr = "((year == 2024 and category == 'tutorial') or (year == 2023 and category == 'guide')) and rating >= 4.5"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

if len(results[0]) > 0:
    print("\n  前3条结果:")
    for i, hit in enumerate(results[0][:3]):
        print(f"    {i+1}. Year: {hit.entity.get('year')}, Category: {hit.entity.get('category')}, Rating: {hit.entity.get('rating')}")

# ===== 8. NOT 操作符 =====
print("\n=== 8. NOT 操作符 ===")

# 8.1 NOT 单个条件
print("  8.1 NOT 单个条件: NOT (category == 'blog')")

expr = "not (category == 'blog')"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# 8.2 NOT IN
print("\n  8.2 NOT IN: category not in ['blog', 'paper']")

expr = "category not in ['blog', 'paper']"

start = time.time()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
elapsed = time.time() - start

print(f"  ✓ 查询完成，耗时: {elapsed*1000:.2f}ms")
print(f"  ✓ 返回结果数: {len(results[0])}")

# ===== 9. 性能对比：OR vs IN =====
print("\n=== 9. 性能对比：OR vs IN ===")

# 9.1 使用 OR
print("  9.1 使用 OR...")

expr_or = "category == 'tutorial' or category == 'guide' or category == 'documentation'"

start = time.time()
for _ in range(10):
    collection.search(
        data=[query_vector],
        anns_field="embedding",
        param={"metric_type": "L2", "params": {"ef": 64}},
        limit=10,
        expr=expr_or
    )
time_or = (time.time() - start) / 10

print(f"  ✓ 平均耗时: {time_or*1000:.2f}ms")

# 9.2 使用 IN
print("\n  9.2 使用 IN...")

expr_in = "category in ['tutorial', 'guide', 'documentation']"

start = time.time()
for _ in range(10):
    collection.search(
        data=[query_vector],
        anns_field="embedding",
        param={"metric_type": "L2", "params": {"ef": 64}},
        limit=10,
        expr=expr_in
    )
time_in = (time.time() - start) / 10

print(f"  ✓ 平均耗时: {time_in*1000:.2f}ms")

print(f"\n  性能对比:")
print(f"    - OR:  {time_or*1000:.2f}ms")
print(f"    - IN:  {time_in*1000:.2f}ms")
print(f"    - IN 快: {(time_or/time_in - 1)*100:.1f}%")

# ===== 10. 清理 =====
print("\n=== 10. 清理 ===")

collection.release()
connections.disconnect("default")

print("✓ 资源已释放")
print("\n=== 场景2完成 ===")
```

---

## 运行输出示例

```
=== 1. 连接并加载 Collection ===
✓ Collection 加载成功: documents_basic
  - 数据量: 1000

=== 2. 准备查询向量 ===
✓ 查询向量准备完成

=== 3. AND 逻辑组合 ===
  3.1 两个条件: year == 2024 AND category == 'tutorial'
  ✓ 查询完成，耗时: 8.23ms
  ✓ 返回结果数: 5
  ✓ 所有结果都满足条件: True

  3.2 三个条件: year == 2024 AND category == 'tutorial' AND rating >= 4.5
  ✓ 查询完成，耗时: 7.45ms
  ✓ 返回结果数: 2

=== 4. OR 逻辑组合 ===
  4.1 两个条件: year == 2024 OR year == 2023
  ✓ 查询完成，耗时: 10.12ms
  ✓ 返回结果数: 10
  ✓ 所有结果都满足条件: True

  4.2 类别 OR: category == 'tutorial' OR category == 'guide'
  ✓ 查询完成，耗时: 9.87ms
  ✓ 返回结果数: 10

=== 5. IN 操作符 ===
  5.1 年份 IN: year in [2023, 2024]
  ✓ 查询完成，耗时: 9.34ms
  ✓ 返回结果数: 10

  5.2 类别 IN: category in ['tutorial', 'guide', 'documentation']
  ✓ 查询完成，耗时: 8.91ms
  ✓ 返回结果数: 10
  ✓ 所有结果都满足条件: True

=== 6. 范围查询 ===
  6.1 评分范围: rating >= 4.0 AND rating <= 5.0
  ✓ 查询完成，耗时: 10.45ms
  ✓ 返回结果数: 10

  6.2 年份范围: year >= 2022 AND year <= 2024
  ✓ 查询完成，耗时: 11.23ms
  ✓ 返回结果数: 10

=== 7. 复杂嵌套条件 ===
  7.1 AND + OR: (year == 2024 OR year == 2023) AND rating >= 4.5
  ✓ 查询完成，耗时: 9.67ms
  ✓ 返回结果数: 8

  7.2 IN + AND: year in [2023, 2024] AND category in ['tutorial', 'guide'] AND rating >= 4.0
  ✓ 查询完成，耗时: 8.34ms
  ✓ 返回结果数: 6

  7.3 复杂嵌套: ((year == 2024 AND category == 'tutorial') OR (year == 2023 AND category == 'guide')) AND rating >= 4.5
  ✓ 查询完成，耗时: 7.89ms
  ✓ 返回结果数: 3

  前3条结果:
    1. Year: 2024, Category: tutorial, Rating: 4.8
    2. Year: 2023, Category: guide, Rating: 4.7
    3. Year: 2024, Category: tutorial, Rating: 4.6

=== 8. NOT 操作符 ===
  8.1 NOT 单个条件: NOT (category == 'blog')
  ✓ 查询完成，耗时: 11.56ms
  ✓ 返回结果数: 10

  8.2 NOT IN: category not in ['blog', 'paper']
  ✓ 查询完成，耗时: 10.23ms
  ✓ 返回结果数: 10

=== 9. 性能对比：OR vs IN ===
  9.1 使用 OR...
  ✓ 平均耗时: 10.45ms

  9.2 使用 IN...
  ✓ 平均耗时: 8.91ms

  性能对比:
    - OR:  10.45ms
    - IN:  8.91ms
    - IN 快: 17.3%

=== 10. 清理 ===
✓ 资源已释放

=== 场景2完成 ===
```

---

## 关键要点

### 1. 表达式语法总结

```python
# AND 逻辑
expr = "year == 2024 and category == 'tutorial'"

# OR 逻辑
expr = "year == 2024 or year == 2023"

# IN 操作符
expr = "category in ['tutorial', 'guide', 'documentation']"

# 范围查询
expr = "rating >= 4.0 and rating <= 5.0"

# 复杂嵌套
expr = "(year == 2024 or year == 2023) and rating >= 4.5"

# NOT 操作符
expr = "not (category == 'blog')"
expr = "category not in ['blog', 'paper']"
```

### 2. 性能优化建议

- **使用 IN 代替多个 OR**：IN 性能更好（快 15-20%）
- **高选择性条件前置**：`tenant_id == 'A' and age > 18`
- **避免复杂的 NOT**：NOT 需要全表扫描
- **合理使用括号**：明确优先级，避免歧义

### 3. 常见错误

```python
# ❌ 错误：字符串没有引号
expr = "category == tutorial"

# ✅ 正确
expr = "category == 'tutorial'"

# ❌ 错误：类型不匹配
expr = "year == '2024'"  # year 是 INT64

# ✅ 正确
expr = "year == 2024"
```

---

**下一步**：学习 [11_实战代码_场景3_性能对比测试.md](./11_实战代码_场景3_性能对比测试.md)
