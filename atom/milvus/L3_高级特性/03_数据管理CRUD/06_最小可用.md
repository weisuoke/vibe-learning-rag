# æœ€å°å¯ç”¨ - Milvus æ•°æ®ç®¡ç† CRUD

> ç”¨æœ€å°‘çš„ä»£ç ï¼ŒæŒæ¡ Milvus CRUD çš„æ ¸å¿ƒæ“ä½œ

---

## æ ¸å¿ƒç†å¿µ

**æœ€å°å¯ç”¨é›† = Insert + Query + Delete**

è¿™ä¸‰ä¸ªæ“ä½œæ„æˆäº† Milvus æ•°æ®ç®¡ç†çš„æœ€å°é—­ç¯ï¼š
- **Insert**: æŠŠæ•°æ®æ”¾è¿›å»
- **Query**: æŠŠæ•°æ®å–å‡ºæ¥
- **Delete**: æŠŠæ•°æ®åˆ æ‰

æŒæ¡è¿™ä¸‰ä¸ªæ“ä½œï¼Œä½ å°±èƒ½æ„å»ºä¸€ä¸ªåŸºæœ¬çš„å‘é‡æ•°æ®åº“åº”ç”¨ã€‚

---

## æœ€å°å¯ç”¨ä»£ç ï¼ˆ50è¡Œï¼‰

```python
from pymilvus import connections, Collection, FieldSchema, CollectionSchema, DataType
import numpy as np

# ============================================================
# ç¬¬ä¸€æ­¥ï¼šè¿æ¥ Milvus
# ============================================================
connections.connect(
    alias="default",
    host="localhost",
    port="19530"
)

# ============================================================
# ç¬¬äºŒæ­¥ï¼šåˆ›å»º Collectionï¼ˆåªéœ€è¦åšä¸€æ¬¡ï¼‰
# ============================================================
# å®šä¹‰å­—æ®µ
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=False),
    FieldSchema(name="text", dtype=DataType.VARCHAR, max_length=500),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=128)
]

# åˆ›å»º Schema å’Œ Collection
schema = CollectionSchema(fields=fields, description="æœ€å°å¯ç”¨ç¤ºä¾‹")
collection = Collection(name="minimal_crud", schema=schema)

# åˆ›å»ºç´¢å¼•ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æ— æ³•æ£€ç´¢ï¼‰
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "L2",
    "params": {"nlist": 128}
}
collection.create_index(field_name="embedding", index_params=index_params)

# ============================================================
# ç¬¬ä¸‰æ­¥ï¼šæ’å…¥æ•°æ®ï¼ˆInsertï¼‰
# ============================================================
# å‡†å¤‡æ•°æ®
data = [
    [1, 2, 3],  # id
    ["æ–‡æœ¬A", "æ–‡æœ¬B", "æ–‡æœ¬C"],  # text
    [np.random.rand(128).tolist() for _ in range(3)]  # embedding
]

# æ’å…¥
collection.insert(data)
collection.flush()  # ç¡®ä¿æ•°æ®æŒä¹…åŒ–

# åŠ è½½åˆ°å†…å­˜ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æ— æ³•æ£€ç´¢ï¼‰
collection.load()

# ============================================================
# ç¬¬å››æ­¥ï¼šæŸ¥è¯¢æ•°æ®ï¼ˆQueryï¼‰
# ============================================================
# æ–¹å¼1: æŒ‰ä¸»é”®æŸ¥è¯¢ï¼ˆç²¾ç¡®æŸ¥è¯¢ï¼‰
results = collection.query(
    expr="id in [1, 2]",
    output_fields=["id", "text"]
)
print("Query ç»“æœ:", results)

# æ–¹å¼2: å‘é‡æ£€ç´¢ï¼ˆç›¸ä¼¼åº¦æŸ¥è¯¢ï¼‰
search_vector = [np.random.rand(128).tolist()]
search_results = collection.search(
    data=search_vector,
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=2,
    output_fields=["id", "text"]
)
print("Search ç»“æœ:", search_results[0])

# ============================================================
# ç¬¬äº”æ­¥ï¼šåˆ é™¤æ•°æ®ï¼ˆDeleteï¼‰
# ============================================================
# æŒ‰æ¡ä»¶åˆ é™¤
collection.delete(expr="id in [3]")
collection.flush()

print("åˆ é™¤å®Œæˆï¼")

# ============================================================
# ç¬¬å…­æ­¥ï¼šæ¸…ç†èµ„æº
# ============================================================
collection.release()  # é‡Šæ”¾å†…å­˜
# collection.drop()  # åˆ é™¤ Collectionï¼ˆå¯é€‰ï¼‰
```

---

## ä¸‰å¤§æ ¸å¿ƒæ“ä½œè¯¦è§£

### 1. Insert - æ’å…¥æ•°æ®

**æœ€ç®€å•çš„æ’å…¥**ï¼š

```python
# å‡†å¤‡æ•°æ®ï¼ˆåˆ—å¼å­˜å‚¨ï¼‰
data = [
    [1, 2, 3],  # ä¸»é”® id
    ["A", "B", "C"],  # æ–‡æœ¬å­—æ®µ
    [[0.1]*128, [0.2]*128, [0.3]*128]  # å‘é‡å­—æ®µ
]

# æ’å…¥
collection.insert(data)
collection.flush()  # æŒä¹…åŒ–
```

**å…³é”®ç‚¹**ï¼š
- æ•°æ®æ ¼å¼ï¼šåˆ—å¼å­˜å‚¨ï¼ˆæ¯ä¸ªå­—æ®µä¸€ä¸ªåˆ—è¡¨ï¼‰
- å¿…é¡»è°ƒç”¨ `flush()` ç¡®ä¿æ•°æ®æŒä¹…åŒ–
- æ’å…¥åéœ€è¦ `load()` æ‰èƒ½æ£€ç´¢

---

### 2. Query - æŸ¥è¯¢æ•°æ®

**ä¸¤ç§æŸ¥è¯¢æ–¹å¼**ï¼š

#### æ–¹å¼1: ç²¾ç¡®æŸ¥è¯¢ï¼ˆQueryï¼‰

```python
# æŒ‰æ¡ä»¶æŸ¥è¯¢
results = collection.query(
    expr="id in [1, 2, 3]",  # æŸ¥è¯¢è¡¨è¾¾å¼
    output_fields=["id", "text"]  # è¿”å›å­—æ®µ
)

# ç»“æœæ˜¯åˆ—è¡¨
for result in results:
    print(f"ID: {result['id']}, Text: {result['text']}")
```

#### æ–¹å¼2: å‘é‡æ£€ç´¢ï¼ˆSearchï¼‰

```python
# ç›¸ä¼¼åº¦æ£€ç´¢
search_vector = [[0.15]*128]  # æŸ¥è¯¢å‘é‡

results = collection.search(
    data=search_vector,  # æŸ¥è¯¢å‘é‡
    anns_field="embedding",  # å‘é‡å­—æ®µå
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=5,  # è¿”å› Top-5
    output_fields=["id", "text"]
)

# ç»“æœæ˜¯åµŒå¥—åˆ—è¡¨
for hits in results:
    for hit in hits:
        print(f"ID: {hit.id}, Distance: {hit.distance}, Text: {hit.entity.get('text')}")
```

**å…³é”®åŒºåˆ«**ï¼š
- **Query**: ç²¾ç¡®æŸ¥è¯¢ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰æ•°æ®
- **Search**: ç›¸ä¼¼åº¦æ£€ç´¢ï¼Œè¿”å›æœ€ç›¸ä¼¼çš„ Top-K æ•°æ®

---

### 3. Delete - åˆ é™¤æ•°æ®

**æŒ‰æ¡ä»¶åˆ é™¤**ï¼š

```python
# åˆ é™¤æŒ‡å®š ID
collection.delete(expr="id in [1, 2, 3]")

# åˆ é™¤ç¬¦åˆæ¡ä»¶çš„æ•°æ®
collection.delete(expr="id > 100")

# æŒä¹…åŒ–åˆ é™¤
collection.flush()
```

**å…³é”®ç‚¹**ï¼š
- åªèƒ½æŒ‰è¡¨è¾¾å¼åˆ é™¤ï¼Œä¸èƒ½æŒ‰å‘é‡ç›¸ä¼¼åº¦åˆ é™¤
- åˆ é™¤æ˜¯é€»è¾‘åˆ é™¤ï¼Œéœ€è¦ Compaction æ‰èƒ½çœŸæ­£é‡Šæ”¾ç©ºé—´
- å¿…é¡»è°ƒç”¨ `flush()` ç¡®ä¿åˆ é™¤ç”Ÿæ•ˆ

---

## æœ€å°å¯ç”¨å·¥ä½œæµ

```
1. è¿æ¥ Milvus
   â†“
2. åˆ›å»º Collection + ç´¢å¼•ï¼ˆä¸€æ¬¡æ€§ï¼‰
   â†“
3. æ’å…¥æ•°æ® â†’ flush() â†’ load()
   â†“
4. æŸ¥è¯¢æ•°æ®ï¼ˆQuery æˆ– Searchï¼‰
   â†“
5. åˆ é™¤æ•°æ® â†’ flush()
   â†“
6. é‡Šæ”¾èµ„æº release()
```

---

## å¸¸è§é”™è¯¯ä¸è§£å†³

### é”™è¯¯1: æ£€ç´¢æ—¶æŠ¥é”™ "collection not loaded"

**åŸå› **: å¿˜è®°è°ƒç”¨ `collection.load()`

**è§£å†³**:
```python
collection.load()  # åŠ è½½åˆ°å†…å­˜
```

---

### é”™è¯¯2: æ’å…¥åæŸ¥è¯¢ä¸åˆ°æ•°æ®

**åŸå› **: å¿˜è®°è°ƒç”¨ `collection.flush()`

**è§£å†³**:
```python
collection.insert(data)
collection.flush()  # æŒä¹…åŒ–
```

---

### é”™è¯¯3: Search æŠ¥é”™ "index not created"

**åŸå› **: å¿˜è®°åˆ›å»ºç´¢å¼•

**è§£å†³**:
```python
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "L2",
    "params": {"nlist": 128}
}
collection.create_index(field_name="embedding", index_params=index_params)
```

---

### é”™è¯¯4: åˆ é™¤åæ•°æ®è¿˜åœ¨

**åŸå› **: å¿˜è®°è°ƒç”¨ `collection.flush()`

**è§£å†³**:
```python
collection.delete(expr="id in [1, 2, 3]")
collection.flush()  # æŒä¹…åŒ–åˆ é™¤
```

---

## æœ€å°å¯ç”¨æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ä½¿ç”¨ Milvus CRUD å‰ï¼Œç¡®ä¿ä½ å·²ç»ï¼š

- [ ] **è¿æ¥æˆåŠŸ**: `connections.connect()` æ— æŠ¥é”™
- [ ] **åˆ›å»º Collection**: å®šä¹‰äº† Schema å’Œå­—æ®µ
- [ ] **åˆ›å»ºç´¢å¼•**: å‘é‡å­—æ®µå¿…é¡»æœ‰ç´¢å¼•
- [ ] **æ’å…¥æ•°æ®**: ä½¿ç”¨ `insert()` + `flush()`
- [ ] **åŠ è½½ Collection**: è°ƒç”¨ `load()` åŠ è½½åˆ°å†…å­˜
- [ ] **æŸ¥è¯¢æ•°æ®**: ä½¿ç”¨ `query()` æˆ– `search()`
- [ ] **åˆ é™¤æ•°æ®**: ä½¿ç”¨ `delete()` + `flush()`
- [ ] **é‡Šæ”¾èµ„æº**: ä½¿ç”¨ `release()` é‡Šæ”¾å†…å­˜

---

## å¿«é€ŸéªŒè¯è„šæœ¬

```python
from pymilvus import connections, Collection, FieldSchema, CollectionSchema, DataType
import numpy as np

def test_minimal_crud():
    """æœ€å°å¯ç”¨ CRUD æµ‹è¯•"""

    # 1. è¿æ¥
    connections.connect(host="localhost", port="19530")
    print("âœ“ è¿æ¥æˆåŠŸ")

    # 2. åˆ›å»º Collection
    fields = [
        FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=False),
        FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=128)
    ]
    schema = CollectionSchema(fields=fields)
    collection = Collection(name="test_crud", schema=schema)
    print("âœ“ Collection åˆ›å»ºæˆåŠŸ")

    # 3. åˆ›å»ºç´¢å¼•
    index_params = {"index_type": "IVF_FLAT", "metric_type": "L2", "params": {"nlist": 128}}
    collection.create_index(field_name="embedding", index_params=index_params)
    print("âœ“ ç´¢å¼•åˆ›å»ºæˆåŠŸ")

    # 4. æ’å…¥æ•°æ®
    data = [[1, 2, 3], [np.random.rand(128).tolist() for _ in range(3)]]
    collection.insert(data)
    collection.flush()
    print("âœ“ æ•°æ®æ’å…¥æˆåŠŸ")

    # 5. åŠ è½½
    collection.load()
    print("âœ“ Collection åŠ è½½æˆåŠŸ")

    # 6. æŸ¥è¯¢
    results = collection.query(expr="id in [1, 2]", output_fields=["id"])
    assert len(results) == 2
    print("âœ“ æŸ¥è¯¢æˆåŠŸ")

    # 7. æ£€ç´¢
    search_vector = [np.random.rand(128).tolist()]
    search_results = collection.search(
        data=search_vector,
        anns_field="embedding",
        param={"metric_type": "L2", "params": {"nprobe": 10}},
        limit=2
    )
    assert len(search_results[0]) == 2
    print("âœ“ æ£€ç´¢æˆåŠŸ")

    # 8. åˆ é™¤
    collection.delete(expr="id in [3]")
    collection.flush()
    print("âœ“ åˆ é™¤æˆåŠŸ")

    # 9. æ¸…ç†
    collection.release()
    collection.drop()
    print("âœ“ æ¸…ç†å®Œæˆ")

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")

if __name__ == "__main__":
    test_minimal_crud()
```

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡äº†æœ€å°å¯ç”¨æ“ä½œåï¼Œä½ å¯ä»¥ï¼š

1. **å­¦ä¹ æ‰¹é‡æ“ä½œ** â†’ æå‡æ’å…¥æ€§èƒ½
2. **å­¦ä¹ å¤æ‚æŸ¥è¯¢** â†’ æŒæ¡æ ‡é‡è¿‡æ»¤å’Œæ··åˆæ£€ç´¢
3. **å­¦ä¹  Upsert** â†’ å®ç°æ•°æ®æ›´æ–°
4. **å­¦ä¹ åˆ†åŒºç®¡ç†** â†’ ä¼˜åŒ–å¤§è§„æ¨¡æ•°æ®æ£€ç´¢

è¯¦è§åç»­ç« èŠ‚ã€‚

---

## æ€»ç»“

**æœ€å°å¯ç”¨ = 3 ä¸ªæ“ä½œ + 6 ä¸ªæ­¥éª¤**

**3 ä¸ªæ“ä½œ**ï¼š
- Insertï¼ˆæ’å…¥ï¼‰
- Query/Searchï¼ˆæŸ¥è¯¢/æ£€ç´¢ï¼‰
- Deleteï¼ˆåˆ é™¤ï¼‰

**6 ä¸ªæ­¥éª¤**ï¼š
1. è¿æ¥ Milvus
2. åˆ›å»º Collection + ç´¢å¼•
3. æ’å…¥æ•°æ® + flush
4. åŠ è½½ Collection
5. æŸ¥è¯¢/æ£€ç´¢æ•°æ®
6. é‡Šæ”¾èµ„æº

**è®°ä½**ï¼š
- æ’å…¥åå¿…é¡» `flush()` + `load()`
- åˆ é™¤åå¿…é¡» `flush()`
- æ£€ç´¢å‰å¿…é¡»åˆ›å»ºç´¢å¼•

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [07_åŒé‡ç±»æ¯”.md](./07_åŒé‡ç±»æ¯”.md) åŠ æ·±ç†è§£
