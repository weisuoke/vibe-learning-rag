# 实战代码：多项目切换配置

> 完整的多项目配置方案，实现不同项目间的快速切换和独立配置

---

## 一、场景描述

**开发者背景：**
- 同时维护 3 个项目
- 项目 A：TypeScript + React（电商平台）
- 项目 B：Python + FastAPI（后端 API）
- 项目 C：Next.js（个人博客）

**痛点：**
- 每个项目技术栈不同
- 每个项目规范不同
- 频繁切换项目时需要重新告诉 AI 项目信息
- 希望 Pi Agent 能自动适应当前项目

**目标：**
- 每个项目独立配置
- 切换项目时自动加载对应配置
- 不同项目使用不同模型（成本优化）
- 保持个人全局偏好

---

## 二、配置架构

### 2.1 目录结构

```bash
~/.pi/agent/                          # 全局配置（个人偏好）
├── AGENTS.md                         # 个人工作习惯
├── settings.json                     # 全局设置
└── APPEND_SYSTEM.md                  # 个人工作风格

~/projects/
├── project-a-ecommerce/              # 项目 A：电商平台
│   ├── AGENTS.md                     # 项目 A 规范
│   ├── .pi/
│   │   ├── settings.json             # 项目 A 配置
│   │   └── APPEND_SYSTEM.md          # 项目 A 特定行为
│   └── src/
│
├── project-b-api/                    # 项目 B：后端 API
│   ├── AGENTS.md                     # 项目 B 规范
│   ├── .pi/
│   │   ├── settings.json             # 项目 B 配置
│   │   └── APPEND_SYSTEM.md          # 项目 B 特定行为
│   └── app/
│
└── project-c-blog/                   # 项目 C：个人博客
    ├── AGENTS.md                     # 项目 C 规范
    ├── .pi/
    │   └── settings.json             # 项目 C 配置
    └── app/
```

### 2.2 配置层级

```
全局配置（个人偏好）
↓ 继承
项目配置（项目特定）
↓
最终生效配置
```

---

## 三、全局配置（个人偏好）

### 3.1 ~/.pi/agent/AGENTS.md

```markdown
# 个人工作习惯

## 代码风格偏好
- 简洁优先，避免过度工程
- 函数长度不超过 50 行
- 使用有意义的变量名

## 工作方式
- 代码优先，少说多做
- 不要问"需要我继续吗？"
- 直接给出最佳方案，不要列举多个选项

## 常用工具
- 编辑器：VS Code
- 终端：iTerm2 + zsh
- Git 工具：lazygit

## 个人偏好
- 喜欢使用 Vim 快捷键
- 喜欢使用函数式编程风格
- 喜欢使用 TypeScript 类型推导
```

### 3.2 ~/.pi/agent/settings.json

```json
{
  "defaultModel": "claude-sonnet-4",
  "theme": "dark",
  "quietStartup": true,
  "collapseChangelog": true,
  "showTokenUsage": true,
  "compaction": {
    "enabled": true,
    "reserveTokens": 50000,
    "keepRecentTokens": 10000
  },
  "shellPath": "/bin/zsh",
  "autoSave": true,
  "logLevel": "info"
}
```

### 3.3 ~/.pi/agent/APPEND_SYSTEM.md

```markdown
# 个人工作风格

## 沟通方式
- 简洁直接，不要冗长的解释
- 代码优先，少说多做
- 不要输出"让我来帮你..."之类的开场白

## 代码风格
- 优先使用函数式编程
- 使用 const 声明所有变量
- 避免使用 any 类型

## 工作流程
- 每次修改代码后自动运行测试
- 提交前自动运行 lint
- 不要问"需要我运行测试吗？"，直接运行
```

---

## 四、项目 A 配置（TypeScript + React）

### 4.1 project-a-ecommerce/AGENTS.md

```markdown
# 项目 A：电商平台前端

## 项目概述
基于 TypeScript + React 的电商平台前端。

## 技术栈
- TypeScript 5.3
- React 18.2
- Vite 5.0
- pnpm
- Zustand（状态管理）
- Tailwind CSS（样式）
- React Query（API 调用）

## 目录结构
```
src/
├── features/       # 功能模块
│   ├── products/   # 商品模块
│   ├── cart/       # 购物车模块
│   └── orders/     # 订单模块
├── components/     # 共享组件
├── hooks/          # 共享 Hooks
├── utils/          # 工具函数
└── api/            # API 调用
```

## 开发规范
- 代码风格：Prettier + ESLint
- 提交规范：Conventional Commits
- 测试要求：核心功能必须有单元测试

## 命名约定
- 组件：PascalCase（UserProfile.tsx）
- 文件：kebab-case（user-profile.utils.ts）
- 变量：camelCase（userName）
- 常量：UPPER_SNAKE_CASE（API_BASE_URL）

## 常用命令
- `pnpm dev` - 启动开发服务器
- `pnpm build` - 构建生产版本
- `pnpm test` - 运行测试
- `pnpm lint` - 代码检查

## 注意事项
- ⚠️ 不要修改 src/legacy/ 目录
- ⚠️ API 调用统一使用 src/api/client.ts
- ⚠️ 所有组件必须有 TypeScript 类型
```

### 4.2 project-a-ecommerce/.pi/settings.json

```json
{
  "defaultModel": "claude-opus-4",
  "compaction": {
    "enabled": true,
    "reserveTokens": 80000,
    "keepRecentTokens": 20000
  },
  "skills": [
    "./.pi/skills/react"
  ]
}
```

**说明：**
- 使用 Opus 模型（重要项目，需要高质量）
- 更高的 token 保留（复杂项目）
- 加载 React 特定技能

### 4.3 project-a-ecommerce/.pi/APPEND_SYSTEM.md

```markdown
# 项目 A 特定行为

## 代码风格
- 使用函数式组件
- 使用 React Hooks
- 优先使用 Zustand 管理状态
- 样式使用 Tailwind CSS

## API 调用
- 所有 API 调用使用 React Query
- 统一使用 src/api/client.ts
- 错误处理使用 React Query 的机制

## 测试
- 核心功能必须有单元测试
- 使用 Vitest + React Testing Library
- 每次修改后自动运行测试
```

---

## 五、项目 B 配置（Python + FastAPI）

### 5.1 project-b-api/AGENTS.md

```markdown
# 项目 B：后端 API

## 项目概述
基于 Python + FastAPI 的后端 API 服务。

## 技术栈
- Python 3.13
- FastAPI 0.115
- SQLAlchemy（ORM）
- PostgreSQL（数据库）
- Pydantic（数据验证）
- pytest（测试）

## 目录结构
```
app/
├── api/            # API 路由
│   ├── v1/         # API v1
│   └── deps.py     # 依赖注入
├── core/           # 核心配置
├── models/         # 数据模型
├── schemas/        # Pydantic schemas
├── services/       # 业务逻辑
└── tests/          # 测试
```

## 开发规范
- 代码风格：Black + isort + flake8
- 类型检查：mypy
- 提交规范：Conventional Commits
- 测试要求：覆盖率 > 80%

## 命名约定
- 文件：snake_case（user_service.py）
- 类：PascalCase（UserService）
- 函数：snake_case（get_user_by_id）
- 常量：UPPER_SNAKE_CASE（API_BASE_URL）

## 常用命令
- `uv run uvicorn app.main:app --reload` - 启动开发服务器
- `uv run pytest` - 运行测试
- `uv run black .` - 格式化代码
- `uv run mypy .` - 类型检查

## 注意事项
- ⚠️ 所有 API 端点必须有类型注解
- ⚠️ 所有数据库操作必须在事务中执行
- ⚠️ 所有错误必须记录到日志
```

### 5.2 project-b-api/.pi/settings.json

```json
{
  "defaultModel": "claude-sonnet-4",
  "compaction": {
    "enabled": true,
    "reserveTokens": 50000
  },
  "shellEnv": {
    "PYTHONPATH": "${PWD}"
  }
}
```

**说明：**
- 使用 Sonnet 模型（后端项目，成本优化）
- 标准 token 保留
- 设置 PYTHONPATH 环境变量

### 5.3 project-b-api/.pi/APPEND_SYSTEM.md

```markdown
# 项目 B 特定行为

## 代码风格
- 使用 Black 格式化
- 使用 isort 排序导入
- 所有函数必须有类型注解
- 使用 Pydantic 进行数据验证

## API 设计
- 遵循 RESTful 设计
- 使用 FastAPI 的依赖注入
- 所有端点必须有文档字符串

## 数据库
- 使用 SQLAlchemy ORM
- 所有操作必须在事务中执行
- 使用 Alembic 管理迁移

## 测试
- 使用 pytest
- 覆盖率必须 > 80%
- 每次修改后自动运行测试
```

---

## 六、项目 C 配置（Next.js）

### 6.1 project-c-blog/AGENTS.md

```markdown
# 项目 C：个人博客

## 项目概述
基于 Next.js 的个人博客，使用 MDX 编写文章。

## 技术栈
- Next.js 14（App Router）
- TypeScript
- Tailwind CSS
- MDX（博客文章）
- Vercel（部署）

## 目录结构
```
app/
├── blog/           # 博客页面
├── about/          # 关于页面
└── layout.tsx      # 根布局
content/            # MDX 文章
components/         # React 组件
public/             # 静态资源
```

## 开发规范
- 代码风格：Prettier + ESLint
- 简洁优先，避免过度工程
- 文章使用 MDX 格式

## 常用命令
- `pnpm dev` - 启动开发服务器
- `pnpm build` - 构建生产版本
- `pnpm lint` - 代码检查

## 注意事项
- ⚠️ 文章放在 content/ 目录
- ⚠️ 图片放在 public/images/ 目录
- ⚠️ 使用 Next.js Image 组件优化图片
```

### 6.2 project-c-blog/.pi/settings.json

```json
{
  "defaultModel": "claude-haiku-4",
  "compaction": {
    "enabled": true,
    "reserveTokens": 30000
  }
}
```

**说明：**
- 使用 Haiku 模型（个人项目，成本优化）
- 较低的 token 保留（简单项目）

---

## 七、项目切换流程

### 7.1 切换到项目 A

```bash
# 1. 切换目录
cd ~/projects/project-a-ecommerce

# 2. 启动 Pi Agent
pi

# Pi Agent 自动加载：
# - 全局 AGENTS.md（个人习惯）
# - 项目 A AGENTS.md（项目规范）
# - 全局 settings.json（个人偏好）
# - 项目 A settings.json（项目配置）
# - 全局 APPEND_SYSTEM.md（个人风格）
# - 项目 A APPEND_SYSTEM.md（项目行为）

# 3. Pi Agent 现在理解：
# - 这是一个 TypeScript + React 项目
# - 使用 Vite + pnpm
# - 使用 Zustand + Tailwind CSS
# - 使用 Opus 模型（高质量）
```

### 7.2 切换到项目 B

```bash
# 1. 切换目录
cd ~/projects/project-b-api

# 2. 启动 Pi Agent
pi

# Pi Agent 自动加载：
# - 全局配置（个人习惯）
# - 项目 B 配置（Python + FastAPI）

# 3. Pi Agent 现在理解：
# - 这是一个 Python + FastAPI 项目
# - 使用 SQLAlchemy + PostgreSQL
# - 使用 Sonnet 模型（成本优化）
```

### 7.3 切换到项目 C

```bash
# 1. 切换目录
cd ~/projects/project-c-blog

# 2. 启动 Pi Agent
pi

# Pi Agent 自动加载：
# - 全局配置（个人习惯）
# - 项目 C 配置（Next.js）

# 3. Pi Agent 现在理解：
# - 这是一个 Next.js 博客项目
# - 使用 MDX 编写文章
# - 使用 Haiku 模型（快速响应）
```

---

## 八、配置对比表

| 配置项 | 全局 | 项目 A | 项目 B | 项目 C |
|--------|------|--------|--------|--------|
| **模型** | Sonnet | Opus | Sonnet | Haiku |
| **技术栈** | - | TS+React | Python+FastAPI | Next.js |
| **包管理器** | - | pnpm | uv | pnpm |
| **代码风格** | 函数式 | React Hooks | Black+isort | 简洁优先 |
| **测试框架** | - | Vitest | pytest | - |
| **Token 保留** | 50k | 80k | 50k | 30k |

---

## 九、成本优化策略

### 9.1 模型选择策略

```json
// 全局默认：Sonnet（平衡）
{
  "defaultModel": "claude-sonnet-4"
}

// 重要项目：Opus（高质量）
// project-a/.pi/settings.json
{
  "defaultModel": "claude-opus-4"
}

// 个人项目：Haiku（快速+省钱）
// project-c/.pi/settings.json
{
  "defaultModel": "claude-haiku-4"
}
```

**成本对比：**
- Opus：最贵，但质量最高
- Sonnet：中等价格，平衡性能
- Haiku：最便宜，快速响应

**选择建议：**
- 商业项目、复杂项目 → Opus
- 日常开发、中等复杂度 → Sonnet
- 个人项目、简单任务 → Haiku

### 9.2 Token 优化策略

```json
// 复杂项目：更多 token
{
  "compaction": {
    "reserveTokens": 80000,
    "keepRecentTokens": 20000
  }
}

// 简单项目：较少 token
{
  "compaction": {
    "reserveTokens": 30000,
    "keepRecentTokens": 10000
  }
}
```

---

## 十、快速切换脚本

### 10.1 创建切换脚本

```bash
# ~/bin/switch-project.sh
#!/bin/bash

case "$1" in
  a|ecommerce)
    cd ~/projects/project-a-ecommerce
    echo "切换到项目 A：电商平台"
    ;;
  b|api)
    cd ~/projects/project-b-api
    echo "切换到项目 B：后端 API"
    ;;
  c|blog)
    cd ~/projects/project-c-blog
    echo "切换到项目 C：个人博客"
    ;;
  *)
    echo "用法: switch-project [a|b|c]"
    exit 1
    ;;
esac

# 启动 Pi Agent
pi
```

### 10.2 使用脚本

```bash
# 添加到 PATH
chmod +x ~/bin/switch-project.sh
export PATH="$HOME/bin:$PATH"

# 快速切换
switch-project a  # 切换到项目 A
switch-project b  # 切换到项目 B
switch-project c  # 切换到项目 C
```

### 10.3 Shell 别名

```bash
# ~/.zshrc
alias pa='cd ~/projects/project-a-ecommerce && pi'
alias pb='cd ~/projects/project-b-api && pi'
alias pc='cd ~/projects/project-c-blog && pi'

# 使用
pa  # 切换到项目 A 并启动 Pi
pb  # 切换到项目 B 并启动 Pi
pc  # 切换到项目 C 并启动 Pi
```

---

## 十一、配置管理技巧

### 11.1 配置模板管理

```bash
# 创建配置模板目录
mkdir -p ~/.pi/templates

# 保存常用配置模板
cat > ~/.pi/templates/typescript-react.json << 'EOF'
{
  "defaultModel": "claude-opus-4",
  "compaction": {
    "reserveTokens": 80000
  }
}
EOF

cat > ~/.pi/templates/python-fastapi.json << 'EOF'
{
  "defaultModel": "claude-sonnet-4",
  "shellEnv": {
    "PYTHONPATH": "${PWD}"
  }
}
EOF

# 新项目使用模板
cp ~/.pi/templates/typescript-react.json new-project/.pi/settings.json
```

### 11.2 配置同步

```bash
# 使用 Git 管理配置模板
cd ~/.pi
git init
git add templates/
git commit -m "Add config templates"

# 在新机器上同步
git clone <repo-url> ~/.pi
```

### 11.3 配置验证

```bash
# 验证 JSON 语法
cat .pi/settings.json | jq .

# 查看最终生效的配置
pi
# 查看启动日志中的 "Loaded settings"
```

---

## 十二、常见问题

### Q1: 如何知道当前使用的是哪个项目的配置？

**A:** Pi Agent 启动时会显示加载的配置文件：

```bash
$ pi

Loaded context files:
- ~/.pi/agent/AGENTS.md
- /projects/project-a-ecommerce/AGENTS.md

Loaded settings:
- ~/.pi/agent/settings.json
- /projects/project-a-ecommerce/.pi/settings.json

Ready to assist!
```

### Q2: 如何在不重启 Pi 的情况下切换项目？

**A:** 不推荐。最好的方式是：
1. 退出当前 Pi（Ctrl+D）
2. 切换到新项目目录
3. 启动新的 Pi

### Q3: 全局配置和项目配置冲突怎么办？

**A:** 项目配置优先：
- 对象：深度合并（项目覆盖全局）
- 数组：完全替换（项目替换全局）

### Q4: 如何为新项目快速创建配置？

**A:** 使用配置模板：

```bash
# 1. 创建项目目录
mkdir new-project
cd new-project

# 2. 复制配置模板
mkdir -p .pi
cp ~/.pi/templates/typescript-react.json .pi/settings.json

# 3. 创建 AGENTS.md
cat > AGENTS.md << 'EOF'
# 新项目规范
- TypeScript + React
- 使用 pnpm
EOF

# 4. 启动 Pi
pi
```

---

## 十三、实际效果

### 13.1 切换效率提升

**使用前：**
- 切换项目后需要重新告诉 AI 项目信息
- 每次都要说明技术栈、规范、命令
- 浪费时间和 token

**使用后：**
- 切换目录 + 启动 Pi = 自动加载配置
- Pi Agent 立即理解当前项目
- 无需重复说明

**时间节省：90%**

### 13.2 成本优化

**使用前：**
- 所有项目都使用 Opus 模型
- 月成本：$300

**使用后：**
- 重要项目用 Opus
- 日常开发用 Sonnet
- 个人项目用 Haiku
- 月成本：$150

**成本节省：50%**

### 13.3 开发体验

**使用前：**
- 切换项目时需要"热身"
- 需要重新建立上下文
- 容易混淆不同项目的规范

**使用后：**
- 切换项目立即进入状态
- Pi Agent 自动适应当前项目
- 不同项目规范清晰分离

**体验提升：显著**

---

## 十四、总结

**多项目切换配置的核心要点：**

1. **全局配置** - 个人习惯和偏好（所有项目通用）
2. **项目配置** - 项目特定规范和设置（当前项目生效）
3. **模型选择** - 根据项目重要性选择模型（成本优化）
4. **快速切换** - 使用脚本或别名快速切换项目
5. **配置模板** - 为新项目提供配置模板

**效果：**
- 切换效率提升 90%
- 成本节省 50%
- 开发体验显著提升

**记住：** Context Files 让 Pi Agent 能够自动适应不同项目，实现真正的"即插即用"！
