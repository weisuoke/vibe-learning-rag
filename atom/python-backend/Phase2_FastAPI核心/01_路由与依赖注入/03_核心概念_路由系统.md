# 核心概念：路由系统

> FastAPI 的路由系统：用装饰器声明 API 端点，自动解析参数

---

## 什么是路由系统？

**路由系统 = 将 HTTP 请求映射到处理函数的机制**

```
HTTP 请求 → 路由匹配 → 处理函数 → HTTP 响应
```

**核心组成：**
1. **路由装饰器** - 声明 API 端点（@app.get、@app.post 等）
2. **路径模式** - 定义 URL 结构（/users/{user_id}）
3. **参数解析** - 自动提取路径参数、查询参数、请求体

---

## 1. 路由装饰器

### 1.1 基础装饰器

**支持的 HTTP 方法：**

```python
from fastapi import FastAPI

app = FastAPI()

# GET - 获取资源
@app.get("/items")
async def list_items():
    return {"items": []}

# POST - 创建资源
@app.post("/items")
async def create_item():
    return {"message": "Created"}

# PUT - 完整更新资源
@app.put("/items/{item_id}")
async def update_item(item_id: int):
    return {"message": f"Updated {item_id}"}

# PATCH - 部分更新资源
@app.patch("/items/{item_id}")
async def partial_update_item(item_id: int):
    return {"message": f"Patched {item_id}"}

# DELETE - 删除资源
@app.delete("/items/{item_id}")
async def delete_item(item_id: int):
    return {"message": f"Deleted {item_id}"}

# HEAD - 获取响应头（不返回响应体）
@app.head("/items")
async def items_head():
    return {}

# OPTIONS - 获取支持的方法
@app.options("/items")
async def items_options():
    return {}
```

**RESTful 设计原则：**

| HTTP 方法 | 用途 | 幂等性 | 安全性 |
|-----------|------|--------|--------|
| GET | 获取资源 | ✅ 是 | ✅ 是 |
| POST | 创建资源 | ❌ 否 | ❌ 否 |
| PUT | 完整更新 | ✅ 是 | ❌ 否 |
| PATCH | 部分更新 | ❌ 否 | ❌ 否 |
| DELETE | 删除资源 | ✅ 是 | ❌ 否 |

**幂等性：** 多次执行结果相同
**安全性：** 不修改服务器状态

---

### 1.2 装饰器参数

**常用参数：**

```python
from fastapi import FastAPI, status
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

@app.post(
    "/items",                          # 路径
    response_model=Item,               # 响应模型
    status_code=status.HTTP_201_CREATED,  # 状态码
    tags=["items"],                    # 标签（用于文档分组）
    summary="Create an item",          # 摘要
    description="Create a new item with name and price",  # 描述
    response_description="The created item",  # 响应描述
    deprecated=False,                  # 是否废弃
    name="create_item",                # 操作名称
    responses={                        # 额外响应
        404: {"description": "Item not found"},
        400: {"description": "Invalid input"}
    }
)
async def create_item(item: Item):
    return item
```

**自动生成的 API 文档：**
- 访问 `http://localhost:8000/docs` 查看 Swagger UI
- 访问 `http://localhost:8000/redoc` 查看 ReDoc

---

### 1.3 路由前缀和标签

**使用 APIRouter 组织路由：**

```python
from fastapi import APIRouter, FastAPI

# 创建路由器
users_router = APIRouter(
    prefix="/users",           # 路由前缀
    tags=["users"],            # 标签
    responses={404: {"description": "Not found"}}
)

# 在路由器上定义路由
@users_router.get("/")
async def list_users():
    return {"users": []}

@users_router.get("/{user_id}")
async def get_user(user_id: int):
    return {"user_id": user_id}

@users_router.post("/")
async def create_user():
    return {"message": "Created"}

# 创建主应用
app = FastAPI()

# 包含路由器
app.include_router(users_router)

# 最终路由：
# GET  /users/
# GET  /users/{user_id}
# POST /users/
```

**多个路由器：**

```python
from fastapi import FastAPI, APIRouter

# 用户路由
users_router = APIRouter(prefix="/users", tags=["users"])

@users_router.get("/")
async def list_users():
    return {"users": []}

# 商品路由
items_router = APIRouter(prefix="/items", tags=["items"])

@items_router.get("/")
async def list_items():
    return {"items": []}

# 主应用
app = FastAPI()
app.include_router(users_router)
app.include_router(items_router)

# 最终路由：
# GET /users/
# GET /items/
```

---

## 2. 路径参数

### 2.1 基础路径参数

**定义路径参数：**

```python
from fastapi import FastAPI

app = FastAPI()

# 单个路径参数
@app.get("/users/{user_id}")
async def get_user(user_id: int):
    return {"user_id": user_id}

# 多个路径参数
@app.get("/users/{user_id}/posts/{post_id}")
async def get_user_post(user_id: int, post_id: int):
    return {"user_id": user_id, "post_id": post_id}

# 字符串路径参数
@app.get("/files/{file_path:path}")
async def get_file(file_path: str):
    # file_path 可以包含斜杠
    # /files/docs/readme.md → file_path = "docs/readme.md"
    return {"file_path": file_path}
```

**类型转换和验证：**

```python
# 自动类型转换
@app.get("/items/{item_id}")
async def get_item(item_id: int):
    # GET /items/123 → item_id = 123 (int)
    # GET /items/abc → 422 Validation Error
    return {"item_id": item_id, "type": type(item_id).__name__}
```

---

### 2.2 路径参数验证

**使用 Path() 添加验证：**

```python
from fastapi import FastAPI, Path

app = FastAPI()

@app.get("/users/{user_id}")
async def get_user(
    user_id: int = Path(
        ...,                    # 必需（... 表示必需）
        title="User ID",        # 标题
        description="The ID of the user to get",  # 描述
        ge=1,                   # 大于等于 1
        le=1000,                # 小于等于 1000
        example=123             # 示例值
    )
):
    return {"user_id": user_id}

# GET /users/0   → 422 Error (user_id < 1)
# GET /users/123 → OK
# GET /users/1001 → 422 Error (user_id > 1000)
```

**字符串验证：**

```python
from fastapi import Path

@app.get("/users/{username}")
async def get_user_by_name(
    username: str = Path(
        ...,
        min_length=3,           # 最小长度
        max_length=50,          # 最大长度
        regex="^[a-zA-Z0-9_]+$"  # 正则表达式
    )
):
    return {"username": username}

# GET /users/ab       → 422 Error (too short)
# GET /users/alice    → OK
# GET /users/alice@   → 422 Error (invalid chars)
```

---

### 2.3 枚举路径参数

**使用 Enum 限制可选值：**

```python
from enum import Enum
from fastapi import FastAPI

class UserRole(str, Enum):
    admin = "admin"
    user = "user"
    guest = "guest"

app = FastAPI()

@app.get("/users/role/{role}")
async def get_users_by_role(role: UserRole):
    return {"role": role.value}

# GET /users/role/admin → OK
# GET /users/role/user  → OK
# GET /users/role/invalid → 422 Error
```

---

## 3. 查询参数

### 3.1 基础查询参数

**定义查询参数：**

```python
from fastapi import FastAPI

app = FastAPI()

# 可选查询参数
@app.get("/items")
async def list_items(
    skip: int = 0,      # 默认值 0
    limit: int = 10     # 默认值 10
):
    return {"skip": skip, "limit": limit}

# GET /items              → skip=0, limit=10
# GET /items?skip=20      → skip=20, limit=10
# GET /items?limit=50     → skip=0, limit=50
# GET /items?skip=20&limit=50 → skip=20, limit=50
```

**必需查询参数：**

```python
# 没有默认值 = 必需
@app.get("/search")
async def search(q: str):
    return {"query": q}

# GET /search        → 422 Error (missing q)
# GET /search?q=test → OK
```

**可选查询参数（None）：**

```python
from typing import Optional

@app.get("/items")
async def list_items(q: Optional[str] = None):
    if q:
        return {"query": q}
    return {"message": "No query"}

# GET /items       → {"message": "No query"}
# GET /items?q=test → {"query": "test"}
```

---

### 3.2 查询参数验证

**使用 Query() 添加验证：**

```python
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items")
async def list_items(
    q: str = Query(
        None,                   # 默认值（可选）
        title="Query string",   # 标题
        description="Search query",  # 描述
        min_length=3,           # 最小长度
        max_length=50,          # 最大长度
        regex="^[a-zA-Z0-9 ]+$",  # 正则表达式
        example="laptop"        # 示例值
    ),
    limit: int = Query(
        10,                     # 默认值
        ge=1,                   # 大于等于 1
        le=100,                 # 小于等于 100
        description="Number of items to return"
    )
):
    return {"query": q, "limit": limit}
```

**必需查询参数（使用 ...）：**

```python
from fastapi import Query

@app.get("/search")
async def search(
    q: str = Query(..., min_length=3)  # ... 表示必需
):
    return {"query": q}

# GET /search        → 422 Error (missing q)
# GET /search?q=ab   → 422 Error (too short)
# GET /search?q=test → OK
```

---

### 3.3 多值查询参数

**列表查询参数：**

```python
from typing import List
from fastapi import Query

@app.get("/items")
async def list_items(
    tags: List[str] = Query(None)
):
    return {"tags": tags}

# GET /items                    → tags=None
# GET /items?tags=python        → tags=["python"]
# GET /items?tags=python&tags=fastapi → tags=["python", "fastapi"]
```

**默认值列表：**

```python
@app.get("/items")
async def list_items(
    tags: List[str] = Query(["python", "fastapi"])
):
    return {"tags": tags}

# GET /items → tags=["python", "fastapi"]
```

---

## 4. 请求体

### 4.1 Pydantic 模型

**定义请求体模型：**

```python
from fastapi import FastAPI
from pydantic import BaseModel, Field

app = FastAPI()

class Item(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    description: str | None = Field(None, max_length=500)
    price: float = Field(..., gt=0)
    tax: float | None = Field(None, ge=0)

@app.post("/items")
async def create_item(item: Item):
    return item

# POST /items
# Body: {"name": "Laptop", "price": 999.99}
# → OK

# POST /items
# Body: {"name": "", "price": -10}
# → 422 Error (validation failed)
```

**嵌套模型：**

```python
from typing import List

class Tag(BaseModel):
    name: str
    color: str

class Item(BaseModel):
    name: str
    tags: List[Tag]

@app.post("/items")
async def create_item(item: Item):
    return item

# POST /items
# Body: {
#   "name": "Laptop",
#   "tags": [
#     {"name": "electronics", "color": "blue"},
#     {"name": "computers", "color": "green"}
#   ]
# }
```

---

### 4.2 多个请求体参数

**多个 Pydantic 模型：**

```python
class Item(BaseModel):
    name: str
    price: float

class User(BaseModel):
    username: str
    email: str

@app.post("/purchase")
async def purchase(item: Item, user: User):
    return {"item": item, "user": user}

# POST /purchase
# Body: {
#   "item": {"name": "Laptop", "price": 999.99},
#   "user": {"username": "alice", "email": "alice@example.com"}
# }
```

**混合请求体和查询参数：**

```python
@app.post("/items")
async def create_item(
    item: Item,              # 请求体
    q: str | None = None     # 查询参数
):
    return {"item": item, "query": q}

# POST /items?q=test
# Body: {"name": "Laptop", "price": 999.99}
```

---

### 4.3 单值请求体

**使用 Body() 定义单值：**

```python
from fastapi import Body

@app.post("/items")
async def create_item(
    name: str = Body(...),
    price: float = Body(...)
):
    return {"name": name, "price": price}

# POST /items
# Body: {"name": "Laptop", "price": 999.99}
```

**嵌入单个模型：**

```python
from fastapi import Body

class Item(BaseModel):
    name: str
    price: float

@app.post("/items")
async def create_item(
    item: Item = Body(..., embed=True)
):
    return item

# 不使用 embed=True:
# Body: {"name": "Laptop", "price": 999.99}

# 使用 embed=True:
# Body: {"item": {"name": "Laptop", "price": 999.99}}
```

---

## 5. 参数优先级

**FastAPI 如何区分参数类型？**

```python
from fastapi import FastAPI, Path, Query, Body
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

@app.put("/items/{item_id}")
async def update_item(
    item_id: int = Path(...),        # 路径参数（在 URL 路径中）
    q: str | None = Query(None),     # 查询参数（在 URL ?后面）
    item: Item = Body(...)           # 请求体（在 HTTP Body 中）
):
    return {"item_id": item_id, "query": q, "item": item}

# PUT /items/123?q=test
# Body: {"name": "Laptop", "price": 999.99}
```

**优先级规则：**

1. **路径参数** - 在路径模式中定义（`{item_id}`）
2. **查询参数** - 单一类型（int、str、float 等）且不在路径中
3. **请求体** - Pydantic 模型或使用 Body()

---

## 6. 表单数据和文件上传

### 6.1 表单数据

**接收表单数据：**

```python
from fastapi import FastAPI, Form

app = FastAPI()

@app.post("/login")
async def login(
    username: str = Form(...),
    password: str = Form(...)
):
    return {"username": username}

# POST /login
# Content-Type: application/x-www-form-urlencoded
# Body: username=alice&password=secret123
```

---

### 6.2 文件上传

**单文件上传：**

```python
from fastapi import FastAPI, File, UploadFile

app = FastAPI()

@app.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    contents = await file.read()
    return {
        "filename": file.filename,
        "content_type": file.content_type,
        "size": len(contents)
    }
```

**多文件上传：**

```python
from typing import List

@app.post("/upload-multiple")
async def upload_multiple_files(files: List[UploadFile] = File(...)):
    return [
        {"filename": file.filename, "size": len(await file.read())}
        for file in files
    ]
```

---

## 7. 路由顺序和优先级

**路由匹配顺序：**

```python
from fastapi import FastAPI

app = FastAPI()

# 顺序很重要！

# 1. 具体路径优先
@app.get("/users/me")
async def get_current_user():
    return {"user": "current"}

# 2. 路径参数在后
@app.get("/users/{user_id}")
async def get_user(user_id: int):
    return {"user_id": user_id}

# GET /users/me  → 匹配第1个路由
# GET /users/123 → 匹配第2个路由
```

**错误示例（顺序错误）：**

```python
# ❌ 错误：路径参数在前
@app.get("/users/{user_id}")
async def get_user(user_id: int):
    return {"user_id": user_id}

@app.get("/users/me")
async def get_current_user():
    return {"user": "current"}

# GET /users/me → 匹配第1个路由，user_id="me"，类型转换失败 → 422 Error
```

---

## 8. 在 AI Agent 后端中的应用

### 8.1 对话接口

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class ChatRequest(BaseModel):
    message: str
    conversation_id: str | None = None

class ChatResponse(BaseModel):
    reply: str
    conversation_id: str

@app.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    # 处理对话
    reply = process_message(request.message, request.conversation_id)
    return ChatResponse(reply=reply, conversation_id=request.conversation_id or "new")
```

---

### 8.2 文档管理接口

```python
from typing import List

class Document(BaseModel):
    title: str
    content: str
    tags: List[str] = []

# 上传文档
@app.post("/documents", status_code=201)
async def upload_document(doc: Document):
    doc_id = save_document(doc)
    return {"id": doc_id}

# 获取文档列表
@app.get("/documents")
async def list_documents(
    tag: str | None = None,
    limit: int = Query(10, ge=1, le=100)
):
    docs = get_documents(tag=tag, limit=limit)
    return {"documents": docs}

# 获取单个文档
@app.get("/documents/{doc_id}")
async def get_document(doc_id: int = Path(..., ge=1)):
    doc = get_document_by_id(doc_id)
    if not doc:
        raise HTTPException(status_code=404, detail="Document not found")
    return doc

# 删除文档
@app.delete("/documents/{doc_id}", status_code=204)
async def delete_document(doc_id: int):
    delete_document_by_id(doc_id)
    return None
```

---

## 总结

### 路由系统的核心要点

1. **路由装饰器** - 声明式定义 API 端点
2. **路径参数** - 标识资源（必需）
3. **查询参数** - 过滤资源（可选）
4. **请求体** - 复杂数据（Pydantic 模型）
5. **自动验证** - 类型检查和数据验证
6. **自动文档** - Swagger UI 和 ReDoc

### 与 Express 的对比

| 特性 | Express | FastAPI |
|------|---------|---------|
| 路由定义 | `app.get('/path', handler)` | `@app.get("/path")` |
| 参数解析 | 手动 `req.params`、`req.query` | 自动解析到函数参数 |
| 数据验证 | express-validator | Pydantic 自动验证 |
| 类型安全 | TypeScript（编译时） | Python 类型注解（运行时） |
| API 文档 | 手动编写 | 自动生成 |

---

**记住：** 路由系统是 FastAPI 的基础，理解路由系统才能构建清晰的 API！
