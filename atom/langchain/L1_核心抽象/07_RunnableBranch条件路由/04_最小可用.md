# 最小可用知识

掌握以下内容，就能开始使用 RunnableBranch：

---

## 4.1 基础结构：条件 + 分支 + 默认

**核心概念**：RunnableBranch 由三部分组成

```python
from langchain_core.runnables import RunnableBranch, RunnableLambda

branch = RunnableBranch(
    # 条件1 + 分支1
    (lambda x: condition1(x), branch1),
    # 条件2 + 分支2
    (lambda x: condition2(x), branch2),
    # 默认分支（必须）
    default_branch
)
```

**在 AI Agent 中**：根据用户输入类型选择不同的处理器

---

## 4.2 条件函数：返回布尔值

**核心概念**：条件可以是 lambda 函数或 Runnable

```python
# 方式1：lambda 函数
condition = lambda x: "urgent" in x.lower()

# 方式2：Runnable（更复杂的判断）
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

classifier = ChatPromptTemplate.from_template(
    "Is this urgent? Answer yes/no: {text}"
) | ChatOpenAI() | (lambda x: "yes" in x.content.lower())
```

**在 AI Agent 中**：可以用 LLM 做智能分类

---

## 4.3 顺序评估：第一个匹配就执行

**核心概念**：条件从上到下评估，第一个返回 True 的分支执行

```python
branch = RunnableBranch(
    (lambda x: x > 100, handle_large),    # 先检查
    (lambda x: x > 50, handle_medium),    # 再检查
    (lambda x: x > 0, handle_small),      # 最后检查
    handle_invalid                         # 都不匹配用这个
)

# 输入 150 → 只执行 handle_large
# 输入 75 → 只执行 handle_medium
# 输入 -5 → 执行 handle_invalid
```

**注意**：条件顺序很重要！从最具体到最通用。

---

## 4.4 与 LCEL 组合：无缝集成

**核心概念**：RunnableBranch 是 Runnable，可以用管道操作符

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

# 前置处理
prompt = ChatPromptTemplate.from_template("Classify: {text}")
classifier = prompt | ChatOpenAI()

# 条件路由
branch = RunnableBranch(
    (lambda x: "positive" in x.content, positive_chain),
    (lambda x: "negative" in x.content, negative_chain),
    neutral_chain
)

# 组合成完整链
chain = classifier | branch

# 执行
result = chain.invoke({"text": "I love this product!"})
```

**在 AI Agent 中**：分类 → 路由 → 处理，一气呵成

---

## 4.5 默认分支：必须提供

**核心概念**：最后一个参数是默认分支，所有条件都不匹配时执行

```python
# ✅ 正确：提供默认分支
branch = RunnableBranch(
    (condition1, branch1),
    (condition2, branch2),
    default_branch  # 必须
)

# ❌ 错误：没有默认分支会报错
branch = RunnableBranch(
    (condition1, branch1),
    (condition2, branch2)
)  # TypeError!
```

**最佳实践**：默认分支可以是错误处理或通用处理器

```python
default_handler = RunnableLambda(
    lambda x: {"error": "No matching condition", "input": x}
)
```

---

## 这些知识足以

掌握以上5个要点，你就能：

- ✅ 创建基础的条件路由
- ✅ 设计简单的分支逻辑
- ✅ 与 LCEL 链式组合
- ✅ 处理常见的路由场景
- ✅ 为后续学习复杂路由打基础

---

## 快速参考

| 概念 | 说明 | 示例 |
|------|------|------|
| **条件函数** | 返回布尔值的函数 | `lambda x: "urgent" in x` |
| **分支** | 条件为 True 时执行的 Runnable | `ChatOpenAI()` |
| **默认分支** | 所有条件都不匹配时执行 | 最后一个参数 |
| **顺序评估** | 从上到下，第一个匹配就停止 | 条件顺序很重要 |
| **LCEL 组合** | 用 `\|` 连接 | `classifier \| branch` |

---

## 常见模式

### 模式1：类型检查路由
```python
branch = RunnableBranch(
    (lambda x: isinstance(x, dict), dict_handler),
    (lambda x: isinstance(x, str), str_handler),
    default_handler
)
```

### 模式2：关键词路由
```python
branch = RunnableBranch(
    (lambda x: "code" in x.lower(), code_handler),
    (lambda x: "math" in x.lower(), math_handler),
    general_handler
)
```

### 模式3：阈值路由
```python
branch = RunnableBranch(
    (lambda x: x["score"] > 0.8, high_confidence),
    (lambda x: x["score"] > 0.5, medium_confidence),
    low_confidence
)
```

---

**记住**：RunnableBranch 的核心是"顺序评估 + 第一匹配 + 默认分支"，掌握这三点就能应对大部分场景！
