# æ ¸å¿ƒæ¦‚å¿µ 03ï¼šæ‰‹åŠ¨å‹ç¼©ä¸è‡ªå®šä¹‰æŒ‡ä»¤

> **æ ¸å¿ƒæ¦‚å¿µ**ï¼šå¦‚ä½•æ‰‹åŠ¨è§¦å‘å‹ç¼©å¹¶é€šè¿‡ Extension å®ç°è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥

---

## æ¦‚è¿°

**æ‰‹åŠ¨å‹ç¼©ä¸è‡ªå®šä¹‰æŒ‡ä»¤**æ˜¯ Compaction çš„ç¬¬ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒè§£å†³äº†"å¦‚ä½•å®šåˆ¶å‹ç¼©"çš„é—®é¢˜ã€‚

**æ ¸å¿ƒé—®é¢˜ï¼š**
- å¦‚ä½•æ‰‹åŠ¨è§¦å‘å‹ç¼©ï¼Ÿ
- å¦‚ä½•è‡ªå®šä¹‰å‹ç¼©æç¤ºè¯ï¼Ÿ
- å¦‚ä½•ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹ï¼Ÿ
- å¦‚ä½•å®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘ï¼Ÿ

---

## 1. æ‰‹åŠ¨å‹ç¼©å‘½ä»¤

### 1.1 /compact å‘½ä»¤

**åŸºæœ¬ç”¨æ³•ï¼š**
```bash
# ä½¿ç”¨é»˜è®¤æç¤ºè¯å‹ç¼©
/compact

# ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤å‹ç¼©
/compact æ€»ç»“åˆšæ‰å®Œæˆçš„ç”¨æˆ·è®¤è¯åŠŸèƒ½å¼€å‘

# ä½¿ç”¨è¯¦ç»†æŒ‡ä»¤
/compact æ€»ç»“å¯¹è¯ï¼Œé‡ç‚¹å…³æ³¨ï¼š1) æŠ€æœ¯å†³ç­– 2) å·²å®Œæˆçš„åŠŸèƒ½ 3) å¾…è§£å†³çš„é—®é¢˜
```

**ä½•æ—¶ä½¿ç”¨æ‰‹åŠ¨å‹ç¼©ï¼Ÿ**

| åœºæ™¯ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä»»åŠ¡å®Œæˆ** | å®Œæˆä¸€ä¸ªå¤§ä»»åŠ¡å | `/compact æ€»ç»“ç”¨æˆ·è®¤è¯åŠŸèƒ½å¼€å‘` |
| **è¯é¢˜åˆ‡æ¢** | ä»ä¸€ä¸ªè¯é¢˜åˆ‡æ¢åˆ°å¦ä¸€ä¸ª | `/compact æ€»ç»“æ¶æ„è®¨è®ºï¼Œå‡†å¤‡å¼€å§‹ç¼–ç ` |
| **å¯¹è¯æ··ä¹±** | å¯¹è¯è·‘åï¼Œéœ€è¦é‡æ–°èšç„¦ | `/compact æ€»ç»“æ ¸å¿ƒè¿›å±•ï¼Œå¿½ç•¥æ— å…³è®¨è®º` |
| **æµ‹è¯•å‹ç¼©** | å¼€å‘è‡ªå®šä¹‰å‹ç¼©æ‰©å±•æ—¶ | `/compact æµ‹è¯•è‡ªå®šä¹‰æç¤ºè¯æ•ˆæœ` |

### 1.2 æ‰‹åŠ¨å‹ç¼© vs è‡ªåŠ¨å‹ç¼©

**å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | è‡ªåŠ¨å‹ç¼© | æ‰‹åŠ¨å‹ç¼© |
|------|---------|---------|
| **è§¦å‘æ—¶æœº** | æ¥è¿‘ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ | ç”¨æˆ·ä¸»åŠ¨è§¦å‘ |
| **å‹ç¼©æŒ‡ä»¤** | é»˜è®¤æç¤ºè¯ | å¯è‡ªå®šä¹‰æŒ‡ä»¤ |
| **ä½¿ç”¨åœºæ™¯** | é•¿å¯¹è¯è‡ªåŠ¨ç®¡ç† | ä»»åŠ¡è¾¹ç•Œã€è¯é¢˜åˆ‡æ¢ |
| **ä¼˜åŠ¿** | æ— æ„ŸçŸ¥ã€è‡ªåŠ¨åŒ– | å¯æ§ã€å¯å®šåˆ¶ |
| **åŠ£åŠ¿** | ä¸å¯æ§æ—¶æœº | éœ€è¦ç”¨æˆ·åˆ¤æ–­ |

**æœ€ä½³å®è·µï¼šç»“åˆä½¿ç”¨**
```bash
# æ—¥å¸¸ä½¿ç”¨ï¼šä¾èµ–è‡ªåŠ¨å‹ç¼©
# å¯¹è¯è‡ªç„¶è¿›è¡Œï¼Œæ— éœ€å…³å¿ƒå‹ç¼©

# å…³é”®æ—¶åˆ»ï¼šä½¿ç”¨æ‰‹åŠ¨å‹ç¼©
# å®Œæˆé‡è¦åŠŸèƒ½å
/compact æ€»ç»“åˆšæ‰å®Œæˆçš„æ”¯ä»˜åŠŸèƒ½é›†æˆ

# åˆ‡æ¢è¯é¢˜å‰
/compact æ€»ç»“å‰ç«¯å¼€å‘è®¨è®ºï¼Œå‡†å¤‡è®¨è®ºåç«¯ API
```

---

## 2. Extension é’©å­

### 2.1 session_before_compact äº‹ä»¶

**æ ¸å¿ƒé’©å­ï¼šåœ¨å‹ç¼©å‰æ‹¦æˆª**

```typescript
import { Extension } from '@mariozechner/pi-agent-core';

export const customCompactionExtension: Extension = {
  name: 'custom-compaction',

  async onLoad(context) {
    // ç›‘å¬å‹ç¼©å‰äº‹ä»¶
    context.session.on('session_before_compact', async (event) => {
      console.log('å³å°†è§¦å‘å‹ç¼©');

      // å¯ä»¥ä¿®æ”¹å‹ç¼©è¡Œä¸º
      // 1. è‡ªå®šä¹‰æç¤ºè¯
      // 2. ä½¿ç”¨ä¸åŒæ¨¡å‹
      // 3. å–æ¶ˆå‹ç¼©
      // 4. å®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘
    });
  },
};
```

**Event å¯¹è±¡ç»“æ„ï¼š**
```typescript
interface CompactionEvent {
  // ä¸Šä¸‹æ–‡ä¿¡æ¯
  contextTokens: number;      // å½“å‰ token æ•°
  contextWindow: number;       // ä¸Šä¸‹æ–‡çª—å£å¤§å°
  reserveTokens: number;       // é¢„ç•™ç©ºé—´
  keepRecentTokens: number;    // ä¿ç•™æœ€è¿‘æ¶ˆæ¯

  // æ¶ˆæ¯ä¿¡æ¯
  messages: Message[];         // æ‰€æœ‰æ¶ˆæ¯
  cutPoint: number;            // åˆ‡ç‚¹ç´¢å¼•

  // è‡ªå®šä¹‰é€‰é¡¹
  customPrompt?: string;       // è‡ªå®šä¹‰æç¤ºè¯
  customModel?: string;        // è‡ªå®šä¹‰æ¨¡å‹
  cancel?: boolean;            // å–æ¶ˆå‹ç¼©
  replacement?: Message[];     // æ›¿æ¢å‹ç¼©ç»“æœ
}
```

### 2.2 è‡ªå®šä¹‰å‹ç¼©æç¤ºè¯

**ç¤ºä¾‹ï¼šä»»åŠ¡å¯¼å‘çš„å‹ç¼©**
```typescript
context.session.on('session_before_compact', async (event) => {
  // è‡ªå®šä¹‰æç¤ºè¯ï¼Œå¼ºè°ƒä»»åŠ¡å®Œæˆæƒ…å†µ
  event.customPrompt = `
è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯ï¼Œé‡ç‚¹å…³æ³¨ï¼š

1. **å·²å®Œæˆçš„ä»»åŠ¡**ï¼šåˆ—å‡ºæ‰€æœ‰å®Œæˆçš„åŠŸèƒ½å’Œç‰¹æ€§
2. **æŠ€æœ¯å†³ç­–**ï¼šè®°å½•é‡è¦çš„æŠ€æœ¯é€‰æ‹©å’ŒåŸå› 
3. **å¾…è§£å†³é—®é¢˜**ï¼šåˆ—å‡ºå°šæœªè§£å†³çš„é—®é¢˜å’Œé˜»å¡ç‚¹
4. **æ–‡ä»¶æ“ä½œ**ï¼šè®°å½•æ‰€æœ‰è¯»å–å’Œä¿®æ”¹çš„æ–‡ä»¶

æ ¼å¼ï¼š
## Summary
[é«˜å±‚æ¬¡æ¦‚è¿°]

## Completed Tasks
- [ä»»åŠ¡ 1]
- [ä»»åŠ¡ 2]

## Technical Decisions
- [å†³ç­– 1]: [åŸå› ]
- [å†³ç­– 2]: [åŸå› ]

## Pending Issues
- [é—®é¢˜ 1]
- [é—®é¢˜ 2]

## Files
- Read: [æ–‡ä»¶åˆ—è¡¨]
- Modified: [æ–‡ä»¶åˆ—è¡¨]
  `;
});
```

**ç¤ºä¾‹ï¼šä»£ç å®¡æŸ¥å¯¼å‘çš„å‹ç¼©**
```typescript
context.session.on('session_before_compact', async (event) => {
  event.customPrompt = `
è¯·æ€»ç»“ä»¥ä¸‹ä»£ç å®¡æŸ¥å¯¹è¯ï¼š

1. **å®¡æŸ¥çš„æ–‡ä»¶**ï¼šåˆ—å‡ºæ‰€æœ‰å®¡æŸ¥çš„æ–‡ä»¶
2. **å‘ç°çš„é—®é¢˜**ï¼šåˆ—å‡ºæ‰€æœ‰å‘ç°çš„é—®é¢˜ï¼ˆæŒ‰ä¸¥é‡ç¨‹åº¦ï¼‰
3. **ä¿®å¤å»ºè®®**ï¼šåˆ—å‡ºæ‰€æœ‰ä¿®å¤å»ºè®®
4. **å·²ä¿®å¤é—®é¢˜**ï¼šåˆ—å‡ºå·²ç»ä¿®å¤çš„é—®é¢˜

æ ¼å¼ï¼š
## Files Reviewed
- [æ–‡ä»¶åˆ—è¡¨]

## Issues Found
### Critical
- [é—®é¢˜ 1]

### Major
- [é—®é¢˜ 2]

### Minor
- [é—®é¢˜ 3]

## Fixes Applied
- [ä¿®å¤ 1]
- [ä¿®å¤ 2]
  `;
});
```

---

## 3. è‡ªå®šä¹‰å‹ç¼©æ¨¡å‹

### 3.1 æˆæœ¬ä¼˜åŒ–ï¼šä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹

> **2025-2026 Best Practice**: ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹ï¼ˆå¦‚ Gemini Flashï¼‰è¿›è¡Œå‹ç¼©ï¼Œé™ä½æˆæœ¬ã€‚
> ([Reddit: LLM Summarization Costs](https://www.reddit.com/r/LocalLLaMA/comments/...))

**æˆæœ¬å¯¹æ¯”ï¼š**

| æ¨¡å‹ | è¾“å…¥æˆæœ¬ ($/1M tokens) | è¾“å‡ºæˆæœ¬ ($/1M tokens) | å‹ç¼©æˆæœ¬ (50K tokens) |
|------|----------------------|----------------------|---------------------|
| **Claude Opus 4** | $15 | $75 | $0.75 + $0.15 = $0.90 |
| **Claude Sonnet 4** | $3 | $15 | $0.15 + $0.03 = $0.18 |
| **Gemini Flash 2.0** | $0.075 | $0.30 | $0.004 + $0.0006 = $0.005 |

**èŠ‚çœï¼šä½¿ç”¨ Gemini Flash å¯èŠ‚çœ 99% çš„å‹ç¼©æˆæœ¬ï¼**

**å®ç°ï¼š**
```typescript
context.session.on('session_before_compact', async (event) => {
  // ä½¿ç”¨ Gemini Flash è¿›è¡Œå‹ç¼©
  event.customModel = 'gemini-flash-2.0';

  console.log('ä½¿ç”¨ Gemini Flash è¿›è¡Œå‹ç¼©ï¼ˆæˆæœ¬ä¼˜åŒ–ï¼‰');
});
```

### 3.2 è´¨é‡ vs æˆæœ¬æƒè¡¡

**ä¸åŒæ¨¡å‹çš„å‹ç¼©è´¨é‡ï¼š**

| æ¨¡å‹ | å‹ç¼©è´¨é‡ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|---------|
| **Claude Opus 4** | â­â­â­â­â­ | ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’° | å…³é”®å¯¹è¯ã€å¤æ‚ä»»åŠ¡ |
| **Claude Sonnet 4** | â­â­â­â­ | ğŸ’°ğŸ’°ğŸ’° | ä¸€èˆ¬å¯¹è¯ã€æ—¥å¸¸ä½¿ç”¨ |
| **Gemini Flash 2.0** | â­â­â­ | ğŸ’° | ç®€å•å¯¹è¯ã€æˆæœ¬æ•æ„Ÿ |

**åŠ¨æ€é€‰æ‹©æ¨¡å‹ï¼š**
```typescript
context.session.on('session_before_compact', async (event) => {
  // æ ¹æ®å¯¹è¯å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
  const complexity = estimateComplexity(event.messages);

  if (complexity > 0.8) {
    event.customModel = 'claude-opus-4';  // é«˜è´¨é‡
  } else if (complexity > 0.5) {
    event.customModel = 'claude-sonnet-4'; // å¹³è¡¡
  } else {
    event.customModel = 'gemini-flash-2.0'; // æˆæœ¬ä¼˜åŒ–
  }
});

function estimateComplexity(messages: Message[]): number {
  // ç®€å•å¯å‘å¼ï¼šä»£ç é‡ã€æ–‡ä»¶æ•°ã€è®¨è®ºæ·±åº¦
  let complexity = 0;

  for (const message of messages) {
    // ä»£ç å—å¤š â†’ å¤æ‚åº¦é«˜
    const codeBlocks = (message.content.match(/```/g) || []).length / 2;
    complexity += codeBlocks * 0.1;

    // å·¥å…·è°ƒç”¨å¤š â†’ å¤æ‚åº¦é«˜
    if (message.tool_calls) {
      complexity += message.tool_calls.length * 0.05;
    }
  }

  return Math.min(complexity, 1.0);
}
```

---

## 4. å–æ¶ˆæˆ–æ›¿æ¢å‹ç¼©

### 4.1 å–æ¶ˆå‹ç¼©

**åœºæ™¯ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ä¸éœ€è¦å‹ç¼©**

```typescript
context.session.on('session_before_compact', async (event) => {
  // æ£€æŸ¥æ˜¯å¦åœ¨å…³é”®ä»»åŠ¡ä¸­
  const isInCriticalTask = checkCriticalTask(event.messages);

  if (isInCriticalTask) {
    // å–æ¶ˆå‹ç¼©ï¼Œä¿ç•™å®Œæ•´ä¸Šä¸‹æ–‡
    event.cancel = true;
    console.log('åœ¨å…³é”®ä»»åŠ¡ä¸­ï¼Œå–æ¶ˆå‹ç¼©');
  }
});

function checkCriticalTask(messages: Message[]): boolean {
  const lastMessage = messages[messages.length - 1];

  // æ£€æµ‹å…³é”®ä»»åŠ¡çš„ä¿¡å·
  const criticalSignals = [
    'æ­£åœ¨è°ƒè¯•',
    'debugging',
    'åˆ†æé”™è¯¯',
    'analyzing error',
  ];

  return criticalSignals.some(signal =>
    lastMessage.content.toLowerCase().includes(signal)
  );
}
```

### 4.2 æ›¿æ¢å‹ç¼©ç»“æœ

**åœºæ™¯ï¼šå®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘**

```typescript
context.session.on('session_before_compact', async (event) => {
  // ä½¿ç”¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘
  const customSummary = await myCustomCompression(event.messages);

  // æ›¿æ¢é»˜è®¤å‹ç¼©ç»“æœ
  event.replacement = [
    {
      role: 'summary',
      content: customSummary,
    },
  ];

  console.log('ä½¿ç”¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘');
});

async function myCustomCompression(messages: Message[]): Promise<string> {
  // è‡ªå®šä¹‰å‹ç¼©ç®—æ³•
  // ä¾‹å¦‚ï¼šä½¿ç”¨æœ¬åœ°æ¨¡å‹ã€è§„åˆ™basedå‹ç¼©ç­‰

  // 1. æå–å…³é”®ä¿¡æ¯
  const keyPoints = extractKeyPoints(messages);

  // 2. ç”Ÿæˆæ‘˜è¦
  const summary = `
## Custom Summary

${keyPoints.join('\n')}

## Statistics
- Total messages: ${messages.length}
- Code blocks: ${countCodeBlocks(messages)}
- Files modified: ${extractFiles(messages).modified.length}
  `;

  return summary;
}
```

---

## 5. æ¶ˆæ¯åºåˆ—åŒ–

### 5.1 serializeConversation() å‡½æ•°

**ç”¨é€”ï¼šå°†æ¶ˆæ¯è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œç”¨äºå‹ç¼©**

```typescript
function serializeConversation(messages: Message[]): string {
  let text = '';

  for (const message of messages) {
    // æ·»åŠ è§’è‰²æ ‡è®°
    text += `**${message.role}**:\n`;

    // æ·»åŠ å†…å®¹
    text += `${message.content}\n\n`;

    // æ·»åŠ å·¥å…·è°ƒç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
    if (message.tool_calls) {
      text += `[Tool Calls: ${message.tool_calls.length}]\n`;
      for (const toolCall of message.tool_calls) {
        text += `- ${toolCall.function.name}(${toolCall.function.arguments})\n`;
      }
      text += '\n';
    }
  }

  return text;
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
```typescript
context.session.on('session_before_compact', async (event) => {
  // åºåˆ—åŒ–æ¶ˆæ¯
  const conversationText = serializeConversation(event.messages);

  // ä½¿ç”¨è‡ªå®šä¹‰ LLM è¿›è¡Œå‹ç¼©
  const summary = await myLLM.summarize(conversationText);

  event.replacement = [
    { role: 'summary', content: summary },
  ];
});
```

### 5.2 è‡ªå®šä¹‰åºåˆ—åŒ–æ ¼å¼

**ç¤ºä¾‹ï¼šXML æ ¼å¼**
```typescript
function serializeToXML(messages: Message[]): string {
  let xml = '<conversation>\n';

  for (const message of messages) {
    xml += `  <message role="${message.role}">\n`;
    xml += `    <content>${escapeXML(message.content)}</content>\n`;

    if (message.tool_calls) {
      xml += `    <tool_calls>\n`;
      for (const toolCall of message.tool_calls) {
        xml += `      <tool name="${toolCall.function.name}">\n`;
        xml += `        <arguments>${escapeXML(toolCall.function.arguments)}</arguments>\n`;
        xml += `      </tool>\n`;
      }
      xml += `    </tool_calls>\n`;
    }

    xml += `  </message>\n`;
  }

  xml += '</conversation>';
  return xml;
}
```

**ç¤ºä¾‹ï¼šJSON æ ¼å¼**
```typescript
function serializeToJSON(messages: Message[]): string {
  const simplified = messages.map(msg => ({
    role: msg.role,
    content: msg.content,
    tools: msg.tool_calls?.map(tc => tc.function.name),
  }));

  return JSON.stringify(simplified, null, 2);
}
```

---

## 6. å®Œæ•´ç¤ºä¾‹ï¼šè‡ªå®šä¹‰å‹ç¼©æ‰©å±•

**åŸºäº pi-mono çš„ custom-compaction.ts ç¤ºä¾‹ï¼š**

```typescript
import { Extension } from '@mariozechner/pi-agent-core';

export const customCompactionExtension: Extension = {
  name: 'custom-compaction',
  description: 'è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥ï¼Œä½¿ç”¨ Gemini Flash é™ä½æˆæœ¬',

  async onLoad(context) {
    console.log('âœ… è‡ªå®šä¹‰å‹ç¼©æ‰©å±•å·²åŠ è½½');

    // ç›‘å¬å‹ç¼©å‰äº‹ä»¶
    context.session.on('session_before_compact', async (event) => {
      console.log('=== è‡ªå®šä¹‰å‹ç¼©è§¦å‘ ===');
      console.log(`å½“å‰ tokens: ${event.contextTokens}`);
      console.log(`é˜ˆå€¼: ${event.contextWindow - event.reserveTokens}`);

      // 1. ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹
      event.customModel = 'gemini-flash-2.0';

      // 2. è‡ªå®šä¹‰æç¤ºè¯
      event.customPrompt = `
è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

## Summary
[1-2 æ®µè¯çš„é«˜å±‚æ¬¡æ¦‚è¿°]

## Key Achievements
- [å®Œæˆçš„åŠŸèƒ½ 1]
- [å®Œæˆçš„åŠŸèƒ½ 2]

## Technical Decisions
- [å†³ç­– 1]: [åŸå› ]
- [å†³ç­– 2]: [åŸå› ]

## Files
- Read: [æ–‡ä»¶åˆ—è¡¨]
- Modified: [æ–‡ä»¶åˆ—è¡¨]

## Next Steps
- [å¾…åŠäº‹é¡¹ 1]
- [å¾…åŠäº‹é¡¹ 2]
      `;

      // 3. è®°å½•å‹ç¼©äº‹ä»¶
      await logCompactionEvent(event);
    });
  },
};

async function logCompactionEvent(event: CompactionEvent) {
  const log = {
    timestamp: new Date().toISOString(),
    contextTokens: event.contextTokens,
    contextWindow: event.contextWindow,
    usage: (event.contextTokens / event.contextWindow * 100).toFixed(2) + '%',
    model: event.customModel || 'default',
  };

  console.log('å‹ç¼©æ—¥å¿—:', JSON.stringify(log, null, 2));

  // å¯ä»¥ä¿å­˜åˆ°æ–‡ä»¶
  // await fs.appendFile('.pi/compaction.log', JSON.stringify(log) + '\n');
}
```

**ä½¿ç”¨æ‰©å±•ï¼š**
```bash
# 1. åˆ›å»ºæ‰©å±•æ–‡ä»¶
mkdir -p .pi/extensions
cat > .pi/extensions/custom-compaction.ts << 'EOF'
[ä¸Šé¢çš„ä»£ç ]
EOF

# 2. é‡æ–°åŠ è½½æ‰©å±•
pi
/reload

# 3. æµ‹è¯•å‹ç¼©
/compact æµ‹è¯•è‡ªå®šä¹‰å‹ç¼©
```

---

## 7. 2025-2026 å‰æ²¿å®è·µ

### 7.1 RL-based Compression

> **2025-2026 Research**: ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å‹ç¼©ç­–ç•¥ã€‚
> ([RL Compression Discussion](https://www.reddit.com/r/LocalLLaMA/comments/...))

**æ ¸å¿ƒæ€æƒ³ï¼š**
```typescript
// æ ¹æ®å‹ç¼©æ•ˆæœè°ƒæ•´ç­–ç•¥
class RLCompactionStrategy {
  private rewards: number[] = [];

  async compress(messages: Message[]): Promise<string> {
    // 1. é€‰æ‹©å‹ç¼©ç­–ç•¥ï¼ˆåŸºäºå†å²å¥–åŠ±ï¼‰
    const strategy = this.selectStrategy();

    // 2. æ‰§è¡Œå‹ç¼©
    const summary = await this.applySt rategy(strategy, messages);

    // 3. è¯„ä¼°å‹ç¼©è´¨é‡
    const reward = await this.evaluateQuality(summary, messages);

    // 4. æ›´æ–°ç­–ç•¥
    this.updateStrategy(strategy, reward);

    return summary;
  }
}
```

### 7.2 Production Best Practices

> **2025-2026 Industry Practice**: ç”Ÿäº§ç¯å¢ƒä¸­çš„å‹ç¼©æœ€ä½³å®è·µã€‚
> ([GitHub Discussions](https://github.com/...))

**å…³é”®å®è·µï¼š**

1. **ç›‘æ§å‹ç¼©è´¨é‡**
```typescript
// è®°å½•æ¯æ¬¡å‹ç¼©çš„æŒ‡æ ‡
const metrics = {
  compressionRatio: originalTokens / summaryTokens,
  cost: calculateCost(model, tokens),
  quality: evaluateQuality(summary),
  timestamp: Date.now(),
};

await saveMetrics(metrics);
```

2. **A/B æµ‹è¯•å‹ç¼©ç­–ç•¥**
```typescript
// éšæœºé€‰æ‹©å‹ç¼©ç­–ç•¥ï¼Œå¯¹æ¯”æ•ˆæœ
const strategy = Math.random() < 0.5 ? 'strategyA' : 'strategyB';
await compressWithStrategy(strategy);
```

3. **å›é€€æœºåˆ¶**
```typescript
// å¦‚æœå‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ç­–ç•¥
try {
  await compressWithGemini();
} catch (error) {
  console.warn('Gemini å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨ Claude Sonnet');
  await compressWithClaude();
}
```

---

## æ€»ç»“

**æ‰‹åŠ¨å‹ç¼©ä¸è‡ªå®šä¹‰æŒ‡ä»¤çš„æ ¸å¿ƒè¦ç‚¹ï¼š**

1. **/compact å‘½ä»¤**ï¼šæ‰‹åŠ¨è§¦å‘å‹ç¼©ï¼Œå¯æŒ‡å®šè‡ªå®šä¹‰æŒ‡ä»¤
2. **Extension é’©å­**ï¼š`session_before_compact` äº‹ä»¶æ‹¦æˆªå‹ç¼©
3. **è‡ªå®šä¹‰æç¤ºè¯**ï¼šæ ¹æ®åœºæ™¯å®šåˆ¶å‹ç¼©æ ¼å¼
4. **è‡ªå®šä¹‰æ¨¡å‹**ï¼šä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹é™ä½æˆæœ¬
5. **å–æ¶ˆ/æ›¿æ¢**ï¼šå®Œå…¨æ§åˆ¶å‹ç¼©è¡Œä¸º
6. **æ¶ˆæ¯åºåˆ—åŒ–**ï¼šè½¬æ¢æ¶ˆæ¯æ ¼å¼ç”¨äºè‡ªå®šä¹‰å‹ç¼©

**å…³é”®ç†è§£ï¼š**
- æ‰‹åŠ¨å‹ç¼©é€‚åˆä»»åŠ¡è¾¹ç•Œå’Œè¯é¢˜åˆ‡æ¢
- Extension æä¾›äº†å¼ºå¤§çš„å®šåˆ¶èƒ½åŠ›
- ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹å¯å¤§å¹…é™ä½æˆæœ¬
- å¯ä»¥å®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘

---

**ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š**
- **å®æˆ˜ä»£ç  01**ï¼šåŸºç¡€å‹ç¼©é…ç½®ï¼ˆ07_å®æˆ˜ä»£ç _01_åŸºç¡€å‹ç¼©é…ç½®.mdï¼‰
- **å®æˆ˜ä»£ç  02**ï¼šè‡ªå®šä¹‰å‹ç¼©æ‰©å±•ï¼ˆ07_å®æˆ˜ä»£ç _02_è‡ªå®šä¹‰å‹ç¼©æ‰©å±•.mdï¼‰

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-20
**ç»´æŠ¤è€…ï¼š** Claude Code
