# 环境变量管理 - 概览

## 知识点定位

**阶段：** Phase6_部署与架构（第3个知识点）

**前置知识：**
- Phase2_FastAPI核心（应用启动和关闭事件）
- Phase3_数据库层（连接池管理）
- Phase5_生产级实践（日志、错误处理）

**后续学习：**
- 健康检查端点
- 优雅关闭
- Kubernetes ConfigMap/Secrets

---

## 学习目标

完成本知识点后，你将能够：

- [ ] 使用 python-dotenv 加载 .env 文件
- [ ] 用 Pydantic Settings 构建类型安全的配置类
- [ ] 理解 12-Factor App 配置分离原则
- [ ] 实现开发/测试/生产环境的配置切换
- [ ] 在 Docker 容器中注入环境变量
- [ ] 保护 API 密钥等敏感信息
- [ ] 理解配置优先级（系统环境变量 > .env > 默认值）
- [ ] 实现配置验证机制
- [ ] 设计多环境文件模式

---

## 核心价值

**为什么需要环境变量管理？**

在 AI Agent 后端开发中，你会遇到这些问题：

1. **配置硬编码**：数据库连接、API 密钥写死在代码里
2. **环境混乱**：开发时连接生产数据库，导致数据污染
3. **密钥泄露**：API 密钥提交到 git，被公开访问
4. **部署困难**：每次部署都要修改代码中的配置

**环境变量管理解决这些问题：**

- ✅ 配置与代码分离，不同环境用不同配置
- ✅ 敏感信息不提交到 git，保护密钥安全
- ✅ 部署时只需改环境变量，不需要修改代码
- ✅ 类型安全的配置验证，启动时发现配置错误

---

## 知识点结构

### 1. 基础工具层

- **python-dotenv**：加载 .env 文件到系统环境变量
- **Pydantic Settings**：类型安全的配置类
- **os.getenv()**：读取环境变量

### 2. 架构原则层

- **12-Factor App**：配置分离原则
- **配置优先级**：系统环境变量 > .env > 默认值
- **环境隔离**：开发/测试/生产环境分离

### 3. 实践应用层

- **多环境文件模式**：.env.dev、.env.test、.env.prod
- **Docker 环境变量注入**：docker-compose、Kubernetes
- **敏感信息保护**：.gitignore、密钥管理服务

---

## 学习路径

```
python-dotenv 基础
    ↓
Pydantic Settings 配置类
    ↓
12-Factor App 原则
    ↓
环境检测与切换
    ↓
配置层级与优先级
    ↓
Docker 环境变量
    ↓
敏感信息管理
    ↓
配置验证机制
    ↓
多环境文件模式
```

---

## 快速开始

### 最简单的例子

```python
# .env
DATABASE_URL=postgresql://localhost:5432/mydb
OPENAI_API_KEY=sk-xxx

# app.py
from dotenv import load_dotenv
import os

load_dotenv()

db_url = os.getenv("DATABASE_URL")
api_key = os.getenv("OPENAI_API_KEY")

print(f"数据库: {db_url}")
print(f"API密钥: {api_key[:10]}...")
```

### 生产级例子

```python
# config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str
    openai_api_key: str
    debug: bool = False

    class Config:
        env_file = ".env"

settings = Settings()

# main.py
from config import settings

print(f"数据库: {settings.database_url}")
print(f"调试模式: {settings.debug}")
```

---

## 实际应用场景

### 场景1：本地开发

```bash
# .env.dev
DATABASE_URL=postgresql://localhost:5432/dev_db
OPENAI_API_KEY=sk-dev-xxx
DEBUG=True
```

### 场景2：测试环境

```bash
# .env.test
DATABASE_URL=postgresql://test-db:5432/test_db
OPENAI_API_KEY=sk-test-xxx
DEBUG=False
```

### 场景3：生产环境

```bash
# 系统环境变量（不用 .env 文件）
export DATABASE_URL=postgresql://prod-db:5432/prod_db
export OPENAI_API_KEY=sk-prod-xxx
export DEBUG=False
```

---

## 常见问题

### Q1: .env 文件应该提交到 git 吗？

**A:** 不应该！`.env` 包含敏感信息，应该加入 `.gitignore`。提交 `.env.example` 作为模板。

### Q2: Pydantic Settings 和 os.getenv() 有什么区别？

**A:** Pydantic Settings 提供类型验证、必需字段检查、IDE 提示，而 os.getenv() 只返回字符串。

### Q3: 配置优先级是什么？

**A:** 系统环境变量 > .env 文件 > 默认值。系统环境变量优先级最高。

### Q4: Docker 容器中如何使用环境变量？

**A:** 通过 `docker-compose.yml` 的 `environment` 或 `env_file` 注入。

---

## 学习建议

1. **先掌握基础**：从 python-dotenv 和 Pydantic Settings 开始
2. **理解原则**：学习 12-Factor App 配置分离原则
3. **实践应用**：在实际项目中实现多环境配置
4. **关注安全**：重点学习敏感信息保护
5. **深入优化**：学习配置验证、优先级、Docker 集成

---

## 预计学习时间

- **快速入门**：30分钟（掌握 python-dotenv 和基础用法）
- **深入理解**：2小时（掌握 Pydantic Settings 和多环境配置）
- **生产实践**：4小时（掌握 Docker 集成和敏感信息保护）

---

## 参考资源

- [python-dotenv 官方文档](https://github.com/theskumar/python-dotenv)
- [Pydantic Settings 官方文档](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
- [12-Factor App 配置原则](https://12factor.net/config)
- [FastAPI 配置最佳实践](https://fastapi.tiangolo.com/advanced/settings/)

---

**版本：** v1.0
**最后更新：** 2026-02-13
