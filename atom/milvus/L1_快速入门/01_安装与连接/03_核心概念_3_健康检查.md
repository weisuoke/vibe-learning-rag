# æ ¸å¿ƒæ¦‚å¿µ 3: å¥åº·æ£€æŸ¥

æ·±å…¥ç†è§£ Milvus 2.6 çš„å¥åº·æ£€æŸ¥æœºåˆ¶ã€ç›‘æ§æ–¹æ³•å’Œæ•…éšœæ’æŸ¥ç­–ç•¥ã€‚

---

## æ¦‚è¿°

å¥åº·æ£€æŸ¥æ˜¯ç¡®ä¿ Milvus æœåŠ¡æ­£å¸¸è¿è¡Œçš„å…³é”®æœºåˆ¶,é€šè¿‡å¤šç§æ–¹æ³•éªŒè¯æœåŠ¡çŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

---

## å¥åº·æ£€æŸ¥å±‚æ¬¡

### ä¸‰å±‚å¥åº·æ£€æŸ¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¥åº·æ£€æŸ¥å±‚æ¬¡                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  1. å®¹å™¨å±‚å¥åº·æ£€æŸ¥                                        â”‚
â”‚     â”œâ”€â”€ Docker healthcheck                              â”‚
â”‚     â”œâ”€â”€ å®¹å™¨çŠ¶æ€ç›‘æ§                                      â”‚
â”‚     â””â”€â”€ è¿›ç¨‹å­˜æ´»æ£€æŸ¥                                      â”‚
â”‚                                                          â”‚
â”‚  2. æœåŠ¡å±‚å¥åº·æ£€æŸ¥                                        â”‚
â”‚     â”œâ”€â”€ HTTP healthz endpoint                           â”‚
â”‚     â”œâ”€â”€ gRPC è¿æ¥æµ‹è¯•                                    â”‚
â”‚     â””â”€â”€ API å“åº”éªŒè¯                                      â”‚
â”‚                                                          â”‚
â”‚  3. æ•°æ®å±‚å¥åº·æ£€æŸ¥                                        â”‚
â”‚     â”œâ”€â”€ Collection å¯è®¿é—®æ€§                              â”‚
â”‚     â”œâ”€â”€ æ•°æ®ä¸€è‡´æ€§éªŒè¯                                    â”‚
â”‚     â””â”€â”€ ç´¢å¼•çŠ¶æ€æ£€æŸ¥                                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®¹å™¨å±‚å¥åº·æ£€æŸ¥

### Docker Healthcheck é…ç½®

```yaml
# docker-compose.yml
services:
  standalone:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s        # æ£€æŸ¥é—´éš”
      start_period: 90s    # å¯åŠ¨å®½é™æœŸ
      timeout: 20s         # è¶…æ—¶æ—¶é—´
      retries: 3           # é‡è¯•æ¬¡æ•°
```

**å‚æ•°è¯¦è§£**:

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | å»ºè®®å€¼ |
|------|------|--------|--------|
| `test` | å¥åº·æ£€æŸ¥å‘½ä»¤ | - | `curl -f http://localhost:9091/healthz` |
| `interval` | æ£€æŸ¥é—´éš” | 30s | 30s |
| `start_period` | å¯åŠ¨å®½é™æœŸ | 0s | 90s |
| `timeout` | è¶…æ—¶æ—¶é—´ | 30s | 20s |
| `retries` | é‡è¯•æ¬¡æ•° | 3 | 3 |

### æŸ¥çœ‹å®¹å™¨å¥åº·çŠ¶æ€

```bash
# æ–¹æ³• 1: docker compose ps
docker compose ps

# è¾“å‡ºç¤ºä¾‹:
# NAME                COMMAND                  SERVICE      STATUS       PORTS
# milvus-standalone   /tini -- milvus run stâ€¦  standalone   Up (healthy) 0.0.0.0:19530->19530/tcp

# æ–¹æ³• 2: docker inspect
docker inspect --format='{{.State.Health.Status}}' milvus-standalone

# è¾“å‡ºç¤ºä¾‹:
# healthy

# æ–¹æ³• 3: æŸ¥çœ‹å¥åº·æ£€æŸ¥æ—¥å¿—
docker inspect --format='{{json .State.Health}}' milvus-standalone | jq

# è¾“å‡ºç¤ºä¾‹:
# {
#   "Status": "healthy",
#   "FailingStreak": 0,
#   "Log": [
#     {
#       "Start": "2026-02-16T10:00:00Z",
#       "End": "2026-02-16T10:00:01Z",
#       "ExitCode": 0,
#       "Output": "OK"
#     }
#   ]
# }
```

### å¥åº·çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | åŸå›  |
|------|------|------|
| **starting** | å¯åŠ¨ä¸­ | å®¹å™¨åˆšå¯åŠ¨,åœ¨ start_period å†… |
| **healthy** | å¥åº· | å¥åº·æ£€æŸ¥é€šè¿‡ |
| **unhealthy** | ä¸å¥åº· | è¿ç»­ retries æ¬¡æ£€æŸ¥å¤±è´¥ |
| **none** | æ— å¥åº·æ£€æŸ¥ | æœªé…ç½® healthcheck |

---

## æœåŠ¡å±‚å¥åº·æ£€æŸ¥

### HTTP Healthz Endpoint

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://localhost:9091/healthz

# è¾“å‡ºç¤ºä¾‹:
# OK

# è¯¦ç»†å¥åº·æ£€æŸ¥
curl http://localhost:9091/healthz?detail=true

# è¾“å‡ºç¤ºä¾‹ (JSON):
# {
#   "status": "healthy",
#   "components": {
#     "proxy": "healthy",
#     "query_node": "healthy",
#     "data_node": "healthy",
#     "index_node": "healthy"
#   },
#   "timestamp": "2026-02-16T10:00:00Z"
# }
```

### gRPC è¿æ¥æµ‹è¯•

```python
from pymilvus import MilvusClient

def check_grpc_connection():
    """æ£€æŸ¥ gRPC è¿æ¥"""
    try:
        client = MilvusClient(uri="http://localhost:19530")
        # å°è¯•åˆ—å‡º Collection
        collections = client.list_collections()
        print(f"âœ… gRPC è¿æ¥æ­£å¸¸,Collection æ•°é‡: {len(collections)}")
        return True
    except Exception as e:
        print(f"âŒ gRPC è¿æ¥å¤±è´¥: {e}")
        return False

# è¿è¡Œæ£€æŸ¥
check_grpc_connection()
```

### API å“åº”éªŒè¯

```python
import time
from pymilvus import MilvusClient

def check_api_response_time():
    """æ£€æŸ¥ API å“åº”æ—¶é—´"""
    client = MilvusClient(uri="http://localhost:19530")

    # æµ‹è¯• list_collections å“åº”æ—¶é—´
    start = time.time()
    collections = client.list_collections()
    elapsed = time.time() - start

    print(f"API å“åº”æ—¶é—´: {elapsed*1000:.2f}ms")

    if elapsed < 0.1:
        print("âœ… å“åº”æ—¶é—´æ­£å¸¸ (< 100ms)")
        return True
    elif elapsed < 1.0:
        print("âš ï¸  å“åº”æ—¶é—´è¾ƒæ…¢ (100ms - 1s)")
        return True
    else:
        print("âŒ å“åº”æ—¶é—´è¿‡æ…¢ (> 1s)")
        return False

# è¿è¡Œæ£€æŸ¥
check_api_response_time()
```

---

## æ•°æ®å±‚å¥åº·æ£€æŸ¥

### Collection å¯è®¿é—®æ€§æ£€æŸ¥

```python
from pymilvus import MilvusClient

def check_collection_accessibility(collection_name):
    """æ£€æŸ¥ Collection æ˜¯å¦å¯è®¿é—®"""
    client = MilvusClient(uri="http://localhost:19530")

    try:
        # æ£€æŸ¥ Collection æ˜¯å¦å­˜åœ¨
        if not client.has_collection(collection_name):
            print(f"âŒ Collection '{collection_name}' ä¸å­˜åœ¨")
            return False

        # è·å– Collection è¯¦æƒ…
        info = client.describe_collection(collection_name)
        print(f"âœ… Collection '{collection_name}' å¯è®¿é—®")
        print(f"   - å­—æ®µæ•°: {len(info['fields'])}")
        print(f"   - å‘é‡ç»´åº¦: {info['fields'][1]['params']['dim']}")

        # å°è¯•æŸ¥è¯¢æ•°æ®
        results = client.query(
            collection_name=collection_name,
            filter="id >= 0",
            limit=1
        )
        print(f"   - æ•°æ®å¯æŸ¥è¯¢: {len(results)} æ¡")

        return True
    except Exception as e:
        print(f"âŒ Collection è®¿é—®å¤±è´¥: {e}")
        return False

# è¿è¡Œæ£€æŸ¥
check_collection_accessibility("test")
```

### æ•°æ®ä¸€è‡´æ€§éªŒè¯

```python
from pymilvus import MilvusClient

def check_data_consistency(collection_name):
    """æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§"""
    client = MilvusClient(uri="http://localhost:19530")

    try:
        # æ’å…¥æµ‹è¯•æ•°æ®
        test_id = 999999
        test_data = [{
            "id": test_id,
            "vector": [0.1] * 128,
            "text": "å¥åº·æ£€æŸ¥æµ‹è¯•æ•°æ®"
        }]

        client.insert(collection_name=collection_name, data=test_data)
        print(f"âœ… æ’å…¥æµ‹è¯•æ•°æ®: ID={test_id}")

        # ç­‰å¾…æ•°æ®å¯è§
        import time
        time.sleep(1)

        # æŸ¥è¯¢æµ‹è¯•æ•°æ®
        results = client.query(
            collection_name=collection_name,
            filter=f"id == {test_id}",
            output_fields=["id", "text"]
        )

        if len(results) == 1 and results[0]["id"] == test_id:
            print(f"âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡")

            # æ¸…ç†æµ‹è¯•æ•°æ®
            client.delete(collection_name=collection_name, ids=[test_id])
            print(f"âœ… æ¸…ç†æµ‹è¯•æ•°æ®")

            return True
        else:
            print(f"âŒ æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥")
            return False

    except Exception as e:
        print(f"âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: {e}")
        return False

# è¿è¡Œæ£€æŸ¥
check_data_consistency("test")
```

### ç´¢å¼•çŠ¶æ€æ£€æŸ¥

```python
from pymilvus import MilvusClient

def check_index_status(collection_name):
    """æ£€æŸ¥ç´¢å¼•çŠ¶æ€"""
    client = MilvusClient(uri="http://localhost:19530")

    try:
        # åˆ—å‡ºç´¢å¼•
        indexes = client.list_indexes(collection_name)

        if not indexes:
            print(f"âš ï¸  Collection '{collection_name}' æ²¡æœ‰ç´¢å¼•")
            return False

        print(f"âœ… Collection '{collection_name}' ç´¢å¼•çŠ¶æ€:")
        for index_name in indexes:
            # è·å–ç´¢å¼•è¯¦æƒ…
            index_info = client.describe_index(
                collection_name=collection_name,
                index_name=index_name
            )
            print(f"   - ç´¢å¼•å: {index_name}")
            print(f"   - ç´¢å¼•ç±»å‹: {index_info['index_type']}")
            print(f"   - åº¦é‡ç±»å‹: {index_info['metric_type']}")

        return True
    except Exception as e:
        print(f"âŒ ç´¢å¼•çŠ¶æ€æ£€æŸ¥å¤±è´¥: {e}")
        return False

# è¿è¡Œæ£€æŸ¥
check_index_status("test")
```

---

## å®Œæ•´å¥åº·æ£€æŸ¥è„šæœ¬

### Python å¥åº·æ£€æŸ¥è„šæœ¬

```python
#!/usr/bin/env python3
"""
Milvus 2.6 å®Œæ•´å¥åº·æ£€æŸ¥è„šæœ¬
"""

import time
import sys
from pymilvus import MilvusClient
import requests

class MilvusHealthChecker:
    def __init__(self, uri="http://localhost:19530", webui_url="http://localhost:9091"):
        self.uri = uri
        self.webui_url = webui_url
        self.client = None
        self.checks_passed = 0
        self.checks_failed = 0

    def run_all_checks(self):
        """è¿è¡Œæ‰€æœ‰å¥åº·æ£€æŸ¥"""
        print("=" * 60)
        print("Milvus 2.6 å¥åº·æ£€æŸ¥")
        print("=" * 60)
        print()

        # 1. HTTP Healthz æ£€æŸ¥
        self.check_http_healthz()

        # 2. gRPC è¿æ¥æ£€æŸ¥
        self.check_grpc_connection()

        # 3. API å“åº”æ—¶é—´æ£€æŸ¥
        self.check_api_response_time()

        # 4. Collection åˆ—è¡¨æ£€æŸ¥
        self.check_collections()

        # 5. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
        self.check_data_consistency()

        # 6. æ€»ç»“
        self.print_summary()

        return self.checks_failed == 0

    def check_http_healthz(self):
        """æ£€æŸ¥ HTTP healthz endpoint"""
        print("[1/5] HTTP Healthz æ£€æŸ¥...")
        try:
            response = requests.get(f"{self.webui_url}/healthz", timeout=5)
            if response.status_code == 200:
                print("âœ… HTTP healthz æ­£å¸¸")
                self.checks_passed += 1
            else:
                print(f"âŒ HTTP healthz å¼‚å¸¸: {response.status_code}")
                self.checks_failed += 1
        except Exception as e:
            print(f"âŒ HTTP healthz å¤±è´¥: {e}")
            self.checks_failed += 1
        print()

    def check_grpc_connection(self):
        """æ£€æŸ¥ gRPC è¿æ¥"""
        print("[2/5] gRPC è¿æ¥æ£€æŸ¥...")
        try:
            self.client = MilvusClient(uri=self.uri)
            collections = self.client.list_collections()
            print(f"âœ… gRPC è¿æ¥æ­£å¸¸,Collection æ•°é‡: {len(collections)}")
            self.checks_passed += 1
        except Exception as e:
            print(f"âŒ gRPC è¿æ¥å¤±è´¥: {e}")
            self.checks_failed += 1
        print()

    def check_api_response_time(self):
        """æ£€æŸ¥ API å“åº”æ—¶é—´"""
        print("[3/5] API å“åº”æ—¶é—´æ£€æŸ¥...")
        if not self.client:
            print("â­ï¸  è·³è¿‡ (gRPC è¿æ¥å¤±è´¥)")
            print()
            return

        try:
            start = time.time()
            self.client.list_collections()
            elapsed = time.time() - start

            print(f"   å“åº”æ—¶é—´: {elapsed*1000:.2f}ms")

            if elapsed < 0.1:
                print("âœ… å“åº”æ—¶é—´æ­£å¸¸ (< 100ms)")
                self.checks_passed += 1
            elif elapsed < 1.0:
                print("âš ï¸  å“åº”æ—¶é—´è¾ƒæ…¢ (100ms - 1s)")
                self.checks_passed += 1
            else:
                print("âŒ å“åº”æ—¶é—´è¿‡æ…¢ (> 1s)")
                self.checks_failed += 1
        except Exception as e:
            print(f"âŒ API å“åº”æ—¶é—´æ£€æŸ¥å¤±è´¥: {e}")
            self.checks_failed += 1
        print()

    def check_collections(self):
        """æ£€æŸ¥ Collection åˆ—è¡¨"""
        print("[4/5] Collection åˆ—è¡¨æ£€æŸ¥...")
        if not self.client:
            print("â­ï¸  è·³è¿‡ (gRPC è¿æ¥å¤±è´¥)")
            print()
            return

        try:
            collections = self.client.list_collections()
            print(f"âœ… Collection æ•°é‡: {len(collections)}")
            if collections:
                print(f"   Collection åˆ—è¡¨: {', '.join(collections)}")
            self.checks_passed += 1
        except Exception as e:
            print(f"âŒ Collection åˆ—è¡¨æ£€æŸ¥å¤±è´¥: {e}")
            self.checks_failed += 1
        print()

    def check_data_consistency(self):
        """æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§"""
        print("[5/5] æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...")
        if not self.client:
            print("â­ï¸  è·³è¿‡ (gRPC è¿æ¥å¤±è´¥)")
            print()
            return

        try:
            # åˆ›å»ºä¸´æ—¶ Collection
            test_collection = "_health_check_test"

            # å¦‚æœå­˜åœ¨åˆ™åˆ é™¤
            if self.client.has_collection(test_collection):
                self.client.drop_collection(test_collection)

            # åˆ›å»º Collection
            self.client.create_collection(
                collection_name=test_collection,
                dimension=128,
                metric_type="COSINE"
            )
            print(f"   åˆ›å»ºæµ‹è¯• Collection: {test_collection}")

            # æ’å…¥æµ‹è¯•æ•°æ®
            test_data = [{
                "id": 1,
                "vector": [0.1] * 128,
                "text": "å¥åº·æ£€æŸ¥æµ‹è¯•"
            }]
            self.client.insert(collection_name=test_collection, data=test_data)
            print(f"   æ’å…¥æµ‹è¯•æ•°æ®: 1 æ¡")

            # ç­‰å¾…æ•°æ®å¯è§
            time.sleep(1)

            # æŸ¥è¯¢æµ‹è¯•æ•°æ®
            results = self.client.query(
                collection_name=test_collection,
                filter="id == 1",
                output_fields=["id", "text"]
            )

            if len(results) == 1:
                print(f"   æŸ¥è¯¢æµ‹è¯•æ•°æ®: æˆåŠŸ")
                print("âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡")
                self.checks_passed += 1
            else:
                print(f"   æŸ¥è¯¢æµ‹è¯•æ•°æ®: å¤±è´¥")
                print("âŒ æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥")
                self.checks_failed += 1

            # æ¸…ç†æµ‹è¯• Collection
            self.client.drop_collection(test_collection)
            print(f"   æ¸…ç†æµ‹è¯• Collection")

        except Exception as e:
            print(f"âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: {e}")
            self.checks_failed += 1
        print()

    def print_summary(self):
        """æ‰“å°æ€»ç»“"""
        print("=" * 60)
        print("å¥åº·æ£€æŸ¥æ€»ç»“")
        print("=" * 60)
        print(f"âœ… é€šè¿‡: {self.checks_passed}")
        print(f"âŒ å¤±è´¥: {self.checks_failed}")
        print()

        if self.checks_failed == 0:
            print("ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡!")
            print()
            return True
        else:
            print("âš ï¸  éƒ¨åˆ†å¥åº·æ£€æŸ¥å¤±è´¥,è¯·æ£€æŸ¥æ—¥å¿—")
            print()
            return False

def main():
    """ä¸»å‡½æ•°"""
    checker = MilvusHealthChecker()
    success = checker.run_all_checks()
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
```

### Bash å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# Milvus 2.6 å¥åº·æ£€æŸ¥è„šæœ¬

set -e

echo "======================================================================"
echo "Milvus 2.6 å¥åº·æ£€æŸ¥"
echo "======================================================================"
echo ""

CHECKS_PASSED=0
CHECKS_FAILED=0

# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
echo "[1/5] å®¹å™¨çŠ¶æ€æ£€æŸ¥..."
if docker compose ps | grep -q "milvus-standalone.*Up"; then
    echo "âœ… Milvus å®¹å™¨æ­£åœ¨è¿è¡Œ"
    ((CHECKS_PASSED++))
else
    echo "âŒ Milvus å®¹å™¨æœªè¿è¡Œ"
    ((CHECKS_FAILED++))
fi
echo ""

# 2. æ£€æŸ¥ç«¯å£
echo "[2/5] ç«¯å£æ£€æŸ¥..."
if nc -z localhost 19530 2>/dev/null; then
    echo "âœ… ç«¯å£ 19530 (gRPC) å¯è®¿é—®"
    ((CHECKS_PASSED++))
else
    echo "âŒ ç«¯å£ 19530 (gRPC) ä¸å¯è®¿é—®"
    ((CHECKS_FAILED++))
fi
echo ""

# 3. æ£€æŸ¥ HTTP healthz
echo "[3/5] HTTP Healthz æ£€æŸ¥..."
if curl -sf http://localhost:9091/healthz > /dev/null; then
    echo "âœ… HTTP healthz æ­£å¸¸"
    ((CHECKS_PASSED++))
else
    echo "âŒ HTTP healthz å¼‚å¸¸"
    ((CHECKS_FAILED++))
fi
echo ""

# 4. æ£€æŸ¥ gRPC è¿æ¥
echo "[4/5] gRPC è¿æ¥æ£€æŸ¥..."
if python3 -c "from pymilvus import MilvusClient; MilvusClient('http://localhost:19530').list_collections()" 2>/dev/null; then
    echo "âœ… gRPC è¿æ¥æ­£å¸¸"
    ((CHECKS_PASSED++))
else
    echo "âŒ gRPC è¿æ¥å¤±è´¥"
    ((CHECKS_FAILED++))
fi
echo ""

# 5. æ£€æŸ¥æ—¥å¿—
echo "[5/5] æ—¥å¿—æ£€æŸ¥..."
if docker compose logs milvus-standalone --tail=10 | grep -q "Milvus Proxy successfully started"; then
    echo "âœ… Milvus å¯åŠ¨æ—¥å¿—æ­£å¸¸"
    ((CHECKS_PASSED++))
else
    echo "âš ï¸  Milvus å¯åŠ¨æ—¥å¿—æœªæ‰¾åˆ° (å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­)"
fi
echo ""

# æ€»ç»“
echo "======================================================================"
echo "å¥åº·æ£€æŸ¥æ€»ç»“"
echo "======================================================================"
echo "âœ… é€šè¿‡: $CHECKS_PASSED"
echo "âŒ å¤±è´¥: $CHECKS_FAILED"
echo ""

if [ $CHECKS_FAILED -eq 0 ]; then
    echo "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡!"
    exit 0
else
    echo "âš ï¸  éƒ¨åˆ†å¥åº·æ£€æŸ¥å¤±è´¥,è¯·æ£€æŸ¥æ—¥å¿—"
    exit 1
fi
```

---

## ç›‘æ§å’Œå‘Šè­¦

### Prometheus ç›‘æ§

```yaml
# docker-compose.yml
services:
  standalone:
    ports:
      - "9091:9091"  # Prometheus metrics endpoint

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
```

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'milvus'
    static_configs:
      - targets: ['standalone:9091']
```

### Grafana å¯è§†åŒ–

```yaml
# docker-compose.yml
services:
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-storage:/var/lib/grafana

volumes:
  grafana-storage:
```

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|------|------|---------|---------|
| **milvus_proxy_req_count** | è¯·æ±‚æ€»æ•° | - | - |
| **milvus_proxy_req_latency** | è¯·æ±‚å»¶è¿Ÿ | < 100ms | > 1s |
| **milvus_query_node_memory_usage** | å†…å­˜ä½¿ç”¨ | < 80% | > 90% |
| **milvus_data_node_insert_rate** | æ’å…¥é€Ÿç‡ | - | - |
| **milvus_index_node_build_duration** | ç´¢å¼•æ„å»ºæ—¶é—´ | < 60s | > 300s |

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜è¯Šæ–­

#### é—®é¢˜ 1: å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# è¯Šæ–­æ­¥éª¤
# 1. æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps

# 2. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker compose logs milvus-standalone

# 3. æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :19530

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 5. æ£€æŸ¥å†…å­˜
free -h
```

#### é—®é¢˜ 2: è¿æ¥è¶…æ—¶

```bash
# è¯Šæ–­æ­¥éª¤
# 1. æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker compose ps

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
nc -zv localhost 19530

# 3. æ£€æŸ¥é˜²ç«å¢™
sudo iptables -L | grep 19530

# 4. æ£€æŸ¥ Milvus æ—¥å¿—
docker compose logs milvus-standalone | grep "error"

# 5. ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
sleep 30
python -c "from pymilvus import MilvusClient; MilvusClient('http://localhost:19530').list_collections()"
```

#### é—®é¢˜ 3: æ•°æ®ä¸ä¸€è‡´

```bash
# è¯Šæ–­æ­¥éª¤
# 1. æ£€æŸ¥ WAL æ—¥å¿—
docker compose exec milvus-standalone ls -la /var/lib/milvus/wal/

# 2. æ£€æŸ¥ Compaction çŠ¶æ€
# (éœ€è¦é€šè¿‡ API æŸ¥è¯¢)

# 3. æ‰‹åŠ¨è§¦å‘ Compaction
# (éœ€è¦é€šè¿‡ API è§¦å‘)

# 4. æ£€æŸ¥ etcd å…ƒæ•°æ®
docker compose exec etcd etcdctl get --prefix ""
```

---

## æœ€ä½³å®è·µ

### 1. å®šæœŸå¥åº·æ£€æŸ¥

```bash
# æ·»åŠ åˆ° crontab
# æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
*/5 * * * * /path/to/health_check.sh >> /var/log/milvus_health.log 2>&1
```

### 2. å‘Šè­¦é…ç½®

```yaml
# alertmanager.yml
route:
  receiver: 'email'

receivers:
  - name: 'email'
    email_configs:
      - to: 'admin@example.com'
        from: 'alertmanager@example.com'
        smarthost: 'smtp.example.com:587'
        auth_username: 'alertmanager@example.com'
        auth_password: 'password'
```

### 3. æ—¥å¿—èšåˆ

```yaml
# docker-compose.yml
services:
  standalone:
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service=milvus"
```

### 4. è‡ªåŠ¨æ¢å¤

```yaml
# docker-compose.yml
services:
  standalone:
    restart: always  # è‡ªåŠ¨é‡å¯
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ä¸‰å±‚å¥åº·æ£€æŸ¥**: å®¹å™¨å±‚ã€æœåŠ¡å±‚ã€æ•°æ®å±‚
2. **Docker Healthcheck**: è‡ªåŠ¨ç›‘æ§å®¹å™¨çŠ¶æ€
3. **HTTP Healthz**: å¿«é€ŸéªŒè¯æœåŠ¡å¯ç”¨æ€§
4. **gRPC è¿æ¥æµ‹è¯•**: éªŒè¯å®¢æˆ·ç«¯è¿æ¥
5. **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§
6. **ç›‘æ§å’Œå‘Šè­¦**: Prometheus + Grafana
7. **æ•…éšœæ’æŸ¥**: ç³»ç»ŸåŒ–è¯Šæ–­æµç¨‹
8. **è‡ªåŠ¨åŒ–è„šæœ¬**: Python + Bash å¥åº·æ£€æŸ¥

### ä¸‹ä¸€æ­¥

- é˜…è¯» **07_å®æˆ˜ä»£ç _åœºæ™¯1_Standaloneéƒ¨ç½².md** å­¦ä¹ å®Œæ•´éƒ¨ç½²æµç¨‹
- é˜…è¯» **07_å®æˆ˜ä»£ç _åœºæ™¯3_è¿æ¥ç®¡ç†.md** å­¦ä¹ è¿æ¥ç®¡ç†å®æˆ˜
- é˜…è¯» **09_åŒ–éª¨ç»µæŒ.md** æ·±å…¥ç†è§£åŸç†

---

**å‚è€ƒæ–‡çŒ®**:
- Milvus Monitoring: https://milvus.io/docs/monitor.md
- Docker Healthcheck: https://docs.docker.com/engine/reference/builder/#healthcheck
- Prometheus: https://prometheus.io/docs/introduction/overview/
