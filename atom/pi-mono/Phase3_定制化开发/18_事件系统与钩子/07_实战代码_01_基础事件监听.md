# å®æˆ˜ä»£ç  1ï¼šåŸºç¡€äº‹ä»¶ç›‘å¬

å®Œæ•´å¯è¿è¡Œçš„åŸºç¡€äº‹ä»¶ç›‘å¬ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ç›‘å¬ session_start å’Œ tool_call äº‹ä»¶ã€‚

---

## ç¤ºä¾‹æ¦‚è¿°

æœ¬ç¤ºä¾‹å±•ç¤ºï¼š
1. ç›‘å¬ session å¯åŠ¨äº‹ä»¶
2. ç›‘å¬å·¥å…·è°ƒç”¨äº‹ä»¶
3. è®°å½•æ—¥å¿—å’Œç»Ÿè®¡
4. ç®€å•çš„é€šçŸ¥ç³»ç»Ÿ

**é€‚ç”¨åœºæ™¯ï¼š**
- ç›‘æ§ Agent è¿è¡ŒçŠ¶æ€
- è®°å½•æ“ä½œæ—¥å¿—
- ç»Ÿè®¡ä½¿ç”¨æ•°æ®
- å®æ—¶é€šçŸ¥

---

## å®Œæ•´ä»£ç 

```typescript
/**
 * åŸºç¡€äº‹ä»¶ç›‘å¬æ‰©å±•
 *
 * åŠŸèƒ½ï¼š
 * 1. ç›‘å¬ session å¯åŠ¨å’Œå…³é—­
 * 2. ç›‘å¬å·¥å…·è°ƒç”¨
 * 3. ç»Ÿè®¡ä½¿ç”¨æ•°æ®
 * 4. è¾“å‡ºæ—¥å¿—
 *
 * æ–‡ä»¶ï¼šbasic-event-listener.ts
 */

import { ExtensionAPI, Session, Tool } from '@mariozechner/pi-agent-core';

// ===== 1. ç±»å‹å®šä¹‰ =====

interface SessionStats {
  id: string;
  startTime: number;
  toolCalls: number;
  tools: Map<string, number>; // å·¥å…·åç§° -> è°ƒç”¨æ¬¡æ•°
}

interface ToolCallLog {
  timestamp: number;
  toolName: string;
  args: any;
}

// ===== 2. çŠ¶æ€ç®¡ç† =====

// ä¼šè¯ç»Ÿè®¡æ•°æ®
const sessionStats = new Map<string, SessionStats>();

// å·¥å…·è°ƒç”¨æ—¥å¿—
const toolCallLogs: ToolCallLog[] = [];

// å…¨å±€ç»Ÿè®¡
const globalStats = {
  totalSessions: 0,
  totalToolCalls: 0,
  mostUsedTool: '',
  mostUsedToolCount: 0
};

// ===== 3. è¾…åŠ©å‡½æ•° =====

/**
 * æ ¼å¼åŒ–æ—¶é—´æˆ³
 */
function formatTimestamp(timestamp: number): string {
  return new Date(timestamp).toISOString();
}

/**
 * æ ¼å¼åŒ–æŒç»­æ—¶é—´
 */
function formatDuration(ms: number): string {
  if (ms < 1000) {
    return `${ms}ms`;
  } else if (ms < 60000) {
    return `${(ms / 1000).toFixed(2)}s`;
  } else {
    return `${(ms / 60000).toFixed(2)}min`;
  }
}

/**
 * è¾“å‡ºåˆ†éš”çº¿
 */
function printSeparator(title?: string) {
  if (title) {
    console.log(`\n${'='.repeat(50)}`);
    console.log(`  ${title}`);
    console.log('='.repeat(50));
  } else {
    console.log('='.repeat(50));
  }
}

/**
 * æ›´æ–°å…¨å±€ç»Ÿè®¡
 */
function updateGlobalStats() {
  // ç»Ÿè®¡æœ€å¸¸ç”¨çš„å·¥å…·
  const toolCounts = new Map<string, number>();

  sessionStats.forEach(stats => {
    stats.tools.forEach((count, toolName) => {
      toolCounts.set(toolName, (toolCounts.get(toolName) || 0) + count);
    });
  });

  let maxCount = 0;
  let maxTool = '';

  toolCounts.forEach((count, toolName) => {
    if (count > maxCount) {
      maxCount = count;
      maxTool = toolName;
    }
  });

  globalStats.mostUsedTool = maxTool;
  globalStats.mostUsedToolCount = maxCount;
}

// ===== 4. Extension ä¸»å‡½æ•° =====

export default function basicEventListener(pi: ExtensionAPI) {
  console.log('ğŸ“Š Basic Event Listener Extension loaded');

  // ===== ç›‘å¬ session_start =====
  pi.on('session_start', (session: Session) => {
    printSeparator('SESSION STARTED');

    console.log('Session ID:', session.id);
    console.log('Start Time:', formatTimestamp(Date.now()));
    console.log('Messages:', session.messages.length);

    // åˆå§‹åŒ–ä¼šè¯ç»Ÿè®¡
    sessionStats.set(session.id, {
      id: session.id,
      startTime: Date.now(),
      toolCalls: 0,
      tools: new Map()
    });

    // æ›´æ–°å…¨å±€ç»Ÿè®¡
    globalStats.totalSessions++;

    console.log('Total Sessions:', globalStats.totalSessions);
    printSeparator();
  });

  // ===== ç›‘å¬ tool_call =====
  pi.on('tool_call', (tool: Tool, args: any) => {
    console.log('\nğŸ”§ Tool Called');
    console.log('Tool:', tool.name);
    console.log('Time:', formatTimestamp(Date.now()));

    // è¾“å‡ºå·¥å…·å‚æ•°ï¼ˆç®€åŒ–ï¼‰
    if (tool.name === 'bash') {
      console.log('Command:', args.command);
    } else if (tool.name === 'read') {
      console.log('File:', args.file_path);
    } else if (tool.name === 'write') {
      console.log('File:', args.file_path);
      console.log('Content length:', args.content?.length || 0);
    } else if (tool.name === 'edit') {
      console.log('File:', args.file_path);
      console.log('Old string length:', args.old_string?.length || 0);
      console.log('New string length:', args.new_string?.length || 0);
    }

    // è®°å½•åˆ°æ—¥å¿—
    toolCallLogs.push({
      timestamp: Date.now(),
      toolName: tool.name,
      args: args
    });

    // æ›´æ–°ç»Ÿè®¡
    const currentSession = getCurrentSession();
    if (currentSession) {
      const stats = sessionStats.get(currentSession.id);
      if (stats) {
        stats.toolCalls++;
        stats.tools.set(tool.name, (stats.tools.get(tool.name) || 0) + 1);
      }
    }

    // æ›´æ–°å…¨å±€ç»Ÿè®¡
    globalStats.totalToolCalls++;

    console.log('Total Tool Calls:', globalStats.totalToolCalls);
  });

  // ===== ç›‘å¬ agent_start =====
  pi.on('agent_start', () => {
    console.log('\nğŸ¤– Agent Started');
    console.log('Time:', formatTimestamp(Date.now()));
  });

  // ===== ç›‘å¬ agent_end =====
  pi.on('agent_end', (result: any) => {
    console.log('\nâœ… Agent Ended');
    console.log('Time:', formatTimestamp(Date.now()));

    // è¾“å‡ºå½“å‰ä¼šè¯ç»Ÿè®¡
    const currentSession = getCurrentSession();
    if (currentSession) {
      const stats = sessionStats.get(currentSession.id);
      if (stats) {
        const duration = Date.now() - stats.startTime;

        console.log('\nğŸ“ˆ Session Stats:');
        console.log('Duration:', formatDuration(duration));
        console.log('Tool Calls:', stats.toolCalls);

        if (stats.tools.size > 0) {
          console.log('\nTool Usage:');
          stats.tools.forEach((count, toolName) => {
            console.log(`  ${toolName}: ${count}`);
          });
        }
      }
    }
  });

  // ===== ç›‘å¬ session_shutdown =====
  pi.on('session_shutdown', (session: Session) => {
    printSeparator('SESSION SHUTDOWN');

    console.log('Session ID:', session.id);
    console.log('End Time:', formatTimestamp(Date.now()));

    // è¾“å‡ºä¼šè¯ç»Ÿè®¡
    const stats = sessionStats.get(session.id);
    if (stats) {
      const duration = Date.now() - stats.startTime;

      console.log('\nğŸ“Š Final Session Stats:');
      console.log('Duration:', formatDuration(duration));
      console.log('Tool Calls:', stats.toolCalls);

      if (stats.tools.size > 0) {
        console.log('\nTool Usage:');
        const sortedTools = Array.from(stats.tools.entries())
          .sort((a, b) => b[1] - a[1]);

        sortedTools.forEach(([toolName, count]) => {
          console.log(`  ${toolName}: ${count}`);
        });
      }

      // æ¸…ç†ä¼šè¯æ•°æ®
      sessionStats.delete(session.id);
    }

    // æ›´æ–°å¹¶è¾“å‡ºå…¨å±€ç»Ÿè®¡
    updateGlobalStats();

    console.log('\nğŸŒ Global Stats:');
    console.log('Total Sessions:', globalStats.totalSessions);
    console.log('Total Tool Calls:', globalStats.totalToolCalls);

    if (globalStats.mostUsedTool) {
      console.log('Most Used Tool:', globalStats.mostUsedTool);
      console.log('Usage Count:', globalStats.mostUsedToolCount);
    }

    printSeparator();
  });

  // ===== è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰ä¼šè¯ =====
  function getCurrentSession(): Session | null {
    // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å®ç°
    // å®é™…åº”ç”¨ä¸­éœ€è¦ä» pi è·å–å½“å‰ä¼šè¯
    // è¿™é‡Œå‡è®¾åªæœ‰ä¸€ä¸ªæ´»è·ƒä¼šè¯
    const sessions = Array.from(sessionStats.keys());
    if (sessions.length > 0) {
      return { id: sessions[0] } as Session;
    }
    return null;
  }
}
```

---

## è¿è¡Œè¾“å‡ºç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å¯åŠ¨ piï¼Œæ‰§è¡Œå‡ ä¸ªå‘½ä»¤ï¼Œç„¶åé€€å‡º

```
ğŸ“Š Basic Event Listener Extension loaded

==================================================
  SESSION STARTED
==================================================
Session ID: session-abc123
Start Time: 2026-02-21T01:30:00.000Z
Messages: 0
Total Sessions: 1
==================================================

ğŸ¤– Agent Started
Time: 2026-02-21T01:30:01.000Z

ğŸ”§ Tool Called
Tool: read
Time: 2026-02-21T01:30:02.000Z
File: /path/to/file.ts
Total Tool Calls: 1

ğŸ”§ Tool Called
Tool: bash
Time: 2026-02-21T01:30:05.000Z
Command: npm test
Total Tool Calls: 2

ğŸ”§ Tool Called
Tool: write
Time: 2026-02-21T01:30:10.000Z
File: /path/to/output.ts
Content length: 1234
Total Tool Calls: 3

ğŸ”§ Tool Called
Tool: bash
Time: 2026-02-21T01:30:15.000Z
Command: git status
Total Tool Calls: 4

âœ… Agent Ended
Time: 2026-02-21T01:30:20.000Z

ğŸ“ˆ Session Stats:
Duration: 20.00s
Tool Calls: 4

Tool Usage:
  bash: 2
  read: 1
  write: 1

==================================================
  SESSION SHUTDOWN
==================================================
Session ID: session-abc123
End Time: 2026-02-21T01:30:25.000Z

ğŸ“Š Final Session Stats:
Duration: 25.00s
Tool Calls: 4

Tool Usage:
  bash: 2
  read: 1
  write: 1

ğŸŒ Global Stats:
Total Sessions: 1
Total Tool Calls: 4
Most Used Tool: bash
Usage Count: 2
==================================================
```

---

## ä»£ç è¯´æ˜

### 1. ç±»å‹å®šä¹‰

```typescript
interface SessionStats {
  id: string;
  startTime: number;
  toolCalls: number;
  tools: Map<string, number>;
}
```

å®šä¹‰ä¼šè¯ç»Ÿè®¡æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬ï¼š
- ä¼šè¯ ID
- å¼€å§‹æ—¶é—´
- å·¥å…·è°ƒç”¨æ¬¡æ•°
- æ¯ä¸ªå·¥å…·çš„è°ƒç”¨æ¬¡æ•°

### 2. çŠ¶æ€ç®¡ç†

```typescript
const sessionStats = new Map<string, SessionStats>();
const toolCallLogs: ToolCallLog[] = [];
const globalStats = { ... };
```

ä½¿ç”¨ Map å’Œæ•°ç»„ç®¡ç†çŠ¶æ€ï¼š
- `sessionStats`ï¼šå­˜å‚¨æ¯ä¸ªä¼šè¯çš„ç»Ÿè®¡æ•°æ®
- `toolCallLogs`ï¼šå­˜å‚¨æ‰€æœ‰å·¥å…·è°ƒç”¨æ—¥å¿—
- `globalStats`ï¼šå­˜å‚¨å…¨å±€ç»Ÿè®¡æ•°æ®

### 3. äº‹ä»¶ç›‘å¬

**session_startï¼š**
- åˆå§‹åŒ–ä¼šè¯ç»Ÿè®¡
- è¾“å‡ºä¼šè¯ä¿¡æ¯
- æ›´æ–°å…¨å±€ç»Ÿè®¡

**tool_callï¼š**
- è®°å½•å·¥å…·è°ƒç”¨
- è¾“å‡ºå·¥å…·ä¿¡æ¯
- æ›´æ–°ç»Ÿè®¡æ•°æ®

**agent_endï¼š**
- è¾“å‡ºä¼šè¯ç»Ÿè®¡
- è®¡ç®—æŒç»­æ—¶é—´

**session_shutdownï¼š**
- è¾“å‡ºæœ€ç»ˆç»Ÿè®¡
- æ¸…ç†ä¼šè¯æ•°æ®
- æ›´æ–°å…¨å±€ç»Ÿè®¡

### 4. è¾…åŠ©å‡½æ•°

- `formatTimestamp()`ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
- `formatDuration()`ï¼šæ ¼å¼åŒ–æŒç»­æ—¶é—´
- `printSeparator()`ï¼šè¾“å‡ºåˆ†éš”çº¿
- `updateGlobalStats()`ï¼šæ›´æ–°å…¨å±€ç»Ÿè®¡

---

## ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºæ‰©å±•æ–‡ä»¶

å°†ä»£ç ä¿å­˜ä¸º `basic-event-listener.ts`ï¼Œæ”¾åœ¨ pi çš„æ‰©å±•ç›®å½•ï¼š

```bash
# é¡¹ç›®æ‰©å±•ç›®å½•
.pi/extensions/basic-event-listener.ts

# æˆ–å…¨å±€æ‰©å±•ç›®å½•
~/.pi/extensions/basic-event-listener.ts
```

### 2. é‡æ–°åŠ è½½æ‰©å±•

åœ¨ pi ä¸­æ‰§è¡Œï¼š

```
/reload
```

### 3. æŸ¥çœ‹è¾“å‡º

æ‰©å±•ä¼šè‡ªåŠ¨ç›‘å¬äº‹ä»¶å¹¶è¾“å‡ºæ—¥å¿—ã€‚

---

## æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ æ–‡ä»¶æ—¥å¿—

```typescript
import fs from 'fs';
import path from 'path';

const logFile = path.join(process.cwd(), '.pi', 'event-logs.json');

pi.on('tool_call', (tool, args) => {
  const log = {
    timestamp: Date.now(),
    tool: tool.name,
    args: args
  };

  // è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶
  fs.appendFileSync(logFile, JSON.stringify(log) + '\n');
});
```

### 2. æ·»åŠ é€šçŸ¥

```typescript
pi.on('agent_end', (result) => {
  // å‘é€æ¡Œé¢é€šçŸ¥ï¼ˆmacOSï¼‰
  exec(`osascript -e 'display notification "Agent completed" with title "Pi Agent"'`);
});
```

### 3. æ·»åŠ æ€§èƒ½ç›‘æ§

```typescript
const performanceData = new Map<string, number[]>();

pi.on('tool_call', (tool, args) => {
  const startTime = Date.now();

  pi.once('tool_result', (resultTool, result) => {
    if (resultTool.name === tool.name) {
      const duration = Date.now() - startTime;

      if (!performanceData.has(tool.name)) {
        performanceData.set(tool.name, []);
      }

      performanceData.get(tool.name)!.push(duration);
    }
  });
});

pi.on('session_shutdown', () => {
  console.log('\nâš¡ Performance Stats:');

  performanceData.forEach((durations, toolName) => {
    const avg = durations.reduce((a, b) => a + b, 0) / durations.length;
    const max = Math.max(...durations);
    const min = Math.min(...durations);

    console.log(`${toolName}:`);
    console.log(`  Avg: ${formatDuration(avg)}`);
    console.log(`  Min: ${formatDuration(min)}`);
    console.log(`  Max: ${formatDuration(max)}`);
  });
});
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ TypeScript ç±»å‹

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹å®šä¹‰
interface SessionStats {
  id: string;
  startTime: number;
  toolCalls: number;
}

// âŒ ä¸æ¨èï¼šä½¿ç”¨ any
const stats: any = { ... };
```

### 2. æ¸…ç†èµ„æº

```typescript
// âœ… æ¨èï¼šåœ¨ session_shutdown æ¸…ç†
pi.on('session_shutdown', (session) => {
  sessionStats.delete(session.id);
  toolCallLogs.length = 0;
});
```

### 3. é”™è¯¯å¤„ç†

```typescript
// âœ… æ¨èï¼šæ•è·é”™è¯¯
pi.on('tool_call', (tool, args) => {
  try {
    processToolCall(tool, args);
  } catch (error) {
    console.error('Error processing tool call:', error);
  }
});
```

### 4. æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… æ¨èï¼šé™åˆ¶æ—¥å¿—å¤§å°
const MAX_LOGS = 1000;

pi.on('tool_call', (tool, args) => {
  toolCallLogs.push({ ... });

  if (toolCallLogs.length > MAX_LOGS) {
    toolCallLogs.shift(); // ç§»é™¤æœ€æ—§çš„æ—¥å¿—
  }
});
```

---

## å‚è€ƒèµ„æ–™

**pi-mono æºç ï¼š**
- `packages/coding-agent/src/core/extensions/types.ts` - ExtensionAPI æ¥å£
- `packages/coding-agent/examples/extensions/event-bus.ts` - äº‹ä»¶æ€»çº¿ç¤ºä¾‹

**2025-2026 æœ€æ–°å®è·µï¼š**
- åˆ†å¸ƒå¼ Node.js Event Emitter (2025å¹´8æœˆ) - ç”Ÿå‘½å‘¨æœŸé’©å­æœ€ä½³å®è·µ

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-21
**ç»´æŠ¤è€…ï¼š** Claude Code
