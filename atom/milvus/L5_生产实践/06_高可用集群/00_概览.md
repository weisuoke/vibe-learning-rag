# 高可用集群 - 概览

> 通过多副本、自动故障转移和灾难恢复机制，确保 Milvus 服务在节点故障时仍能持续运行

---

## 知识点概述

**高可用集群**是生产环境部署 Milvus 的核心要求，通过冗余消除单点故障，实现 99.9% 以上的服务可用性。

**核心价值：**
- 消除单点故障，任何组件失效都有备份接管
- 提高系统可用性，从 99% 提升到 99.9% 甚至 99.99%
- 支持无中断维护，可以在不停服的情况下升级系统

---

## 学习路径

```
30字核心 → 第一性原理 → 3个核心概念 → 最小可用 → 双重类比
    ↓
反直觉点 → 实战代码（4个场景）→ 面试必问 → 化骨绵掌 → 一句话总结
```

---

## 10个维度内容

### 1. 【30字核心】
高可用集群通过多副本、自动故障转移和灾难恢复机制，确保 Milvus 服务在节点故障时仍能持续运行。

### 2. 【第一性原理】
从"通过冗余消除单点故障"的本质出发，推导出 Milvus 高可用架构的设计。

### 3. 【3个核心概念】
- **多副本机制**：在多个节点上存储相同数据的副本
- **故障转移**：主节点失效时自动切换到备用节点
- **灾难恢复**：数据中心级别灾难时快速恢复服务

### 4. 【最小可用】
- 理解 Milvus 分布式架构
- 配置多副本部署（Coordinator 3副本，Worker 2+副本）
- 配置健康检查和自动重启
- 配置持久化存储
- 验证故障转移能力

### 5. 【双重类比】
- 高可用集群 = 飞机的多引擎设计 / 负载均衡器+多服务器
- 故障转移 = 备用司机接管方向盘 / Service Worker fallback
- 多副本 = 重要文件的多份备份 / CDN 多地缓存
- 灾难恢复 = 异地备份和应急预案 / 多区域部署
- 健康检查 = 定期体检 / API 健康检查端点

### 6. 【反直觉点】
- ❌ 多副本会显著降低性能（实际：写入并行，读取性能提升）
- ❌ 故障转移是瞬间完成的（实际：需要 5-15 秒）
- ❌ 高可用集群不需要备份（实际：多副本只防硬件故障，不防逻辑错误）

### 7. 【实战代码】
4个完整场景：
- 多副本集群部署配置（Kubernetes YAML + 部署脚本）
- 故障转移测试验证（自动化测试框架）
- 灾难恢复完整流程（备份、同步、切换）
- 健康监控与自动恢复（监控系统 + 自动扩缩容）

### 8. 【面试必问】
- 如何设计一个高可用的 Milvus 集群？
- Milvus 高可用集群的故障转移时间是多少？如何优化？
- 高可用集群和备份恢复有什么区别？

### 9. 【化骨绵掌】
10个2分钟知识卡片，从基础到进阶全面覆盖高可用集群的各个方面。

### 10. 【一句话总结】
高可用集群是通过多副本冗余、自动故障检测与转移、以及完善的灾难恢复策略，实现 Milvus 服务 99.9% 以上可用性的生产级部署方案，在 RAG 系统中保障向量检索服务的稳定性和业务连续性。

---

## 关键指标

### RTO（恢复时间目标）
- **故障转移**：5-15 秒
- **灾难恢复**：1-4 小时

### RPO（恢复点目标）
- **多副本**：0（无数据丢失）
- **定期备份**：1-24 小时（取决于备份频率）

### 可用性目标
- **99.9%**：每年宕机 8.76 小时（生产级标准）
- **99.99%**：每年宕机 52 分钟（高可用标准）

---

## 架构组件

### Coordinator 组件（3 副本）
- Root Coordinator：元数据管理
- Query Coordinator：查询协调
- Data Coordinator：数据协调
- Index Coordinator：索引协调

### Worker 组件（2+ 副本）
- Proxy：客户端接入
- Query Node：查询执行
- Data Node：数据写入
- Index Node：索引构建

### 存储组件
- etcd：元数据存储（3 副本）
- MinIO/S3：对象存储
- Pulsar/Kafka：消息队列

---

## 在 RAG 系统中的应用

```
RAG 系统高可用架构：
用户查询 → Embedding 服务（多副本）
         ↓
    Milvus 集群（高可用）
    [Proxy1] [Proxy2] [Proxy3]
    [QueryNode1] [QueryNode2] [QueryNode3]
         ↓
    LLM 服务（多副本）
         ↓
    返回答案
```

**关键价值：**
- 业务连续性：即使节点故障，RAG 系统仍能正常响应
- 用户体验：用户感知不到后端的故障和恢复
- 运维灵活性：可以在业务高峰期进行维护

---

## 学习建议

1. **先理解原理**：从第一性原理开始，理解为什么需要高可用
2. **掌握核心概念**：多副本、故障转移、灾难恢复
3. **动手实践**：按照实战代码部署一个高可用集群
4. **测试验证**：执行故障转移测试，验证 RTO/RPO
5. **定期演练**：每季度执行一次灾难恢复演练

---

## 快速检查清单

部署前检查：
- [ ] Coordinator 组件至少 3 个副本
- [ ] Worker 组件至少 2 个副本
- [ ] 配置了 livenessProbe 和 readinessProbe
- [ ] 使用外部对象存储（MinIO/S3）
- [ ] 使用外部 etcd 集群（3 副本）
- [ ] 配置了定期备份（每天）
- [ ] 配置了跨数据中心同步（可选）
- [ ] 测试了故障转移能力
- [ ] 验证了数据持久化

---

## 下一步学习

完成本知识点后，建议学习：
- L6_RAG集成实战：将高可用 Milvus 集群集成到 RAG 系统
- 监控与告警：配置 Prometheus + Grafana 监控
- 性能优化：在保证高可用的前提下优化性能

---

**开始学习：** [01_30字核心](./01_30字核心.md)
