# æ ¸å¿ƒæ¦‚å¿µ 2ï¼šæ•°æ®æ’å…¥æ“ä½œ

> **Milvus 2.6 æ ¸å¿ƒç‰¹æ€§**ï¼šç»“åˆ Embedding Functionsï¼Œæ•°æ®æ’å…¥ä»"æ‰‹åŠ¨å‘é‡åŒ– + æ’å…¥"ç®€åŒ–ä¸º"æ’å…¥åŸå§‹æ–‡æœ¬"ï¼ŒMilvus è‡ªåŠ¨å®Œæˆå‘é‡åŒ–å’Œç´¢å¼•ã€‚

---

## ä»€ä¹ˆæ˜¯æ•°æ®æ’å…¥æ“ä½œï¼Ÿ

**æ•°æ®æ’å…¥æ“ä½œ**æ˜¯å°†æ•°æ®å†™å…¥ Milvus Collection çš„è¿‡ç¨‹ã€‚åœ¨ Milvus 2.6 ä¸­ï¼Œæ•°æ®æ’å…¥æ“ä½œåŒ…æ‹¬ä¸‰ç§ä¸»è¦æ–¹å¼ï¼š

1. **Insertï¼ˆæ’å…¥ï¼‰**ï¼šæ’å…¥æ–°æ•°æ®
2. **Upsertï¼ˆæ’å…¥æˆ–æ›´æ–°ï¼‰**ï¼šå¦‚æœä¸»é”®å­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦åˆ™æ’å…¥
3. **Bulk Insertï¼ˆæ‰¹é‡æ’å…¥ï¼‰**ï¼šé«˜æ•ˆæ’å…¥å¤§é‡æ•°æ®

### Milvus 2.6 çš„æ ¸å¿ƒå˜åŒ–

åœ¨ Milvus 2.6 ä¹‹å‰ï¼Œæ•°æ®æ’å…¥éœ€è¦æ‰‹åŠ¨å‘é‡åŒ–ï¼š

```
ç”¨æˆ·ä»£ç  â†’ è°ƒç”¨ Embedding API â†’ è·å–å‘é‡ â†’ æ’å…¥ Milvus
```

æœ‰äº† **Embedding Functions** åï¼Œæµç¨‹å˜æˆï¼š

```
ç”¨æˆ·ä»£ç  â†’ æ’å…¥åŸå§‹æ–‡æœ¬åˆ° Milvus â†’ Milvus è‡ªåŠ¨å‘é‡åŒ–å¹¶å­˜å‚¨
```

---

## Insert æ“ä½œï¼šæ’å…¥æ–°æ•°æ®

### 2026 æ–¹å¼ï¼šä½¿ç”¨ Embedding Functions

**å®Œæ•´ç¤ºä¾‹ï¼š**

```python
from pymilvus import MilvusClient, DataType, Function, FunctionType

# 1. è¿æ¥ Milvus
client = MilvusClient(uri="http://localhost:19530")

# 2. åˆ›å»º Schemaï¼ˆé…ç½® Embedding Functionï¼‰
schema = client.create_schema()
schema.add_field("id", DataType.INT64, is_primary=True, auto_id=False)
schema.add_field("document", DataType.VARCHAR, max_length=9000)
schema.add_field("dense", DataType.FLOAT_VECTOR, dim=1536)

# å®šä¹‰ Embedding Function
text_embedding_function = Function(
    name="openai_embedding",
    function_type=FunctionType.TEXTEMBEDDING,
    input_field_names=["document"],
    output_field_names=["dense"],
    params={
        "provider": "openai",
        "model_name": "text-embedding-3-small",
    }
)
schema.add_function(text_embedding_function)

# 3. é…ç½®ç´¢å¼•å¹¶åˆ›å»º Collection
index_params = client.prepare_index_params()
index_params.add_index(field_name="dense", index_type="AUTOINDEX", metric_type="COSINE")
client.create_collection(collection_name='my_collection', schema=schema, index_params=index_params)

# 4. æ’å…¥æ•°æ®ï¼ˆç›´æ¥æ’å…¥åŸå§‹æ–‡æœ¬ï¼Œæ— éœ€æ‰‹åŠ¨å‘é‡åŒ–ï¼‰
data = [
    {'id': 1, 'document': 'Artificial Intelligence is transforming industries.'},
    {'id': 2, 'document': 'Machine Learning enables computers to learn from data.'},
    {'id': 3, 'document': 'Deep Learning uses neural networks for complex tasks.'},
]

result = client.insert(collection_name='my_collection', data=data)
print(f"âœ… æ’å…¥æˆåŠŸï¼š{result['insert_count']} æ¡æ•°æ®")

# è¾“å‡ºï¼šâœ… æ’å…¥æˆåŠŸï¼š3 æ¡æ•°æ®
```

**å…³é”®ç‚¹ï¼š**
- **æ— éœ€æ‰‹åŠ¨å‘é‡åŒ–**ï¼šç›´æ¥æ’å…¥åŸå§‹æ–‡æœ¬ï¼ŒMilvus è‡ªåŠ¨è°ƒç”¨ OpenAI API ç”Ÿæˆå‘é‡
- **è‡ªåŠ¨ç´¢å¼•**ï¼šæ’å…¥åè‡ªåŠ¨å»ºç«‹ç´¢å¼•ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
- **ç®€åŒ–ä»£ç **ï¼šä» 80+ è¡Œå‡å°‘åˆ° 50 è¡Œ

---

## Upsert æ“ä½œï¼šæ’å…¥æˆ–æ›´æ–°

### ä»€ä¹ˆæ˜¯ Upsertï¼Ÿ

**Upsert** = **Up**date + In**sert**

- å¦‚æœä¸»é”®å­˜åœ¨ï¼Œåˆ™**æ›´æ–°**è¯¥å®ä½“
- å¦‚æœä¸»é”®ä¸å­˜åœ¨ï¼Œåˆ™**æ’å…¥**æ–°å®ä½“

### Upsert çš„ä¸¤ç§æ¨¡å¼

#### 1. Override æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

**Override æ¨¡å¼**ä¼šå®Œå…¨æ›¿æ¢ç°æœ‰å®ä½“ï¼š

```python
# å‡è®¾ Collection ä¸­å·²æœ‰ id=1 çš„æ•°æ®ï¼š
# {'id': 1, 'document': 'Old text', 'metadata': {'source': 'old'}}

# Upsert æ–°æ•°æ®
data = [
    {'id': 1, 'document': 'New text', 'metadata': {'source': 'new'}}
]

result = client.upsert(collection_name='my_collection', data=data)
print(f"âœ… Upsert æˆåŠŸï¼š{result['upsert_count']} æ¡æ•°æ®")

# ç»“æœï¼šid=1 çš„æ•°æ®è¢«å®Œå…¨æ›¿æ¢ä¸ºæ–°æ•°æ®
# {'id': 1, 'document': 'New text', 'metadata': {'source': 'new'}}
```

**å·¥ä½œåŸç†ï¼š**
1. Milvus æ£€æŸ¥ä¸»é”®æ˜¯å¦å­˜åœ¨
2. å¦‚æœå­˜åœ¨ï¼Œåˆ é™¤æ—§å®ä½“
3. æ’å…¥æ–°å®ä½“ï¼ˆåŒ…å«æ–°çš„å‘é‡ï¼‰

#### 2. Merge æ¨¡å¼ï¼ˆMilvus 2.6.2+ï¼‰

**Merge æ¨¡å¼**åªæ›´æ–°æŒ‡å®šå­—æ®µï¼Œä¿ç•™å…¶ä»–å­—æ®µï¼š

```python
# å‡è®¾ Collection ä¸­å·²æœ‰ id=1 çš„æ•°æ®ï¼š
# {'id': 1, 'document': 'Old text', 'metadata': {'source': 'old', 'tags': ['ai']}}

# Upsert æ–°æ•°æ®ï¼ˆåªæ›´æ–° document å­—æ®µï¼‰
data = [
    {'id': 1, 'document': 'New text'}
]

result = client.upsert(
    collection_name='my_collection',
    data=data,
    partial_update=True  # å¯ç”¨ Merge æ¨¡å¼
)

# ç»“æœï¼šåªæ›´æ–° document å­—æ®µï¼Œmetadata ä¿æŒä¸å˜
# {'id': 1, 'document': 'New text', 'metadata': {'source': 'old', 'tags': ['ai']}}
```

**å·¥ä½œåŸç†ï¼š**
1. Milvus æŸ¥è¯¢ç°æœ‰å®ä½“
2. åˆå¹¶æ–°æ—§æ•°æ®ï¼ˆåªæ›´æ–°æŒ‡å®šå­—æ®µï¼‰
3. æ’å…¥åˆå¹¶åçš„æ•°æ®
4. åˆ é™¤æ—§å®ä½“

### Upsert ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æ¨¡å¼ | è¯´æ˜ |
|------|------|------|
| **æ–‡æ¡£æ›´æ–°** | Override | æ–‡æ¡£å†…å®¹å®Œå…¨æ”¹å˜ï¼Œéœ€è¦é‡æ–°å‘é‡åŒ– |
| **å…ƒæ•°æ®æ›´æ–°** | Merge | åªæ›´æ–°å…ƒæ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€åˆ†ç±»ï¼‰ï¼Œä¸é‡æ–°å‘é‡åŒ– |
| **å¢é‡ç´¢å¼•** | Override | å®šæœŸæ›´æ–°æ–‡æ¡£ï¼Œä¿æŒç´¢å¼•æœ€æ–° |
| **éƒ¨åˆ†å­—æ®µæ›´æ–°** | Merge | åªæ›´æ–°ç‰¹å®šå­—æ®µï¼ŒèŠ‚çœå‘é‡åŒ–æˆæœ¬ |

---

## Bulk Insert æ“ä½œï¼šæ‰¹é‡æ’å…¥

### ä»€ä¹ˆæ˜¯ Bulk Insertï¼Ÿ

**Bulk Insert** æ˜¯é«˜æ•ˆæ’å…¥å¤§é‡æ•°æ®çš„æ–¹å¼ï¼Œé€‚ç”¨äºï¼š
- åˆå§‹åŒ–çŸ¥è¯†åº“ï¼ˆæ•°ä¸‡åˆ°æ•°ç™¾ä¸‡æ¡æ–‡æ¡£ï¼‰
- å®šæœŸæ‰¹é‡æ›´æ–°
- æ•°æ®è¿ç§»

### 2026 æ–¹å¼ï¼šä½¿ç”¨ Embedding Functions æ‰¹é‡æ’å…¥

```python
from pymilvus import MilvusClient, DataType, Function, FunctionType

# 1. å‡†å¤‡å¤§é‡æ•°æ®
documents = []
for i in range(10000):
    documents.append({
        'id': i,
        'document': f'This is document number {i} about AI and machine learning.',
        'metadata': {'source': 'batch', 'index': i}
    })

# 2. æ‰¹é‡æ’å…¥ï¼ˆMilvus è‡ªåŠ¨å‘é‡åŒ–ï¼‰
batch_size = 1000  # æ¯æ‰¹ 1000 æ¡
total_inserted = 0

for i in range(0, len(documents), batch_size):
    batch = documents[i:i + batch_size]
    result = client.insert(collection_name='my_collection', data=batch)
    total_inserted += result['insert_count']
    print(f"âœ… å·²æ’å…¥ï¼š{total_inserted}/{len(documents)} æ¡æ•°æ®")

print(f"ğŸ‰ æ‰¹é‡æ’å…¥å®Œæˆï¼šå…± {total_inserted} æ¡æ•°æ®")
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
âœ… å·²æ’å…¥ï¼š1000/10000 æ¡æ•°æ®
âœ… å·²æ’å…¥ï¼š2000/10000 æ¡æ•°æ®
...
âœ… å·²æ’å…¥ï¼š10000/10000 æ¡æ•°æ®
ğŸ‰ æ‰¹é‡æ’å…¥å®Œæˆï¼šå…± 10000 æ¡æ•°æ®
```

### æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–

#### 1. é€‰æ‹©åˆé€‚çš„ Batch Size

```python
# æ ¹æ®æ•°æ®å¤§å°é€‰æ‹© Batch Size
if avg_doc_length < 500:
    batch_size = 2000  # çŸ­æ–‡æ¡£ï¼Œå¯ä»¥æ›´å¤§
elif avg_doc_length < 2000:
    batch_size = 1000  # ä¸­ç­‰æ–‡æ¡£
else:
    batch_size = 500   # é•¿æ–‡æ¡£ï¼Œå‡å°æ‰¹æ¬¡
```

#### 2. å¹¶è¡Œæ’å…¥ï¼ˆå¤šçº¿ç¨‹ï¼‰

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def insert_batch(batch, batch_id):
    """æ’å…¥å•ä¸ªæ‰¹æ¬¡"""
    result = client.insert(collection_name='my_collection', data=batch)
    return batch_id, result['insert_count']

# å‡†å¤‡æ‰¹æ¬¡
batches = []
batch_size = 1000
for i in range(0, len(documents), batch_size):
    batches.append(documents[i:i + batch_size])

# å¹¶è¡Œæ’å…¥
total_inserted = 0
with ThreadPoolExecutor(max_workers=4) as executor:
    futures = {executor.submit(insert_batch, batch, i): i for i, batch in enumerate(batches)}

    for future in as_completed(futures):
        batch_id, count = future.result()
        total_inserted += count
        print(f"âœ… æ‰¹æ¬¡ {batch_id} å®Œæˆï¼š{count} æ¡æ•°æ®")

print(f"ğŸ‰ å¹¶è¡Œæ’å…¥å®Œæˆï¼šå…± {total_inserted} æ¡æ•°æ®")
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

| æ–¹å¼ | 10,000 æ¡æ•°æ® | 100,000 æ¡æ•°æ® |
|------|---------------|----------------|
| **å•çº¿ç¨‹** | ~2 åˆ†é’Ÿ | ~20 åˆ†é’Ÿ |
| **4 çº¿ç¨‹å¹¶è¡Œ** | ~30 ç§’ | ~5 åˆ†é’Ÿ |
| **8 çº¿ç¨‹å¹¶è¡Œ** | ~20 ç§’ | ~3 åˆ†é’Ÿ |

#### 3. é”™è¯¯å¤„ç†ä¸é‡è¯•

```python
import time

def insert_with_retry(batch, max_retries=3):
    """å¸¦é‡è¯•çš„æ’å…¥"""
    for attempt in range(max_retries):
        try:
            result = client.insert(collection_name='my_collection', data=batch)
            return result['insert_count']
        except Exception as e:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                print(f"âš ï¸ æ’å…¥å¤±è´¥ï¼Œ{wait_time} ç§’åé‡è¯•... (å°è¯• {attempt + 1}/{max_retries})")
                time.sleep(wait_time)
            else:
                print(f"âŒ æ’å…¥å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š{e}")
                raise

# ä½¿ç”¨
for i in range(0, len(documents), batch_size):
    batch = documents[i:i + batch_size]
    count = insert_with_retry(batch)
    print(f"âœ… å·²æ’å…¥ï¼š{count} æ¡æ•°æ®")
```

---

## ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”ï¼šæ‰‹åŠ¨å‘é‡åŒ– + æ’å…¥

### ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨è°ƒç”¨ Embedding API

```python
from pymilvus import MilvusClient, DataType
from openai import OpenAI
import os

# 1. è¿æ¥ Milvus
client = MilvusClient(uri="http://localhost:19530")

# 2. åˆ›å»º Schemaï¼ˆæ²¡æœ‰ Embedding Functionï¼‰
schema = client.create_schema()
schema.add_field("id", DataType.INT64, is_primary=True, auto_id=False)
schema.add_field("document", DataType.VARCHAR, max_length=9000)
schema.add_field("dense", DataType.FLOAT_VECTOR, dim=1536)

# 3. é…ç½®ç´¢å¼•å¹¶åˆ›å»º Collection
index_params = client.prepare_index_params()
index_params.add_index(field_name="dense", index_type="AUTOINDEX", metric_type="COSINE")
client.create_collection(collection_name='my_collection_traditional', schema=schema, index_params=index_params)

# 4. å‡†å¤‡æ•°æ®
documents = [
    {'id': 1, 'document': 'Artificial Intelligence is transforming industries.'},
    {'id': 2, 'document': 'Machine Learning enables computers to learn from data.'},
    {'id': 3, 'document': 'Deep Learning uses neural networks for complex tasks.'},
]

# 5. æ‰‹åŠ¨è°ƒç”¨ OpenAI API ç”Ÿæˆå‘é‡
openai_client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

texts = [doc['document'] for doc in documents]
response = openai_client.embeddings.create(
    input=texts,
    model="text-embedding-3-small"
)

embeddings = [item.embedding for item in response.data]

# 6. ç»„è£…æ•°æ®ï¼ˆæ‰‹åŠ¨æ·»åŠ å‘é‡ï¼‰
entities = []
for i, doc in enumerate(documents):
    entities.append({
        'id': doc['id'],
        'document': doc['document'],
        'dense': embeddings[i]  # æ‰‹åŠ¨æä¾›å‘é‡
    })

# 7. æ’å…¥æ•°æ®
result = client.insert(collection_name='my_collection_traditional', data=entities)
print(f"âœ… æ’å…¥æˆåŠŸï¼š{result['insert_count']} æ¡æ•°æ®")
```

### ä¼ ç»Ÿæ–¹å¼ï¼šæ‰¹é‡æ’å…¥

```python
# æ‰¹é‡æ’å…¥ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
batch_size = 1000
total_inserted = 0

for i in range(0, len(documents), batch_size):
    batch = documents[i:i + batch_size]

    # 1. æ‰‹åŠ¨ç”Ÿæˆå‘é‡
    texts = [doc['document'] for doc in batch]
    response = openai_client.embeddings.create(
        input=texts,
        model="text-embedding-3-small"
    )
    embeddings = [item.embedding for item in response.data]

    # 2. ç»„è£…æ•°æ®
    entities = []
    for j, doc in enumerate(batch):
        entities.append({
            'id': doc['id'],
            'document': doc['document'],
            'dense': embeddings[j]
        })

    # 3. æ’å…¥æ•°æ®
    result = client.insert(collection_name='my_collection_traditional', data=entities)
    total_inserted += result['insert_count']
    print(f"âœ… å·²æ’å…¥ï¼š{total_inserted}/{len(documents)} æ¡æ•°æ®")
```

---

## å¯¹æ¯”æ€»ç»“ï¼šEmbedding Functions vs ä¼ ç»Ÿæ–¹å¼

### 1. å·¥ä½œæµå¯¹æ¯”

**Embedding Functions å·¥ä½œæµï¼ˆ3 æ­¥ï¼‰ï¼š**

```
1. åˆ›å»º Collectionï¼ˆé…ç½® Embedding Functionï¼‰
   â†“
2. æ’å…¥åŸå§‹æ–‡æœ¬ï¼ˆè‡ªåŠ¨å‘é‡åŒ– + è‡ªåŠ¨ç´¢å¼•ï¼‰
   â†“
3. å®Œæˆ
```

**ä¼ ç»Ÿæ–¹å¼å·¥ä½œæµï¼ˆ5 æ­¥ï¼‰ï¼š**

```
1. åˆ›å»º Collection
   â†“
2. å‡†å¤‡æ•°æ®
   â†“
3. æ‰‹åŠ¨è°ƒç”¨ Embedding API
   â†“
4. ç»„è£…æ•°æ®ï¼ˆæ·»åŠ å‘é‡ï¼‰
   â†“
5. æ’å…¥æ•°æ®
```

### 2. ä»£ç å¤æ‚åº¦å¯¹æ¯”

| ç»´åº¦ | Embedding Functions | ä¼ ç»Ÿæ–¹å¼ |
|------|---------------------|----------|
| **ä»£ç è¡Œæ•°** | ~50 è¡Œ | ~80 è¡Œ |
| **å¤–éƒ¨ä¾èµ–** | æ— éœ€ `openai` åº“ | éœ€è¦ `openai` åº“ |
| **API è°ƒç”¨ç®¡ç†** | Milvus è‡ªåŠ¨ç®¡ç† | éœ€è¦æ‰‹åŠ¨ç®¡ç† |
| **é”™è¯¯å¤„ç†** | Milvus ç»Ÿä¸€å¤„ç† | éœ€è¦æ‰‹åŠ¨å¤„ç† |
| **æ‰¹å¤„ç†é€»è¾‘** | Milvus è‡ªåŠ¨ä¼˜åŒ– | éœ€è¦æ‰‹åŠ¨å®ç° |

### 3. æ€§èƒ½å¯¹æ¯”

| ç»´åº¦ | Embedding Functions | ä¼ ç»Ÿæ–¹å¼ |
|------|---------------------|----------|
| **ç½‘ç»œå»¶è¿Ÿ** | ä½ï¼ˆMilvus å†…éƒ¨ä¼˜åŒ–ï¼‰ | é«˜ï¼ˆå¤šæ¬¡å¤–éƒ¨ API è°ƒç”¨ï¼‰ |
| **æ‰¹é‡æ’å…¥** | è‡ªåŠ¨æ‰¹å¤„ç† | éœ€è¦æ‰‹åŠ¨æ‰¹å¤„ç† |
| **å¹¶å‘æ§åˆ¶** | Milvus è‡ªåŠ¨ç®¡ç† | éœ€è¦æ‰‹åŠ¨ç®¡ç† |
| **é”™è¯¯é‡è¯•** | å†…ç½®é‡è¯•æœºåˆ¶ | éœ€è¦æ‰‹åŠ¨å®ç° |
| **API é™æµ** | Milvus è‡ªåŠ¨å¤„ç† | éœ€è¦æ‰‹åŠ¨å¤„ç† |

### 4. Upsert æ“ä½œå¯¹æ¯”

| ç»´åº¦ | Embedding Functions | ä¼ ç»Ÿæ–¹å¼ |
|------|---------------------|----------|
| **Override æ¨¡å¼** | è‡ªåŠ¨é‡æ–°å‘é‡åŒ– | éœ€è¦æ‰‹åŠ¨é‡æ–°å‘é‡åŒ– |
| **Merge æ¨¡å¼** | æ”¯æŒï¼ˆ2.6.2+ï¼‰ | éœ€è¦æ‰‹åŠ¨å®ç° |
| **éƒ¨åˆ†æ›´æ–°** | ç®€å•ï¼ˆ`partial_update=True`ï¼‰ | å¤æ‚ï¼ˆéœ€è¦æŸ¥è¯¢ + åˆå¹¶ + æ’å…¥ï¼‰ |

### 5. æ‰¹é‡æ’å…¥å¯¹æ¯”

**10,000 æ¡æ–‡æ¡£çš„æ‰¹é‡æ’å…¥ï¼š**

| æ–¹å¼ | ä»£ç è¡Œæ•° | æ‰§è¡Œæ—¶é—´ | é”™è¯¯å¤„ç† |
|------|----------|----------|----------|
| **Embedding Functionsï¼ˆå•çº¿ç¨‹ï¼‰** | ~30 è¡Œ | ~2 åˆ†é’Ÿ | è‡ªåŠ¨ |
| **Embedding Functionsï¼ˆå¹¶è¡Œï¼‰** | ~50 è¡Œ | ~30 ç§’ | è‡ªåŠ¨ |
| **ä¼ ç»Ÿæ–¹å¼ï¼ˆå•çº¿ç¨‹ï¼‰** | ~60 è¡Œ | ~2.5 åˆ†é’Ÿ | æ‰‹åŠ¨ |
| **ä¼ ç»Ÿæ–¹å¼ï¼ˆå¹¶è¡Œï¼‰** | ~100 è¡Œ | ~40 ç§’ | æ‰‹åŠ¨ |

---

## ä½•æ—¶ä½¿ç”¨å“ªç§æ’å…¥æ–¹å¼ï¼Ÿ

### Insert vs Upsert vs Bulk Insert

| åœºæ™¯ | æ¨èæ–¹å¼ | åŸå›  |
|------|----------|------|
| **åˆå§‹åŒ–çŸ¥è¯†åº“** | Bulk Insert | é«˜æ•ˆæ’å…¥å¤§é‡æ•°æ® |
| **å®æ—¶æ·»åŠ æ–‡æ¡£** | Insert | ç®€å•ç›´æ¥ï¼Œé€‚åˆå°æ‰¹é‡ |
| **æ–‡æ¡£æ›´æ–°** | Upsert (Override) | è‡ªåŠ¨å¤„ç†æ’å…¥/æ›´æ–°é€»è¾‘ |
| **å…ƒæ•°æ®æ›´æ–°** | Upsert (Merge) | åªæ›´æ–°ç‰¹å®šå­—æ®µï¼ŒèŠ‚çœæˆæœ¬ |
| **å®šæœŸåŒæ­¥** | Bulk Insert + Upsert | æ‰¹é‡æ’å…¥æ–°æ•°æ®ï¼ŒUpsert æ›´æ–°ç°æœ‰æ•°æ® |

### Override vs Merge æ¨¡å¼

| åœºæ™¯ | æ¨èæ¨¡å¼ | åŸå›  |
|------|----------|------|
| **æ–‡æ¡£å†…å®¹æ”¹å˜** | Override | éœ€è¦é‡æ–°å‘é‡åŒ– |
| **å…ƒæ•°æ®æ›´æ–°** | Merge | ä¸éœ€è¦é‡æ–°å‘é‡åŒ–ï¼ŒèŠ‚çœæˆæœ¬ |
| **æ ‡ç­¾/åˆ†ç±»æ›´æ–°** | Merge | åªæ›´æ–°æ ‡ç­¾å­—æ®µ |
| **å®Œå…¨æ›¿æ¢** | Override | ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ |

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„ Batch Size

```python
# æ ¹æ®æ–‡æ¡£å¤§å°å’Œç½‘ç»œæƒ…å†µé€‰æ‹©
if avg_doc_length < 500:
    batch_size = 2000  # çŸ­æ–‡æ¡£
elif avg_doc_length < 2000:
    batch_size = 1000  # ä¸­ç­‰æ–‡æ¡£
else:
    batch_size = 500   # é•¿æ–‡æ¡£
```

### 2. ä½¿ç”¨ Upsert å¤„ç†é‡å¤æ•°æ®

```python
# ä½¿ç”¨ Upsert é¿å…é‡å¤æ’å…¥
data = [
    {'id': 1, 'document': 'New or updated document'}
]

# å¦‚æœ id=1 å­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦åˆ™æ’å…¥
result = client.upsert(collection_name='my_collection', data=data)
```

### 3. æ‰¹é‡æ’å…¥æ—¶ç›‘æ§è¿›åº¦

```python
from tqdm import tqdm

for i in tqdm(range(0, len(documents), batch_size), desc="æ’å…¥è¿›åº¦"):
    batch = documents[i:i + batch_size]
    result = client.insert(collection_name='my_collection', data=batch)
```

### 4. é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•

```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

try:
    result = client.insert(collection_name='my_collection', data=data)
    logger.info(f"âœ… æ’å…¥æˆåŠŸï¼š{result['insert_count']} æ¡æ•°æ®")
except Exception as e:
    logger.error(f"âŒ æ’å…¥å¤±è´¥ï¼š{e}")
    raise
```

### 5. ä½¿ç”¨ Merge æ¨¡å¼èŠ‚çœæˆæœ¬

```python
# åªæ›´æ–°å…ƒæ•°æ®ï¼Œä¸é‡æ–°å‘é‡åŒ–
data = [
    {'id': 1, 'metadata': {'tags': ['updated', 'ai']}}
]

result = client.upsert(
    collection_name='my_collection',
    data=data,
    partial_update=True  # åªæ›´æ–° metadata å­—æ®µ
)
```

---

## å¸¸è§é—®é¢˜

### 1. Insert å’Œ Upsert çš„æ€§èƒ½å·®å¼‚ï¼Ÿ

**Upsert æ¯” Insert æ…¢**ï¼Œå› ä¸º Upsert éœ€è¦ï¼š
1. æŸ¥è¯¢ä¸»é”®æ˜¯å¦å­˜åœ¨
2. å¦‚æœå­˜åœ¨ï¼Œåˆ é™¤æ—§å®ä½“
3. æ’å…¥æ–°å®ä½“

**å»ºè®®ï¼š**
- å¦‚æœç¡®å®šæ•°æ®ä¸å­˜åœ¨ï¼Œä½¿ç”¨ **Insert**
- å¦‚æœä¸ç¡®å®šæˆ–éœ€è¦æ›´æ–°ï¼Œä½¿ç”¨ **Upsert**

### 2. æ‰¹é‡æ’å…¥æ—¶å¦‚ä½•å¤„ç†å¤±è´¥ï¼Ÿ

ä½¿ç”¨**åˆ†æ‰¹ + é‡è¯•**ç­–ç•¥ï¼š

```python
failed_batches = []

for i in range(0, len(documents), batch_size):
    batch = documents[i:i + batch_size]
    try:
        result = client.insert(collection_name='my_collection', data=batch)
    except Exception as e:
        logger.error(f"æ‰¹æ¬¡ {i} å¤±è´¥ï¼š{e}")
        failed_batches.append((i, batch))

# é‡è¯•å¤±è´¥çš„æ‰¹æ¬¡
for i, batch in failed_batches:
    try:
        result = client.insert(collection_name='my_collection', data=batch)
        logger.info(f"âœ… æ‰¹æ¬¡ {i} é‡è¯•æˆåŠŸ")
    except Exception as e:
        logger.error(f"âŒ æ‰¹æ¬¡ {i} é‡è¯•å¤±è´¥ï¼š{e}")
```

### 3. Embedding Functions ä¼šå½±å“æ’å…¥æ€§èƒ½å—ï¼Ÿ

**ä¸ä¼šæ˜¾è‘—å½±å“ã€‚** Milvus å†…éƒ¨è¿›è¡Œäº†ä¼˜åŒ–ï¼š
- **æ‰¹å¤„ç†**ï¼šè‡ªåŠ¨å°†å¤šä¸ªè¯·æ±‚åˆå¹¶
- **ç¼“å­˜**ï¼šç›¸åŒæ–‡æœ¬çš„å‘é‡ä¼šè¢«ç¼“å­˜
- **å¹¶å‘æ§åˆ¶**ï¼šè‡ªåŠ¨ç®¡ç†å¹¶å‘è¯·æ±‚

### 4. å¦‚ä½•å¤„ç† Nullable å­—æ®µçš„ Upsertï¼Ÿ

```python
# å¦‚æœå­—æ®µå¯ä»¥ä¸º null
schema.add_field("optional_field", DataType.VARCHAR, max_length=1000, nullable=True)

# Upsert æ—¶å¯ä»¥çœç•¥ nullable å­—æ®µ
data = [
    {'id': 1, 'document': 'New text'}  # optional_field ä¿æŒåŸå€¼
]

result = client.upsert(
    collection_name='my_collection',
    data=data,
    partial_update=True
)
```

---

## æ€»ç»“

**æ•°æ®æ’å…¥æ“ä½œ**æ˜¯ Milvus çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒMilvus 2.6 é€šè¿‡ **Embedding Functions** å¤§å¹…ç®€åŒ–äº†æ’å…¥æµç¨‹ï¼š

1. **Insert**ï¼šæ’å…¥æ–°æ•°æ®ï¼Œé€‚åˆå®æ—¶æ·»åŠ 
2. **Upsert**ï¼šæ’å…¥æˆ–æ›´æ–°ï¼Œé€‚åˆå¤„ç†é‡å¤æ•°æ®
3. **Bulk Insert**ï¼šæ‰¹é‡æ’å…¥ï¼Œé€‚åˆåˆå§‹åŒ–çŸ¥è¯†åº“

**æ ¸å¿ƒåŸåˆ™ï¼š**
- **2026 å¹´ä¼˜å…ˆä½¿ç”¨ Embedding Functions**
- **é€‰æ‹©åˆé€‚çš„æ’å…¥æ–¹å¼**ï¼ˆInsert/Upsert/Bulk Insertï¼‰
- **é€‰æ‹©åˆé€‚çš„ Upsert æ¨¡å¼**ï¼ˆOverride/Mergeï¼‰
- **æ‰¹é‡æ’å…¥æ—¶æ³¨æ„æ€§èƒ½ä¼˜åŒ–**ï¼ˆBatch Sizeã€å¹¶è¡Œã€é”™è¯¯å¤„ç†ï¼‰

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Embedding Functions è¿›è¡Œç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆSearchã€Queryã€Hybrid Searchï¼‰ã€‚
