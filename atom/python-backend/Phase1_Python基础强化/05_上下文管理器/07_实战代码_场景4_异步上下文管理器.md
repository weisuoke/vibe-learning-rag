# 实战代码 - 场景4：异步上下文管理器

## 概述

演示如何使用 `async with` 和 `@asynccontextmanager` 管理异步资源。

---

## 场景4.1：异步数据库连接

```python
"""
异步数据库连接
演示：使用 async with 管理异步数据库连接
"""

import asyncio
from contextlib import asynccontextmanager
import asyncpg

@asynccontextmanager
async def get_async_db():
    """异步数据库连接上下文管理器"""
    print("连接数据库...")
    conn = await asyncpg.connect("postgresql://user:pass@localhost/db")

    try:
        yield conn
    finally:
        print("关闭数据库连接")
        await conn.close()

# 使用
async def fetch_users():
    async with get_async_db() as conn:
        users = await conn.fetch("SELECT * FROM users")
        return users

# 运行
asyncio.run(fetch_users())
```

---

## 场景4.2：异步文件操作

```python
"""
异步文件操作
演示：使用 aiofiles 进行异步文件读写
"""

import aiofiles
from contextlib import asynccontextmanager

@asynccontextmanager
async def async_file(filename, mode="r"):
    """异步文件上下文管理器"""
    print(f"打开文件: {filename}")
    f = await aiofiles.open(filename, mode)

    try:
        yield f
    finally:
        print(f"关闭文件: {filename}")
        await f.close()

# 使用
async def process_file():
    async with async_file("data.txt", "r") as f:
        content = await f.read()
        print(f"文件内容: {content}")

asyncio.run(process_file())
```

---

## 场景4.3：FastAPI 生命周期管理

```python
"""
FastAPI 生命周期管理
演示：使用异步上下文管理器管理应用生命周期
"""

from fastapi import FastAPI
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    """FastAPI 生命周期管理"""
    # 启动时
    print("应用启动...")
    await init_database()
    await init_cache()
    await load_models()

    yield  # 应用运行期间

    # 关闭时
    print("应用关闭...")
    await close_database()
    await close_cache()
    await unload_models()

app = FastAPI(lifespan=lifespan)

@app.get("/")
async def root():
    return {"message": "Hello World"}
```

---

## 场景4.4：异步资源池

```python
"""
异步资源池
演示：管理异步资源池
"""

@asynccontextmanager
async def async_resource_pool(size=10):
    """异步资源池上下文管理器"""
    pool = []

    # 创建资源池
    print(f"创建资源池（大小: {size}）")
    for i in range(size):
        resource = await create_async_resource(i)
        pool.append(resource)

    try:
        yield pool
    finally:
        # 清理资源池
        print("清理资源池")
        for resource in pool:
            await release_async_resource(resource)

# 使用
async def process_with_pool():
    async with async_resource_pool(5) as pool:
        tasks = [process_item(item, pool) for item in items]
        results = await asyncio.gather(*tasks)
        return results
```

---

## 在 AI Agent 后端中的应用

```python
"""
AI Agent 异步推理
演示：异步 AI 模型推理上下文
"""

@asynccontextmanager
async def async_ai_model(model_name):
    """异步 AI 模型上下文管理器"""
    print(f"加载模型: {model_name}")
    model = await load_model_async(model_name)

    try:
        yield model
    finally:
        print(f"卸载模型: {model_name}")
        await unload_model_async(model)

@app.post("/async-predict")
async def async_predict(text: str):
    async with async_ai_model("gpt-3.5") as model:
        result = await model.generate_async(text)
        return {"result": result}
```

---

**版本：** v1.0
**最后更新：** 2026-02-11
