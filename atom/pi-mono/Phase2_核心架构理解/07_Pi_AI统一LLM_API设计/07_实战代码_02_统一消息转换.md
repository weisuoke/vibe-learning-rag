# 实战代码2：统一消息转换

> 实现不同 Provider 之间的消息格式转换

---

## 目标

实现消息格式转换器，支持 OpenAI、Anthropic、Google 三种格式的双向转换。

---

## 完整代码

```typescript
/**
 * 统一消息转换实现
 * 演示：如何在不同 Provider 格式之间转换
 */

// ===== 1. 统一格式定义 =====

interface Message {
  role: 'user' | 'assistant';
  content: string | ContentBlock[];
}

type ContentBlock =
  | { type: 'text'; text: string }
  | { type: 'image'; source: { type: 'url'; url: string } };

// ===== 2. 消息转换器 =====

class MessageConverter {
  /**
   * 转换为 OpenAI 格式
   */
  toOpenAI(message: Message): any {
    if (typeof message.content === 'string') {
      return {
        role: message.role,
        content: message.content
      };
    }

    return {
      role: message.role,
      content: message.content.map(block => {
        if (block.type === 'text') {
          return { type: 'text', text: block.text };
        } else if (block.type === 'image') {
          return {
            type: 'image_url',
            image_url: { url: block.source.url }
          };
        }
      })
    };
  }

  /**
   * 从 OpenAI 格式转换
   */
  fromOpenAI(openaiMessage: any): Message {
    if (typeof openaiMessage.content === 'string') {
      return {
        role: openaiMessage.role,
        content: openaiMessage.content
      };
    }

    return {
      role: openaiMessage.role,
      content: openaiMessage.content.map((block: any) => {
        if (block.type === 'text') {
          return { type: 'text', text: block.text };
        } else if (block.type === 'image_url') {
          return {
            type: 'image',
            source: { type: 'url', url: block.image_url.url }
          };
        }
      })
    };
  }

  /**
   * 转换为 Anthropic 格式
   */
  toAnthropic(message: Message): any {
    const content = typeof message.content === 'string'
      ? [{ type: 'text', text: message.content }]
      : message.content.map(block => {
          if (block.type === 'text') {
            return { type: 'text', text: block.text };
          } else if (block.type === 'image') {
            return {
              type: 'image',
              source: {
                type: 'url',
                url: block.source.url
              }
            };
          }
        });

    return {
      role: message.role,
      content
    };
  }

  /**
   * 从 Anthropic 格式转换
   */
  fromAnthropic(anthropicMessage: any): Message {
    return {
      role: anthropicMessage.role,
      content: anthropicMessage.content.map((block: any) => {
        if (block.type === 'text') {
          return { type: 'text', text: block.text };
        } else if (block.type === 'image') {
          return {
            type: 'image',
            source: { type: 'url', url: block.source.url }
          };
        }
      })
    };
  }
}

// ===== 3. 使用示例 =====

async function main() {
  const converter = new MessageConverter();

  // 统一格式消息
  const piMessage: Message = {
    role: 'user',
    content: [
      { type: 'text', text: 'What is in this image?' },
      { type: 'image', source: { type: 'url', url: 'https://example.com/image.jpg' } }
    ]
  };

  console.log('=== Pi AI 格式 ===');
  console.log(JSON.stringify(piMessage, null, 2));

  // 转换为 OpenAI 格式
  const openaiMessage = converter.toOpenAI(piMessage);
  console.log('\n=== OpenAI 格式 ===');
  console.log(JSON.stringify(openaiMessage, null, 2));

  // 转换为 Anthropic 格式
  const anthropicMessage = converter.toAnthropic(piMessage);
  console.log('\n=== Anthropic 格式 ===');
  console.log(JSON.stringify(anthropicMessage, null, 2));

  // 往返转换测试
  const backToPi = converter.fromOpenAI(openaiMessage);
  console.log('\n=== 往返转换测试 ===');
  console.log('原始:', JSON.stringify(piMessage.content));
  console.log('转换后:', JSON.stringify(backToPi.content));
  console.log('相同:', JSON.stringify(piMessage) === JSON.stringify(backToPi));
}

main().catch(console.error);
```

---

## 运行输出

```json
=== Pi AI 格式 ===
{
  "role": "user",
  "content": [
    { "type": "text", "text": "What is in this image?" },
    { "type": "image", "source": { "type": "url", "url": "https://example.com/image.jpg" } }
  ]
}

=== OpenAI 格式 ===
{
  "role": "user",
  "content": [
    { "type": "text", "text": "What is in this image?" },
    { "type": "image_url", "image_url": { "url": "https://example.com/image.jpg" } }
  ]
}

=== Anthropic 格式 ===
{
  "role": "user",
  "content": [
    { "type": "text", "text": "What is in this image?" },
    { "type": "image", "source": { "type": "url", "url": "https://example.com/image.jpg" } }
  ]
}

=== 往返转换测试 ===
原始: [{"type":"text","text":"What is in this image?"},{"type":"image","source":{"type":"url","url":"https://example.com/image.jpg"}}]
转换后: [{"type":"text","text":"What is in this image?"},{"type":"image","source":{"type":"url","url":"https://example.com/image.jpg"}}]
相同: true
```

---

## 关键点

### 1. 双向转换
确保转换是无损的，往返转换后数据不变。

### 2. 类型安全
使用 TypeScript 类型确保转换正确。

### 3. 格式差异
- OpenAI: `image_url` 字段
- Anthropic: `image` 字段 + `source` 嵌套
- Pi AI: 统一的 `image` + `source`

---

**版本：** v1.0
**最后更新：** 2026-02-19
