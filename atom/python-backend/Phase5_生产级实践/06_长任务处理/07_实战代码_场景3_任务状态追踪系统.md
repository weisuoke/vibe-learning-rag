# 实战代码 - 场景3：任务状态追踪系统

> 完整的任务状态管理系统，包含CRUD操作和查询接口

---

## 场景描述

**需求**：构建完整的任务状态追踪系统，支持任务创建、查询、更新、删除

**技术栈**：FastAPI + SQLAlchemy + PostgreSQL + Pydantic

---

## 完整代码实现

### 1. 任务模型（完整版）

```python
# app/models/task.py
from sqlalchemy import Column, Integer, String, Float, DateTime, Text, Enum, JSON
from sqlalchemy.sql import func
from app.core.database import Base
import enum

class TaskStatus(str, enum.Enum):
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELED = "canceled"

class Task(Base):
    __tablename__ = "tasks"

    id = Column(Integer, primary_key=True, index=True)
    task_id = Column(String, unique=True, index=True, nullable=False)
    task_type = Column(String, index=True, nullable=False)
    status = Column(Enum(TaskStatus), default=TaskStatus.PENDING, index=True)
    progress = Column(Float, default=0.0)
    params = Column(JSON, nullable=True)
    result = Column(JSON, nullable=True)
    error = Column(Text, nullable=True)
    retry_count = Column(Integer, default=0)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())
    started_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
```

---

### 2. Pydantic模型

```python
# app/schemas/task.py
from pydantic import BaseModel
from typing import Optional, Any
from datetime import datetime

class TaskCreate(BaseModel):
    task_type: str
    params: Optional[dict] = None

class TaskUpdate(BaseModel):
    status: Optional[str] = None
    progress: Optional[float] = None
    result: Optional[dict] = None
    error: Optional[str] = None

class TaskResponse(BaseModel):
    id: int
    task_id: str
    task_type: str
    status: str
    progress: float
    params: Optional[dict]
    result: Optional[dict]
    error: Optional[str]
    retry_count: int
    created_at: datetime
    updated_at: Optional[datetime]
    started_at: Optional[datetime]
    completed_at: Optional[datetime]

    class Config:
        from_attributes = True
```

---

### 3. 任务服务层

```python
# app/services/task_service.py
from sqlalchemy.orm import Session
from app.models.task import Task, TaskStatus
from app.schemas.task import TaskCreate, TaskUpdate
from typing import List, Optional
from datetime import datetime, timedelta

class TaskService:
    @staticmethod
    def create_task(db: Session, task_data: TaskCreate, task_id: str) -> Task:
        """创建任务"""
        task = Task(
            task_id=task_id,
            task_type=task_data.task_type,
            params=task_data.params,
            status=TaskStatus.PENDING
        )
        db.add(task)
        db.commit()
        db.refresh(task)
        return task

    @staticmethod
    def get_task(db: Session, task_id: str) -> Optional[Task]:
        """查询单个任务"""
        return db.query(Task).filter(Task.task_id == task_id).first()

    @staticmethod
    def get_tasks(
        db: Session,
        status: Optional[TaskStatus] = None,
        task_type: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> List[Task]:
        """查询任务列表"""
        query = db.query(Task)

        if status:
            query = query.filter(Task.status == status)

        if task_type:
            query = query.filter(Task.task_type == task_type)

        return query.order_by(Task.created_at.desc()).offset(skip).limit(limit).all()

    @staticmethod
    def update_task(db: Session, task_id: str, task_data: TaskUpdate) -> Optional[Task]:
        """更新任务"""
        task = db.query(Task).filter(Task.task_id == task_id).first()

        if not task:
            return None

        # 更新字段
        if task_data.status:
            task.status = TaskStatus(task_data.status)

            # 更新时间戳
            if task_data.status == "running" and not task.started_at:
                task.started_at = datetime.utcnow()

            if task_data.status in ["completed", "failed", "canceled"]:
                task.completed_at = datetime.utcnow()

        if task_data.progress is not None:
            task.progress = task_data.progress

        if task_data.result:
            task.result = task_data.result

        if task_data.error:
            task.error = task_data.error

        task.updated_at = datetime.utcnow()

        db.commit()
        db.refresh(task)
        return task

    @staticmethod
    def delete_task(db: Session, task_id: str) -> bool:
        """删除任务"""
        task = db.query(Task).filter(Task.task_id == task_id).first()

        if not task:
            return False

        db.delete(task)
        db.commit()
        return True

    @staticmethod
    def get_task_stats(db: Session) -> dict:
        """获取任务统计"""
        total = db.query(Task).count()
        pending = db.query(Task).filter(Task.status == TaskStatus.PENDING).count()
        running = db.query(Task).filter(Task.status == TaskStatus.RUNNING).count()
        completed = db.query(Task).filter(Task.status == TaskStatus.COMPLETED).count()
        failed = db.query(Task).filter(Task.status == TaskStatus.FAILED).count()

        return {
            "total": total,
            "pending": pending,
            "running": running,
            "completed": completed,
            "failed": failed
        }

    @staticmethod
    def cleanup_old_tasks(db: Session, days: int = 30) -> int:
        """清理旧任务"""
        cutoff_date = datetime.utcnow() - timedelta(days=days)

        deleted = db.query(Task).filter(
            Task.status.in_([TaskStatus.COMPLETED, TaskStatus.FAILED]),
            Task.completed_at < cutoff_date
        ).delete()

        db.commit()
        return deleted
```

---

### 4. FastAPI路由

```python
# app/api/tasks.py
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.database import get_db
from app.services.task_service import TaskService
from app.schemas.task import TaskCreate, TaskUpdate, TaskResponse
from typing import List, Optional

router = APIRouter(prefix="/tasks", tags=["tasks"])

@router.post("/", response_model=TaskResponse)
async def create_task(
    task_data: TaskCreate,
    db: Session = Depends(get_db)
):
    """创建任务"""
    import uuid
    task_id = str(uuid.uuid4())

    task = TaskService.create_task(db, task_data, task_id)
    return task

@router.get("/{task_id}", response_model=TaskResponse)
async def get_task(
    task_id: str,
    db: Session = Depends(get_db)
):
    """查询任务"""
    task = TaskService.get_task(db, task_id)

    if not task:
        raise HTTPException(status_code=404, detail="Task not found")

    return task

@router.get("/", response_model=List[TaskResponse])
async def list_tasks(
    status: Optional[str] = None,
    task_type: Optional[str] = None,
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    """查询任务列表"""
    tasks = TaskService.get_tasks(
        db,
        status=status,
        task_type=task_type,
        skip=skip,
        limit=limit
    )
    return tasks

@router.patch("/{task_id}", response_model=TaskResponse)
async def update_task(
    task_id: str,
    task_data: TaskUpdate,
    db: Session = Depends(get_db)
):
    """更新任务"""
    task = TaskService.update_task(db, task_id, task_data)

    if not task:
        raise HTTPException(status_code=404, detail="Task not found")

    return task

@router.delete("/{task_id}")
async def delete_task(
    task_id: str,
    db: Session = Depends(get_db)
):
    """删除任务"""
    success = TaskService.delete_task(db, task_id)

    if not success:
        raise HTTPException(status_code=404, detail="Task not found")

    return {"status": "deleted"}

@router.get("/stats/summary")
async def get_task_stats(db: Session = Depends(get_db)):
    """获取任务统计"""
    stats = TaskService.get_task_stats(db)
    return stats

@router.post("/cleanup")
async def cleanup_old_tasks(
    days: int = 30,
    db: Session = Depends(get_db)
):
    """清理旧任务"""
    deleted = TaskService.cleanup_old_tasks(db, days)
    return {"deleted": deleted}
```

---

### 5. 主应用

```python
# app/main.py
from fastapi import FastAPI
from app.api.tasks import router as tasks_router
from app.core.database import engine, Base

# 创建数据库表
Base.metadata.create_all(bind=engine)

app = FastAPI(title="任务状态追踪系统")

# 注册路由
app.include_router(tasks_router)

@app.get("/health")
async def health_check():
    return {"status": "ok"}
```

---

## API测试示例

### 1. 创建任务

```bash
curl -X POST "http://localhost:8000/tasks/" \
  -H "Content-Type: application/json" \
  -d '{
    "task_type": "document_process",
    "params": {"file_path": "/tmp/test.pdf"}
  }'

# 响应：
# {
#   "id": 1,
#   "task_id": "abc-123",
#   "task_type": "document_process",
#   "status": "pending",
#   "progress": 0.0,
#   ...
# }
```

---

### 2. 查询任务

```bash
curl "http://localhost:8000/tasks/abc-123"

# 响应：
# {
#   "id": 1,
#   "task_id": "abc-123",
#   "status": "running",
#   "progress": 50.0,
#   ...
# }
```

---

### 3. 更新任务

```bash
curl -X PATCH "http://localhost:8000/tasks/abc-123" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "completed",
    "progress": 100.0,
    "result": {"files_processed": 10}
  }'
```

---

### 4. 查询任务列表

```bash
# 查询所有任务
curl "http://localhost:8000/tasks/"

# 按状态过滤
curl "http://localhost:8000/tasks/?status=completed"

# 按类型过滤
curl "http://localhost:8000/tasks/?task_type=document_process"

# 分页
curl "http://localhost:8000/tasks/?skip=0&limit=10"
```

---

### 5. 获取统计信息

```bash
curl "http://localhost:8000/tasks/stats/summary"

# 响应：
# {
#   "total": 100,
#   "pending": 10,
#   "running": 5,
#   "completed": 80,
#   "failed": 5
# }
```

---

### 6. 清理旧任务

```bash
curl -X POST "http://localhost:8000/tasks/cleanup?days=30"

# 响应：
# {
#   "deleted": 50
# }
```

---

## 前端集成示例

```javascript
// 任务管理类
class TaskManager {
    constructor(baseUrl = 'http://localhost:8000') {
        this.baseUrl = baseUrl;
    }

    async createTask(taskType, params) {
        const response = await fetch(`${this.baseUrl}/tasks/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({task_type: taskType, params})
        });
        return response.json();
    }

    async getTask(taskId) {
        const response = await fetch(`${this.baseUrl}/tasks/${taskId}`);
        return response.json();
    }

    async listTasks(filters = {}) {
        const params = new URLSearchParams(filters);
        const response = await fetch(`${this.baseUrl}/tasks/?${params}`);
        return response.json();
    }

    async updateTask(taskId, updates) {
        const response = await fetch(`${this.baseUrl}/tasks/${taskId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updates)
        });
        return response.json();
    }

    async deleteTask(taskId) {
        const response = await fetch(`${this.baseUrl}/tasks/${taskId}`, {
            method: 'DELETE'
        });
        return response.json();
    }

    async getStats() {
        const response = await fetch(`${this.baseUrl}/tasks/stats/summary`);
        return response.json();
    }
}

// 使用示例
const taskManager = new TaskManager();

// 创建任务
const task = await taskManager.createTask('document_process', {
    file_path: '/tmp/test.pdf'
});

// 轮询任务状态
const pollTask = async (taskId) => {
    while (true) {
        const task = await taskManager.getTask(taskId);
        console.log(`进度: ${task.progress}%`);

        if (task.status === 'completed' || task.status === 'failed') {
            break;
        }

        await new Promise(r => setTimeout(r, 1000));
    }
};

await pollTask(task.task_id);
```

---

## 关键知识点

### 1. 服务层模式

```python
# 将业务逻辑封装在服务层
class TaskService:
    @staticmethod
    def create_task(db, task_data, task_id):
        # 业务逻辑
        pass
```

### 2. Pydantic验证

```python
# 自动验证请求数据
class TaskCreate(BaseModel):
    task_type: str
    params: Optional[dict] = None
```

### 3. 依赖注入

```python
# 自动注入数据库Session
async def create_task(
    task_data: TaskCreate,
    db: Session = Depends(get_db)
):
    pass
```

---

## 总结

本示例演示了：
- ✅ 完整的CRUD操作
- ✅ 服务层模式
- ✅ Pydantic数据验证
- ✅ 任务统计和清理
- ✅ 前端集成示例

**下一步**：学习SSE流式进度更新（场景4）
