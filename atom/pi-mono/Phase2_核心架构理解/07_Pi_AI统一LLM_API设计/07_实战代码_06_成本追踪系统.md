# 实战代码6：成本追踪系统

> 实现完整的成本追踪和分析系统

---

## 目标

追踪 Token 使用量和成本，生成使用报告。

---

## 完整代码

```typescript
/**
 * 成本追踪系统
 * 演示：Token 追踪 + 成本计算 + 报告生成
 */

// ===== 1. 类型定义 =====

interface TokenUsage {
  inputTokens: number;
  outputTokens: number;
  totalTokens: number;
  cost: number;
}

interface UsageRecord {
  id: string;
  timestamp: number;
  provider: string;
  model: string;
  usage: TokenUsage;
}

// ===== 2. 定价配置 =====

const PRICING = {
  'openai/gpt-4o-mini': { input: 0.15, output: 0.60 },
  'anthropic/claude-opus-4': { input: 3.00, output: 15.00 },
  'google/gemini-2.0-flash': { input: 0.075, output: 0.30 }
};

// ===== 3. 成本计算器 =====

class CostCalculator {
  calculate(provider: string, model: string, usage: Omit<TokenUsage, 'cost'>): number {
    const key = `${provider}/${model}`;
    const pricing = PRICING[key];

    if (!pricing) {
      return 0;
    }

    const inputCost = (usage.inputTokens / 1_000_000) * pricing.input;
    const outputCost = (usage.outputTokens / 1_000_000) * pricing.output;

    return inputCost + outputCost;
  }
}

// ===== 4. 使用量追踪器 =====

class UsageTracker {
  private records: UsageRecord[] = [];
  private calculator = new CostCalculator();

  track(provider: string, model: string, inputTokens: number, outputTokens: number): UsageRecord {
    const totalTokens = inputTokens + outputTokens;
    const cost = this.calculator.calculate(provider, model, {
      inputTokens,
      outputTokens,
      totalTokens
    });

    const record: UsageRecord = {
      id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      timestamp: Date.now(),
      provider,
      model,
      usage: { inputTokens, outputTokens, totalTokens, cost }
    };

    this.records.push(record);
    return record;
  }

  getTotalUsage(): TokenUsage {
    return this.records.reduce(
      (total, record) => ({
        inputTokens: total.inputTokens + record.usage.inputTokens,
        outputTokens: total.outputTokens + record.usage.outputTokens,
        totalTokens: total.totalTokens + record.usage.totalTokens,
        cost: total.cost + record.usage.cost
      }),
      { inputTokens: 0, outputTokens: 0, totalTokens: 0, cost: 0 }
    );
  }

  getUsageByProvider(): Record<string, TokenUsage> {
    const result: Record<string, TokenUsage> = {};

    for (const record of this.records) {
      if (!result[record.provider]) {
        result[record.provider] = {
          inputTokens: 0,
          outputTokens: 0,
          totalTokens: 0,
          cost: 0
        };
      }

      const usage = result[record.provider];
      usage.inputTokens += record.usage.inputTokens;
      usage.outputTokens += record.usage.outputTokens;
      usage.totalTokens += record.usage.totalTokens;
      usage.cost += record.usage.cost;
    }

    return result;
  }

  generateReport(): string {
    const total = this.getTotalUsage();
    const byProvider = this.getUsageByProvider();

    let report = '# LLM Usage Report\n\n';
    report += '## Summary\n\n';
    report += `- Total tokens: ${total.totalTokens.toLocaleString()}\n`;
    report += `- Total cost: $${total.cost.toFixed(4)}\n\n`;

    report += '## By Provider\n\n';
    report += '| Provider | Tokens | Cost |\n';
    report += '|----------|--------|------|\n';

    for (const [provider, usage] of Object.entries(byProvider)) {
      report += `| ${provider} | ${usage.totalTokens.toLocaleString()} | $${usage.cost.toFixed(4)} |\n`;
    }

    return report;
  }
}

// ===== 5. 使用示例 =====

async function main() {
  const tracker = new UsageTracker();

  console.log('=== 成本追踪示例 ===\n');

  // 模拟多次调用
  console.log('1. OpenAI 调用');
  tracker.track('openai', 'gpt-4o-mini', 1000, 500);
  console.log('   Input: 1000 tokens, Output: 500 tokens');

  console.log('\n2. Anthropic 调用');
  tracker.track('anthropic', 'claude-opus-4', 2000, 1000);
  console.log('   Input: 2000 tokens, Output: 1000 tokens');

  console.log('\n3. Google 调用');
  tracker.track('google', 'gemini-2.0-flash', 1500, 800);
  console.log('   Input: 1500 tokens, Output: 800 tokens');

  // 显示总使用量
  const total = tracker.getTotalUsage();
  console.log('\n=== 总使用量 ===');
  console.log(`Total tokens: ${total.totalTokens.toLocaleString()}`);
  console.log(`Total cost: $${total.cost.toFixed(4)}`);

  // 生成报告
  console.log('\n' + tracker.generateReport());
}

main().catch(console.error);
```

---

## 运行输出

```
=== 成本追踪示例 ===

1. OpenAI 调用
   Input: 1000 tokens, Output: 500 tokens

2. Anthropic 调用
   Input: 2000 tokens, Output: 1000 tokens

3. Google 调用
   Input: 1500 tokens, Output: 800 tokens

=== 总使用量 ===
Total tokens: 6,800
Total cost: $0.0214

# LLM Usage Report

## Summary

- Total tokens: 6,800
- Total cost: $0.0214

## By Provider

| Provider | Tokens | Cost |
|----------|--------|------|
| openai | 1,500 | $0.0004 |
| anthropic | 3,000 | $0.0210 |
| google | 2,300 | $0.0003 |
```

---

## 关键点

### 1. 定价配置
集中管理所有 Provider 的定价。

### 2. 自动计算
根据 Token 使用量自动计算成本。

### 3. 聚合统计
按 Provider 聚合使用量和成本。

---

**版本：** v1.0
**最后更新：** 2026-02-19
