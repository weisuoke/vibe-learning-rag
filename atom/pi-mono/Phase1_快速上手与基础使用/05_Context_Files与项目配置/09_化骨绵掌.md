# 化骨绵掌

> 10 张知识卡片，每张 2 分钟速读，全面掌握 Context Files 配置

---

## 卡片 1：三个文件的职责分工

**核心概念：** Context Files 由三个文件组成，各司其职。

| 文件 | 职责 | 类比 | 提交到 Git？ |
|------|------|------|--------------|
| **AGENTS.md** | 项目知识库 | 项目 README | ✅ 是 |
| **settings.json** | 运行配置 | VS Code settings | ❌ 否（个人配置） |
| **SYSTEM.md** | AI 人设 | ESLint 规则 | ✅ 是（团队共识） |

**记忆口诀：**
- AGENTS = 项目说明书（What）
- settings = 运行配置（How）
- SYSTEM = AI 性格（Who）

**快速上手：**
```bash
# 最小配置（30秒）
echo "# 项目规范\n- TypeScript + React" > AGENTS.md
mkdir -p .pi && echo '{"defaultModel": "claude-opus-4"}' > .pi/settings.json
```

---

## 卡片 2：AGENTS.md 的累加机制

**核心概念：** AGENTS.md 不是覆盖，而是累加（concatenate）。

**加载顺序：**
```
全局 ~/.pi/agent/AGENTS.md
↓ 累加
项目根 /project/AGENTS.md
↓ 累加
子目录 /project/subdir/AGENTS.md
↓
最终内容 = 三者拼接
```

**实际案例：**
```markdown
# 全局 AGENTS.md
- 个人习惯：使用 Vim 快捷键

# 项目根 AGENTS.md
- 项目规范：TypeScript + React

# 子目录 AGENTS.md
- 模块规范：使用 Zustand 管理状态

# Pi Agent 看到的内容（累加）
- 个人习惯：使用 Vim 快捷键
- 项目规范：TypeScript + React
- 模块规范：使用 Zustand 管理状态
```

**避免误区：** 不要在子目录重复父目录的内容！

---

## 卡片 3：settings.json 的智能合并

**核心概念：** 对象深度合并，数组完全替换。

**合并规则：**
```json
// 全局配置
{
  "defaultModel": "claude-sonnet-4",
  "compaction": {
    "enabled": true,
    "reserveTokens": 50000
  },
  "packages": ["@pi/core"]
}

// 项目配置
{
  "compaction": {
    "reserveTokens": 80000
  },
  "packages": ["@pi/custom"]
}

// 最终结果
{
  "defaultModel": "claude-sonnet-4",  // 继承全局
  "compaction": {
    "enabled": true,                   // 继承全局（对象合并）
    "reserveTokens": 80000             // 项目覆盖
  },
  "packages": ["@pi/custom"]           // 完全替换（数组不合并）
}
```

**记住：** 数组配置需要显式包含全局值！

---

## 卡片 4：SYSTEM.md vs APPEND_SYSTEM.md

**核心概念：** 替换 vs 追加，99% 的情况用 APPEND_SYSTEM.md。

| 文件 | 行为 | 使用场景 | 风险 |
|------|------|----------|------|
| **SYSTEM.md** | 完全替换默认提示词 | 完全自定义 AI（高级） | 高（丢失默认能力） |
| **APPEND_SYSTEM.md** | 追加到默认提示词 | 添加项目规则（推荐） | 低（保留默认能力） |

**实际案例：**
```markdown
# ❌ 错误：使用 SYSTEM.md
# .pi/SYSTEM.md
你必须使用函数式编程。

# 结果：Pi Agent 失去所有默认能力（不知道如何使用工具）

---

# ✅ 正确：使用 APPEND_SYSTEM.md
# .pi/APPEND_SYSTEM.md
你必须使用函数式编程。

# 结果：Pi Agent 保留默认能力 + 遵循函数式编程
```

**记住：** 除非你知道自己在做什么，否则用 APPEND_SYSTEM.md！

---

## 卡片 5：配置文件的位置和优先级

**核心概念：** 全局 vs 项目级，项目级优先。

**文件位置：**
```bash
# 全局配置（所有项目生效）
~/.pi/agent/
├── AGENTS.md
├── settings.json
├── SYSTEM.md
└── APPEND_SYSTEM.md

# 项目配置（当前项目生效）
/project/.pi/
├── settings.json
├── SYSTEM.md
└── APPEND_SYSTEM.md

# 项目根配置（团队共享）
/project/
└── AGENTS.md
```

**优先级规则：**
- AGENTS.md：累加（所有层级都生效）
- settings.json：项目覆盖全局
- SYSTEM.md：项目覆盖全局

**最佳实践：**
- 全局：个人习惯和偏好
- 项目：团队规范和配置

---

## 卡片 6：AGENTS.md 的内容结构

**核心概念：** 用 Markdown 写项目说明书。

**推荐结构：**
```markdown
# 项目概述
简短描述项目是什么，使用什么技术栈。

# 技术栈
- TypeScript 5
- React 18
- Vite 5
- pnpm

# 目录结构
- src/components/ - React 组件
- src/utils/ - 工具函数
- src/api/ - API 调用

# 开发规范
- 代码风格：Prettier + ESLint
- 提交规范：Conventional Commits
- 测试要求：单元测试覆盖率 > 80%

# 常用命令
- pnpm dev - 启动开发服务器
- pnpm build - 构建生产版本
- pnpm test - 运行测试
- pnpm lint - 代码检查

# 注意事项
- 不要修改 src/legacy/ 目录
- API 调用统一使用 src/api/client.ts
- 所有组件必须有 TypeScript 类型
```

**记住：** 写给 AI 看的"项目 README"！

---

## 卡片 7：settings.json 的常用配置

**核心概念：** 掌握 20% 的配置，解决 80% 的问题。

**必知配置：**
```json
{
  // 模型配置
  "defaultModel": "claude-opus-4",
  "defaultThinkingLevel": "medium",

  // UI 配置
  "theme": "dark",
  "quietStartup": true,
  "collapseChangelog": true,

  // 性能配置
  "compaction": {
    "enabled": true,
    "reserveTokens": 50000,
    "keepRecentTokens": 10000
  },

  // 资源配置
  "packages": ["@pi/core"],
  "skills": ["~/.pi/skills/common"],
  "extensions": ["~/.pi/extensions/custom"]
}
```

**常用场景：**
- 切换模型：修改 `defaultModel`
- 安静启动：设置 `quietStartup: true`
- 自动压缩：配置 `compaction`

---

## 卡片 8：团队协作的配置策略

**核心概念：** 共享规范，个性化配置。

**Git 管理策略：**
```bash
# 提交到 Git（团队共享）
project/
├── AGENTS.md              # ✅ 提交（团队规范）
└── .gitignore
    └── .pi/               # ❌ 忽略（个人配置）

# .gitignore 内容
.pi/settings.json
.pi/SYSTEM.md
.pi/APPEND_SYSTEM.md
```

**团队协作流程：**
1. **项目启动** - 创建 AGENTS.md，定义团队规范
2. **提交到 Git** - 让所有成员共享规范
3. **个人定制** - 每个成员在 .pi/ 目录配置个人偏好
4. **定期更新** - Review 和更新 AGENTS.md

**最佳实践：**
- AGENTS.md：只包含团队共识
- settings.json：个人偏好（模型、主题）
- APPEND_SYSTEM.md：个人工作风格

---

## 卡片 9：Mono-repo 的渐进式披露

**核心概念：** 根目录通用规范 + 子包特定规范。

**目录结构：**
```bash
/monorepo/
├── AGENTS.md                    # 通用规范
├── packages/
│   ├── frontend/
│   │   └── AGENTS.md            # 前端特定规范
│   └── backend/
│       └── AGENTS.md            # 后端特定规范
```

**内容设计：**
```markdown
# /monorepo/AGENTS.md（通用规范）
- 代码风格：Prettier
- 提交规范：Conventional Commits
- 测试要求：覆盖率 > 80%

# /monorepo/packages/frontend/AGENTS.md（前端特定）
- 框架：React 18
- 状态管理：Zustand
- 样式：Tailwind CSS

# /monorepo/packages/backend/AGENTS.md（后端特定）
- 框架：Express
- 数据库：PostgreSQL
- ORM：Prisma
```

**记住：** 子目录不要重复父目录的内容！

**来源：** Twitter @badlogicgames 的 progressive disclosure 最佳实践

---

## 卡片 10：热重载和调试技巧

**核心概念：** 修改配置后，使用 /reload 立即生效。

**热重载命令：**
```bash
# 在 Pi 中执行
/reload

# 效果：重新加载所有 Context Files
# - AGENTS.md
# - settings.json
# - SYSTEM.md / APPEND_SYSTEM.md
```

**调试技巧：**

**1. 查看加载的配置**
```bash
# Pi 启动时会显示加载的文件
Loaded context files:
- ~/.pi/agent/AGENTS.md
- /project/AGENTS.md
- /project/.pi/settings.json
```

**2. 测试配置是否生效**
```bash
# 修改 AGENTS.md
echo "测试规则：使用函数式编程" >> AGENTS.md

# 重新加载
/reload

# 测试：问 Pi "项目有什么规范？"
# Pi 应该提到"使用函数式编程"
```

**3. 排查配置问题**
```bash
# 检查文件是否存在
ls -la AGENTS.md .pi/settings.json

# 检查文件内容
cat AGENTS.md
cat .pi/settings.json

# 检查 JSON 语法
cat .pi/settings.json | jq .
```

**常见问题：**
- 配置不生效？→ 检查文件位置和语法
- 行为异常？→ 检查是否误用 SYSTEM.md
- 配置冲突？→ 检查多层级的 AGENTS.md

---

## 总结：10 张卡片速查表

| 卡片 | 核心知识点 | 记忆关键词 |
|------|-----------|-----------|
| 1 | 三个文件的职责 | What / How / Who |
| 2 | AGENTS.md 累加机制 | 累加不覆盖 |
| 3 | settings.json 合并规则 | 对象合并，数组替换 |
| 4 | SYSTEM.md vs APPEND | 99% 用 APPEND |
| 5 | 文件位置和优先级 | 全局 vs 项目 |
| 6 | AGENTS.md 内容结构 | 项目说明书 |
| 7 | settings.json 常用配置 | 模型、UI、性能 |
| 8 | 团队协作策略 | 共享规范，个性配置 |
| 9 | Mono-repo 渐进披露 | 通用 + 特定 |
| 10 | 热重载和调试 | /reload 命令 |

---

**学习路径建议：**
1. **第一天**：卡片 1-4（基础概念）
2. **第二天**：卡片 5-7（配置实践）
3. **第三天**：卡片 8-10（高级技巧）

**实战练习：**
1. 为你的项目创建 AGENTS.md
2. 配置 .pi/settings.json 切换模型
3. 尝试 /reload 命令测试热重载
4. 在团队项目中应用配置策略

---

**记住：** 每张卡片 2 分钟，20 分钟掌握 Context Files 核心知识！
