# æ ¸å¿ƒæ¦‚å¿µ8ï¼šé…ç½®éªŒè¯æœºåˆ¶

## ä¸€å¥è¯å®šä¹‰

**é…ç½®éªŒè¯æœºåˆ¶æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥é…ç½®çš„å®Œæ•´æ€§ã€æ­£ç¡®æ€§å’Œå®‰å…¨æ€§çš„æœºåˆ¶ï¼Œç¡®ä¿åº”ç”¨åœ¨æ­£ç¡®çš„é…ç½®ä¸‹è¿è¡Œï¼Œé¿å…è¿è¡Œæ—¶æ‰å‘ç°é…ç½®é”™è¯¯ã€‚**

---

## ä¸ºä»€ä¹ˆéœ€è¦é…ç½®éªŒè¯ï¼Ÿ

### é—®é¢˜åœºæ™¯

**åœºæ™¯1ï¼šç¼ºå°‘å¿…éœ€é…ç½®**

```python
# âŒ æ²¡æœ‰éªŒè¯ï¼Œè¿è¡Œæ—¶æ‰æŠ¥é”™
import os

DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(DATABASE_URL)  # å¦‚æœ DATABASE_URL æ˜¯ Noneï¼Œè¿™é‡Œä¼šæŠ¥é”™

# åº”ç”¨å·²ç»å¯åŠ¨ï¼Œä½†è¿æ¥æ•°æ®åº“æ—¶æ‰å‘ç°é…ç½®ç¼ºå¤±
```

**åœºæ™¯2ï¼šé…ç½®æ ¼å¼é”™è¯¯**

```python
# âŒ æ²¡æœ‰éªŒè¯ï¼Œè¿è¡Œæ—¶æ‰æŠ¥é”™
PORT = int(os.getenv("PORT", "8000"))  # å¦‚æœ PORT ä¸æ˜¯æ•°å­—ï¼Œè¿™é‡Œä¼šæŠ¥é”™
DEBUG = os.getenv("DEBUG", "False").lower() == "true"  # å¦‚æœ DEBUG æ˜¯ "yes"ï¼Œä¼šè¢«å½“ä½œ False
```

**åœºæ™¯3ï¼šé…ç½®å€¼ä¸åˆæ³•**

```python
# âŒ æ²¡æœ‰éªŒè¯ï¼Œä½¿ç”¨äº†ä¸å®‰å…¨çš„é…ç½®
SECRET_KEY = os.getenv("SECRET_KEY", "default-key")  # å¤ªçŸ­ï¼Œä¸å®‰å…¨
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "sk-test")  # æµ‹è¯•å¯†é’¥ï¼Œä¸åº”è¯¥åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
```

### é…ç½®éªŒè¯çš„å¥½å¤„

**1. å¿«é€Ÿå¤±è´¥ï¼ˆFail Fastï¼‰**
- å¯åŠ¨æ—¶å‘ç°é—®é¢˜ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶
- é¿å…éƒ¨åˆ†åŠŸèƒ½æ­£å¸¸ã€éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸çš„æƒ…å†µ

**2. æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯**
- æ˜ç¡®æŒ‡å‡ºå“ªä¸ªé…ç½®ç¼ºå¤±æˆ–é”™è¯¯
- æä¾›ä¿®å¤å»ºè®®

**3. å®‰å…¨ä¿éšœ**
- éªŒè¯å¯†é’¥æ ¼å¼å’Œé•¿åº¦
- é˜²æ­¢ä½¿ç”¨ä¸å®‰å…¨çš„é…ç½®

**4. ç±»å‹å®‰å…¨**
- è‡ªåŠ¨ç±»å‹è½¬æ¢å’ŒéªŒè¯
- IDE ç±»å‹æç¤º

---

## é…ç½®éªŒè¯çš„å±‚æ¬¡

### å±‚æ¬¡1ï¼šå¿…éœ€å­—æ®µéªŒè¯

**éªŒè¯é…ç½®æ˜¯å¦å­˜åœ¨**

```python
import os
import sys

# å¿…éœ€çš„é…ç½®
REQUIRED_VARS = [
    "DATABASE_URL",
    "OPENAI_API_KEY",
    "SECRET_KEY"
]

# éªŒè¯é…ç½®
missing_vars = []
for var in REQUIRED_VARS:
    if not os.getenv(var):
        missing_vars.append(var)

if missing_vars:
    print(f"âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: {', '.join(missing_vars)}")
    sys.exit(1)

print("âœ… å¿…éœ€é…ç½®éªŒè¯é€šè¿‡")
```

---

### å±‚æ¬¡2ï¼šç±»å‹éªŒè¯

**éªŒè¯é…ç½®çš„ç±»å‹æ˜¯å¦æ­£ç¡®**

```python
import os
import sys

def validate_int(key: str, default: int = None) -> int:
    """éªŒè¯æ•´æ•°ç±»å‹"""
    value = os.getenv(key)
    if value is None:
        if default is not None:
            return default
        print(f"âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½® {key}")
        sys.exit(1)

    try:
        return int(value)
    except ValueError:
        print(f"âŒ é”™è¯¯ï¼š{key} å¿…é¡»æ˜¯æ•´æ•°ï¼Œå½“å‰å€¼: {value}")
        sys.exit(1)

def validate_bool(key: str, default: bool = False) -> bool:
    """éªŒè¯å¸ƒå°”ç±»å‹"""
    value = os.getenv(key)
    if value is None:
        return default

    return value.lower() in ("true", "1", "yes", "on")

# ä½¿ç”¨
PORT = validate_int("PORT", 8000)
DEBUG = validate_bool("DEBUG", False)
```

---

### å±‚æ¬¡3ï¼šæ ¼å¼éªŒè¯

**éªŒè¯é…ç½®çš„æ ¼å¼æ˜¯å¦æ­£ç¡®**

```python
import os
import sys
import re

def validate_api_key(key: str) -> str:
    """éªŒè¯ API å¯†é’¥æ ¼å¼"""
    value = os.getenv(key)
    if not value:
        print(f"âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½® {key}")
        sys.exit(1)

    # éªŒè¯ OpenAI API å¯†é’¥æ ¼å¼
    if not value.startswith("sk-"):
        print(f"âŒ é”™è¯¯ï¼š{key} æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ 'sk-' å¼€å¤´")
        sys.exit(1)

    if len(value) < 20:
        print(f"âŒ é”™è¯¯ï¼š{key} é•¿åº¦ä¸è¶³")
        sys.exit(1)

    return value

def validate_database_url(key: str) -> str:
    """éªŒè¯æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ ¼å¼"""
    value = os.getenv(key)
    if not value:
        print(f"âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½® {key}")
        sys.exit(1)

    # éªŒè¯ PostgreSQL è¿æ¥å­—ç¬¦ä¸²æ ¼å¼
    pattern = r'^postgresql://[^:]+:[^@]+@[^:]+:\d+/[^/]+$'
    if not re.match(pattern, value):
        print(f"âŒ é”™è¯¯ï¼š{key} æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æ˜¯ postgresql://user:password@host:port/dbname")
        sys.exit(1)

    return value

# ä½¿ç”¨
OPENAI_API_KEY = validate_api_key("OPENAI_API_KEY")
DATABASE_URL = validate_database_url("DATABASE_URL")
```

---

### å±‚æ¬¡4ï¼šå€¼èŒƒå›´éªŒè¯

**éªŒè¯é…ç½®çš„å€¼æ˜¯å¦åœ¨åˆæ³•èŒƒå›´å†…**

```python
def validate_port(key: str, default: int = 8000) -> int:
    """éªŒè¯ç«¯å£å·èŒƒå›´"""
    port = validate_int(key, default)

    if port < 1024 or port > 65535:
        print(f"âŒ é”™è¯¯ï¼š{key} å¿…é¡»åœ¨ 1024-65535 ä¹‹é—´ï¼Œå½“å‰å€¼: {port}")
        sys.exit(1)

    return port

def validate_log_level(key: str, default: str = "INFO") -> str:
    """éªŒè¯æ—¥å¿—çº§åˆ«"""
    value = os.getenv(key, default).upper()

    valid_levels = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
    if value not in valid_levels:
        print(f"âŒ é”™è¯¯ï¼š{key} å¿…é¡»æ˜¯ {', '.join(valid_levels)} ä¹‹ä¸€ï¼Œå½“å‰å€¼: {value}")
        sys.exit(1)

    return value

# ä½¿ç”¨
PORT = validate_port("PORT", 8000)
LOG_LEVEL = validate_log_level("LOG_LEVEL", "INFO")
```

---

### å±‚æ¬¡5ï¼šç¯å¢ƒç‰¹å®šéªŒè¯

**æ ¹æ®ç¯å¢ƒéªŒè¯é…ç½®çš„å®‰å…¨æ€§**

```python
def validate_production_config():
    """éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    env = os.getenv("ENV", "dev")

    if env == "prod":
        # ç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼
        if os.getenv("DEBUG", "False").lower() == "true":
            print("âŒ é”™è¯¯ï¼šç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼")
            sys.exit(1)

        # ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“
        database_url = os.getenv("DATABASE_URL", "")
        if "localhost" in database_url or "127.0.0.1" in database_url:
            print("âŒ é”™è¯¯ï¼šç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“")
            sys.exit(1)

        # ç”Ÿäº§ç¯å¢ƒå¯†é’¥é•¿åº¦å¿…é¡»è¶³å¤Ÿ
        secret_key = os.getenv("SECRET_KEY", "")
        if len(secret_key) < 32:
            print("âŒ é”™è¯¯ï¼šç”Ÿäº§ç¯å¢ƒå¯†é’¥é•¿åº¦å¿…é¡»è‡³å°‘ 32 å­—ç¬¦")
            sys.exit(1)

        print("âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡")

# ä½¿ç”¨
validate_production_config()
```

---

## ä½¿ç”¨ Pydantic Settings è¿›è¡ŒéªŒè¯

### åŸºç¡€éªŒè¯

```python
from pydantic import Field, field_validator
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # å¿…éœ€å­—æ®µï¼ˆæ²¡æœ‰é»˜è®¤å€¼ï¼‰
    database_url: str = Field(..., description="æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²")
    openai_api_key: str = Field(..., description="OpenAI API å¯†é’¥")

    # å¯é€‰å­—æ®µï¼ˆæœ‰é»˜è®¤å€¼ï¼‰
    debug: bool = Field(False, description="è°ƒè¯•æ¨¡å¼")
    port: int = Field(8000, description="ç«¯å£å·")

    class Config:
        env_file = ".env"

# å¯åŠ¨æ—¶éªŒè¯ï¼ˆç¼ºå°‘å¿…éœ€å­—æ®µä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰
try:
    settings = Settings()
    print("âœ… é…ç½®éªŒè¯é€šè¿‡")
except Exception as e:
    print(f"âŒ é…ç½®é”™è¯¯: {e}")
    sys.exit(1)
```

---

### è‡ªå®šä¹‰éªŒè¯å™¨

```python
from pydantic import Field, field_validator
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    openai_api_key: str
    database_url: str
    port: int = 8000
    log_level: str = "INFO"

    @field_validator("openai_api_key")
    @classmethod
    def validate_api_key(cls, v: str) -> str:
        """éªŒè¯ API å¯†é’¥æ ¼å¼"""
        if not v.startswith("sk-"):
            raise ValueError("OpenAI API å¯†é’¥å¿…é¡»ä»¥ 'sk-' å¼€å¤´")
        if len(v) < 20:
            raise ValueError("OpenAI API å¯†é’¥é•¿åº¦ä¸è¶³")
        return v

    @field_validator("database_url")
    @classmethod
    def validate_database_url(cls, v: str) -> str:
        """éªŒè¯æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²"""
        if not v.startswith("postgresql://"):
            raise ValueError("åªæ”¯æŒ PostgreSQL æ•°æ®åº“")
        if "localhost" in v:
            import os
            if os.getenv("ENV") == "prod":
                raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“")
        return v

    @field_validator("port")
    @classmethod
    def validate_port(cls, v: int) -> int:
        """éªŒè¯ç«¯å£å·èŒƒå›´"""
        if v < 1024 or v > 65535:
            raise ValueError(f"ç«¯å£å·å¿…é¡»åœ¨ 1024-65535 ä¹‹é—´ï¼Œå½“å‰å€¼: {v}")
        return v

    @field_validator("log_level")
    @classmethod
    def validate_log_level(cls, v: str) -> str:
        """éªŒè¯æ—¥å¿—çº§åˆ«"""
        v = v.upper()
        valid_levels = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v not in valid_levels:
            raise ValueError(f"æ—¥å¿—çº§åˆ«å¿…é¡»æ˜¯ {', '.join(valid_levels)} ä¹‹ä¸€")
        return v

    class Config:
        env_file = ".env"

# ä½¿ç”¨
settings = Settings()
```

---

### è·¨å­—æ®µéªŒè¯

```python
from pydantic import model_validator
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    env: str = "dev"
    debug: bool = False
    database_url: str
    secret_key: str

    @model_validator(mode='after')
    def validate_production_config(self):
        """éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®"""
        if self.env == "prod":
            # ç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼
            if self.debug:
                raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼")

            # ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“
            if "localhost" in self.database_url:
                raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“")

            # ç”Ÿäº§ç¯å¢ƒå¯†é’¥é•¿åº¦å¿…é¡»è¶³å¤Ÿ
            if len(self.secret_key) < 32:
                raise ValueError("ç”Ÿäº§ç¯å¢ƒå¯†é’¥é•¿åº¦å¿…é¡»è‡³å°‘ 32 å­—ç¬¦")

        return self

    class Config:
        env_file = ".env"

settings = Settings()
```

---

## é…ç½®éªŒè¯çš„å®é™…åº”ç”¨

### ç¤ºä¾‹1ï¼šFastAPI åº”ç”¨çš„é…ç½®éªŒè¯

```python
# app/config.py
import os
from enum import Enum
from pydantic import Field, field_validator, model_validator
from pydantic_settings import BaseSettings

class Environment(str, Enum):
    DEV = "dev"
    TEST = "test"
    PROD = "prod"

class Settings(BaseSettings):
    # ç¯å¢ƒæ ‡è¯†
    env: Environment = Environment.DEV

    # åº”ç”¨é…ç½®
    app_name: str = "AI Agent API"
    debug: bool = False
    log_level: str = "INFO"

    # æ•°æ®åº“é…ç½®
    database_url: str = Field(..., description="PostgreSQL è¿æ¥å­—ç¬¦ä¸²")
    database_pool_size: int = Field(10, ge=1, le=100)

    # LLM é…ç½®
    openai_api_key: str = Field(..., description="OpenAI API å¯†é’¥")
    openai_model: str = "gpt-4"
    openai_temperature: float = Field(0.7, ge=0.0, le=2.0)

    # å®‰å…¨é…ç½®
    secret_key: str = Field(..., min_length=32, description="JWT å¯†é’¥")

    # Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
    redis_url: str | None = None

    @field_validator("openai_api_key")
    @classmethod
    def validate_api_key(cls, v: str) -> str:
        if not v.startswith("sk-"):
            raise ValueError("OpenAI API å¯†é’¥æ ¼å¼é”™è¯¯")
        return v

    @field_validator("database_url")
    @classmethod
    def validate_database_url(cls, v: str) -> str:
        if not v.startswith("postgresql://"):
            raise ValueError("åªæ”¯æŒ PostgreSQL æ•°æ®åº“")
        return v

    @field_validator("log_level")
    @classmethod
    def validate_log_level(cls, v: str) -> str:
        v = v.upper()
        valid_levels = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v not in valid_levels:
            raise ValueError(f"æ—¥å¿—çº§åˆ«å¿…é¡»æ˜¯ {', '.join(valid_levels)} ä¹‹ä¸€")
        return v

    @model_validator(mode='after')
    def validate_production_config(self):
        if self.env == Environment.PROD:
            if self.debug:
                raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼")
            if "localhost" in self.database_url:
                raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“")
        return self

    class Config:
        env_file = f".env.{os.getenv('ENV', 'dev')}"

# å¯åŠ¨æ—¶éªŒè¯
try:
    settings = Settings()
    print(f"âœ… é…ç½®éªŒè¯é€šè¿‡")
    print(f"   ç¯å¢ƒ: {settings.env}")
    print(f"   æ•°æ®åº“: {settings.database_url}")
    print(f"   è°ƒè¯•æ¨¡å¼: {settings.debug}")
except Exception as e:
    print(f"âŒ é…ç½®é”™è¯¯: {e}")
    import sys
    sys.exit(1)
```

---

### ç¤ºä¾‹2ï¼šå¯åŠ¨æ—¶é…ç½®æ£€æŸ¥

```python
# app/main.py
from fastapi import FastAPI
from app.config import settings
import logging

logger = logging.getLogger(__name__)

app = FastAPI(
    title=settings.app_name,
    debug=settings.debug
)

@app.on_event("startup")
async def startup():
    """åº”ç”¨å¯åŠ¨æ—¶çš„é…ç½®æ£€æŸ¥"""
    logger.info("ğŸš€ å¯åŠ¨åº”ç”¨")

    # æ‰“å°é…ç½®ä¿¡æ¯
    logger.info(f"ğŸ“ ç¯å¢ƒ: {settings.env}")
    logger.info(f"ğŸ—„ï¸  æ•°æ®åº“: {settings.database_url}")
    logger.info(f"ğŸ¤– LLM æ¨¡å‹: {settings.openai_model}")
    logger.info(f"ğŸ› è°ƒè¯•æ¨¡å¼: {settings.debug}")

    # éªŒè¯æ•°æ®åº“è¿æ¥
    try:
        from app.database import engine
        with engine.connect() as conn:
            conn.execute("SELECT 1")
        logger.info("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
    except Exception as e:
        logger.error(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        raise

    # éªŒè¯ Redis è¿æ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if settings.redis_url:
        try:
            import redis
            r = redis.from_url(settings.redis_url)
            r.ping()
            logger.info("âœ… Redis è¿æ¥æˆåŠŸ")
        except Exception as e:
            logger.error(f"âŒ Redis è¿æ¥å¤±è´¥: {e}")
            raise

    logger.info("âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ")

@app.get("/health")
def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    return {
        "status": "healthy",
        "env": settings.env,
        "debug": settings.debug
    }
```

---

### ç¤ºä¾‹3ï¼šé…ç½®éªŒè¯å·¥å…·

```python
# scripts/validate_config.py
"""
é…ç½®éªŒè¯å·¥å…·
ç”¨äºåœ¨éƒ¨ç½²å‰éªŒè¯é…ç½®æ–‡ä»¶
"""
import os
import sys
from pathlib import Path

def validate_env_file(env_file: str):
    """éªŒè¯ .env æ–‡ä»¶"""
    print(f"éªŒè¯é…ç½®æ–‡ä»¶: {env_file}")

    if not Path(env_file).exists():
        print(f"âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {env_file}")
        return False

    # åŠ è½½é…ç½®
    from dotenv import load_dotenv
    load_dotenv(env_file)

    # éªŒè¯å¿…éœ€å­—æ®µ
    required_vars = [
        "DATABASE_URL",
        "OPENAI_API_KEY",
        "SECRET_KEY"
    ]

    missing_vars = []
    for var in required_vars:
        if not os.getenv(var):
            missing_vars.append(var)

    if missing_vars:
        print(f"âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: {', '.join(missing_vars)}")
        return False

    # éªŒè¯é…ç½®æ ¼å¼
    try:
        from app.config import Settings
        settings = Settings()
        print(f"âœ… é…ç½®éªŒè¯é€šè¿‡")
        print(f"   ç¯å¢ƒ: {settings.env}")
        print(f"   æ•°æ®åº“: {settings.database_url}")
        return True
    except Exception as e:
        print(f"âŒ é…ç½®é”™è¯¯: {e}")
        return False

if __name__ == "__main__":
    env_file = sys.argv[1] if len(sys.argv) > 1 else ".env"
    success = validate_env_file(env_file)
    sys.exit(0 if success else 1)
```

**ä½¿ç”¨ï¼š**

```bash
# éªŒè¯å¼€å‘ç¯å¢ƒé…ç½®
python scripts/validate_config.py .env.dev

# éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®
python scripts/validate_config.py .env.prod
```

---

## é…ç½®éªŒè¯çš„æœ€ä½³å®è·µ

### å®è·µ1ï¼šå¯åŠ¨æ—¶éªŒè¯

**åœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³éªŒè¯é…ç½®ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶æ‰å‘ç°é—®é¢˜ã€‚**

```python
# âœ… æ­£ç¡®ï¼šå¯åŠ¨æ—¶éªŒè¯
from app.config import settings  # å¯¼å…¥æ—¶å°±ä¼šéªŒè¯

# âŒ é”™è¯¯ï¼šè¿è¡Œæ—¶æ‰éªŒè¯
def get_database():
    database_url = os.getenv("DATABASE_URL")  # å¯èƒ½æ˜¯ None
    return create_engine(database_url)  # è¿è¡Œæ—¶æ‰æŠ¥é”™
```

---

### å®è·µ2ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

**é”™è¯¯ä¿¡æ¯åº”è¯¥æ˜ç¡®æŒ‡å‡ºé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚**

```python
# âŒ é”™è¯¯ï¼šæ¨¡ç³Šçš„é”™è¯¯ä¿¡æ¯
if not os.getenv("DATABASE_URL"):
    raise ValueError("é…ç½®é”™è¯¯")

# âœ… æ­£ç¡®ï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
if not os.getenv("DATABASE_URL"):
    raise ValueError(
        "ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: DATABASE_URL\n"
        "è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®:\n"
        "DATABASE_URL=postgresql://user:password@localhost:5432/dbname"
    )
```

---

### å®è·µ3ï¼šä½¿ç”¨ç±»å‹æ³¨è§£

**ä½¿ç”¨ç±»å‹æ³¨è§£æä¾› IDE æ”¯æŒå’Œç±»å‹æ£€æŸ¥ã€‚**

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str  # IDE çŸ¥é“è¿™æ˜¯ str ç±»å‹
    port: int          # IDE çŸ¥é“è¿™æ˜¯ int ç±»å‹
    debug: bool        # IDE çŸ¥é“è¿™æ˜¯ bool ç±»å‹

settings = Settings()

# IDE æœ‰å®Œæ•´çš„ç±»å‹æç¤º
if settings.debug:  # IDE çŸ¥é“è¿™æ˜¯ bool
    print(settings.database_url)  # IDE çŸ¥é“è¿™æ˜¯ str
```

---

### å®è·µ4ï¼šç¯å¢ƒç‰¹å®šéªŒè¯

**æ ¹æ®ç¯å¢ƒåº”ç”¨ä¸åŒçš„éªŒè¯è§„åˆ™ã€‚**

```python
@model_validator(mode='after')
def validate_environment_specific(self):
    if self.env == "prod":
        # ç”Ÿäº§ç¯å¢ƒçš„ä¸¥æ ¼éªŒè¯
        if self.debug:
            raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½å¯ç”¨è°ƒè¯•æ¨¡å¼")
        if len(self.secret_key) < 32:
            raise ValueError("ç”Ÿäº§ç¯å¢ƒå¯†é’¥é•¿åº¦ä¸è¶³")
    elif self.env == "dev":
        # å¼€å‘ç¯å¢ƒçš„å®½æ¾éªŒè¯
        if not self.debug:
            print("âš ï¸  è­¦å‘Šï¼šå¼€å‘ç¯å¢ƒå»ºè®®å¯ç”¨è°ƒè¯•æ¨¡å¼")
    return self
```

---

### å®è·µ5ï¼šé…ç½®æ–‡æ¡£åŒ–

**ä½¿ç”¨ Field çš„ description å‚æ•°æ–‡æ¡£åŒ–é…ç½®ã€‚**

```python
from pydantic import Field

class Settings(BaseSettings):
    database_url: str = Field(
        ...,
        description="PostgreSQL è¿æ¥å­—ç¬¦ä¸²",
        examples=["postgresql://user:password@localhost:5432/mydb"]
    )

    openai_api_key: str = Field(
        ...,
        description="OpenAI API å¯†é’¥",
        examples=["sk-proj-xxxxxxxxxxxxx"]
    )

    debug: bool = Field(
        False,
        description="è°ƒè¯•æ¨¡å¼ï¼ˆä»…ç”¨äºå¼€å‘ç¯å¢ƒï¼‰"
    )
```

---

## é…ç½®éªŒè¯çš„é«˜çº§ç‰¹æ€§

### ç‰¹æ€§1ï¼šè‡ªå®šä¹‰éªŒè¯å™¨

```python
from pydantic import field_validator

class Settings(BaseSettings):
    database_url: str

    @field_validator("database_url")
    @classmethod
    def validate_database_url(cls, v: str, info) -> str:
        # è®¿é—®å…¶ä»–å­—æ®µ
        env = info.data.get("env", "dev")

        # æ ¹æ®ç¯å¢ƒéªŒè¯
        if env == "prod" and "localhost" in v:
            raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨æœ¬åœ°æ•°æ®åº“")

        return v
```

---

### ç‰¹æ€§2ï¼šæ¡ä»¶éªŒè¯

```python
from pydantic import model_validator

class Settings(BaseSettings):
    redis_enabled: bool = False
    redis_url: str | None = None

    @model_validator(mode='after')
    def validate_redis_config(self):
        # å¦‚æœå¯ç”¨äº† Redisï¼Œå¿…é¡»æä¾› URL
        if self.redis_enabled and not self.redis_url:
            raise ValueError("å¯ç”¨ Redis æ—¶å¿…é¡»æä¾› REDIS_URL")
        return self
```

---

### ç‰¹æ€§3ï¼šè­¦å‘Šè€Œéé”™è¯¯

```python
import warnings

class Settings(BaseSettings):
    database_url: str

    @field_validator("database_url")
    @classmethod
    def validate_database_url(cls, v: str) -> str:
        if "localhost" in v:
            warnings.warn(
                "ä½¿ç”¨æœ¬åœ°æ•°æ®åº“ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ",
                UserWarning
            )
        return v
```

---

## æ€»ç»“

**é…ç½®éªŒè¯æœºåˆ¶çš„æ ¸å¿ƒä»·å€¼ï¼š**

1. **å¿«é€Ÿå¤±è´¥**ï¼šå¯åŠ¨æ—¶å‘ç°é—®é¢˜ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶
2. **æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯**ï¼šæ˜ç¡®æŒ‡å‡ºé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
3. **ç±»å‹å®‰å…¨**ï¼šè‡ªåŠ¨ç±»å‹è½¬æ¢å’ŒéªŒè¯
4. **å®‰å…¨ä¿éšœ**ï¼šéªŒè¯å¯†é’¥æ ¼å¼å’Œé•¿åº¦
5. **ç¯å¢ƒç‰¹å®šéªŒè¯**ï¼šæ ¹æ®ç¯å¢ƒåº”ç”¨ä¸åŒçš„éªŒè¯è§„åˆ™

**éªŒè¯å±‚æ¬¡ï¼š**
1. å¿…éœ€å­—æ®µéªŒè¯ï¼šé…ç½®æ˜¯å¦å­˜åœ¨
2. ç±»å‹éªŒè¯ï¼šé…ç½®ç±»å‹æ˜¯å¦æ­£ç¡®
3. æ ¼å¼éªŒè¯ï¼šé…ç½®æ ¼å¼æ˜¯å¦æ­£ç¡®
4. å€¼èŒƒå›´éªŒè¯ï¼šé…ç½®å€¼æ˜¯å¦åœ¨åˆæ³•èŒƒå›´å†…
5. ç¯å¢ƒç‰¹å®šéªŒè¯ï¼šæ ¹æ®ç¯å¢ƒéªŒè¯é…ç½®çš„å®‰å…¨æ€§

**å®ç°æ–¹å¼ï¼š**
- æ‰‹åŠ¨éªŒè¯ï¼šä½¿ç”¨ if è¯­å¥å’Œå¼‚å¸¸
- Pydantic Settingsï¼šè‡ªåŠ¨éªŒè¯å’Œç±»å‹è½¬æ¢
- è‡ªå®šä¹‰éªŒè¯å™¨ï¼šfield_validator å’Œ model_validator
- å¯åŠ¨æ—¶æ£€æŸ¥ï¼šåœ¨ FastAPI çš„ startup äº‹ä»¶ä¸­éªŒè¯

**æœ€ä½³å®è·µï¼š**
- å¯åŠ¨æ—¶éªŒè¯ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- ä½¿ç”¨ç±»å‹æ³¨è§£
- ç¯å¢ƒç‰¹å®šéªŒè¯
- é…ç½®æ–‡æ¡£åŒ–

**å®é™…åº”ç”¨ï¼š**
- FastAPI åº”ç”¨çš„é…ç½®éªŒè¯
- å¯åŠ¨æ—¶é…ç½®æ£€æŸ¥
- é…ç½®éªŒè¯å·¥å…·
- CI/CD é›†æˆ
