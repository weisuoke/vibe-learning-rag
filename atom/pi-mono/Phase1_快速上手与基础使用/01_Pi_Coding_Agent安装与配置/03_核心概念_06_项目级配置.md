# 核心概念 06：项目级配置

> **知识点定位**：掌握 Pi Coding Agent 的项目级配置系统，理解 .pi/settings.json、AGENTS.md、SYSTEM.md 的作用和配置方法

---

## 一、项目级配置概述

### 1.1 什么是项目级配置

项目级配置允许为每个项目定制 Pi 的行为，包括默认模型、上下文文件、自定义提示等。

**配置层级：**
```
全局配置 (~/.pi/agent/)
    ↓ 被覆盖
项目配置 (.pi/)
    ↓ 被覆盖
CLI 参数
```

**核心配置文件：**
- `.pi/settings.json`：项目设置（模型、思考级别、主题等）
- `AGENTS.md` / `CLAUDE.md`：项目上下文和指令
- `.pi/SYSTEM.md`：自定义系统提示
- `.pi/APPEND_SYSTEM.md`：追加系统提示
- `.pi/skills/`：项目专属技能
- `.pi/prompts/`：项目专属提示模板
- `.pi/extensions/`：项目专属扩展

> **来源**：[Pi Coding Agent README - Settings](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/README.md#settings) (2026-02)

### 1.2 为什么需要项目级配置

**场景示例：**

```
项目 A（前端项目）
- 默认使用 Claude Sonnet 4（快速响应）
- 加载 React 编码规范
- 启用 ESLint 自动修复

项目 B（后端项目）
- 默认使用 Claude Opus 4（深度思考）
- 加载 API 设计规范
- 启用数据库迁移工具

项目 C（开源项目）
- 使用 GitHub Copilot（免费）
- 加载贡献指南
- 启用 Git 提交规范检查
```

---

## 二、.pi/settings.json 配置

### 2.1 配置文件位置

```
项目根目录/
├── .pi/
│   ├── settings.json          # 项目配置
│   ├── SYSTEM.md              # 自定义系统提示
│   ├── skills/                # 项目技能
│   ├── prompts/               # 项目提示模板
│   └── extensions/            # 项目扩展
├── AGENTS.md                  # 项目上下文（根目录）
└── src/
```

### 2.2 完整配置示例

```json
{
  "provider": "anthropic",
  "model": "claude-opus-4",
  "thinkingLevel": "extended",
  "theme": "default",
  "steeringMode": "one-at-a-time",
  "followUpMode": "one-at-a-time",
  "transport": "auto",
  "compaction": {
    "enabled": true,
    "strategy": "auto",
    "threshold": 0.8,
    "keepRecent": 10
  },
  "scopedModels": [
    "claude-opus-4",
    "claude-sonnet-4",
    "gpt-4o"
  ],
  "extensions": [
    "pi-git-extension",
    "pi-test-runner"
  ]
}
```

### 2.3 配置字段详解

#### 2.3.1 模型配置

```json
{
  "provider": "anthropic",
  "model": "claude-opus-4"
}
```

**可选值：**
- `provider`: `"anthropic"`, `"openai"`, `"xai"`, `"google"`, `"groq"` 等
- `model`: Provider 支持的任何模型名称

#### 2.3.2 思考级别

```json
{
  "thinkingLevel": "extended"
}
```

**可选值：**
- `"normal"`：标准模式，快速响应
- `"extended"`：扩展思考，更深入分析
- `"deep"`：深度思考，复杂问题

#### 2.3.3 主题配置

```json
{
  "theme": "default"
}
```

**可选值：**
- `"default"`：默认主题
- `"dark"`：深色主题
- `"light"`：浅色主题
- 自定义主题名称（需在 `~/.pi/agent/themes/` 中定义）

#### 2.3.4 消息传递模式

```json
{
  "steeringMode": "one-at-a-time",
  "followUpMode": "one-at-a-time"
}
```

**可选值：**
- `"one-at-a-time"`：逐条发送，等待响应
- `"all"`：一次性发送所有队列消息

#### 2.3.5 传输协议

```json
{
  "transport": "auto"
}
```

**可选值：**
- `"auto"`：自动选择（优先 SSE）
- `"sse"`：Server-Sent Events
- `"websocket"`：WebSocket

#### 2.3.6 压缩配置

```json
{
  "compaction": {
    "enabled": true,
    "strategy": "auto",
    "threshold": 0.8,
    "keepRecent": 10
  }
}
```

**字段说明：**
- `enabled`: 是否启用自动压缩
- `strategy`: `"auto"`, `"manual"`, `"disabled"`
- `threshold`: 触发压缩的上下文使用率（0.8 = 80%）
- `keepRecent`: 保留最近 N 条消息不压缩

#### 2.3.7 Scoped Models

```json
{
  "scopedModels": [
    "claude-opus-4",
    "claude-sonnet-4",
    "gpt-4o"
  ]
}
```

**作用：**
- 定义 `Ctrl+P` / `Shift+Ctrl+P` 快速切换的模型列表
- 只显示常用模型，提高切换效率

#### 2.3.8 扩展配置

```json
{
  "extensions": [
    "pi-git-extension",
    "pi-test-runner"
  ]
}
```

**作用：**
- 自动加载指定的扩展
- 扩展可以是 npm 包名或本地路径

### 2.4 配置优先级

```
CLI 参数（最高）
    ↓
.pi/settings.json（项目）
    ↓
~/.pi/agent/settings.json（全局）
    ↓
默认值（最低）
```

**示例：**

```bash
# 全局配置
~/.pi/agent/settings.json:
{
  "model": "claude-sonnet-4"
}

# 项目配置
.pi/settings.json:
{
  "model": "claude-opus-4"
}

# CLI 参数
pi --model claude-haiku-4

# 结果：使用 claude-haiku-4
```

---

## 三、AGENTS.md / CLAUDE.md 上下文文件

### 3.1 上下文文件概述

`AGENTS.md` 和 `CLAUDE.md` 是项目级的上下文文件，在 Pi 启动时自动加载，用于提供项目说明、编码规范、常用命令等。

**文件名：**
- `AGENTS.md`：标准名称（推荐）
- `CLAUDE.md`：兼容名称（Claude Code 使用）

**加载顺序：**
```
1. ~/.pi/agent/AGENTS.md（全局）
2. 父目录中的 AGENTS.md（从根目录向下）
3. 当前目录的 AGENTS.md（项目根目录）
```

> **来源**：[Pi Coding Agent README - Context Files](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/README.md#context-files) (2026-02)

### 3.2 AGENTS.md 示例

```markdown
# 项目上下文

## 项目概述

这是一个 TypeScript + React 的前端项目，使用 Vite 构建。

## 技术栈

- **框架**：React 18
- **语言**：TypeScript 5
- **构建工具**：Vite 5
- **状态管理**：Zustand
- **样式**：Tailwind CSS
- **测试**：Vitest + React Testing Library

## 编码规范

### TypeScript

- 使用严格模式（`strict: true`）
- 优先使用函数组件和 Hooks
- 使用 `interface` 定义 Props 类型
- 避免使用 `any`，使用 `unknown` 代替

### React

- 组件文件使用 `.tsx` 扩展名
- 组件名使用 PascalCase
- Props 接口命名：`<ComponentName>Props`
- 使用命名导出而非默认导出

### 样式

- 使用 Tailwind CSS 实用类
- 避免内联样式
- 复杂样式使用 CSS Modules

## 常用命令

```bash
# 开发服务器
npm run dev

# 构建
npm run build

# 测试
npm test

# 类型检查
npm run type-check

# Lint
npm run lint
```

## 项目结构

```
src/
├── components/     # React 组件
├── hooks/          # 自定义 Hooks
├── stores/         # Zustand stores
├── utils/          # 工具函数
├── types/          # TypeScript 类型定义
└── App.tsx         # 根组件
```

## 注意事项

- 所有 API 调用必须包含错误处理
- 组件必须有对应的测试文件
- 提交前运行 `npm run lint` 和 `npm test`
- 使用语义化的 Git 提交消息
```

### 3.3 AGENTS.md 最佳实践

**1. 项目概述**
```markdown
## 项目概述

简短描述项目的目的、主要功能和技术栈。
```

**2. 编码规范**
```markdown
## 编码规范

### 命名约定
- 文件名：kebab-case
- 组件名：PascalCase
- 函数名：camelCase

### 代码风格
- 使用 2 空格缩进
- 使用单引号
- 行尾不加分号
```

**3. 常用命令**
```markdown
## 常用命令

```bash
# 启动开发服务器
npm run dev

# 运行测试
npm test
```
```

**4. 项目结构**
```markdown
## 项目结构

```
src/
├── components/
├── utils/
└── App.tsx
```
```

**5. 注意事项**
```markdown
## 注意事项

- 提交前运行测试
- 遵循 Git 提交规范
- 更新文档
```

### 3.4 多层级 AGENTS.md

Pi 支持在多个目录层级放置 `AGENTS.md`，所有文件会被合并加载：

```
~/
├── .pi/agent/AGENTS.md          # 全局配置
└── projects/
    ├── AGENTS.md                # 所有项目共享
    └── my-project/
        ├── AGENTS.md            # 项目特定配置
        └── .pi/
```

**加载结果：**
```
1. ~/.pi/agent/AGENTS.md
2. ~/projects/AGENTS.md
3. ~/projects/my-project/AGENTS.md
```

---

## 四、SYSTEM.md 自定义系统提示

### 4.1 系统提示概述

系统提示是发送给 LLM 的第一条消息，定义 Agent 的行为和能力。

**默认系统提示：**
- Pi 内置了一个简洁的系统提示
- 定义了 4 个工具：`read`, `write`, `edit`, `bash`
- 强调极简和用户主导

**自定义系统提示：**
- `.pi/SYSTEM.md`：完全替换默认系统提示
- `.pi/APPEND_SYSTEM.md`：追加到默认系统提示

### 4.2 SYSTEM.md 示例

```markdown
# 自定义系统提示

你是一个专注于 React 开发的 AI 助手。

## 核心能力

- 编写高质量的 React 组件
- 遵循 React 最佳实践
- 使用 TypeScript 类型系统
- 编写可测试的代码

## 工具

你有以下工具可用：
- `read`: 读取文件
- `write`: 创建文件
- `edit`: 编辑文件
- `bash`: 执行命令

## 行为准则

1. **代码质量优先**：编写清晰、可维护的代码
2. **类型安全**：充分利用 TypeScript 类型系统
3. **测试驱动**：为新功能编写测试
4. **性能意识**：避免不必要的重渲染
5. **可访问性**：遵循 WCAG 2.1 标准

## 响应格式

- 简洁明了，避免冗长解释
- 代码优先，少说多做
- 遇到问题主动提问
```

### 4.3 APPEND_SYSTEM.md 示例

```markdown
# 追加系统提示

## 项目特定规则

- 所有组件必须使用函数组件
- 使用 Zustand 进行状态管理
- API 调用使用 React Query
- 样式使用 Tailwind CSS

## 禁止事项

- 不要使用类组件
- 不要使用 Redux
- 不要使用内联样式
- 不要使用 `any` 类型
```

### 4.4 系统提示最佳实践

**1. 保持简洁**
```markdown
# ❌ 不好
你是一个非常强大的、经验丰富的、专业的 AI 助手...

# ✅ 好
你是一个 React 开发助手。
```

**2. 明确工具**
```markdown
## 可用工具

- `read`: 读取文件
- `write`: 创建文件
- `edit`: 编辑文件
- `bash`: 执行命令
```

**3. 定义行为**
```markdown
## 行为准则

1. 代码优先，少说多做
2. 遇到问题主动提问
3. 遵循项目编码规范
```

**4. 避免过度约束**
```markdown
# ❌ 不好
你必须严格遵循以下 100 条规则...

# ✅ 好
遵循项目编码规范，见 AGENTS.md
```

---

## 五、项目技能和提示模板

### 5.1 项目技能（.pi/skills/）

项目技能是项目专属的 Skill，只在当前项目中可用。

**目录结构：**
```
.pi/
└── skills/
    ├── deploy/
    │   └── SKILL.md
    ├── test/
    │   └── SKILL.md
    └── review/
        └── SKILL.md
```

**示例：.pi/skills/deploy/SKILL.md**

```markdown
---
name: deploy
description: Deploy the application to production
---

# Deploy Skill

Use this skill when the user asks to deploy the application.

## Steps

1. Run tests to ensure everything works
2. Build the production bundle
3. Upload to S3
4. Invalidate CloudFront cache
5. Verify deployment

## Commands

```bash
npm test
npm run build
aws s3 sync dist/ s3://my-bucket/
aws cloudfront create-invalidation --distribution-id XXX --paths "/*"
```

## Verification

Check https://example.com to verify the deployment.
```

### 5.2 项目提示模板（.pi/prompts/）

项目提示模板是项目专属的 Prompt Template，只在当前项目中可用。

**目录结构：**
```
.pi/
└── prompts/
    ├── component.md
    ├── test.md
    └── api.md
```

**示例：.pi/prompts/component.md**

```markdown
---
name: component
description: Create a new React component
---

Create a new React component with the following requirements:

- Component name: {{name}}
- Props: {{props}}
- Functionality: {{functionality}}

Requirements:
- Use TypeScript
- Use function component
- Include PropTypes interface
- Add basic styling with Tailwind
- Create corresponding test file
```

**使用方式：**
```
> /component
# Pi 会展开模板并提示填写变量
```

### 5.3 项目扩展（.pi/extensions/）

项目扩展是项目专属的 Extension，只在当前项目中可用。

**目录结构：**
```
.pi/
└── extensions/
    └── my-extension/
        ├── package.json
        ├── index.ts
        └── README.md
```

**示例：.pi/extensions/my-extension/index.ts**

```typescript
import { ExtensionAPI } from '@mariozechner/pi-coding-agent';

export default function (pi: ExtensionAPI) {
  // 注册自定义工具
  pi.registerTool({
    name: 'deploy',
    description: 'Deploy the application',
    parameters: {
      type: 'object',
      properties: {
        environment: {
          type: 'string',
          enum: ['staging', 'production']
        }
      }
    },
    handler: async (params) => {
      // 部署逻辑
      return { success: true };
    }
  });

  // 注册自定义命令
  pi.registerCommand('deploy', {
    description: 'Deploy to production',
    handler: async () => {
      // 命令逻辑
    }
  });
}
```

---

## 六、配置模板

### 6.1 前端项目配置

```json
// .pi/settings.json
{
  "provider": "anthropic",
  "model": "claude-sonnet-4",
  "thinkingLevel": "normal",
  "scopedModels": [
    "claude-sonnet-4",
    "claude-haiku-4",
    "gpt-4o"
  ],
  "compaction": {
    "enabled": true,
    "threshold": 0.8
  }
}
```

```markdown
<!-- AGENTS.md -->
# 前端项目

## 技术栈
- React 18 + TypeScript
- Vite + Tailwind CSS

## 编码规范
- 使用函数组件
- Props 使用 interface
- 样式使用 Tailwind

## 常用命令
```bash
npm run dev
npm test
npm run build
```
```

### 6.2 后端项目配置

```json
// .pi/settings.json
{
  "provider": "anthropic",
  "model": "claude-opus-4",
  "thinkingLevel": "extended",
  "scopedModels": [
    "claude-opus-4",
    "claude-sonnet-4"
  ]
}
```

```markdown
<!-- AGENTS.md -->
# 后端项目

## 技术栈
- Node.js + Express
- TypeScript + Prisma
- PostgreSQL

## 编码规范
- 使用 async/await
- 错误处理使用中间件
- API 遵循 REST 规范

## 数据库
```bash
npx prisma migrate dev
npx prisma studio
```
```

### 6.3 开源项目配置

```json
// .pi/settings.json
{
  "provider": "github-copilot",
  "model": "gpt-4o",
  "scopedModels": [
    "gpt-4o",
    "claude-sonnet-4"
  ]
}
```

```markdown
<!-- AGENTS.md -->
# 开源项目

## 贡献指南
- Fork 仓库
- 创建 feature 分支
- 提交 PR

## 提交规范
- feat: 新功能
- fix: 修复 bug
- docs: 文档更新

## 测试要求
- 所有 PR 必须包含测试
- 测试覆盖率 > 80%
```

---

## 七、配置管理最佳实践

### 7.1 版本控制

```bash
# 提交到 Git
git add .pi/settings.json
git add AGENTS.md
git commit -m "Add Pi configuration"

# .gitignore
.pi/sessions/
.pi/auth.json
```

### 7.2 团队协作

```markdown
# README.md

## Pi 配置

本项目使用 Pi Coding Agent 进行开发。

### 安装
```bash
npm install -g @mariozechner/pi-coding-agent
```

### 配置
项目配置已包含在 `.pi/settings.json` 和 `AGENTS.md` 中。

### 使用
```bash
cd project
pi
```
```

### 7.3 多环境配置

```bash
# 开发环境
.pi/settings.json

# 生产环境
.pi/settings.production.json

# 切换配置
cp .pi/settings.production.json .pi/settings.json
```

---

## 八、故障排查

### 8.1 配置未生效

**问题：** 修改 `.pi/settings.json` 后未生效

**解决方案：**
```bash
# 重新加载配置
pi
/reload

# 或重启 Pi
/quit
pi
```

### 8.2 AGENTS.md 未加载

**问题：** `AGENTS.md` 内容未显示在启动头部

**排查步骤：**
```bash
# 1. 检查文件位置
ls -la AGENTS.md
ls -la .pi/AGENTS.md

# 2. 检查文件内容
cat AGENTS.md

# 3. 检查启动日志
PI_DEBUG=1 pi
```

### 8.3 扩展加载失败

**问题：** 项目扩展未加载

**解决方案：**
```bash
# 检查扩展目录
ls -la .pi/extensions/

# 检查 package.json
cat .pi/extensions/my-extension/package.json

# 使用 --dev 模式
pi --dev .pi/extensions/my-extension
```

---

## 九、总结

### 9.1 核心要点

1. **配置层级**：全局 < 项目 < CLI
2. **settings.json**：模型、思考级别、压缩等
3. **AGENTS.md**：项目上下文、编码规范、常用命令
4. **SYSTEM.md**：自定义系统提示
5. **项目资源**：技能、提示模板、扩展

### 9.2 配置文件总结

| 文件 | 作用 | 位置 |
|------|------|------|
| `settings.json` | 项目设置 | `.pi/` |
| `AGENTS.md` | 项目上下文 | 根目录或 `.pi/` |
| `SYSTEM.md` | 自定义系统提示 | `.pi/` |
| `APPEND_SYSTEM.md` | 追加系统提示 | `.pi/` |
| `skills/` | 项目技能 | `.pi/` |
| `prompts/` | 提示模板 | `.pi/` |
| `extensions/` | 项目扩展 | `.pi/` |

### 9.3 下一步

- 学习 **自定义 Provider**（核心概念 07）
- 掌握 **多 Provider 切换**（核心概念 08）
- 了解 **实战代码示例**（实战代码 01-08）

---

**参考资料：**
- [Pi Coding Agent README - Settings](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/README.md#settings)
- [Pi Coding Agent README - Context Files](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/README.md#context-files)
- [Pi Settings Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/settings.md)

**文档版本**：v1.0 (2026-02-18)
