# æ ¸å¿ƒæ¦‚å¿µ 01ï¼šPlan è¡¨ç¤ºä¸æ–‡ä»¶å­˜å‚¨

> **æ ¸å¿ƒç†å¿µï¼š** æ–‡ä»¶ä¼˜å…ˆï¼ˆFile-Firstï¼‰æ˜¯ pi-mono çš„æ ¸å¿ƒå“²å­¦ï¼ŒPlan åº”è¯¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ä»¥å®ç°æœ€å¤§å¯è§‚å¯Ÿæ€§ã€‚

---

## Plan çš„æœ¬è´¨

### ä»€ä¹ˆæ˜¯ Planï¼Ÿ

Planï¼ˆè®¡åˆ’ï¼‰æ˜¯å¯¹ä»»åŠ¡æ‰§è¡Œç­–ç•¥çš„ç»“æ„åŒ–æè¿°ï¼ŒåŒ…å«ï¼š

1. **ç›®æ ‡ï¼ˆGoalï¼‰**ï¼šè¦å®ç°ä»€ä¹ˆ
2. **ä»»åŠ¡ï¼ˆTasksï¼‰**ï¼šéœ€è¦åšå“ªäº›äº‹
3. **ä¾èµ–ï¼ˆDependenciesï¼‰**ï¼šä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»
4. **ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰**ï¼šç›¸å…³çš„èƒŒæ™¯ä¿¡æ¯
5. **å†³ç­–ï¼ˆDecisionsï¼‰**ï¼šä¸ºä»€ä¹ˆè¿™æ ·åš

### Plan çš„ä¸¤ç§è¡¨ç¤ºæ–¹å¼

| æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **JSON** | ç»“æ„åŒ–ã€æ˜“è§£æã€ç±»å‹å®‰å…¨ | ä¸æ˜“äººå·¥ç¼–è¾‘ã€å¯è¯»æ€§å·® | ç¨‹åºå¤„ç†ã€è‡ªåŠ¨åŒ– |
| **Markdown** | å¯è¯»æ€§å¥½ã€æ˜“ç¼–è¾‘ã€æ”¯æŒå¯Œæ–‡æœ¬ | è§£æå¤æ‚ã€ç»“æ„æ¾æ•£ | äººå·¥é˜…è¯»ã€åä½œ |

---

## JSON æ ¼å¼çš„ Plan

### åŸºæœ¬ç»“æ„

```typescript
interface Plan {
  // å…ƒæ•°æ®
  id: string;
  createdAt: string;
  updatedAt: string;
  status: 'draft' | 'approved' | 'executing' | 'completed' | 'failed';

  // æ ¸å¿ƒå†…å®¹
  goal: string;
  context: string;
  tasks: Task[];
  dependencies: Dependency[];

  // æ‰§è¡Œä¿¡æ¯
  currentTask?: string;
  completedTasks: string[];
  failedTasks: string[];

  // å…ƒä¿¡æ¯
  metadata: Record<string, any>;
}

interface Task {
  id: string;
  title: string;
  description: string;
  status: 'pending' | 'in_progress' | 'completed' | 'failed';
  dependencies: string[]; // Task IDs
  estimatedComplexity?: 'low' | 'medium' | 'high';
  actualDuration?: number;
  notes?: string;
}

interface Dependency {
  from: string; // Task ID
  to: string;   // Task ID
  type: 'blocks' | 'requires' | 'suggests';
}
```

### å®Œæ•´ç¤ºä¾‹

```json
{
  "id": "plan-20260221-001",
  "createdAt": "2026-02-21T10:00:00Z",
  "updatedAt": "2026-02-21T10:30:00Z",
  "status": "approved",

  "goal": "å®ç°ç”¨æˆ·è®¤è¯ç³»ç»Ÿ",
  "context": "å½“å‰ç³»ç»Ÿæ²¡æœ‰è®¤è¯æœºåˆ¶ï¼Œéœ€è¦æ·»åŠ  JWT è®¤è¯",

  "tasks": [
    {
      "id": "task-001",
      "title": "è®¾è®¡æ•°æ®åº“ Schema",
      "description": "åˆ›å»º users è¡¨ï¼ŒåŒ…å« id, email, password_hash, created_at",
      "status": "completed",
      "dependencies": [],
      "estimatedComplexity": "low",
      "actualDuration": 1800
    },
    {
      "id": "task-002",
      "title": "å®ç°ç”¨æˆ·æ³¨å†Œ API",
      "description": "POST /api/auth/registerï¼Œæ¥æ”¶ email å’Œ password",
      "status": "in_progress",
      "dependencies": ["task-001"],
      "estimatedComplexity": "medium"
    },
    {
      "id": "task-003",
      "title": "å®ç°ç”¨æˆ·ç™»å½• API",
      "description": "POST /api/auth/loginï¼Œè¿”å› JWT token",
      "status": "pending",
      "dependencies": ["task-001"],
      "estimatedComplexity": "medium"
    },
    {
      "id": "task-004",
      "title": "å®ç° JWT éªŒè¯ä¸­é—´ä»¶",
      "description": "éªŒè¯è¯·æ±‚å¤´ä¸­çš„ JWT token",
      "status": "pending",
      "dependencies": ["task-003"],
      "estimatedComplexity": "high"
    }
  ],

  "dependencies": [
    {
      "from": "task-001",
      "to": "task-002",
      "type": "blocks"
    },
    {
      "from": "task-001",
      "to": "task-003",
      "type": "blocks"
    },
    {
      "from": "task-003",
      "to": "task-004",
      "type": "requires"
    }
  ],

  "currentTask": "task-002",
  "completedTasks": ["task-001"],
  "failedTasks": [],

  "metadata": {
    "author": "pi-agent",
    "project": "auth-system",
    "priority": "high",
    "tags": ["authentication", "security", "jwt"]
  }
}
```

### JSON æ ¼å¼çš„ä¼˜åŠ¿

1. **ç»“æ„åŒ–**ï¼šä¸¥æ ¼çš„æ•°æ®ç»“æ„ï¼Œæ˜“äºéªŒè¯
2. **å¯è§£æ**ï¼šç¨‹åºå¯ä»¥ç›´æ¥è§£æå’Œå¤„ç†
3. **ç±»å‹å®‰å…¨**ï¼šé…åˆ TypeScript æ¥å£ï¼Œç±»å‹å®‰å…¨
4. **æ˜“äºæŸ¥è¯¢**ï¼šå¯ä»¥ç”¨ jq ç­‰å·¥å…·æŸ¥è¯¢
5. **ç‰ˆæœ¬æ§åˆ¶å‹å¥½**ï¼šGit diff å¯ä»¥æ¸…æ™°æ˜¾ç¤ºå˜åŒ–

### JSON æ ¼å¼çš„åŠ£åŠ¿

1. **å¯è¯»æ€§å·®**ï¼šäººå·¥é˜…è¯»å›°éš¾
2. **ç¼–è¾‘ä¸ä¾¿**ï¼šéœ€è¦æ³¨æ„è¯­æ³•ï¼Œå®¹æ˜“å‡ºé”™
3. **ç¼ºä¹å¯Œæ–‡æœ¬**ï¼šæ— æ³•ä½¿ç”¨ Markdown æ ¼å¼åŒ–
4. **å†—é•¿**ï¼šåŒ…å«å¤§é‡ç»“æ„åŒ–ä¿¡æ¯

---

## Markdown æ ¼å¼çš„ Plan

### åŸºæœ¬ç»“æ„

```markdown
# Plan: [Plan Title]

**ID**: plan-20260221-001
**Created**: 2026-02-21 10:00:00
**Status**: approved

## Goal

[Clear statement of what we want to achieve]

## Context

[Background information, constraints, assumptions]

## Tasks

### Task 1: [Task Title]
**ID**: task-001
**Status**: completed
**Dependencies**: none
**Complexity**: low

[Detailed description of the task]

**Notes**:
- [Any relevant notes]

### Task 2: [Task Title]
**ID**: task-002
**Status**: in_progress
**Dependencies**: task-001
**Complexity**: medium

[Detailed description of the task]

## Dependencies

```mermaid
graph TD
    task-001 --> task-002
    task-001 --> task-003
    task-003 --> task-004
```

## Execution Log

- [2026-02-21 10:00] Created plan
- [2026-02-21 10:15] Completed task-001
- [2026-02-21 10:30] Started task-002

## Metadata

- **Author**: pi-agent
- **Project**: auth-system
- **Priority**: high
- **Tags**: authentication, security, jwt
```

### å®Œæ•´ç¤ºä¾‹

```markdown
# Plan: å®ç°ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

**ID**: plan-20260221-001
**Created**: 2026-02-21 10:00:00
**Updated**: 2026-02-21 10:30:00
**Status**: approved

## Goal

å®ç°ä¸€ä¸ªåŸºäº JWT çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•å’Œ token éªŒè¯ã€‚

## Context

å½“å‰ç³»ç»Ÿæ²¡æœ‰è®¤è¯æœºåˆ¶ï¼Œæ‰€æœ‰ API éƒ½æ˜¯å…¬å¼€çš„ã€‚éœ€è¦æ·»åŠ è®¤è¯ç³»ç»Ÿä»¥ä¿æŠ¤æ•æ„Ÿæ•°æ®ã€‚

**æŠ€æœ¯æ ˆ**:
- Backend: Node.js + Express
- Database: PostgreSQL
- Auth: JWT (jsonwebtoken)
- Password: bcrypt

**çº¦æŸ**:
- Token æœ‰æ•ˆæœŸ: 24 å°æ—¶
- å¯†ç æœ€å°é•¿åº¦: 8 å­—ç¬¦
- éœ€è¦æ”¯æŒ refresh token

## Tasks

### Task 1: è®¾è®¡æ•°æ®åº“ Schema
**ID**: task-001
**Status**: âœ… completed
**Dependencies**: none
**Complexity**: low
**Duration**: 30 minutes

åˆ›å»º `users` è¡¨ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- `id`: UUID, primary key
- `email`: VARCHAR(255), unique, not null
- `password_hash`: VARCHAR(255), not null
- `created_at`: TIMESTAMP, default now()
- `updated_at`: TIMESTAMP, default now()

**SQL**:
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Notes**:
- ä½¿ç”¨ UUID è€Œéè‡ªå¢ IDï¼Œæ›´å®‰å…¨
- email å­—æ®µæ·»åŠ å”¯ä¸€ç´¢å¼•
- å¯†ç ä½¿ç”¨ bcrypt hashï¼Œä¸å­˜å‚¨æ˜æ–‡

---

### Task 2: å®ç°ç”¨æˆ·æ³¨å†Œ API
**ID**: task-002
**Status**: ğŸ”„ in_progress
**Dependencies**: task-001
**Complexity**: medium
**Estimated Duration**: 1 hour

å®ç° `POST /api/auth/register` ç«¯ç‚¹ï¼š

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Response** (Success):
```json
{
  "success": true,
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}
```

**Response** (Error):
```json
{
  "success": false,
  "error": "Email already exists"
}
```

**Validation**:
- Email æ ¼å¼éªŒè¯
- å¯†ç é•¿åº¦ >= 8
- Email å”¯ä¸€æ€§æ£€æŸ¥

**Implementation Steps**:
1. åˆ›å»º `src/routes/auth.ts`
2. æ·»åŠ  email éªŒè¯ä¸­é—´ä»¶
3. ä½¿ç”¨ bcrypt hash å¯†ç 
4. æ’å…¥æ•°æ®åº“
5. è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰

---

### Task 3: å®ç°ç”¨æˆ·ç™»å½• API
**ID**: task-003
**Status**: â³ pending
**Dependencies**: task-001
**Complexity**: medium
**Estimated Duration**: 1 hour

å®ç° `POST /api/auth/login` ç«¯ç‚¹ï¼š

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Response** (Success):
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}
```

**JWT Payload**:
```json
{
  "userId": "uuid",
  "email": "user@example.com",
  "iat": 1234567890,
  "exp": 1234654290
}
```

**Implementation Steps**:
1. æŸ¥è¯¢ç”¨æˆ·
2. éªŒè¯å¯†ç ï¼ˆbcrypt.compareï¼‰
3. ç”Ÿæˆ JWT token
4. è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯

---

### Task 4: å®ç° JWT éªŒè¯ä¸­é—´ä»¶
**ID**: task-004
**Status**: â³ pending
**Dependencies**: task-003
**Complexity**: high
**Estimated Duration**: 1.5 hours

å®ç° `authenticateToken` ä¸­é—´ä»¶ï¼ŒéªŒè¯è¯·æ±‚å¤´ä¸­çš„ JWT tokenã€‚

**Usage**:
```typescript
app.get('/api/protected', authenticateToken, (req, res) => {
  // req.user åŒ…å«è§£ç åçš„ç”¨æˆ·ä¿¡æ¯
  res.json({ message: 'Protected data', user: req.user });
});
```

**Implementation Steps**:
1. ä» `Authorization` header æå– token
2. éªŒè¯ token ç­¾å
3. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
4. å°†è§£ç åçš„ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ° `req.user`
5. å¤„ç†å„ç§é”™è¯¯æƒ…å†µ

**Error Handling**:
- 401: Token missing
- 401: Token invalid
- 401: Token expired
- 403: Insufficient permissions

## Dependencies

```mermaid
graph TD
    task-001[Task 1: è®¾è®¡æ•°æ®åº“ Schema] --> task-002[Task 2: ç”¨æˆ·æ³¨å†Œ API]
    task-001 --> task-003[Task 3: ç”¨æˆ·ç™»å½• API]
    task-003 --> task-004[Task 4: JWT éªŒè¯ä¸­é—´ä»¶]

    style task-001 fill:#90EE90
    style task-002 fill:#FFD700
    style task-003 fill:#D3D3D3
    style task-004 fill:#D3D3D3
```

**Legend**:
- ğŸŸ¢ Green: Completed
- ğŸŸ¡ Yellow: In Progress
- âšª Gray: Pending

## Execution Log

- **[2026-02-21 10:00]** Created plan
- **[2026-02-21 10:15]** Completed task-001 (è®¾è®¡æ•°æ®åº“ Schema)
  - Created `users` table
  - Added indexes
- **[2026-02-21 10:30]** Started task-002 (ç”¨æˆ·æ³¨å†Œ API)
  - Created `src/routes/auth.ts`
  - Implemented email validation

## Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| å¯†ç å­˜å‚¨ä¸å®‰å…¨ | High | ä½¿ç”¨ bcryptï¼Œsalt rounds >= 10 |
| JWT secret æ³„éœ² | High | ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå®šæœŸè½®æ¢ |
| Token è¿‡æœŸå¤„ç† | Medium | å®ç° refresh token æœºåˆ¶ |
| SQL æ³¨å…¥ | High | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ |

## Testing Strategy

1. **Unit Tests**:
   - Password hashing
   - JWT generation/verification
   - Email validation

2. **Integration Tests**:
   - Register flow
   - Login flow
   - Protected route access

3. **Security Tests**:
   - SQL injection attempts
   - XSS attempts
   - Brute force protection

## Metadata

- **Author**: pi-agent
- **Project**: auth-system
- **Priority**: high
- **Tags**: authentication, security, jwt, express, postgresql
- **Estimated Total Duration**: 4 hours
- **Actual Duration**: TBD
```

### Markdown æ ¼å¼çš„ä¼˜åŠ¿

1. **å¯è¯»æ€§å¥½**ï¼šäººå·¥é˜…è¯»å‹å¥½
2. **æ˜“äºç¼–è¾‘**ï¼šä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨éƒ½å¯ä»¥ç¼–è¾‘
3. **å¯Œæ–‡æœ¬æ”¯æŒ**ï¼šæ”¯æŒä»£ç å—ã€è¡¨æ ¼ã€å›¾è¡¨
4. **åä½œå‹å¥½**ï¼šå›¢é˜Ÿæˆå‘˜å¯ä»¥ç›´æ¥ç¼–è¾‘
5. **ç‰ˆæœ¬æ§åˆ¶å‹å¥½**ï¼šGit diff æ¸…æ™°å¯è¯»

### Markdown æ ¼å¼çš„åŠ£åŠ¿

1. **ç»“æ„æ¾æ•£**ï¼šæ²¡æœ‰ä¸¥æ ¼çš„æ•°æ®ç»“æ„
2. **è§£æå¤æ‚**ï¼šéœ€è¦è‡ªå®šä¹‰è§£æå™¨
3. **ç±»å‹ä¸å®‰å…¨**ï¼šæ— æ³•ä¿è¯æ•°æ®ç±»å‹
4. **æŸ¥è¯¢å›°éš¾**ï¼šæ— æ³•ç”¨å·¥å…·ç›´æ¥æŸ¥è¯¢

---

## æ–‡ä»¶å­˜å‚¨æ¨¡å¼

### æ¨¡å¼ 1ï¼šå•æ–‡ä»¶å­˜å‚¨

**ç»“æ„**:
```
.pi/
â””â”€â”€ plan.md  # æˆ– plan.json
```

**ä¼˜åŠ¿**:
- ç®€å•ç›´æ¥
- æ˜“äºæŸ¥æ‰¾
- é€‚åˆå°å‹é¡¹ç›®

**åŠ£åŠ¿**:
- åªèƒ½å­˜å‚¨ä¸€ä¸ªè®¡åˆ’
- å†å²è®°å½•éœ€è¦ä¾èµ– Git

**é€‚ç”¨åœºæ™¯**:
- ç®€å•ä»»åŠ¡
- å•äººå¼€å‘
- å¿«é€ŸåŸå‹

### æ¨¡å¼ 2ï¼šå¤šæ–‡ä»¶å­˜å‚¨

**ç»“æ„**:
```
.pi/plans/
â”œâ”€â”€ plan-20260221-001.md
â”œâ”€â”€ plan-20260221-002.md
â””â”€â”€ plan-20260221-003.md
```

**ä¼˜åŠ¿**:
- å¯ä»¥å­˜å‚¨å¤šä¸ªè®¡åˆ’
- å†å²è®°å½•æ¸…æ™°
- æ˜“äºç®¡ç†

**åŠ£åŠ¿**:
- éœ€è¦ç®¡ç†æ–‡ä»¶å‘½å
- éœ€è¦ç´¢å¼•æœºåˆ¶

**é€‚ç”¨åœºæ™¯**:
- å¤æ‚é¡¹ç›®
- å¤šä¸ªå¹¶è¡Œä»»åŠ¡
- å›¢é˜Ÿåä½œ

### æ¨¡å¼ 3ï¼šåˆ†å±‚å­˜å‚¨

**ç»“æ„**:
```
.pi/
â”œâ”€â”€ plans/
â”‚   â”œâ”€â”€ active/
â”‚   â”‚   â””â”€â”€ plan-current.md
â”‚   â”œâ”€â”€ completed/
â”‚   â”‚   â”œâ”€â”€ plan-20260220-001.md
â”‚   â”‚   â””â”€â”€ plan-20260220-002.md
â”‚   â””â”€â”€ archived/
â”‚       â””â”€â”€ plan-20260219-001.md
â””â”€â”€ index.json  # ç´¢å¼•æ–‡ä»¶
```

**ä¼˜åŠ¿**:
- æ¸…æ™°çš„çŠ¶æ€ç®¡ç†
- æ˜“äºæŸ¥æ‰¾
- æ”¯æŒå½’æ¡£

**åŠ£åŠ¿**:
- ç»“æ„å¤æ‚
- éœ€è¦ç»´æŠ¤ç´¢å¼•

**é€‚ç”¨åœºæ™¯**:
- å¤§å‹é¡¹ç›®
- é•¿æœŸç»´æŠ¤
- ä¼ä¸šçº§åº”ç”¨

### æ¨¡å¼ 4ï¼šæ··åˆå­˜å‚¨

**ç»“æ„**:
```
.pi/
â”œâ”€â”€ plans/
â”‚   â”œâ”€â”€ plan-20260221-001/
â”‚   â”‚   â”œâ”€â”€ plan.md          # ä¸»è®¡åˆ’æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ metadata.json    # å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ tasks/           # ä»»åŠ¡è¯¦æƒ…
â”‚   â”‚   â”‚   â”œâ”€â”€ task-001.md
â”‚   â”‚   â”‚   â””â”€â”€ task-002.md
â”‚   â”‚   â””â”€â”€ logs/            # æ‰§è¡Œæ—¥å¿—
â”‚   â”‚       â””â”€â”€ execution.log
â”‚   â””â”€â”€ plan-20260221-002/
â”‚       â””â”€â”€ ...
â””â”€â”€ index.json
```

**ä¼˜åŠ¿**:
- æœ€å¤§çµæ´»æ€§
- æ”¯æŒå¤æ‚ç»“æ„
- æ˜“äºæ‰©å±•

**åŠ£åŠ¿**:
- æœ€å¤æ‚
- éœ€è¦å®Œå–„çš„ç®¡ç†å·¥å…·

**é€‚ç”¨åœºæ™¯**:
- è¶…å¤§å‹é¡¹ç›®
- å¤æ‚ä¾èµ–å…³ç³»
- éœ€è¦è¯¦ç»†å®¡è®¡

---

## æ–‡ä»¶å‘½åè§„èŒƒ

### å‘½åæ¨¡å¼

```
plan-[date]-[sequence]-[optional-slug].md
```

**ç¤ºä¾‹**:
```
plan-20260221-001-auth-system.md
plan-20260221-002-api-refactor.md
plan-20260221-003.md
```

### å‘½åè§„åˆ™

1. **å‰ç¼€**: ç»Ÿä¸€ä½¿ç”¨ `plan-`
2. **æ—¥æœŸ**: YYYYMMDD æ ¼å¼
3. **åºå·**: 3 ä½æ•°å­—ï¼Œä» 001 å¼€å§‹
4. **Slug**: å¯é€‰ï¼Œç®€çŸ­æè¿°ï¼ˆkebab-caseï¼‰
5. **æ‰©å±•å**: `.md` æˆ– `.json`

---

## æ–‡ä»¶è¯»å†™æ“ä½œ

### å†™å…¥ Planï¼ˆTypeScriptï¼‰

```typescript
import { writeFile } from 'fs/promises';
import { join } from 'path';

interface WritePlanOptions {
  format: 'json' | 'markdown';
  directory?: string;
}

async function writePlan(
  plan: Plan,
  options: WritePlanOptions = { format: 'markdown' }
): Promise<string> {
  const { format, directory = '.pi/plans' } = options;

  // ç”Ÿæˆæ–‡ä»¶å
  const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
  const filename = `plan-${timestamp}-${plan.id}.${format === 'json' ? 'json' : 'md'}`;
  const filepath = join(directory, filename);

  // ç”Ÿæˆå†…å®¹
  const content = format === 'json'
    ? JSON.stringify(plan, null, 2)
    : convertPlanToMarkdown(plan);

  // å†™å…¥æ–‡ä»¶
  await writeFile(filepath, content, 'utf-8');

  return filepath;
}

function convertPlanToMarkdown(plan: Plan): string {
  return `# Plan: ${plan.goal}

**ID**: ${plan.id}
**Created**: ${plan.createdAt}
**Status**: ${plan.status}

## Goal

${plan.goal}

## Context

${plan.context}

## Tasks

${plan.tasks.map(task => `
### Task ${task.id}: ${task.title}
**Status**: ${task.status}
**Dependencies**: ${task.dependencies.join(', ') || 'none'}

${task.description}
`).join('\n')}

## Metadata

${Object.entries(plan.metadata).map(([key, value]) => `- **${key}**: ${value}`).join('\n')}
`;
}
```

### è¯»å– Planï¼ˆTypeScriptï¼‰

```typescript
import { readFile } from 'fs/promises';

async function readPlan(filepath: string): Promise<Plan> {
  const content = await readFile(filepath, 'utf-8');

  if (filepath.endsWith('.json')) {
    return JSON.parse(content) as Plan;
  } else {
    return parseMarkdownPlan(content);
  }
}

function parseMarkdownPlan(content: string): Plan {
  // ç®€åŒ–çš„ Markdown è§£æå™¨
  const lines = content.split('\n');

  // æå–å…ƒæ•°æ®
  const idMatch = content.match(/\*\*ID\*\*:\s*(.+)/);
  const statusMatch = content.match(/\*\*Status\*\*:\s*(.+)/);

  // æå– Goal
  const goalMatch = content.match(/## Goal\n\n(.+)/);

  // æå– Tasksï¼ˆç®€åŒ–ç‰ˆï¼‰
  const tasks: Task[] = [];
  const taskMatches = content.matchAll(/### Task (.+?): (.+)/g);
  for (const match of taskMatches) {
    tasks.push({
      id: match[1],
      title: match[2],
      description: '',
      status: 'pending',
      dependencies: []
    });
  }

  return {
    id: idMatch?.[1] || '',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    status: (statusMatch?.[1] as any) || 'draft',
    goal: goalMatch?.[1] || '',
    context: '',
    tasks,
    dependencies: [],
    completedTasks: [],
    failedTasks: [],
    metadata: {}
  };
}
```

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æ ¼å¼

| åœºæ™¯ | æ¨èæ ¼å¼ | åŸå›  |
|------|---------|------|
| äººå·¥é˜…è¯»å’Œç¼–è¾‘ | Markdown | å¯è¯»æ€§å¥½ |
| ç¨‹åºè‡ªåŠ¨å¤„ç† | JSON | æ˜“è§£æ |
| å›¢é˜Ÿåä½œ | Markdown | æ˜“äº review |
| å¤æ‚ä¾èµ–å…³ç³» | JSON | ç»“æ„åŒ– |

### 2. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶

```bash
# å°† .pi/ ç›®å½•çº³å…¥ Git
git add .pi/plans/
git commit -m "Add implementation plan for auth system"
```

### 3. æ·»åŠ ç´¢å¼•æ–‡ä»¶

```json
{
  "plans": [
    {
      "id": "plan-20260221-001",
      "file": "plans/plan-20260221-001-auth-system.md",
      "status": "in_progress",
      "createdAt": "2026-02-21T10:00:00Z"
    }
  ]
}
```

### 4. å®šæœŸå½’æ¡£

```bash
# å°†å®Œæˆçš„è®¡åˆ’ç§»åˆ°å½’æ¡£ç›®å½•
mv .pi/plans/active/plan-*.md .pi/plans/completed/
```

### 5. ä½¿ç”¨æ¨¡æ¿

åˆ›å»º `.pi/templates/plan-template.md`:

```markdown
# Plan: [Title]

**ID**: [auto-generated]
**Created**: [auto-generated]
**Status**: draft

## Goal

[What do you want to achieve?]

## Context

[Background, constraints, assumptions]

## Tasks

### Task 1: [Title]
**Status**: pending
**Dependencies**: none

[Description]

## Metadata

- **Author**: [Your name]
- **Priority**: [low/medium/high]
```

---

## å‚è€ƒèµ„æº

### å®˜æ–¹èµ„æº

- [Pi-mono GitHub](https://github.com/badlogic/pi-mono)
- [Extension API Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md)

### ç ”ç©¶èµ„æ–™

- `temp/03_grok_pi_mono_extensions.md` - Pi-mono æ‰©å±• API
- `temp/04_grok_pi_mono_examples.md` - Pi-mono æ‰©å±•ç¤ºä¾‹

---

## ä¸‹ä¸€æ­¥

- **03_æ ¸å¿ƒæ¦‚å¿µ_02_Extension_APIé›†æˆ.md**ï¼šå­¦ä¹ å¦‚ä½•é€šè¿‡æ‰©å±• API å®ç° Plan Mode
- **07_å®æˆ˜ä»£ç _01_æ–‡ä»¶å¼è®¡åˆ’.md**ï¼šæŸ¥çœ‹å®Œæ•´çš„æ–‡ä»¶å¼è§„åˆ’ä»£ç ç¤ºä¾‹
