# 实战代码3：语义分块实现

完整可运行的语义分块代码示例（基于 embedding 相似度）。

---

## LangChain 实现

```python
"""
语义分块 - LangChain 实现
"""

from langchain_experimental.text_splitter import SemanticChunker
from langchain_openai import OpenAIEmbeddings

# 创建语义分块器
embeddings = OpenAIEmbeddings(model="text-embedding-3-small")

semantic_splitter = SemanticChunker(
    embeddings=embeddings,
    breakpoint_threshold_type="percentile",
    breakpoint_threshold_amount=95,  # 95% 分位数
)

text = """
Python是一种编程语言。它简单易学。Python支持多种编程范式。

机器学习是AI的分支。深度学习很流行。神经网络是核心技术。
"""

chunks = semantic_splitter.split_text(text)

for i, chunk in enumerate(chunks):
    print(f"Chunk {i+1}: {chunk}")
```

---

## 成本效益分析（2025-2026）

```python
"""
对比语义分块与递归分块的成本效益
"""

import time
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_experimental.text_splitter import SemanticChunker
from langchain_openai import OpenAIEmbeddings

text = "Python编程..." * 1000  # 约10万字符

# 方案1：递归分块（无成本）
start = time.time()
recursive_splitter = RecursiveCharacterTextSplitter(
    chunk_size=512,
    chunk_overlap=77
)
recursive_chunks = recursive_splitter.split_text(text)
recursive_time = time.time() - start

print(f"递归分块:")
print(f"  块数: {len(recursive_chunks)}")
print(f"  耗时: {recursive_time:.2f}s")
print(f"  成本: $0")

# 方案2：语义分块（高成本）
start = time.time()
embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
semantic_splitter = SemanticChunker(embeddings=embeddings)
semantic_chunks = semantic_splitter.split_text(text)
semantic_time = time.time() - start

# 估算成本（假设2000个句子，每个50 tokens）
estimated_cost = (2000 * 50 / 1000000) * 0.02  # $0.02 per 1M tokens

print(f"\n语义分块:")
print(f"  块数: {len(semantic_chunks)}")
print(f"  耗时: {semantic_time:.2f}s")
print(f"  成本: ${estimated_cost:.4f}")

print(f"\n结论:")
print(f"  准确率提升: ~2-3%")
print(f"  成本增加: {estimated_cost / 0.0001 if estimated_cost > 0 else 'N/A'}x")
print(f"  推荐: 递归分块 + 上下文感知（性价比更高）")
```

---

## 核心研究来源

**Anthropic 2024-2025**: 递归分块 + 上下文感知 > 语义分块（性价比）

---

**下一步：** [07_实战代码_04_代理式分块实现](./07_实战代码_04_代理式分块实现.md)
