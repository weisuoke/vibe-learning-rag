# 最小可用

掌握以下内容，就能开始使用 SQLAlchemy ORM：

## 4.1 安装和配置

```bash
# 安装 SQLAlchemy 和 PostgreSQL 驱动
uv add sqlalchemy psycopg2-binary
```

```python
# 创建数据库引擎
from sqlalchemy import create_engine

DATABASE_URL = "postgresql://user:password@localhost:5432/dbname"
engine = create_engine(DATABASE_URL, echo=True)  # echo=True 打印 SQL
```

**这能做什么：** 连接到 PostgreSQL 数据库

---

## 4.2 定义模型（声明式）

```python
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import declarative_base

# 创建基类
Base = declarative_base()

# 定义模型
class User(Base):
    __tablename__ = "users"  # 表名

    id = Column(Integer, primary_key=True)  # 主键
    name = Column(String(50), nullable=False)  # 非空字符串
    email = Column(String(100), unique=True)  # 唯一邮箱

# 创建所有表
Base.metadata.create_all(engine)
```

**这能做什么：** 用 Python 类定义数据库表结构

**类比前端：** 就像 TypeScript 的 interface，定义数据结构

---

## 4.3 创建 Session（会话）

```python
from sqlalchemy.orm import sessionmaker

# 创建 Session 工厂
SessionLocal = sessionmaker(bind=engine)

# 创建 Session 实例
session = SessionLocal()

# 使用完后关闭
session.close()

# 推荐：使用上下文管理器
with SessionLocal() as session:
    # 在这里操作数据库
    pass
# 自动关闭
```

**这能做什么：** 管理数据库操作的生命周期

**类比前端：** 就像 HTTP 请求的上下文，操作完自动清理

---

## 4.4 基本 CRUD 操作

### Create（创建）

```python
# 创建对象
user = User(name="Alice", email="alice@example.com")

# 添加到 Session
session.add(user)

# 提交到数据库
session.commit()

# 刷新对象，获取数据库生成的 ID
session.refresh(user)
print(user.id)  # 1
```

### Read（查询）

```python
# 查询所有用户
users = session.query(User).all()

# 查询第一个用户
user = session.query(User).first()

# 按条件查询
user = session.query(User).filter(User.email == "alice@example.com").first()

# 按 ID 查询
user = session.query(User).get(1)
```

### Update（更新）

```python
# 查询用户
user = session.query(User).filter(User.id == 1).first()

# 修改属性
user.name = "Alice Smith"

# 提交更改
session.commit()
```

### Delete（删除）

```python
# 查询用户
user = session.query(User).filter(User.id == 1).first()

# 删除
session.delete(user)

# 提交
session.commit()
```

**这能做什么：** 完成所有基本数据库操作

**类比前端：** 就像 Prisma 的 create/findMany/update/delete

---

## 4.5 在 FastAPI 中使用（依赖注入）

```python
from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session

app = FastAPI()

# 依赖函数：获取数据库 Session
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# 在路由中使用
@app.get("/users")
def get_users(db: Session = Depends(get_db)):
    users = db.query(User).all()
    return users

@app.post("/users")
def create_user(name: str, email: str, db: Session = Depends(get_db)):
    user = User(name=name, email=email)
    db.add(user)
    db.commit()
    db.refresh(user)
    return user
```

**这能做什么：** 在 FastAPI 中正确管理数据库连接

**类比前端：** 就像 Express 的中间件，每个请求自动注入数据库连接

---

## 这些知识足以：

- ✅ 定义数据模型（User、Product、Order 等）
- ✅ 执行基本的 CRUD 操作
- ✅ 在 FastAPI 中集成数据库
- ✅ 开始构建 AI Agent 的数据层（用户、对话、消息）
- ✅ 为后续学习关系映射、事务管理打基础

---

## 快速上手检查清单

- [ ] 安装 SQLAlchemy 和数据库驱动
- [ ] 创建数据库引擎
- [ ] 定义至少一个模型类
- [ ] 创建 Session 并执行 CRUD 操作
- [ ] 在 FastAPI 中使用依赖注入

---

## 下一步学习

掌握了最小可用知识后，可以学习：
- **Session 管理**：事务、回滚、连接池
- **关系定义**：一对多、多对多关系
- **高级查询**：JOIN、聚合、子查询
- **数据库迁移**：Alembic 版本控制

---

**记住：** 这 5 个知识点是 SQLAlchemy 的核心，掌握它们就能开始实际开发。
