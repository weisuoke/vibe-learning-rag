# 实战代码 01：快速开始场景

> 5 个完整的快速开始场景，从安装到日常使用

---

## 场景 1：首次安装与配置

### 目标

从零开始安装 Pi，配置 API 密钥，完成首次对话。

### 步骤

```bash
# 1. 全局安装 Pi
npm install -g @mariozechner/pi-coding-agent

# 2. 验证安装
pi --version
# 输出: 0.52.12

# 3. 配置 API 密钥（方式 1：环境变量）
export ANTHROPIC_API_KEY=sk-ant-api03-...

# 4. 启动 Pi
pi
```

### 预期输出

```
┌─────────────────────────────────────────────────────────┐
│ Pi Coding Agent v0.52.12                                │
│ Type /help for available commands                       │
└─────────────────────────────────────────────────────────┘

claude-opus-4 | new-session | 0 tokens

>
```

### 首次对话

```bash
> 你好，请介绍一下你自己

AI: 你好！我是 Pi Coding Agent，一个基于 Claude 的 AI 编码助手。

我可以帮你：
1. 编写和修改代码
2. 解释复杂的技术概念
3. 审查代码质量
4. 修复 bug
5. 设计系统架构

我支持多种编程语言，特别擅长 TypeScript、Python、JavaScript 等。

你可以使用 @文件引用 来让我查看你的代码，或者使用 !命令 来执行命令并让我分析输出。

有什么我可以帮你的吗？
```

### 配置项目设置

```bash
# 5. 创建项目配置
mkdir -p .pi
cat > .pi/settings.json << 'EOF'
{
  "defaultModel": "claude-opus-4",
  "scopedModels": [
    "claude-opus-4",
    "claude-sonnet-4",
    "claude-haiku-4"
  ],
  "editor": {
    "multilineKey": "shift+enter",
    "tabCompletion": true
  }
}
EOF

# 6. 重启 Pi 应用配置
pi
```

---

## 场景 2：代码生成与文件操作

### 目标

使用 Pi 生成代码并保存到文件。

### 对话流程

```bash
> 请帮我写一个 TypeScript 函数，计算斐波那契数列的第 n 项

AI: 好的，我来写一个高效的斐波那契函数：

[Tool: write] src/fibonacci.ts
```

### 生成的代码

```typescript
/**
 * 计算斐波那契数列的第 n 项
 * 使用动态规划优化，时间复杂度 O(n)，空间复杂度 O(1)
 */
export function fibonacci(n: number): number {
  if (n <= 0) {
    throw new Error('n must be a positive integer');
  }

  if (n === 1 || n === 2) {
    return 1;
  }

  let prev = 1;
  let curr = 1;

  for (let i = 3; i <= n; i++) {
    const next = prev + curr;
    prev = curr;
    curr = next;
  }

  return curr;
}

// 示例用法
if (require.main === module) {
  console.log('Fibonacci(10):', fibonacci(10));  // 55
  console.log('Fibonacci(20):', fibonacci(20));  // 6765
}
```

### AI 响应

```
AI: 我创建了一个高效的斐波那契函数：

特点：
1. 使用动态规划，避免递归的指数级时间复杂度
2. 空间复杂度 O(1)，只使用两个变量
3. 包含输入验证
4. 添加了示例用法

你可以运行测试：
!npx ts-node src/fibonacci.ts
```

### 测试代码

```bash
> !npx ts-node src/fibonacci.ts

[Command: npx ts-node src/fibonacci.ts]
Fibonacci(10): 55
Fibonacci(20): 6765

> 很好！请添加单元测试

AI: 好的，我来添加测试：

[Tool: write] src/fibonacci.test.ts
```

### 测试文件

```typescript
import { fibonacci } from './fibonacci';

describe('fibonacci', () => {
  test('should return 1 for n=1', () => {
    expect(fibonacci(1)).toBe(1);
  });

  test('should return 1 for n=2', () => {
    expect(fibonacci(2)).toBe(1);
  });

  test('should return correct value for n=10', () => {
    expect(fibonacci(10)).toBe(55);
  });

  test('should return correct value for n=20', () => {
    expect(fibonacci(20)).toBe(6765);
  });

  test('should throw error for n<=0', () => {
    expect(() => fibonacci(0)).toThrow('n must be a positive integer');
    expect(() => fibonacci(-1)).toThrow('n must be a positive integer');
  });

  test('should handle large numbers', () => {
    expect(fibonacci(30)).toBe(832040);
  });
});
```

---

## 场景 3：Bug 修复工作流

### 目标

使用 Pi 分析测试失败并修复 bug。

### 初始状态

```bash
# 运行测试
> !npm test

[Command: npm test]
FAIL src/auth.test.ts
  ● authenticate › should reject invalid tokens

    expect(received).toBe(expected)

    Expected: false
    Received: true

      42 |   it('should reject invalid tokens', () => {
      43 |     const result = authenticate('invalid');
    > 44 |     expect(result).toBe(false);
         |                    ^
      45 |   });

Tests: 1 failed, 5 passed, 6 total
```

### 分析与修复

```bash
> 请分析这个测试失败的原因，并修复 bug

AI: 让我先查看 authenticate 函数的实现：

[Tool: read] src/auth.ts

AI: 我发现了问题。authenticate 函数没有正确验证 token 的格式。
当前代码：

```typescript
export function authenticate(token: string): boolean {
  if (!token) return false;
  // 缺少 token 格式验证
  return true;  // 总是返回 true！
}
```

问题：函数只检查 token 是否存在，但没有验证格式。

让我修复：

[Tool: edit] src/auth.ts
```

### 修复后的代码

```typescript
export function authenticate(token: string): boolean {
  if (!token) return false;

  // Token 格式验证：至少 32 个字符
  if (token.length < 32) return false;

  // Token 格式验证：只包含字母数字和连字符
  const tokenPattern = /^[a-zA-Z0-9-]+$/;
  if (!tokenPattern.test(token)) return false;

  // 这里应该调用实际的验证逻辑
  // 例如：验证 JWT 签名、检查数据库等
  return true;
}
```

### 验证修复

```bash
> !npm test

[Command: npm test]
PASS src/auth.test.ts
  ✓ authenticate › should accept valid tokens (2 ms)
  ✓ authenticate › should reject invalid tokens (1 ms)
  ✓ authenticate › should reject empty tokens (1 ms)
  ✓ authenticate › should reject short tokens (1 ms)
  ✓ authenticate › should reject tokens with special characters (1 ms)

Tests: 6 passed, 6 total

> 完美！请帮我提交这个修复

AI: 好的，让我创建一个 commit：

[Tool: bash] git add src/auth.ts
[Tool: bash] git commit -m "fix: validate token format in authenticate function

- Add minimum length check (32 characters)
- Add pattern validation (alphanumeric and hyphens only)
- Fixes test failure in auth.test.ts"

Commit created: a1b2c3d
```

---

## 场景 4：代码审查与重构

### 目标

使用 Pi 审查代码质量并提供重构建议。

### 代码审查

```bash
> 请审查 @src/api/users.ts 的代码质量

AI: 让我查看这个文件：

[Tool: read] src/api/users.ts

AI: 我发现了几个问题：

**问题 1：缺少错误处理**
```typescript
// 当前代码
export async function getUser(id: string) {
  const response = await fetch(`/api/users/${id}`);
  return response.json();  // 没有检查响应状态
}
```

**问题 2：硬编码的 API 端点**
```typescript
// 多处重复
fetch('/api/users/...')
fetch('/api/users/...')
```

**问题 3：缺少类型定义**
```typescript
// 返回类型是 any
export async function getUser(id: string) {
  // ...
}
```

**建议的重构：**

[Tool: edit] src/api/users.ts
```

### 重构后的代码

```typescript
// API 配置
const API_BASE_URL = process.env.API_BASE_URL || '/api';

// 类型定义
export interface User {
  id: string;
  name: string;
  email: string;
  createdAt: Date;
}

export interface ApiError {
  message: string;
  code: string;
  status: number;
}

// 通用 API 调用函数
async function apiCall<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

  if (!response.ok) {
    const error: ApiError = {
      message: await response.text(),
      code: 'API_ERROR',
      status: response.status
    };
    throw error;
  }

  return response.json();
}

// 用户 API
export async function getUser(id: string): Promise<User> {
  return apiCall<User>(`/users/${id}`);
}

export async function listUsers(): Promise<User[]> {
  return apiCall<User[]>('/users');
}

export async function createUser(data: Omit<User, 'id' | 'createdAt'>): Promise<User> {
  return apiCall<User>('/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
}

export async function updateUser(id: string, data: Partial<User>): Promise<User> {
  return apiCall<User>(`/users/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
}

export async function deleteUser(id: string): Promise<void> {
  await apiCall<void>(`/users/${id}`, {
    method: 'DELETE'
  });
}
```

### AI 总结

```
AI: 重构完成！改进点：

1. ✅ 添加了完整的错误处理
2. ✅ 提取了 API_BASE_URL 配置
3. ✅ 添加了 TypeScript 类型定义
4. ✅ 创建了通用的 apiCall 函数（DRY 原则）
5. ✅ 实现了完整的 CRUD 操作
6. ✅ 使用了 TypeScript 的高级类型（Omit、Partial）

代码质量显著提升！
```

---

## 场景 5：多文件项目搭建

### 目标

使用 Pi 快速搭建一个 Express API 项目。

### 项目初始化

```bash
> 请帮我创建一个 Express + TypeScript 的 API 项目，包含用户认证功能

AI: 好的，我来创建项目结构：

项目结构：
```
project/
├── src/
│   ├── index.ts          # 入口文件
│   ├── app.ts            # Express 应用
│   ├── routes/
│   │   ├── auth.ts       # 认证路由
│   │   └── users.ts      # 用户路由
│   ├── middleware/
│   │   └── auth.ts       # 认证中间件
│   ├── models/
│   │   └── user.ts       # 用户模型
│   └── utils/
│       └── jwt.ts        # JWT 工具
├── package.json
├── tsconfig.json
└── .env.example
```

让我逐个创建文件：

[Tool: write] package.json
```

### package.json

```json
{
  "name": "express-auth-api",
  "version": "1.0.0",
  "description": "Express API with TypeScript and JWT authentication",
  "main": "dist/index.js",
  "scripts": {
    "dev": "ts-node-dev --respawn src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "bcrypt": "^5.1.1",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/jsonwebtoken": "^9.0.5",
    "@types/bcrypt": "^5.0.2",
    "@types/node": "^20.10.0",
    "typescript": "^5.3.3",
    "ts-node-dev": "^2.0.0",
    "jest": "^29.7.0",
    "@types/jest": "^29.5.11"
  }
}
```

### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### src/index.ts

```typescript
import dotenv from 'dotenv';
import app from './app';

// 加载环境变量
dotenv.config();

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
```

### src/app.ts

```typescript
import express from 'express';
import authRoutes from './routes/auth';
import userRoutes from './routes/users';

const app = express();

// 中间件
app.use(express.json());

// 路由
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);

// 健康检查
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

export default app;
```

### src/models/user.ts

```typescript
export interface User {
  id: string;
  email: string;
  password: string;  // 哈希后的密码
  name: string;
  createdAt: Date;
}

// 简单的内存存储（生产环境应使用数据库）
export const users: User[] = [];

export function findUserByEmail(email: string): User | undefined {
  return users.find(u => u.email === email);
}

export function findUserById(id: string): User | undefined {
  return users.find(u => u.id === id);
}

export function createUser(user: User): User {
  users.push(user);
  return user;
}
```

### src/utils/jwt.ts

```typescript
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

export interface TokenPayload {
  userId: string;
  email: string;
}

export function generateToken(payload: TokenPayload): string {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: '7d' });
}

export function verifyToken(token: string): TokenPayload {
  return jwt.verify(token, JWT_SECRET) as TokenPayload;
}
```

### src/middleware/auth.ts

```typescript
import { Request, Response, NextFunction } from 'express';
import { verifyToken } from '../utils/jwt';

export interface AuthRequest extends Request {
  user?: {
    userId: string;
    email: string;
  };
}

export function authMiddleware(
  req: AuthRequest,
  res: Response,
  next: NextFunction
) {
  const authHeader = req.headers.authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'No token provided' });
  }

  const token = authHeader.substring(7);

  try {
    const payload = verifyToken(token);
    req.user = payload;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
}
```

### src/routes/auth.ts

```typescript
import { Router } from 'express';
import bcrypt from 'bcrypt';
import { v4 as uuidv4 } from 'uuid';
import { createUser, findUserByEmail } from '../models/user';
import { generateToken } from '../utils/jwt';

const router = Router();

// 注册
router.post('/register', async (req, res) => {
  const { email, password, name } = req.body;

  // 验证输入
  if (!email || !password || !name) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // 检查用户是否已存在
  if (findUserByEmail(email)) {
    return res.status(400).json({ error: 'User already exists' });
  }

  // 哈希密码
  const hashedPassword = await bcrypt.hash(password, 10);

  // 创建用户
  const user = createUser({
    id: uuidv4(),
    email,
    password: hashedPassword,
    name,
    createdAt: new Date()
  });

  // 生成 token
  const token = generateToken({ userId: user.id, email: user.email });

  res.status(201).json({
    user: {
      id: user.id,
      email: user.email,
      name: user.name
    },
    token
  });
});

// 登录
router.post('/login', async (req, res) => {
  const { email, password } = req.body;

  // 验证输入
  if (!email || !password) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // 查找用户
  const user = findUserByEmail(email);
  if (!user) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }

  // 验证密码
  const isValid = await bcrypt.compare(password, user.password);
  if (!isValid) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }

  // 生成 token
  const token = generateToken({ userId: user.id, email: user.email });

  res.json({
    user: {
      id: user.id,
      email: user.email,
      name: user.name
    },
    token
  });
});

export default router;
```

### src/routes/users.ts

```typescript
import { Router } from 'express';
import { authMiddleware, AuthRequest } from '../middleware/auth';
import { findUserById } from '../models/user';

const router = Router();

// 获取当前用户信息（需要认证）
router.get('/me', authMiddleware, (req: AuthRequest, res) => {
  const user = findUserById(req.user!.userId);

  if (!user) {
    return res.status(404).json({ error: 'User not found' });
  }

  res.json({
    id: user.id,
    email: user.email,
    name: user.name,
    createdAt: user.createdAt
  });
});

export default router;
```

### .env.example

```bash
PORT=3000
JWT_SECRET=your-secret-key-change-this-in-production
```

### 启动项目

```bash
> 项目创建完成！现在让我们测试一下：

# 1. 安装依赖
!!npm install

# 2. 创建 .env 文件
!!cp .env.example .env

# 3. 启动开发服务器
!!npm run dev

AI: 服务器已启动！你可以测试 API：

# 注册用户
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'

# 登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# 获取用户信息（需要 token）
curl http://localhost:3000/api/users/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## 总结

这 5 个场景展示了 Pi 的核心功能：

1. **场景 1**：安装配置 - 快速上手
2. **场景 2**：代码生成 - 创建和测试代码
3. **场景 3**：Bug 修复 - 分析和修复问题
4. **场景 4**：代码审查 - 提升代码质量
5. **场景 5**：项目搭建 - 快速创建完整项目

**关键技巧：**
- 使用 @文件引用查看代码
- 使用 !命令执行测试
- 使用 /copy 复制生成的代码
- 使用 /name 命名会话便于管理

---

**来源：**
- [Pi Coding Agent README](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/README.md) - 2026-02
- [Examples 目录](https://github.com/badlogic/pi-mono/tree/main/examples) - 2026-02
- [Community Use Cases](https://x.com/search?q=pi-mono) - 2025-2026
