# Query改写 - 概览

> RAG系统检索前的查询优化技术集合，通过6大策略弥合用户查询与文档表达的语义鸿沟

---

## 快速导航

| 维度 | 文件 | 核心内容 | 阅读时长 |
|------|------|---------|---------|
| **30字核心** | `01_30字核心.md` | 一句话理解Query改写 | 2分钟 |
| **第一性原理** | `02_第一性原理.md` | 从根本问题推导Query改写的必要性 | 8分钟 |
| **核心概念** | `03_核心概念_*.md` | 6大策略详解（HyDE、Multi-Query等） | 30分钟 |
| **最小可用** | `04_最小可用.md` | 20%核心知识解决80%问题 | 5分钟 |
| **双重类比** | `05_双重类比.md` | 前端开发+日常生活类比 | 8分钟 |
| **反直觉点** | `06_反直觉点.md` | 3个常见误区 | 5分钟 |
| **实战代码** | `07_实战代码_*.md` | 5个完整可运行示例 | 40分钟 |
| **面试必问** | `08_面试必问.md` | 高频面试题+出彩回答 | 10分钟 |
| **化骨绵掌** | `09_化骨绵掌.md` | 10个2分钟知识卡片 | 20分钟 |
| **一句话总结** | `10_一句话总结.md` | 完整总结+学习检查清单 | 3分钟 |

---

## 什么是Query改写？

**Query改写（Query Rewriting）** 是在RAG系统检索前，对用户原始查询进行优化和转换的技术集合。

### 核心问题

用户查询往往存在以下问题：
- **简短模糊**："怎么让代码快？"
- **口语化**："那个异步的东西怎么用？"
- **表达差异**：用户说"加速"，文档写"性能优化"
- **复杂多跳**："对比Python和Go的并发模型"

### 解决方案

通过6大策略优化查询：

```
用户原始查询 → Query改写 → 优化后的查询 → 检索 → 更好的结果
```

---

## 6大核心策略

### 1. HyDE (Hypothetical Document Embeddings)

**原理：** 生成假设性文档，用文档检索文档

**适用场景：** 查询与文档表达方式差异大

**示例：**
```
用户查询："Python异步编程怎么用？"

HyDE生成假设文档：
"Python异步编程使用asyncio库实现。通过async/await关键字定义协程函数。
使用asyncio.run()运行异步任务。适用于I/O密集型场景，提升并发性能。"

用假设文档的embedding检索 → 匹配度更高
```

**2025-2026年状态：** 60%生产RAG系统采用

---

### 2. Multi-Query (多查询生成)

**原理：** 生成3-5个查询变体，扩大召回范围

**适用场景：** 通用场景，2026年标配

**示例：**
```
原始查询："RAG系统如何优化？"

生成变体：
1. "如何提升RAG检索准确率？"
2. "RAG系统性能优化方法有哪些？"
3. "检索增强生成的优化策略"
4. "RAG召回率和精度如何改进？"

分别检索后融合 → 召回率大幅提升
```

**2025-2026年状态：** 85%生产RAG系统采用

---

### 3. Query Expansion (查询扩展)

**原理：** 添加同义词、相关词、领域术语

**适用场景：** 关键词检索（BM25）场景

**示例：**
```
原始查询："Python异步"

扩展后："Python异步 OR asyncio OR 协程 OR coroutine OR async/await"

BM25检索 → 覆盖更多相关文档
```

**2025-2026年状态：** 70%生产RAG系统采用

---

### 4. Query Decomposition (查询分解)

**原理：** 将复杂查询拆分为多个子查询

**适用场景：** 多跳问题、对比分析

**示例：**
```
复杂查询："对比Python和JavaScript的异步编程模型，并说明各自适用场景"

分解为子查询：
1. "Python异步编程模型是什么？"
2. "JavaScript异步编程模型是什么？"
3. "Python异步适用场景"
4. "JavaScript异步适用场景"

迭代检索和推理 → 综合答案
```

**2025-2026年状态：** 45%生产RAG系统采用

---

### 5. Keyword Enrichment (关键词增强)

**原理：** LLM提取并增强关键词

**适用场景：** 模糊查询、口语化查询

**示例：**
```
原始查询："怎么让API更快？"

LLM提取关键词：["API", "性能优化", "响应时间", "缓存", "异步", "并发"]

增强查询："API性能优化 响应时间 缓存策略 异步处理 并发优化"
```

**2025-2026年状态：** 55%生产RAG系统采用

---

### 6. Pseudo-Answer Generation (伪答案生成)

**原理：** 生成假设性答案用于检索

**适用场景：** 问答场景，类似HyDE但更短

**示例：**
```
原始查询："FastAPI如何处理异步？"

生成伪答案：
"FastAPI原生支持异步处理。使用async def定义异步路由。
支持异步数据库操作。性能优于同步框架。"

用伪答案检索 → 找到相关文档
```

**2025-2026年状态：** 40%生产RAG系统采用

---

## 策略选择决策树

```
用户查询类型？
├─ 简短模糊 → Multi-Query（标配）
├─ 表达差异大 → HyDE
├─ 关键词检索 → Query Expansion
├─ 复杂多跳 → Query Decomposition
├─ 口语化 → Keyword Enrichment
└─ 问答场景 → Pseudo-Answer
```

---

## 在RAG流程中的位置

```
用户Query
   ↓
Query改写 ← 本知识点
   ↓
检索（BM25/向量）
   ↓
ReRank重排序
   ↓
LLM生成
   ↓
答案
```

**关键特点：**
- 最早介入的优化环节
- 一次改写，多次检索受益
- 影响后续所有环节的质量

---

## 核心价值

### 1. 弥合语义鸿沟

**问题：** 用户查询 ≠ 文档表达

| 用户查询 | 文档表达 | 语义鸿沟 |
|---------|---------|---------|
| "怎么让代码跑得快？" | "性能优化策略" | ✅ 大 |
| "Python异步编程" | "asyncio协程实现" | ✅ 中 |
| "FastAPI异步路由" | "FastAPI async def" | ❌ 小 |

**Query改写：** 将用户语言转换为文档语言

### 2. 提升召回率

**单一查询：** 可能遗漏相关文档

**Query改写：** 多角度覆盖，扩大召回范围

**数据：** 平均提升20-35%检索准确率

### 3. 成本效益高

**成本：** $0.01-0.05/1K queries（主要是LLM调用）

**效果：** 20-35%准确率提升

**ROI：** 极高，是召回率优化的性价比之王

---

## 2025-2026年生产标准

### 主流框架支持

| 框架 | 支持策略 | 文档 |
|------|---------|------|
| **LangChain** | Multi-Query, HyDE | MultiQueryRetriever |
| **LlamaIndex** | Query Transformation | Query Engine |
| **Haystack** | Query Expansion | Query Pipeline |
| **Elasticsearch** | Query Rewriting with LLMs | Search Labs |

### 企业级应用

- **85%** 的生产RAG系统使用Multi-Query
- **60%** 使用HyDE处理语义鸿沟
- **70%** 在BM25检索中使用Query Expansion
- **45%** 使用Query Decomposition处理复杂查询

---

## 学习路径

### 第一阶段：理解基础（30分钟）

1. **阅读30字核心** - 快速理解Query改写
2. **阅读第一性原理** - 理解为什么需要Query改写
3. **阅读最小可用** - 掌握20%核心知识

### 第二阶段：掌握策略（2小时）

4. **阅读6个核心概念** - 深入理解每个策略
   - HyDE假设文档生成
   - Multi-Query多查询生成
   - Query Expansion查询扩展
   - Query Decomposition查询分解
   - Keyword Enrichment关键词增强
   - Pseudo-Answer伪答案生成

### 第三阶段：实战练习（3小时）

5. **运行5个实战代码** - 手写实现每个策略
   - HyDE实现
   - Multi-Query实现
   - Query Expansion实现
   - Query Decomposition实现
   - 综合应用场景

### 第四阶段：深化理解（1小时）

6. **阅读双重类比** - 通过类比加深理解
7. **阅读反直觉点** - 避免常见误区
8. **阅读面试必问** - 准备面试

### 第五阶段：系统掌握（30分钟）

9. **阅读化骨绵掌** - 10个知识卡片系统复习
10. **阅读一句话总结** - 完整总结+检查清单

---

## 与其他RAG优化技术的关系

### Query改写 + 混合检索

**互补关系：**
```
Query改写（优化输入） + 混合检索（优化检索策略）
         ↓                      ↓
    更好的查询表达          BM25 + 向量检索
         ↓                      ↓
              更高的召回率
```

**组合效果：** 提升40-60%（非线性叠加）

### Query改写 + ReRank

**协作关系：**
```
Query改写 → 检索 → ReRank → LLM生成
   ↓         ↓       ↓
扩大召回   粗筛    精排
```

**各自作用：**
- Query改写：扩大召回范围，提升召回率
- ReRank：精细排序，提升精度

---

## 快速参考卡

### 6大策略速记

| 策略 | 核心原理 | 一句话 |
|------|---------|--------|
| **HyDE** | 生成假设文档 | 用文档检索文档 |
| **Multi-Query** | 生成3-5个变体 | 多角度扩大召回 |
| **Query Expansion** | 添加同义词 | 增强关键词匹配 |
| **Query Decomposition** | 拆分复杂查询 | 处理多跳问题 |
| **Keyword Enrichment** | LLM提取关键词 | 优化模糊查询 |
| **Pseudo-Answer** | 生成假设答案 | 改善问答匹配 |

### 实施优先级

**第一阶段（必备）：**
- Multi-Query：通用场景，立即见效

**第二阶段（优化）：**
- HyDE：处理语义鸿沟
- Query Expansion：增强BM25检索

**第三阶段（进阶）：**
- Query Decomposition：复杂查询
- Keyword Enrichment：模糊查询
- Pseudo-Answer：问答优化

---

## 核心数据

### 性能提升

| 研究来源 | 技术 | 提升幅度 | 场景 |
|---------|------|---------|------|
| Elastic Labs (2026.01) | Query Expansion | +25% | 企业搜索 |
| Stack AI (2025.09) | Multi-Query | +30% | 通用RAG |
| LangChain | HyDE | +20-35% | 文档问答 |
| NVIDIA | Query Decomposition | +28% | 多跳推理 |

### 成本效益

| 优化方法 | 成本 | 精度提升 | ROI |
|---------|------|---------|-----|
| 更好的Embedding模型 | 高（重建索引） | +5-10% | 低 |
| **Query改写** | **低（$0.01-0.05/1K）** | **+20-35%** | **极高** |
| ReRank | 低（$0.025/M tokens） | +15-48% | 极高 |

---

## 参考资料

### 核心研究（2025-2026）

- [Query Rewriting Strategies with LLMs](https://www.elastic.co/search-labs/blog/query-rewriting-with-llms) - Elastic Labs, 2026.01
- [Advanced RAG Techniques](https://www.stack-ai.com/blog/advanced-rag-techniques) - Stack AI, 2025.09
- [HyDE: Precise Zero-Shot Dense Retrieval](https://arxiv.org/abs/2212.10496) - Original Paper, 2022
- [Multi-Query Retriever](https://python.langchain.com/docs/modules/data_connection/retrievers/MultiQueryRetriever) - LangChain
- [Query Decomposition for RAG](https://developer.nvidia.com/blog/build-an-agentic-rag-pipeline-with-llama-3-1-and-nvidia-nemo-retriever/) - NVIDIA, 2025

### 技术指南

- [Haystack Query Expansion](https://haystack.deepset.ai/tutorials/query-expansion) - Deepset
- [UniRAG: Universal RAG Framework](https://arxiv.org/abs/2406.07520) - Research Paper, 2024
- [Question Decomposition Improves RAG](https://arxiv.org/abs/2409.12365) - Research Paper, 2024

---

**版本：** v1.0 (2026年标准)
**最后更新：** 2026-02-16
**适用场景：** RAG开发、信息检索、查询优化
