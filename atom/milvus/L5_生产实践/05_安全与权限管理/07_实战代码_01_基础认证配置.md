# 实战代码1：基础认证配置

**完整的 Milvus 认证配置示例，从零开始搭建生产级认证系统。**

---

## 场景说明

**目标：** 为企业 RAG 系统配置基础认证，包括：
- 启用 Milvus 认证
- 创建不同角色的用户
- 实现安全连接
- 密码管理和轮换

**适用场景：**
- 企业内部知识库
- 多用户 RAG 系统
- 生产环境部署

---

## 完整代码

```python
"""
Milvus 基础认证配置
演示：从零开始配置生产级认证系统
"""

import os
import logging
from typing import List, Dict, Optional
from datetime import datetime, timedelta
from pymilvus import connections, utility, Collection
from dotenv import load_dotenv
import hashlib
import secrets

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


# ===== 1. 配置管理 =====

class MilvusAuthConfig:
    """Milvus 认证配置管理"""

    def __init__(self):
        load_dotenv()
        self.host = os.getenv("MILVUS_HOST", "localhost")
        self.port = os.getenv("MILVUS_PORT", "19530")
        self.admin_user = os.getenv("MILVUS_ADMIN_USER", "root")
        self.admin_password = os.getenv("MILVUS_ADMIN_PASSWORD", "Milvus")

    def get_connection_params(self, user: str = None, password: str = None) -> Dict:
        """获取连接参数"""
        return {
            "alias": "default",
            "host": self.host,
            "port": self.port,
            "user": user or self.admin_user,
            "password": password or self.admin_password
        }


# ===== 2. 用户管理 =====

class UserManager:
    """用户管理器"""

    def __init__(self, config: MilvusAuthConfig):
        self.config = config
        self.logger = logging.getLogger("UserManager")

        # 使用管理员账号连接
        connections.connect(**config.get_connection_params())
        self.logger.info("✅ 管理员连接成功")

    def create_user(self, username: str, password: str) -> bool:
        """创建用户"""
        try:
            # 检查用户是否已存在
            if username in utility.list_users():
                self.logger.warning(f"用户 {username} 已存在")
                return False

            # 验证密码强度
            if not self._validate_password(password):
                self.logger.error("密码不符合安全要求")
                return False

            # 创建用户
            utility.create_user(user=username, password=password)
            self.logger.info(f"✅ 用户 {username} 已创建")
            return True

        except Exception as e:
            self.logger.error(f"❌ 创建用户失败：{e}")
            return False

    def delete_user(self, username: str) -> bool:
        """删除用户"""
        try:
            # 检查用户是否存在
            if username not in utility.list_users():
                self.logger.warning(f"用户 {username} 不存在")
                return False

            # 不能删除 root 用户
            if username == "root":
                self.logger.error("❌ 不能删除 root 用户")
                return False

            # 删除用户
            utility.delete_user(user=username)
            self.logger.info(f"✅ 用户 {username} 已删除")
            return True

        except Exception as e:
            self.logger.error(f"❌ 删除用户失败：{e}")
            return False

    def update_password(self, username: str, old_password: str, new_password: str) -> bool:
        """修改密码"""
        try:
            # 验证新密码强度
            if not self._validate_password(new_password):
                self.logger.error("新密码不符合安全要求")
                return False

            # 修改密码
            utility.update_password(
                user=username,
                old_password=old_password,
                new_password=new_password
            )
            self.logger.info(f"✅ 用户 {username} 的密码已修改")
            return True

        except Exception as e:
            self.logger.error(f"❌ 修改密码失败：{e}")
            return False

    def list_users(self) -> List[str]:
        """列出所有用户"""
        return utility.list_users()

    def _validate_password(self, password: str) -> bool:
        """验证密码强度"""
        if len(password) < 12:
            self.logger.error("密码长度必须至少12个字符")
            return False

        if not any(c.isupper() for c in password):
            self.logger.error("密码必须包含大写字母")
            return False

        if not any(c.islower() for c in password):
            self.logger.error("密码必须包含小写字母")
            return False

        if not any(c.isdigit() for c in password):
            self.logger.error("密码必须包含数字")
            return False

        if not any(c in "!@#$%^&*(),.?\":{}|<>" for c in password):
            self.logger.error("密码必须包含特殊字符")
            return False

        return True


# ===== 3. 密码生成器 =====

class PasswordGenerator:
    """安全密码生成器"""

    @staticmethod
    def generate_strong_password(length: int = 16) -> str:
        """生成强密码"""
        import string

        # 确保包含所有类型的字符
        password = [
            secrets.choice(string.ascii_uppercase),  # 大写字母
            secrets.choice(string.ascii_lowercase),  # 小写字母
            secrets.choice(string.digits),           # 数字
            secrets.choice("!@#$%^&*(),.?\":{}|<>")  # 特殊字符
        ]

        # 填充剩余长度
        all_chars = string.ascii_letters + string.digits + "!@#$%^&*(),.?\":{}|<>"
        password += [secrets.choice(all_chars) for _ in range(length - 4)]

        # 打乱顺序
        secrets.SystemRandom().shuffle(password)

        return ''.join(password)


# ===== 4. 安全连接管理 =====

class SecureConnection:
    """安全连接管理"""

    def __init__(self, config: MilvusAuthConfig):
        self.config = config
        self.logger = logging.getLogger("SecureConnection")
        self.connected = False

    def connect(self, username: str, password: str) -> bool:
        """建立安全连接"""
        try:
            connections.connect(
                alias="secure",
                host=self.config.host,
                port=self.config.port,
                user=username,
                password=password
            )
            self.connected = True
            self.logger.info(f"✅ 用户 {username} 连接成功")
            return True

        except Exception as e:
            self.logger.error(f"❌ 连接失败：{e}")
            return False

    def disconnect(self):
        """断开连接"""
        if self.connected:
            connections.disconnect("secure")
            self.connected = False
            self.logger.info("✅ 连接已断开")

    def __enter__(self):
        """上下文管理器：进入"""
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """上下文管理器：退出"""
        self.disconnect()


# ===== 5. 认证审计 =====

class AuthAuditor:
    """认证审计器"""

    def __init__(self):
        self.logger = logging.getLogger("AuthAuditor")
        self.audit_log = []

    def log_login(self, username: str, success: bool, ip_address: str = "unknown"):
        """记录登录事件"""
        event = {
            "timestamp": datetime.now(),
            "event_type": "LOGIN",
            "username": username,
            "success": success,
            "ip_address": ip_address
        }
        self.audit_log.append(event)
        self.logger.info(f"{'✅' if success else '❌'} 登录: {username} from {ip_address}")

    def log_password_change(self, username: str, success: bool):
        """记录密码修改事件"""
        event = {
            "timestamp": datetime.now(),
            "event_type": "PASSWORD_CHANGE",
            "username": username,
            "success": success
        }
        self.audit_log.append(event)
        self.logger.info(f"{'✅' if success else '❌'} 密码修改: {username}")

    def log_user_creation(self, username: str, created_by: str):
        """记录用户创建事件"""
        event = {
            "timestamp": datetime.now(),
            "event_type": "USER_CREATION",
            "username": username,
            "created_by": created_by
        }
        self.audit_log.append(event)
        self.logger.info(f"✅ 用户创建: {username} by {created_by}")

    def get_audit_log(self, username: str = None) -> List[Dict]:
        """获取审计日志"""
        if username:
            return [e for e in self.audit_log if e.get("username") == username]
        return self.audit_log


# ===== 6. 完整的认证系统 =====

class MilvusAuthSystem:
    """完整的 Milvus 认证系统"""

    def __init__(self):
        self.config = MilvusAuthConfig()
        self.user_manager = UserManager(self.config)
        self.password_generator = PasswordGenerator()
        self.auditor = AuthAuditor()
        self.logger = logging.getLogger("MilvusAuthSystem")

    def setup_initial_users(self):
        """设置初始用户"""
        self.logger.info("=== 设置初始用户 ===")

        # 1. 修改默认管理员密码
        self.logger.info("1. 修改默认管理员密码")
        new_admin_password = self.password_generator.generate_strong_password()
        success = self.user_manager.update_password(
            username="root",
            old_password="Milvus",
            new_password=new_admin_password
        )
        if success:
            self.auditor.log_password_change("root", True)
            self.logger.info(f"新管理员密码：{new_admin_password}")
            self.logger.warning("⚠️ 请妥善保存此密码！")

        # 2. 创建只读用户
        self.logger.info("\n2. 创建只读用户")
        readonly_password = self.password_generator.generate_strong_password()
        success = self.user_manager.create_user("readonly_user", readonly_password)
        if success:
            self.auditor.log_user_creation("readonly_user", "root")
            self.logger.info(f"只读用户密码：{readonly_password}")

        # 3. 创建数据管理员
        self.logger.info("\n3. 创建数据管理员")
        admin_password = self.password_generator.generate_strong_password()
        success = self.user_manager.create_user("data_admin", admin_password)
        if success:
            self.auditor.log_user_creation("data_admin", "root")
            self.logger.info(f"数据管理员密码：{admin_password}")

        # 4. 列出所有用户
        self.logger.info("\n4. 当前用户列表")
        users = self.user_manager.list_users()
        for user in users:
            self.logger.info(f"  - {user}")

    def test_authentication(self, username: str, password: str):
        """测试认证"""
        self.logger.info(f"\n=== 测试用户 {username} 的认证 ===")

        conn = SecureConnection(self.config)
        success = conn.connect(username, password)
        self.auditor.log_login(username, success)

        if success:
            # 测试基本操作
            try:
                collections = utility.list_collections()
                self.logger.info(f"✅ 可以列出 Collection：{collections}")
            except Exception as e:
                self.logger.error(f"❌ 操作失败：{e}")

            conn.disconnect()

    def show_audit_log(self):
        """显示审计日志"""
        self.logger.info("\n=== 审计日志 ===")
        for event in self.auditor.get_audit_log():
            self.logger.info(
                f"[{event['timestamp']}] {event['event_type']} - "
                f"User: {event.get('username', 'N/A')}"
            )


# ===== 7. 主程序 =====

def main():
    """主程序"""
    print("=" * 60)
    print("Milvus 基础认证配置示例")
    print("=" * 60)

    # 创建认证系统
    auth_system = MilvusAuthSystem()

    # 步骤1：设置初始用户
    auth_system.setup_initial_users()

    # 步骤2：测试认证（使用默认密码，实际应使用生成的密码）
    # 注意：这里使用默认密码仅用于演示，实际应使用上面生成的密码
    print("\n" + "=" * 60)
    print("测试认证")
    print("=" * 60)

    # 测试管理员登录
    auth_system.test_authentication("root", "Milvus")

    # 步骤3：显示审计日志
    auth_system.show_audit_log()

    print("\n" + "=" * 60)
    print("认证配置完成")
    print("=" * 60)


# ===== 8. 使用示例 =====

def example_usage():
    """使用示例"""

    # 示例1：创建用户管理器
    config = MilvusAuthConfig()
    user_manager = UserManager(config)

    # 示例2：创建新用户
    password = PasswordGenerator.generate_strong_password()
    user_manager.create_user("analyst", password)
    print(f"分析师密码：{password}")

    # 示例3：使用安全连接
    conn = SecureConnection(config)
    if conn.connect("analyst", password):
        # 执行操作
        collections = utility.list_collections()
        print(f"Collections: {collections}")
        conn.disconnect()

    # 示例4：修改密码
    new_password = PasswordGenerator.generate_strong_password()
    user_manager.update_password("analyst", password, new_password)

    # 示例5：删除用户
    user_manager.delete_user("analyst")


if __name__ == "__main__":
    # 运行主程序
    main()

    # 或运行示例
    # example_usage()
```

---

## 运行输出示例

```
============================================================
Milvus 基础认证配置示例
============================================================
2025-02-10 10:30:00 - UserManager - INFO - ✅ 管理员连接成功
2025-02-10 10:30:00 - MilvusAuthSystem - INFO - === 设置初始用户 ===
2025-02-10 10:30:00 - MilvusAuthSystem - INFO - 1. 修改默认管理员密码
2025-02-10 10:30:01 - UserManager - INFO - ✅ 用户 root 的密码已修改
2025-02-10 10:30:01 - MilvusAuthSystem - INFO - 新管理员密码：Xk9#mP2$vL8@qR5!
2025-02-10 10:30:01 - MilvusAuthSystem - WARNING - ⚠️ 请妥善保存此密码！

2025-02-10 10:30:01 - MilvusAuthSystem - INFO - 2. 创建只读用户
2025-02-10 10:30:02 - UserManager - INFO - ✅ 用户 readonly_user 已创建
2025-02-10 10:30:02 - MilvusAuthSystem - INFO - 只读用户密码：Tn7!wQ3@hK9$pM2#

2025-02-10 10:30:02 - MilvusAuthSystem - INFO - 3. 创建数据管理员
2025-02-10 10:30:03 - UserManager - INFO - ✅ 用户 data_admin 已创建
2025-02-10 10:30:03 - MilvusAuthSystem - INFO - 数据管理员密码：Bv4#xN8@jL2$rQ6!

2025-02-10 10:30:03 - MilvusAuthSystem - INFO - 4. 当前用户列表
2025-02-10 10:30:03 - MilvusAuthSystem - INFO -   - root
2025-02-10 10:30:03 - MilvusAuthSystem - INFO -   - readonly_user
2025-02-10 10:30:03 - MilvusAuthSystem - INFO -   - data_admin

============================================================
测试认证
============================================================
2025-02-10 10:30:04 - MilvusAuthSystem - INFO - === 测试用户 root 的认证 ===
2025-02-10 10:30:04 - SecureConnection - INFO - ✅ 用户 root 连接成功
2025-02-10 10:30:04 - AuthAuditor - INFO - ✅ 登录: root from unknown
2025-02-10 10:30:04 - SecureConnection - INFO - ✅ 可以列出 Collection：['docs', 'products']
2025-02-10 10:30:04 - SecureConnection - INFO - ✅ 连接已断开

=== 审计日志 ===
2025-02-10 10:30:01 - AuthAuditor - INFO - [2025-02-10 10:30:01] PASSWORD_CHANGE - User: root
2025-02-10 10:30:02 - AuthAuditor - INFO - [2025-02-10 10:30:02] USER_CREATION - User: readonly_user
2025-02-10 10:30:03 - AuthAuditor - INFO - [2025-02-10 10:30:03] USER_CREATION - User: data_admin
2025-02-10 10:30:04 - AuthAuditor - INFO - [2025-02-10 10:30:04] LOGIN - User: root

============================================================
认证配置完成
============================================================
```

---

## 环境配置

### .env 文件

```bash
# Milvus 连接配置
MILVUS_HOST=localhost
MILVUS_PORT=19530

# 管理员凭证（初始）
MILVUS_ADMIN_USER=root
MILVUS_ADMIN_PASSWORD=Milvus

# 修改后的管理员密码（生产环境）
# MILVUS_ADMIN_PASSWORD=Xk9#mP2$vL8@qR5!
```

### 依赖安装

```bash
# 安装依赖
pip install pymilvus python-dotenv

# 或使用 uv
uv add pymilvus python-dotenv
```

---

## 关键特性

### 1. 密码强度验证

```python
# 密码要求：
- 最小长度：12字符
- 必须包含：大写字母、小写字母、数字、特殊字符
- 自动生成的密码符合所有要求
```

### 2. 安全密码生成

```python
# 使用 secrets 模块（加密安全）
password = PasswordGenerator.generate_strong_password(16)
# 示例：Xk9#mP2$vL8@qR5!
```

### 3. 审计日志

```python
# 记录所有认证事件：
- 登录成功/失败
- 密码修改
- 用户创建/删除
```

### 4. 上下文管理器

```python
# 自动管理连接生命周期
with SecureConnection(config) as conn:
    if conn.connect("user", "pass"):
        # 执行操作
        pass
# 自动断开连接
```

---

## 生产环境建议

### 1. 密码存储

```python
# ❌ 不要硬编码密码
password = "Milvus123!"

# ✅ 使用环境变量
password = os.getenv("MILVUS_PASSWORD")

# ✅ 使用密钥管理服务
password = get_from_vault("milvus/password")
```

### 2. 定期密码轮换

```python
# 每90天强制修改密码
class PasswordPolicy:
    MAX_AGE_DAYS = 90

    def check_password_age(self, user):
        # 检查密码年龄
        # 如果超过90天，强制修改
        pass
```

### 3. 多因素认证

```python
# 结合 OTP（一次性密码）
def login_with_mfa(username, password, otp_code):
    # 1. 验证用户名和密码
    # 2. 验证 OTP
    # 3. 生成会话令牌
    pass
```

---

## 小结

**本示例展示了：**

1. ✅ 完整的用户管理系统
2. ✅ 安全密码生成和验证
3. ✅ 安全连接管理
4. ✅ 认证审计日志
5. ✅ 生产环境最佳实践

**下一步：** 学习 RBAC 权限管理的实战代码
