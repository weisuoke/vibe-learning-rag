# 最小可用

> 掌握以下内容，就能快速搭建 Milvus 监控体系

---

## 核心知识点

掌握以下 5 个要点，就能开始使用 Milvus 监控与健康检查：

---

### 4.1 验证 Milvus Metrics 端点

**快速检查 Milvus 是否暴露监控指标：**

```bash
# 访问 Metrics 端点
curl http://localhost:9091/metrics

# 应该看到类似输出：
# HELP milvus_proxy_search_vectors_count Total number of vectors searched
# TYPE milvus_proxy_search_vectors_count counter
# milvus_proxy_search_vectors_count 12345
```

**Python 验证脚本：**

```python
import requests

response = requests.get("http://localhost:9091/metrics")
if response.status_code == 200:
    print("✅ Metrics 端点可访问")
    print(f"指标数量: {len([l for l in response.text.split('\n') if l and not l.startswith('#')])}")
else:
    print("❌ Metrics 端点不可访问")
```

---

### 4.2 部署 Prometheus 采集指标

**最小化 Docker Compose 配置：**

```yaml
version: '3.8'

services:
  # Milvus 服务（假设已部署）
  milvus:
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
      - "9091:9091"  # Metrics 端点

  # Prometheus 监控
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
```

**prometheus.yml 配置：**

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'milvus'
    static_configs:
      - targets: ['milvus:9091']
```

**启动监控：**

```bash
docker-compose up -d prometheus
```

**验证采集：**

```bash
# 访问 Prometheus UI
open http://localhost:9090

# 查询指标
# 在查询框输入: milvus_proxy_search_vectors_count
```

---

### 4.3 配置健康检查

**Docker Compose 健康检查配置：**

```yaml
services:
  milvus:
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
      - "9091:9091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
```

**验证健康检查：**

```bash
# 查看容器健康状态
docker ps

# 输出示例：
# CONTAINER ID   STATUS
# abc123         Up 5 minutes (healthy)

# 手动测试健康检查
curl http://localhost:9091/healthz
# 输出: OK
```

---

### 4.4 部署 Grafana 可视化

**添加 Grafana 到 Docker Compose：**

```yaml
services:
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana

volumes:
  grafana-data:
```

**配置步骤：**

1. 访问 Grafana：http://localhost:3000
2. 登录（用户名/密码：admin/admin）
3. 添加数据源：
   - Configuration → Data Sources → Add data source
   - 选择 Prometheus
   - URL: `http://prometheus:9090`
   - 点击 "Save & Test"

4. 创建仪表盘：
   - Create → Dashboard → Add new panel
   - 输入查询：`rate(milvus_proxy_search_vectors_count[5m])`
   - 保存面板

---

### 4.5 监控关键指标

**必须监控的 5 个核心指标：**

#### 1. QPS（每秒查询数）

```promql
# Prometheus 查询
rate(milvus_proxy_search_vectors_count[5m])
```

**含义：** 系统负载，反映业务量

---

#### 2. 查询延迟 P95

```promql
# Prometheus 查询
histogram_quantile(0.95,
  rate(milvus_proxy_search_latency_milliseconds_bucket[5m])
)
```

**含义：** 95% 的查询延迟低于此值，反映用户体验

---

#### 3. 错误率

```promql
# Prometheus 查询
rate(milvus_proxy_search_failed_count[5m])
/
rate(milvus_proxy_search_vectors_count[5m])
* 100
```

**含义：** 系统可靠性，应该 < 1%

---

#### 4. 内存使用率

```promql
# Prometheus 查询（假设总内存 16GB）
process_resident_memory_bytes / (16 * 1024 * 1024 * 1024) * 100
```

**含义：** 资源使用情况，应该 < 80%

---

#### 5. CPU 使用率

```promql
# Prometheus 查询
rate(process_cpu_seconds_total[5m]) * 100
```

**含义：** 计算资源使用，应该 < 80%

---

## 快速上手步骤

### 步骤1：准备环境（5分钟）

```bash
# 创建项目目录
mkdir milvus-monitoring
cd milvus-monitoring

# 创建配置文件
touch docker-compose.yml prometheus.yml
```

---

### 步骤2：配置文件（5分钟）

**docker-compose.yml：**

```yaml
version: '3.8'

services:
  milvus:
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus-data:/var/lib/milvus
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana

volumes:
  milvus-data:
  prometheus-data:
  grafana-data:
```

**prometheus.yml：**

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'milvus'
    static_configs:
      - targets: ['milvus:9091']
```

---

### 步骤3：启动服务（2分钟）

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 等待 Milvus 启动完成（约 1-2 分钟）
docker-compose logs -f milvus
```

---

### 步骤4：验证监控（5分钟）

```bash
# 1. 验证 Milvus Metrics
curl http://localhost:9091/metrics | head -20

# 2. 验证 Prometheus
open http://localhost:9090
# 在查询框输入: milvus_proxy_search_vectors_count

# 3. 验证 Grafana
open http://localhost:3000
# 登录: admin/admin
```

---

### 步骤5：创建仪表盘（10分钟）

1. **添加数据源：**
   - Configuration → Data Sources → Add data source
   - 选择 Prometheus
   - URL: `http://prometheus:9090`
   - Save & Test

2. **创建仪表盘：**
   - Create → Dashboard → Add new panel

3. **添加 QPS 面板：**
   - Query: `rate(milvus_proxy_search_vectors_count[5m])`
   - Panel title: "QPS"
   - Unit: "reqps"

4. **添加延迟面板：**
   - Query: `histogram_quantile(0.95, rate(milvus_proxy_search_latency_milliseconds_bucket[5m]))`
   - Panel title: "Search Latency P95"
   - Unit: "ms"

5. **保存仪表盘**

---

## 这些知识足以

完成以上步骤后，你已经能够：

- ✅ **部署完整的监控栈**：Prometheus + Grafana
- ✅ **采集 Milvus 指标**：自动采集所有暴露的指标
- ✅ **配置健康检查**：自动检测服务状态
- ✅ **可视化关键指标**：QPS、延迟、错误率、资源使用
- ✅ **实时监控系统状态**：通过 Grafana 仪表盘

---

## 在 RAG 系统中的应用

### 最小化 RAG 监控配置

```python
"""
RAG 系统的最小化监控实现
"""

from pymilvus import connections, Collection
from prometheus_client import Counter, Histogram, start_http_server
import time

# 定义监控指标
rag_search_total = Counter(
    'rag_search_total',
    'Total number of RAG searches',
    ['collection']
)

rag_search_duration = Histogram(
    'rag_search_duration_seconds',
    'RAG search duration in seconds',
    ['collection']
)

def search_with_monitoring(collection_name: str, query_vector: list, top_k: int = 10):
    """带监控的向量检索"""
    start_time = time.time()

    try:
        # 连接 Milvus
        connections.connect(host="localhost", port="19530")

        # 执行检索
        collection = Collection(collection_name)
        results = collection.search(
            data=[query_vector],
            anns_field="embedding",
            param={"metric_type": "L2", "params": {"nprobe": 10}},
            limit=top_k
        )

        # 记录成功指标
        duration = time.time() - start_time
        rag_search_total.labels(collection=collection_name).inc()
        rag_search_duration.labels(collection=collection_name).observe(duration)

        return results

    except Exception as e:
        # 记录失败指标
        duration = time.time() - start_time
        rag_search_duration.labels(collection=collection_name).observe(duration)
        raise e

if __name__ == "__main__":
    # 启动 Prometheus 指标服务
    start_http_server(8000)
    print("Metrics server started on :8000")

    # 保持运行
    while True:
        time.sleep(1)
```

**Prometheus 配置添加 RAG 指标采集：**

```yaml
scrape_configs:
  - job_name: 'milvus'
    static_configs:
      - targets: ['milvus:9091']

  - job_name: 'rag-app'
    static_configs:
      - targets: ['rag-app:8000']  # RAG 应用的指标端点
```

---

## 常见问题

### Q1: Prometheus 无法采集到 Milvus 指标？

**检查清单：**
```bash
# 1. 验证 Milvus Metrics 端点可访问
curl http://localhost:9091/metrics

# 2. 检查 Prometheus 配置
docker-compose exec prometheus cat /etc/prometheus/prometheus.yml

# 3. 查看 Prometheus 日志
docker-compose logs prometheus

# 4. 检查网络连接
docker-compose exec prometheus ping milvus
```

---

### Q2: Grafana 无法连接 Prometheus？

**解决方案：**
```bash
# 1. 确认 Prometheus 运行正常
curl http://localhost:9090/-/healthy

# 2. 在 Grafana 中使用容器名称
# URL: http://prometheus:9090 (不是 localhost)

# 3. 检查网络
docker-compose exec grafana ping prometheus
```

---

### Q3: 健康检查一直失败？

**解决方案：**
```bash
# 1. 增加初始延迟时间
healthcheck:
  start_period: 120s  # 给 Milvus 更多启动时间

# 2. 检查健康检查端点
curl http://localhost:9091/healthz

# 3. 查看 Milvus 日志
docker-compose logs milvus
```

---

## 下一步学习

完成最小可用知识后，建议继续学习：

1. **双重类比**：理解监控概念的类比
2. **反直觉点**：避免常见误区
3. **实战代码**：完整的监控部署示例
4. **面试必问**：深入理解监控原理

---

**下一步：** [05_双重类比](./05_双重类比.md)
