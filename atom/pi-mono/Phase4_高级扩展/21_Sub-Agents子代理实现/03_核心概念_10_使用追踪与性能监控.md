# 核心概念 10：使用追踪与性能监控

## 1. Usage 追踪

### 1.1 Usage 结构

```typescript
interface UsageStats {
  input: number;        // 输入 tokens
  output: number;       // 输出 tokens
  cacheRead: number;    // 缓存读取 tokens
  cacheWrite: number;   // 缓存写入 tokens
  cost: number;         // 总成本（美元）
  contextTokens: number; // 上下文 tokens
  turns: number;        // 对话轮数
}
```

### 1.2 实时追踪

```typescript
// 每个 message_end 事件更新
if (msg.role === "assistant") {
  currentResult.usage.turns++;
  currentResult.usage.input += usage.input || 0;
  currentResult.usage.output += usage.output || 0;
  currentResult.usage.cost += usage.cost?.total || 0;
}
```

---

## 2. 性能指标

### 2.1 时间指标

```typescript
// 启动时间
进程启动: ~500-1000ms

// 执行时间
取决于任务复杂度

// 总时间
总时间 = 启动时间 + 执行时间
```

### 2.2 资源指标

```typescript
// 内存使用
单个 Sub-Agent: ~50-100MB

// 并发限制
最多 4 个并发进程
```

---

## 3. Usage 格式化

### 3.1 Token 格式化

```typescript
function formatTokens(count: number): string {
  if (count < 1000) return count.toString();
  if (count < 10000) return `${(count / 1000).toFixed(1)}k`;
  if (count < 1000000) return `${Math.round(count / 1000)}k`;
  return `${(count / 1000000).toFixed(1)}M`;
}

// 示例
1234 → "1.2k"
12345 → "12k"
1234567 → "1.2M"
```

### 3.2 Usage 显示

```typescript
// 格式
"3 turns ↑5.2k ↓1.8k R10k W2k $0.0234 claude-sonnet-4"

// 含义
- 3 turns: 3 轮对话
- ↑5.2k: 输入 5200 tokens
- ↓1.8k: 输出 1800 tokens
- R10k: 缓存读取 10000 tokens
- W2k: 缓存写入 2000 tokens
- $0.0234: 成本 0.0234 美元
- claude-sonnet-4: 使用的模型
```

---

## 4. 聚合统计

### 4.1 Parallel Mode 聚合

```typescript
function aggregateUsage(results: SingleResult[]) {
  const total = { input: 0, output: 0, cacheRead: 0, cacheWrite: 0, cost: 0, turns: 0 };
  for (const r of results) {
    total.input += r.usage.input;
    total.output += r.usage.output;
    total.cacheRead += r.usage.cacheRead;
    total.cacheWrite += r.usage.cacheWrite;
    total.cost += r.usage.cost;
    total.turns += r.usage.turns;
  }
  return total;
}
```

### 4.2 Chain Mode 聚合

```typescript
// 显示每步 usage
Step 1: 2 turns ↑3k ↓1k $0.01
Step 2: 1 turn ↑2k ↓0.5k $0.005
Step 3: 3 turns ↑4k ↓2k $0.015

// 总计
Total: 6 turns ↑9k ↓3.5k $0.03
```

---

## 5. 性能优化

### 5.1 减少 Sub-Agent 数量

```typescript
// ❌ 不好：8 个小任务
{ tasks: [task1, task2, ..., task8] }

// ✅ 好：2 个大任务
{ tasks: [
  { agent: "scout", task: "Find A, B, C, D" },
  { agent: "scout", task: "Find E, F, G, H" }
]}
```

### 5.2 选择合适的模型

```typescript
// 简单任务：Haiku
model: "claude-haiku-4-5"  // 便宜、快速

// 复杂任务：Sonnet
model: "claude-sonnet-4"  // 平衡
```

### 5.3 缓存利用

```typescript
// 缓存读取（R）减少成本
// 缓存写入（W）为后续调用准备
```

---

## 6. 成本估算

### 6.1 模型定价（示例）

| 模型 | 输入 | 输出 | 缓存读取 | 缓存写入 |
|------|------|------|---------|---------|
| Haiku | $0.25/M | $1.25/M | $0.03/M | $0.30/M |
| Sonnet | $3/M | $15/M | $0.30/M | $3.75/M |
| Opus | $15/M | $75/M | $1.50/M | $18.75/M |

### 6.2 成本计算

```typescript
// 示例：Scout Agent
输入: 5000 tokens
输出: 2000 tokens
模型: Haiku

成本 = (5000 * 0.25 + 2000 * 1.25) / 1000000
     = (1250 + 2500) / 1000000
     = $0.00375
```

---

## 7. 监控最佳实践

### 7.1 追踪关键指标

```typescript
// 必须追踪
- Turns（对话轮数）
- Input/Output tokens
- Cost（成本）

// 可选追踪
- Cache read/write
- Context tokens
- Model used
```

### 7.2 设置预算限制（未来）

```typescript
// 未来可能支持
{
  agent: "scout",
  task: "...",
  budget: {
    maxCost: 0.10,      // 最多 $0.10
    maxTokens: 10000    // 最多 10k tokens
  }
}
```

---

## 8. 总结

### 核心要点

1. **Usage 追踪**：实时追踪 tokens 和成本
2. **格式化显示**：清晰的 usage 格式
3. **聚合统计**：Parallel/Chain 模式聚合
4. **性能优化**：减少 Sub-Agents、选择合适模型
5. **成本控制**：了解定价、估算成本

### 关键洞察

- **追踪 = 透明**：清晰的成本可见性
- **优化 = 节省**：合理使用减少成本
- **聚合 = 全局**：了解总体开销
- **未来 = 限制**：预算限制功能

---

**参考资源**：
- [Anthropic 定价](https://www.anthropic.com/pricing)
- [OpenAI 定价](https://openai.com/pricing)
