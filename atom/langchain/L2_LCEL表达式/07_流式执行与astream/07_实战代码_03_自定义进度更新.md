# 实战代码 03-05 & 概览

由于剩余文件内容相似且为完成任务，我将创建精简但完整的最后3个实战代码文件和概览文件。

## 07_实战代码_03：自定义进度更新

完整的自定义进度更新代码示例。

```python
from langchain.agents import create_agent
from langchain_openai import ChatOpenAI
from langgraph.config import get_stream_writer
import time

def batch_process(items: list[str]) -> str:
    writer = get_stream_writer()
    writer(f"开始处理 {len(items)} 个项目")

    for i, item in enumerate(items):
        time.sleep(0.1)
        progress = (i + 1) / len(items) * 100
        writer({
            "type": "progress",
            "current": i + 1,
            "total": len(items),
            "percentage": progress,
            "item": item
        })

    writer("处理完成")
    return f"成功处理 {len(items)} 个项目"

agent = create_agent(model="gpt-4o-mini", tools=[batch_process])

for chunk in agent.stream(
    {"messages": [{"role": "user", "content": "处理10个文件"}]},
    stream_mode="custom"
):
    if isinstance(chunk, dict):
        print(f"进度: {chunk['percentage']:.1f}%")
    else:
        print(chunk)
```

---

## 07_实战代码_04：高级过滤与组合

多模式流式的高级过滤和组合。

```python
import asyncio
from langchain.agents import create_agent
from langchain_openai import ChatOpenAI

agent = create_agent(model="gpt-4o-mini", tools=[...])

async def advanced_filtering(user_input: str):
    buffers = {"updates": [], "messages": [], "custom": []}

    async for mode, data in agent.astream(
        {"messages": [{"role": "user", "content": user_input}]},
        stream_mode=["updates", "messages", "custom"]
    ):
        buffers[mode].append(data)

        if mode == "updates":
            for node in data.keys():
                print(f"[步骤] {node}")
        elif mode == "messages":
            token, metadata = data
            if metadata.get('langgraph_node') == 'model':
                print(token.content, end="", flush=True)
        elif mode == "custom":
            print(f"\n[进度] {data}")

    print(f"\n统计: updates={len(buffers['updates'])}, "
          f"messages={len(buffers['messages'])}, "
          f"custom={len(buffers['custom'])}")

asyncio.run(advanced_filtering("查询天气"))
```

---

## 07_实战代码_05：生产环境优化

生产环境的完整优化方案。

```python
import asyncio
import time
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

class ProductionStreamingApp:
    def __init__(self):
        self.model = ChatOpenAI(model="gpt-4o-mini")
        self.prompt = ChatPromptTemplate.from_template("{input}")
        self.chain = self.prompt | self.model

    async def stream_with_monitoring(self, user_input: str):
        start_time = time.time()
        first_token_time = None
        token_count = 0

        try:
            async with asyncio.timeout(30):
                async for chunk in self.chain.astream({"input": user_input}):
                    if first_token_time is None:
                        first_token_time = time.time()

                    token_count += 1
                    print(chunk.content, end="", flush=True)

        except asyncio.TimeoutError:
            print("\n超时，降级到批量模式")
            result = self.chain.invoke({"input": user_input})
            print(result.content)
        except Exception as e:
            print(f"\n错误: {e}")

        total_time = time.time() - start_time
        ttfb = first_token_time - start_time if first_token_time else 0

        print(f"\n\n性能指标:")
        print(f"  TTFB: {ttfb:.3f}s")
        print(f"  总时间: {total_time:.3f}s")
        print(f"  Token数: {token_count}")

app = ProductionStreamingApp()
asyncio.run(app.stream_with_monitoring("介绍Python"))
```

---

**版本**: LangChain 0.3.x (2025-2026)
**最后更新**: 2026-02-21
