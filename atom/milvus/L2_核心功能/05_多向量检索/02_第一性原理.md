# 第一性原理

> 从根本问题思考多向量检索

---

## 什么是第一性原理？

**第一性原理**：回到事物最基本的真理，从源头思考问题，而不是基于类比或经验。

---

## 多向量检索的第一性原理

### 1. 最基础的定义

**多向量检索 = 在单个数据对象中存储多个向量表示，并同时检索这些向量以获得更全面的匹配结果**

仅此而已！没有更基础的了。

**拆解：**
- **单个数据对象**：一条文档记录、一个商品、一篇文章
- **多个向量表示**：同一对象的不同维度特征（文本向量、图片向量、标题向量等）
- **同时检索**：并行执行多个向量检索操作
- **融合结果**：通过算法整合多个检索结果

---

### 2. 为什么需要多向量检索？

#### 核心问题：单一向量无法完整表达复杂对象

**问题1：信息维度的多样性**
```
一个商品包含：
- 文字描述："红色连衣裙，适合夏天穿"
- 商品图片：实际的裙子照片
- 用户评价："质量很好，颜色鲜艳"

如果只用一个向量表示，必然丢失某些维度的信息。
```

**问题2：不同用户的检索偏好**
```
用户A：通过文字搜索 "红色连衣裙"
用户B：上传图片搜索 "找类似的裙子"
用户C：既输入文字又上传图片

单一向量无法同时满足这三种检索方式。
```

**问题3：检索准确率的瓶颈**
```
单一向量检索：
- 文本向量检索：召回率70%，准确率75%
- 图片向量检索：召回率65%，准确率80%

多向量融合：
- 召回率85%，准确率90%（显著提升）
```

**根本原因：** 现实世界的对象是**多模态**的，单一模态的表示必然是不完整的。

---

### 3. 多向量检索的三层价值

#### 价值1：提升检索准确率

**原理：** 多个向量提供互补信息，减少单一向量的误判

**示例：**
```python
# 场景：搜索"苹果手机"

# 单一文本向量检索：
# 可能召回：苹果手机、苹果电脑、苹果平板、苹果（水果）
# 问题：无法区分"苹果公司产品"和"苹果水果"

# 多向量检索（文本 + 图片）：
# 文本向量：理解"手机"这个概念
# 图片向量：识别手机的外观特征
# 融合结果：只召回真正的苹果手机 ✅
```

**数学直觉：**
```
P(相关 | 文本匹配 AND 图片匹配) > P(相关 | 文本匹配)

多个独立证据的组合，降低了误判概率。
```

---

#### 价值2：支持多模态应用

**原理：** 不同模态的数据需要不同的向量表示

**示例：**
```python
# 场景：智能客服系统

用户输入：
- 文字："我的订单怎么还没发货？"
- 截图：订单详情页面

知识库：
- 文本向量：FAQ文档的文字内容
- 图片向量：FAQ文档中的示例截图

多向量检索：
- 文本向量匹配：找到"订单发货"相关的FAQ
- 图片向量匹配：找到包含类似截图的FAQ
- 融合结果：最相关的FAQ（既有文字说明，又有截图示例）
```

**本质：** 人类理解世界是多感官的（视觉、听觉、触觉），AI系统也应该是多模态的。

---

#### 价值3：增强系统灵活性

**原理：** 可以根据场景动态调整检索策略

**示例：**
```python
# 场景：电商搜索

# 策略1：文本为主（用户只输入文字）
weights = {"text": 0.8, "image": 0.2}

# 策略2：图片为主（用户上传图片）
weights = {"text": 0.2, "image": 0.8}

# 策略3：均衡（用户既输入文字又上传图片）
weights = {"text": 0.5, "image": 0.5}

# 同一个系统，不同场景下自动调整
```

**本质：** 多向量检索提供了**可组合的检索能力**，而不是固定的单一检索方式。

---

### 4. 从第一性原理推导 RAG 多模态检索

**推理链：**

```
1. RAG 的核心目标：为 LLM 提供相关的上下文信息
   ↓
2. 文档包含多种信息：文本、图表、表格、代码
   ↓
3. 单一文本向量无法完整表达图表和表格的信息
   ↓
4. 需要为不同类型的内容创建不同的向量表示
   ↓
5. 用户的问题可能涉及多种信息类型
   ↓
6. 需要同时检索多个向量字段
   ↓
7. 融合多个检索结果，提供最相关的上下文
   ↓
8. 多向量检索是 RAG 系统的必然选择
```

**实际应用：**
```python
# 文档：Python 教程（包含文字说明 + 代码示例 + 运行结果截图）

# 向量化策略：
# - text_vector：文字说明的向量
# - code_vector：代码示例的向量
# - image_vector：截图的向量

# 用户问题："如何使用 pandas 读取 CSV 文件？"

# 多向量检索：
# 1. text_vector 检索：找到包含"pandas"和"CSV"的文档
# 2. code_vector 检索：找到包含 pd.read_csv() 的代码示例
# 3. image_vector 检索：找到包含 CSV 文件截图的文档

# 融合结果：最相关的教程（既有文字说明，又有代码示例，还有运行结果）
```

---

### 5. 一句话总结第一性原理

**多向量检索是因为现实对象的多模态本质，单一向量无法完整表达，通过多个向量的互补和融合，实现更准确、更灵活的检索。**

---

## 从第一性原理看技术选择

### 为什么选择 Milvus？

**第一性原理：** 多向量检索需要高效的向量存储和检索能力

**Milvus 的优势：**
1. **原生支持多向量字段**：在单个 Collection 中定义多个向量字段
2. **高性能 ANN 算法**：HNSW、IVF 等索引类型
3. **灵活的融合策略**：支持 RRF、自定义加权等
4. **分布式架构**：支持大规模数据和高并发

**对比其他方案：**
| 方案 | 多向量支持 | 性能 | 灵活性 |
|------|-----------|------|--------|
| **Milvus** | ✅ 原生支持 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Elasticsearch | ❌ 需要多个索引 | ⭐⭐⭐ | ⭐⭐⭐ |
| Faiss | ❌ 需要手动管理 | ⭐⭐⭐⭐ | ⭐⭐ |
| Pinecone | ⚠️ 有限支持 | ⭐⭐⭐⭐ | ⭐⭐⭐ |

---

### 为什么选择 RRF 融合？

**第一性原理：** 不同向量字段的相似度分数可能不可比（不同度量方式、不同模型）

**RRF 的优势：**
1. **只看排名，不看分数**：避免分数范围不一致的问题
2. **简单鲁棒**：无需调参，开箱即用
3. **理论保证**：有数学证明的融合效果

**公式推导：**
```
RRF(d) = Σ 1 / (k + rank_i(d))

其中：
- d：文档
- rank_i(d)：文档 d 在第 i 个检索结果中的排名
- k：平滑参数（通常为60）

直觉：排名越靠前，分数越高
```

---

### 为什么需要加权融合？

**第一性原理：** 不同向量字段的重要性可能不同

**示例：**
```python
# 场景：电商搜索

# 用户只输入文字 "红色连衣裙"
# → 文本向量更重要（权重0.8）

# 用户上传图片
# → 图片向量更重要（权重0.8）

# 用户既输入文字又上传图片
# → 两者同等重要（权重0.5）
```

**本质：** 加权融合提供了**可控的检索策略**，而不是固定的融合方式。

---

## 第一性原理的实践指导

### 原则1：只保留有区分度的向量字段

**判断标准：**
```python
def should_add_vector_field(field):
    """是否应该添加这个向量字段？"""
    # 1. 是否提供独特信息？（与现有字段不重复）
    # 2. 是否显著提升准确率？（实测提升>10%）
    # 3. 维护成本是否可接受？（更新频率、计算成本）
    return all([
        is_unique_information(field),
        improves_accuracy(field, threshold=0.1),
        is_maintainable(field)
    ])
```

---

### 原则2：根据场景选择融合算法

**决策树：**
```
不同度量方式（COSINE vs L2）？
├─ 是 → RRF
└─ 否 → 需要精细权重控制？
         ├─ 是 → 加权平均
         └─ 否 → RRF（默认）
```

---

### 原则3：向量检索 + 标量过滤

**组合策略：**
```python
# 向量检索：语义匹配（模糊）
# 标量过滤：硬约束（精确）

results = collection.hybrid_search(
    reqs=[text_req, image_req],  # 向量检索
    rerank=RRFRanker(),
    limit=10,
    expr="price < 1000 and stock > 0"  # 标量过滤
)
```

---

## 总结

**多向量检索的第一性原理：**

1. **本质**：现实对象是多模态的，单一向量无法完整表达
2. **价值**：提升准确率、支持多模态、增强灵活性
3. **实现**：多个向量字段 + 并行检索 + 融合算法
4. **应用**：RAG 多模态检索、电商搜索、智能客服等

**核心思想：** 通过多个互补的向量表示，更全面地理解和匹配复杂对象。

---

**继续学习：** [03_核心概念_多字段向量.md](./03_核心概念_多字段向量.md)
