# Agent执行器 - 实战代码4：执行控制

> 控制 Agent 的执行流程

---

## 学习目标

- 设置最大迭代次数
- 实现早停策略
- 处理超时和异常
- 监控执行过程

---

## 示例1：基础执行控制

```python
"""
基础执行控制
演示 max_iterations 和 early_stopping_method
"""

from langchain.agents import AgentExecutor, create_react_agent
from langchain_openai import ChatOpenAI
from langchain.tools import tool
from langchain.prompts import PromptTemplate

# 定义工具
@tool
def query_order(order_id: str) -> str:
    """查询订单信息"""
    return f"订单 {order_id} 已发货"

# 创建 Agent
llm = ChatOpenAI(model="gpt-4", temperature=0)
tools = [query_order]
prompt = PromptTemplate.from_template("...")

agent = create_react_agent(llm, tools, prompt)

# ===== 执行控制配置 =====
executor = AgentExecutor(
    agent=agent,
    tools=tools,
    max_iterations=10,              # 最大迭代次数
    early_stopping_method="generate",  # 早停策略
    handle_parsing_errors=True,     # 处理解析错误
    verbose=True,                   # 打印执行过程
)

# 运行
result = executor.invoke({"input": "订单12345什么时候到？"})
```

---

## 示例2：超时控制

```python
"""
超时控制
防止 Agent 执行时间过长
"""

import asyncio
from fastapi import FastAPI, HTTPException

app = FastAPI()

@app.post("/agent")
async def run_agent(question: str, timeout: float = 30.0):
    """运行 Agent，设置超时时间"""
    try:
        result = await asyncio.wait_for(
            executor.ainvoke({"input": question}),
            timeout=timeout
        )
        return {"answer": result["output"]}
    except asyncio.TimeoutError:
        raise HTTPException(status_code=504, detail="Agent 执行超时")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

## 示例3：中间步骤监控

```python
"""
中间步骤监控
记录和分析 Agent 的执行过程
"""

# 返回中间步骤
executor = AgentExecutor(
    agent=agent,
    tools=tools,
    return_intermediate_steps=True,  # 返回中间步骤
)

result = executor.invoke({"input": "问题"})

# 分析执行过程
print(f"迭代次数：{len(result['intermediate_steps'])}")

for i, (action, observation) in enumerate(result['intermediate_steps']):
    print(f"步骤{i+1}:")
    print(f"  工具: {action.tool}")
    print(f"  参数: {action.tool_input}")
    print(f"  结果: {observation}")
```

---

## 示例4：错误处理

```python
"""
错误处理
处理 Agent 执行中的各种错误
"""

async def run_agent_with_error_handling(question: str):
    """运行 Agent，完善的错误处理"""
    try:
        # 1. 超时控制
        result = await asyncio.wait_for(
            executor.ainvoke({"input": question}),
            timeout=30.0
        )

        # 2. 检查结果
        if not result.get("output"):
            return {"error": "Agent 未返回结果"}

        return {"answer": result["output"]}

    except asyncio.TimeoutError:
        return {"error": "执行超时"}

    except ValueError as e:
        # 参数错误
        return {"error": f"参数错误：{str(e)}"}

    except Exception as e:
        # 其他错误
        logger.error(f"Agent 执行失败：{str(e)}")
        return {"error": "执行失败"}
```

---

## 示例5：执行监控

```python
"""
执行监控
监控 Agent 的性能指标
"""

import time
import logging

logger = logging.getLogger(__name__)

async def run_agent_with_monitoring(question: str):
    """运行 Agent，记录监控指标"""

    start_time = time.time()

    try:
        result = await executor.ainvoke({"input": question})

        # 计算执行时间
        elapsed_time = time.time() - start_time

        # 记录指标
        iterations = len(result.get('intermediate_steps', []))

        logger.info(f"问题：{question}")
        logger.info(f"迭代次数：{iterations}")
        logger.info(f"执行时间：{elapsed_time:.2f}秒")

        # 告警
        if iterations >= 10:
            logger.warning(f"达到最大迭代次数：{question}")

        if elapsed_time > 10:
            logger.warning(f"执行时间过长：{elapsed_time:.2f}秒")

        return result["output"]

    except Exception as e:
        logger.error(f"执行失败：{str(e)}")
        raise
```

---

## 最佳实践

### 1. 合理设置 max_iterations

```python
# 简单任务
simple_executor = AgentExecutor(max_iterations=5)

# 复杂任务
complex_executor = AgentExecutor(max_iterations=20)
```

### 2. 使用 generate 早停策略

```python
executor = AgentExecutor(
    early_stopping_method="generate",  # 生产环境推荐
)
```

### 3. 添加超时控制

```python
result = await asyncio.wait_for(
    executor.ainvoke({"input": question}),
    timeout=30.0
)
```

### 4. 记录执行日志

```python
logger.info(f"问题：{question}")
logger.info(f"迭代次数：{iterations}")
logger.info(f"执行时间：{elapsed_time}")
```

---

## 学习检查清单

- [ ] 设置 max_iterations 参数
- [ ] 理解 force 和 generate 早停策略
- [ ] 实现超时控制
- [ ] 处理执行错误
- [ ] 监控中间步骤
- [ ] 记录执行日志

---

**版本：** v1.0
**最后更新：** 2026-02-12
