# Session 管理与分支 - 实战代码 04：多分支协作工作流

> 实现团队协作场景下的多分支管理和合并策略

---

## 场景：多个分支并行开发

实现：
- 多分支并行开发
- 分支状态跟踪
- 分支合并策略
- 团队协作工作流

---

## 完整代码实现

```typescript
/**
 * 多分支协作工作流实战示例
 * 演示：团队协作场景下的多分支管理
 */

import fs from 'fs/promises';
import path from 'path';

// ===== 类型定义（省略，与前面相同）=====

// ===== 分支管理器 =====

class BranchManager {
  constructor(private sessionsDir: string) {}

  // 创建分支
  async createBranch(
    baseSessionId: string,
    branchName: string,
    owner: string
  ): Promise<Session> {
    const forkManager = new ForkManager(this.sessionsDir);

    // 获取基础会话的最后节点
    const baseSession = new Session(baseSessionId, this.sessionsDir);
    const messages = await baseSession.getMessages();
    const lastNodeId = messages[messages.length - 1]?.id;

    // Fork 创建分支
    const branch = await forkManager.forkSession(
      baseSessionId,
      lastNodeId,
      branchName
    );

    // 添加分支元数据
    await branch.setName(branchName);
    const storage = new SessionStorage(branchName, this.sessionsDir);
    await storage.append({
      id: this.generateId(),
      type: 'metadata',
      branchOwner: owner,
      branchStatus: 'active',
      createdFrom: baseSessionId,
      timestamp: Date.now()
    });

    return branch;
  }

  // 获取所有分支
  async listBranches(baseSessionId: string): Promise<BranchInfo[]> {
    const manager = new SessionManager(this.sessionsDir);
    const allSessions = await manager.listSessions();

    const branches: BranchInfo[] = [];

    for (const session of allSessions) {
      const storage = new SessionStorage(session.id, this.sessionsDir);
      const entries = await storage.readAll();

      // 查找 fork 元数据
      const forkMetadata = entries.find(
        e => e.type === 'fork_metadata' && e.parentSessionId === baseSessionId
      );

      if (forkMetadata) {
        // 提取分支信息
        const metadata = entries.filter(e => e.type === 'metadata');
        const branchOwner = metadata.find(m => m.branchOwner)?.branchOwner;
        const branchStatus = metadata.find(m => m.branchStatus)?.branchStatus || 'active';

        branches.push({
          sessionId: session.id,
          name: session.name || session.id,
          owner: branchOwner,
          status: branchStatus,
          entryCount: session.entryCount,
          lastModified: session.lastModified
        });
      }
    }

    return branches;
  }

  // 更新分支状态
  async updateBranchStatus(
    branchId: string,
    status: 'active' | 'completed' | 'merged' | 'abandoned'
  ): Promise<void> {
    const storage = new SessionStorage(branchId, this.sessionsDir);
    await storage.append({
      id: this.generateId(),
      type: 'metadata',
      branchStatus: status,
      timestamp: Date.now()
    });
  }

  private generateId(): string {
    return Math.random().toString(36).substring(2, 15);
  }
}

interface BranchInfo {
  sessionId: string;
  name: string;
  owner?: string;
  status: string;
  entryCount: number;
  lastModified: number;
}

// ===== 使用示例 =====

async function main() {
  console.log('=== 多分支协作工作流示例 ===\n');

  const sessionsDir = path.join(process.cwd(), '.demo-sessions');
  await fs.mkdir(sessionsDir, { recursive: true });

  const manager = new SessionManager(sessionsDir);
  const branchManager = new BranchManager(sessionsDir);

  // 1. 创建主分支
  console.log('1. 创建主分支（项目需求讨论）');
  const mainBranch = await manager.createSession('project-main');
  await mainBranch.setName('主分支-项目需求');

  await mainBranch.appendMessage('user', '项目需求：实现电商平台');
  await mainBranch.appendMessage('assistant', '好的，我们需要实现以下模块：\n1. 用户系统\n2. 商品管理\n3. 订单系统\n4. 支付系统');
  await mainBranch.appendMessage('user', '团队分工：Alice负责后端，Bob负责前端，Charlie负责数据库');

  console.log(`   主分支创建完成\n`);

  // 2. Alice 创建后端分支
  console.log('2. Alice 创建后端分支');
  const backendBranch = await branchManager.createBranch(
    mainBranch.id,
    'backend-alice',
    'Alice'
  );

  await backendBranch.appendMessage('user', '开始实现后端 API');
  await backendBranch.appendMessage('assistant', '实现用户 API...');
  await backendBranch.appendMessage('assistant', '实现商品 API...');
  await backendBranch.appendMessage('user', '后端 API 完成');

  console.log(`   后端分支创建完成\n`);

  // 3. Bob 创建前端分支
  console.log('3. Bob 创建前端分支');
  const frontendBranch = await branchManager.createBranch(
    mainBranch.id,
    'frontend-bob',
    'Bob'
  );

  await frontendBranch.appendMessage('user', '开始实现前端界面');
  await frontendBranch.appendMessage('assistant', '实现用户界面...');
  await frontendBranch.appendMessage('assistant', '实现商品列表...');
  await frontendBranch.appendMessage('user', '前端界面完成');

  console.log(`   前端分支创建完成\n`);

  // 4. Charlie 创建数据库分支
  console.log('4. Charlie 创建数据库分支');
  const databaseBranch = await branchManager.createBranch(
    mainBranch.id,
    'database-charlie',
    'Charlie'
  );

  await databaseBranch.appendMessage('user', '开始设计数据库');
  await databaseBranch.appendMessage('assistant', '设计用户表...');
  await databaseBranch.appendMessage('assistant', '设计商品表...');
  await databaseBranch.appendMessage('user', '数据库设计完成');

  console.log(`   数据库分支创建完成\n`);

  // 5. 列出所有分支
  console.log('5. 列出所有分支');
  const branches = await branchManager.listBranches(mainBranch.id);
  console.log(`   总共 ${branches.length} 个分支:`);
  branches.forEach((branch, i) => {
    console.log(`   ${i + 1}. ${branch.name}`);
    console.log(`      - 负责人: ${branch.owner}`);
    console.log(`      - 状态: ${branch.status}`);
    console.log(`      - 条目数: ${branch.entryCount}`);
  });
  console.log();

  // 6. 更新分支状态
  console.log('6. 更新分支状态');
  await branchManager.updateBranchStatus(backendBranch.id, 'completed');
  await branchManager.updateBranchStatus(frontendBranch.id, 'completed');
  await branchManager.updateBranchStatus(databaseBranch.id, 'completed');
  console.log(`   所有分支已标记为完成\n`);

  // 7. 查看更新后的分支状态
  console.log('7. 查看更新后的分支状态');
  const updatedBranches = await branchManager.listBranches(mainBranch.id);
  updatedBranches.forEach((branch, i) => {
    console.log(`   ${i + 1}. ${branch.name} - 状态: ${branch.status}`);
  });

  console.log('\n=== 示例完成 ===');

  // 清理
  await fs.rm(sessionsDir, { recursive: true, force: true });
}

// 运行示例
main().catch(console.error);
```

---

## 运行输出示例

```
=== 多分支协作工作流示例 ===

1. 创建主分支（项目需求讨论）
   主分支创建完成

2. Alice 创建后端分支
   后端分支创建完成

3. Bob 创建前端分支
   前端分支创建完成

4. Charlie 创建数据库分支
   数据库分支创建完成

5. 列出所有分支
   总共 3 个分支:
   1. database-charlie
      - 负责人: Charlie
      - 状态: active
      - 条目数: 8
   2. frontend-bob
      - 负责人: Bob
      - 状态: active
      - 条目数: 8
   3. backend-alice
      - 负责人: Alice
      - 状态: active
      - 条目数: 8

6. 更新分支状态
   所有分支已标记为完成

7. 查看更新后的分支状态
   1. database-charlie - 状态: completed
   2. frontend-bob - 状态: completed
   3. backend-alice - 状态: completed

=== 示例完成 ===
```

---

## 学习检查清单

- [ ] 实现分支管理器
- [ ] 创建多个并行分支
- [ ] 跟踪分支状态
- [ ] 列出和管理分支
- [ ] 应用于团队协作场景

---

**版本：** v1.0
**最后更新：** 2026-02-18
**维护者：** Claude Code
