# 最小可用知识

掌握以下内容，就能开始配置 Milvus 资源：

---

## 4.1 内存配置三要素

**核心原则：计算需求 → 分配资源 → 预留余量**

```python
# 快速计算内存需求
def quick_memory_estimate(num_vectors: int, vector_dim: int) -> dict:
    """
    快速估算内存需求

    参数：
    - num_vectors: 向量数量
    - vector_dim: 向量维度

    返回：推荐配置
    """
    # 1. 原始数据大小
    raw_size_gb = (num_vectors * vector_dim * 4) / (1024**3)

    # 2. 使用 IVF_PQ 压缩（压缩到 15%）
    compressed_gb = raw_size_gb * 0.15

    # 3. 加上查询缓冲区（20%）
    with_buffer_gb = compressed_gb * 1.2

    # 4. 安全余量（30%）
    recommended_gb = with_buffer_gb * 1.3

    return {
        "raw_data_gb": round(raw_size_gb, 2),
        "compressed_gb": round(compressed_gb, 2),
        "recommended_memory_gb": round(recommended_gb, 2)
    }

# 示例：1000万向量
config = quick_memory_estimate(10_000_000, 768)
print(f"推荐内存: {config['recommended_memory_gb']} GB")
# 输出: 推荐内存: 13.68 GB
```

**配置文件**：

```yaml
# milvus.yaml
queryNode:
  cache:
    memoryLimit: 14680064000  # 约 14GB (字节)
```

---

## 4.2 缓存配置两步走

**步骤1：确定缓存大小（总内存的 10-20%）**

```python
# 缓存大小计算
total_memory_gb = 32
cache_size_gb = total_memory_gb * 0.15  # 15%
cache_size_mb = int(cache_size_gb * 1024)

print(f"推荐缓存大小: {cache_size_mb} MB")
# 输出: 推荐缓存大小: 4915 MB
```

**步骤2：启用缓存**

```yaml
# milvus.yaml
queryNode:
  cache:
    enabled: true
    memoryLimit: 4915  # MB
    expiration: 600    # 10分钟
```

**Python 代码**：

```python
from pymilvus import Collection

collection = Collection("my_collection")
collection.set_properties({
    "cache.enabled": "true",
    "cache.size": "4915",
    "cache.ttl": "600"
})
```

---

## 4.3 并发配置公式

**公式：最大并发 = min(内存限制, CPU限制) × 0.8**

```python
# 并发数计算
def calculate_max_concurrent(
    memory_gb: int,
    query_memory_mb: int,
    cpu_cores: int
) -> int:
    """
    计算最大并发数

    参数：
    - memory_gb: 可用内存（GB）
    - query_memory_mb: 每个查询的内存需求（MB）
    - cpu_cores: CPU 核心数

    返回：推荐最大并发数
    """
    # 内存限制
    memory_limit = (memory_gb * 1024) // query_memory_mb

    # CPU 限制（每核心 3 个查询）
    cpu_limit = cpu_cores * 3

    # 取较小值，并留 20% 余量
    max_concurrent = int(min(memory_limit, cpu_limit) * 0.8)

    return max_concurrent

# 示例
max_queries = calculate_max_concurrent(
    memory_gb=16,
    query_memory_mb=200,
    cpu_cores=16
)

print(f"推荐最大并发: {max_queries}")
# 输出: 推荐最大并发: 38
```

**配置文件**：

```yaml
# milvus.yaml
queryNode:
  maxConcurrentQueries: 38
  queryQueueSize: 200
  queryTimeout: 10
```

---

## 4.4 快速验证配置

**验证脚本**：

```python
from pymilvus import connections, utility

# 连接到 Milvus
connections.connect("default", host="localhost", port="19530")

# 获取系统信息
info = utility.get_server_version()
print(f"Milvus 版本: {info}")

# 检查内存使用
stats = utility.get_query_segment_info("my_collection")
total_memory = sum(seg.mem_size for seg in stats)
print(f"Collection 内存使用: {total_memory / (1024**3):.2f} GB")

# 测试查询性能
import time
import numpy as np

query_vector = np.random.rand(768).tolist()
start = time.time()

from pymilvus import Collection
collection = Collection("my_collection")
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10
)

latency = (time.time() - start) * 1000
print(f"查询延迟: {latency:.2f}ms")

# 判断配置是否合理
if latency < 50:
    print("✅ 配置良好")
elif latency < 100:
    print("⚠️ 配置可接受，可以优化")
else:
    print("❌ 配置需要优化")
```

---

## 4.5 常见配置模板

### 小规模场景（< 100万向量）

```yaml
# 推荐配置：8GB 内存
queryNode:
  cache:
    memoryLimit: 6442450944  # 6GB
  maxConcurrentQueries: 20
```

### 中等规模场景（100万-1000万向量）

```yaml
# 推荐配置：32GB 内存
queryNode:
  cache:
    memoryLimit: 25769803776  # 24GB
  maxConcurrentQueries: 50
```

### 大规模场景（> 1000万向量）

```yaml
# 推荐配置：64GB+ 内存
queryNode:
  cache:
    memoryLimit: 51539607552  # 48GB
  maxConcurrentQueries: 100
```

---

## 这些知识足以：

- ✅ 根据数据量计算内存需求
- ✅ 配置合理的缓存大小
- ✅ 设置并发限制避免系统崩溃
- ✅ 验证配置是否生效
- ✅ 为不同规模的场景选择配置模板
- ✅ 为后续的性能调优打下基础

---

## 下一步学习

掌握了最小可用知识后，可以深入学习：
1. **内存优化**：分层内存策略、动态调整
2. **缓存优化**：LRU vs LFU、缓存预热
3. **并发优化**：限流、熔断、队列管理
4. **监控调优**：性能指标、瓶颈分析
