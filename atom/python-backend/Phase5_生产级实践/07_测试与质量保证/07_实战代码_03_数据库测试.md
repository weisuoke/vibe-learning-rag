# 实战代码 03 - 数据库测试

## 项目结构

```
project/
├── app/
│   ├── database.py
│   ├── models/
│   │   ├── user.py
│   │   └── post.py
│   └── repositories/
│       └── user_repository.py
├── tests/
│   ├── conftest.py
│   ├── test_models.py
│   └── test_repositories.py
└── pytest.ini
```

---

## 数据库配置

### 数据库模型

```python
# app/database.py
"""数据库配置"""
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

def get_engine(database_url: str):
    """创建数据库引擎"""
    return create_engine(database_url, echo=False)

def get_session_factory(engine):
    """创建会话工厂"""
    return sessionmaker(bind=engine, autocommit=False, autoflush=False)
```

```python
# app/models/user.py
"""用户模型"""
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from app.database import Base

class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False)
    hashed_password = Column(String(255), nullable=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # 关系
    posts = relationship("Post", back_populates="author", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<User(id={self.id}, username='{self.username}')>"
```

```python
# app/models/post.py
"""文章模型"""
from sqlalchemy import Column, Integer, String, Text, ForeignKey, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from app.database import Base

class Post(Base):
    """文章表"""
    __tablename__ = "posts"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(200), nullable=False)
    content = Column(Text, nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 关系
    author = relationship("User", back_populates="posts")

    def __repr__(self):
        return f"<Post(id={self.id}, title='{self.title}')>"
```

---

## 测试配置

### conftest.py

```python
# tests/conftest.py
"""测试配置"""
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from app.database import Base
from app.models.user import User
from app.models.post import Post


@pytest.fixture(scope="session")
def engine():
    """测试数据库引擎（会话级别）"""
    # 使用内存数据库
    test_engine = create_engine("sqlite:///:memory:", echo=False)

    # 创建所有表
    Base.metadata.create_all(test_engine)

    yield test_engine

    # 清理
    Base.metadata.drop_all(test_engine)
    test_engine.dispose()


@pytest.fixture(scope="function")
def db_session(engine):
    """数据库会话（函数级别，每个测试独立）"""
    # 创建连接
    connection = engine.connect()

    # 开始事务
    transaction = connection.begin()

    # 创建会话
    SessionLocal = sessionmaker(bind=connection)
    session = SessionLocal()

    yield session

    # 回滚事务（撤销所有修改）
    session.close()
    transaction.rollback()
    connection.close()


@pytest.fixture
def sample_user(db_session):
    """示例用户"""
    user = User(
        username="testuser",
        email="test@example.com",
        hashed_password="hashed_password_123"
    )
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)
    return user


@pytest.fixture
def sample_users(db_session):
    """多个示例用户"""
    users = [
        User(
            username=f"user{i}",
            email=f"user{i}@example.com",
            hashed_password="hashed_password"
        )
        for i in range(5)
    ]
    db_session.add_all(users)
    db_session.commit()
    for user in users:
        db_session.refresh(user)
    return users


@pytest.fixture
def sample_post(db_session, sample_user):
    """示例文章"""
    post = Post(
        title="Test Post",
        content="This is a test post content.",
        user_id=sample_user.id
    )
    db_session.add(post)
    db_session.commit()
    db_session.refresh(post)
    return post
```

---

## 模型测试

```python
# tests/test_models.py
"""数据库模型测试"""
import pytest
from datetime import datetime
from app.models.user import User
from app.models.post import Post


class TestUserModel:
    """用户模型测试"""

    def test_create_user(self, db_session):
        """测试：创建用户"""
        user = User(
            username="alice",
            email="alice@example.com",
            hashed_password="hashed_pwd"
        )
        db_session.add(user)
        db_session.commit()

        # 验证 ID 已生成
        assert user.id is not None

        # 验证默认值
        assert user.is_active is True
        assert isinstance(user.created_at, datetime)

    def test_user_unique_username(self, db_session):
        """测试：用户名唯一性"""
        # 创建第一个用户
        user1 = User(
            username="alice",
            email="alice1@example.com",
            hashed_password="pwd"
        )
        db_session.add(user1)
        db_session.commit()

        # 尝试创建相同用户名的用户
        user2 = User(
            username="alice",
            email="alice2@example.com",
            hashed_password="pwd"
        )
        db_session.add(user2)

        # 应该抛出异常
        with pytest.raises(Exception):  # IntegrityError
            db_session.commit()

    def test_user_unique_email(self, db_session):
        """测试：邮箱唯一性"""
        # 创建第一个用户
        user1 = User(
            username="alice",
            email="same@example.com",
            hashed_password="pwd"
        )
        db_session.add(user1)
        db_session.commit()

        # 尝试创建相同邮箱的用户
        user2 = User(
            username="bob",
            email="same@example.com",
            hashed_password="pwd"
        )
        db_session.add(user2)

        with pytest.raises(Exception):
            db_session.commit()

    def test_query_user_by_username(self, db_session, sample_user):
        """测试：根据用户名查询"""
        found = db_session.query(User).filter_by(username="testuser").first()

        assert found is not None
        assert found.id == sample_user.id
        assert found.email == sample_user.email

    def test_query_user_by_id(self, db_session, sample_user):
        """测试：根据 ID 查询"""
        found = db_session.query(User).filter_by(id=sample_user.id).first()

        assert found is not None
        assert found.username == "testuser"

    def test_update_user(self, db_session, sample_user):
        """测试：更新用户"""
        # 更新邮箱
        sample_user.email = "newemail@example.com"
        db_session.commit()

        # 重新查询验证
        found = db_session.query(User).filter_by(id=sample_user.id).first()
        assert found.email == "newemail@example.com"

    def test_delete_user(self, db_session, sample_user):
        """测试：删除用户"""
        user_id = sample_user.id

        # 删除用户
        db_session.delete(sample_user)
        db_session.commit()

        # 验证已删除
        found = db_session.query(User).filter_by(id=user_id).first()
        assert found is None

    def test_user_repr(self, sample_user):
        """测试：用户字符串表示"""
        repr_str = repr(sample_user)
        assert "User" in repr_str
        assert "testuser" in repr_str


class TestPostModel:
    """文章模型测试"""

    def test_create_post(self, db_session, sample_user):
        """测试：创建文章"""
        post = Post(
            title="My First Post",
            content="This is the content.",
            user_id=sample_user.id
        )
        db_session.add(post)
        db_session.commit()

        assert post.id is not None
        assert isinstance(post.created_at, datetime)
        assert isinstance(post.updated_at, datetime)

    def test_post_author_relationship(self, db_session, sample_user, sample_post):
        """测试：文章-作者关系"""
        # 通过文章访问作者
        assert sample_post.author.id == sample_user.id
        assert sample_post.author.username == "testuser"

        # 通过作者访问文章
        assert len(sample_user.posts) == 1
        assert sample_user.posts[0].id == sample_post.id

    def test_query_posts_by_user(self, db_session, sample_user):
        """测试：查询用户的所有文章"""
        # 创建多篇文章
        posts = [
            Post(title=f"Post {i}", content=f"Content {i}", user_id=sample_user.id)
            for i in range(3)
        ]
        db_session.add_all(posts)
        db_session.commit()

        # 查询
        found_posts = db_session.query(Post).filter_by(user_id=sample_user.id).all()

        assert len(found_posts) == 3

    def test_update_post(self, db_session, sample_post):
        """测试：更新文章"""
        original_updated_at = sample_post.updated_at

        # 更新标题
        sample_post.title = "Updated Title"
        db_session.commit()

        # 验证更新
        found = db_session.query(Post).filter_by(id=sample_post.id).first()
        assert found.title == "Updated Title"
        # updated_at 应该自动更新（如果数据库支持）

    def test_delete_post(self, db_session, sample_post):
        """测试：删除文章"""
        post_id = sample_post.id

        db_session.delete(sample_post)
        db_session.commit()

        found = db_session.query(Post).filter_by(id=post_id).first()
        assert found is None

    def test_cascade_delete(self, db_session, sample_user):
        """测试：级联删除"""
        # 创建文章
        post = Post(
            title="Test Post",
            content="Content",
            user_id=sample_user.id
        )
        db_session.add(post)
        db_session.commit()
        post_id = post.id

        # 删除用户（应该级联删除文章）
        db_session.delete(sample_user)
        db_session.commit()

        # 验证文章也被删除
        found_post = db_session.query(Post).filter_by(id=post_id).first()
        assert found_post is None


class TestQueryOperations:
    """查询操作测试"""

    def test_count_users(self, db_session, sample_users):
        """测试：统计用户数"""
        count = db_session.query(User).count()
        assert count == 5

    def test_filter_active_users(self, db_session, sample_users):
        """测试：过滤活跃用户"""
        # 停用一个用户
        sample_users[0].is_active = False
        db_session.commit()

        # 查询活跃用户
        active_users = db_session.query(User).filter_by(is_active=True).all()
        assert len(active_users) == 4

    def test_order_by(self, db_session, sample_users):
        """测试：排序"""
        # 按用户名排序
        users = db_session.query(User).order_by(User.username).all()

        usernames = [u.username for u in users]
        assert usernames == sorted(usernames)

    def test_limit_and_offset(self, db_session, sample_users):
        """测试：分页"""
        # 获取前2个用户
        page1 = db_session.query(User).order_by(User.id).limit(2).all()
        assert len(page1) == 2

        # 获取第3-4个用户
        page2 = db_session.query(User).order_by(User.id).offset(2).limit(2).all()
        assert len(page2) == 2
        assert page2[0].id != page1[0].id

    def test_like_query(self, db_session, sample_users):
        """测试：模糊查询"""
        # 查询用户名包含 "user" 的用户
        users = db_session.query(User).filter(User.username.like("%user%")).all()
        assert len(users) == 5

        # 查询用户名以 "user1" 开头的用户
        users = db_session.query(User).filter(User.username.like("user1%")).all()
        assert len(users) == 1

    def test_in_query(self, db_session, sample_users):
        """测试：IN 查询"""
        usernames = ["user0", "user2", "user4"]
        users = db_session.query(User).filter(User.username.in_(usernames)).all()

        assert len(users) == 3
        found_usernames = [u.username for u in users]
        assert set(found_usernames) == set(usernames)
```

---

## Repository 测试

```python
# app/repositories/user_repository.py
"""用户仓库"""
from typing import Optional, List
from sqlalchemy.orm import Session
from app.models.user import User


class UserRepository:
    """用户仓库"""

    def __init__(self, session: Session):
        self.session = session

    def create(self, username: str, email: str, hashed_password: str) -> User:
        """创建用户"""
        user = User(
            username=username,
            email=email,
            hashed_password=hashed_password
        )
        self.session.add(user)
        self.session.commit()
        self.session.refresh(user)
        return user

    def get_by_id(self, user_id: int) -> Optional[User]:
        """根据 ID 获取用户"""
        return self.session.query(User).filter_by(id=user_id).first()

    def get_by_username(self, username: str) -> Optional[User]:
        """根据用户名获取用户"""
        return self.session.query(User).filter_by(username=username).first()

    def get_by_email(self, email: str) -> Optional[User]:
        """根据邮箱获取用户"""
        return self.session.query(User).filter_by(email=email).first()

    def get_all(self, skip: int = 0, limit: int = 100) -> List[User]:
        """获取所有用户（分页）"""
        return self.session.query(User).offset(skip).limit(limit).all()

    def get_active_users(self) -> List[User]:
        """获取活跃用户"""
        return self.session.query(User).filter_by(is_active=True).all()

    def update(self, user: User) -> User:
        """更新用户"""
        self.session.commit()
        self.session.refresh(user)
        return user

    def delete(self, user: User) -> None:
        """删除用户"""
        self.session.delete(user)
        self.session.commit()

    def count(self) -> int:
        """统计用户数"""
        return self.session.query(User).count()

    def exists_by_username(self, username: str) -> bool:
        """检查用户名是否存在"""
        return self.session.query(User).filter_by(username=username).first() is not None

    def exists_by_email(self, email: str) -> bool:
        """检查邮箱是否存在"""
        return self.session.query(User).filter_by(email=email).first() is not None
```

```python
# tests/test_repositories.py
"""仓库测试"""
import pytest
from app.repositories.user_repository import UserRepository
from app.models.user import User


@pytest.fixture
def user_repo(db_session):
    """用户仓库 fixture"""
    return UserRepository(db_session)


class TestUserRepositoryCreate:
    """用户创建测试"""

    def test_create_user(self, user_repo):
        """测试：创建用户"""
        user = user_repo.create(
            username="alice",
            email="alice@example.com",
            hashed_password="hashed_pwd"
        )

        assert user.id is not None
        assert user.username == "alice"
        assert user.email == "alice@example.com"
        assert user.is_active is True

    def test_create_multiple_users(self, user_repo):
        """测试：创建多个用户"""
        user1 = user_repo.create("alice", "alice@example.com", "pwd")
        user2 = user_repo.create("bob", "bob@example.com", "pwd")

        assert user1.id != user2.id
        assert user_repo.count() == 2


class TestUserRepositoryGet:
    """用户查询测试"""

    def test_get_by_id(self, user_repo, sample_user):
        """测试：根据 ID 获取"""
        found = user_repo.get_by_id(sample_user.id)

        assert found is not None
        assert found.username == sample_user.username

    def test_get_by_id_not_found(self, user_repo):
        """测试：ID 不存在"""
        found = user_repo.get_by_id(99999)
        assert found is None

    def test_get_by_username(self, user_repo, sample_user):
        """测试：根据用户名获取"""
        found = user_repo.get_by_username("testuser")

        assert found is not None
        assert found.id == sample_user.id

    def test_get_by_username_not_found(self, user_repo):
        """测试：用户名不存在"""
        found = user_repo.get_by_username("nonexistent")
        assert found is None

    def test_get_by_email(self, user_repo, sample_user):
        """测试：根据邮箱获取"""
        found = user_repo.get_by_email("test@example.com")

        assert found is not None
        assert found.id == sample_user.id

    def test_get_all(self, user_repo, sample_users):
        """测试：获取所有用户"""
        users = user_repo.get_all()

        assert len(users) == 5

    def test_get_all_with_pagination(self, user_repo, sample_users):
        """测试：分页获取"""
        # 第一页
        page1 = user_repo.get_all(skip=0, limit=2)
        assert len(page1) == 2

        # 第二页
        page2 = user_repo.get_all(skip=2, limit=2)
        assert len(page2) == 2

        # 确保不重复
        page1_ids = {u.id for u in page1}
        page2_ids = {u.id for u in page2}
        assert page1_ids.isdisjoint(page2_ids)

    def test_get_active_users(self, user_repo, sample_users, db_session):
        """测试：获取活跃用户"""
        # 停用一个用户
        sample_users[0].is_active = False
        db_session.commit()

        active_users = user_repo.get_active_users()

        assert len(active_users) == 4
        assert all(u.is_active for u in active_users)


class TestUserRepositoryUpdate:
    """用户更新测试"""

    def test_update_user(self, user_repo, sample_user):
        """测试：更新用户"""
        # 修改邮箱
        sample_user.email = "newemail@example.com"
        updated = user_repo.update(sample_user)

        assert updated.email == "newemail@example.com"

        # 验证更新已保存
        found = user_repo.get_by_id(sample_user.id)
        assert found.email == "newemail@example.com"

    def test_update_multiple_fields(self, user_repo, sample_user):
        """测试：更新多个字段"""
        sample_user.email = "new@example.com"
        sample_user.is_active = False
        user_repo.update(sample_user)

        found = user_repo.get_by_id(sample_user.id)
        assert found.email == "new@example.com"
        assert found.is_active is False


class TestUserRepositoryDelete:
    """用户删除测试"""

    def test_delete_user(self, user_repo, sample_user):
        """测试：删除用户"""
        user_id = sample_user.id

        user_repo.delete(sample_user)

        # 验证已删除
        found = user_repo.get_by_id(user_id)
        assert found is None

    def test_delete_and_count(self, user_repo, sample_users):
        """测试：删除后统计"""
        initial_count = user_repo.count()
        assert initial_count == 5

        user_repo.delete(sample_users[0])

        assert user_repo.count() == 4


class TestUserRepositoryExists:
    """用户存在性测试"""

    def test_exists_by_username(self, user_repo, sample_user):
        """测试：检查用户名存在"""
        assert user_repo.exists_by_username("testuser") is True
        assert user_repo.exists_by_username("nonexistent") is False

    def test_exists_by_email(self, user_repo, sample_user):
        """测试：检查邮箱存在"""
        assert user_repo.exists_by_email("test@example.com") is True
        assert user_repo.exists_by_email("nonexistent@example.com") is False


class TestUserRepositoryCount:
    """用户统计测试"""

    def test_count_empty(self, user_repo):
        """测试：空数据库"""
        assert user_repo.count() == 0

    def test_count_after_operations(self, user_repo):
        """测试：操作后统计"""
        assert user_repo.count() == 0

        user_repo.create("alice", "alice@example.com", "pwd")
        assert user_repo.count() == 1

        user_repo.create("bob", "bob@example.com", "pwd")
        assert user_repo.count() == 2

        user = user_repo.get_by_username("alice")
        user_repo.delete(user)
        assert user_repo.count() == 1
```

---

## 运行测试

```bash
# 运行所有数据库测试
pytest tests/test_models.py tests/test_repositories.py -v

# 运行特定测试类
pytest tests/test_models.py::TestUserModel -v

# 运行特定测试函数
pytest tests/test_models.py::TestUserModel::test_create_user -v

# 显示详细输出
pytest tests/ -v -s

# 生成覆盖率报告
pytest tests/ --cov=app --cov-report=html
```

---

## 总结

### 核心要点

1. **测试数据库配置**：使用内存数据库（SQLite）快速测试
2. **事务回滚**：每个测试后回滚，保证测试独立性
3. **fixture 复用**：使用 fixture 准备测试数据
4. **模型测试**：测试 CRUD 操作、关系、约束
5. **Repository 测试**：测试业务逻辑层

### 最佳实践

- 使用内存数据库加速测试
- 每个测试独立（事务回滚）
- 测试所有 CRUD 操作
- 测试约束和关系
- 测试边界条件
