# æ ¸å¿ƒæ¦‚å¿µ

æŒæ¡ä¸‰ä¸ªæœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Œè¦†ç›– 90% çš„ RAG å‘é‡å­˜å‚¨åœºæ™¯ã€‚

---

## æ ¸å¿ƒæ¦‚å¿µ1ï¼šç´¢å¼•ç±»å‹ï¼ˆIndex Typesï¼‰

**ç´¢å¼•æ˜¯åŠ é€Ÿå‘é‡æœç´¢çš„æ•°æ®ç»“æ„ï¼Œä¸åŒç´¢å¼•åœ¨é€Ÿåº¦ã€ç²¾åº¦ã€å†…å­˜ä¹‹é—´æœ‰ä¸åŒæƒè¡¡ã€‚**

### ä¸‰ç§ä¸»æµç´¢å¼•

#### 1. Flatï¼ˆæš´åŠ›æœç´¢ï¼‰

```python
# Flat ç´¢å¼•ï¼šéå†æ‰€æœ‰å‘é‡ï¼Œè®¡ç®—è·ç¦»
def flat_search(query, vectors, k):
    distances = []
    for i, vec in enumerate(vectors):
        dist = cosine_distance(query, vec)
        distances.append((i, dist))
    return sorted(distances, key=lambda x: x[1])[:k]
```

**ç‰¹ç‚¹ï¼š**
- âœ… 100% ç²¾ç¡®ï¼Œä¸ä¼šæ¼æ‰ä»»ä½•ç»“æœ
- âŒ é€Ÿåº¦æ…¢ï¼ŒO(N) å¤æ‚åº¦
- é€‚ç”¨ï¼šæ•°æ®é‡å°ï¼ˆ< 1ä¸‡ï¼‰ï¼Œæˆ–éœ€è¦ç²¾ç¡®ç»“æœ

#### 2. IVFï¼ˆå€’æ’æ–‡ä»¶ç´¢å¼•ï¼‰

```
åŸç†ï¼šæŠŠå‘é‡ç©ºé—´åˆ’åˆ†æˆå¤šä¸ªåŒºåŸŸï¼ˆèšç±»ï¼‰ï¼ŒæŸ¥è¯¢æ—¶åªæœç´¢æœ€è¿‘çš„å‡ ä¸ªåŒºåŸŸ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚    â—â—â—        â—‹â—‹â—‹â—‹                  â”‚
â”‚   â—â—â—â—â—      â—‹â—‹â—‹â—‹â—‹â—‹                 â”‚
â”‚    â—â—â—        â—‹â—‹â—‹â—‹     â—†â—†â—†         â”‚
â”‚              â—‹â—‹â—‹      â—†â—†â—†â—†â—†        â”‚
â”‚                        â—†â—†â—†         â”‚
â”‚   â–²â–²â–²                              â”‚
â”‚  â–²â–²â–²â–²â–²       â– â– â– â–                   â”‚
â”‚   â–²â–²â–²       â– â– â– â– â– â–                  â”‚
â”‚              â– â– â– â–                    â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  4ä¸ªèšç±»åŒºåŸŸï¼ŒæŸ¥è¯¢æ—¶åªæœç´¢æœ€è¿‘çš„1-2ä¸ªåŒºåŸŸ
```

**ç‰¹ç‚¹ï¼š**
- âœ… é€Ÿåº¦å¿«ï¼Œåªæœç´¢éƒ¨åˆ†æ•°æ®
- âŒ å¯èƒ½æ¼æ‰è¾¹ç•Œé™„è¿‘çš„ç»“æœ
- å‚æ•°ï¼š`nlist`ï¼ˆèšç±»æ•°ï¼‰ã€`nprobe`ï¼ˆæœç´¢çš„èšç±»æ•°ï¼‰

```python
# Milvus ä¸­ä½¿ç”¨ IVF
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "COSINE",
    "params": {"nlist": 1024}  # åˆ’åˆ†æˆ1024ä¸ªåŒºåŸŸ
}

search_params = {
    "params": {"nprobe": 16}  # æœç´¢16ä¸ªæœ€è¿‘çš„åŒºåŸŸ
}
```

#### 3. HNSWï¼ˆåˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œå›¾ï¼‰

```
åŸç†ï¼šæ„å»ºå¤šå±‚å›¾ç»“æ„ï¼Œä»é¡¶å±‚å¿«é€Ÿå®šä½ï¼Œé€å±‚ç»†åŒ–

Layer 2 (ç¨€ç–):    A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ B
                   â”‚             â”‚
Layer 1 (ä¸­ç­‰):    A â”€â”€ C â”€â”€ D â”€â”€ B
                   â”‚    â”‚    â”‚    â”‚
Layer 0 (ç¨ å¯†):    Aâ”€Eâ”€Câ”€Fâ”€Dâ”€Gâ”€Bâ”€H

æŸ¥è¯¢è¿‡ç¨‹ï¼š
1. ä»é¡¶å±‚å¼€å§‹ï¼Œæ‰¾åˆ°æœ€è¿‘çš„èŠ‚ç‚¹
2. ä¸‹é™åˆ°ä¸‹ä¸€å±‚ï¼Œç»§ç»­æœç´¢
3. é‡å¤ç›´åˆ°æœ€åº•å±‚ï¼Œè¿”å›ç»“æœ
```

**ç‰¹ç‚¹ï¼š**
- âœ… é€Ÿåº¦å¿«ï¼Œç²¾åº¦é«˜ï¼ˆæœ€ä½³å¹³è¡¡ï¼‰
- âŒ å†…å­˜å ç”¨è¾ƒå¤§ï¼Œæ„å»ºæ—¶é—´é•¿
- å‚æ•°ï¼š`M`ï¼ˆæ¯å±‚è¿æ¥æ•°ï¼‰ã€`ef_construction`ï¼ˆæ„å»ºæ—¶æœç´¢èŒƒå›´ï¼‰

```python
# ChromaDB é»˜è®¤ä½¿ç”¨ HNSW
# Milvus ä¸­ä½¿ç”¨ HNSW
index_params = {
    "index_type": "HNSW",
    "metric_type": "COSINE",
    "params": {
        "M": 16,              # æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°
        "efConstruction": 256  # æ„å»ºæ—¶çš„æœç´¢èŒƒå›´
    }
}
```

### ç´¢å¼•å¯¹æ¯”

| ç´¢å¼•ç±»å‹ | æœç´¢é€Ÿåº¦ | ç²¾åº¦ | å†…å­˜å ç”¨ | é€‚ç”¨åœºæ™¯ |
|----------|----------|------|----------|----------|
| Flat | ğŸ¢ æ…¢ | 100% | ä½ | å°æ•°æ®é‡ã€ç²¾ç¡®æœç´¢ |
| IVF | ğŸš€ å¿« | 95%+ | ä¸­ | å¤§æ•°æ®é‡ã€å¯æ¥å—è¿‘ä¼¼ |
| HNSW | ğŸš€ å¿« | 98%+ | é«˜ | è¿½æ±‚é€Ÿåº¦å’Œç²¾åº¦å¹³è¡¡ |

### åœ¨ RAG å¼€å‘ä¸­çš„é€‰æ‹©

```
æ•°æ®é‡ < 1ä¸‡ â†’ Flatï¼ˆç®€å•å¯é ï¼‰
æ•°æ®é‡ 1ä¸‡-100ä¸‡ â†’ HNSWï¼ˆæ¨èï¼ŒChromaDB é»˜è®¤ï¼‰
æ•°æ®é‡ > 100ä¸‡ â†’ IVF æˆ– HNSWï¼ˆæ ¹æ®å†…å­˜é€‰æ‹©ï¼‰
```

---

## æ ¸å¿ƒæ¦‚å¿µ2ï¼šç›¸ä¼¼åº¦åº¦é‡ï¼ˆDistance Metricsï¼‰

**ç›¸ä¼¼åº¦åº¦é‡å†³å®šäº†"ä¸¤ä¸ªå‘é‡æœ‰å¤šç›¸ä¼¼"çš„è®¡ç®—æ–¹å¼ã€‚**

### ä¸‰ç§ä¸»æµåº¦é‡

#### 1. ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰

```python
import numpy as np

def cosine_similarity(a, b):
    """
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦

    èŒƒå›´ï¼š[-1, 1]
    1 = å®Œå…¨ç›¸åŒæ–¹å‘
    0 = æ­£äº¤ï¼ˆæ— å…³ï¼‰
    -1 = å®Œå…¨ç›¸åæ–¹å‘
    """
    return np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))

# ç¤ºä¾‹
vec1 = [1, 0, 0]
vec2 = [1, 1, 0]
print(cosine_similarity(vec1, vec2))  # 0.707
```

**ç‰¹ç‚¹ï¼š**
- âœ… åªå…³æ³¨æ–¹å‘ï¼Œä¸å…³æ³¨é•¿åº¦
- âœ… å¯¹æ–‡æœ¬è¯­ä¹‰åŒ¹é…æ•ˆæœå¥½
- é€‚ç”¨ï¼š**RAG é¦–é€‰**ï¼Œæ–‡æœ¬ç›¸ä¼¼åº¦

#### 2. æ¬§æ°è·ç¦»ï¼ˆEuclidean Distance / L2ï¼‰

```python
def euclidean_distance(a, b):
    """
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„æ¬§æ°è·ç¦»

    èŒƒå›´ï¼š[0, +âˆ)
    0 = å®Œå…¨ç›¸åŒ
    è¶Šå¤§ = è¶Šä¸ç›¸ä¼¼
    """
    return np.linalg.norm(np.array(a) - np.array(b))

# ç¤ºä¾‹
vec1 = [1, 0, 0]
vec2 = [1, 1, 0]
print(euclidean_distance(vec1, vec2))  # 1.0
```

**ç‰¹ç‚¹ï¼š**
- âœ… ç›´è§‚ï¼Œå°±æ˜¯ç©ºé—´ä¸­çš„ç›´çº¿è·ç¦»
- âŒ å—å‘é‡é•¿åº¦å½±å“
- é€‚ç”¨ï¼šå›¾åƒç‰¹å¾ã€å½’ä¸€åŒ–åçš„å‘é‡

#### 3. å†…ç§¯ï¼ˆInner Product / IPï¼‰

```python
def inner_product(a, b):
    """
    è®¡ç®—ä¸¤ä¸ªå‘é‡çš„å†…ç§¯

    èŒƒå›´ï¼š(-âˆ, +âˆ)
    è¶Šå¤§ = è¶Šç›¸ä¼¼
    """
    return np.dot(a, b)

# ç¤ºä¾‹
vec1 = [1, 0, 0]
vec2 = [1, 1, 0]
print(inner_product(vec1, vec2))  # 1.0
```

**ç‰¹ç‚¹ï¼š**
- âœ… è®¡ç®—æœ€å¿«
- âŒ å—å‘é‡é•¿åº¦å½±å“
- é€‚ç”¨ï¼šå·²å½’ä¸€åŒ–çš„å‘é‡ï¼ˆæ­¤æ—¶ç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰

### åº¦é‡å¯¹æ¯”

| åº¦é‡ | å…¬å¼ | èŒƒå›´ | ç‰¹ç‚¹ | RAG æ¨è |
|------|------|------|------|----------|
| Cosine | cos(Î¸) | [-1, 1] | åªçœ‹æ–¹å‘ | âœ… é¦–é€‰ |
| L2 | âˆšÎ£(a-b)Â² | [0, âˆ) | çœ‹è·ç¦» | å¯ç”¨ |
| IP | Î£(aÃ—b) | (-âˆ, âˆ) | çœ‹æŠ•å½± | å½’ä¸€åŒ–åå¯ç”¨ |

### åœ¨ RAG å¼€å‘ä¸­çš„é€‰æ‹©

```python
# ChromaDBï¼šé»˜è®¤ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦
collection = client.create_collection(
    name="my_collection",
    metadata={"hnsw:space": "cosine"}  # å¯é€‰ï¼šcosine, l2, ip
)

# Milvusï¼šåˆ›å»ºç´¢å¼•æ—¶æŒ‡å®š
index_params = {
    "index_type": "HNSW",
    "metric_type": "COSINE",  # å¯é€‰ï¼šCOSINE, L2, IP
    "params": {"M": 16, "efConstruction": 256}
}
```

**RAG æœ€ä½³å®è·µï¼šä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosineï¼‰**

---

## æ ¸å¿ƒæ¦‚å¿µ3ï¼šå…ƒæ•°æ®è¿‡æ»¤ï¼ˆMetadata Filteringï¼‰

**å…ƒæ•°æ®è¿‡æ»¤å…è®¸åœ¨å‘é‡æœç´¢çš„åŒæ—¶ï¼ŒæŒ‰æ¡ä»¶ç­›é€‰ç»“æœã€‚**

### ä¸ºä»€ä¹ˆéœ€è¦å…ƒæ•°æ®è¿‡æ»¤ï¼Ÿ

```
åœºæ™¯ï¼šä¼ä¸šçŸ¥è¯†åº“æœç´¢

ç”¨æˆ·é—®ï¼š"å…¬å¸çš„å¹´å‡æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"

ä¸è¿‡æ»¤ï¼š
- å¯èƒ½è¿”å›2020å¹´çš„æ—§æ”¿ç­–
- å¯èƒ½è¿”å›å…¶ä»–éƒ¨é—¨çš„æ”¿ç­–

è¿‡æ»¤åï¼š
- åªæœç´¢ 2024 å¹´çš„æ–‡æ¡£
- åªæœç´¢ HR éƒ¨é—¨çš„æ–‡æ¡£
```

### å…ƒæ•°æ®çš„å­˜å‚¨

```python
# æ¯ä¸ªå‘é‡å¯ä»¥é™„å¸¦å…ƒæ•°æ®
document = {
    "id": "doc_001",
    "text": "å¹´å‡æ”¿ç­–ï¼šå…¥èŒæ»¡ä¸€å¹´å¯äº«å—5å¤©å¹´å‡...",
    "vector": [0.1, 0.2, 0.3, ...],  # Embedding å‘é‡
    "metadata": {
        "source": "HRæ‰‹å†Œ",
        "year": 2024,
        "department": "HR",
        "doc_type": "policy",
        "author": "å¼ ä¸‰"
    }
}
```

### ChromaDB å…ƒæ•°æ®è¿‡æ»¤

```python
import chromadb

client = chromadb.Client()
collection = client.create_collection("company_docs")

# æ·»åŠ æ–‡æ¡£ï¼ˆå¸¦å…ƒæ•°æ®ï¼‰
collection.add(
    ids=["doc1", "doc2", "doc3"],
    documents=["å¹´å‡æ”¿ç­–...", "æŠ¥é”€æµç¨‹...", "è€ƒå‹¤åˆ¶åº¦..."],
    metadatas=[
        {"year": 2024, "department": "HR"},
        {"year": 2024, "department": "Finance"},
        {"year": 2023, "department": "HR"}
    ]
)

# æŸ¥è¯¢ï¼šåªæœç´¢ 2024 å¹´ HR éƒ¨é—¨çš„æ–‡æ¡£
results = collection.query(
    query_texts=["å¹´å‡æ€ä¹ˆç®—"],
    n_results=5,
    where={
        "$and": [
            {"year": {"$eq": 2024}},
            {"department": {"$eq": "HR"}}
        ]
    }
)
```

### Milvus å…ƒæ•°æ®è¿‡æ»¤

```python
from pymilvus import Collection

collection = Collection("company_docs")

# æŸ¥è¯¢ï¼šå¸¦è¿‡æ»¤æ¡ä»¶
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "COSINE", "params": {"nprobe": 16}},
    limit=5,
    expr='year == 2024 and department == "HR"'  # è¿‡æ»¤è¡¨è¾¾å¼
)
```

### å¸¸ç”¨è¿‡æ»¤æ“ä½œç¬¦

| æ“ä½œç¬¦ | å«ä¹‰ | ChromaDB | Milvus |
|--------|------|----------|--------|
| ç­‰äº | = | `{"field": {"$eq": value}}` | `field == value` |
| ä¸ç­‰äº | â‰  | `{"field": {"$ne": value}}` | `field != value` |
| å¤§äº | > | `{"field": {"$gt": value}}` | `field > value` |
| å°äº | < | `{"field": {"$lt": value}}` | `field < value` |
| åŒ…å« | in | `{"field": {"$in": [...]}}` | `field in [...]` |
| ä¸ | AND | `{"$and": [...]}` | `expr1 and expr2` |
| æˆ– | OR | `{"$or": [...]}` | `expr1 or expr2` |

### åœ¨ RAG å¼€å‘ä¸­çš„åº”ç”¨

**å¸¸è§è¿‡æ»¤åœºæ™¯ï¼š**

| åœºæ™¯ | è¿‡æ»¤å­—æ®µ | ç¤ºä¾‹ |
|------|----------|------|
| å¤šç§Ÿæˆ· | `tenant_id` | åªæœç´¢å½“å‰ç”¨æˆ·çš„æ–‡æ¡£ |
| æ—¶æ•ˆæ€§ | `created_at` | åªæœç´¢æœ€è¿‘ä¸€å¹´çš„æ–‡æ¡£ |
| æƒé™æ§åˆ¶ | `access_level` | åªæœç´¢ç”¨æˆ·æœ‰æƒé™çš„æ–‡æ¡£ |
| æ–‡æ¡£ç±»å‹ | `doc_type` | åªæœç´¢ FAQ æˆ–æŠ€æœ¯æ–‡æ¡£ |
| æ¥æºè¿‡æ»¤ | `source` | åªæœç´¢å®˜æ–¹æ–‡æ¡£ |

```python
# RAG å®æˆ˜ç¤ºä¾‹ï¼šå¤šç§Ÿæˆ· + æ—¶æ•ˆæ€§è¿‡æ»¤
def search_with_filters(query, user_id, collection):
    results = collection.query(
        query_texts=[query],
        n_results=10,
        where={
            "$and": [
                {"tenant_id": {"$eq": user_id}},
                {"year": {"$gte": 2023}}
            ]
        }
    )
    return results
```

---

## ä¸‰ä¸ªæ¦‚å¿µçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‘é‡å­˜å‚¨æŸ¥è¯¢æµç¨‹                         â”‚
â”‚                                                             â”‚
â”‚  1. å…ƒæ•°æ®è¿‡æ»¤                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ ä»100ä¸‡æ–‡æ¡£ä¸­ï¼Œç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„10ä¸‡æ–‡æ¡£    â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â†“                                  â”‚
â”‚  2. ç´¢å¼•æœç´¢                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ ä½¿ç”¨ HNSW/IVF ç´¢å¼•ï¼Œå¿«é€Ÿæ‰¾åˆ°æœ€ç›¸ä¼¼çš„å‘é‡  â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â†“                                  â”‚
â”‚  3. ç›¸ä¼¼åº¦è®¡ç®—                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ï¼Œè¿”å› Top-K ç»“æœ         â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ä¸‹ä¸€æ­¥ï¼š** [04_æœ€å°å¯ç”¨](./04_æœ€å°å¯ç”¨.md) - æŒæ¡ 20% æ ¸å¿ƒçŸ¥è¯†è§£å†³ 80% é—®é¢˜
