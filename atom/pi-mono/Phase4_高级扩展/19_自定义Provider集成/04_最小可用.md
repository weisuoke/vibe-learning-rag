# 最小可用知识

## 核心概念（3个）

### 1. 两种集成方式

**简单配置（models.json）**
- 适用于OpenAI兼容API
- 零代码，仅需编辑JSON文件
- 80%的场景都可以用这种方式

**高级扩展（Extension）**
- 适用于复杂场景（OAuth、自定义API）
- 需要编写TypeScript代码
- 完全控制集成逻辑

### 2. pi.registerProvider() API

**核心接口：**
```typescript
pi.registerProvider(providerId: string, config: ProviderConfig)
```

**最小配置：**
```typescript
pi.registerProvider('my-provider', {
  baseUrl: 'https://api.example.com/v1',
  apiKey: 'MY_API_KEY',  // 环境变量名
  api: 'openai-completions',
  models: [{ id: 'my-model', name: 'My Model', ... }]
})
```

### 3. OAuth认证接口

**三个核心方法：**
```typescript
interface OAuthProviderInterface {
  login(callbacks): Promise<OAuthCredentials>      // 登录流程
  refreshToken(credentials): Promise<OAuthCredentials>  // 刷新Token
  getApiKey(credentials): string                   // 获取API Key
}
```

## 最小可用实践（5个场景）

### 场景1：本地Ollama集成（最简单）

**需求：** 使用本地Ollama运行的Llama模型

**实现：**
```json
// ~/.pi/agent/models.json
{
  "providers": [
    {
      "id": "ollama",
      "name": "Ollama",
      "apiKeyEnvVar": null,
      "baseUrl": "http://localhost:11434/v1"
    }
  ],
  "models": [
    {
      "id": "ollama/llama3.2",
      "name": "Llama 3.2",
      "providerId": "ollama",
      "contextWindow": 128000,
      "maxOutputTokens": 4096
    }
  ]
}
```

**使用：**
```bash
pi
/model ollama/llama3.2
```

### 场景2：企业代理路由

**需求：** 通过企业代理访问OpenAI

**实现：**
```typescript
// ~/.pi/agent/extensions/proxy/index.ts
export default function(pi) {
  pi.registerProvider('openai', {
    baseUrl: 'https://proxy.company.com/openai/v1'
  })
}
```

### 场景3：自定义API Key

**需求：** 使用自定义环境变量名

**实现：**
```typescript
pi.registerProvider('my-llm', {
  baseUrl: 'https://api.my-llm.com/v1',
  apiKey: 'MY_CUSTOM_API_KEY',  // 环境变量名
  api: 'openai-completions',
  models: [...]
})
```

**设置环境变量：**
```bash
export MY_CUSTOM_API_KEY=sk-...
```

### 场景4：OAuth认证（Device Code Flow）

**需求：** 企业内部LLM需要OAuth认证

**实现：**
```typescript
export default function(pi) {
  pi.registerProvider('company-llm', {
    baseUrl: 'https://ai.company.com/v1',
    api: 'openai-completions',
    models: [...],
    oauth: {
      name: 'Company AI (SSO)',

      async login(callbacks) {
        // 1. 请求设备代码
        const res = await fetch('https://auth.company.com/device/code', {
          method: 'POST',
          body: new URLSearchParams({ client_id: 'pi-agent' })
        })
        const data = await res.json()

        // 2. 显示用户代码
        callbacks.onDeviceCode({
          userCode: data.user_code,
          verificationUri: data.verification_uri
        })

        // 3. 轮询Token
        const token = await pollForToken(data.device_code)

        return {
          access: token.access_token,
          refresh: token.refresh_token,
          expires: Date.now() + token.expires_in * 1000
        }
      },

      async refreshToken(credentials) {
        const res = await fetch('https://auth.company.com/token', {
          method: 'POST',
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: credentials.refresh
          })
        })
        const data = await res.json()
        return {
          access: data.access_token,
          refresh: data.refresh_token || credentials.refresh,
          expires: Date.now() + data.expires_in * 1000
        }
      },

      getApiKey(credentials) {
        return credentials.access
      }
    }
  })
}
```

**使用：**
```bash
pi
/login company-llm
```

### 场景5：自定义请求头

**需求：** 添加自定义认证头

**实现：**
```typescript
pi.registerProvider('my-provider', {
  baseUrl: 'https://api.example.com/v1',
  headers: {
    'X-API-Key': 'MY_API_KEY',  // 环境变量名
    'X-Custom-Header': 'value'
  },
  api: 'openai-completions',
  models: [...]
})
```

## 关键决策点

### 决策1：选择集成方式

**判断标准：**
- API是否OpenAI兼容？
  - 是 → 使用models.json配置
  - 否 → 使用Extension

- 是否需要OAuth认证？
  - 是 → 使用Extension + oauth配置
  - 否 → 使用models.json或简单Extension

### 决策2：选择API类型

**常见API类型：**
- `openai-completions` - OpenAI Chat Completions API（最常用）
- `anthropic-messages` - Anthropic Messages API
- `google-generative-ai` - Google Generative AI
- 自定义 - 实现streamSimple函数

**判断标准：**
- 如果API文档说"OpenAI兼容" → `openai-completions`
- 如果是Anthropic格式 → `anthropic-messages`
- 如果是完全自定义格式 → 实现streamSimple

### 决策3：凭证存储

**API Key存储：**
- 环境变量（推荐）
- Extension中硬编码（不推荐，仅用于测试）

**OAuth凭证存储：**
- 自动存储在`~/.pi/agent/auth.json`
- 自动刷新机制

## 常见问题

### Q1: models.json放在哪里？

**答案：**
- 用户级：`~/.pi/agent/models.json`（所有项目共享）
- 项目级：`.pi/agent/models.json`（仅当前项目）

### Q2: 如何测试自定义Provider？

**答案：**
```bash
# 1. 配置Provider
# 2. 启动pi
pi

# 3. 切换到自定义模型
/model my-provider/my-model

# 4. 测试对话
Hello, can you hear me?
```

### Q3: OAuth登录失败怎么办？

**答案：**
```bash
# 1. 检查auth.json
cat ~/.pi/agent/auth.json

# 2. 删除旧凭证
rm ~/.pi/agent/auth.json

# 3. 重新登录
pi
/login my-provider
```

### Q4: 如何调试Extension？

**答案：**
```typescript
// 在Extension中添加日志
export default function(pi) {
  console.log('Extension loaded')

  pi.registerProvider('my-provider', {
    // ...
  })

  console.log('Provider registered')
}
```

### Q5: 如何覆盖内置Provider？

**答案：**
```typescript
// 覆盖OpenAI的baseUrl
pi.registerProvider('openai', {
  baseUrl: 'https://my-proxy.com/v1'
})
// 所有OpenAI模型都会使用新的baseUrl
```

## 学习路径

### 第1步：本地模型（1小时）
- 安装Ollama
- 配置models.json
- 测试对话

### 第2步：代理路由（30分钟）
- 创建Extension
- 覆盖baseUrl
- 测试连接

### 第3步：OAuth认证（2小时）
- 理解Device Code Flow
- 实现OAuth接口
- 测试登录流程

### 第4步：自定义API（3小时）
- 研究API文档
- 实现streamSimple
- 测试流式响应

## 总结

**20%核心知识：**
1. models.json配置（80%场景）
2. pi.registerProvider() API
3. OAuth三个核心方法

**80%效果：**
- 集成本地模型（Ollama、vLLM）
- 配置企业代理
- 实现OAuth认证
- 添加自定义Provider
