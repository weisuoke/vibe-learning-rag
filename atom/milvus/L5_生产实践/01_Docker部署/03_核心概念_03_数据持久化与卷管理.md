# 核心概念3：数据持久化与卷管理

> 深入理解 Docker Volume 的工作原理、数据持久化策略和备份恢复方案

---

## 概述

容器是无状态的，容器删除后内部数据会丢失。Docker Volume 提供数据持久化机制，确保 Milvus 的数据在容器重启或删除后仍然保留。

---

## 1. 为什么需要数据持久化？

### 1.1 容器的无状态特性

```
容器生命周期：
创建 → 运行 → 停止 → 删除
  ↓      ↓      ↓      ↓
数据：✅    ✅    ✅    ❌ 数据丢失
```

**问题**：
- 容器删除后，容器内的所有数据都会丢失
- 容器重启后，数据会恢复到镜像的初始状态
- 无法在容器间共享数据

**解决方案**：
- 使用 Docker Volume 将数据存储在容器外部
- Volume 独立于容器生命周期
- 容器删除后，Volume 中的数据仍然保留

### 1.2 Milvus 需要持久化的数据

```
┌─────────────────────────────────────────┐
│  Milvus 数据分类                         │
├─────────────────────────────────────────┤
│  1. 元数据（etcd）                       │
│     - Collection schema                 │
│     - 索引信息                           │
│     - 分区信息                           │
│     - 系统配置                           │
│                                         │
│  2. 向量数据（MinIO）                    │
│     - 原始向量                           │
│     - 索引文件                           │
│     - 日志文件                           │
│     - Binlog（二进制日志）               │
│                                         │
│  3. WAL 日志（Milvus）                   │
│     - 写前日志                           │
│     - 用于故障恢复                       │
│     - 保证数据一致性                     │
└─────────────────────────────────────────┘
```

**数据重要性**：
- **元数据**：丢失后无法访问 Collection
- **向量数据**：丢失后需要重新插入所有数据
- **WAL 日志**：丢失后可能导致数据不一致

---

## 2. Docker Volume 的三种类型

### 2.1 Named Volumes（推荐）

**定义**：由 Docker 管理的持久化卷

```yaml
volumes:
  milvus_data:
    driver: local

services:
  milvus:
    volumes:
      - milvus_data:/var/lib/milvus
```

**特点**：
- ✅ Docker 自动管理存储位置
- ✅ 跨平台兼容（Linux/macOS/Windows）
- ✅ 可以使用 `docker volume` 命令管理
- ✅ 性能好（直接使用宿主机文件系统）
- ✅ 适合生产环境

**存储位置**：
```bash
# Linux
/var/lib/docker/volumes/<volume_name>/_data

# macOS (Docker Desktop)
~/Library/Containers/com.docker.docker/Data/vms/0/data/docker/volumes/<volume_name>/_data

# Windows (Docker Desktop)
\\wsl$\docker-desktop-data\data\docker\volumes\<volume_name>\_data
```

**管理命令**：
```bash
# 创建 volume
docker volume create milvus_data

# 查看所有 volumes
docker volume ls

# 查看 volume 详情
docker volume inspect milvus_data

# 删除 volume
docker volume rm milvus_data

# 清理未使用的 volumes
docker volume prune
```

### 2.2 Bind Mounts

**定义**：将宿主机目录挂载到容器

```yaml
services:
  milvus:
    volumes:
      - ./data/milvus:/var/lib/milvus
      - /opt/milvus/data:/var/lib/milvus
```

**特点**：
- ✅ 数据位置明确，方便查看
- ✅ 可以直接编辑文件
- ✅ 适合开发和调试
- ❌ 路径依赖宿主机
- ❌ 跨平台兼容性差
- ❌ 权限问题（Linux）

**使用场景**：
- 开发环境：方便查看和修改数据
- 配置文件：挂载配置文件到容器
- 日志输出：将日志输出到宿主机

**权限问题**：
```bash
# Linux 上可能遇到权限问题
# 容器内的用户 UID 与宿主机不匹配

# 解决方案1：修改宿主机目录权限
sudo chown -R 1000:1000 ./data/milvus

# 解决方案2：在容器中使用 root 用户
docker-compose.yml:
  milvus:
    user: root
```

### 2.3 tmpfs Mounts

**定义**：将数据存储在内存中

```yaml
services:
  milvus:
    volumes:
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 1000000000  # 1GB
```

**特点**：
- ✅ 性能极高（内存速度）
- ✅ 容器停止后自动清理
- ❌ 数据不持久化
- ❌ 占用内存

**使用场景**：
- 临时文件
- 缓存数据
- 不需要持久化的数据

---

## 3. Milvus 数据持久化配置

### 3.1 完整的持久化配置

```yaml
version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    volumes:
      # 持久化 etcd 数据
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    volumes:
      # 持久化 MinIO 数据
      - minio_data:/minio_data
    command: minio server /minio_data

  milvus:
    image: milvusdb/milvus:v2.4.0
    volumes:
      # 持久化 Milvus 数据
      - milvus_data:/var/lib/milvus

      # 配置文件（只读）
      - ./configs/milvus.yaml:/milvus/configs/milvus.yaml:ro

      # 日志输出（Bind Mount）
      - ./logs:/var/log/milvus

      # 临时文件（tmpfs）
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 1000000000

volumes:
  etcd_data:
    driver: local
    labels:
      project: milvus
      environment: production

  minio_data:
    driver: local
    labels:
      project: milvus
      environment: production

  milvus_data:
    driver: local
    labels:
      project: milvus
      environment: production
```

### 3.2 使用 SSD 存储

```yaml
volumes:
  milvus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/milvus  # SSD 挂载点
```

**优势**：
- 更快的读写速度
- 更低的延迟
- 适合向量检索场景

### 3.3 使用 NFS 网络存储

```yaml
volumes:
  milvus_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.1.100,rw
      device: ":/mnt/nfs/milvus"
```

**优势**：
- 多个容器共享数据
- 数据集中管理
- 方便备份

**劣势**：
- 网络延迟
- 性能不如本地存储

---

## 4. 数据备份策略

### 4.1 备份 Named Volumes

**方法1：使用 docker run 备份**

```bash
# 备份 milvus_data volume
docker run --rm \
  -v milvus_data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_backup_$(date +%Y%m%d_%H%M%S).tar.gz /data

# 备份所有 volumes
for volume in etcd_data minio_data milvus_data; do
  docker run --rm \
    -v $volume:/data \
    -v $(pwd):/backup \
    ubuntu tar czf /backup/${volume}_$(date +%Y%m%d_%H%M%S).tar.gz /data
done
```

**方法2：使用 docker-compose 备份**

```bash
# 停止服务（可选，确保数据一致性）
docker-compose stop

# 备份
docker-compose run --rm \
  -v milvus_data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_backup.tar.gz /data

# 重启服务
docker-compose start
```

### 4.2 恢复 Named Volumes

```bash
# 创建新的 volume
docker volume create milvus_data_new

# 恢复数据
docker run --rm \
  -v milvus_data_new:/data \
  -v $(pwd):/backup \
  ubuntu tar xzf /backup/milvus_backup.tar.gz -C /

# 更新 docker-compose.yml 使用新 volume
# 或者删除旧 volume，重命名新 volume
docker volume rm milvus_data
docker volume create milvus_data
# 再次恢复到 milvus_data
```

### 4.3 备份 Bind Mounts

```bash
# 直接备份宿主机目录
tar czf milvus_backup.tar.gz ./data/milvus

# 恢复
tar xzf milvus_backup.tar.gz -C ./data/
```

### 4.4 自动化备份脚本

```bash
#!/bin/bash
# backup_milvus.sh

BACKUP_DIR="/opt/backups/milvus"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止 Milvus（可选）
# docker-compose stop milvus

# 备份 etcd
docker run --rm \
  -v milvus_etcd_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar czf /backup/etcd_$DATE.tar.gz /data

# 备份 MinIO
docker run --rm \
  -v milvus_minio_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar czf /backup/minio_$DATE.tar.gz /data

# 备份 Milvus
docker run --rm \
  -v milvus_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar czf /backup/milvus_$DATE.tar.gz /data

# 重启 Milvus
# docker-compose start milvus

# 清理旧备份（保留最近 7 天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

**设置定时任务**：

```bash
# 编辑 crontab
crontab -e

# 每天凌晨 2 点备份
0 2 * * * /opt/scripts/backup_milvus.sh >> /var/log/milvus_backup.log 2>&1
```

---

## 5. 数据迁移

### 5.1 迁移到新服务器

**步骤1：在旧服务器上备份**

```bash
# 停止服务
docker-compose stop

# 备份 volumes
docker run --rm \
  -v milvus_data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_data.tar.gz /data

# 备份 docker-compose.yml
cp docker-compose.yml backup/
```

**步骤2：传输到新服务器**

```bash
# 使用 scp 传输
scp milvus_data.tar.gz user@new-server:/opt/milvus/backup/
scp docker-compose.yml user@new-server:/opt/milvus/
```

**步骤3：在新服务器上恢复**

```bash
# 创建 volume
docker volume create milvus_data

# 恢复数据
docker run --rm \
  -v milvus_data:/data \
  -v /opt/milvus/backup:/backup \
  ubuntu tar xzf /backup/milvus_data.tar.gz -C /

# 启动服务
docker-compose up -d
```

### 5.2 从单机迁移到分布式

**挑战**：
- 单机模式和分布式模式的数据格式不同
- 需要重新导入数据

**方案1：使用 Milvus 导出/导入工具**

```python
from pymilvus import connections, Collection, utility

# 连接到单机 Milvus
connections.connect("source", host="old-server", port="19530")

# 导出数据
collection = Collection("my_collection")
data = collection.query(expr="", output_fields=["*"])

# 连接到分布式 Milvus
connections.connect("target", host="new-server", port="19530")

# 导入数据
new_collection = Collection("my_collection")
new_collection.insert(data)
```

**方案2：使用备份恢复（需要停机）**

```bash
# 1. 备份单机 Milvus 的 MinIO 数据
# 2. 在分布式 Milvus 中恢复 MinIO 数据
# 3. 重建索引
```

---

## 6. 数据一致性保证

### 6.1 停机备份（强一致性）

```bash
# 1. 停止 Milvus
docker-compose stop milvus

# 2. 等待数据刷盘
sleep 10

# 3. 备份
docker run --rm \
  -v milvus_data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_backup.tar.gz /data

# 4. 重启 Milvus
docker-compose start milvus
```

### 6.2 在线备份（最终一致性）

```bash
# 不停止 Milvus，直接备份
# 可能存在数据不一致的风险
docker run --rm \
  -v milvus_data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_backup.tar.gz /data
```

### 6.3 使用快照（推荐）

```bash
# 如果使用支持快照的存储（如 LVM、ZFS）
# 可以创建快照后再备份

# 创建 LVM 快照
lvcreate -L 10G -s -n milvus_snapshot /dev/vg0/milvus_data

# 挂载快照
mount /dev/vg0/milvus_snapshot /mnt/snapshot

# 备份快照
tar czf milvus_backup.tar.gz /mnt/snapshot

# 删除快照
umount /mnt/snapshot
lvremove /dev/vg0/milvus_snapshot
```

---

## 7. 存储空间管理

### 7.1 查看 Volume 大小

```bash
# 查看所有 volumes 的大小
docker system df -v

# 查看特定 volume 的大小
docker volume inspect milvus_data | grep Mountpoint
du -sh $(docker volume inspect milvus_data | grep Mountpoint | awk '{print $2}' | tr -d '",')
```

### 7.2 清理未使用的 Volumes

```bash
# 查看未使用的 volumes
docker volume ls -f dangling=true

# 清理未使用的 volumes
docker volume prune

# 清理所有未使用的资源（包括 volumes）
docker system prune -a --volumes
```

### 7.3 Volume 大小限制

```yaml
# Docker 不直接支持 volume 大小限制
# 需要在宿主机层面配置

# 方案1：使用 LVM 配额
# 方案2：使用文件系统配额
# 方案3：监控并告警
```

---

## 8. 在 RAG 开发中的最佳实践

### 8.1 开发环境配置

```yaml
# docker-compose.dev.yml
services:
  milvus:
    volumes:
      # 使用 Bind Mount，方便查看数据
      - ./data/milvus:/var/lib/milvus
      - ./logs:/var/log/milvus
      - ./configs:/milvus/configs
```

**优势**：
- 数据位置明确
- 方便调试和查看
- 可以直接编辑配置文件

### 8.2 生产环境配置

```yaml
# docker-compose.prod.yml
services:
  etcd:
    volumes:
      - etcd_data:/etcd

  minio:
    volumes:
      - minio_data:/minio_data

  milvus:
    volumes:
      # 使用 Named Volume
      - milvus_data:/var/lib/milvus

      # 配置文件只读
      - ./configs/milvus.yaml:/milvus/configs/milvus.yaml:ro

      # 日志输出到宿主机
      - /var/log/milvus:/var/log/milvus

volumes:
  etcd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/etcd  # 使用 SSD

  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/minio

  milvus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/milvus
```

**优势**：
- 使用 SSD 提高性能
- Named Volume 便于管理
- 配置文件只读，防止误修改

### 8.3 备份策略

```bash
# 生产环境备份策略
# 1. 每天全量备份
# 2. 每小时增量备份（如果支持）
# 3. 保留最近 7 天的备份
# 4. 每周备份到远程存储

# 全量备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/opt/backups/milvus/$DATE"
mkdir -p $BACKUP_DIR

# 备份所有 volumes
for volume in etcd_data minio_data milvus_data; do
  docker run --rm \
    -v $volume:/data \
    -v $BACKUP_DIR:/backup \
    ubuntu tar czf /backup/$volume.tar.gz /data
done

# 上传到 S3
aws s3 sync $BACKUP_DIR s3://my-backups/milvus/$DATE/
```

---

## 9. 常见问题和解决方案

### 9.1 Volume 权限问题

**问题**：容器无法写入 volume

```bash
# 错误信息
Permission denied: '/var/lib/milvus'
```

**解决方案**：

```bash
# 方案1：修改宿主机目录权限
sudo chown -R 1000:1000 /mnt/ssd/milvus

# 方案2：使用 root 用户运行容器
docker-compose.yml:
  milvus:
    user: root

# 方案3：使用 Named Volume（推荐）
# Named Volume 由 Docker 管理，自动处理权限
```

### 9.2 Volume 空间不足

**问题**：磁盘空间不足

```bash
# 错误信息
no space left on device
```

**解决方案**：

```bash
# 1. 清理未使用的 volumes
docker volume prune

# 2. 清理 Docker 缓存
docker system prune -a

# 3. 扩展磁盘空间
# 4. 迁移到更大的磁盘
```

### 9.3 Volume 数据丢失

**问题**：容器重启后数据丢失

**原因**：
- 没有配置 volume
- 使用了 tmpfs
- 误删除了 volume

**解决方案**：

```yaml
# 确保配置了 volume
services:
  milvus:
    volumes:
      - milvus_data:/var/lib/milvus  # 必须配置

volumes:
  milvus_data:  # 必须定义
```

---

## 关键要点

1. **使用 Named Volumes 而非 Bind Mounts**
   - 生产环境推荐 Named Volumes
   - 开发环境可以使用 Bind Mounts

2. **三类数据都需要持久化**
   - etcd：元数据
   - MinIO：向量数据
   - Milvus：WAL 日志

3. **定期备份是必须的**
   - 每天全量备份
   - 保留多个备份版本
   - 测试恢复流程

4. **使用 SSD 提高性能**
   - 向量检索对 I/O 性能敏感
   - SSD 比 HDD 快 10-100 倍

5. **监控存储空间**
   - 设置告警阈值
   - 定期清理旧数据
   - 预留足够的空间

6. **测试恢复流程**
   - 定期测试备份恢复
   - 确保备份可用
   - 记录恢复时间

---

## 下一步学习

完成本节后，建议学习：
- **实战代码**：完整的部署和备份示例
- **化骨绵掌**：10个2分钟知识卡片
