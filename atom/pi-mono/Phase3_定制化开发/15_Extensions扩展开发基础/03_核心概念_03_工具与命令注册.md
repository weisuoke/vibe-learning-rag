# Extensions æ‰©å±•å¼€å‘åŸºç¡€ - æ ¸å¿ƒæ¦‚å¿µ 03ï¼šå·¥å…·ä¸å‘½ä»¤æ³¨å†Œ

> æ·±å…¥ç†è§£å·¥å…·æ³¨å†Œã€å‘½ä»¤æ³¨å†Œã€å¿«æ·é”®æ³¨å†Œå’Œå‚æ•° schema å®šä¹‰

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£ Extensions çš„å·¥å…·å’Œå‘½ä»¤æ³¨å†Œæœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- registerTool API å’Œ ToolDefinition æ¥å£
- registerCommandã€registerShortcutã€registerFlag
- TypeBox å‚æ•° schema å®šä¹‰
- è‡ªå®šä¹‰æ¸²æŸ“å’Œ UI é›†æˆ

---

## 1. å·¥å…·æ³¨å†Œï¼ˆregisterToolï¼‰

### 1.1 ToolDefinition æ¥å£

**å®Œæ•´çš„ ToolDefinition æ¥å£ï¼š**

```typescript
export interface ToolDefinition {
  // åŸºæœ¬ä¿¡æ¯
  name: string;                    // å·¥å…·åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  label?: string;                  // UI æ˜¾ç¤ºæ ‡ç­¾
  description: string;             // å·¥å…·æè¿°ï¼ˆAgent ç†è§£ç”¨é€”ï¼‰

  // å‚æ•°å®šä¹‰
  parameters: TSchema;             // TypeBox schema

  // æ‰§è¡Œå‡½æ•°
  execute(
    toolCallId: string,            // å·¥å…·è°ƒç”¨ ID
    params: unknown,               // å‚æ•°å¯¹è±¡
    signal: AbortSignal,           // å–æ¶ˆä¿¡å·
    onUpdate: (update: ToolUpdate) => void,  // è¿›åº¦æ›´æ–°
    ctx: ExtensionContext          // æ‰©å±•ä¸Šä¸‹æ–‡
  ): Promise<ToolResult>;

  // å¯é€‰ï¼šè‡ªå®šä¹‰æ¸²æŸ“
  renderCall?(
    args: unknown,                 // å·¥å…·å‚æ•°
    theme: Theme                   // ä¸»é¢˜å¯¹è±¡
  ): Component;

  renderResult?(
    result: ToolResult,            // å·¥å…·ç»“æœ
    state: { expanded: boolean },  // å±•å¼€çŠ¶æ€
    theme: Theme                   // ä¸»é¢˜å¯¹è±¡
  ): Component;
}
```

### 1.2 åŸºæœ¬å·¥å…·æ³¨å†Œ

**æœ€ç®€å•çš„å·¥å…·æ³¨å†Œï¼š**

```typescript
import { Type } from "@sinclair/typebox";
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "greet",
    label: "Greeting",
    description: "Generate a personalized greeting",

    parameters: Type.Object({
      name: Type.String({ description: "Name to greet" }),
    }),

    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const { name } = params as { name: string };

      return {
        content: [{ type: "text", text: `Hello, ${name}!` }],
        details: { greeted: name },
      };
    },
  });
}
```

### 1.3 å‚æ•° Schemaï¼ˆTypeBoxï¼‰

**TypeBox æ˜¯ pi-mono ä½¿ç”¨çš„ schema å®šä¹‰åº“ï¼š**

```typescript
import { Type } from "@sinclair/typebox";
import { StringEnum } from "@mariozechner/pi-ai";

// åŸºæœ¬ç±»å‹
Type.String()                    // å­—ç¬¦ä¸²
Type.Number()                    // æ•°å­—
Type.Boolean()                   // å¸ƒå°”å€¼
Type.Array(Type.String())        // å­—ç¬¦ä¸²æ•°ç»„
Type.Object({ ... })             // å¯¹è±¡

// å¯é€‰å­—æ®µ
Type.Optional(Type.String())

// å¸¦æè¿°
Type.String({ description: "User name" })

// å¸¦é»˜è®¤å€¼
Type.String({ default: "default value" })

// æšä¸¾ï¼ˆé‡è¦ï¼šä½¿ç”¨ StringEnumï¼‰
StringEnum(["option1", "option2", "option3"] as const)

// å¤æ‚å¯¹è±¡
Type.Object({
  name: Type.String({ description: "Name" }),
  age: Type.Optional(Type.Number({ description: "Age" })),
  role: StringEnum(["admin", "user"] as const),
  tags: Type.Array(Type.String()),
})
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ StringEnum è€Œä¸æ˜¯ Type.Unionï¼Ÿ**

```typescript
// âŒ ä¸å¥½ï¼šType.Union ä¸å…¼å®¹ Google API
parameters: Type.Object({
  action: Type.Union([
    Type.Literal("list"),
    Type.Literal("add"),
  ]),
})

// âœ… å¥½ï¼šStringEnum å…¼å®¹æ‰€æœ‰ LLM API
parameters: Type.Object({
  action: StringEnum(["list", "add"] as const),
})
```

### 1.4 å®Œæ•´çš„å·¥å…·ç¤ºä¾‹

```typescript
import { Type } from "@sinclair/typebox";
import { StringEnum } from "@mariozechner/pi-ai";
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "calculator",
    label: "Calculator",
    description: "Perform arithmetic operations",

    parameters: Type.Object({
      operation: StringEnum(["add", "subtract", "multiply", "divide"] as const),
      a: Type.Number({ description: "First number" }),
      b: Type.Number({ description: "Second number" }),
    }),

    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const { operation, a, b } = params as {
        operation: "add" | "subtract" | "multiply" | "divide";
        a: number;
        b: number;
      };

      // æ£€æŸ¥å–æ¶ˆä¿¡å·
      if (signal.aborted) {
        throw new Error("Operation cancelled");
      }

      // æ‰§è¡Œè®¡ç®—
      let result: number;
      switch (operation) {
        case "add":
          result = a + b;
          break;
        case "subtract":
          result = a - b;
          break;
        case "multiply":
          result = a * b;
          break;
        case "divide":
          if (b === 0) {
            return {
              content: [{ type: "text", text: "Error: Division by zero" }],
              details: { error: "division_by_zero" },
            };
          }
          result = a / b;
          break;
      }

      // è¿”å›ç»“æœ
      return {
        content: [
          {
            type: "text",
            text: `${a} ${operation} ${b} = ${result}`,
          },
        ],
        details: { operation, a, b, result },
      };
    },
  });
}
```

---

## 2. è¿›åº¦æ›´æ–°ï¼ˆonUpdateï¼‰

### 2.1 å®æ—¶è¿›åº¦åé¦ˆ

**ä½¿ç”¨ onUpdate å‘ç”¨æˆ·æ˜¾ç¤ºè¿›åº¦ï¼š**

```typescript
pi.registerTool({
  name: "long_task",
  description: "A task that takes time",
  parameters: Type.Object({
    steps: Type.Number(),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { steps } = params as { steps: number };

    for (let i = 0; i < steps; i++) {
      // æ£€æŸ¥å–æ¶ˆ
      if (signal.aborted) {
        throw new Error("Task cancelled");
      }

      // å‘é€è¿›åº¦æ›´æ–°
      onUpdate({
        content: [
          {
            type: "text",
            text: `Processing step ${i + 1}/${steps}...`,
          },
        ],
      });

      // æ¨¡æ‹Ÿå·¥ä½œ
      await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // è¿”å›æœ€ç»ˆç»“æœ
    return {
      content: [{ type: "text", text: `Completed ${steps} steps` }],
      details: { steps },
    };
  },
});
```

### 2.2 å–æ¶ˆæ”¯æŒï¼ˆAbortSignalï¼‰

**å“åº”ç”¨æˆ·å–æ¶ˆæ“ä½œï¼š**

```typescript
pi.registerTool({
  name: "fetch_data",
  description: "Fetch data from API",
  parameters: Type.Object({
    url: Type.String(),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { url } = params as { url: string };

    try {
      // å°† signal ä¼ é€’ç»™ fetch
      const response = await fetch(url, { signal });
      const data = await response.json();

      return {
        content: [{ type: "text", text: JSON.stringify(data) }],
        details: { data },
      };
    } catch (error) {
      if (error.name === "AbortError") {
        return {
          content: [{ type: "text", text: "Request cancelled" }],
          details: { cancelled: true },
        };
      }
      throw error;
    }
  },
});
```

---

## 3. è‡ªå®šä¹‰æ¸²æŸ“

### 3.1 renderCall - è‡ªå®šä¹‰å·¥å…·è°ƒç”¨æ˜¾ç¤º

**è‡ªå®šä¹‰å·¥å…·è°ƒç”¨çš„ UI æ˜¾ç¤ºï¼š**

```typescript
import { Text } from "@mariozechner/pi-tui";

pi.registerTool({
  name: "deploy",
  description: "Deploy application",
  parameters: Type.Object({
    env: StringEnum(["staging", "production"] as const),
    version: Type.String(),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    // æ‰§è¡Œéƒ¨ç½²
    return { content: [...], details: {} };
  },

  // è‡ªå®šä¹‰å·¥å…·è°ƒç”¨æ˜¾ç¤º
  renderCall(args, theme) {
    const { env, version } = args as { env: string; version: string };

    // ä½¿ç”¨ä¸»é¢˜é¢œè‰²
    const envColor = env === "production" ? "error" : "warning";
    const text =
      theme.fg("toolTitle", theme.bold("deploy ")) +
      theme.fg(envColor, env) +
      theme.fg("dim", ` v${version}`);

    return new Text(text, 0, 0);
  },
});
```

### 3.2 renderResult - è‡ªå®šä¹‰ç»“æœæ˜¾ç¤º

**è‡ªå®šä¹‰å·¥å…·ç»“æœçš„ UI æ˜¾ç¤ºï¼š**

```typescript
pi.registerTool({
  name: "todo",
  description: "Manage todos",
  parameters: Type.Object({
    action: StringEnum(["list", "add", "toggle"] as const),
    text: Type.Optional(Type.String()),
    id: Type.Optional(Type.Number()),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    // æ‰§è¡Œ todo æ“ä½œ
    return {
      content: [...],
      details: { todos: [...], action: params.action },
    };
  },

  // è‡ªå®šä¹‰ç»“æœæ˜¾ç¤º
  renderResult(result, { expanded }, theme) {
    const details = result.details as { todos: Todo[]; action: string };

    if (details.action === "list") {
      const todos = details.todos;

      if (todos.length === 0) {
        return new Text(theme.fg("dim", "No todos"), 0, 0);
      }

      let text = theme.fg("muted", `${todos.length} todo(s):`);

      // å±•å¼€æ—¶æ˜¾ç¤ºæ‰€æœ‰ï¼ŒæŠ˜å æ—¶åªæ˜¾ç¤ºå‰ 5 ä¸ª
      const display = expanded ? todos : todos.slice(0, 5);

      for (const todo of display) {
        const check = todo.done
          ? theme.fg("success", "âœ“")
          : theme.fg("dim", "â—‹");
        const itemText = todo.done
          ? theme.fg("dim", todo.text)
          : theme.fg("muted", todo.text);
        text += `\n${check} ${theme.fg("accent", `#${todo.id}`)} ${itemText}`;
      }

      if (!expanded && todos.length > 5) {
        text += `\n${theme.fg("dim", `... ${todos.length - 5} more`)}`;
      }

      return new Text(text, 0, 0);
    }

    // å…¶ä»– action çš„é»˜è®¤æ˜¾ç¤º
    const content = result.content[0];
    return new Text(
      content?.type === "text" ? content.text : "",
      0,
      0
    );
  },
});
```

---

## 4. å‘½ä»¤æ³¨å†Œï¼ˆregisterCommandï¼‰

### 4.1 åŸºæœ¬å‘½ä»¤æ³¨å†Œ

**æ³¨å†Œæ–œæ å‘½ä»¤ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.registerCommand("hello", {
    description: "Say hello to the user",

    handler: async (args, ctx) => {
      const name = args.trim() || "World";
      ctx.ui.notify(`Hello, ${name}!`, "info");
    },
  });
}
```

**ä½¿ç”¨ï¼š**
```bash
# åœ¨ pi ä¼šè¯ä¸­
/hello
# è¾“å‡º: Hello, World!

/hello Alice
# è¾“å‡º: Hello, Alice!
```

### 4.2 å¸¦å‚æ•°è¡¥å…¨çš„å‘½ä»¤

**æä¾›å‚æ•°è‡ªåŠ¨è¡¥å…¨ï¼š**

```typescript
pi.registerCommand("theme", {
  description: "Change the theme",

  // å‚æ•°è‡ªåŠ¨è¡¥å…¨
  getArgumentCompletions: (prefix) => {
    const themes = ["dark", "light", "auto"];
    return themes
      .filter(t => t.startsWith(prefix))
      .map(t => ({ value: t, label: t }));
  },

  handler: async (args, ctx) => {
    const theme = args.trim();

    if (!["dark", "light", "auto"].includes(theme)) {
      ctx.ui.notify("Invalid theme. Use: dark, light, or auto", "error");
      return;
    }

    // è®¾ç½®ä¸»é¢˜
    ctx.ui.notify(`Theme changed to: ${theme}`, "success");
  },
});
```

### 4.3 å¤æ‚å‘½ä»¤ç¤ºä¾‹

```typescript
pi.registerCommand("session-info", {
  description: "Show current session information",

  handler: async (args, ctx) => {
    const branch = ctx.sessionManager.getBranch();

    // ç»Ÿè®¡ä¿¡æ¯
    const messageCount = branch.filter(e => e.type === "message").length;
    const toolCalls = branch.filter(
      e =>
        e.type === "message" &&
        e.message.role === "toolResult"
    ).length;

    // æœ€è¿‘çš„å·¥å…·è°ƒç”¨
    const recentTools = branch
      .filter(
        e =>
          e.type === "message" &&
          e.message.role === "toolResult"
      )
      .slice(-5)
      .map(e => e.message.toolName);

    // æ˜¾ç¤ºä¿¡æ¯
    const info = [
      "ğŸ“Š Session Information",
      "â”€".repeat(40),
      `Messages: ${messageCount}`,
      `Tool Calls: ${toolCalls}`,
      `Branch Length: ${branch.length}`,
      "",
      "Recent Tools:",
      ...recentTools.map(t => `  - ${t}`),
      "â”€".repeat(40),
    ].join("\n");

    ctx.ui.notify(info, "info");
  },
});
```

---

## 5. å¿«æ·é”®æ³¨å†Œï¼ˆregisterShortcutï¼‰

### 5.1 åŸºæœ¬å¿«æ·é”®æ³¨å†Œ

**æ³¨å†Œé”®ç›˜å¿«æ·é”®ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  // Ctrl+T: æ˜¾ç¤º todos
  pi.registerShortcut("ctrl+t", async (ctx) => {
    ctx.ui.notify("Showing todos...", "info");
    // æ˜¾ç¤º todos UI
  });

  // Ctrl+Shift+S: ä¿å­˜ session
  pi.registerShortcut("ctrl+shift+s", async (ctx) => {
    ctx.ui.notify("Session saved", "success");
  });
}
```

### 5.2 KeyId ç±»å‹

**æ”¯æŒçš„æŒ‰é”®ç»„åˆï¼š**

```typescript
// å•é”®
"a", "b", "c", ..., "z"
"0", "1", "2", ..., "9"
"enter", "escape", "space", "tab"
"up", "down", "left", "right"
"home", "end", "pageup", "pagedown"

// ä¿®é¥°é”®ç»„åˆ
"ctrl+a", "ctrl+shift+a"
"alt+a", "alt+shift+a"
"meta+a", "meta+shift+a"  // Command on macOS

// åŠŸèƒ½é”®
"f1", "f2", ..., "f12"
```

### 5.3 å¿«æ·é”®ç¤ºä¾‹

```typescript
export default function (pi: ExtensionAPI) {
  // Ctrl+L: æ¸…å±
  pi.registerShortcut("ctrl+l", async (ctx) => {
    // æ¸…å±é€»è¾‘
    ctx.ui.notify("Screen cleared", "info");
  });

  // Ctrl+/: æ˜¾ç¤ºå¸®åŠ©
  pi.registerShortcut("ctrl+/", async (ctx) => {
    const help = [
      "Keyboard Shortcuts:",
      "  Ctrl+T: Show todos",
      "  Ctrl+L: Clear screen",
      "  Ctrl+/: Show this help",
    ].join("\n");
    ctx.ui.notify(help, "info");
  });

  // Escape: å–æ¶ˆå½“å‰æ“ä½œ
  pi.registerShortcut("escape", async (ctx) => {
    ctx.ui.notify("Operation cancelled", "warning");
  });
}
```

---

## 6. æ ‡å¿—æ³¨å†Œï¼ˆregisterFlagï¼‰

### 6.1 åŸºæœ¬æ ‡å¿—æ³¨å†Œ

**æ³¨å†Œå‘½ä»¤è¡Œæ ‡å¿—ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.registerFlag("verbose", {
    description: "Enable verbose logging",
    type: "boolean",
    default: false,
  });

  pi.registerFlag("output", {
    description: "Output file path",
    type: "string",
    default: "output.txt",
  });

  // ä½¿ç”¨æ ‡å¿—
  pi.on("session_start", async (event, ctx) => {
    const verbose = ctx.flags.verbose;
    const output = ctx.flags.output;

    if (verbose) {
      console.log("Verbose mode enabled");
      console.log(`Output file: ${output}`);
    }
  });
}
```

**ä½¿ç”¨ï¼š**
```bash
pi --verbose --output=result.txt
```

---

## 7. å·¥å…·è¦†ç›–ï¼ˆTool Overrideï¼‰

### 7.1 è¦†ç›–å†…ç½®å·¥å…·

**å¯ä»¥è¦†ç›–å†…ç½®å·¥å…·çš„è¡Œä¸ºï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  // è¦†ç›– read å·¥å…·ï¼Œæ·»åŠ æ—¥å¿—
  pi.registerTool({
    name: "read",  // ä¸å†…ç½®å·¥å…·åŒå
    description: "Read file with logging",
    parameters: Type.Object({
      file_path: Type.String(),
      offset: Type.Optional(Type.Number()),
      limit: Type.Optional(Type.Number()),
    }),

    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const { file_path } = params as { file_path: string };

      // è®°å½•æ—¥å¿—
      console.log(`[READ] ${file_path}`);

      // è°ƒç”¨åŸå§‹çš„ read å·¥å…·
      // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé€šå¸¸ä¸æ¨èè¦†ç›–å†…ç½®å·¥å…·
      // æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨

      return {
        content: [{ type: "text", text: "File read" }],
        details: {},
      };
    },
  });
}
```

**æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨**

```typescript
export default function (pi: ExtensionAPI) {
  // ç›‘å¬ read å·¥å…·è°ƒç”¨
  pi.on("tool_call", async (event, ctx) => {
    if (event.toolName === "read") {
      const { file_path } = event.input;
      console.log(`[READ] ${file_path}`);
    }
  });
}
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å‚æ•°éªŒè¯

```typescript
pi.registerTool({
  name: "my_tool",
  description: "My tool",
  parameters: Type.Object({
    value: Type.Number({ minimum: 0, maximum: 100 }),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { value } = params as { value: number };

    // TypeBox å·²ç»éªŒè¯äº†å‚æ•°ï¼Œä½†å¯ä»¥æ·»åŠ é¢å¤–éªŒè¯
    if (value < 0 || value > 100) {
      return {
        content: [{ type: "text", text: "Value must be between 0 and 100" }],
        details: { error: "invalid_value" },
      };
    }

    // æ‰§è¡Œé€»è¾‘
    return { content: [...], details: {} };
  },
});
```

### 8.2 é”™è¯¯å¤„ç†

```typescript
pi.registerTool({
  name: "my_tool",
  description: "My tool",
  parameters: Type.Object({
    url: Type.String(),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { url } = params as { url: string };

    try {
      const response = await fetch(url, { signal });
      const data = await response.json();

      return {
        content: [{ type: "text", text: JSON.stringify(data) }],
        details: { data },
      };
    } catch (error) {
      // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
      if (error.name === "AbortError") {
        return {
          content: [{ type: "text", text: "Request cancelled" }],
          details: { cancelled: true },
        };
      }

      if (error instanceof TypeError) {
        return {
          content: [{ type: "text", text: "Network error" }],
          details: { error: "network_error" },
        };
      }

      // è®°å½•é”™è¯¯
      console.error("Tool execution failed:", error);

      return {
        content: [{ type: "text", text: `Error: ${error.message}` }],
        details: { error: error.message },
      };
    }
  },
});
```

### 8.3 æ€§èƒ½ä¼˜åŒ–

```typescript
export default function (pi: ExtensionAPI) {
  // ç¼“å­˜æ˜‚è´µçš„è®¡ç®—
  let cache = new Map();

  pi.registerTool({
    name: "expensive_tool",
    description: "Tool with expensive computation",
    parameters: Type.Object({
      input: Type.String(),
    }),

    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const { input } = params as { input: string };

      // æ£€æŸ¥ç¼“å­˜
      if (cache.has(input)) {
        return {
          content: [{ type: "text", text: cache.get(input) }],
          details: { cached: true },
        };
      }

      // æ‰§è¡Œæ˜‚è´µçš„è®¡ç®—
      const result = await expensiveComputation(input);

      // ç¼“å­˜ç»“æœ
      cache.set(input, result);

      return {
        content: [{ type: "text", text: result }],
        details: { cached: false },
      };
    },
  });

  // æ¸…ç†ç¼“å­˜
  pi.on("session_exit", async (event, ctx) => {
    cache.clear();
  });
}
```

---

## 9. å®é™…åº”ç”¨ç¤ºä¾‹

### 9.1 æ•°æ®åº“æŸ¥è¯¢å·¥å…·

```typescript
import { Type } from "@sinclair/typebox";
import { StringEnum } from "@mariozechner/pi-ai";

pi.registerTool({
  name: "db_query",
  label: "Database Query",
  description: "Query the database",

  parameters: Type.Object({
    table: StringEnum(["users", "posts", "comments"] as const),
    action: StringEnum(["select", "count", "describe"] as const),
    filter: Type.Optional(Type.String({ description: "WHERE clause" })),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { table, action, filter } = params as {
      table: string;
      action: string;
      filter?: string;
    };

    // æ„å»º SQL æŸ¥è¯¢
    let sql = "";
    switch (action) {
      case "select":
        sql = `SELECT * FROM ${table}`;
        break;
      case "count":
        sql = `SELECT COUNT(*) FROM ${table}`;
        break;
      case "describe":
        sql = `DESCRIBE ${table}`;
        break;
    }

    if (filter) {
      sql += ` WHERE ${filter}`;
    }

    // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆç¤ºä¾‹ï¼‰
    onUpdate({
      content: [{ type: "text", text: `Executing: ${sql}` }],
    });

    const result = await executeQuery(sql);

    return {
      content: [{ type: "text", text: JSON.stringify(result, null, 2) }],
      details: { sql, result },
    };
  },
});
```

### 9.2 éƒ¨ç½²å·¥å…·

```typescript
pi.registerTool({
  name: "deploy",
  label: "Deploy",
  description: "Deploy application to environment",

  parameters: Type.Object({
    env: StringEnum(["staging", "production"] as const),
    version: Type.String({ description: "Version to deploy" }),
    confirm: Type.Boolean({ description: "Confirm deployment", default: false }),
  }),

  async execute(toolCallId, params, signal, onUpdate, ctx) {
    const { env, version, confirm } = params as {
      env: string;
      version: string;
      confirm: boolean;
    };

    // ç”Ÿäº§ç¯å¢ƒéœ€è¦ç¡®è®¤
    if (env === "production" && !confirm) {
      const ok = await ctx.ui.confirm(
        "âš ï¸ Production Deployment",
        `Deploy ${version} to production?`
      );

      if (!ok) {
        return {
          content: [{ type: "text", text: "Deployment cancelled" }],
          details: { cancelled: true },
        };
      }
    }

    // æ‰§è¡Œéƒ¨ç½²
    onUpdate({
      content: [{ type: "text", text: `Deploying ${version} to ${env}...` }],
    });

    await ctx.exec(`./scripts/deploy.sh ${env} ${version}`);

    return {
      content: [
        {
          type: "text",
          text: `âœ“ Deployed ${version} to ${env}`,
        },
      ],
      details: { env, version, timestamp: Date.now() },
    };
  },
});
```

---

## 10. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å·¥å…·æ³¨å†Œ**ï¼šä½¿ç”¨ registerTool æ·»åŠ è‡ªå®šä¹‰å·¥å…·
2. **å‚æ•° Schema**ï¼šä½¿ç”¨ TypeBox å®šä¹‰å‚æ•°ï¼ŒStringEnum ç”¨äºæšä¸¾
3. **è¿›åº¦æ›´æ–°**ï¼šä½¿ç”¨ onUpdate æä¾›å®æ—¶åé¦ˆ
4. **å–æ¶ˆæ”¯æŒ**ï¼šå“åº” AbortSignal å®ç°å–æ¶ˆåŠŸèƒ½
5. **è‡ªå®šä¹‰æ¸²æŸ“**ï¼šä½¿ç”¨ renderCall å’Œ renderResult å®šåˆ¶ UI
6. **å‘½ä»¤æ³¨å†Œ**ï¼šä½¿ç”¨ registerCommand æ·»åŠ æ–œæ å‘½ä»¤
7. **å¿«æ·é”®æ³¨å†Œ**ï¼šä½¿ç”¨ registerShortcut æ·»åŠ é”®ç›˜å¿«æ·é”®
8. **é”™è¯¯å¤„ç†**ï¼šæ•è·å¹¶å¤„ç†æ‰€æœ‰é”™è¯¯ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### ä¸‹ä¸€æ­¥

- **æ ¸å¿ƒæ¦‚å¿µ 04**ï¼šUI å®šåˆ¶ä¸äº¤äº’
- **æ ¸å¿ƒæ¦‚å¿µ 05**ï¼šProvider ä¸æ¨¡å‹ç®¡ç†
- **å®æˆ˜ä»£ç **ï¼šå·¥å…·å¢å¼ºæ‰©å±•ã€å‘½ä»¤ä¸å¿«æ·é”®æ‰©å±•

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-20
**é€‚ç”¨äº**: pi-mono 2025-2026 ç‰ˆæœ¬
