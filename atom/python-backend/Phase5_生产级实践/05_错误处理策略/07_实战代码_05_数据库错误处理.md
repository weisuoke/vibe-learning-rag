# 实战代码5：数据库错误处理

**场景：** 处理 SQLAlchemy 数据库操作的各种错误

---

## 完整代码

```python
"""
数据库错误处理
处理：连接错误、完整性错误、事务回滚
"""

from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.exc import IntegrityError, OperationalError, DBAPIError
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type
import structlog

logger = structlog.get_logger()

# ===== 自定义异常 =====
class DatabaseError(Exception):
    def __init__(self, operation: str, error: str):
        self.operation = operation
        self.error = error
        super().__init__(f"数据库操作失败: {operation} - {error}")

# ===== 数据库操作（带错误处理）=====
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=0.5, min=0.5, max=5),
    retry=retry_if_exception_type((OperationalError, DBAPIError))
)
async def save_conversation(session: AsyncSession, conversation: dict):
    """保存对话（自动重试）"""
    try:
        from models import Conversation

        conv = Conversation(**conversation)
        session.add(conv)
        await session.commit()

        logger.info("conversation_saved", conversation_id=conv.id)
        return conv
    except IntegrityError as e:
        await session.rollback()
        logger.error("integrity_error", error=str(e))
        raise DatabaseError("save_conversation", "数据完整性错误")
    except OperationalError as e:
        await session.rollback()
        logger.error("operational_error", error=str(e))
        raise DatabaseError("save_conversation", "数据库连接失败")
    except Exception as e:
        await session.rollback()
        logger.error("database_error", error=str(e))
        raise DatabaseError("save_conversation", str(e))

# ===== FastAPI 集成 =====
from fastapi import FastAPI, Depends, HTTPException

app = FastAPI()

async def get_session():
    """获取数据库会话"""
    engine = create_async_engine("postgresql+asyncpg://...")
    async with AsyncSession(engine) as session:
        yield session

@app.post("/conversations")
async def create_conversation(
    message: str,
    response: str,
    session: AsyncSession = Depends(get_session)
):
    try:
        conversation = await save_conversation(
            session,
            {"message": message, "response": response}
        )
        return {"id": conversation.id}
    except DatabaseError as e:
        raise HTTPException(status_code=500, detail=e.error)
```

---

## 运行输出

```bash
# 正常保存
curl -X POST "http://localhost:8000/conversations" \
  -d '{"message": "你好", "response": "你好！"}'
# → {"id": 1}

# 数据完整性错误（重复ID）
# → {"detail": "数据完整性错误"}

# 数据库连接失败（自动重试3次）
# → {"detail": "数据库连接失败"}
```
