# 核心概念1：基础类型注解

详细讲解 Python 类型注解的基础类型系统。

---

## 概述

Python 类型注解支持从简单到复杂的各种类型定义。本文档覆盖最常用的基础类型。

---

## 1. 内置基础类型

### 1.1 四大基础类型

```python
# int - 整数
age: int = 25
user_id: int = 12345
count: int = 0

# str - 字符串
name: str = "Alice"
email: str = "alice@example.com"
message: str = "Hello, World!"

# float - 浮点数
price: float = 99.99
temperature: float = 36.5
pi: float = 3.14159

# bool - 布尔值
is_active: bool = True
has_permission: bool = False
is_admin: bool = True
```

**在 FastAPI 中的应用：**

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/users/{user_id}")
async def get_user(
    user_id: int,  # 路径参数自动转换为 int
    include_email: bool = False  # 查询参数自动转换为 bool
):
    return {"user_id": user_id, "include_email": include_email}

# 访问：GET /users/123?include_email=true
# FastAPI 自动：
# - 将 "123" 转换为 123（int）
# - 将 "true" 转换为 True（bool）
# - 如果类型错误，返回 422 错误
```

### 1.2 None 类型

```python
# None 是特殊的单例类型
result: None = None

def log_message(message: str) -> None:
    """无返回值的函数"""
    print(f"[LOG] {message}")
    # 隐式返回 None

# 显式返回 None
def initialize() -> None:
    print("Initializing...")
    return None
```

**类比 TypeScript：**

```typescript
// TypeScript
function logMessage(message: string): void {
    console.log(`[LOG] ${message}`);
}

// Python 的 None 类似 TypeScript 的 void
```

---

## 2. Optional 类型（最重要）

### 2.1 基本用法

```python
from typing import Optional

# Optional[T] = T | None
email: Optional[str] = None  # 可以是 str 或 None
age: Optional[int] = 25  # 可以是 int 或 None

# Python 3.10+ 新语法
email: str | None = None
age: int | None = 25
```

### 2.2 函数返回 Optional

```python
from typing import Optional

def find_user(user_id: int) -> Optional[str]:
    """查找用户，可能不存在"""
    users = {1: "Alice", 2: "Bob", 3: "Charlie"}
    return users.get(user_id)  # get() 返回 None 如果不存在

# 使用时必须检查 None
user_name = find_user(999)
if user_name is not None:
    print(user_name.upper())  # 安全
else:
    print("User not found")

# ❌ 错误：不检查 None
user_name = find_user(999)
print(user_name.upper())  # 可能 AttributeError
```

### 2.3 Optional 参数

```python
from typing import Optional

def greet(name: str, title: Optional[str] = None) -> str:
    """问候函数，title 是可选的"""
    if title is not None:
        return f"Hello, {title} {name}"
    return f"Hello, {name}"

# 使用
print(greet("Alice"))  # "Hello, Alice"
print(greet("Alice", "Dr."))  # "Hello, Dr. Alice"
```

### 2.4 在 FastAPI 中的应用

```python
from fastapi import FastAPI, Query
from typing import Optional

app = FastAPI()

@app.get("/search")
async def search(
    q: str,  # 必填查询参数
    category: Optional[str] = None,  # 可选查询参数
    limit: int = 10  # 可选，有默认值
):
    result = {"query": q, "limit": limit}
    if category is not None:
        result["category"] = category
    return result

# 访问：GET /search?q=python
# 访问：GET /search?q=python&category=tutorial
```

### 2.5 mypy 对 Optional 的检查

```python
from typing import Optional

def get_user_email(user_id: int) -> Optional[str]:
    return find_user(user_id)

# ❌ mypy 报错：Optional[str] 不能直接调用 upper()
email = get_user_email(1)
print(email.upper())

# ✅ mypy 通过：检查了 None
email = get_user_email(1)
if email is not None:
    print(email.upper())

# ✅ mypy 通过：使用默认值
email = get_user_email(1) or "unknown@example.com"
print(email.upper())
```

---

## 3. 容器类型

### 3.1 List（列表）

```python
# Python 3.9+ 写法
names: list[str] = ["Alice", "Bob", "Charlie"]
scores: list[int] = [95, 87, 92, 88]
prices: list[float] = [9.99, 19.99, 29.99]

# 旧写法（Python 3.5-3.8）
from typing import List
names: List[str] = ["Alice", "Bob"]

# 空列表
empty: list[str] = []

# 嵌套列表
matrix: list[list[int]] = [
    [1, 2, 3],
    [4, 5, 6],
    [7, 8, 9]
]
```

**函数使用：**

```python
def get_top_students(scores: list[int], n: int) -> list[int]:
    """返回前 n 名学生的分数"""
    sorted_scores = sorted(scores, reverse=True)
    return sorted_scores[:n]

# 使用
top_scores = get_top_students([95, 87, 92, 88, 90], 3)
print(top_scores)  # [95, 92, 90]
```

**在 FastAPI 中：**

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

@app.post("/items/batch")
async def create_items(items: list[Item]):
    """批量创建商品"""
    return {"count": len(items), "items": items}

# 请求体：
# [
#   {"name": "Book", "price": 29.99},
#   {"name": "Pen", "price": 1.99}
# ]
```

### 3.2 Dict（字典）

```python
# Python 3.9+ 写法
user_ages: dict[str, int] = {"Alice": 25, "Bob": 30}
config: dict[str, str] = {"host": "localhost", "port": "8000"}
scores: dict[int, float] = {1: 95.5, 2: 87.3, 3: 92.1}

# 旧写法
from typing import Dict
user_ages: Dict[str, int] = {"Alice": 25}

# 空字典
empty: dict[str, int] = {}

# 嵌套字典
users: dict[str, dict[str, str]] = {
    "user1": {"name": "Alice", "email": "alice@example.com"},
    "user2": {"name": "Bob", "email": "bob@example.com"}
}
```

**函数使用：**

```python
def merge_configs(
    default: dict[str, str],
    custom: dict[str, str]
) -> dict[str, str]:
    """合并配置"""
    return {**default, **custom}

# 使用
default_config = {"host": "localhost", "port": "8000"}
custom_config = {"port": "9000", "debug": "true"}
final_config = merge_configs(default_config, custom_config)
print(final_config)  # {"host": "localhost", "port": "9000", "debug": "true"}
```

**在 FastAPI 中：**

```python
from fastapi import FastAPI

app = FastAPI()

@app.post("/config")
async def update_config(config: dict[str, str]):
    """更新配置"""
    return {"updated": config}

# 请求体：
# {
#   "host": "localhost",
#   "port": "8000",
#   "debug": "true"
# }
```

### 3.3 Tuple（元组）

```python
# 固定长度和类型的元组
coordinates: tuple[float, float] = (37.7749, -122.4194)
user_info: tuple[str, int, bool] = ("Alice", 25, True)

# 可变长度的元组（所有元素类型相同）
numbers: tuple[int, ...] = (1, 2, 3, 4, 5)

# 函数返回多个值
def get_user_info(user_id: int) -> tuple[str, int, str]:
    """返回用户信息：姓名、年龄、邮箱"""
    return ("Alice", 25, "alice@example.com")

# 使用
name, age, email = get_user_info(1)
print(f"{name}, {age}, {email}")
```

### 3.4 Set（集合）

```python
# Python 3.9+ 写法
tags: set[str] = {"python", "fastapi", "ai"}
user_ids: set[int] = {1, 2, 3, 4, 5}

# 旧写法
from typing import Set
tags: Set[str] = {"python", "fastapi"}

# 空集合
empty: set[str] = set()

# 函数使用
def get_unique_tags(items: list[dict[str, str]]) -> set[str]:
    """获取所有唯一标签"""
    tags = set()
    for item in items:
        tags.update(item.get("tags", []))
    return tags
```

---

## 4. Union 类型（多种可能）

### 4.1 基本用法

```python
from typing import Union

# 旧写法
user_id: Union[int, str] = 123
user_id: Union[int, str] = "user_123"

# Python 3.10+ 新写法
user_id: int | str = 123
user_id: int | str = "user_123"

# 多种类型
value: int | float | str = 42
value: int | float | str = 3.14
value: int | float | str = "hello"
```

### 4.2 函数使用

```python
def process_id(user_id: int | str) -> str:
    """处理用户ID，可以是整数或字符串"""
    if isinstance(user_id, int):
        return f"ID: {user_id}"
    else:
        return f"Username: {user_id}"

# 使用
print(process_id(123))  # "ID: 123"
print(process_id("alice"))  # "Username: alice"
```

### 4.3 在 FastAPI 中

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/users/{user_id}")
async def get_user(user_id: int | str):
    """用户ID可以是整数或字符串"""
    if isinstance(user_id, int):
        return {"type": "numeric_id", "value": user_id}
    return {"type": "username", "value": user_id}

# 访问：GET /users/123
# 访问：GET /users/alice
```

### 4.4 Union vs Optional

```python
from typing import Optional

# Optional[T] 是 Union[T, None] 的简写
email: Optional[str] = None
# 等价于
email: Union[str, None] = None
# 等价于（Python 3.10+）
email: str | None = None

# Union 可以有多个类型
value: int | float | str = 42
# Optional 只能是 T 或 None
value: Optional[int] = None
```

---

## 5. Any 类型（谨慎使用）

### 5.1 基本用法

```python
from typing import Any

# Any 表示任意类型
data: Any = 42
data: Any = "hello"
data: Any = [1, 2, 3]
data: Any = {"key": "value"}

# 函数使用
def process_data(data: Any) -> str:
    """处理任意类型的数据"""
    return str(data)
```

### 5.2 何时使用 Any

**合理场景：**

```python
import json
from typing import Any

def parse_json(text: str) -> dict[str, Any]:
    """解析 JSON，值类型未知"""
    return json.loads(text)

# 使用
data = parse_json('{"name": "Alice", "age": 25}')
name: str = data["name"]  # 手动断言类型
age: int = data["age"]
```

**应该避免：**

```python
# ❌ 不好：懒得写类型
def process(data: Any) -> Any:
    return data.upper()

# ✅ 好：明确类型
def process(data: str) -> str:
    return data.upper()
```

---

## 6. 类型别名（简化复杂类型）

### 6.1 基本用法

```python
from typing import Union

# 定义类型别名
UserId = int | str
UserData = dict[str, str | int]
Coordinates = tuple[float, float]

# 使用类型别名
def get_user(user_id: UserId) -> UserData:
    return {"name": "Alice", "age": 25}

def calculate_distance(
    point1: Coordinates,
    point2: Coordinates
) -> float:
    x1, y1 = point1
    x2, y2 = point2
    return ((x2 - x1) ** 2 + (y2 - y1) ** 2) ** 0.5
```

### 6.2 复杂类型别名

```python
from typing import Optional

# JSON 数据类型
JsonValue = str | int | float | bool | None | dict[str, "JsonValue"] | list["JsonValue"]
JsonObject = dict[str, JsonValue]

# 配置类型
Config = dict[str, str | int | bool]

# 回调函数类型
from typing import Callable
Callback = Callable[[str], None]

def process_with_callback(data: str, callback: Callback) -> None:
    result = data.upper()
    callback(result)
```

---

## 7. 实战示例

### 示例1：用户管理系统

```python
from typing import Optional

class User:
    def __init__(
        self,
        user_id: int,
        name: str,
        email: str,
        age: Optional[int] = None
    ):
        self.user_id = user_id
        self.name = name
        self.email = email
        self.age = age

def find_user_by_id(user_id: int) -> Optional[User]:
    """根据ID查找用户"""
    # 模拟数据库查询
    if user_id == 1:
        return User(1, "Alice", "alice@example.com", 25)
    return None

def get_user_display_name(user: User) -> str:
    """获取用户显示名称"""
    if user.age is not None:
        return f"{user.name} ({user.age})"
    return user.name

# 使用
user = find_user_by_id(1)
if user is not None:
    print(get_user_display_name(user))
```

### 示例2：配置管理

```python
from typing import Optional

# 类型别名
Config = dict[str, str | int | bool]

def load_config(file_path: str) -> Config:
    """加载配置文件"""
    return {
        "host": "localhost",
        "port": 8000,
        "debug": True,
        "workers": 4
    }

def get_config_value(
    config: Config,
    key: str,
    default: Optional[str | int | bool] = None
) -> str | int | bool | None:
    """获取配置值"""
    return config.get(key, default)

# 使用
config = load_config("config.json")
host = get_config_value(config, "host", "0.0.0.0")
port = get_config_value(config, "port", 8000)
```

### 示例3：数据处理管道

```python
from typing import Callable

# 类型别名
DataProcessor = Callable[[list[int]], list[int]]

def filter_positive(numbers: list[int]) -> list[int]:
    """过滤正数"""
    return [n for n in numbers if n > 0]

def double_values(numbers: list[int]) -> list[int]:
    """值翻倍"""
    return [n * 2 for n in numbers]

def apply_processors(
    data: list[int],
    processors: list[DataProcessor]
) -> list[int]:
    """应用多个处理器"""
    result = data
    for processor in processors:
        result = processor(result)
    return result

# 使用
data = [-2, -1, 0, 1, 2, 3]
processors = [filter_positive, double_values]
result = apply_processors(data, processors)
print(result)  # [2, 4, 6]
```

---

## 总结

### 基础类型速查表

| 类型 | 语法 | 示例 |
|------|------|------|
| 整数 | `int` | `age: int = 25` |
| 字符串 | `str` | `name: str = "Alice"` |
| 浮点数 | `float` | `price: float = 99.99` |
| 布尔值 | `bool` | `is_active: bool = True` |
| 无返回值 | `None` | `def log() -> None` |
| 可选类型 | `Optional[T]` | `email: Optional[str]` |
| 列表 | `list[T]` | `names: list[str]` |
| 字典 | `dict[K, V]` | `ages: dict[str, int]` |
| 元组 | `tuple[T, ...]` | `coords: tuple[float, float]` |
| 集合 | `set[T]` | `tags: set[str]` |
| 联合类型 | `T \| U` | `id: int \| str` |
| 任意类型 | `Any` | `data: Any` |

### 最佳实践

1. **优先使用具体类型**：避免过度使用 `Any`
2. **处理 Optional**：使用前检查 `None`
3. **使用类型别名**：简化复杂类型定义
4. **Python 3.10+**：使用 `T | U` 代替 `Union[T, U]`
5. **FastAPI 集成**：充分利用类型注解的自动验证

### 下一步

学习完基础类型注解后，继续学习：
- 泛型与高级类型（Generic、Protocol、Literal）
- mypy 静态类型检查配置
- FastAPI 中的实战应用
