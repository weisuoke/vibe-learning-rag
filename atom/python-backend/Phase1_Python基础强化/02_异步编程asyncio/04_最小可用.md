# 最小可用知识

> 掌握以下内容，就能开始使用 asyncio 构建异步 API

---

## 核心理念

**20%的核心知识解决80%的问题**

在 AI Agent 开发中，你只需要掌握以下几个核心概念，就能编写高性能的异步 API。

---

## 4.1 定义异步函数：async def

**一句话：** 用 `async def` 定义异步函数，它返回一个协程对象

```python
# 定义异步函数
async def fetch_user(user_id: int):
    # 模拟数据库查询
    await asyncio.sleep(0.1)
    return {"id": user_id, "name": "Alice"}

# 调用异步函数（必须用 await）
user = await fetch_user(1)
```

**前端类比：**
```javascript
// JavaScript
async function fetchUser(userId) {
    await sleep(100);
    return {id: userId, name: "Alice"};
}
```

**在 AI Agent 中的应用：**
- FastAPI 路由函数
- 数据库查询函数
- LLM API 调用函数

---

## 4.2 等待异步操作：await

**一句话：** `await` 暂停当前协程，等待异步操作完成，然后继续执行

```python
async def main():
    # await 会等待异步函数完成
    result = await fetch_user(1)
    print(result)  # {"id": 1, "name": "Alice"}

    # 可以连续 await 多个操作
    user1 = await fetch_user(1)
    user2 = await fetch_user(2)  # 串行执行，总耗时 0.2秒
```

**关键规则：**
- ✅ 只能在 `async def` 函数内使用 `await`
- ✅ `await` 后面必须是可等待对象（协程、Task、Future）
- ❌ 不能在普通函数中使用 `await`

**在 AI Agent 中的应用：**
```python
@app.get("/user/{user_id}")
async def get_user(user_id: int):
    # 等待数据库查询
    user = await db.fetch_user(user_id)
    return user
```

---

## 4.3 并发执行：asyncio.gather()

**一句话：** 同时执行多个异步操作，等待全部完成

```python
async def main():
    # 并发执行3个查询，总耗时 0.1秒（而非 0.3秒）
    results = await asyncio.gather(
        fetch_user(1),
        fetch_user(2),
        fetch_user(3)
    )
    print(results)  # [user1, user2, user3]
```

**前端类比：**
```javascript
// JavaScript Promise.all()
const results = await Promise.all([
    fetchUser(1),
    fetchUser(2),
    fetchUser(3)
]);
```

**性能对比：**
```python
# ❌ 串行执行：0.3秒
user1 = await fetch_user(1)  # 0.1秒
user2 = await fetch_user(2)  # 0.1秒
user3 = await fetch_user(3)  # 0.1秒

# ✅ 并发执行：0.1秒
users = await asyncio.gather(
    fetch_user(1),
    fetch_user(2),
    fetch_user(3)
)  # 同时执行，总耗时 0.1秒
```

**在 AI Agent 中的应用：**
```python
# 同时调用多个 LLM API
responses = await asyncio.gather(
    openai_client.chat.completions.create(...),
    anthropic_client.messages.create(...),
    cohere_client.generate(...)
)
```

---

## 4.4 运行异步主函数：asyncio.run()

**一句话：** 启动事件循环，运行异步主函数

```python
async def main():
    users = await asyncio.gather(
        fetch_user(1),
        fetch_user(2),
        fetch_user(3)
    )
    print(users)

# 运行异步主函数
if __name__ == "__main__":
    asyncio.run(main())
```

**前端类比：**
```javascript
// JavaScript 不需要显式启动事件循环
// Node.js 自动运行事件循环
async function main() {
    const users = await Promise.all([...]);
}
main();
```

**在 AI Agent 中的应用：**
- FastAPI 自动管理事件循环，不需要手动调用 `asyncio.run()`
- 只在独立脚本中使用 `asyncio.run()`

---

## 4.5 创建后台任务：asyncio.create_task()

**一句话：** 创建一个任务在后台运行，不阻塞当前代码

```python
async def send_email(user_id: int):
    await asyncio.sleep(2)  # 模拟发送邮件
    print(f"Email sent to user {user_id}")

async def main():
    # 创建后台任务，不等待完成
    task = asyncio.create_task(send_email(1))

    # 继续执行其他操作
    print("继续处理其他请求...")

    # 如果需要，可以稍后等待任务完成
    await task
```

**前端类比：**
```javascript
// JavaScript
async function main() {
    // 启动一个 Promise，不等待
    const emailPromise = sendEmail(1);

    console.log("继续处理其他请求...");

    // 稍后等待
    await emailPromise;
}
```

**在 AI Agent 中的应用：**
```python
from fastapi import BackgroundTasks

@app.post("/user")
async def create_user(user: User, background_tasks: BackgroundTasks):
    # 保存用户到数据库
    await db.save_user(user)

    # 后台发送欢迎邮件
    background_tasks.add_task(send_welcome_email, user.email)

    return {"status": "created"}
```

---

## 这些知识足以

掌握以上5个核心概念，你就能：

✅ **编写异步 FastAPI 路由**
```python
@app.get("/users/{user_id}")
async def get_user(user_id: int):
    user = await db.fetch_user(user_id)
    return user
```

✅ **并发调用多个 API**
```python
results = await asyncio.gather(
    llm_api_1.generate(prompt),
    llm_api_2.generate(prompt),
    llm_api_3.generate(prompt)
)
```

✅ **处理后台任务**
```python
task = asyncio.create_task(long_running_task())
# 继续处理其他请求
```

✅ **为后续学习打基础**
- FastAPI 依赖注入
- 数据库连接池
- AI Agent 流式输出
- 生产级错误处理

---

## 快速参考卡

| 操作 | 语法 | 用途 |
|------|------|------|
| 定义异步函数 | `async def func():` | 创建可异步执行的函数 |
| 等待异步操作 | `await func()` | 暂停等待异步操作完成 |
| 并发执行 | `await asyncio.gather(f1(), f2())` | 同时执行多个异步操作 |
| 运行主函数 | `asyncio.run(main())` | 启动事件循环 |
| 后台任务 | `asyncio.create_task(func())` | 创建不阻塞的后台任务 |

---

## 学习检查

完成本节后，你应该能够：

- [ ] 使用 `async def` 定义异步函数
- [ ] 使用 `await` 等待异步操作
- [ ] 使用 `asyncio.gather()` 并发执行多个任务
- [ ] 使用 `asyncio.run()` 运行异步主函数
- [ ] 使用 `asyncio.create_task()` 创建后台任务
- [ ] 理解串行执行和并发执行的性能差异

---

## 下一步

- **深入理解**：阅读【第一性原理】和【核心概念】
- **实战练习**：完成【实战代码】中的所有示例
- **应用到项目**：在 FastAPI 项目中使用异步路由

---

**记住：** 这5个概念是 asyncio 的核心，掌握它们就能解决 80% 的异步编程问题！
