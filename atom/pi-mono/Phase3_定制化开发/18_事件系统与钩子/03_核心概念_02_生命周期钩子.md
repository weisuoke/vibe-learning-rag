# 核心概念 2：生命周期钩子

## 一句话定义

**生命周期钩子是 pi-mono 在 Agent 运行的关键时刻触发的 40+ 个事件，允许在特定时机插入自定义逻辑。**

---

## 详细解释

### 什么是生命周期钩子？

生命周期钩子（Lifecycle Hooks）是在 Agent 运行的关键节点自动触发的事件，类似于 React 的 useEffect 或 Vue 的生命周期函数。

**核心特点：**
- **预定义时机**：在特定的生命周期节点触发（如 session_start、before_agent_start）
- **自动触发**：无需手动调用，由 pi-mono 核心代码自动触发
- **可插拔**：可以在任何钩子上注册多个处理器
- **有序执行**：按注册顺序执行

**与普通事件的区别：**
- **生命周期钩子**：预定义的、有明确语义的事件（如 session_start）
- **自定义事件**：用户自定义的、用于扩展间通信的事件（如 pi.events.emit('my-event')）

### 生命周期钩子分类

pi-mono 提供了 40+ 个生命周期钩子，分为 7 大类：

| 类别 | 数量 | 用途 |
|------|------|------|
| Session Events | 10个 | 会话生命周期管理 |
| Agent Events | 6个 | Agent 运行周期控制 |
| Message Events | 3个 | 消息处理流程 |
| Tool Events | 5个 | 工具调用监控 |
| Model Events | 1个 | 模型选择 |
| User Events | 2个 | 用户交互 |
| Resource Events | 1个 | 资源发现 |

---

## Session Events（会话生命周期）

Session Events 管理会话的整个生命周期，从创建到销毁。

### 1. session_start

**触发时机：** 新会话启动时

**参数：**
```typescript
pi.on('session_start', (session: Session) => {
  // session.id: 会话 ID
  // session.messages: 消息列表
  // session.settings: 会话设置
});
```

**使用场景：**
- 初始化会话状态
- 加载会话配置
- 记录会话开始时间

**示例：**
```typescript
pi.on('session_start', (session) => {
  console.log('=== Session Started ===');
  console.log('Session ID:', session.id);
  console.log('Messages:', session.messages.length);

  // 初始化会话状态
  sessionState.set(session.id, {
    startTime: Date.now(),
    toolCalls: 0
  });
});
```

### 2. session_before_switch

**触发时机：** 切换会话之前

**参数：**
```typescript
pi.on('session_before_switch', (fromSession: Session, toSession: Session) => {
  // fromSession: 当前会话
  // toSession: 目标会话
});
```

**使用场景：**
- 保存当前会话状态
- 清理临时资源
- 记录切换日志

**示例：**
```typescript
pi.on('session_before_switch', (fromSession, toSession) => {
  console.log(`Switching from ${fromSession.id} to ${toSession.id}`);

  // 保存当前会话状态
  saveSessionState(fromSession.id);
});
```

### 3. session_switch

**触发时机：** 切换会话之后

**参数：**
```typescript
pi.on('session_switch', (fromSession: Session, toSession: Session) => {
  // fromSession: 之前的会话
  // toSession: 当前会话
});
```

**使用场景：**
- 加载新会话状态
- 初始化新会话资源
- 更新 UI 显示

**示例：**
```typescript
pi.on('session_switch', (fromSession, toSession) => {
  console.log(`Switched to session: ${toSession.id}`);

  // 加载新会话状态
  loadSessionState(toSession.id);
});
```

### 4. session_before_fork

**触发时机：** 分支会话之前

**参数：**
```typescript
pi.on('session_before_fork', (parentSession: Session, forkPoint: number) => {
  // parentSession: 父会话
  // forkPoint: 分支点（消息索引）
});
```

**使用场景：**
- 记录分支操作
- 复制父会话状态
- 准备分支资源

**示例：**
```typescript
pi.on('session_before_fork', (parentSession, forkPoint) => {
  console.log(`Forking session ${parentSession.id} at message ${forkPoint}`);

  // 复制父会话状态
  const parentState = sessionState.get(parentSession.id);
  // 准备分支状态
});
```

### 5. session_fork

**触发时机：** 分支会话之后

**参数：**
```typescript
pi.on('session_fork', (parentSession: Session, childSession: Session) => {
  // parentSession: 父会话
  // childSession: 子会话
});
```

**使用场景：**
- 初始化子会话状态
- 记录分支关系
- 更新会话树

**示例：**
```typescript
pi.on('session_fork', (parentSession, childSession) => {
  console.log(`Forked session: ${childSession.id} from ${parentSession.id}`);

  // 初始化子会话状态
  sessionState.set(childSession.id, {
    parent: parentSession.id,
    startTime: Date.now()
  });
});
```

### 6. session_before_compact

**触发时机：** 压缩会话之前

**参数：**
```typescript
pi.on('session_before_compact', (session: Session) => {
  // session: 待压缩的会话
});
```

**使用场景：**
- 自定义压缩策略
- 保存重要消息
- 记录压缩日志

**示例：**
```typescript
pi.on('session_before_compact', (session) => {
  console.log(`Compacting session: ${session.id}`);
  console.log(`Messages before: ${session.messages.length}`);

  // 可以在这里实现自定义压缩逻辑
});
```

### 7. session_compact

**触发时机：** 压缩会话之后

**参数：**
```typescript
pi.on('session_compact', (session: Session, removedCount: number) => {
  // session: 压缩后的会话
  // removedCount: 移除的消息数量
});
```

**使用场景：**
- 记录压缩结果
- 更新统计信息
- 清理相关资源

**示例：**
```typescript
pi.on('session_compact', (session, removedCount) => {
  console.log(`Compacted session: ${session.id}`);
  console.log(`Removed ${removedCount} messages`);
  console.log(`Messages after: ${session.messages.length}`);
});
```

### 8. session_shutdown

**触发时机：** 会话关闭时

**参数：**
```typescript
pi.on('session_shutdown', (session: Session) => {
  // session: 关闭的会话
});
```

**使用场景：**
- 清理会话资源
- 保存会话数据
- 记录会话统计

**示例：**
```typescript
pi.on('session_shutdown', (session) => {
  console.log(`Session shutdown: ${session.id}`);

  // 清理会话状态
  const state = sessionState.get(session.id);
  if (state) {
    console.log('Session stats:', {
      duration: Date.now() - state.startTime,
      toolCalls: state.toolCalls
    });
    sessionState.delete(session.id);
  }
});
```

### 9. session_before_tree

**触发时机：** 显示会话树之前

**参数：**
```typescript
pi.on('session_before_tree', () => {
  // 无参数
});
```

**使用场景：**
- 准备会话树数据
- 更新会话关系
- 记录树操作

**示例：**
```typescript
pi.on('session_before_tree', () => {
  console.log('Preparing session tree...');
});
```

### 10. session_tree

**触发时机：** 显示会话树之后

**参数：**
```typescript
pi.on('session_tree', (tree: SessionTree) => {
  // tree: 会话树结构
});
```

**使用场景：**
- 分析会话关系
- 导出会话树
- 可视化会话结构

**示例：**
```typescript
pi.on('session_tree', (tree) => {
  console.log('Session tree:', JSON.stringify(tree, null, 2));
});
```

---

## Agent Events（Agent 运行周期）

Agent Events 控制 Agent 的运行周期，从启动到结束。

### 1. before_agent_start

**触发时机：** Agent 启动之前（可以修改消息）

**参数：**
```typescript
pi.on('before_agent_start', (messages: Message[]) => {
  // messages: 消息数组（可修改）
});
```

**使用场景：**
- 注入系统指令
- 添加项目上下文
- 修改用户消息

**示例：**
```typescript
pi.on('before_agent_start', (messages) => {
  // 注入项目上下文
  const projectContext = loadProjectContext();
  messages.push({
    role: 'system',
    content: `Project context: ${projectContext}`
  });

  // 添加自定义指令
  messages.push({
    role: 'system',
    content: 'Always write clean, maintainable code.'
  });
});
```

### 2. agent_start

**触发时机：** Agent 开始运行

**参数：**
```typescript
pi.on('agent_start', () => {
  // 无参数
});
```

**使用场景：**
- 记录开始时间
- 初始化 Agent 状态
- 发送通知

**示例：**
```typescript
pi.on('agent_start', () => {
  const startTime = Date.now();
  console.log('Agent started at:', new Date(startTime).toISOString());

  // 记录开始时间
  agentState.set('startTime', startTime);
});
```

### 3. agent_end

**触发时机：** Agent 运行结束

**参数：**
```typescript
pi.on('agent_end', (result: AgentResult) => {
  // result: Agent 运行结果
});
```

**使用场景：**
- 计算运行时间
- 记录运行结果
- 清理 Agent 资源

**示例：**
```typescript
pi.on('agent_end', (result) => {
  const startTime = agentState.get('startTime');
  const duration = Date.now() - startTime;

  console.log('Agent ended');
  console.log('Duration:', duration, 'ms');
  console.log('Result:', result);

  // 清理状态
  agentState.clear();
});
```

### 4. turn_start

**触发时机：** 每个 turn（回合）开始

**参数：**
```typescript
pi.on('turn_start', (turnNumber: number) => {
  // turnNumber: 回合编号（从 1 开始）
});
```

**使用场景：**
- 记录回合开始
- 初始化回合状态
- 监控回合数量

**示例：**
```typescript
pi.on('turn_start', (turnNumber) => {
  console.log(`=== Turn ${turnNumber} Started ===`);

  // 记录回合状态
  turnState.set(turnNumber, {
    startTime: Date.now(),
    toolCalls: []
  });
});
```

### 5. turn_end

**触发时机：** 每个 turn（回合）结束

**参数：**
```typescript
pi.on('turn_end', (turnNumber: number) => {
  // turnNumber: 回合编号
});
```

**使用场景：**
- 计算回合时间
- 统计回合信息
- 清理回合资源

**示例：**
```typescript
pi.on('turn_end', (turnNumber) => {
  const state = turnState.get(turnNumber);
  const duration = Date.now() - state.startTime;

  console.log(`=== Turn ${turnNumber} Ended ===`);
  console.log('Duration:', duration, 'ms');
  console.log('Tool calls:', state.toolCalls.length);

  // 清理回合状态
  turnState.delete(turnNumber);
});
```

### 6. context

**触发时机：** 上下文更新时

**参数：**
```typescript
pi.on('context', (context: Context) => {
  // context: 当前上下文
});
```

**使用场景：**
- 监控上下文变化
- 记录上下文大小
- 优化上下文使用

**示例：**
```typescript
pi.on('context', (context) => {
  console.log('Context updated');
  console.log('Token count:', context.tokenCount);
  console.log('Files:', context.files.length);
});
```

---

## Message Events（消息处理流程）

Message Events 跟踪消息的处理流程，从开始到结束。

### 1. message_start

**触发时机：** 消息开始处理

**参数：**
```typescript
pi.on('message_start', (message: Message) => {
  // message: 开始处理的消息
});
```

**使用场景：**
- 记录消息开始时间
- 初始化消息状态
- 监控消息处理

**示例：**
```typescript
pi.on('message_start', (message) => {
  console.log('Message started:', message.role);

  messageState.set(message.id, {
    startTime: Date.now(),
    content: ''
  });
});
```

### 2. message_update

**触发时机：** 流式消息更新（每次接收到新内容）

**参数：**
```typescript
pi.on('message_update', (message: Message, delta: string) => {
  // message: 当前消息
  // delta: 新增的内容
});
```

**使用场景：**
- 实时显示消息内容
- 监控流式输出
- 记录消息增量

**示例：**
```typescript
pi.on('message_update', (message, delta) => {
  const state = messageState.get(message.id);
  if (state) {
    state.content += delta;
    console.log('Message update:', delta);
  }
});
```

### 3. message_end

**触发时机：** 消息处理完成

**参数：**
```typescript
pi.on('message_end', (message: Message) => {
  // message: 完成的消息
});
```

**使用场景：**
- 计算消息处理时间
- 记录完整消息
- 清理消息状态

**示例：**
```typescript
pi.on('message_end', (message) => {
  const state = messageState.get(message.id);
  const duration = Date.now() - state.startTime;

  console.log('Message ended');
  console.log('Duration:', duration, 'ms');
  console.log('Content length:', message.content.length);

  messageState.delete(message.id);
});
```

---

## Tool Events（工具调用监控）

Tool Events 监控工具的调用和执行过程。

### 1. tool_call

**触发时机：** 工具被调用时

**参数：**
```typescript
pi.on('tool_call', (tool: Tool, args: any) => {
  // tool: 被调用的工具
  // args: 工具参数
});
```

**使用场景：**
- 记录工具调用
- 监控工具使用
- 拦截危险操作

**示例：**
```typescript
pi.on('tool_call', (tool, args) => {
  console.log('=== Tool Called ===');
  console.log('Tool:', tool.name);
  console.log('Args:', JSON.stringify(args, null, 2));

  // 拦截危险命令
  if (tool.name === 'bash' && args.command.includes('rm -rf')) {
    console.warn('⚠️  Dangerous command detected!');
  }
});
```

### 2. tool_result

**触发时机：** 工具执行完成

**参数：**
```typescript
pi.on('tool_result', (tool: Tool, result: any) => {
  // tool: 执行的工具
  // result: 执行结果
});
```

**使用场景：**
- 记录工具结果
- 缓存工具输出
- 分析工具性能

**示例：**
```typescript
pi.on('tool_result', (tool, result) => {
  console.log('=== Tool Result ===');
  console.log('Tool:', tool.name);
  console.log('Result:', result);

  // 缓存结果
  toolCache.set(`${tool.name}:${JSON.stringify(result.args)}`, result);
});
```

### 3. tool_execution_start

**触发时机：** 工具开始执行

**参数：**
```typescript
pi.on('tool_execution_start', (tool: Tool, args: any) => {
  // tool: 开始执行的工具
  // args: 工具参数
});
```

**使用场景：**
- 记录执行开始时间
- 监控执行状态
- 显示执行进度

**示例：**
```typescript
pi.on('tool_execution_start', (tool, args) => {
  console.log(`Executing ${tool.name}...`);

  toolState.set(tool.name, {
    startTime: Date.now()
  });
});
```

### 4. tool_execution_update

**触发时机：** 工具执行过程中（流式输出）

**参数：**
```typescript
pi.on('tool_execution_update', (tool: Tool, update: string) => {
  // tool: 执行中的工具
  // update: 输出更新
});
```

**使用场景：**
- 实时显示工具输出
- 监控执行进度
- 记录执行日志

**示例：**
```typescript
pi.on('tool_execution_update', (tool, update) => {
  console.log(`[${tool.name}] ${update}`);
});
```

### 5. tool_execution_end

**触发时机：** 工具执行结束

**参数：**
```typescript
pi.on('tool_execution_end', (tool: Tool, result: any) => {
  // tool: 执行完成的工具
  // result: 执行结果
});
```

**使用场景：**
- 计算执行时间
- 记录执行结果
- 清理执行状态

**示例：**
```typescript
pi.on('tool_execution_end', (tool, result) => {
  const state = toolState.get(tool.name);
  const duration = Date.now() - state.startTime;

  console.log(`${tool.name} completed in ${duration}ms`);

  toolState.delete(tool.name);
});
```

---

## Model Events（模型选择）

### model_select

**触发时机：** 选择或切换模型时

**参数：**
```typescript
pi.on('model_select', (model: string) => {
  // model: 选择的模型名称
});
```

**使用场景：**
- 记录模型切换
- 监控模型使用
- 统计模型偏好

**示例：**
```typescript
pi.on('model_select', (model) => {
  console.log('Model selected:', model);

  // 记录模型使用
  modelUsage.set(model, (modelUsage.get(model) || 0) + 1);
});
```

---

## User Events（用户交互）

### 1. user_bash

**触发时机：** 用户执行 bash 命令时

**参数：**
```typescript
pi.on('user_bash', (command: string) => {
  // command: 用户执行的命令
});
```

**使用场景：**
- 记录用户命令
- 监控命令使用
- 分析用户行为

**示例：**
```typescript
pi.on('user_bash', (command) => {
  console.log('User executed:', command);

  // 记录命令历史
  commandHistory.push({
    command,
    timestamp: Date.now()
  });
});
```

### 2. input

**触发时机：** 用户输入时

**参数：**
```typescript
pi.on('input', (input: string) => {
  // input: 用户输入的内容
});
```

**使用场景：**
- 记录用户输入
- 分析用户意图
- 监控输入模式

**示例：**
```typescript
pi.on('input', (input) => {
  console.log('User input:', input);

  // 分析输入长度
  inputStats.push({
    length: input.length,
    timestamp: Date.now()
  });
});
```

---

## Resource Events（资源发现）

### resources_discover

**触发时机：** 发现新资源时（如 MCP 资源）

**参数：**
```typescript
pi.on('resources_discover', (resources: Resource[]) => {
  // resources: 发现的资源列表
});
```

**使用场景：**
- 记录资源发现
- 监控资源变化
- 更新资源索引

**示例：**
```typescript
pi.on('resources_discover', (resources) => {
  console.log('Resources discovered:', resources.length);

  resources.forEach(resource => {
    console.log('- ', resource.name, resource.uri);
  });
});
```

---

## 与 2025-2026 最新技术趋势的联系

### NestJS 生命周期钩子（2024-2025）

根据 NestJS 的生命周期钩子模式 [1]，现代框架的生命周期钩子具有以下特点：

**核心特性：**
- 依赖注入支持
- 异步钩子处理
- 钩子执行顺序保证

**在 pi-mono 中的体现：**
```typescript
// NestJS 风格的生命周期钩子
export default function myExtension(pi: ExtensionAPI) {
  // OnInit - 类似 session_start
  pi.on('session_start', async (session) => {
    await initializeExtension();
  });

  // OnDestroy - 类似 session_shutdown
  pi.on('session_shutdown', async (session) => {
    await cleanupExtension();
  });
}
```

---

## 生命周期流程图

```
用户启动 pi
  ↓
session_start
  ↓
用户输入
  ↓
before_agent_start (可修改消息)
  ↓
agent_start
  ↓
turn_start (回合 1)
  ↓
message_start
  ↓
message_update (流式输出)
  ↓
tool_call
  ↓
tool_execution_start
  ↓
tool_execution_update
  ↓
tool_execution_end
  ↓
tool_result
  ↓
message_end
  ↓
turn_end
  ↓
agent_end
  ↓
session_shutdown
```

---

## 最佳实践

### 1. 选择合适的钩子

```typescript
// ✅ 推荐：使用 before_agent_start 注入消息
pi.on('before_agent_start', (messages) => {
  messages.push({ role: 'system', content: 'Custom instruction' });
});

// ❌ 不推荐：使用 agent_start（无法修改消息）
pi.on('agent_start', () => {
  // 太晚了，无法修改消息
});
```

### 2. 避免在钩子中执行耗时操作

```typescript
// ✅ 推荐：异步处理，不阻塞
pi.on('tool_call', async (tool, args) => {
  logToDatabase(tool, args).catch(console.error);
});

// ❌ 不推荐：同步耗时操作
pi.on('tool_call', (tool, args) => {
  syncExpensiveOperation(); // 阻塞主流程
});
```

### 3. 清理资源

```typescript
// ✅ 推荐：在 session_shutdown 清理资源
pi.on('session_shutdown', (session) => {
  sessionState.delete(session.id);
  toolCache.clear();
});
```

### 4. 使用状态管理

```typescript
// ✅ 推荐：使用 Map 管理状态
const sessionState = new Map();

pi.on('session_start', (session) => {
  sessionState.set(session.id, { startTime: Date.now() });
});

pi.on('session_shutdown', (session) => {
  sessionState.delete(session.id);
});
```

---

## 参考资料

[1] NestJS 生命周期钩子, https://docs.nestjs.com/fundamentals/lifecycle-events, 2024-2025

---

**版本：** v1.0
**最后更新：** 2026-02-21
**维护者：** Claude Code
