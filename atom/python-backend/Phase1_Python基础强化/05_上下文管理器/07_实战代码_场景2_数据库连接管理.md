# 实战代码 - 场景2：数据库连接管理

## 概述

演示如何使用上下文管理器管理数据库连接、事务、会话等资源。

---

## 场景2.1：SQLAlchemy 会话管理

```python
"""
SQLAlchemy 会话管理
演示：在 FastAPI 中使用上下文管理器管理数据库会话
"""

from contextlib import contextmanager
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# ===== 数据库配置 =====
DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()

# ===== 模型定义 =====
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)

Base.metadata.create_all(engine)

# ===== 会话上下文管理器 =====
@contextmanager
def get_db():
    """数据库会话上下文管理器"""
    db = SessionLocal()
    try:
        yield db
        db.commit()  # 成功则提交
    except Exception:
        db.rollback()  # 失败则回滚
        raise
    finally:
        db.close()  # 总是关闭

# ===== 使用示例 =====
print("=== 创建用户 ===")
with get_db() as db:
    user = User(name="Alice", email="alice@example.com")
    db.add(user)
print("用户创建成功")

print("\n=== 查询用户 ===")
with get_db() as db:
    users = db.query(User).all()
    for user in users:
        print(f"ID: {user.id}, Name: {user.name}, Email: {user.email}")
```

---

## 场景2.2：事务管理

```python
"""
数据库事务管理
演示：自动提交或回滚事务
"""

@contextmanager
def transaction(db):
    """事务上下文管理器"""
    print("BEGIN TRANSACTION")
    try:
        yield db
        db.commit()
        print("COMMIT")
    except Exception as e:
        db.rollback()
        print(f"ROLLBACK: {e}")
        raise

# ===== 成功案例 =====
print("=== 成功事务 ===")
with get_db() as db:
    with transaction(db):
        user1 = User(name="Bob", email="bob@example.com")
        user2 = User(name="Charlie", email="charlie@example.com")
        db.add(user1)
        db.add(user2)

# ===== 失败案例 =====
print("\n=== 失败事务（自动回滚）===")
try:
    with get_db() as db:
        with transaction(db):
            user = User(name="Dave", email="dave@example.com")
            db.add(user)
            raise ValueError("模拟错误")
except ValueError:
    print("事务已回滚，Dave 未被创建")
```

---

## 场景2.3：连接池管理

```python
"""
连接池管理
演示：使用上下文管理器管理连接池
"""

from contextlib import contextmanager
import psycopg2
from psycopg2 import pool

# 创建连接池
connection_pool = pool.SimpleConnectionPool(
    minconn=1,
    maxconn=10,
    host="localhost",
    database="mydb",
    user="postgres",
    password="password"
)

@contextmanager
def get_connection():
    """从连接池获取连接"""
    conn = connection_pool.getconn()
    print(f"获取连接: {id(conn)}")
    try:
        yield conn
    finally:
        connection_pool.putconn(conn)
        print(f"归还连接: {id(conn)}")

# 使用
with get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
    users = cursor.fetchall()
```

---

## 在 FastAPI 中的应用

```python
"""
FastAPI 数据库依赖注入
演示：使用上下文管理器作为依赖
"""

from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session

app = FastAPI()

def get_db():
    """数据库会话依赖"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/{user_id}")
async def get_user(user_id: int, db: Session = Depends(get_db)):
    """获取用户（自动管理会话）"""
    user = db.query(User).filter(User.id == user_id).first()
    return user

@app.post("/users")
async def create_user(name: str, email: str, db: Session = Depends(get_db)):
    """创建用户（自动提交/回滚）"""
    user = User(name=name, email=email)
    db.add(user)
    db.commit()
    return user
```

---

**版本：** v1.0
**最后更新：** 2026-02-11
