# 实战代码 03：分支创建与导航

> 完整的 TypeScript 分支管理实现，支持分支创建、切换和交互式导航

---

## 代码概览

本文实现完整的分支管理系统，包括：

1. **Leaf Pointer 管理**：跟踪当前活跃节点
2. **分支创建**：从任意节点创建新分支
3. **分支切换**：在不同分支间切换
4. **分支导航**：交互式浏览和选择分支
5. **分支可视化**：显示所有分支的树形结构

---

## 完整实现

### 类型定义

```typescript
// types.ts
export interface BranchInfo {
  id: string;
  leafId: string;
  depth: number;
  messageCount: number;
  lastMessage?: string;
  createdAt: string;
}

export interface NavigationOption {
  type: 'forward' | 'backward' | 'branch' | 'switch';
  targetId: string;
  label: string;
  description?: string;
}
```

### 分支管理器

```typescript
// branch-manager.ts
import { randomBytes } from 'crypto';
import { SessionEntry, TreeNode } from './types';
import { TreeBuilder } from './tree-builder';
import { JsonlManager } from './jsonl-manager';

export class BranchManager {
  private jsonlManager: JsonlManager;
  private treeBuilder: TreeBuilder;
  private leafId: string;

  constructor(filePath: string) {
    this.jsonlManager = new JsonlManager(filePath);

    // 加载现有会话
    const entries = this.jsonlManager.readAll();

    if (entries.length === 0) {
      // 创建新会话
      const rootId = this.generateId();
      const root: SessionEntry = {
        type: 'session',
        id: rootId,
        parentId: null,
        timestamp: new Date().toISOString()
      };

      this.jsonlManager.append(root);
      this.jsonlManager.flush();

      this.leafId = rootId;
      this.treeBuilder = new TreeBuilder([root]);
    } else {
      // 使用最后一个条目作为叶子
      this.leafId = entries[entries.length - 1].id;
      this.treeBuilder = new TreeBuilder(entries);
    }
  }

  /**
   * 生成唯一 ID
   */
  private generateId(): string {
    return randomBytes(4).toString('hex');
  }

  /**
   * 添加消息（总是添加到当前叶子节点下）
   */
  addMessage(content: string, type: 'user' | 'assistant'): string {
    const id = this.generateId();
    const entry: SessionEntry = {
      type,
      id,
      parentId: this.leafId,
      timestamp: new Date().toISOString(),
      content
    };

    this.jsonlManager.append(entry);
    this.jsonlManager.flush();

    // 更新树构建器
    const entries = this.jsonlManager.readAll();
    this.treeBuilder = new TreeBuilder(entries);

    // 更新叶子指针
    this.leafId = id;

    return id;
  }

  /**
   * 创建分支（移动叶子指针）
   */
  branch(branchFromId: string): void {
    const entry = this.treeBuilder.getEntry(branchFromId);
    if (!entry) {
      throw new Error(`Entry not found: ${branchFromId}`);
    }

    this.leafId = branchFromId;
    console.log(`✓ Branched from ${branchFromId}`);
  }

  /**
   * 获取当前叶子 ID
   */
  getLeafId(): string {
    return this.leafId;
  }

  /**
   * 获取当前分支（从叶子到根）
   */
  getCurrentBranch(): SessionEntry[] {
    return this.treeBuilder.getBranch(this.leafId);
  }

  /**
   * 获取所有分支信息
   */
  getAllBranches(): BranchInfo[] {
    const leaves = this.treeBuilder.getLeaves();
    const branches: BranchInfo[] = [];

    for (const leaf of leaves) {
      const branch = this.treeBuilder.getBranch(leaf.id);
      const messages = branch.filter(e => e.type === 'user' || e.type === 'assistant');
      const lastMessage = messages[messages.length - 1];

      branches.push({
        id: leaf.id,
        leafId: leaf.id,
        depth: branch.length,
        messageCount: messages.length,
        lastMessage: lastMessage?.content,
        createdAt: leaf.timestamp
      });
    }

    return branches;
  }

  /**
   * 切换到指定分支
   */
  switchToBranch(branchId: string): void {
    const branches = this.getAllBranches();
    const branch = branches.find(b => b.id === branchId);

    if (!branch) {
      throw new Error(`Branch not found: ${branchId}`);
    }

    this.leafId = branch.leafId;
    console.log(`✓ Switched to branch ${branchId}`);
  }

  /**
   * 获取父节点
   */
  getParent(id: string): SessionEntry | null {
    return this.treeBuilder.getParent(id);
  }

  /**
   * 获取子节点
   */
  getChildren(id: string): SessionEntry[] {
    return this.treeBuilder.getChildren(id);
  }

  /**
   * 可视化当前分支
   */
  visualizeCurrentBranch(): void {
    const branch = this.getCurrentBranch();

    console.log('\n=== Current Branch ===');
    for (let i = 0; i < branch.length; i++) {
      const prefix = '  '.repeat(i);
      const entry = branch[i];
      const marker = entry.id === this.leafId ? ' ← current' : '';

      if (entry.type === 'session') {
        console.log(`${prefix}└─ [Session]${marker}`);
      } else {
        const content = entry.content?.substring(0, 40) || '';
        const suffix = (entry.content?.length || 0) > 40 ? '...' : '';
        console.log(`${prefix}└─ [${entry.type}] ${content}${suffix}${marker}`);
      }
    }
    console.log('');
  }

  /**
   * 可视化完整树
   */
  visualizeFullTree(): void {
    const tree = this.treeBuilder.buildFullTree();
    if (!tree) {
      console.log('No tree to visualize');
      return;
    }

    console.log('\n=== Full Tree ===');
    this.renderNode(tree, '', true);
    console.log('');
  }

  private renderNode(node: TreeNode, prefix: string, isLast: boolean): void {
    const connector = isLast ? '└── ' : '├── ';
    const marker = node.entry.id === this.leafId ? ' ← current' : '';

    let label: string;
    if (node.entry.type === 'session') {
      label = `[Session]${marker}`;
    } else {
      const content = node.entry.content?.substring(0, 30) || '';
      const suffix = (node.entry.content?.length || 0) > 30 ? '...' : '';
      label = `[${node.entry.type}] ${content}${suffix}${marker}`;
    }

    console.log(prefix + connector + label);

    const childPrefix = prefix + (isLast ? '    ' : '│   ');
    const children = node.children;

    for (let i = 0; i < children.length; i++) {
      const isLastChild = i === children.length - 1;
      this.renderNode(children[i], childPrefix, isLastChild);
    }
  }

  /**
   * 关闭管理器
   */
  close(): void {
    this.jsonlManager.close();
  }
}
```

### 交互式导航器

```typescript
// interactive-navigator.ts
import * as readline from 'readline';
import { BranchManager } from './branch-manager';
import { NavigationOption } from './types';

export class InteractiveNavigator {
  private rl: readline.Interface;

  constructor(private manager: BranchManager) {
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });
  }

  /**
   * 启动交互式导航
   */
  async navigate(): Promise<void> {
    console.log('=== Interactive Branch Navigator ===');
    console.log('Commands: forward, back, branch, switch, tree, quit\n');

    while (true) {
      // 显示当前位置
      this.showCurrentPosition();

      // 显示可用选项
      const options = this.getNavigationOptions();
      this.showOptions(options);

      // 获取用户输入
      const command = await this.prompt('> ');

      if (command === 'quit' || command === 'q') {
        break;
      }

      // 执行命令
      try {
        await this.executeCommand(command, options);
      } catch (error) {
        console.error(`Error: ${(error as Error).message}`);
      }
    }

    this.rl.close();
  }

  /**
   * 显示当前位置
   */
  private showCurrentPosition(): void {
    const branch = this.manager.getCurrentBranch();
    const current = branch[branch.length - 1];

    console.log('\n--- Current Position ---');
    console.log(`ID: ${current.id}`);
    console.log(`Type: ${current.type}`);
    if (current.content) {
      console.log(`Content: ${current.content.substring(0, 50)}...`);
    }
    console.log(`Depth: ${branch.length}`);
  }

  /**
   * 获取导航选项
   */
  private getNavigationOptions(): NavigationOption[] {
    const options: NavigationOption[] = [];
    const leafId = this.manager.getLeafId();
    const children = this.manager.getChildren(leafId);
    const parent = this.manager.getParent(leafId);

    // 前进选项
    if (children.length > 0) {
      for (let i = 0; i < children.length; i++) {
        const child = children[i];
        options.push({
          type: 'forward',
          targetId: child.id,
          label: `forward ${i + 1}`,
          description: `${child.type}: ${child.content?.substring(0, 30) || child.id}`
        });
      }
    }

    // 后退选项
    if (parent) {
      options.push({
        type: 'backward',
        targetId: parent.id,
        label: 'back',
        description: `${parent.type}: ${parent.content?.substring(0, 30) || parent.id}`
      });
    }

    // 分支选项
    options.push({
      type: 'branch',
      targetId: leafId,
      label: 'branch',
      description: 'Create new branch from current position'
    });

    // 切换分支选项
    const branches = this.manager.getAllBranches();
    if (branches.length > 1) {
      for (let i = 0; i < branches.length; i++) {
        const branch = branches[i];
        if (branch.leafId !== leafId) {
          options.push({
            type: 'switch',
            targetId: branch.id,
            label: `switch ${i + 1}`,
            description: `Branch ${i + 1}: ${branch.lastMessage?.substring(0, 30) || branch.id}`
          });
        }
      }
    }

    return options;
  }

  /**
   * 显示选项
   */
  private showOptions(options: NavigationOption[]): void {
    console.log('\n--- Available Options ---');

    const grouped = new Map<string, NavigationOption[]>();
    for (const option of options) {
      if (!grouped.has(option.type)) {
        grouped.set(option.type, []);
      }
      grouped.get(option.type)!.push(option);
    }

    for (const [type, opts] of grouped) {
      console.log(`\n${type.toUpperCase()}:`);
      for (const opt of opts) {
        console.log(`  ${opt.label}: ${opt.description || ''}`);
      }
    }

    console.log('\nOTHER:');
    console.log('  tree: Show full tree');
    console.log('  quit: Exit navigator');
  }

  /**
   * 执行命令
   */
  private async executeCommand(
    command: string,
    options: NavigationOption[]
  ): Promise<void> {
    if (command === 'tree') {
      this.manager.visualizeFullTree();
      return;
    }

    const option = options.find(opt => opt.label === command);
    if (!option) {
      console.log(`Unknown command: ${command}`);
      return;
    }

    switch (option.type) {
      case 'forward':
      case 'backward':
        this.manager.branch(option.targetId);
        console.log(`✓ Moved to ${option.targetId}`);
        break;

      case 'branch':
        console.log('Creating new branch...');
        const content = await this.prompt('Enter message: ');
        this.manager.addMessage(content, 'user');
        console.log('✓ Branch created');
        break;

      case 'switch':
        this.manager.switchToBranch(option.targetId);
        break;
    }
  }

  /**
   * 提示用户输入
   */
  private prompt(question: string): Promise<string> {
    return new Promise(resolve => {
      this.rl.question(question, answer => {
        resolve(answer.trim());
      });
    });
  }
}
```

### 分支比较器

```typescript
// branch-comparator.ts
import { BranchManager } from './branch-manager';
import { SessionEntry } from './types';

export class BranchComparator {
  constructor(private manager: BranchManager) {}

  /**
   * 比较两个分支
   */
  compareBranches(branch1Id: string, branch2Id: string): void {
    const branch1 = this.manager.getBranch(branch1Id);
    const branch2 = this.manager.getBranch(branch2Id);

    console.log('\n=== Branch Comparison ===\n');

    // 找到分叉点
    const divergencePoint = this.findDivergencePoint(branch1, branch2);

    console.log(`Divergence point: ${divergencePoint?.id || 'root'}`);
    console.log(`\nBranch 1 (${branch1Id}):`);
    this.printBranchFromPoint(branch1, divergencePoint);

    console.log(`\nBranch 2 (${branch2Id}):`);
    this.printBranchFromPoint(branch2, divergencePoint);
  }

  /**
   * 找到分叉点
   */
  private findDivergencePoint(
    branch1: SessionEntry[],
    branch2: SessionEntry[]
  ): SessionEntry | null {
    let divergencePoint: SessionEntry | null = null;

    const minLength = Math.min(branch1.length, branch2.length);

    for (let i = 0; i < minLength; i++) {
      if (branch1[i].id === branch2[i].id) {
        divergencePoint = branch1[i];
      } else {
        break;
      }
    }

    return divergencePoint;
  }

  /**
   * 打印从分叉点开始的分支
   */
  private printBranchFromPoint(
    branch: SessionEntry[],
    divergencePoint: SessionEntry | null
  ): void {
    const startIndex = divergencePoint
      ? branch.findIndex(e => e.id === divergencePoint.id) + 1
      : 0;

    if (startIndex >= branch.length) {
      console.log('  (no changes)');
      return;
    }

    for (let i = startIndex; i < branch.length; i++) {
      const entry = branch[i];
      const content = entry.content?.substring(0, 50) || '';
      const suffix = (entry.content?.length || 0) > 50 ? '...' : '';
      console.log(`  ${i - startIndex + 1}. [${entry.type}] ${content}${suffix}`);
    }
  }

  /**
   * 获取分支差异统计
   */
  getBranchDiff(branch1Id: string, branch2Id: string): {
    commonLength: number;
    branch1UniqueCount: number;
    branch2UniqueCount: number;
  } {
    const branch1 = this.manager.getBranch(branch1Id);
    const branch2 = this.manager.getBranch(branch2Id);

    const divergencePoint = this.findDivergencePoint(branch1, branch2);
    const commonLength = divergencePoint
      ? branch1.findIndex(e => e.id === divergencePoint.id) + 1
      : 0;

    return {
      commonLength,
      branch1UniqueCount: branch1.length - commonLength,
      branch2UniqueCount: branch2.length - commonLength
    };
  }
}
```

---

## 使用示例

### 示例 1：基础分支操作

```typescript
import { BranchManager } from './branch-manager';

function basicBranchExample() {
  const manager = new BranchManager('session.jsonl');

  // 初始对话
  manager.addMessage('Hello', 'user');
  manager.addMessage('Hi there!', 'assistant');
  const msg2Id = manager.getLeafId();

  manager.addMessage('How are you?', 'user');
  manager.addMessage('I\'m good', 'assistant');

  // 可视化当前分支
  manager.visualizeCurrentBranch();

  // 创建分支：回到 msg2
  manager.branch(msg2Id);

  // 从分支点继续对话
  manager.addMessage('What\'s your name?', 'user');
  manager.addMessage('I\'m Claude', 'assistant');

  // 可视化完整树
  manager.visualizeFullTree();

  manager.close();
}

basicBranchExample();
```

**输出：**

```
=== Current Branch ===
└─ [Session]
  └─ [user] Hello
    └─ [assistant] Hi there!
      └─ [user] How are you?
        └─ [assistant] I'm good ← current

✓ Branched from a3f2c8d1

=== Full Tree ===
└── [Session]
    └── [user] Hello
        └── [assistant] Hi there!
            ├── [user] How are you?
            │   └── [assistant] I'm good
            └── [user] What's your name? ← current
                └── [assistant] I'm Claude
```

### 示例 2：分支信息查询

```typescript
function branchInfoExample() {
  const manager = new BranchManager('session.jsonl');

  // 获取所有分支
  const branches = manager.getAllBranches();

  console.log('=== All Branches ===');
  branches.forEach((branch, index) => {
    console.log(`\nBranch ${index + 1}:`);
    console.log(`  ID: ${branch.id}`);
    console.log(`  Depth: ${branch.depth}`);
    console.log(`  Messages: ${branch.messageCount}`);
    console.log(`  Last message: ${branch.lastMessage?.substring(0, 40)}...`);
    console.log(`  Created: ${new Date(branch.createdAt).toLocaleString()}`);
  });

  manager.close();
}

branchInfoExample();
```

### 示例 3：交互式导航

```typescript
import { InteractiveNavigator } from './interactive-navigator';

async function interactiveExample() {
  const manager = new BranchManager('session.jsonl');
  const navigator = new InteractiveNavigator(manager);

  await navigator.navigate();

  manager.close();
}

interactiveExample();
```

### 示例 4：分支比较

```typescript
import { BranchComparator } from './branch-comparator';

function compareExample() {
  const manager = new BranchManager('session.jsonl');
  const comparator = new BranchComparator(manager);

  const branches = manager.getAllBranches();

  if (branches.length >= 2) {
    // 比较前两个分支
    comparator.compareBranches(branches[0].id, branches[1].id);

    // 获取差异统计
    const diff = comparator.getBranchDiff(branches[0].id, branches[1].id);
    console.log('\n=== Diff Statistics ===');
    console.log(`Common length: ${diff.commonLength}`);
    console.log(`Branch 1 unique: ${diff.branch1UniqueCount}`);
    console.log(`Branch 2 unique: ${diff.branch2UniqueCount}`);
  }

  manager.close();
}

compareExample();
```

### 示例 5：分支切换

```typescript
function switchBranchExample() {
  const manager = new BranchManager('session.jsonl');

  // 获取所有分支
  const branches = manager.getAllBranches();

  console.log('Available branches:');
  branches.forEach((branch, index) => {
    console.log(`  ${index + 1}. ${branch.lastMessage?.substring(0, 40)}...`);
  });

  // 切换到第二个分支
  if (branches.length >= 2) {
    manager.switchToBranch(branches[1].id);
    console.log('\nSwitched to branch 2');

    // 显示当前分支
    manager.visualizeCurrentBranch();
  }

  manager.close();
}

switchBranchExample();
```

---

## 高级功能

### 功能 1：分支标签

```typescript
interface LabeledBranch extends BranchInfo {
  label?: string;
}

class LabeledBranchManager extends BranchManager {
  private branchLabels = new Map<string, string>();

  labelBranch(branchId: string, label: string): void {
    this.branchLabels.set(branchId, label);
  }

  getLabeledBranches(): LabeledBranch[] {
    const branches = this.getAllBranches();
    return branches.map(branch => ({
      ...branch,
      label: this.branchLabels.get(branch.id)
    }));
  }
}
```

### 功能 2：分支历史

```typescript
class BranchHistory {
  private history: string[] = [];
  private currentIndex: number = -1;

  push(branchId: string): void {
    // 删除当前位置之后的历史
    this.history = this.history.slice(0, this.currentIndex + 1);

    // 添加新的分支
    this.history.push(branchId);
    this.currentIndex++;
  }

  canGoBack(): boolean {
    return this.currentIndex > 0;
  }

  canGoForward(): boolean {
    return this.currentIndex < this.history.length - 1;
  }

  goBack(): string | null {
    if (!this.canGoBack()) {
      return null;
    }

    this.currentIndex--;
    return this.history[this.currentIndex];
  }

  goForward(): string | null {
    if (!this.canGoForward()) {
      return null;
    }

    this.currentIndex++;
    return this.history[this.currentIndex];
  }
}
```

### 功能 3：分支搜索

```typescript
class BranchSearcher {
  constructor(private manager: BranchManager) {}

  searchInBranch(branchId: string, query: string): SessionEntry[] {
    const branch = this.manager.getBranch(branchId);
    return branch.filter(entry =>
      entry.content?.toLowerCase().includes(query.toLowerCase())
    );
  }

  searchAllBranches(query: string): Map<string, SessionEntry[]> {
    const results = new Map<string, SessionEntry[]>();
    const branches = this.manager.getAllBranches();

    for (const branch of branches) {
      const matches = this.searchInBranch(branch.id, query);
      if (matches.length > 0) {
        results.set(branch.id, matches);
      }
    }

    return results;
  }
}
```

---

## 与 Pi-mono 的对比

### Pi-mono 的实现

```typescript
// Pi-mono session-manager.ts
class SessionManager {
  private leafId: string;

  branch(branchFromId: string): void {
    const entry = this.entryMap.get(branchFromId);
    if (!entry) {
      throw new Error(`Entry not found: ${branchFromId}`);
    }

    this.leafId = branchFromId;
    this.flush();
  }

  addMessage(content: string, type: string): string {
    const id = this.generateId();
    const entry = {
      type,
      id,
      parentId: this.leafId,
      timestamp: new Date().toISOString(),
      content
    };

    this.appendMessage(entry);
    this.leafId = id;

    return id;
  }
}
```

### 我们的实现

```typescript
// 更完整、更易用的实现
class BranchManager {
  // 分支信息查询
  getAllBranches(): BranchInfo[] { ... }

  // 分支切换
  switchToBranch(branchId: string): void { ... }

  // 可视化
  visualizeCurrentBranch(): void { ... }
  visualizeFullTree(): void { ... }
}

// 交互式导航
class InteractiveNavigator {
  async navigate(): Promise<void> { ... }
}

// 分支比较
class BranchComparator {
  compareBranches(id1, id2): void { ... }
}
```

---

## 关键要点总结

1. **Leaf Pointer**：跟踪当前活跃节点
2. **分支创建**：移动叶子指针，不修改数据
3. **分支切换**：在不同分支间自由切换
4. **交互式导航**：提供友好的用户界面
5. **分支比较**：对比不同分支的差异

---

**下一步**：实现 Session 上下文构建 → `07_实战代码_04_Session上下文构建.md`
