# 核心概念 01：npm 全局安装

> 深入理解 Pi Coding Agent 的 npm 全局安装机制、环境要求和从源码运行

---

## 概述

**核心定义：** npm 全局安装是将 Pi Coding Agent 安装到系统级目录，使其在任何目录都能通过 `pi` 命令访问。

**为什么重要：**
- ✅ 全局可用：无需在每个项目中单独安装
- ✅ 统一管理：所有项目使用同一个 Pi 版本
- ✅ 简化更新：一次更新，全局生效
- ✅ 标准做法：符合 Node.js CLI 工具的最佳实践

---

## 1. npm 全局安装详解

### 1.1 安装命令

```bash
# 基础安装
npm install -g @mariozechner/pi-coding-agent

# 指定版本安装
npm install -g @mariozechner/pi-coding-agent@0.52.12

# 从 npm 最新版本安装
npm install -g @mariozechner/pi-coding-agent@latest
```

**安装过程：**

```bash
# 1. npm 下载包
# 从 npm registry 下载 @mariozechner/pi-coding-agent

# 2. 解压到全局目录
# macOS/Linux: /usr/local/lib/node_modules/@mariozechner/pi-coding-agent
# Windows: %APPDATA%\npm\node_modules\@mariozechner\pi-coding-agent

# 3. 创建可执行链接
# macOS/Linux: /usr/local/bin/pi -> ../lib/node_modules/@mariozechner/pi-coding-agent/bin/pi.js
# Windows: %APPDATA%\npm\pi.cmd

# 4. 验证安装
pi --version
# 输出：0.52.12
```

### 1.2 全局安装目录

**查看全局安装目录：**

```bash
# 查看全局 node_modules 目录
npm root -g
# macOS/Linux 输出：/usr/local/lib/node_modules
# Windows 输出：C:\Users\<username>\AppData\Roaming\npm\node_modules

# 查看全局 bin 目录
npm bin -g
# macOS/Linux 输出：/usr/local/bin
# Windows 输出：C:\Users\<username>\AppData\Roaming\npm

# 查看 Pi 的安装位置
which pi  # macOS/Linux
where pi  # Windows
```

**目录结构：**

```
/usr/local/lib/node_modules/@mariozechner/pi-coding-agent/
├── bin/
│   └── pi.js                 # 可执行入口
├── dist/                     # 编译后的代码
│   ├── index.js
│   ├── cli.js
│   └── ...
├── node_modules/             # 依赖包
├── package.json              # 包信息
└── README.md
```

### 1.3 PATH 环境变量

**全局安装后，npm 会自动将 bin 目录添加到 PATH：**

```bash
# 查看 PATH
echo $PATH  # macOS/Linux
echo %PATH%  # Windows

# 应该包含 npm 的全局 bin 目录
# macOS/Linux: /usr/local/bin
# Windows: C:\Users\<username>\AppData\Roaming\npm
```

**如果 `pi` 命令找不到：**

```bash
# 手动添加到 PATH（macOS/Linux）
export PATH="$(npm bin -g):$PATH"

# 永久添加到 shell 配置
echo 'export PATH="$(npm bin -g):$PATH"' >> ~/.zshrc
source ~/.zshrc

# Windows：通过系统设置添加环境变量
# 控制面板 → 系统 → 高级系统设置 → 环境变量
# 在 Path 中添加：C:\Users\<username>\AppData\Roaming\npm
```

---

## 2. 环境要求

### 2.1 Node.js 版本要求

**最低要求：Node.js 18+**

```bash
# 检查 Node.js 版本
node --version
# 需要：v18.0.0 或更高

# 推荐版本
# - Node.js 20 LTS（长期支持）
# - Node.js 22（最新稳定版）
```

**为什么需要 Node.js 18+？**

```typescript
// Pi 使用了 Node.js 18+ 的新特性
// 1. Fetch API（Node.js 18+）
const response = await fetch('https://api.anthropic.com/v1/messages')

// 2. Test Runner（Node.js 18+）
import { test } from 'node:test'

// 3. Watch Mode（Node.js 18+）
node --watch src/index.ts

// 4. 性能改进
// - 更快的启动速度
// - 更低的内存占用
```

**如果 Node.js 版本过低：**

```bash
# 使用 nvm 安装新版本（推荐）
# 1. 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 2. 安装 Node.js 20
nvm install 20
nvm use 20
nvm alias default 20

# 3. 验证版本
node --version
# 输出：v20.x.x

# 4. 重新安装 Pi
npm install -g @mariozechner/pi-coding-agent
```

### 2.2 npm 版本要求

**npm 版本：** 通常随 Node.js 一起安装，无需单独配置

```bash
# 检查 npm 版本
npm --version
# Node.js 18: npm 8.x
# Node.js 20: npm 10.x

# 更新 npm（如果需要）
npm install -g npm@latest
```

### 2.3 操作系统支持

**支持的操作系统：**

| 操作系统 | 支持状态 | 备注 |
|---------|---------|------|
| **macOS** | ✅ 完全支持 | 推荐使用 Terminal.app 或 iTerm2 |
| **Linux** | ✅ 完全支持 | 推荐使用 bash 或 zsh |
| **Windows** | ✅ 支持（WSL 推荐） | 原生 PowerShell 支持有限 |
| **Termux (Android)** | ✅ 实验性支持 | 需要额外配置 |

**Windows 用户注意事项：**

```bash
# 推荐使用 WSL（Windows Subsystem for Linux）
# 1. 启用 WSL
wsl --install

# 2. 安装 Ubuntu
wsl --install -d Ubuntu

# 3. 在 WSL 中安装 Node.js 和 Pi
# 进入 WSL
wsl

# 安装 Node.js（使用 nvm）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 20

# 安装 Pi
npm install -g @mariozechner/pi-coding-agent

# 4. 运行 Pi
pi
```

**原生 Windows PowerShell 的限制：**
- 终端 UI 渲染可能有问题
- 某些快捷键不可用
- 推荐使用 WSL 或 Windows Terminal

---

## 3. 验证安装

### 3.1 基础验证

```bash
# 1. 检查版本
pi --version
# 输出：0.52.12

# 2. 检查帮助信息
pi --help
# 输出：Pi Coding Agent 的使用说明

# 3. 检查安装位置
which pi  # macOS/Linux
where pi  # Windows
# 输出：/usr/local/bin/pi

# 4. 检查包信息
npm list -g @mariozechner/pi-coding-agent
# 输出：
# /usr/local/lib/node_modules
# └── @mariozechner/pi-coding-agent@0.52.12
```

### 3.2 功能验证

```bash
# 1. 启动 Pi（不配置 Provider）
pi --no-session
# 应该能启动，但会提示需要配置 Provider

# 2. 列出可用的 Provider
pi --list-providers
# 输出：支持的 Provider 列表

# 3. 检查配置文件
ls -la ~/.pi/agent/
# 应该看到：
# - settings.json（如果存在）
# - auth.json（如果已配置）
# - sessions/（Session 存储目录）
```

### 3.3 故障排查

**问题 1：`pi: command not found`**

```bash
# 原因：PATH 环境变量未包含 npm 全局 bin 目录

# 解决方案 1：临时添加到 PATH
export PATH="$(npm bin -g):$PATH"
pi --version

# 解决方案 2：永久添加到 shell 配置
echo 'export PATH="$(npm bin -g):$PATH"' >> ~/.zshrc
source ~/.zshrc

# 解决方案 3：使用 npx 运行（不推荐）
npx @mariozechner/pi-coding-agent
```

**问题 2：权限错误（Permission denied）**

```bash
# 原因：没有权限写入全局目录

# 解决方案 1：使用 sudo（不推荐）
sudo npm install -g @mariozechner/pi-coding-agent

# 解决方案 2：修改 npm 全局目录（推荐）
# 1. 创建用户级全局目录
mkdir -p ~/.npm-global

# 2. 配置 npm 使用新目录
npm config set prefix '~/.npm-global'

# 3. 添加到 PATH
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.zshrc
source ~/.zshrc

# 4. 重新安装 Pi
npm install -g @mariozechner/pi-coding-agent
```

**问题 3：Node.js 版本过低**

```bash
# 错误信息：
# Error: Pi requires Node.js 18 or higher

# 解决方案：升级 Node.js
nvm install 20
nvm use 20
npm install -g @mariozechner/pi-coding-agent
```

---

## 4. 从源码运行（开发者）

### 4.1 克隆仓库

```bash
# 1. 克隆 pi-mono 仓库
git clone https://github.com/badlogic/pi-mono.git
cd pi-mono

# 2. 查看仓库结构
ls -la
# 输出：
# - packages/          # 所有包的源码
#   - ai/              # pi-ai 包（LLM API 抽象）
#   - agent-core/      # pi-agent-core 包（Agent 运行时）
#   - coding-agent/    # pi-coding-agent 包（CLI）
#   - tui/             # pi-tui 包（终端 UI）
#   - web-ui/          # pi-web-ui 包（Web UI）
# - examples/          # 示例代码
# - test.sh            # 测试脚本
# - pi-test.sh         # 从源码运行 Pi
```

### 4.2 安装依赖

```bash
# Pi 使用 npm workspaces 管理 monorepo
# 1. 安装所有依赖
npm install

# 这会安装所有包的依赖，包括：
# - packages/ai/node_modules
# - packages/agent-core/node_modules
# - packages/coding-agent/node_modules
# - packages/tui/node_modules
# - packages/web-ui/node_modules
```

### 4.3 构建项目

```bash
# 1. 构建所有包
npm run build

# 这会依次构建：
# - packages/ai
# - packages/agent-core
# - packages/tui
# - packages/coding-agent
# - packages/web-ui

# 2. 验证构建
ls packages/coding-agent/dist/
# 应该看到编译后的 JavaScript 文件
```

### 4.4 从源码运行

```bash
# 方式 1：使用 pi-test.sh 脚本（推荐）
./pi-test.sh

# 方式 2：直接运行
node packages/coding-agent/dist/cli.js

# 方式 3：使用 npm script
npm run pi -w packages/coding-agent
```

**pi-test.sh 脚本内容：**

```bash
#!/bin/bash
# pi-test.sh

# 设置环境变量
export NODE_ENV=development

# 运行 Pi
node packages/coding-agent/dist/cli.js "$@"
```

### 4.5 开发工作流

```bash
# 1. 监听文件变化，自动重新构建
npm run watch

# 2. 在另一个终端运行 Pi
./pi-test.sh

# 3. 修改代码后，Pi 会自动重新加载

# 4. 运行测试
./test.sh

# 5. 代码检查
npm run lint

# 6. 格式化代码
npm run format
```

---

## 5. 更新和卸载

### 5.1 更新 Pi

```bash
# 方式 1：更新到最新版本
npm update -g @mariozechner/pi-coding-agent

# 方式 2：重新安装（强制更新）
npm install -g @mariozechner/pi-coding-agent@latest

# 方式 3：更新到指定版本
npm install -g @mariozechner/pi-coding-agent@0.52.12

# 验证更新
pi --version
```

**检查可用的新版本：**

```bash
# 查看 npm 上的最新版本
npm view @mariozechner/pi-coding-agent version

# 查看所有可用版本
npm view @mariozechner/pi-coding-agent versions

# 查看包信息
npm info @mariozechner/pi-coding-agent
```

### 5.2 卸载 Pi

```bash
# 1. 卸载全局包
npm uninstall -g @mariozechner/pi-coding-agent

# 2. 验证卸载
pi --version
# 应该输出：command not found

# 3. 清理配置文件（可选）
rm -rf ~/.pi/agent/

# 4. 清理 npm 缓存（可选）
npm cache clean --force
```

---

## 6. 与 AI Agent 开发的关系

### 6.1 为什么选择 npm 全局安装？

**对比其他分发方式：**

| 分发方式 | 优点 | 缺点 | Pi 的选择 |
|---------|------|------|----------|
| **npm 全局安装** | 标准、简单、易更新 | 需要 Node.js 环境 | ✅ 选择 |
| **二进制分发** | 无需运行时 | 打包复杂、更新不便 | ❌ |
| **Docker 镜像** | 环境隔离 | 启动慢、体积大 | ❌ |
| **pip 安装（Python）** | Python 生态 | 跨语言集成复杂 | ❌ |

**Pi 选择 npm 的原因：**
1. **TypeScript 生态**：Pi 使用 TypeScript 开发，npm 是自然选择
2. **Extensions 支持**：Extensions 使用 TypeScript，npm 提供完整的模块系统
3. **跨平台**：Node.js 跨平台支持好
4. **开发者熟悉**：前端和 Node.js 开发者都熟悉 npm

### 6.2 全局安装对 AI Agent 开发的影响

**优势：**

```typescript
// 1. 全局可用，任何项目都能使用
// 项目 A
cd ~/projects/project-a
pi  // 使用全局安装的 Pi

// 项目 B
cd ~/projects/project-b
pi  // 使用同一个 Pi

// 2. 统一版本，避免版本冲突
// 所有项目使用同一个 Pi 版本
// 避免了"在我机器上能跑"的问题

// 3. 简化 CI/CD
// .github/workflows/ci.yml
- name: Install Pi
  run: npm install -g @mariozechner/pi-coding-agent

- name: Run Pi
  run: pi -p "Review this PR"
```

**项目级定制：**

```bash
# 虽然 Pi 全局安装，但每个项目可以有自己的配置
# 项目 A
.pi/settings.json  # 项目 A 的配置
.pi/AGENTS.md      # 项目 A 的上下文

# 项目 B
.pi/settings.json  # 项目 B 的配置
.pi/AGENTS.md      # 项目 B 的上下文

# 全局 Pi + 项目配置 = 灵活性
```

### 6.3 作为 SDK 使用

**Pi 不仅是 CLI，还可以作为 SDK：**

```typescript
// 在你的 Node.js 项目中使用 Pi
import { createAgent } from '@mariozechner/pi-agent-core'
import { createProvider } from '@mariozechner/pi-ai'

// 创建自定义 Agent
const agent = createAgent({
  provider: createProvider({
    type: 'anthropic',
    apiKey: process.env.ANTHROPIC_API_KEY
  }),
  model: 'claude-opus-4',
  tools: [
    // 自定义工具
  ],
  systemPrompt: '你是我的专属助手...'
})

// 运行 Agent
const response = await agent.run('帮我分析这段代码')
```

**实际案例：OpenClaw**

```typescript
// OpenClaw 使用 Pi SDK 构建自定义 Agent
// https://github.com/openclaw/openclaw

import { createAgent } from '@mariozechner/pi-agent-core'

const openclawAgent = createAgent({
  // OpenClaw 特定的配置
  tools: [
    searchTool,
    deployTool,
    databaseTool
  ],
  systemPrompt: openclawSystemPrompt
})
```

---

## 7. 最佳实践

### 7.1 版本管理

```bash
# 1. 锁定版本（生产环境）
npm install -g @mariozechner/pi-coding-agent@0.52.12

# 2. 使用最新版本（开发环境）
npm install -g @mariozechner/pi-coding-agent@latest

# 3. 在 package.json 中记录版本（团队协作）
{
  "devDependencies": {
    "@mariozechner/pi-coding-agent": "^0.52.12"
  }
}
```

### 7.2 多版本管理

```bash
# 使用 npx 运行特定版本（不安装）
npx @mariozechner/pi-coding-agent@0.52.12

# 使用 npm alias（高级）
npm install -g pi-stable@npm:@mariozechner/pi-coding-agent@0.52.12
npm install -g pi-latest@npm:@mariozechner/pi-coding-agent@latest

# 运行不同版本
pi-stable --version  # 0.52.12
pi-latest --version  # 最新版本
```

### 7.3 团队协作

```bash
# 1. 在项目 README 中记录 Pi 版本要求
# README.md
## 环境要求
- Node.js 20+
- Pi Coding Agent 0.52.12+

## 安装
npm install -g @mariozechner/pi-coding-agent@^0.52.12

# 2. 在 CI/CD 中固定版本
# .github/workflows/ci.yml
- name: Install Pi
  run: npm install -g @mariozechner/pi-coding-agent@0.52.12
```

---

## 8. 学习检查

完成本节后，你应该能够：

- [ ] 理解 npm 全局安装的原理和目录结构
- [ ] 检查和配置 PATH 环境变量
- [ ] 验证 Node.js 和 npm 版本要求
- [ ] 从源码构建和运行 Pi
- [ ] 更新和卸载 Pi
- [ ] 解决常见的安装问题
- [ ] 理解全局安装对 AI Agent 开发的影响
- [ ] 将 Pi 作为 SDK 使用

---

## 参考资源

- [Pi Coding Agent NPM](https://www.npmjs.com/package/@mariozechner/pi-coding-agent) - v0.52.12
- [Pi-mono GitHub](https://github.com/badlogic/pi-mono) - 官方仓库
- [Node.js 官网](https://nodejs.org/) - Node.js 下载和文档
- [npm 文档](https://docs.npmjs.com/) - npm 使用指南

---

**版本：** v1.0
**最后更新：** 2026-02-17
**维护者：** Claude Code
**基于：** Pi Coding Agent v0.52.12
