# 实战代码 3：类型检查集成

## 场景说明

将 mypy 和 pyright 集成到 LangChain 项目中，展示如何配置和使用类型检查器。

---

## 项目结构

```
project/
├── src/
│   ├── chains/
│   │   └── rag_chain.py
│   ├── utils/
│   │   └── helpers.py
│   └── main.py
├── tests/
│   └── test_chains.py
├── mypy.ini
├── pyrightconfig.json
├── pyproject.toml
└── .github/
    └── workflows/
        └── type-check.yml
```

---

## 配置文件

### 1. mypy 配置

```ini
# mypy.ini
[mypy]
python_version = 3.13
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_any_unimported = True
no_implicit_optional = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
warn_unreachable = True
strict_equality = True

# LangChain 相关配置
[mypy-langchain.*]
ignore_missing_imports = False

[mypy-langchain_core.*]
ignore_missing_imports = False

[mypy-langchain_openai.*]
ignore_missing_imports = False

# 第三方库
[mypy-chromadb.*]
ignore_missing_imports = True

[mypy-sentence_transformers.*]
ignore_missing_imports = True

[mypy-pypdf.*]
ignore_missing_imports = True
```

### 2. pyright 配置

```json
// pyrightconfig.json
{
  "pythonVersion": "3.13",
  "typeCheckingMode": "strict",
  "include": ["src"],
  "exclude": [
    "**/node_modules",
    "**/__pycache__",
    ".venv",
    "build",
    "dist"
  ],
  "reportMissingImports": true,
  "reportMissingTypeStubs": false,
  "reportUnusedImport": true,
  "reportUnusedClass": true,
  "reportUnusedFunction": true,
  "reportUnusedVariable": true,
  "reportDuplicateImport": true,
  "reportOptionalSubscript": true,
  "reportOptionalMemberAccess": true,
  "reportOptionalCall": true,
  "reportOptionalIterable": true,
  "reportOptionalContextManager": true,
  "reportOptionalOperand": true,
  "reportUntypedFunctionDecorator": true,
  "reportUntypedClassDecorator": true,
  "reportUntypedBaseClass": true,
  "reportUntypedNamedTuple": true,
  "reportPrivateUsage": true,
  "reportConstantRedefinition": true,
  "reportIncompatibleMethodOverride": true,
  "reportIncompatibleVariableOverride": true,
  "reportInconsistentConstructor": true,
  "reportOverlappingOverload": true,
  "reportMissingSuperCall": false,
  "reportUninitializedInstanceVariable": true,
  "reportInvalidStringEscapeSequence": true,
  "reportUnknownParameterType": true,
  "reportUnknownArgumentType": true,
  "reportUnknownLambdaType": true,
  "reportUnknownVariableType": true,
  "reportUnknownMemberType": true,
  "reportMissingParameterType": true,
  "reportMissingTypeArgument": true,
  "reportInvalidTypeVarUse": true,
  "reportCallInDefaultInitializer": true,
  "reportUnnecessaryIsInstance": true,
  "reportUnnecessaryCast": true,
  "reportUnnecessaryComparison": true,
  "reportAssertAlwaysTrue": true,
  "reportSelfClsParameterName": true,
  "reportImplicitStringConcatenation": false,
  "reportUndefinedVariable": true,
  "reportUnboundVariable": true,
  "reportInvalidStubStatement": true,
  "reportIncompleteStub": true,
  "reportUnsupportedDunderAll": true,
  "reportUnusedCoroutine": true
}
```

### 3. pyproject.toml 配置

```toml
# pyproject.toml
[tool.mypy]
python_version = "3.13"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[[tool.mypy.overrides]]
module = "chromadb.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "sentence_transformers.*"
ignore_missing_imports = true

[tool.pyright]
pythonVersion = "3.13"
typeCheckingMode = "strict"
include = ["src"]
exclude = ["**/node_modules", "**/__pycache__", ".venv"]
```

---

## 示例代码

### 1. 类型安全的 RAG 链

```python
# src/chains/rag_chain.py
"""
类型安全的 RAG 链
"""

from typing import Any
from langchain_core.runnables import Runnable, RunnableLambda, RunnableParallel
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_community.vectorstores import Chroma
from langchain_core.documents import Document
from pydantic import BaseModel

# ===== 类型定义 =====

class Query(BaseModel):
    """查询输入"""
    question: str
    top_k: int = 3

class RetrievalResult(BaseModel):
    """检索结果"""
    question: str
    documents: list[str]

class RAGOutput(BaseModel):
    """RAG 输出"""
    answer: str
    sources: list[str]

# ===== 组件定义 =====

def create_vectorstore() -> Chroma:
    """创建向量存储"""
    docs = [
        Document(page_content="Python is a programming language"),
        Document(page_content="LangChain is a framework for LLM applications"),
        Document(page_content="Type hints improve code quality"),
    ]
    return Chroma.from_documents(docs, OpenAIEmbeddings())

def retrieve_documents(query: Query) -> RetrievalResult:
    """检索文档"""
    vectorstore = create_vectorstore()
    docs = vectorstore.similarity_search(query.question, k=query.top_k)
    return RetrievalResult(
        question=query.question,
        documents=[doc.page_content for doc in docs]
    )

def format_context(result: RetrievalResult) -> dict[str, str]:
    """格式化上下文"""
    context = "\n".join(result.documents)
    return {
        "question": result.question,
        "context": context
    }

# ===== RAG 链 =====

def create_rag_chain() -> Runnable[Query, str]:
    """创建 RAG 链"""

    # 检索器
    retriever: Runnable[Query, RetrievalResult] = RunnableLambda(retrieve_documents)

    # 格式化器
    formatter: Runnable[RetrievalResult, dict[str, str]] = RunnableLambda(format_context)

    # Prompt
    prompt: Runnable[dict[str, str], Any] = ChatPromptTemplate.from_template(
        """Answer the question based on the context:

Context: {context}

Question: {question}

Answer:"""
    )

    # LLM
    model: Runnable[Any, Any] = ChatOpenAI(model="gpt-4o-mini")

    # Parser
    parser: Runnable[Any, str] = StrOutputParser()

    # 组合
    chain: Runnable[Query, str] = (
        retriever
        | formatter
        | prompt
        | model
        | parser
    )

    return chain

# ===== 使用示例 =====

if __name__ == "__main__":
    chain = create_rag_chain()

    query = Query(question="What is Python?", top_k=2)
    answer: str = chain.invoke(query)

    print(f"Question: {query.question}")
    print(f"Answer: {answer}")
```

### 2. 工具函数

```python
# src/utils/helpers.py
"""
类型安全的工具函数
"""

from typing import TypeVar, Callable
from langchain_core.runnables import Runnable, RunnableLambda

T = TypeVar('T')
U = TypeVar('U')

def create_runnable(fn: Callable[[T], U]) -> Runnable[T, U]:
    """创建 Runnable"""
    return RunnableLambda(fn)

def compose_runnables(
    first: Runnable[T, U],
    second: Runnable[U, V]
) -> Runnable[T, V]:
    """组合 Runnable"""
    return first | second

def map_runnable(
    runnable: Runnable[T, U],
    items: list[T]
) -> list[U]:
    """批量应用 Runnable"""
    return runnable.batch(items)
```

### 3. 测试代码

```python
# tests/test_chains.py
"""
类型安全的测试
"""

from src.chains.rag_chain import Query, create_rag_chain
from src.utils.helpers import create_runnable

def test_rag_chain() -> None:
    """测试 RAG 链"""
    chain = create_rag_chain()

    query = Query(question="What is Python?")
    answer: str = chain.invoke(query)

    assert isinstance(answer, str)
    assert len(answer) > 0

def test_create_runnable() -> None:
    """测试创建 Runnable"""
    runnable = create_runnable(lambda x: x.upper())

    result: str = runnable.invoke("hello")
    assert result == "HELLO"
```

---

## 类型检查脚本

### 1. 基础检查脚本

```bash
#!/bin/bash
# scripts/type-check.sh

echo "=== 类型检查 ==="

# 激活环境
source .venv/bin/activate

# 运行 mypy
echo "\n1. Running mypy..."
mypy src/ || exit 1

# 运行 pyright
echo "\n2. Running pyright..."
pyright src/ || exit 1

echo "\n✅ 类型检查通过！"
```

### 2. 详细检查脚本

```bash
#!/bin/bash
# scripts/type-check-detailed.sh

echo "=== 详细类型检查 ==="

# 激活环境
source .venv/bin/activate

# 1. mypy 检查
echo "\n1. mypy 检查..."
mypy src/ --show-error-codes --pretty || exit 1

# 2. pyright 检查
echo "\n2. pyright 检查..."
pyright src/ --outputjson > pyright-report.json
cat pyright-report.json | jq '.summary'

# 3. 生成报告
echo "\n3. 生成报告..."
mypy src/ --html-report mypy-report/
echo "mypy 报告: mypy-report/index.html"
echo "pyright 报告: pyright-report.json"

# 4. 统计
echo "\n4. 统计..."
echo "总文件数: $(find src -name '*.py' | wc -l)"
echo "类型覆盖率: $(mypy src/ --any-exprs-report mypy-report/)"

echo "\n✅ 详细检查完成！"
```

### 3. 增量检查脚本

```bash
#!/bin/bash
# scripts/type-check-incremental.sh

echo "=== 增量类型检查 ==="

# 获取修改的文件
CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR | grep '\.py$')

if [ -z "$CHANGED_FILES" ]; then
    echo "没有修改的 Python 文件"
    exit 0
fi

echo "检查修改的文件:"
echo "$CHANGED_FILES"

# 激活环境
source .venv/bin/activate

# 检查修改的文件
echo "\n运行 mypy..."
echo "$CHANGED_FILES" | xargs mypy || exit 1

echo "\n运行 pyright..."
echo "$CHANGED_FILES" | xargs pyright || exit 1

echo "\n✅ 增量检查通过！"
```

---

## CI/CD 集成

### 1. GitHub Actions

```yaml
# .github/workflows/type-check.yml
name: Type Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  type-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync

      - name: Run mypy
        run: uv run mypy src/

      - name: Run pyright
        run: uv run pyright src/

      - name: Generate reports
        if: always()
        run: |
          uv run mypy src/ --html-report mypy-report/
          uv run pyright src/ --outputjson > pyright-report.json

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-check-reports
          path: |
            mypy-report/
            pyright-report.json
```

### 2. pre-commit 集成

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.0
    hooks:
      - id: mypy
        additional_dependencies:
          - types-requests
          - pydantic
        args: [--config-file=mypy.ini]

  - repo: https://github.com/RobertCraigie/pyright-python
    rev: v1.1.400
    hooks:
      - id: pyright
```

---

## 常见问题和解决方案

### 1. 第三方库缺少类型注解

**问题**：
```
error: Skipping analyzing "chromadb": module is installed, but missing library stubs or py.typed marker
```

**解决方案**：

```bash
# 方案1：安装 type stubs
uv add --dev types-chromadb

# 方案2：配置忽略
# mypy.ini
[mypy-chromadb.*]
ignore_missing_imports = True
```

### 2. 动态代码类型检查

**问题**：
```python
def get_attr(obj, name):
    return getattr(obj, name)

# error: Missing type annotation for function
```

**解决方案**：

```python
from typing import Any

def get_attr(obj: Any, name: str) -> Any:
    return getattr(obj, name)
```

### 3. 循环导入

**问题**：
```python
# a.py
from b import B
class A:
    def get_b(self) -> B: ...

# b.py
from a import A
class B:
    def get_a(self) -> A: ...

# error: Cannot find implementation or library stub for module named "b"
```

**解决方案**：

```python
# a.py
from __future__ import annotations
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from b import B

class A:
    def get_b(self) -> B:
        ...
```

---

## 最佳实践

### 1. 渐进式采用

```ini
# 第一阶段：基础检查
[mypy]
python_version = 3.13
warn_return_any = True

# 第二阶段：禁止未类型化的定义
# disallow_untyped_defs = True

# 第三阶段：严格模式
# strict = True
```

### 2. 配置 IDE 集成

**VS Code**：
```json
// .vscode/settings.json
{
  "python.linting.mypyEnabled": true,
  "python.linting.pylintEnabled": false,
  "python.analysis.typeCheckingMode": "strict",
  "python.analysis.diagnosticMode": "workspace"
}
```

### 3. 使用 type stubs

```bash
# 安装常用库的 type stubs
uv add --dev types-requests
uv add --dev types-redis
uv add --dev types-pyyaml
```

### 4. 定期运行检查

```bash
# 添加到 Makefile
.PHONY: type-check
type-check:
	uv run mypy src/
	uv run pyright src/

# 使用
make type-check
```

---

## 学习检查清单

- [ ] 理解 mypy 和 pyright 的配置
- [ ] 能够集成类型检查到项目
- [ ] 掌握 CI/CD 集成
- [ ] 能够解决常见类型检查问题
- [ ] 理解渐进式类型检查策略
- [ ] 能够配置 IDE 集成
- [ ] 掌握最佳实践

---

## 下一步

- **面试必问** - 准备面试问题
- **化骨绵掌** - 巩固所有知识点
- **概览** - 查看完整学习路径

---

## 参考资源

1. [mypy 官方文档](https://mypy.readthedocs.io/)
2. [pyright 官方文档](https://github.com/microsoft/pyright)
3. [GitHub Actions 文档](https://docs.github.com/en/actions)
4. [pre-commit 文档](https://pre-commit.com/)
5. [LangChain 类型系统](https://reference.langchain.com/python/langchain_core/runnables)
