# 最小可用

掌握以下内容，就能在 RAG 项目中使用向量存储。

---

## 4.1 ChromaDB 快速上手（5分钟）

ChromaDB 是最简单的向量数据库，零配置即可使用。

### 安装

```bash
pip install chromadb
```

### 基本操作

```python
import chromadb

# 1. 创建客户端（内存模式）
client = chromadb.Client()

# 2. 创建集合（类似数据库的表）
collection = client.create_collection(name="my_docs")

# 3. 添加文档（自动生成 Embedding）
collection.add(
    ids=["doc1", "doc2", "doc3"],
    documents=[
        "Python 是一种编程语言",
        "机器学习是人工智能的分支",
        "RAG 结合了检索和生成"
    ],
    metadatas=[
        {"source": "wiki", "year": 2024},
        {"source": "textbook", "year": 2023},
        {"source": "blog", "year": 2024}
    ]
)

# 4. 查询
results = collection.query(
    query_texts=["什么是 RAG？"],
    n_results=2
)

print(results["documents"])
# [['RAG 结合了检索和生成', '机器学习是人工智能的分支']]
```

### 持久化存储

```python
# 持久化到磁盘
client = chromadb.PersistentClient(path="./chroma_db")

# 之后重启程序，数据仍然存在
collection = client.get_collection("my_docs")
```

---

## 4.2 Milvus 快速上手（10分钟）

Milvus 是生产级向量数据库，支持分布式和大规模数据。

### 安装（使用 Milvus Lite，无需 Docker）

```bash
pip install pymilvus
```

### 基本操作

```python
from pymilvus import MilvusClient

# 1. 创建客户端（本地文件模式）
client = MilvusClient("./milvus_demo.db")

# 2. 创建集合
client.create_collection(
    collection_name="my_docs",
    dimension=384  # 向量维度，需要与 Embedding 模型匹配
)

# 3. 准备数据（需要自己生成 Embedding）
from sentence_transformers import SentenceTransformer

model = SentenceTransformer('all-MiniLM-L6-v2')
texts = [
    "Python 是一种编程语言",
    "机器学习是人工智能的分支",
    "RAG 结合了检索和生成"
]
embeddings = model.encode(texts)

# 4. 插入数据
data = [
    {"id": i, "vector": embeddings[i].tolist(), "text": texts[i]}
    for i in range(len(texts))
]
client.insert(collection_name="my_docs", data=data)

# 5. 查询
query_embedding = model.encode(["什么是 RAG？"])
results = client.search(
    collection_name="my_docs",
    data=query_embedding.tolist(),
    limit=2,
    output_fields=["text"]
)

print(results)
```

---

## 4.3 核心 CRUD 操作

### 增（Add/Insert）

```python
# ChromaDB
collection.add(
    ids=["id1"],
    documents=["文本内容"],
    embeddings=[[0.1, 0.2, ...]],  # 可选，不传则自动生成
    metadatas=[{"key": "value"}]
)

# Milvus
client.insert(
    collection_name="my_docs",
    data=[{"id": 1, "vector": [0.1, 0.2, ...], "text": "内容"}]
)
```

### 查（Query/Search）

```python
# ChromaDB
results = collection.query(
    query_texts=["查询文本"],
    n_results=5,
    where={"year": {"$eq": 2024}}  # 元数据过滤
)

# Milvus
results = client.search(
    collection_name="my_docs",
    data=[query_vector],
    limit=5,
    filter='year == 2024'  # 元数据过滤
)
```

### 改（Update/Upsert）

```python
# ChromaDB
collection.update(
    ids=["id1"],
    documents=["更新后的内容"],
    metadatas=[{"key": "new_value"}]
)

# Milvus
client.upsert(
    collection_name="my_docs",
    data=[{"id": 1, "vector": [...], "text": "更新内容"}]
)
```

### 删（Delete）

```python
# ChromaDB
collection.delete(ids=["id1", "id2"])
collection.delete(where={"year": {"$lt": 2020}})  # 按条件删除

# Milvus
client.delete(collection_name="my_docs", ids=[1, 2])
client.delete(collection_name="my_docs", filter='year < 2020')
```

---

## 4.4 选择建议

| 场景 | 推荐 | 原因 |
|------|------|------|
| 学习/原型 | ChromaDB | 零配置，自动 Embedding |
| 小规模生产（<100万） | ChromaDB | 简单可靠 |
| 大规模生产（>100万） | Milvus | 分布式，高性能 |
| 需要云服务 | Milvus Cloud | 托管服务，免运维 |

---

## 这些知识足以：

- ✅ 在 RAG 项目中存储和检索文档向量
- ✅ 实现基本的语义搜索功能
- ✅ 使用元数据过滤优化检索结果
- ✅ 为后续学习检索器设计打下基础

---

**下一步：** [05_双重类比](./05_双重类比.md) - 用熟悉的概念理解向量存储
