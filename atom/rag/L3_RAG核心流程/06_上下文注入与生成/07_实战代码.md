# 实战代码

一个完整可运行的 RAG 上下文注入与生成示例。

---

## 完整示例：企业知识库问答系统

```python
"""
RAG 上下文注入与生成 - 完整实战示例
演示：从检索结果到生成答案的完整流程
"""

import os
from typing import List
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_community.vectorstores import Chroma
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough
from langchain_core.documents import Document

# ===== 1. 准备示例文档 =====
print("=" * 50)
print("1. 准备示例文档")
print("=" * 50)

# 模拟企业知识库文档
documents = [
    Document(
        page_content="员工入职满1年享有5天带薪年假，满3年享有10天，满5年享有15天。年假需在当年使用完毕，不可跨年累积。",
        metadata={"source": "员工手册.pdf", "page": 15, "category": "假期政策"}
    ),
    Document(
        page_content="请假申请需提前3个工作日通过OA系统提交，经直属领导审批后生效。紧急情况可先电话请假，事后补交申请。",
        metadata={"source": "请假制度.docx", "page": 3, "category": "假期政策"}
    ),
    Document(
        page_content="病假需提供二级以上医院的诊断证明。病假期间工资按基本工资的80%发放，连续病假超过30天需提供医院的病休证明。",
        metadata={"source": "员工手册.pdf", "page": 18, "category": "假期政策"}
    ),
    Document(
        page_content="公司实行弹性工作制，核心工作时间为10:00-16:00，员工可在7:00-10:00之间选择上班时间，工作满8小时即可。",
        metadata={"source": "考勤制度.pdf", "page": 5, "category": "考勤"}
    ),
    Document(
        page_content="报销流程：填写报销单→附上发票原件→部门经理审批→财务审核→打款。一般报销周期为5-7个工作日。",
        metadata={"source": "财务制度.pdf", "page": 22, "category": "财务"}
    ),
]

print(f"已准备 {len(documents)} 个文档")
for doc in documents:
    print(f"  - {doc.metadata['source']}: {doc.page_content[:30]}...")

# ===== 2. 创建向量存储和检索器 =====
print("\n" + "=" * 50)
print("2. 创建向量存储和检索器")
print("=" * 50)

# 初始化 Embedding 模型
embeddings = OpenAIEmbeddings(model="text-embedding-3-small")

# 创建向量存储（使用内存模式）
vectorstore = Chroma.from_documents(
    documents=documents,
    embedding=embeddings,
    collection_name="company_kb"
)

# 创建检索器
retriever = vectorstore.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 3}  # 返回最相关的3个文档
)

print("向量存储创建完成")
print(f"检索器配置: Top-K = 3")

# ===== 3. 定义 Prompt 模板 =====
print("\n" + "=" * 50)
print("3. 定义 Prompt 模板")
print("=" * 50)

RAG_PROMPT_TEMPLATE = """你是公司的智能HR助手，专门回答员工关于公司政策的问题。

【行为准则】
1. 只基于【参考资料】中的内容回答问题
2. 如果资料中没有相关信息，请如实告知"根据现有资料无法回答这个问题"
3. 回答时引用具体来源，格式：[来源：文档名称]
4. 保持回答简洁、准确、友好

【参考资料】
{context}

【员工问题】
{question}

【回答】"""

prompt = ChatPromptTemplate.from_template(RAG_PROMPT_TEMPLATE)
print("Prompt 模板定义完成")
print(f"模板变量: context, question")

# ===== 4. 定义上下文格式化函数 =====
print("\n" + "=" * 50)
print("4. 定义上下文格式化函数")
print("=" * 50)

def format_docs_with_metadata(docs: List[Document]) -> str:
    """
    将检索到的文档格式化为结构化的上下文字符串

    包含：
    - 文档编号
    - 来源信息
    - 文档内容
    """
    formatted_docs = []

    for i, doc in enumerate(docs, 1):
        source = doc.metadata.get("source", "未知来源")
        page = doc.metadata.get("page", "")
        category = doc.metadata.get("category", "")

        # 构建文档头
        header = f"【文档{i}】"
        header += f"来源：{source}"
        if page:
            header += f"，第{page}页"
        if category:
            header += f"，分类：{category}"

        # 组合文档
        formatted_docs.append(f"{header}\n{doc.page_content}")

    return "\n\n---\n\n".join(formatted_docs)

print("格式化函数定义完成")

# ===== 5. 创建 LLM 和 RAG 链 =====
print("\n" + "=" * 50)
print("5. 创建 LLM 和 RAG 链")
print("=" * 50)

# 初始化 LLM
llm = ChatOpenAI(
    model="gpt-3.5-turbo",
    temperature=0,  # 确定性输出，适合问答场景
    max_tokens=500
)

# 构建 RAG 链（使用 LCEL）
rag_chain = (
    {
        "context": retriever | format_docs_with_metadata,
        "question": RunnablePassthrough()
    }
    | prompt
    | llm
    | StrOutputParser()
)

print("RAG 链构建完成")
print("链结构: 检索 → 格式化 → Prompt → LLM → 解析")

# ===== 6. 测试问答 =====
print("\n" + "=" * 50)
print("6. 测试问答")
print("=" * 50)

# 测试问题列表
test_questions = [
    "公司的年假政策是什么？",
    "请假需要提前多久申请？",
    "公司有弹性工作制吗？",
    "公司的股票期权政策是什么？",  # 故意问一个资料中没有的问题
]

for question in test_questions:
    print(f"\n【问题】{question}")
    print("-" * 40)

    # 先看看检索到了什么
    retrieved_docs = retriever.invoke(question)
    print(f"检索到 {len(retrieved_docs)} 个相关文档:")
    for doc in retrieved_docs:
        print(f"  - {doc.metadata['source']}: {doc.page_content[:40]}...")

    # 生成答案
    answer = rag_chain.invoke(question)
    print(f"\n【答案】\n{answer}")
    print("=" * 50)

# ===== 7. 高级功能：流式输出 =====
print("\n" + "=" * 50)
print("7. 高级功能：流式输出")
print("=" * 50)

print("【问题】详细介绍一下病假政策")
print("-" * 40)
print("【流式答案】")

# 使用 stream 方法实现流式输出
for chunk in rag_chain.stream("详细介绍一下病假政策"):
    print(chunk, end="", flush=True)

print("\n")

# ===== 8. 高级功能：返回来源 =====
print("\n" + "=" * 50)
print("8. 高级功能：返回来源")
print("=" * 50)

from langchain_core.runnables import RunnableParallel

# 创建一个同时返回答案和来源的链
rag_chain_with_sources = RunnableParallel(
    {
        "answer": rag_chain,
        "sources": retriever | (lambda docs: [
            {"source": d.metadata["source"], "page": d.metadata.get("page")}
            for d in docs
        ])
    }
)

result = rag_chain_with_sources.invoke("年假可以跨年累积吗？")
print(f"【问题】年假可以跨年累积吗？")
print(f"\n【答案】\n{result['answer']}")
print(f"\n【参考来源】")
for src in result['sources']:
    print(f"  - {src['source']}, 第{src['page']}页")

print("\n" + "=" * 50)
print("示例运行完成！")
print("=" * 50)
```

---

## 运行输出示例

```
==================================================
1. 准备示例文档
==================================================
已准备 5 个文档
  - 员工手册.pdf: 员工入职满1年享有5天带薪年假，满3年享有10天...
  - 请假制度.docx: 请假申请需提前3个工作日通过OA系统提交...
  - 员工手册.pdf: 病假需提供二级以上医院的诊断证明...
  - 考勤制度.pdf: 公司实行弹性工作制，核心工作时间为10:00-16:00...
  - 财务制度.pdf: 报销流程：填写报销单→附上发票原件...

==================================================
6. 测试问答
==================================================

【问题】公司的年假政策是什么？
----------------------------------------
检索到 3 个相关文档:
  - 员工手册.pdf: 员工入职满1年享有5天带薪年假，满3年享有10天...
  - 请假制度.docx: 请假申请需提前3个工作日通过OA系统提交...
  - 员工手册.pdf: 病假需提供二级以上医院的诊断证明...

【答案】
根据公司政策，年假安排如下：

1. **年假天数**：
   - 入职满1年：5天带薪年假
   - 入职满3年：10天带薪年假
   - 入职满5年：15天带薪年假

2. **使用规则**：年假需在当年使用完毕，不可跨年累积。

[来源：员工手册.pdf，第15页]
==================================================

【问题】公司的股票期权政策是什么？
----------------------------------------
检索到 3 个相关文档:
  - 财务制度.pdf: 报销流程：填写报销单→附上发票原件...
  - 考勤制度.pdf: 公司实行弹性工作制，核心工作时间为10:00-16:00...
  - 员工手册.pdf: 员工入职满1年享有5天带薪年假...

【答案】
根据现有资料无法回答这个问题。参考资料中没有关于股票期权政策的相关信息，建议您咨询HR部门获取详细信息。
==================================================
```

---

## 代码要点总结

| 步骤 | 关键代码 | 说明 |
|------|----------|------|
| 创建检索器 | `vectorstore.as_retriever(search_kwargs={"k": 3})` | 返回 Top-3 |
| 格式化上下文 | `format_docs_with_metadata()` | 结构化 + 来源标注 |
| 构建 RAG 链 | `retriever \| format_docs \| prompt \| llm` | LCEL 链式调用 |
| 流式输出 | `rag_chain.stream(question)` | 实时返回 |
| 返回来源 | `RunnableParallel` | 同时返回答案和来源 |

---

## 运行前准备

```bash
# 安装依赖
pip install langchain langchain-openai chromadb tiktoken

# 设置环境变量
export OPENAI_API_KEY="your-api-key"
```

---

**下一步：** [08_面试必问](./08_面试必问.md) - 如何在面试中出彩回答
