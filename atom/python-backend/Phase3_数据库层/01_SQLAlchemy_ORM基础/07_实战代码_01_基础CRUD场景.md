# 实战代码场景1：基础 CRUD 场景

完整可运行的用户管理系统，演示 SQLAlchemy ORM 的基础 CRUD 操作。

---

## 场景说明

**目标：** 实现一个简单的用户管理系统，包含完整的 CRUD 操作。

**功能：**
- 创建用户
- 查询用户（单个、列表、分页）
- 更新用户信息
- 删除用户（软删除）

**技术栈：**
- SQLAlchemy 2.0+
- PostgreSQL
- Python 3.13+

---

## 完整代码

```python
"""
SQLAlchemy ORM 基础 CRUD 示例
演示：用户管理系统的增删改查操作
"""

from sqlalchemy import create_engine, Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import declarative_base, sessionmaker, Session
from datetime import datetime
from typing import List, Optional

# ===== 1. 数据库配置 =====

DATABASE_URL = "postgresql://user:password@localhost:5432/testdb"

# 创建引擎
engine = create_engine(
    DATABASE_URL,
    echo=True,  # 打印 SQL 语句（开发环境）
    pool_size=5,
    max_overflow=10
)

# 创建 Session 工厂
SessionLocal = sessionmaker(bind=engine, expire_on_commit=False)

# 创建基类
Base = declarative_base()


# ===== 2. 定义模型 =====

class User(Base):
    """用户模型"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, autoincrement=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    full_name = Column(String(100))
    is_active = Column(Boolean, default=True, index=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    deleted_at = Column(DateTime, nullable=True)  # 软删除标记

    def __repr__(self):
        return f"<User(id={self.id}, username={self.username}, email={self.email})>"


# ===== 3. 创建表 =====

def init_db():
    """初始化数据库（创建所有表）"""
    Base.metadata.create_all(engine)
    print("✅ 数据库表创建成功")


# ===== 4. CRUD 操作函数 =====

def create_user(
    db: Session,
    username: str,
    email: str,
    full_name: Optional[str] = None
) -> User:
    """创建用户"""
    user = User(
        username=username,
        email=email,
        full_name=full_name
    )
    db.add(user)
    db.commit()
    db.refresh(user)  # 刷新对象，获取数据库生成的 ID
    print(f"✅ 创建用户成功: {user}")
    return user


def get_user_by_id(db: Session, user_id: int) -> Optional[User]:
    """根据 ID 查询用户"""
    user = db.query(User)\
        .filter(User.id == user_id)\
        .filter(User.deleted_at == None)\
        .first()
    return user


def get_user_by_username(db: Session, username: str) -> Optional[User]:
    """根据用户名查询用户"""
    user = db.query(User)\
        .filter(User.username == username)\
        .filter(User.deleted_at == None)\
        .first()
    return user


def get_user_by_email(db: Session, email: str) -> Optional[User]:
    """根据邮箱查询用户"""
    user = db.query(User)\
        .filter(User.email == email)\
        .filter(User.deleted_at == None)\
        .first()
    return user


def get_users(
    db: Session,
    skip: int = 0,
    limit: int = 10,
    is_active: Optional[bool] = None
) -> List[User]:
    """查询用户列表（分页）"""
    query = db.query(User).filter(User.deleted_at == None)

    # 可选筛选：是否激活
    if is_active is not None:
        query = query.filter(User.is_active == is_active)

    users = query\
        .order_by(User.created_at.desc())\
        .offset(skip)\
        .limit(limit)\
        .all()

    return users


def count_users(db: Session, is_active: Optional[bool] = None) -> int:
    """统计用户数量"""
    query = db.query(User).filter(User.deleted_at == None)

    if is_active is not None:
        query = query.filter(User.is_active == is_active)

    return query.count()


def update_user(
    db: Session,
    user_id: int,
    username: Optional[str] = None,
    email: Optional[str] = None,
    full_name: Optional[str] = None,
    is_active: Optional[bool] = None
) -> Optional[User]:
    """更新用户信息"""
    user = get_user_by_id(db, user_id)

    if not user:
        print(f"❌ 用户不存在: id={user_id}")
        return None

    # 更新字段
    if username is not None:
        user.username = username
    if email is not None:
        user.email = email
    if full_name is not None:
        user.full_name = full_name
    if is_active is not None:
        user.is_active = is_active

    db.commit()
    db.refresh(user)
    print(f"✅ 更新用户成功: {user}")
    return user


def delete_user(db: Session, user_id: int, soft: bool = True) -> bool:
    """删除用户（默认软删除）"""
    user = get_user_by_id(db, user_id)

    if not user:
        print(f"❌ 用户不存在: id={user_id}")
        return False

    if soft:
        # 软删除：标记删除时间
        user.deleted_at = datetime.utcnow()
        db.commit()
        print(f"✅ 软删除用户成功: {user}")
    else:
        # 硬删除：从数据库中删除
        db.delete(user)
        db.commit()
        print(f"✅ 硬删除用户成功: id={user_id}")

    return True


def restore_user(db: Session, user_id: int) -> Optional[User]:
    """恢复已删除的用户"""
    user = db.query(User)\
        .filter(User.id == user_id)\
        .filter(User.deleted_at != None)\
        .first()

    if not user:
        print(f"❌ 用户不存在或未被删除: id={user_id}")
        return None

    user.deleted_at = None
    db.commit()
    db.refresh(user)
    print(f"✅ 恢复用户成功: {user}")
    return user


# ===== 5. 批量操作 =====

def create_users_batch(db: Session, users_data: List[dict]) -> List[User]:
    """批量创建用户"""
    users = [User(**data) for data in users_data]
    db.add_all(users)
    db.commit()

    # 刷新所有对象
    for user in users:
        db.refresh(user)

    print(f"✅ 批量创建用户成功: {len(users)} 个")
    return users


def deactivate_users_batch(db: Session, user_ids: List[int]) -> int:
    """批量停用用户"""
    count = db.query(User)\
        .filter(User.id.in_(user_ids))\
        .filter(User.deleted_at == None)\
        .update({"is_active": False}, synchronize_session=False)

    db.commit()
    print(f"✅ 批量停用用户成功: {count} 个")
    return count


# ===== 6. 搜索功能 =====

def search_users(db: Session, keyword: str, limit: int = 10) -> List[User]:
    """搜索用户（用户名或邮箱）"""
    users = db.query(User)\
        .filter(User.deleted_at == None)\
        .filter(
            (User.username.like(f"%{keyword}%")) |
            (User.email.like(f"%{keyword}%")) |
            (User.full_name.like(f"%{keyword}%"))
        )\
        .limit(limit)\
        .all()

    print(f"✅ 搜索到 {len(users)} 个用户")
    return users


# ===== 7. 演示函数 =====

def demo_basic_crud():
    """演示基础 CRUD 操作"""
    print("\n" + "="*50)
    print("演示：基础 CRUD 操作")
    print("="*50 + "\n")

    with SessionLocal() as db:
        # 1. 创建用户
        print("--- 1. 创建用户 ---")
        user1 = create_user(db, "alice", "alice@example.com", "Alice Smith")
        user2 = create_user(db, "bob", "bob@example.com", "Bob Johnson")
        user3 = create_user(db, "charlie", "charlie@example.com", "Charlie Brown")

        # 2. 查询单个用户
        print("\n--- 2. 查询单个用户 ---")
        user = get_user_by_id(db, user1.id)
        print(f"按 ID 查询: {user}")

        user = get_user_by_username(db, "bob")
        print(f"按用户名查询: {user}")

        user = get_user_by_email(db, "charlie@example.com")
        print(f"按邮箱查询: {user}")

        # 3. 查询用户列表
        print("\n--- 3. 查询用户列表 ---")
        users = get_users(db, skip=0, limit=10)
        print(f"所有用户 ({len(users)} 个):")
        for user in users:
            print(f"  - {user}")

        # 4. 统计用户数量
        print("\n--- 4. 统计用户数量 ---")
        total = count_users(db)
        active = count_users(db, is_active=True)
        print(f"总用户数: {total}")
        print(f"激活用户数: {active}")

        # 5. 更新用户
        print("\n--- 5. 更新用户 ---")
        update_user(db, user1.id, full_name="Alice Johnson", is_active=False)

        # 6. 软删除用户
        print("\n--- 6. 软删除用户 ---")
        delete_user(db, user2.id, soft=True)

        # 7. 查询用户列表（验证删除）
        print("\n--- 7. 查询用户列表（验证删除） ---")
        users = get_users(db)
        print(f"剩余用户 ({len(users)} 个):")
        for user in users:
            print(f"  - {user}")

        # 8. 恢复用户
        print("\n--- 8. 恢复用户 ---")
        restore_user(db, user2.id)

        # 9. 查询用户列表（验证恢复）
        print("\n--- 9. 查询用户列表（验证恢复） ---")
        users = get_users(db)
        print(f"所有用户 ({len(users)} 个):")
        for user in users:
            print(f"  - {user}")


def demo_batch_operations():
    """演示批量操作"""
    print("\n" + "="*50)
    print("演示：批量操作")
    print("="*50 + "\n")

    with SessionLocal() as db:
        # 1. 批量创建用户
        print("--- 1. 批量创建用户 ---")
        users_data = [
            {"username": f"user{i}", "email": f"user{i}@example.com", "full_name": f"User {i}"}
            for i in range(1, 6)
        ]
        users = create_users_batch(db, users_data)

        # 2. 批量停用用户
        print("\n--- 2. 批量停用用户 ---")
        user_ids = [user.id for user in users[:3]]
        deactivate_users_batch(db, user_ids)

        # 3. 查询激活用户
        print("\n--- 3. 查询激活用户 ---")
        active_users = get_users(db, is_active=True)
        print(f"激活用户 ({len(active_users)} 个):")
        for user in active_users:
            print(f"  - {user}")


def demo_search():
    """演示搜索功能"""
    print("\n" + "="*50)
    print("演示：搜索功能")
    print("="*50 + "\n")

    with SessionLocal() as db:
        # 搜索用户
        print("--- 搜索用户 ---")
        results = search_users(db, "alice")
        print(f"搜索 'alice' 的结果 ({len(results)} 个):")
        for user in results:
            print(f"  - {user}")

        results = search_users(db, "example.com")
        print(f"\n搜索 'example.com' 的结果 ({len(results)} 个):")
        for user in results:
            print(f"  - {user}")


# ===== 8. 主函数 =====

def main():
    """主函数"""
    # 初始化数据库
    init_db()

    # 演示基础 CRUD
    demo_basic_crud()

    # 演示批量操作
    demo_batch_operations()

    # 演示搜索功能
    demo_search()

    print("\n" + "="*50)
    print("✅ 所有演示完成")
    print("="*50)


if __name__ == "__main__":
    main()
```

---

## 运行输出示例

```
✅ 数据库表创建成功

==================================================
演示：基础 CRUD 操作
==================================================

--- 1. 创建用户 ---
✅ 创建用户成功: <User(id=1, username=alice, email=alice@example.com)>
✅ 创建用户成功: <User(id=2, username=bob, email=bob@example.com)>
✅ 创建用户成功: <User(id=3, username=charlie, email=charlie@example.com)>

--- 2. 查询单个用户 ---
按 ID 查询: <User(id=1, username=alice, email=alice@example.com)>
按用户名查询: <User(id=2, username=bob, email=bob@example.com)>
按邮箱查询: <User(id=3, username=charlie, email=charlie@example.com)>

--- 3. 查询用户列表 ---
所有用户 (3 个):
  - <User(id=3, username=charlie, email=charlie@example.com)>
  - <User(id=2, username=bob, email=bob@example.com)>
  - <User(id=1, username=alice, email=alice@example.com)>

--- 4. 统计用户数量 ---
总用户数: 3
激活用户数: 3

--- 5. 更新用户 ---
✅ 更新用户成功: <User(id=1, username=alice, email=alice@example.com)>

--- 6. 软删除用户 ---
✅ 软删除用户成功: <User(id=2, username=bob, email=bob@example.com)>

--- 7. 查询用户列表（验证删除） ---
剩余用户 (2 个):
  - <User(id=3, username=charlie, email=charlie@example.com)>
  - <User(id=1, username=alice, email=alice@example.com)>

--- 8. 恢复用户 ---
✅ 恢复用户成功: <User(id=2, username=bob, email=bob@example.com)>

--- 9. 查询用户列表（验证恢复） ---
所有用户 (3 个):
  - <User(id=3, username=charlie, email=charlie@example.com)>
  - <User(id=2, username=bob, email=bob@example.com)>
  - <User(id=1, username=alice, email=alice@example.com)>

==================================================
演示：批量操作
==================================================

--- 1. 批量创建用户 ---
✅ 批量创建用户成功: 5 个

--- 2. 批量停用用户 ---
✅ 批量停用用户成功: 3 个

--- 3. 查询激活用户 ---
激活用户 (5 个):
  - <User(id=8, username=user5, email=user5@example.com)>
  - <User(id=7, username=user4, email=user4@example.com)>
  - <User(id=3, username=charlie, email=charlie@example.com)>
  - <User(id=2, username=bob, email=bob@example.com)>
  - <User(id=1, username=alice, email=alice@example.com)>

==================================================
演示：搜索功能
==================================================

--- 搜索用户 ---
搜索 'alice' 的结果 (1 个):
  - <User(id=1, username=alice, email=alice@example.com)>

搜索 'example.com' 的结果 (8 个):
  - <User(id=1, username=alice, email=alice@example.com)>
  - <User(id=2, username=bob, email=bob@example.com)>
  - <User(id=3, username=charlie, email=charlie@example.com)>
  ...

==================================================
✅ 所有演示完成
==================================================
```

---

## 代码说明

### 1. 数据库配置

```python
# 创建引擎
engine = create_engine(
    DATABASE_URL,
    echo=True,  # 开发环境打印 SQL
    pool_size=5,
    max_overflow=10
)

# 创建 Session 工厂
SessionLocal = sessionmaker(bind=engine, expire_on_commit=False)
```

### 2. 模型定义

```python
class User(Base):
    __tablename__ = "users"

    # 主键
    id = Column(Integer, primary_key=True, autoincrement=True)

    # 唯一字段 + 索引
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)

    # 可选字段
    full_name = Column(String(100))

    # 状态字段 + 索引
    is_active = Column(Boolean, default=True, index=True)

    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 软删除标记
    deleted_at = Column(DateTime, nullable=True)
```

### 3. CRUD 操作

**Create（创建）：**
```python
user = User(username="alice", email="alice@example.com")
db.add(user)
db.commit()
db.refresh(user)  # 获取数据库生成的 ID
```

**Read（查询）：**
```python
# 单个查询
user = db.query(User).filter(User.id == 1).first()

# 列表查询 + 分页
users = db.query(User)\
    .order_by(User.created_at.desc())\
    .offset(skip)\
    .limit(limit)\
    .all()
```

**Update（更新）：**
```python
user = db.query(User).filter(User.id == 1).first()
user.username = "new_name"
db.commit()
```

**Delete（删除）：**
```python
# 软删除
user.deleted_at = datetime.utcnow()
db.commit()

# 硬删除
db.delete(user)
db.commit()
```

### 4. 批量操作

```python
# 批量创建
users = [User(**data) for data in users_data]
db.add_all(users)
db.commit()

# 批量更新
db.query(User)\
    .filter(User.id.in_(user_ids))\
    .update({"is_active": False}, synchronize_session=False)
db.commit()
```

### 5. 搜索功能

```python
users = db.query(User)\
    .filter(
        (User.username.like(f"%{keyword}%")) |
        (User.email.like(f"%{keyword}%"))
    )\
    .all()
```

---

## 最佳实践

1. **使用上下文管理器**：`with SessionLocal() as db:`
2. **软删除**：添加 `deleted_at` 字段，不直接删除数据
3. **添加索引**：为常用查询字段添加索引
4. **时间戳**：添加 `created_at` 和 `updated_at`
5. **批量操作**：使用 `add_all()` 和 `update()` 提升性能
6. **错误处理**：检查对象是否存在，返回 `None` 或抛出异常

---

## 扩展练习

1. 添加分页辅助函数（返回总数和数据）
2. 添加更多筛选条件（按创建时间、按状态）
3. 实现用户角色管理（添加 `role` 字段）
4. 添加事务回滚示例
5. 实现用户导出功能（导出为 CSV）

---

**记住：** 这是 SQLAlchemy ORM 的基础 CRUD 操作，掌握这些就能开始实际开发。
