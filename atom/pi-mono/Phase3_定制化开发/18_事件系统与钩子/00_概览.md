# 事件系统与钩子 - 知识点概览

> **编号：18** | **Phase 3: 定制化开发** | **学习时长：1.5小时**

---

## 知识点定位

**事件系统与钩子**是 pi-mono 定制化开发的最后一个核心知识点，也是实现流程控制和行为定制的关键机制。

### 在学习路径中的位置

```
Phase 3: 定制化开发
├── 13. Prompt Templates 模板系统 ✅
├── 14. Skills 技能包开发 ✅
├── 15. Extensions 扩展开发基础 ✅
├── 16. 自定义工具注册 ✅
├── 17. UI 组件定制 ✅
└── 18. 事件系统与钩子 ← 当前
```

### 为什么学习这个知识点？

在前面的学习中，你已经掌握了：
- **Prompt Templates**：提示词复用
- **Skills**：功能封装
- **Extensions**：扩展开发
- **自定义工具**：工具注册
- **UI 组件**：界面定制

但是，如何在 Agent 运行的关键时刻插入自定义逻辑？如何在扩展之间进行通信？如何监控 Agent 的运行状态？

**事件系统与钩子**就是答案。

---

## 核心内容

### 30字核心

**事件系统与钩子是 pi-mono 基于 EventEmitter 的事件驱动机制，是 AI Agent 实现流程控制和行为定制的核心基础。**

### 4个核心概念

1. **事件监听（pi.on）**
   - 监听 Agent 运行时的各种事件
   - 在关键时刻插入自定义逻辑
   - 实现流程控制和状态监控

2. **生命周期钩子（40+ 钩子）**
   - Session Events（会话生命周期）
   - Agent Events（Agent 运行周期）
   - Message Events（消息处理周期）
   - Tool Events（工具调用周期）
   - Model Events（模型选择）
   - User Events（用户交互）
   - Resource Events（资源发现）

3. **自定义事件（pi.events）**
   - 扩展间通信机制
   - emit() 发送事件
   - on() 监听事件
   - 实现松耦合的扩展协作

4. **Spawn Hooks**
   - 拦截 bash 命令执行
   - 修改 command、cwd、env
   - 实现命令预处理和环境注入

---

## 学习路径

本知识点按照以下 10 个维度组织：

### 基础理解
1. **30字核心** - 一句话理解事件系统与钩子
2. **第一性原理** - 从根本理解为什么需要事件驱动
3. **核心概念** - 4个核心概念详细讲解（拆分为4个文件）
4. **最小可用** - 20%核心知识解决80%问题

### 深入理解
5. **双重类比** - TypeScript/Node.js + 日常生活类比
6. **反直觉点** - 3个常见误区

### 实战应用
7. **实战代码** - 4个完整可运行示例（拆分为4个文件）
8. **面试必问** - 高频面试问题与出彩回答

### 进阶掌握
9. **化骨绵掌** - 10个2分钟知识卡片
10. **一句话总结** - 整体总结

---

## 学习目标

完成本知识点学习后，你应该能够：

### 理解层面
- [ ] 理解事件驱动架构的核心价值
- [ ] 理解 pi-mono 的双层事件总线设计
- [ ] 理解 40+ 生命周期钩子的触发时机
- [ ] 理解 Spawn Hooks 的工作原理

### 应用层面
- [ ] 使用 pi.on() 监听生命周期事件
- [ ] 在关键时刻插入自定义逻辑
- [ ] 使用 pi.events 实现扩展间通信
- [ ] 实现 Spawn Hooks 拦截命令执行
- [ ] 调试事件流和钩子执行

### 实战层面
- [ ] 实现 session_start 监听和初始化
- [ ] 实现 before_agent_start 注入消息
- [ ] 实现 tool_call 拦截和日志记录
- [ ] 实现扩展间事件通信
- [ ] 实现 bash spawn hook 环境注入

---

## 与其他知识点的关系

### 前置知识
- **15. Extensions 扩展开发基础** - 事件系统是 Extension API 的核心部分
- **16. 自定义工具注册** - 工具调用会触发 tool_call 事件

### 后续应用
- **Phase 4: 高级扩展** - 使用事件系统实现高级功能
- **Phase 5: 实战项目** - 在实战项目中使用事件系统

### 协同知识
- **8. Agent Core 运行时机制** - 理解 Agent 运行流程，才能理解钩子触发时机
- **11. Session 存储与树形结构** - Session 事件与 Session 管理紧密相关

---

## 学习建议

### 学习顺序
1. **先理解概念**：阅读 30字核心、第一性原理、核心概念
2. **再看代码**：阅读实战代码，理解实际应用
3. **动手实践**：在自己的 Extension 中使用事件系统
4. **深入理解**：阅读化骨绵掌，全面掌握

### 学习重点
- **生命周期钩子**：40+ 钩子的触发时机和参数
- **双层事件总线**：pi.on 和 pi.events 的区别
- **Spawn Hooks**：命令拦截和环境注入

### 实践建议
1. 从简单的事件监听开始（session_start）
2. 逐步尝试更复杂的钩子（before_agent_start）
3. 实现扩展间通信（pi.events）
4. 最后尝试 Spawn Hooks

---

## 快速参考

### 事件监听基础
```typescript
// 监听 session 启动事件
pi.on('session_start', (session) => {
  console.log('Session started:', session.id);
});

// 监听工具调用
pi.on('tool_call', (tool, args) => {
  console.log('Tool called:', tool.name);
});
```

### 生命周期钩子
```typescript
// 在 Agent 启动前注入消息
pi.on('before_agent_start', (messages) => {
  messages.push({
    role: 'system',
    content: 'Custom instruction'
  });
});
```

### 自定义事件
```typescript
// 发送自定义事件
pi.events.emit('my-event', { data: 'value' });

// 监听自定义事件
pi.events.on('my-event', (payload) => {
  console.log('Received:', payload);
});
```

### Spawn Hooks
```typescript
// 拦截 bash 命令
pi.registerSpawnHook((command, cwd, env) => {
  // 修改环境变量
  env.MY_VAR = 'value';
  return { command, cwd, env };
});
```

---

## 文档结构

本知识点包含以下文件：

### 基础维度
- `01_30字核心.md` - 一句话定义
- `02_第一性原理.md` - 从根本理解事件驱动
- `10_一句话总结.md` - 整体总结

### 核心概念（详细讲解）
- `03_核心概念_01_事件监听.md` - pi.on() 事件监听机制
- `03_核心概念_02_生命周期钩子.md` - 40+ 生命周期钩子详解
- `03_核心概念_03_自定义事件.md` - pi.events 扩展间通信
- `03_核心概念_04_Spawn_Hooks.md` - Spawn Hooks 实现

### 其他维度
- `04_最小可用.md` - 20%核心知识
- `05_双重类比.md` - TypeScript + 日常生活类比
- `06_反直觉点.md` - 3个常见误区

### 实战代码（完整示例）
- `07_实战代码_01_基础事件监听.md` - 基础事件监听示例
- `07_实战代码_02_生命周期钩子应用.md` - 生命周期钩子实战
- `07_实战代码_03_自定义事件通信.md` - 扩展间通信示例
- `07_实战代码_04_Spawn_Hooks实现.md` - Spawn Hooks 完整示例

### 进阶内容
- `08_面试必问.md` - 面试问题与答案
- `09_化骨绵掌.md` - 10个知识卡片

---

## 预计学习时长

- **快速浏览**：30分钟（30字核心 + 核心概念 + 实战代码）
- **深入学习**：1.5小时（完整阅读所有维度）
- **实践掌握**：3小时（动手实现示例）

---

## 下一步

完成本知识点学习后，你将完成 **Phase 3: 定制化开发** 的所有内容。

接下来可以：
- **Phase 4: 高级扩展** - 实现自定义 Provider、MCP 集成、Sub-Agents
- **Phase 5: 实战项目** - 基于 pi-mono 构建实际应用
- **回顾 Phase 3** - 巩固定制化开发的所有知识点

---

**版本：** v1.0
**最后更新：** 2026-02-21
**维护者：** Claude Code
