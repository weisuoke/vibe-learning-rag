# 实战代码

完整的进阶 Prompt 技巧代码示例，可直接运行。

---

## 示例1：Few-shot RAG 问答系统

```python
"""
Few-shot RAG 问答系统
演示：通过示例统一 RAG 回答风格
"""

from openai import OpenAI

client = OpenAI()

# ===== 1. 定义 Few-shot 示例 =====
FEW_SHOT_EXAMPLES = [
    {
        "question": "产品保修期是多久？",
        "context": "保修政策：本产品自购买之日起享有1年保修服务。",
        "answer": """根据保修政策，产品保修期为 **1年**，自购买之日起计算。

如需保修服务，请保留好购买凭证。"""
    },
    {
        "question": "如何申请退款？",
        "context": "退款政策：用户可在购买后7天内申请退款，需提供订单号和退款原因。",
        "answer": """退款申请流程如下：

1. **确认时间**：购买后7天内可申请
2. **准备材料**：订单号、退款原因
3. **提交申请**：联系客服提交退款申请

请注意保留相关凭证。"""
    }
]


def build_few_shot_prompt(examples: list, context: str, query: str) -> str:
    """构建 Few-shot Prompt"""

    # 构建示例部分
    examples_text = ""
    for i, ex in enumerate(examples, 1):
        examples_text += f"""
### 示例 {i}
**问题**：{ex['question']}
**参考文档**：{ex['context']}
**回答**：
{ex['answer']}

---
"""

    prompt = f"""你是一个专业的客服助手。请参考以下示例的回答风格和格式。

## 回答示例
{examples_text}

## 现在请回答

**参考文档**：
{context}

**用户问题**：{query}

**回答**：
"""
    return prompt


def few_shot_rag_answer(context: str, query: str) -> str:
    """Few-shot RAG 问答"""

    prompt = build_few_shot_prompt(FEW_SHOT_EXAMPLES, context, query)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3
    )

    return response.choices[0].message.content


# ===== 测试 =====
if __name__ == "__main__":
    test_context = "配送政策：订单满99元免运费，不满99元收取10元运费。偏远地区加收5元。"
    test_query = "运费怎么计算？"

    answer = few_shot_rag_answer(test_context, test_query)
    print("=" * 50)
    print("Few-shot RAG 回答：")
    print("=" * 50)
    print(answer)
```

**运行输出示例：**
```
==================================================
Few-shot RAG 回答：
==================================================
运费计算规则如下：

1. **满99元**：免运费
2. **不满99元**：收取10元运费
3. **偏远地区**：额外加收5元

建议凑单满99元享受免运费优惠。
```

---

## 示例2：Chain-of-Thought 复杂问题推理

```python
"""
Chain-of-Thought RAG 系统
演示：处理需要多步推理的复杂问题
"""

from openai import OpenAI

client = OpenAI()


def build_cot_prompt(context: str, query: str) -> str:
    """构建 CoT Prompt"""

    return f"""你是一个知识库问答助手。对于复杂问题，请分步骤思考后再给出答案。

## 参考文档
{context}

## 用户问题
{query}

## 请按以下步骤回答：

### 步骤1：理解问题
这个问题在问什么？需要哪些信息来回答？

### 步骤2：定位信息
在文档中找到了哪些相关信息？

### 步骤3：分析推理
如何根据这些信息得出答案？

### 步骤4：最终答案
综合以上分析，答案是：
"""


def cot_rag_answer(context: str, query: str) -> str:
    """CoT RAG 问答"""

    prompt = build_cot_prompt(context, query)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3
    )

    return response.choices[0].message.content


# ===== 测试 =====
if __name__ == "__main__":
    # 复杂问题：需要综合多个信息
    test_context = """
产品A：价格100元，会员折扣9折
产品B：价格80元，会员折扣8.5折
会员政策：消费满200元可升级为VIP，VIP额外享受95折
"""
    test_query = "我是普通会员，买2个产品A和1个产品B，能升级VIP吗？最终要付多少钱？"

    answer = cot_rag_answer(test_context, test_query)
    print("=" * 50)
    print("CoT RAG 回答：")
    print("=" * 50)
    print(answer)
```

**运行输出示例：**
```
==================================================
CoT RAG 回答：
==================================================
### 步骤1：理解问题
用户想知道：1) 购买后能否升级VIP 2) 最终支付金额

### 步骤2：定位信息
- 产品A：100元，会员9折
- 产品B：80元，会员8.5折
- VIP升级条件：消费满200元
- VIP额外折扣：95折

### 步骤3：分析推理
1. 计算会员价：
   - 2个产品A：100 × 0.9 × 2 = 180元
   - 1个产品B：80 × 0.85 = 68元
   - 总计：180 + 68 = 248元

2. 判断VIP升级：248元 > 200元，可以升级VIP

3. 应用VIP折扣：248 × 0.95 = 235.6元

### 步骤4：最终答案
是的，您可以升级为VIP！最终支付金额为 **235.6元**。
```

---

## 示例3：JSON 结构化输出

```python
"""
结构化输出 RAG 系统
演示：强制 LLM 输出 JSON 格式
"""

import json
from openai import OpenAI

client = OpenAI()


def build_json_prompt(context: str, query: str) -> str:
    """构建 JSON 输出 Prompt"""

    return f"""你是一个知识库问答助手。

## 参考文档
{context}

## 用户问题
{query}

## 输出要求
请严格按以下 JSON 格式输出，不要输出其他内容：
{{
    "answer": "直接回答用户问题",
    "confidence": "high/medium/low",
    "source": "信息来源（文档中的哪部分）",
    "related_questions": ["相关问题1", "相关问题2"]
}}
"""


def json_rag_answer(context: str, query: str) -> dict:
    """JSON 结构化 RAG 问答"""

    prompt = build_json_prompt(context, query)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        response_format={"type": "json_object"},  # 强制 JSON
        temperature=0.3
    )

    # 解析 JSON
    result = json.loads(response.choices[0].message.content)
    return result


def safe_json_parse(response: str) -> dict:
    """安全解析 JSON（带容错）"""
    import re

    try:
        return json.loads(response)
    except json.JSONDecodeError:
        # 尝试提取 JSON 部分
        match = re.search(r'\{.*\}', response, re.DOTALL)
        if match:
            return json.loads(match.group())
        # 返回默认结构
        return {
            "answer": response,
            "confidence": "low",
            "source": "unknown",
            "related_questions": []
        }


# ===== 测试 =====
if __name__ == "__main__":
    test_context = "退换货政策：商品签收后7天内可无理由退换，需保持商品完好。食品类商品不支持退换。"
    test_query = "买的零食可以退吗？"

    result = json_rag_answer(test_context, test_query)

    print("=" * 50)
    print("JSON 结构化输出：")
    print("=" * 50)
    print(json.dumps(result, ensure_ascii=False, indent=2))

    # 程序可以直接使用
    print("\n直接使用字段：")
    print(f"答案：{result['answer']}")
    print(f"置信度：{result['confidence']}")
```

**运行输出示例：**
```
==================================================
JSON 结构化输出：
==================================================
{
  "answer": "很抱歉，零食属于食品类商品，不支持退换。",
  "confidence": "high",
  "source": "退换货政策中的'食品类商品不支持退换'条款",
  "related_questions": ["哪些商品可以退换？", "退换货的时间限制是多久？"]
}

直接使用字段：
答案：很抱歉，零食属于食品类商品，不支持退换。
置信度：high
```

---

## 示例4：完整的进阶 RAG 系统（三合一）

```python
"""
完整的进阶 RAG 系统
演示：Few-shot + CoT + JSON 结构化输出
"""

import json
from openai import OpenAI

client = OpenAI()

# ===== 系统配置 =====
SYSTEM_PROMPT = """你是一个专业的知识库问答助手。

## 核心规则
- 只基于提供的参考文档回答问题
- 如果文档中没有相关信息，明确告知用户
- 对于复杂问题，先分析再回答
"""

FEW_SHOT_EXAMPLE = """
## 回答示例

问题：产品保修期是多久？
文档：保修政策第3条：本产品保修期为1年。

思考过程：
1. 问题询问保修期时长
2. 在文档中找到"保修期为1年"
3. 信息明确，置信度高

输出：{"answer": "产品保修期为1年", "confidence": "high", "source": "保修政策第3条", "reasoning": "文档明确说明保修期为1年"}
"""


def advanced_rag_answer(context: str, query: str) -> dict:
    """进阶 RAG 问答（三合一）"""

    prompt = f"""{FEW_SHOT_EXAMPLE}

## 参考文档
{context}

## 用户问题
{query}

请按示例格式，先写思考过程，再输出 JSON 结果。

思考过程：
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": prompt}
        ],
        temperature=0.3
    )

    full_response = response.choices[0].message.content

    # 提取 JSON 部分
    import re
    json_match = re.search(r'\{.*\}', full_response, re.DOTALL)
    if json_match:
        try:
            result = json.loads(json_match.group())
            result["full_response"] = full_response
            return result
        except json.JSONDecodeError:
            pass

    return {
        "answer": full_response,
        "confidence": "medium",
        "source": "unknown",
        "reasoning": "JSON解析失败",
        "full_response": full_response
    }


# ===== 测试 =====
if __name__ == "__main__":
    test_context = """
会员等级政策：
- 普通会员：消费享9.5折
- 银卡会员：消费满2000元升级，享9折
- 金卡会员：消费满5000元升级，享8.5折
- 钻石会员：消费满10000元升级，享8折，额外赠送生日礼品
"""
    test_query = "我已经消费了4500元，再买多少能升级金卡？升级后有什么优惠？"

    result = advanced_rag_answer(test_context, test_query)

    print("=" * 50)
    print("完整响应（含思考过程）：")
    print("=" * 50)
    print(result.get("full_response", ""))

    print("\n" + "=" * 50)
    print("结构化结果：")
    print("=" * 50)
    print(f"答案：{result.get('answer', 'N/A')}")
    print(f"置信度：{result.get('confidence', 'N/A')}")
    print(f"来源：{result.get('source', 'N/A')}")
```

---

## 代码要点总结

| 技巧 | 关键代码 | 注意事项 |
|------|---------|---------|
| **Few-shot** | 在 Prompt 中添加示例 | 示例要高质量、格式一致 |
| **CoT** | 添加"步骤1/2/3"结构 | 复杂问题才用 |
| **JSON Mode** | `response_format={"type": "json_object"}` | 添加解析容错 |
| **组合使用** | 示例 + 步骤 + JSON 格式要求 | 注意 Token 消耗 |

---

**下一步：** [08_面试必问](./08_面试必问.md) - 如何在面试中展示进阶技巧
