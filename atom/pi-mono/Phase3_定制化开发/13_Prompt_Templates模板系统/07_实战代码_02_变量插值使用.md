# 实战代码 02: 变量插值使用

## 概述

本章节通过完整的 TypeScript 代码示例，演示如何在模板中使用各种变量插值语法。所有代码都是可运行的，并包含详细的注释和说明。

---

## 示例 1: 位置参数使用

### 需求

创建一个模板，使用位置参数接受多个输入。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/compare.md << 'EOF'
---
description: Compare two technologies
---
# Technology Comparison

Compare $1 and $2 in the following aspects:

1. **Performance**: Which is faster?
2. **Scalability**: Which scales better?
3. **Learning Curve**: Which is easier to learn?
4. **Community**: Which has better community support?
5. **Use Cases**: When to use each?

Provide a detailed comparison with specific examples.
EOF
```

### 使用

```bash
pi
/compare React Vue
/compare TypeScript JavaScript
/compare PostgreSQL MongoDB
```

### TypeScript 模拟实现

```typescript
/**
 * 模拟变量替换
 */
function substitutePositionalArgs(template: string, args: string[]): string {
  let result = template;

  // 替换 $1, $2, $3, ...
  args.forEach((arg, index) => {
    const placeholder = `$${index + 1}`;
    result = result.replace(new RegExp(`\\${placeholder}`, 'g'), arg);
  });

  return result;
}

// 测试
const template = 'Compare $1 and $2';
const args = ['React', 'Vue'];
const result = substitutePositionalArgs(template, args);
console.log(result); // "Compare React and Vue"
```

---

## 示例 2: 所有参数使用

### 需求

创建一个模板，处理任意数量的文件。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/analyze-files.md << 'EOF'
---
description: Analyze multiple files
---
# File Analysis

Analyze the following files: $@

For each file, provide:
1. **Purpose**: What does this file do?
2. **Dependencies**: What does it depend on?
3. **Complexity**: How complex is it?
4. **Issues**: Any potential issues?
5. **Suggestions**: Improvement suggestions

Provide a summary at the end comparing all files.
EOF
```

### 使用

```bash
pi
/analyze-files src/utils.ts src/services.ts src/components.tsx
```

### TypeScript 实现

```typescript
/**
 * 替换所有参数
 */
function substituteAllArgs(template: string, args: string[]): string {
  const allArgs = args.join(' ');
  return template
    .replace(/\$@/g, allArgs)
    .replace(/\$ARGUMENTS/g, allArgs);
}

// 测试
const template = 'Analyze the following files: $@';
const args = ['src/utils.ts', 'src/services.ts', 'src/components.tsx'];
const result = substituteAllArgs(template, args);
console.log(result);
// "Analyze the following files: src/utils.ts src/services.ts src/components.tsx"
```

---

## 示例 3: 参数切片使用

### 需求

创建一个模板，将第一个参数作为基准，其余参数作为比较对象。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/compare-with-base.md << 'EOF'
---
description: Compare files against a base file
---
# File Comparison

## Base File
$1

## Files to Compare
${@:2}

## Task
Compare each file against the base file and identify:
1. **Similarities**: Common patterns and structures
2. **Differences**: Key differences in implementation
3. **Improvements**: Which file has better implementation?
4. **Refactoring**: Opportunities to consolidate code

Provide specific examples and code snippets.
EOF
```

### 使用

```bash
pi
/compare-with-base src/base.ts src/variant1.ts src/variant2.ts src/variant3.ts
```

### TypeScript 实现

```typescript
/**
 * 替换参数切片
 */
function substituteArgSlice(template: string, args: string[]): string {
  let result = template;

  // 替换 ${@:N:L} (从第 N 个参数开始，取 L 个)
  result = result.replace(/\$\{@:(\d+):(\d+)\}/g, (match, start, length) => {
    const startIdx = parseInt(start) - 1;
    const endIdx = startIdx + parseInt(length);
    return args.slice(startIdx, endIdx).join(' ');
  });

  // 替换 ${@:N} (从第 N 个参数开始的所有参数)
  result = result.replace(/\$\{@:(\d+)\}/g, (match, start) => {
    const startIdx = parseInt(start) - 1;
    return args.slice(startIdx).join(' ');
  });

  // 替换位置参数
  args.forEach((arg, index) => {
    const placeholder = `$${index + 1}`;
    result = result.replace(new RegExp(`\\${placeholder}`, 'g'), arg);
  });

  return result;
}

// 测试
const template = `Base: $1\nCompare: \${@:2}`;
const args = ['base.ts', 'variant1.ts', 'variant2.ts', 'variant3.ts'];
const result = substituteArgSlice(template, args);
console.log(result);
// "Base: base.ts\nCompare: variant1.ts variant2.ts variant3.ts"
```

---

## 示例 4: 混合使用多种语法

### 需求

创建一个复杂的模板，混合使用多种变量语法。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/advanced-review.md << 'EOF'
---
description: Advanced code review with multiple files
---
# Advanced Code Review

## Primary File
$1

## Related Files
${@:2:2}

## All Files in Context
$@

## Review Instructions

### 1. Primary File Analysis
Focus on $1 as the main file to review.

### 2. Related Files Context
Consider ${@:2:2} as related context.

### 3. Holistic Review
Review all files ($@) together to understand:
- How they interact
- Shared patterns
- Potential issues
- Refactoring opportunities

Provide a comprehensive review with specific recommendations.
EOF
```

### TypeScript 实现

```typescript
/**
 * 完整的变量替换实现
 */
function substituteVariables(template: string, args: string[]): string {
  let result = template;

  // 1. 替换 $ARGUMENTS 和 $@
  const allArgs = args.join(' ');
  result = result.replace(/\$ARGUMENTS/g, allArgs);
  result = result.replace(/\$@/g, allArgs);

  // 2. 替换 ${@:N:L}
  result = result.replace(/\$\{@:(\d+):(\d+)\}/g, (match, start, length) => {
    const startIdx = parseInt(start) - 1;
    const endIdx = startIdx + parseInt(length);
    return args.slice(startIdx, endIdx).join(' ');
  });

  // 3. 替换 ${@:N}
  result = result.replace(/\$\{@:(\d+)\}/g, (match, start) => {
    const startIdx = parseInt(start) - 1;
    return args.slice(startIdx).join(' ');
  });

  // 4. 替换 $1, $2, $3, ...
  result = result.replace(/\$(\d+)/g, (match, num) => {
    const idx = parseInt(num) - 1;
    return args[idx] || '';
  });

  return result;
}

// 测试
const template = `
Primary: $1
Related: \${@:2:2}
All: $@
`;

const args = ['main.ts', 'utils.ts', 'services.ts', 'components.tsx'];
const result = substituteVariables(template, args);
console.log(result);
```

---

## 示例 5: 在代码块中使用变量

### 需求

创建一个模板，在代码块中使用变量生成代码。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/gen-component.md << 'EOF'
---
description: Generate React component
---
# React Component Generator

Generate a React component named $1 with the following props: ${@:2}

## Generated Code

```typescript
import React from 'react';

interface ${1}Props {
  // Props for ${@:2}
}

export const $1: React.FC<${1}Props> = (props) => {
  return (
    <div className="$1">
      {/* Component implementation */}
    </div>
  );
};

export default $1;
```

## Usage Example

```typescript
import { $1 } from './$1';

function App() {
  return <$1 ${@:2} />;
}
```

Please implement the component with proper TypeScript types and React best practices.
EOF
```

### TypeScript 实现

```typescript
/**
 * 生成 React 组件模板
 */
function generateComponentTemplate(componentName: string, props: string[]): string {
  const propsStr = props.join(' ');

  return `# React Component Generator

Generate a React component named ${componentName} with the following props: ${propsStr}

## Generated Code

\`\`\`typescript
import React from 'react';

interface ${componentName}Props {
  // Props for ${propsStr}
}

export const ${componentName}: React.FC<${componentName}Props> = (props) => {
  return (
    <div className="${componentName}">
      {/* Component implementation */}
    </div>
  );
};

export default ${componentName};
\`\`\`

## Usage Example

\`\`\`typescript
import { ${componentName} } from './${componentName}';

function App() {
  return <${componentName} ${propsStr} />;
}
\`\`\`

Please implement the component with proper TypeScript types and React best practices.`;
}

// 测试
const result = generateComponentTemplate('UserProfile', ['userId', 'userName', 'avatar']);
console.log(result);
```

---

## 示例 6: 参数验证和错误处理

### 需求

创建一个健壮的变量替换函数，包含参数验证和错误处理。

### 实现

```typescript
/**
 * 参数验证错误
 */
class ArgumentError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'ArgumentError';
  }
}

/**
 * 带验证的变量替换
 */
function substituteVariablesWithValidation(
  template: string,
  args: string[],
  options: {
    strict?: boolean;
    defaultValue?: string;
  } = {}
): string {
  const { strict = false, defaultValue = '' } = options;

  let result = template;

  // 1. 替换 $ARGUMENTS 和 $@
  const allArgs = args.join(' ');
  result = result.replace(/\$ARGUMENTS/g, allArgs);
  result = result.replace(/\$@/g, allArgs);

  // 2. 替换 ${@:N:L}
  result = result.replace(/\$\{@:(\d+):(\d+)\}/g, (match, start, length) => {
    const startIdx = parseInt(start) - 1;
    const endIdx = startIdx + parseInt(length);

    if (strict && startIdx >= args.length) {
      throw new ArgumentError(`Argument index ${start} out of range (have ${args.length} args)`);
    }

    return args.slice(startIdx, endIdx).join(' ');
  });

  // 3. 替换 ${@:N}
  result = result.replace(/\$\{@:(\d+)\}/g, (match, start) => {
    const startIdx = parseInt(start) - 1;

    if (strict && startIdx >= args.length) {
      throw new ArgumentError(`Argument index ${start} out of range (have ${args.length} args)`);
    }

    return args.slice(startIdx).join(' ');
  });

  // 4. 替换 $1, $2, $3, ...
  result = result.replace(/\$(\d+)/g, (match, num) => {
    const idx = parseInt(num) - 1;

    if (strict && idx >= args.length) {
      throw new ArgumentError(`Argument $${num} not provided (have ${args.length} args)`);
    }

    return args[idx] || defaultValue;
  });

  return result;
}

// 测试：正常情况
try {
  const template = 'Hello, $1! You are $2 years old.';
  const args = ['Alice', '25'];
  const result = substituteVariablesWithValidation(template, args);
  console.log('✅ Success:', result);
} catch (error) {
  console.error('❌ Error:', error.message);
}

// 测试：缺少参数（非严格模式）
try {
  const template = 'Hello, $1! You are $2 years old.';
  const args = ['Alice'];
  const result = substituteVariablesWithValidation(template, args, { defaultValue: '[missing]' });
  console.log('✅ Success:', result); // "Hello, Alice! You are [missing] years old."
} catch (error) {
  console.error('❌ Error:', error.message);
}

// 测试：缺少参数（严格模式）
try {
  const template = 'Hello, $1! You are $2 years old.';
  const args = ['Alice'];
  const result = substituteVariablesWithValidation(template, args, { strict: true });
  console.log('✅ Success:', result);
} catch (error) {
  console.error('❌ Error:', error.message); // "Argument $2 not provided (have 1 args)"
}
```

---

## 示例 7: 参数转换和格式化

### 需求

创建一个支持参数转换的变量替换函数。

### 实现

```typescript
/**
 * 参数转换函数类型
 */
type ArgumentTransformer = (arg: string) => string;

/**
 * 内置转换器
 */
const builtinTransformers: Record<string, ArgumentTransformer> = {
  uppercase: (arg) => arg.toUpperCase(),
  lowercase: (arg) => arg.toLowerCase(),
  capitalize: (arg) => arg.charAt(0).toUpperCase() + arg.slice(1).toLowerCase(),
  kebabCase: (arg) => arg.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase(),
  snakeCase: (arg) => arg.replace(/([a-z])([A-Z])/g, '$1_$2').toLowerCase(),
  camelCase: (arg) => arg.replace(/-([a-z])/g, (_, letter) => letter.toUpperCase()),
};

/**
 * 带转换的变量替换
 */
function substituteWithTransform(
  template: string,
  args: string[],
  transformers: Record<string, ArgumentTransformer> = {}
): string {
  const allTransformers = { ...builtinTransformers, ...transformers };

  let result = template;

  // 替换带转换的变量: ${1|uppercase}
  result = result.replace(/\$\{(\d+)\|(\w+)\}/g, (match, num, transformer) => {
    const idx = parseInt(num) - 1;
    const arg = args[idx] || '';
    const transform = allTransformers[transformer];

    if (!transform) {
      console.warn(`Unknown transformer: ${transformer}`);
      return arg;
    }

    return transform(arg);
  });

  // 替换普通变量
  result = result.replace(/\$(\d+)/g, (match, num) => {
    const idx = parseInt(num) - 1;
    return args[idx] || '';
  });

  return result;
}

// 测试
const template = `
Component: \${1|capitalize}
File: \${1|kebabCase}.tsx
Class: \${1|camelCase}
Constant: \${1|uppercase}
`;

const args = ['user-profile'];
const result = substituteWithTransform(template, args);
console.log(result);
/*
Component: User-profile
File: user-profile.tsx
Class: userProfile
Constant: USER-PROFILE
*/
```

---

## 示例 8: 完整的模板引擎

### 需求

创建一个完整的模板引擎，支持所有功能。

### 实现

```typescript
import * as fs from 'fs';
import * as path from 'path';

/**
 * 模板引擎配置
 */
interface TemplateEngineOptions {
  strict?: boolean;
  defaultValue?: string;
  transformers?: Record<string, ArgumentTransformer>;
}

/**
 * 模板引擎
 */
class TemplateEngine {
  private options: Required<TemplateEngineOptions>;

  constructor(options: TemplateEngineOptions = {}) {
    this.options = {
      strict: options.strict ?? false,
      defaultValue: options.defaultValue ?? '',
      transformers: { ...builtinTransformers, ...options.transformers }
    };
  }

  /**
   * 渲染模板
   */
  render(template: string, args: string[]): string {
    let result = template;

    // 1. 替换带转换的变量
    result = this.substituteWithTransformers(result, args);

    // 2. 替换 $ARGUMENTS 和 $@
    const allArgs = args.join(' ');
    result = result.replace(/\$ARGUMENTS/g, allArgs);
    result = result.replace(/\$@/g, allArgs);

    // 3. 替换参数切片
    result = this.substituteSlices(result, args);

    // 4. 替换位置参数
    result = this.substitutePositional(result, args);

    return result;
  }

  /**
   * 从文件渲染
   */
  renderFile(filePath: string, args: string[]): string {
    const template = fs.readFileSync(filePath, 'utf-8');
    return this.render(template, args);
  }

  /**
   * 替换带转换的变量
   */
  private substituteWithTransformers(template: string, args: string[]): string {
    return template.replace(/\$\{(\d+)\|(\w+)\}/g, (match, num, transformer) => {
      const idx = parseInt(num) - 1;
      const arg = args[idx] || this.options.defaultValue;
      const transform = this.options.transformers[transformer];

      if (!transform) {
        console.warn(`Unknown transformer: ${transformer}`);
        return arg;
      }

      return transform(arg);
    });
  }

  /**
   * 替换参数切片
   */
  private substituteSlices(template: string, args: string[]): string {
    let result = template;

    // ${@:N:L}
    result = result.replace(/\$\{@:(\d+):(\d+)\}/g, (match, start, length) => {
      const startIdx = parseInt(start) - 1;
      const endIdx = startIdx + parseInt(length);

      if (this.options.strict && startIdx >= args.length) {
        throw new ArgumentError(`Argument index ${start} out of range`);
      }

      return args.slice(startIdx, endIdx).join(' ');
    });

    // ${@:N}
    result = result.replace(/\$\{@:(\d+)\}/g, (match, start) => {
      const startIdx = parseInt(start) - 1;

      if (this.options.strict && startIdx >= args.length) {
        throw new ArgumentError(`Argument index ${start} out of range`);
      }

      return args.slice(startIdx).join(' ');
    });

    return result;
  }

  /**
   * 替换位置参数
   */
  private substitutePositional(template: string, args: string[]): string {
    return template.replace(/\$(\d+)/g, (match, num) => {
      const idx = parseInt(num) - 1;

      if (this.options.strict && idx >= args.length) {
        throw new ArgumentError(`Argument $${num} not provided`);
      }

      return args[idx] || this.options.defaultValue;
    });
  }
}

// 使用示例
const engine = new TemplateEngine({
  strict: false,
  defaultValue: '[missing]',
  transformers: {
    // 自定义转换器
    reverse: (arg) => arg.split('').reverse().join('')
  }
});

// 测试
const template = `
Name: $1
Age: $2
Reversed: \${1|reverse}
All: $@
`;

const result = engine.render(template, ['Alice', '25']);
console.log(result);
```

---

## 总结

本章节演示了如何在 TypeScript 中实现和使用各种变量插值功能：

1. **位置参数** - `$1`, `$2`, `$3`
2. **所有参数** - `$@`, `$ARGUMENTS`
3. **参数切片** - `${@:N}`, `${@:N:L}`
4. **混合使用** - 组合多种语法
5. **代码块中使用** - 在代码生成中使用变量
6. **参数验证** - 错误处理和验证
7. **参数转换** - 格式化和转换
8. **完整引擎** - 功能完整的模板引擎

所有代码都是完整可运行的，可以直接在项目中使用。

---

**版本：** v1.0
**最后更新：** 2026-02-20
**维护者：** Claude Code
