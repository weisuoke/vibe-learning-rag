# æœ€å°å¯ç”¨çŸ¥è¯†

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½å¼€å§‹ä½¿ç”¨ Milvus è¿›è¡Œæ•°æ®æ’å…¥ä¸æŸ¥è¯¢ï¼š

---

## 4.1 æ‰¹é‡æ’å…¥æ•°æ®ï¼ˆæ ¸å¿ƒæ“ä½œï¼‰

**ä¸€å¥è¯**ï¼šæ‰¹é‡æ’å…¥æ¯”å•æ¡æ’å…¥å¿« 10-100 å€ï¼Œæ˜¯ Milvus çš„æ¨èæ–¹å¼ã€‚

```python
from pymilvus import Collection
import numpy as np

# å‡†å¤‡æ•°æ®ï¼šID + å‘é‡ + å…ƒæ•°æ®
num_docs = 1000
ids = list(range(num_docs))
vectors = np.random.rand(num_docs, 768).tolist()
texts = [f"æ–‡æ¡£ {i}" for i in range(num_docs)]

# æ‰¹é‡æ’å…¥ï¼ˆæ•°æ®é¡ºåºå¿…é¡»ä¸ Schema ä¸€è‡´ï¼‰
data = [ids, vectors, texts]
collection.insert(data)

print(f"âœ… æ’å…¥å®Œæˆï¼Œæ€»æ•°æ®é‡: {collection.num_entities}")
```

**å…³é”®è¦ç‚¹**ï¼š
- æ‰¹é‡æ’å…¥æ¯”å•æ¡æ’å…¥å¿« 10-100 å€
- æ•°æ®é¡ºåºå¿…é¡»ä¸ Schema å­—æ®µé¡ºåºä¸€è‡´
- æ’å…¥åæ•°æ®ä¸ä¼šç«‹å³å¯è§ï¼ˆéœ€è¦ç­‰å¾… flushï¼‰
- æ¨èæ‰¹æ¬¡å¤§å°ï¼š1000-10000 æ¡

**åœ¨ RAG ä¸­çš„åº”ç”¨**ï¼š
- å¯¼å…¥å¤§é‡æ–‡æ¡£æ—¶ï¼Œå…ˆæ”¶é›†æ‰€æœ‰æ•°æ®ï¼Œå†ä¸€æ¬¡æ€§æ‰¹é‡æ’å…¥
- é¿å…åœ¨å¾ªç¯ä¸­å•æ¡æ’å…¥ï¼ˆæ€§èƒ½æå·®ï¼‰

---

## 4.2 åˆ›å»º HNSW ç´¢å¼•ï¼ˆRAG æ¨èï¼‰

**ä¸€å¥è¯**ï¼šHNSW ç´¢å¼•æä¾›é«˜å¬å›ç‡ï¼ˆ98%+ï¼‰å’Œå¿«é€Ÿæ£€ç´¢ï¼ˆæ¯«ç§’çº§ï¼‰ï¼Œæ˜¯ RAG åœºæ™¯çš„æœ€ä½³é€‰æ‹©ã€‚

```python
# HNSW ç´¢å¼•ï¼šé«˜å¬å›ç‡ + å¿«é€Ÿæ£€ç´¢
index_params = {
    "metric_type": "COSINE",      # ç›¸ä¼¼åº¦åº¦é‡ï¼ˆæ¨è COSINEï¼‰
    "index_type": "HNSW",         # ç´¢å¼•ç±»å‹
    "params": {
        "M": 16,                  # è¿æ¥æ•°ï¼ˆå½±å“å¬å›ç‡ï¼‰
        "efConstruction": 256     # æ„å»ºæ·±åº¦ï¼ˆå½±å“æ„å»ºæ—¶é—´ï¼‰
    }
}

# åˆ›å»ºç´¢å¼•
collection.create_index(
    field_name="embedding",       # å‘é‡å­—æ®µå
    index_params=index_params
)

# å¿…é¡»åŠ è½½åˆ°å†…å­˜æ‰èƒ½æ£€ç´¢
collection.load()
print("âœ… ç´¢å¼•åˆ›å»ºå¹¶åŠ è½½å®Œæˆ")
```

**å…³é”®è¦ç‚¹**ï¼š
- HNSW æ˜¯ RAG åœºæ™¯çš„æœ€ä½³é€‰æ‹©ï¼ˆé«˜å¬å›ç‡ + å¿«é€Ÿï¼‰
- M=16, efConstruction=256 æ˜¯é€šç”¨é…ç½®
- **å¿…é¡» load() æ‰èƒ½æ£€ç´¢**ï¼ˆè¿™æ˜¯ Milvus çš„å¼ºåˆ¶è¦æ±‚ï¼‰
- ç´¢å¼•æ„å»ºéœ€è¦æ—¶é—´ï¼ˆæ•°æ®é‡å¤§æ—¶å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰

**å‚æ•°è¯´æ˜**ï¼š
- **M**ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ï¼Œè¶Šå¤§å¬å›ç‡è¶Šé«˜ä½†å†…å­˜å ç”¨è¶Šå¤§ï¼ˆæ¨è 8-64ï¼‰
- **efConstruction**ï¼šæ„å»ºæ—¶çš„æœç´¢æ·±åº¦ï¼Œè¶Šå¤§æ„å»ºæ—¶é—´è¶Šé•¿ä½†è´¨é‡è¶Šå¥½ï¼ˆæ¨è 100-500ï¼‰

---

## 4.3 æ‰§è¡Œç›¸ä¼¼åº¦æ£€ç´¢

**ä¸€å¥è¯**ï¼šsearch() è¿”å›ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„ Top-K ä¸ªç»“æœã€‚

```python
import numpy as np

# å‡†å¤‡æŸ¥è¯¢å‘é‡
query_vector = np.random.rand(768).tolist()

# æ‰§è¡Œæ£€ç´¢
results = collection.search(
    data=[query_vector],              # æŸ¥è¯¢å‘é‡ï¼ˆå¯ä»¥æ˜¯å¤šä¸ªï¼‰
    anns_field="embedding",           # å‘é‡å­—æ®µå
    param={
        "metric_type": "COSINE",      # ç›¸ä¼¼åº¦åº¦é‡
        "ef": 64                      # æœç´¢æ·±åº¦ï¼ˆå½±å“å¬å›ç‡ï¼‰
    },
    limit=5,                          # Top-Kï¼ˆè¿”å›å‰ 5 ä¸ªï¼‰
    output_fields=["text"]            # è¿”å›çš„å…ƒæ•°æ®å­—æ®µ
)

# å¤„ç†ç»“æœ
print("ğŸ” æ£€ç´¢ç»“æœï¼ˆTop-5ï¼‰ï¼š")
for i, hit in enumerate(results[0], 1):
    print(f"{i}. ID: {hit.id}, ç›¸ä¼¼åº¦: {hit.distance:.4f}")
    print(f"   æ–‡æœ¬: {hit.entity.get('text')}")
```

**å…³é”®è¦ç‚¹**ï¼š
- **limit**ï¼šæ§åˆ¶è¿”å›ç»“æœæ•°é‡ï¼ˆTop-Kï¼‰
- **ef**ï¼šæœç´¢æ·±åº¦ï¼Œè¶Šå¤§å¬å›ç‡è¶Šé«˜ä½†é€Ÿåº¦è¶Šæ…¢ï¼ˆæ¨è 64-512ï¼‰
- **output_fields**ï¼šæŒ‡å®šè¿”å›çš„å…ƒæ•°æ®å­—æ®µï¼ˆä¸è¿”å›å‘é‡å­—æ®µï¼ŒèŠ‚çœå¸¦å®½ï¼‰
- **COSINE ç›¸ä¼¼åº¦**ï¼šå€¼è¶Šå¤§è¶Šç›¸ä¼¼ï¼ˆ0-1 ä¹‹é—´ï¼‰

**ç›¸ä¼¼åº¦åº¦é‡é€‰æ‹©**ï¼š
- **COSINE**ï¼šé€‚åˆæ–‡æœ¬å‘é‡ï¼ˆæ¨èï¼‰
- **L2**ï¼šæ¬§æ°è·ç¦»ï¼Œè·ç¦»è¶Šå°è¶Šç›¸ä¼¼
- **IP**ï¼šå†…ç§¯ï¼Œå€¼è¶Šå¤§è¶Šç›¸ä¼¼

---

## 4.4 æ ‡é‡è¿‡æ»¤æ£€ç´¢ï¼ˆæ··åˆæ£€ç´¢ï¼‰

**ä¸€å¥è¯**ï¼šexpr å‚æ•°æ”¯æŒæ ‡é‡å­—æ®µè¿‡æ»¤ï¼Œå®ç°"å‘é‡ç›¸ä¼¼åº¦ + æ¡ä»¶ç­›é€‰"çš„æ··åˆæ£€ç´¢ã€‚

```python
# å‘é‡æ£€ç´¢ + æ¡ä»¶è¿‡æ»¤
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "COSINE", "ef": 64},
    limit=5,
    expr='category == "æŠ€æœ¯æ–‡æ¡£" and year >= 2023',  # è¿‡æ»¤æ¡ä»¶
    output_fields=["text", "category", "year"]
)

print("ğŸ” æ··åˆæ£€ç´¢ç»“æœï¼š")
for hit in results[0]:
    print(f"ID: {hit.id}, ç±»åˆ«: {hit.entity.get('category')}, å¹´ä»½: {hit.entity.get('year')}")
```

**å…³é”®è¦ç‚¹**ï¼š
- **expr** æ”¯æŒçš„æ“ä½œç¬¦ï¼š==, !=, >, <, >=, <=, in, and, or
- è¿‡æ»¤ä¼šå½±å“æ€§èƒ½ï¼Œå»ºè®®ä½¿ç”¨ Partition ä»£æ›¿ï¼ˆåç»­çŸ¥è¯†ç‚¹ï¼‰
- å¤šæ¡ä»¶ç»„åˆä½¿ç”¨ and/or è¿æ¥

**expr è¡¨è¾¾å¼ç¤ºä¾‹**ï¼š
```python
# å•æ¡ä»¶
expr='category == "æŠ€æœ¯"'

# å¤šæ¡ä»¶
expr='category == "æŠ€æœ¯" and year >= 2023 and score > 7.0'

# IN æ“ä½œç¬¦
expr='category in ["æŠ€æœ¯", "äº§å“"]'

# èŒƒå›´æŸ¥è¯¢
expr='year >= 2020 and year <= 2023'
```

---

## å®Œæ•´çš„æœ€å°å¯ç”¨æµç¨‹

```python
from pymilvus import Collection, connections
import numpy as np

# 1. è¿æ¥ Milvus
connections.connect("default", host="localhost", port="19530")

# 2. è·å– Collection
collection = Collection("my_collection")

# 3. æ‰¹é‡æ’å…¥æ•°æ®
data = [
    list(range(1000)),                    # IDs
    np.random.rand(1000, 768).tolist(),   # å‘é‡
    [f"doc_{i}" for i in range(1000)]     # æ–‡æœ¬
]
collection.insert(data)

# 4. åˆ›å»ºç´¢å¼•å¹¶åŠ è½½
index_params = {
    "metric_type": "COSINE",
    "index_type": "HNSW",
    "params": {"M": 16, "efConstruction": 256}
}
collection.create_index("embedding", index_params)
collection.load()

# 5. æ‰§è¡Œæ£€ç´¢
query_vector = np.random.rand(768).tolist()
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "COSINE", "ef": 64},
    limit=5,
    output_fields=["text"]
)

# 6. å¤„ç†ç»“æœ
for hit in results[0]:
    print(f"ID: {hit.id}, ç›¸ä¼¼åº¦: {hit.distance:.4f}, æ–‡æœ¬: {hit.entity.get('text')}")
```

---

## è¿™äº›çŸ¥è¯†è¶³ä»¥

- âœ… æ„å»ºåŸºç¡€çš„å‘é‡æ£€ç´¢ç³»ç»Ÿ
- âœ… å®ç°ç®€å•çš„ RAG æ–‡æ¡£é—®ç­”
- âœ… ç†è§£ Milvus çš„æ ¸å¿ƒå·¥ä½œæµç¨‹
- âœ… ä¸ºåç»­å­¦ä¹ ç´¢å¼•ä¼˜åŒ–æ‰“åŸºç¡€

---

## å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q1: æ’å…¥åä¸ºä»€ä¹ˆæ£€ç´¢ä¸åˆ°æ•°æ®ï¼Ÿ

**A**: æ•°æ®æ’å…¥æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ç­‰å¾… flush æˆ–ä½¿ç”¨ä¸€è‡´æ€§çº§åˆ«æ§åˆ¶ã€‚

```python
# æ–¹æ³•1ï¼šæ‰‹åŠ¨ flushï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
collection.insert(data)
collection.flush()

# æ–¹æ³•2ï¼šä½¿ç”¨ Strong ä¸€è‡´æ€§çº§åˆ«ï¼ˆæ¨èï¼‰
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "COSINE", "ef": 64},
    limit=5,
    consistency_level="Strong"  # å¼ºä¸€è‡´æ€§
)
```

### Q2: ä¸ºä»€ä¹ˆå¿…é¡» load() æ‰èƒ½æ£€ç´¢ï¼Ÿ

**A**: Milvus çš„ç´¢å¼•éœ€è¦åŠ è½½åˆ°å†…å­˜æ‰èƒ½å¿«é€Ÿæ£€ç´¢ï¼Œç£ç›˜ I/O å¤ªæ…¢ã€‚

```python
# åˆ›å»ºç´¢å¼•åå¿…é¡» load
collection.create_index("embedding", index_params)
collection.load()  # å¿…é¡»ï¼

# æ£€ç´¢å‰æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
print(f"Collection åŠ è½½çŠ¶æ€: {collection.is_loaded}")
```

### Q3: å¦‚ä½•é€‰æ‹© Top-K çš„å€¼ï¼Ÿ

**A**: RAG åœºæ™¯æ¨è Top-3 åˆ° Top-5ï¼Œå¹³è¡¡ç›¸å…³æ€§å’Œ Token æ¶ˆè€—ã€‚

```python
# Top-3ï¼šç²¾å‡†ä½†å¯èƒ½é—æ¼ä¿¡æ¯
results = collection.search(..., limit=3)

# Top-5ï¼šå¹³è¡¡é€‰æ‹©ï¼ˆæ¨èï¼‰
results = collection.search(..., limit=5)

# Top-10ï¼šå¬å›æ›´å¤šä½†å¯èƒ½å¼•å…¥å™ªå£°
results = collection.search(..., limit=10)
```

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡äº†æœ€å°å¯ç”¨çŸ¥è¯†åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **ç´¢å¼•å‚æ•°è°ƒä¼˜**ï¼šæ·±å…¥ç†è§£ Mã€efConstructionã€ef å‚æ•°
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ’å…¥ç­–ç•¥ã€ç´¢å¼•é€‰æ‹©ã€æŸ¥è¯¢ä¼˜åŒ–
3. **é«˜çº§æ£€ç´¢**ï¼šæ··åˆæ£€ç´¢ã€ReRankã€å¤šå‘é‡æ£€ç´¢
4. **ç”Ÿäº§éƒ¨ç½²**ï¼šç›‘æ§ã€å¤‡ä»½ã€é«˜å¯ç”¨

---

**è®°ä½**ï¼šè¿™ 4 ä¸ªæ“ä½œæ˜¯ Milvus çš„æ ¸å¿ƒï¼ŒæŒæ¡å®ƒä»¬å°±èƒ½å¼€å§‹æ„å»º RAG ç³»ç»Ÿï¼
