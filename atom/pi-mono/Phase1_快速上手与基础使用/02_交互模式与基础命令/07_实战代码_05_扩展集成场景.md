# 实战代码 05：扩展集成场景

> 展示如何使用和开发 Pi Extensions

---

## 场景 1：使用社区 Extension

### 安装 pi-interactive-shell

```bash
# 1. 克隆 Extension
cd ~/.pi/extensions
git clone https://github.com/nicopreme/pi-interactive-shell.git

# 2. 在 Pi 中重载
pi
> /reload

Extensions loaded:
  - pi-interactive-shell

> 请使用 interactive-shell 运行 Python REPL

AI: [Tool: interactive-shell]
Starting Python REPL...

>>> print("Hello from Pi!")
Hello from Pi!
>>>
```

**来源：** [@nicopreme on X](https://x.com/nicopreme) - 2025-12

---

## 场景 2：开发简单 Extension

### 创建自定义工具

```typescript
// .pi/extensions/code-analyzer.ts
import { Extension } from '@mariozechner/pi-agent-core';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

export default class CodeAnalyzer extends Extension {
  name = 'code-analyzer';

  async onLoad() {
    // 注册工具：代码复杂度分析
    this.registerTool('analyze-complexity', {
      description: 'Analyze code complexity using eslint',
      parameters: {
        file: { type: 'string', required: true }
      },
      execute: async (args) => {
        const { stdout } = await execAsync(
          `npx eslint ${args.file} --format json`
        );

        const results = JSON.parse(stdout);
        return {
          file: args.file,
          errors: results[0].errorCount,
          warnings: results[0].warningCount,
          complexity: this.calculateComplexity(results[0])
        };
      }
    });

    // 注册工具：代码格式化
    this.registerTool('format-code', {
      description: 'Format code using prettier',
      parameters: {
        file: { type: 'string', required: true }
      },
      execute: async (args) => {
        await execAsync(`npx prettier --write ${args.file}`);
        return { success: true, file: args.file };
      }
    });
  }

  private calculateComplexity(result: any): number {
    // 简单的复杂度计算
    return result.messages.filter(
      (m: any) => m.ruleId === 'complexity'
    ).length;
  }

  async onUnload() {
    console.log('Code Analyzer extension unloaded');
  }
}
```

### 使用自定义 Extension

```bash
> /reload

Extensions loaded:
  - code-analyzer

> 请使用 analyze-complexity 分析 @src/auth.ts

AI: [Tool: analyze-complexity] src/auth.ts

Result:
{
  file: "src/auth.ts",
  errors: 0,
  warnings: 3,
  complexity: 2
}

代码质量良好，只有 3 个警告，复杂度为 2（低）。

> 请使用 format-code 格式化这个文件

AI: [Tool: format-code] src/auth.ts

Result: { success: true, file: "src/auth.ts" }

文件已格式化。
```

---

## 场景 3：Token 监控 Extension

### pIRS Extension（社区）

```typescript
// 基于社区 pIRS Extension 的概念
// 来源: X/Twitter 社区讨论 - 2025-2026

// .pi/extensions/token-monitor.ts
import { Extension } from '@mariozechner/pi-agent-core';

export default class TokenMonitor extends Extension {
  name = 'token-monitor';
  private tokenUsage: Map<string, number> = new Map();

  async onLoad() {
    // 监听工具调用
    this.on('tool:before', (toolName, args) => {
      console.log(`[Token Monitor] Tool: ${toolName}`);
    });

    this.on('tool:after', (toolName, result, tokens) => {
      // 记录 Token 使用
      const current = this.tokenUsage.get(toolName) || 0;
      this.tokenUsage.set(toolName, current + tokens);
    });

    // 注册报告工具
    this.registerTool('token-report', {
      description: 'Generate token usage report',
      parameters: {},
      execute: async () => {
        const report = Array.from(this.tokenUsage.entries())
          .map(([tool, tokens]) => ({ tool, tokens }))
          .sort((a, b) => b.tokens - a.tokens);

        return {
          total: Array.from(this.tokenUsage.values())
            .reduce((a, b) => a + b, 0),
          byTool: report
        };
      }
    });
  }
}
```

### 使用 Token 监控

```bash
> /reload

> [进行一些操作...]

> 请生成 token 使用报告

AI: [Tool: token-report]

Token Usage Report:
Total: 45,230 tokens

By Tool:
1. read: 25,000 tokens (55%)
2. edit: 15,000 tokens (33%)
3. bash: 5,230 tokens (12%)

Estimated cost: $0.68
```

**灵感来源：** [pIRS Extension](https://x.com/search?q=pIRS%20pi-mono) - 2025-2026

---

## 场景 4：Math 渲染 Extension

### 社区 Math Extension

```typescript
// 基于社区讨论的 Math 渲染 Extension
// 来源: X/Twitter - 2025-2026

// .pi/extensions/math-renderer.ts
import { Extension } from '@mariozechner/pi-agent-core';

export default class MathRenderer extends Extension {
  name = 'math-renderer';

  async onLoad() {
    // 拦截 AI 响应，渲染 LaTeX
    this.on('message:assistant', (message) => {
      // 检测 LaTeX 公式
      const latexPattern = /\$\$(.*?)\$\$/g;

      if (latexPattern.test(message.content)) {
        // 渲染为 ASCII art 或使用终端图形
        message.content = this.renderLatex(message.content);
      }
    });
  }

  private renderLatex(content: string): string {
    // 简化的 LaTeX 渲染
    return content.replace(/\$\$(.*?)\$\$/g, (match, latex) => {
      // 实际实现会使用 katex 或类似库
      return `\n[Math: ${latex}]\n`;
    });
  }
}
```

---

## Extension 开发最佳实践

### 1. 清晰的工具定义

```typescript
this.registerTool('tool-name', {
  description: 'Clear description of what this tool does',
  parameters: {
    param1: { type: 'string', required: true },
    param2: { type: 'number', required: false }
  },
  execute: async (args) => {
    // 实现逻辑
    return result;
  }
});
```

### 2. 错误处理

```typescript
execute: async (args) => {
  try {
    const result = await someOperation(args);
    return { success: true, data: result };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}
```

### 3. 使用 /reload 快速迭代

```bash
# 开发流程
1. 修改 Extension 代码
2. /reload
3. 测试
4. 重复 1-3
```

### 4. 事件监听

```typescript
async onLoad() {
  // 监听工具调用
  this.on('tool:before', (name, args) => {
    console.log(`Calling ${name}`);
  });

  // 监听消息
  this.on('message:user', (message) => {
    // 处理用户消息
  });
}
```

---

## 社区 Extensions 列表

| Extension | 作者 | 功能 | 来源 |
|-----------|------|------|------|
| pi-interactive-shell | @nicopreme | 交互式 Shell | X/Twitter 2025-12 |
| pi-messenger | 社区 | 多 Agent 协作 | X/Twitter 2025-2026 |
| pIRS | 社区 | Token 监控 | X/Twitter 2025-2026 |
| Math Rendering | 社区 | LaTeX 渲染 | X/Twitter 2025-2026 |

---

## 快速参考

```typescript
// Extension 基本结构
export default class MyExtension extends Extension {
  name = 'my-extension';

  async onLoad() {
    // 注册工具
    this.registerTool('tool-name', { ... });

    // 监听事件
    this.on('event-name', handler);
  }

  async onUnload() {
    // 清理资源
  }
}
```

---

**来源：**
- [Extensions 文档](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md) - 2026-02
- [X/Twitter 社区](https://x.com/search?q=pi-mono%20extension) - 2025-2026
- [@nicopreme](https://x.com/nicopreme) - pi-interactive-shell
