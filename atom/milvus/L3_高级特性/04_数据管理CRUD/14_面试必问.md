# é¢è¯•å¿…é—® - Milvus æ•°æ®ç®¡ç† CRUD

> 5 ä¸ªå¸¸è§é¢è¯•é—®é¢˜æ·±å…¥è§£æï¼Œå¸®åŠ©ä½ å‡†å¤‡ Milvus ç›¸å…³é¢è¯•

---

## é—®é¢˜ 1: Milvus ä¸ºä»€ä¹ˆæ²¡æœ‰åŸç”Ÿçš„ Update æ“ä½œï¼Ÿ

### æ ‡å‡†ç­”æ¡ˆ

Milvus æ²¡æœ‰åŸç”Ÿçš„ Update æ“ä½œï¼Œä¸»è¦æœ‰ä¸‰ä¸ªåŸå› ï¼š

1. **å‘é‡ç´¢å¼•çš„ä¸å¯å˜æ€§**ï¼šå‘é‡ç´¢å¼•ï¼ˆå¦‚ HNSWï¼‰æ˜¯åŸºäºå‘é‡çš„ç›¸ä¼¼åº¦å…³ç³»æ„å»ºçš„å›¾ç»“æ„ï¼Œä¿®æ”¹å‘é‡éœ€è¦é‡å»ºæ•´ä¸ªç´¢å¼•
2. **åˆ—å¼å­˜å‚¨çš„ç‰¹æ€§**ï¼šMilvus ä½¿ç”¨åˆ—å¼å­˜å‚¨ï¼Œæ•°æ®å­˜å‚¨åœ¨ä¸å¯å˜çš„ Segment ä¸­ï¼Œä¿®æ”¹æ•°æ®éœ€è¦åˆ›å»ºæ–°çš„ Segment
3. **æ€§èƒ½è€ƒè™‘**ï¼šé‡å»ºç´¢å¼•çš„ä»£ä»·éå¸¸é«˜ï¼Œå¯¹äºå¤§è§„æ¨¡æ•°æ®é›†å¯èƒ½éœ€è¦å‡ å°æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Delete + Insert æˆ– Upsertï¼ˆMilvus 2.3+ï¼‰å®ç°æ›´æ–°ã€‚

### æ·±å…¥åˆ†æ

**ä¸ºä»€ä¹ˆå‘é‡ç´¢å¼•ä¸å¯å˜ï¼Ÿ**

ä»¥ HNSW ç´¢å¼•ä¸ºä¾‹ï¼š

```
å‘é‡ A: [0.1, 0.2, 0.3]
å‘é‡ B: [0.15, 0.25, 0.35]
å‘é‡ C: [0.2, 0.3, 0.4]

HNSW å›¾ç»“æ„:
A â†â†’ B â†â†’ C

å¦‚æœä¿®æ”¹å‘é‡ B ä¸º [0.9, 0.8, 0.7]:
- B ä¸ Aã€C çš„ç›¸ä¼¼åº¦å…³ç³»å®Œå…¨æ”¹å˜
- éœ€è¦é‡æ–°è®¡ç®— B çš„é‚»å±…èŠ‚ç‚¹
- å¯èƒ½éœ€è¦é‡å»ºæ•´ä¸ªå›¾ç»“æ„
```

**ä¸ºä»€ä¹ˆåˆ—å¼å­˜å‚¨ä¸å¯å˜ï¼Ÿ**

```
Segment 1 (ä¸å¯å˜):
  id åˆ—: [1, 2, 3]
  text åˆ—: ["A", "B", "C"]
  embedding åˆ—: [[0.1, 0.2], [0.3, 0.4], [0.5, 0.6]]

ä¿®æ”¹ id=2 çš„æ•°æ®:
  â†’ æ— æ³•ç›´æ¥ä¿®æ”¹ Segment 1
  â†’ éœ€è¦åˆ›å»ºæ–°çš„ Segment 2
  â†’ æ ‡è®° Segment 1 ä¸­ id=2 çš„æ•°æ®ä¸ºå·²åˆ é™¤
```

### å®æˆ˜å»ºè®®

**åœºæ™¯ 1: å°‘é‡æ•°æ®æ›´æ–°**

```python
# ä½¿ç”¨ Upsertï¼ˆæ¨èï¼‰
collection.upsert(data)
collection.flush()
```

**åœºæ™¯ 2: å¤§é‡æ•°æ®æ›´æ–°**

```python
# æ‰¹é‡åˆ é™¤ + æ‰¹é‡æ’å…¥
collection.delete(expr=f"id in {ids}")
collection.insert(new_data)
collection.flush()
```

**åœºæ™¯ 3: é¢‘ç¹æ›´æ–°**

å¦‚æœéœ€è¦é¢‘ç¹æ›´æ–°ï¼Œè€ƒè™‘ï¼š
- ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“ï¼ˆMySQL/PostgreSQLï¼‰å­˜å‚¨å…ƒæ•°æ®
- åªåœ¨ Milvus ä¸­å­˜å‚¨å‘é‡å’Œä¸å¸¸å˜åŒ–çš„å­—æ®µ
- å®šæœŸä»æ•°æ®åº“åŒæ­¥åˆ° Milvus

### é¢è¯•åŠ åˆ†ç‚¹

- ç†è§£å‘é‡ç´¢å¼•çš„åŸç†ï¼ˆHNSWã€IVFï¼‰
- çŸ¥é“ Segment çš„ä¸å¯å˜æ€§
- èƒ½å¤Ÿè®¾è®¡åˆç†çš„æ›´æ–°ç­–ç•¥
- äº†è§£ Upsert çš„åŸå­æ€§ä¿è¯

---

## é—®é¢˜ 2: Milvus çš„ Delete æ˜¯è½¯åˆ é™¤è¿˜æ˜¯ç¡¬åˆ é™¤ï¼Ÿå¦‚ä½•é‡Šæ”¾ç©ºé—´ï¼Ÿ

### æ ‡å‡†ç­”æ¡ˆ

Milvus çš„ Delete æ˜¯**è½¯åˆ é™¤**ï¼Œåªæ ‡è®°æ•°æ®ä¸ºå·²åˆ é™¤ï¼Œä¸ç«‹å³é‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚éœ€è¦æ‰§è¡Œ **Compaction** æ‰èƒ½çœŸæ­£é‡Šæ”¾ç©ºé—´ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š
```
delete() â†’ æ ‡è®°åˆ é™¤ â†’ flush() â†’ æŒä¹…åŒ–æ ‡è®° â†’ Compaction â†’ ç©ºé—´é‡Šæ”¾
```

### æ·±å…¥åˆ†æ

**ä¸ºä»€ä¹ˆæ˜¯è½¯åˆ é™¤ï¼Ÿ**

1. **Segment ä¸å¯å˜æ€§**ï¼šæ•°æ®å­˜å‚¨åœ¨ä¸å¯å˜çš„ Segment ä¸­ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹
2. **æ€§èƒ½è€ƒè™‘**ï¼šç«‹å³é‡Šæ”¾ç©ºé—´éœ€è¦é‡å†™ Segmentï¼Œä»£ä»·é«˜
3. **ä¸€è‡´æ€§ä¿è¯**ï¼šè½¯åˆ é™¤ä¿è¯åˆ é™¤æ“ä½œçš„åŸå­æ€§

**Compaction çš„å·¥ä½œåŸç†**ï¼š

```
Compaction å‰:
  Segment 1: [æ•°æ®1, æ•°æ®2(å·²åˆ é™¤), æ•°æ®3]
  Segment 2: [æ•°æ®4(å·²åˆ é™¤), æ•°æ®5, æ•°æ®6]

Compaction å:
  Segment 1': [æ•°æ®1, æ•°æ®3, æ•°æ®5, æ•°æ®6]
  (Segment 1 å’Œ Segment 2 è¢«åˆ é™¤)
```

**Compaction çš„è§¦å‘æ¡ä»¶**ï¼š

1. **è‡ªåŠ¨è§¦å‘**ï¼š
   - åˆ é™¤æ¯”ä¾‹ > 10%
   - Segment å¤§å° > 512MB
   - å®šæœŸè§¦å‘ï¼ˆæ¯å°æ—¶ï¼‰

2. **æ‰‹åŠ¨è§¦å‘**ï¼š
   ```python
   collection.compact()
   collection.wait_for_compaction_completed()
   ```

### å®æˆ˜å»ºè®®

**åœºæ™¯ 1: åˆ é™¤å¤§é‡æ•°æ®åç«‹å³ Compaction**

```python
# åˆ é™¤æ•°æ®
collection.delete(expr="id in [1, 2, 3, ..., 10000]")
collection.flush()

# ç«‹å³ Compaction
collection.compact()
collection.wait_for_compaction_completed()
```

**åœºæ™¯ 2: å®šæœŸ Compaction**

```python
import schedule

def compact_collection():
    collection.compact()
    collection.wait_for_compaction_completed()

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
schedule.every().day.at("02:00").do(compact_collection)
```

**åœºæ™¯ 3: ç›‘æ§ Compaction è¿›åº¦**

```python
def monitor_compaction():
    collection.compact()

    while True:
        state = collection.get_compaction_state()
        print(f"Compaction çŠ¶æ€: {state}")

        if state.state == 3:  # Completed
            break

        time.sleep(5)
```

### é¢è¯•åŠ åˆ†ç‚¹

- ç†è§£è½¯åˆ é™¤å’Œç¡¬åˆ é™¤çš„åŒºåˆ«
- çŸ¥é“ Compaction çš„è§¦å‘æ¡ä»¶
- èƒ½å¤Ÿè®¾è®¡åˆç†çš„ Compaction ç­–ç•¥
- äº†è§£ Compaction å¯¹æ€§èƒ½çš„å½±å“

---

## é—®é¢˜ 3: Query å’Œ Search æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªï¼Ÿ

### æ ‡å‡†ç­”æ¡ˆ

**Query** å’Œ **Search** æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æ“ä½œï¼š

| ç‰¹æ€§ | Query | Search |
|------|-------|--------|
| **æŸ¥è¯¢æ–¹å¼** | æ ‡é‡æŸ¥è¯¢ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ | å‘é‡æ£€ç´¢ï¼ˆç›¸ä¼¼åº¦åŒ¹é…ï¼‰ |
| **æŸ¥è¯¢æ¡ä»¶** | è¡¨è¾¾å¼ï¼ˆexprï¼‰ | å‘é‡ï¼ˆdataï¼‰ |
| **è¿”å›ç»“æœ** | æ‰€æœ‰åŒ¹é…çš„æ•°æ® | Top-K æœ€ç›¸ä¼¼çš„æ•°æ® |
| **ä½¿ç”¨ç´¢å¼•** | ä¸ä½¿ç”¨å‘é‡ç´¢å¼• | ä½¿ç”¨å‘é‡ç´¢å¼• |
| **æ€§èƒ½** | O(n) å…¨è¡¨æ‰«æ | O(log n) ç´¢å¼•åŠ é€Ÿ |
| **é€‚ç”¨åœºæ™¯** | æŒ‰ ID æŸ¥è¯¢ã€æ¡ä»¶è¿‡æ»¤ | ç›¸ä¼¼åº¦æ£€ç´¢ã€æ¨èç³»ç»Ÿ |

### æ·±å…¥åˆ†æ

**Query çš„åº•å±‚å®ç°**ï¼š

```
ç”¨æˆ·è°ƒç”¨ query(expr="id in [1, 2, 3]")
    â†“
è§£æè¡¨è¾¾å¼
    â†“
æ‰«æ Segmentï¼ˆæ ‡é‡å­—æ®µï¼‰
    â†“
è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ•°æ®
    â†“
è¿”å›æ‰€æœ‰åŒ¹é…çš„æ•°æ®
```

**Search çš„åº•å±‚å®ç°**ï¼š

```
ç”¨æˆ·è°ƒç”¨ search(data=[query_vector])
    â†“
åŠ è½½å‘é‡ç´¢å¼•
    â†“
ä½¿ç”¨ç´¢å¼•å¿«é€Ÿæ‰¾åˆ°å€™é€‰é›†
    â†“
è®¡ç®—å€™é€‰é›†ä¸æŸ¥è¯¢å‘é‡çš„è·ç¦»
    â†“
æ’åºå¹¶è¿”å› Top-K
    â†“
ï¼ˆå¯é€‰ï¼‰æ ‡é‡è¿‡æ»¤
    â†“
è¿”å›æœ€ç»ˆç»“æœ
```

**æ··åˆæ£€ç´¢**ï¼š

```python
# å‘é‡æ£€ç´¢ + æ ‡é‡è¿‡æ»¤
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr="category == 'tech' and price < 100"  # æ ‡é‡è¿‡æ»¤
)
```

### å®æˆ˜å»ºè®®

**ä½¿ç”¨ Query çš„åœºæ™¯**ï¼š

```python
# åœºæ™¯ 1: æŒ‰ ID æŸ¥è¯¢
results = collection.query(expr="id in [1, 2, 3]")

# åœºæ™¯ 2: æ¡ä»¶è¿‡æ»¤
results = collection.query(expr="price > 100 and category == 'tech'")

# åœºæ™¯ 3: ç²¾ç¡®åŒ¹é…
results = collection.query(expr="text == 'hello'")
```

**ä½¿ç”¨ Search çš„åœºæ™¯**ï¼š

```python
# åœºæ™¯ 1: ç›¸ä¼¼åº¦æ£€ç´¢
results = collection.search(data=[query_vector], limit=5)

# åœºæ™¯ 2: æ¨èç³»ç»Ÿ
results = collection.search(data=[user_vector], limit=10)

# åœºæ™¯ 3: å›¾åƒæœç´¢
results = collection.search(data=[image_vector], limit=20)
```

**ä½¿ç”¨æ··åˆæ£€ç´¢çš„åœºæ™¯**ï¼š

```python
# åœºæ™¯ 1: ç”µå•†æœç´¢ï¼ˆç›¸ä¼¼å•†å“ + ä»·æ ¼è¿‡æ»¤ï¼‰
results = collection.search(
    data=[query_vector],
    limit=10,
    expr="price < 1000 and stock > 0"
)

# åœºæ™¯ 2: æ–‡æ¡£æ£€ç´¢ï¼ˆç›¸ä¼¼æ–‡æ¡£ + ç±»åˆ«è¿‡æ»¤ï¼‰
results = collection.search(
    data=[query_vector],
    limit=5,
    expr="category == 'tech'"
)
```

### é¢è¯•åŠ åˆ†ç‚¹

- ç†è§£ Query å’Œ Search çš„åº•å±‚å®ç°
- çŸ¥é“æ··åˆæ£€ç´¢çš„æ‰§è¡Œé¡ºåºï¼ˆå…ˆå‘é‡åæ ‡é‡ï¼‰
- èƒ½å¤Ÿæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŸ¥è¯¢æ–¹å¼
- äº†è§£æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

---

## é—®é¢˜ 4: Milvus çš„æ’å…¥æ“ä½œä¸ºä»€ä¹ˆéœ€è¦ flush() å’Œ load()ï¼Ÿ

### æ ‡å‡†ç­”æ¡ˆ

Milvus çš„æ’å…¥æ“ä½œéœ€è¦ `flush()` å’Œ `load()` çš„åŸå› ï¼š

1. **flush()**: å°†å†…å­˜ç¼“å†²åŒºçš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜
2. **load()**: å°†æ•°æ®å’Œç´¢å¼•åŠ è½½åˆ°å†…å­˜ï¼Œæ‰èƒ½è¿›è¡Œæ£€ç´¢

**æ‰§è¡Œæµç¨‹**ï¼š
```
insert() â†’ MemTableï¼ˆå†…å­˜ç¼“å†²åŒºï¼‰
    â†“
flush() â†’ Segmentï¼ˆç£ç›˜ï¼‰
    â†“
load() â†’ Memoryï¼ˆå†…å­˜ç´¢å¼•ï¼‰
    â†“
search() â†’ æ£€ç´¢æˆåŠŸ
```

### æ·±å…¥åˆ†æ

**ä¸ºä»€ä¹ˆéœ€è¦ flush()ï¼Ÿ**

1. **å»¶è¿ŸæŒä¹…åŒ–ç­–ç•¥**ï¼š
   - æ•°æ®å…ˆå†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆMemTableï¼‰
   - æ‰¹é‡å†™å…¥ç£ç›˜ï¼Œå‡å°‘ I/O æ¬¡æ•°
   - æå‡å†™å…¥æ€§èƒ½ï¼ˆ10-100 å€ï¼‰

2. **WAL ä¿è¯æ•°æ®ä¸ä¸¢å¤±**ï¼š
   - æ’å…¥æ—¶å…ˆå†™å…¥ WALï¼ˆWrite-Ahead Logï¼‰
   - flush() å°† MemTable åˆ·æ–°åˆ° Segment
   - å³ä½¿è¿›ç¨‹å´©æºƒï¼Œä¹Ÿèƒ½ä» WAL æ¢å¤

**ä¸ºä»€ä¹ˆéœ€è¦ load()ï¼Ÿ**

1. **æ˜¾å¼åŠ è½½ç­–ç•¥**ï¼š
   - ç”¨æˆ·å†³å®šå“ªäº›æ•°æ®åŠ è½½åˆ°å†…å­˜
   - æ§åˆ¶å†…å­˜ä½¿ç”¨
   - æ€§èƒ½å¯é¢„æµ‹

2. **ç´¢å¼•æ„å»º**ï¼š
   - flush() åæ„å»ºç´¢å¼•
   - load() åŠ è½½ç´¢å¼•åˆ°å†…å­˜
   - æ£€ç´¢æ—¶ç›´æ¥ä½¿ç”¨å†…å­˜ç´¢å¼•

**æ€§èƒ½å¯¹æ¯”**ï¼š

```python
# é”™è¯¯ï¼šæ¯æ¬¡æ’å…¥éƒ½ flush
for data in batches:
    collection.insert(data)
    collection.flush()  # é¢‘ç¹ flushï¼Œæ€§èƒ½å·®

# æ­£ç¡®ï¼šæ‰¹é‡ flush
for data in batches:
    collection.insert(data)
collection.flush()  # æ‰¹é‡ flushï¼Œæ€§èƒ½å¥½
```

### å®æˆ˜å»ºè®®

**åœºæ™¯ 1: å•æ¬¡æ’å…¥**

```python
collection.insert(data)
collection.flush()  # æŒä¹…åŒ–
collection.load()   # åŠ è½½åˆ°å†…å­˜
```

**åœºæ™¯ 2: æ‰¹é‡æ’å…¥**

```python
for batch in batches:
    collection.insert(batch)

collection.flush()  # æ‰¹é‡æŒä¹…åŒ–
collection.load()   # åŠ è½½åˆ°å†…å­˜
```

**åœºæ™¯ 3: å·²åŠ è½½çš„ Collection**

```python
# å¦‚æœ Collection å·²ç»åŠ è½½ï¼Œåªéœ€è¦ flush
collection.insert(data)
collection.flush()  # æ–°æ•°æ®ä¼šè‡ªåŠ¨åŠ è½½
```

### é¢è¯•åŠ åˆ†ç‚¹

- ç†è§£å»¶è¿ŸæŒä¹…åŒ–çš„ä¼˜åŠ¿
- çŸ¥é“ WAL çš„ä½œç”¨
- äº†è§£ MemTable å’Œ Segment çš„å…³ç³»
- èƒ½å¤Ÿä¼˜åŒ– flush() çš„è°ƒç”¨é¢‘ç‡

---

## é—®é¢˜ 5: å¦‚ä½•åœ¨ Milvus ä¸­å®ç°æ•°æ®çš„éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Ÿ

### æ ‡å‡†ç­”æ¡ˆ

Milvus **ä¸æ”¯æŒç›´æ¥çš„éƒ¨åˆ†å­—æ®µæ›´æ–°**ï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š

1. æŸ¥è¯¢åŸå§‹æ•°æ®ï¼ˆè·å–æ‰€æœ‰å­—æ®µï¼‰
2. ä¿®æ”¹éœ€è¦æ›´æ–°çš„å­—æ®µ
3. ä½¿ç”¨ Upsert æ›´æ–°æ‰€æœ‰å­—æ®µ

**åŸå› **ï¼š
- Milvus ä½¿ç”¨åˆ—å¼å­˜å‚¨ï¼Œæ•°æ®å­˜å‚¨åœ¨ä¸å¯å˜çš„ Segment ä¸­
- æ— æ³•åªä¿®æ”¹æŸä¸ªå­—æ®µï¼Œå¿…é¡»é‡å†™æ•´æ¡è®°å½•

### æ·±å…¥åˆ†æ

**ä¸ºä»€ä¹ˆä¸æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Ÿ**

1. **åˆ—å¼å­˜å‚¨çš„ç‰¹æ€§**ï¼š
   ```
   Segment:
     id åˆ—: [1, 2, 3]
     text åˆ—: ["A", "B", "C"]
     embedding åˆ—: [[0.1, 0.2], [0.3, 0.4], [0.5, 0.6]]

   ä¿®æ”¹ id=2 çš„ text:
     â†’ æ— æ³•åªä¿®æ”¹ text åˆ—çš„ä¸€ä¸ªå€¼
     â†’ éœ€è¦é‡å†™æ•´æ¡è®°å½•
   ```

2. **Segment çš„ä¸å¯å˜æ€§**ï¼š
   - Segment ä¸€æ—¦åˆ›å»ºå°±ä¸å¯ä¿®æ”¹
   - ä¿®æ”¹æ•°æ®éœ€è¦åˆ›å»ºæ–°çš„ Segment

**å®ç°éƒ¨åˆ†å­—æ®µæ›´æ–°çš„æ–¹æ³•**ï¼š

**æ–¹æ³• 1: æ‰‹åŠ¨å®ç°**

```python
def update_fields(collection, id, updates):
    """æ›´æ–°æŒ‡å®šå­—æ®µ"""
    # 1. æŸ¥è¯¢åŸå§‹æ•°æ®
    results = collection.query(
        expr=f"id == {id}",
        output_fields=["*"]
    )

    if not results:
        raise ValueError(f"ID {id} ä¸å­˜åœ¨")

    original = results[0]

    # 2. æ›´æ–°å­—æ®µ
    for field, value in updates.items():
        original[field] = value

    # 3. å¦‚æœæ›´æ–°äº† title æˆ– contentï¼Œé‡æ–°ç”Ÿæˆ Embedding
    if "title" in updates or "content" in updates:
        text = f"{original['title']} {original['content']}"
        original["embedding"] = model.encode([text])[0].tolist()

    # 4. Upsert
    data = [[original[field] for field in schema_fields]]
    collection.upsert(data)
    collection.flush()

# ä½¿ç”¨
update_fields(collection, id=1, updates={"text": "new text"})
```

**æ–¹æ³• 2: å°è£…ä¸ºå·¥å…·ç±»**

```python
class FieldUpdater:
    """å­—æ®µæ›´æ–°å™¨"""

    def __init__(self, collection, model):
        self.collection = collection
        self.model = model

    def update(self, id, **updates):
        """æ›´æ–°å­—æ®µ"""
        # æŸ¥è¯¢åŸå§‹æ•°æ®
        results = self.collection.query(
            expr=f"id == {id}",
            output_fields=["*"]
        )

        if not results:
            raise ValueError(f"ID {id} ä¸å­˜åœ¨")

        original = results[0]

        # æ›´æ–°å­—æ®µ
        for field, value in updates.items():
            original[field] = value

        # é‡æ–°ç”Ÿæˆ Embedding
        if "title" in updates or "content" in updates:
            text = f"{original['title']} {original['content']}"
            original["embedding"] = self.model.encode([text])[0].tolist()

        # Upsert
        self._upsert(original)

    def _upsert(self, data):
        """Upsert æ•°æ®"""
        # å®ç° Upsert é€»è¾‘
        pass

# ä½¿ç”¨
updater = FieldUpdater(collection, model)
updater.update(id=1, text="new text", category="new category")
```

### å®æˆ˜å»ºè®®

**åœºæ™¯ 1: æ›´æ–°å•ä¸ªå­—æ®µ**

```python
# æ›´æ–° text å­—æ®µ
update_fields(collection, id=1, updates={"text": "new text"})
```

**åœºæ™¯ 2: æ›´æ–°å¤šä¸ªå­—æ®µ**

```python
# æ›´æ–°å¤šä¸ªå­—æ®µ
update_fields(collection, id=1, updates={
    "text": "new text",
    "category": "new category"
})
```

**åœºæ™¯ 3: æ‰¹é‡æ›´æ–°**

```python
def batch_update_fields(collection, updates_list):
    """æ‰¹é‡æ›´æ–°å­—æ®µ"""
    # updates_list = [{"id": 1, "text": "new text 1"}, {"id": 2, "text": "new text 2"}]

    # æŸ¥è¯¢æ‰€æœ‰éœ€è¦æ›´æ–°çš„æ•°æ®
    ids = [u["id"] for u in updates_list]
    results = collection.query(
        expr=f"id in {ids}",
        output_fields=["*"]
    )

    # æ„å»ºæ˜ å°„
    id_to_data = {r["id"]: r for r in results}

    # æ›´æ–°æ•°æ®
    for update in updates_list:
        id = update["id"]
        if id in id_to_data:
            for field, value in update.items():
                if field != "id":
                    id_to_data[id][field] = value

    # æ‰¹é‡ Upsert
    updated_data = list(id_to_data.values())
    # ... Upsert é€»è¾‘
```

### é¢è¯•åŠ åˆ†ç‚¹

- ç†è§£åˆ—å¼å­˜å‚¨çš„é™åˆ¶
- çŸ¥é“ Segment çš„ä¸å¯å˜æ€§
- èƒ½å¤Ÿå°è£…å·¥å…·å‡½æ•°ç®€åŒ–æ›´æ–°é€»è¾‘
- äº†è§£æ‰¹é‡æ›´æ–°çš„ä¼˜åŒ–ç­–ç•¥

---

## é¢è¯•å‡†å¤‡å»ºè®®

### 1. ç†è®ºçŸ¥è¯†

- **CRUD å››å¤§æ“ä½œ**ï¼šInsert, Query/Search, Upsert, Delete
- **åº•å±‚åŸç†**ï¼šWAL, MemTable, Segment, Index
- **æ€§èƒ½æ¨¡å‹**ï¼šæ‰¹é‡æ“ä½œã€ç´¢å¼•ä¼˜åŒ–ã€åˆ†åŒºåŠ é€Ÿ
- **ä¸€è‡´æ€§æ¨¡å‹**ï¼š4 ç§ä¸€è‡´æ€§çº§åˆ«

### 2. å®æˆ˜ç»éªŒ

- **å®Œæ•´çš„ CRUD æµç¨‹**ï¼šä»åˆ›å»º Collection åˆ°å¢åˆ æ”¹æŸ¥
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ“ä½œã€å¹¶è¡Œå¤„ç†ã€å‡å°‘ flush()
- **é”™è¯¯å¤„ç†**ï¼šé‡è¯•æœºåˆ¶ã€å¼‚å¸¸æ•è·
- **RAG é›†æˆ**ï¼šæ–‡æ¡£å¯¼å…¥ã€æ£€ç´¢ã€æ›´æ–°

### 3. å¸¸è§é—®é¢˜

- ä¸ºä»€ä¹ˆæ²¡æœ‰ Updateï¼Ÿ
- Delete å¦‚ä½•é‡Šæ”¾ç©ºé—´ï¼Ÿ
- Query å’Œ Search çš„åŒºåˆ«ï¼Ÿ
- ä¸ºä»€ä¹ˆéœ€è¦ flush() å’Œ load()ï¼Ÿ
- å¦‚ä½•å®ç°éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Ÿ

### 4. åŠ åˆ†é¡¹

- **æ·±å…¥ç†è§£åŸç†**ï¼šå‘é‡ç´¢å¼•ã€åˆ—å¼å­˜å‚¨ã€Segment
- **æ€§èƒ½ä¼˜åŒ–ç»éªŒ**ï¼šæ‰¹é‡æ“ä½œã€å¹¶è¡Œå¤„ç†ã€Compaction
- **ç”Ÿäº§å®è·µ**ï¼šç›‘æ§ã€å‘Šè­¦ã€å®¹ç¾
- **RAG åº”ç”¨**ï¼šæ–‡æ¡£ç®¡ç†ã€æ£€ç´¢ä¼˜åŒ–ã€é‡æ’åº

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ç†è§£ Milvus çš„è®¾è®¡å“²å­¦**ï¼šåˆ—å¼å­˜å‚¨ã€å»¶è¿ŸæŒä¹…åŒ–ã€æ˜¾å¼åŠ è½½
2. **æŒæ¡ CRUD æ“ä½œçš„åŸç†**ï¼šåº•å±‚å®ç°ã€æ€§èƒ½ç‰¹å¾ã€ä¼˜åŒ–ç­–ç•¥
3. **åŒºåˆ† Query å’Œ Search**ï¼šç²¾ç¡®æŸ¥è¯¢ vs ç›¸ä¼¼åº¦æ£€ç´¢
4. **ç†è§£è½¯åˆ é™¤å’Œ Compaction**ï¼šç©ºé—´é‡Šæ”¾çš„æœºåˆ¶
5. **æŒæ¡æ•°æ®æ›´æ–°ç­–ç•¥**ï¼šUpsertã€éƒ¨åˆ†å­—æ®µæ›´æ–°

### é¢è¯•æŠ€å·§

1. **å…ˆå›ç­”æ ¸å¿ƒè¦ç‚¹**ï¼šç®€æ´æ˜äº†
2. **æ·±å…¥åˆ†æåŸç†**ï¼šå±•ç¤ºç†è§£æ·±åº¦
3. **ç»“åˆå®æˆ˜ç»éªŒ**ï¼šå±•ç¤ºå®è·µèƒ½åŠ›
4. **æå‡ºä¼˜åŒ–å»ºè®®**ï¼šå±•ç¤ºæ€è€ƒèƒ½åŠ›
5. **ä¿æŒè°¦è™šæ€åº¦**ï¼šæ‰¿è®¤ä¸è¶³ï¼Œæ„¿æ„å­¦ä¹ 

---

**ç¥ä½ é¢è¯•æˆåŠŸï¼** ğŸ‰
