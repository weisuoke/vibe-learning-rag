# ç¬¬ä¸€æ€§åŸç†

## ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

ä¸ä¾èµ–ç±»æ¯”ã€ç»éªŒæˆ–æƒ¯ä¾‹ï¼Œè€Œæ˜¯ä»æœ€æ ¹æœ¬çš„äº‹å®å‡ºå‘æ¨å¯¼ã€‚

---

## OutputParser çš„ç¬¬ä¸€æ€§åŸç†

### 1. æœ€åŸºç¡€çš„å®šä¹‰

**OutputParser = å­—ç¬¦ä¸² â†’ ç»“æ„åŒ–å¯¹è±¡çš„è½¬æ¢å‡½æ•°**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

```python
# æœ€ç®€å•çš„ OutputParser æ¦‚å¿µ
def parse(text: str) -> object:
    """å°† LLM è¾“å‡ºçš„å­—ç¬¦ä¸²è½¬æ¢ä¸º Python å¯¹è±¡"""
    return convert_to_object(text)
```

è¿™å°±æ˜¯ OutputParser çš„æœ¬è´¨ï¼šä¸€ä¸ª**ç±»å‹è½¬æ¢å™¨**ã€‚

---

### 2. ä¸ºä»€ä¹ˆéœ€è¦ OutputParserï¼Ÿ

#### æ ¸å¿ƒé—®é¢˜ï¼šLLM è¾“å‡ºä¸åº”ç”¨éœ€æ±‚çš„ç±»å‹ä¸åŒ¹é…

**æ ¹æœ¬çŸ›ç›¾**ï¼š
- **LLM çš„è¾“å‡º**ï¼šå­—ç¬¦ä¸²ï¼ˆStringï¼‰
- **åº”ç”¨çš„éœ€æ±‚**ï¼šç»“æ„åŒ–æ•°æ®ï¼ˆObjectã€Listã€Dictï¼‰

**å…·ä½“è¡¨ç°**ï¼š

```python
# LLM è¿”å›çš„æ˜¯å­—ç¬¦ä¸²
llm_output = '{"name": "Alice", "age": 25}'  # str ç±»å‹

# ä½†åº”ç”¨éœ€è¦çš„æ˜¯å¯¹è±¡
user = User(name="Alice", age=25)  # User å¯¹è±¡
database.save(user)  # æ•°æ®åº“éœ€è¦å¯¹è±¡ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
```

**ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªçŸ›ç›¾ï¼Ÿ**

1. **LLM çš„æœ¬è´¨**ï¼šè¯­è¨€æ¨¡å‹åªèƒ½ç”Ÿæˆ token åºåˆ—ï¼ˆæ–‡æœ¬ï¼‰
2. **åº”ç”¨çš„æœ¬è´¨**ï¼šç¨‹åºéœ€è¦ç±»å‹åŒ–çš„æ•°æ®ç»“æ„
3. **é›†æˆçš„éœ€æ±‚**ï¼šAI è¾“å‡ºè¦ä¸æ•°æ®åº“ã€APIã€UI ç­‰ç³»ç»Ÿé›†æˆ

**å¦‚æœæ²¡æœ‰ OutputParser**ï¼š

```python
# æ‰‹åŠ¨è§£æï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
import json

llm_output = llm.invoke("Extract person info: Alice, 25 years old")
# è¾“å‡º: "The person is Alice and she is 25 years old."

# ğŸ˜± é—®é¢˜ 1ï¼šæ ¼å¼ä¸ç¡®å®š
# LLM å¯èƒ½è¿”å›è‡ªç„¶è¯­è¨€ï¼Œä¸æ˜¯ JSON

# ğŸ˜± é—®é¢˜ 2ï¼šæ‰‹åŠ¨è§£æå®¹æ˜“å‡ºé”™
try:
    data = json.loads(llm_output)  # å¯èƒ½å¤±è´¥
except:
    # éœ€è¦å†™å¤§é‡é”™è¯¯å¤„ç†ä»£ç 
    pass

# ğŸ˜± é—®é¢˜ 3ï¼šæ²¡æœ‰ç±»å‹æ£€æŸ¥
data["age"] = "twenty-five"  # è¿è¡Œæ—¶æ‰å‘ç°é”™è¯¯

# ğŸ˜± é—®é¢˜ 4ï¼šæ²¡æœ‰éªŒè¯
data["age"] = -5  # ä¸åˆç†çš„å€¼
```

---

### 3. OutputParser çš„ä¸‰å±‚ä»·å€¼

#### ä»·å€¼ 1ï¼šç±»å‹å®‰å…¨ï¼ˆType Safetyï¼‰

**é—®é¢˜**ï¼šå­—ç¬¦ä¸²æ²¡æœ‰ç±»å‹çº¦æŸï¼Œè¿è¡Œæ—¶æ‰å‘ç°é”™è¯¯

**è§£å†³**ï¼š

```python
from pydantic import BaseModel

class Person(BaseModel):
    name: str
    age: int  # ç±»å‹çº¦æŸ

# âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
person = Person(name="Alice", age=25)  # OK
person = Person(name="Alice", age="25")  # Pydantic è‡ªåŠ¨è½¬æ¢
person = Person(name="Alice", age="invalid")  # âŒ éªŒè¯é”™è¯¯
```

**ä»·å€¼**ï¼š
- åœ¨å¼€å‘é˜¶æ®µå‘ç°ç±»å‹é”™è¯¯ï¼ˆä¸æ˜¯è¿è¡Œæ—¶ï¼‰
- IDE æä¾›è‡ªåŠ¨è¡¥å…¨å’Œç±»å‹æç¤º
- å‡å°‘ bug å’Œè°ƒè¯•æ—¶é—´

#### ä»·å€¼ 2ï¼šæ•°æ®éªŒè¯ï¼ˆData Validationï¼‰

**é—®é¢˜**ï¼šLLM å¯èƒ½è¿”å›ä¸åˆç†çš„æ•°æ®

**è§£å†³**ï¼š

```python
from pydantic import BaseModel, Field

class Person(BaseModel):
    name: str = Field(min_length=1)  # éç©º
    age: int = Field(ge=0, le=150)   # 0-150 å²
    email: str = Field(pattern=r"^[\w\.-]+@[\w\.-]+\.\w+$")  # é‚®ç®±æ ¼å¼

# âœ… è‡ªåŠ¨éªŒè¯
person = Person(name="Alice", age=25, email="alice@example.com")  # OK
person = Person(name="", age=25, email="alice@example.com")  # âŒ åå­—ä¸ºç©º
person = Person(name="Alice", age=-5, email="alice@example.com")  # âŒ å¹´é¾„è´Ÿæ•°
person = Person(name="Alice", age=25, email="invalid")  # âŒ é‚®ç®±æ ¼å¼é”™è¯¯
```

**ä»·å€¼**ï¼š
- ç¡®ä¿æ•°æ®ç¬¦åˆä¸šåŠ¡è§„åˆ™
- é¿å…è„æ•°æ®è¿›å…¥ç³»ç»Ÿ
- å‡å°‘ä¸‹æ¸¸ç³»ç»Ÿçš„é”™è¯¯å¤„ç†è´Ÿæ‹…

#### ä»·å€¼ 3ï¼šåº”ç”¨é›†æˆï¼ˆApplication Integrationï¼‰

**é—®é¢˜**ï¼šå­—ç¬¦ä¸²æ— æ³•ç›´æ¥ç”¨äºæ•°æ®åº“ã€APIã€UI

**è§£å†³**ï¼š

```python
# âœ… æ•°æ®åº“é›†æˆ
person = structured_llm.invoke("Extract: Alice, 25")
database.save(person)  # ç›´æ¥ä¿å­˜å¯¹è±¡

# âœ… API é›†æˆ
response = requests.post("/api/users", json=person.dict())

# âœ… UI é›†æˆ
render_user_card(person)  # ç›´æ¥ä¼ é€’å¯¹è±¡

# âœ… ä¸šåŠ¡é€»è¾‘
if person.age >= 18:
    grant_access(person)
```

**ä»·å€¼**ï¼š
- æ— ç¼é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ
- å‡å°‘æ•°æ®è½¬æ¢ä»£ç 
- æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

---

### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ RAG åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. RAG ç³»ç»Ÿéœ€è¦ä»æ–‡æ¡£ä¸­æå–ä¿¡æ¯
   â†“
2. LLM å¯ä»¥ç†è§£æ–‡æ¡£å¹¶æå–ä¿¡æ¯
   â†“
3. ä½† LLM è¾“å‡ºæ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯ç»“æ„åŒ–æ•°æ®
   â†“
4. éœ€è¦ OutputParser å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºç»“æ„åŒ–å¯¹è±¡
   â†“
5. ç»“æ„åŒ–å¯¹è±¡å¯ä»¥å­˜å…¥å‘é‡æ•°æ®åº“ä½œä¸ºå…ƒæ•°æ®
   â†“
6. æ£€ç´¢æ—¶å¯ä»¥åŸºäºç»“æ„åŒ–å…ƒæ•°æ®è¿‡æ»¤å’Œæ’åº
   â†“
7. æœ€ç»ˆå®ç°ç²¾å‡†çš„è¯­ä¹‰æ£€ç´¢
```

**å…·ä½“ç¤ºä¾‹**ï¼š

```python
from pydantic import BaseModel
from typing import List

# 1. å®šä¹‰æ–‡æ¡£å…ƒæ•°æ®ç»“æ„
class DocumentMetadata(BaseModel):
    title: str
    author: str
    publish_date: str
    keywords: List[str]
    category: str

# 2. ä½¿ç”¨ OutputParser æå–å…ƒæ•°æ®
extractor = llm.with_structured_output(DocumentMetadata)
metadata = extractor.invoke(f"Extract metadata from: {document_text}")

# 3. å­˜å…¥å‘é‡æ•°æ®åº“
vector_store.add_documents(
    documents=[document_text],
    metadatas=[metadata.dict()]  # ç»“æ„åŒ–å…ƒæ•°æ®
)

# 4. åŸºäºå…ƒæ•°æ®æ£€ç´¢
results = vector_store.similarity_search(
    query="Python programming",
    filter={"category": "æŠ€æœ¯", "author": "Guido"}  # ç»“æ„åŒ–è¿‡æ»¤
)
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ¨ç†é“¾æˆç«‹ï¼Ÿ**

- **å‰æ 1**ï¼šRAG éœ€è¦ç²¾å‡†æ£€ç´¢ â†’ éœ€è¦å…ƒæ•°æ®
- **å‰æ 2**ï¼šLLM èƒ½æå–ä¿¡æ¯ â†’ ä½†è¾“å‡ºæ˜¯å­—ç¬¦ä¸²
- **å‰æ 3**ï¼šå‘é‡æ•°æ®åº“éœ€è¦ç»“æ„åŒ–å…ƒæ•°æ® â†’ ä¸èƒ½æ˜¯å­—ç¬¦ä¸²
- **ç»“è®º**ï¼šå¿…é¡»æœ‰ OutputParser åšç±»å‹è½¬æ¢

---

### 5. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ Agent åº”ç”¨

**æ¨ç†é“¾ï¼š**

```
1. Agent éœ€è¦è°ƒç”¨å·¥å…·ï¼ˆToolï¼‰å®Œæˆä»»åŠ¡
   â†“
2. å·¥å…·è¿”å›çš„æ˜¯åŸå§‹æ•°æ®ï¼ˆAPI å“åº”ã€æ•°æ®åº“æŸ¥è¯¢ç»“æœç­‰ï¼‰
   â†“
3. Agent éœ€è¦ç†è§£å·¥å…·è¿”å›çš„æ•°æ®æ‰èƒ½ç»§ç»­æ¨ç†
   â†“
4. ä½†å·¥å…·è¿”å›çš„æ•°æ®æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆJSONã€XMLã€çº¯æ–‡æœ¬ç­‰ï¼‰
   â†“
5. éœ€è¦ OutputParser å°†å·¥å…·è¿”å›å€¼æ ‡å‡†åŒ–ä¸ºç»“æ„åŒ–å¯¹è±¡
   â†“
6. Agent å¯ä»¥åŸºäºç»“æ„åŒ–å¯¹è±¡åšå†³ç­–
   â†“
7. æœ€ç»ˆå®ç°å¯é çš„å¤šæ­¥æ¨ç†
```

**å…·ä½“ç¤ºä¾‹**ï¼š

```python
from pydantic import BaseModel

# 1. å®šä¹‰å·¥å…·å“åº”ç»“æ„
class WeatherResponse(BaseModel):
    city: str
    temperature: float
    condition: str
    humidity: int

# 2. å·¥å…·è°ƒç”¨
def get_weather(city: str) -> str:
    # è°ƒç”¨å¤©æ°” API
    return '{"city": "åŒ—äº¬", "temperature": 15.5, "condition": "æ™´å¤©", "humidity": 60}'

# 3. ä½¿ç”¨ OutputParser è§£æå·¥å…·å“åº”
parser = llm.with_structured_output(WeatherResponse)
raw_response = get_weather("åŒ—äº¬")
weather = parser.invoke(f"Parse weather data: {raw_response}")

# 4. Agent åŸºäºç»“æ„åŒ–æ•°æ®åšå†³ç­–
if weather.temperature < 10:
    agent.decide("å»ºè®®ç©¿åšå¤–å¥—")
elif weather.condition == "é›¨å¤©":
    agent.decide("å»ºè®®å¸¦é›¨ä¼")
else:
    agent.decide("å¤©æ°”ä¸é”™ï¼Œé€‚åˆå‡ºè¡Œ")
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ¨ç†é“¾æˆç«‹ï¼Ÿ**

- **å‰æ 1**ï¼šAgent éœ€è¦å¤šæ­¥æ¨ç† â†’ éœ€è¦ç†è§£å·¥å…·è¿”å›å€¼
- **å‰æ 2**ï¼šå·¥å…·è¿”å›æ ¼å¼ä¸ç»Ÿä¸€ â†’ éš¾ä»¥ç›´æ¥ä½¿ç”¨
- **å‰æ 3**ï¼šå†³ç­–éœ€è¦ç»“æ„åŒ–æ•°æ® â†’ ä¸èƒ½æ˜¯å­—ç¬¦ä¸²
- **ç»“è®º**ï¼šå¿…é¡»æœ‰ OutputParser æ ‡å‡†åŒ–å·¥å…·å“åº”

---

### 6. 2025-2026 æŠ€æœ¯æ¼”è¿›çš„ç¬¬ä¸€æ€§åŸç†

**æ¼”è¿›è·¯å¾„**ï¼š

```
2024 å‰ï¼šæ‰‹åŠ¨è§£æ
   â†“ é—®é¢˜ï¼šå®¹æ˜“å‡ºé”™ã€ä»£ç å†—é•¿
2024-2025ï¼šPydanticOutputParser
   â†“ é—®é¢˜ï¼šéœ€è¦æ‰‹åŠ¨æ³¨å…¥æ ¼å¼æŒ‡ä»¤ã€é¢å¤– token æ¶ˆè€—
2025-2026ï¼šwith_structured_output()
   â†“ ä¼˜åŠ¿ï¼šåˆ©ç”¨æ¨¡å‹åŸç”Ÿèƒ½åŠ›ã€æ›´å¯é ã€æ›´é«˜æ•ˆ
æœªæ¥ï¼šæ›´å¤šæ¨¡å‹æ”¯æŒåŸç”Ÿç»“æ„åŒ–è¾“å‡º
```

**ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªæ¼”è¿›ï¼Ÿ**

**ç¬¬ä¸€æ€§åŸç†åˆ†æ**ï¼š

1. **æ ¹æœ¬éœ€æ±‚**ï¼šåº”ç”¨éœ€è¦ç»“æ„åŒ–æ•°æ®ï¼ˆä¸å˜ï¼‰
2. **æŠ€æœ¯çº¦æŸ**ï¼šLLM åªèƒ½è¾“å‡ºæ–‡æœ¬ï¼ˆé€æ¸æ”¹å˜ï¼‰
3. **è§£å†³æ–¹æ¡ˆæ¼”è¿›**ï¼š
   - **é˜¶æ®µ 1**ï¼šåœ¨åº”ç”¨å±‚è§£æï¼ˆæ‰‹åŠ¨ JSON.parseï¼‰
   - **é˜¶æ®µ 2**ï¼šåœ¨ Prompt å±‚æŒ‡å¯¼ï¼ˆPydanticOutputParserï¼‰
   - **é˜¶æ®µ 3**ï¼šåœ¨æ¨¡å‹å±‚åŸç”Ÿæ”¯æŒï¼ˆwith_structured_outputï¼‰

**ä¸ºä»€ä¹ˆé˜¶æ®µ 3 æ›´å¥½ï¼Ÿ**

- **æ›´å¯é **ï¼šæ¨¡å‹è®­ç»ƒæ—¶å°±ä¼˜åŒ–äº†ç»“æ„åŒ–è¾“å‡º
- **æ›´é«˜æ•ˆ**ï¼šä¸éœ€è¦é¢å¤–çš„æ ¼å¼æŒ‡ä»¤ï¼ˆèŠ‚çœ tokenï¼‰
- **æ›´ç®€å•**ï¼šAPI æ›´ç®€æ´ï¼Œå¼€å‘ä½“éªŒæ›´å¥½

**æ¨ç†**ï¼š

```
å¦‚æœæ¨¡å‹åŸç”Ÿæ”¯æŒç»“æ„åŒ–è¾“å‡º
   â†“
é‚£ä¹ˆåœ¨ Prompt ä¸­æ³¨å…¥æ ¼å¼æŒ‡ä»¤å°±æ˜¯å¤šä½™çš„
   â†“
åº”è¯¥ç›´æ¥ä½¿ç”¨æ¨¡å‹çš„åŸç”Ÿèƒ½åŠ›
   â†“
with_structured_output() æˆä¸ºæœ€ä½³å®è·µ
```

---

### 7. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**OutputParser æ˜¯è§£å†³"LLM è¾“å‡ºå­—ç¬¦ä¸²"ä¸"åº”ç”¨éœ€æ±‚ç»“æ„åŒ–æ•°æ®"è¿™ä¸€æ ¹æœ¬çŸ›ç›¾çš„ç±»å‹è½¬æ¢å™¨ï¼Œé€šè¿‡ç±»å‹å®‰å…¨ã€æ•°æ®éªŒè¯å’Œåº”ç”¨é›†æˆä¸‰å±‚ä»·å€¼ï¼Œä½¿ AI è¾“å‡ºèƒ½å¤Ÿæ— ç¼é›†æˆåˆ°ç”Ÿäº§ç³»ç»Ÿä¸­ï¼Œ2025-2026 å¹´æŠ€æœ¯æ¼”è¿›çš„æ–¹å‘æ˜¯åˆ©ç”¨æ¨¡å‹åŸç”Ÿèƒ½åŠ›ï¼ˆwith_structured_outputï¼‰æ›¿ä»£åº”ç”¨å±‚è§£æï¼ˆPydanticOutputParserï¼‰ï¼Œä»è€Œå®ç°æ›´å¯é ã€æ›´é«˜æ•ˆã€æ›´ç®€æ´çš„ç»“æ„åŒ–è¾“å‡ºã€‚**

---

## ä»ç¬¬ä¸€æ€§åŸç†æ€è€ƒçš„å¯ç¤º

### å¯ç¤º 1ï¼šä¼˜å…ˆä½¿ç”¨æ¨¡å‹åŸç”Ÿèƒ½åŠ›

å¦‚æœæ¨¡å‹æ”¯æŒåŸç”Ÿç»“æ„åŒ–è¾“å‡ºï¼Œå°±ä¸è¦ç”¨ä¼ ç»Ÿ OutputParserã€‚

**åŸå› **ï¼šæ¨¡å‹å±‚çš„è§£å†³æ–¹æ¡ˆæ¯”åº”ç”¨å±‚æ›´å¯é ã€‚

### å¯ç¤º 2ï¼šç±»å‹å®‰å…¨æ˜¯æ ¸å¿ƒä»·å€¼

OutputParser çš„æ ¸å¿ƒä¸æ˜¯"è§£æ"ï¼Œè€Œæ˜¯"ç±»å‹è½¬æ¢ + éªŒè¯"ã€‚

**åŸå› **ï¼šå­—ç¬¦ä¸² â†’ å¯¹è±¡çš„è½¬æ¢åªæ˜¯æ‰‹æ®µï¼Œç±»å‹å®‰å…¨æ‰æ˜¯ç›®çš„ã€‚

### å¯ç¤º 3ï¼šéªŒè¯åº”è¯¥åœ¨è¾¹ç•Œè¿›è¡Œ

ä¸è¦åœ¨åº”ç”¨å†…éƒ¨åˆ°å¤„éªŒè¯æ•°æ®ï¼Œåº”è¯¥åœ¨ LLM è¾“å‡ºè¾¹ç•Œå°±å®ŒæˆéªŒè¯ã€‚

**åŸå› **ï¼šè¶Šæ—©å‘ç°é”™è¯¯ï¼Œä¿®å¤æˆæœ¬è¶Šä½ã€‚

### å¯ç¤º 4ï¼šç»“æ„åŒ–è¾“å‡ºæ˜¯ AI åº”ç”¨çš„åŸºç¡€è®¾æ–½

æ²¡æœ‰ç»“æ„åŒ–è¾“å‡ºï¼ŒAI åº”ç”¨åªèƒ½åœç•™åœ¨ Demo é˜¶æ®µã€‚

**åŸå› **ï¼šç”Ÿäº§ç³»ç»Ÿéœ€è¦å¯é çš„æ•°æ®æµï¼Œä¸èƒ½ä¾èµ–å­—ç¬¦ä¸²è§£æã€‚

---

**è®°ä½**ï¼šä»ç¬¬ä¸€æ€§åŸç†æ€è€ƒï¼ŒOutputParser ä¸æ˜¯å¯é€‰çš„"é”¦ä¸Šæ·»èŠ±"ï¼Œè€Œæ˜¯ AI åº”ç”¨ä» Demo åˆ°ç”Ÿäº§çš„**å¿…ç»ä¹‹è·¯**ã€‚
