# 实战代码3：RAG 检索集成

完整的 RAG + Pydantic 集成示例，展示文档检索和语义搜索的数据验证。

---

## 场景说明

构建一个 RAG 文档检索 API，包含文档上传、向量化、语义搜索等功能。

---

## 完整代码

```python
"""
RAG + Pydantic 集成示例
演示：文档检索 API
"""

from fastapi import FastAPI, HTTPException, UploadFile, File
from pydantic import BaseModel, Field, field_validator
from typing import List, Optional, Dict, Any
from datetime import datetime
import hashlib

app = FastAPI(title="RAG Search API", version="1.0.0")

# ===== Pydantic 模型定义 =====

class Document(BaseModel):
    """文档模型"""
    id: str = Field(..., description="文档ID")
    content: str = Field(..., min_length=1, description="文档内容")
    metadata: Dict[str, Any] = Field(default_factory=dict, description="元数据")
    created_at: datetime = Field(default_factory=datetime.now)

    @field_validator('content')
    @classmethod
    def content_not_empty(cls, v):
        if not v.strip():
            raise ValueError('content cannot be empty')
        return v.strip()


class SearchRequest(BaseModel):
    """检索请求模型"""
    query: str = Field(..., min_length=1, max_length=1000, description="查询文本")
    top_k: int = Field(5, ge=1, le=20, description="返回结果数量")
    score_threshold: float = Field(0.7, ge=0, le=1, description="相似度阈值")
    filters: Optional[Dict[str, Any]] = Field(None, description="过滤条件")

    @field_validator('query')
    @classmethod
    def query_not_empty(cls, v):
        if not v.strip():
            raise ValueError('query cannot be empty')
        return v.strip()


class SearchResult(BaseModel):
    """检索结果模型"""
    document_id: str
    content: str
    score: float = Field(..., ge=0, le=1)
    metadata: Dict[str, Any]


class SearchResponse(BaseModel):
    """检索响应模型"""
    query: str
    results: List[SearchResult]
    total: int
    took_ms: float


# ===== 模拟向量存储 =====

class VectorStore:
    """模拟向量存储"""
    def __init__(self):
        self.documents: Dict[str, Document] = {}

    def add_document(self, doc: Document):
        self.documents[doc.id] = doc

    def search(self, query: str, top_k: int, threshold: float) -> List[SearchResult]:
        # 模拟检索（实际项目中使用向量相似度）
        results = []
        for doc_id, doc in list(self.documents.items())[:top_k]:
            results.append(SearchResult(
                document_id=doc.id,
                content=doc.content,
                score=0.85,
                metadata=doc.metadata
            ))
        return results


vector_store = VectorStore()


# ===== API 端点 =====

@app.post("/documents", response_model=Document)
async def upload_document(
    content: str = Field(..., min_length=1),
    metadata: Optional[Dict[str, Any]] = None
):
    """上传文档"""
    doc_id = hashlib.md5(content.encode()).hexdigest()
    doc = Document(
        id=doc_id,
        content=content,
        metadata=metadata or {}
    )
    vector_store.add_document(doc)
    return doc


@app.post("/search", response_model=SearchResponse)
async def search(request: SearchRequest):
    """检索文档"""
    import time
    start = time.time()

    results = vector_store.search(
        query=request.query,
        top_k=request.top_k,
        threshold=request.score_threshold
    )

    # 应用过滤器
    if request.filters:
        results = [r for r in results if all(
            r.metadata.get(k) == v for k, v in request.filters.items()
        )]

    took_ms = (time.time() - start) * 1000

    return SearchResponse(
        query=request.query,
        results=results,
        total=len(results),
        took_ms=took_ms
    )


if __name__ == "__main__":
    import uvicorn
    print("RAG 检索 API 启动")
    print("文档: http://localhost:8000/docs")
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

---

## 测试示例

**上传文档：**
```bash
curl -X POST "http://localhost:8000/documents" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "Pydantic 是 Python 的数据验证库",
    "metadata": {"category": "tutorial"}
  }'
```

**检索文档：**
```bash
curl -X POST "http://localhost:8000/search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "什么是 Pydantic",
    "top_k": 5,
    "score_threshold": 0.7
  }'
```

---

## 核心要点

1. **复杂验证**：query 长度、top_k 范围、score 阈值
2. **嵌套模型**：SearchResponse 包含 List[SearchResult]
3. **自定义验证器**：确保 query 和 content 不为空
4. **元数据处理**：灵活的 Dict[str, Any] 类型

---

**版本：** v1.0
**最后更新：** 2026-02-11
