# JWT认证 - 概览

## 为什么 AI Agent API 需要 JWT 认证？

在构建 AI Agent 后端服务时，你会面临这些问题：

1. **如何识别用户身份？** 每个 API 请求都需要知道是谁在调用
2. **如何保护敏感端点？** AI Agent 的对话历史、配置信息不能被随意访问
3. **如何实现权限控制？** 不同用户可能有不同的 Agent 使用权限
4. **如何支持跨域访问？** 前端、移动端、第三方服务都需要调用 API
5. **如何避免服务端压力？** Session 存储会增加服务器负担

**JWT（JSON Web Token）** 就是为了解决这些问题而设计的现代认证方案。

---

## JWT 在 AI Agent 开发中的作用

### 场景1：保护 AI Agent 对话端点

```python
# 没有认证：任何人都能调用
@app.post("/agent/chat")
async def chat(message: str):
    return await agent.run(message)  # ❌ 不安全

# 使用 JWT 认证：只有登录用户能调用
@app.post("/agent/chat")
async def chat(
    message: str,
    current_user: User = Depends(get_current_user)  # ✅ JWT 验证
):
    return await agent.run(message, user_id=current_user.id)
```

### 场景2：实现用户级别的对话隔离

```python
# 每个用户只能访问自己的对话历史
@app.get("/agent/history")
async def get_history(current_user: User = Depends(get_current_user)):
    # JWT 中包含 user_id，自动隔离数据
    return await db.get_conversations(user_id=current_user.id)
```

### 场景3：权限控制（RBAC）

```python
# 只有管理员能访问系统配置
@app.get("/admin/config")
async def get_config(
    current_user: User = Depends(require_role("admin"))  # ✅ 基于 JWT 的角色检查
):
    return system_config
```

---

## 学习路线图

本知识点包含以下内容：

### 基础维度（快速理解）

1. **30字核心** - 一句话理解 JWT
2. **第一性原理** - 从根本理解为什么需要 JWT
3. **最小可用** - 20%核心知识快速上手
4. **双重类比** - 用前端和日常生活理解 JWT
5. **反直觉点** - 避开常见误区
6. **一句话总结** - 最终总结

### 核心概念（深入理解）

7. **JWT结构与编码** - Header、Payload、Signature 三部分
8. **签名与验证机制** - HMAC-SHA256 签名原理
9. **认证流程设计** - 登录、刷新、登出完整流程

### 实战代码（动手实践）

10. **基础JWT生成与验证** - 使用 python-jose 库
11. **用户登录注册** - 密码哈希与验证
12. **Token刷新机制** - Access Token + Refresh Token
13. **依赖注入保护路由** - FastAPI 依赖注入
14. **RBAC权限控制** - 角色和权限管理
15. **手写JWT实现** - 从零实现 JWT 编码器
16. **生产级最佳实践** - 安全策略和错误处理
17. **完整AI Agent API** - 端到端项目示例

### 面试与进阶

18. **面试必问** - 高频面试题和出彩回答
19. **化骨绵掌** - 10个2分钟知识卡片

---

## 与其他 Phase5 知识点的关系

```
Phase5_生产级实践
├── 01_JWT认证 ⭐ 你在这里
│   └── 为 API 提供身份验证和访问控制
│
├── 02_结构化日志
│   └── 记录认证失败、Token 过期等安全事件
│
├── 03_Redis缓存
│   └── 存储 Token 黑名单、用户会话信息
│
├── 04_限流中间件
│   └── 防止暴力破解登录端点
│
├── 05_错误处理策略
│   └── 统一处理认证失败、权限不足等错误
│
├── 06_长任务处理
│   └── 后台任务也需要用户身份信息
│
└── 07_测试与质量保证
    └── 测试认证流程和权限控制
```

**学习建议：**
- JWT 认证是生产级 API 的基础，建议优先学习
- 学完后可以结合 Redis 实现 Token 黑名单
- 配合限流中间件防止登录接口被攻击

---

## 前置知识

在学习 JWT 认证前，你应该掌握：

- ✅ **FastAPI 路由与依赖注入**（Phase2）
- ✅ **SQLAlchemy ORM 基础**（Phase3）
- ✅ **Pydantic 数据验证**（Phase1）
- ✅ **异步编程 asyncio**（Phase1）

如果还没掌握，建议先学习这些知识点。

---

## 学习目标

学完本知识点后，你将能够：

- ✅ 理解 JWT 的工作原理和三部分结构
- ✅ 使用 python-jose 生成和验证 JWT
- ✅ 实现用户注册、登录、登出流程
- ✅ 使用 FastAPI 依赖注入保护路由
- ✅ 实现 Access Token + Refresh Token 机制
- ✅ 设计基于角色的权限控制（RBAC）
- ✅ 从零手写 JWT 编码器和解码器
- ✅ 掌握 JWT 的安全最佳实践
- ✅ 构建完整的 AI Agent 认证系统

---

## 快速开始

如果你想快速上手，可以按以下顺序学习：

1. **30字核心** - 1分钟理解 JWT 是什么
2. **最小可用** - 10分钟掌握核心用法
3. **实战代码_01_基础JWT生成与验证** - 20分钟写出第一个认证端点
4. **实战代码_04_依赖注入保护路由** - 20分钟保护你的 API

**总计：约50分钟即可上手 JWT 认证**

---

## 推荐学习路径

### 路径1：快速实战（适合赶项目）
```
30字核心 → 最小可用 → 实战代码_01 → 实战代码_04
```

### 路径2：深入理解（适合面试准备）
```
30字核心 → 第一性原理 → 核心概念（3个）→ 面试必问
```

### 路径3：完整掌握（适合系统学习）
```
按文档顺序学习所有内容（约4-6小时）
```

---

## 常见问题

### Q1: JWT 和 Session 有什么区别？

**简单回答：**
- Session：服务端存储会话信息，客户端只存 Session ID
- JWT：客户端存储所有信息，服务端无状态验证

**详细对比见：** 第一性原理、双重类比

### Q2: JWT 安全吗？

**关键点：**
- ✅ JWT 本身是安全的（通过签名防篡改）
- ❌ 但存储方式可能不安全（localStorage 容易被 XSS 攻击）
- ✅ 推荐存储在 HttpOnly Cookie 中

**详细说明见：** 反直觉点、生产级最佳实践

### Q3: JWT 可以撤销吗？

**答案：**
- JWT 本身不支持撤销（无状态设计）
- 但可以通过 Token 黑名单实现撤销（需要 Redis）

**详细实现见：** 核心概念_03_认证流程设计、实战代码_07_生产级最佳实践

### Q4: Access Token 和 Refresh Token 有什么区别？

**简单回答：**
- Access Token：短期有效（15分钟），用于 API 调用
- Refresh Token：长期有效（7天），用于刷新 Access Token

**详细实现见：** 实战代码_03_Token刷新机制

---

## 实战项目预览

学完本知识点后，你将能构建这样的 AI Agent API：

```python
# app/main.py
from fastapi import FastAPI, Depends
from app.core.auth import get_current_user, require_role
from app.models.user import User

app = FastAPI()

# 公开端点：注册和登录
@app.post("/auth/register")
async def register(email: str, password: str):
    # 创建用户，返回 JWT
    pass

@app.post("/auth/login")
async def login(email: str, password: str):
    # 验证密码，返回 JWT
    pass

# 受保护端点：需要登录
@app.post("/agent/chat")
async def chat(
    message: str,
    current_user: User = Depends(get_current_user)
):
    # 只有登录用户能调用
    return await agent.run(message, user_id=current_user.id)

# 管理员端点：需要特定角色
@app.get("/admin/users")
async def list_users(
    current_user: User = Depends(require_role("admin"))
):
    # 只有管理员能访问
    return await db.get_all_users()
```

---

## 学习检查清单

在开始学习前，确认你已经：

- [ ] 安装了 Python 3.13+
- [ ] 安装了 FastAPI 和 uvicorn
- [ ] 了解 HTTP 请求和响应
- [ ] 了解 FastAPI 路由和依赖注入
- [ ] 了解 SQLAlchemy ORM 基础

学习过程中，确保你能：

- [ ] 解释 JWT 的三部分结构
- [ ] 手动生成和验证 JWT
- [ ] 实现用户注册和登录
- [ ] 使用依赖注入保护路由
- [ ] 实现 Token 刷新机制
- [ ] 设计 RBAC 权限系统
- [ ] 从零手写 JWT 实现
- [ ] 掌握 JWT 安全最佳实践

---

## 下一步

准备好了吗？让我们从 **30字核心** 开始，快速理解 JWT 的本质！

或者，如果你想快速上手，可以直接跳到 **最小可用** 章节。
