# 数据库迁移 Alembic - 概览

**Alembic 是 SQLAlchemy 的数据库迁移工具，通过版本化的 Python 脚本管理数据库 schema 变更，确保团队协作中的数据库一致性。**

---

## 文档结构

本知识点包含10个维度，帮助你全面掌握 Alembic：

### 基础维度

1. **[30字核心](./01_30字核心.md)** - 一句话理解 Alembic 的本质
2. **[第一性原理](./02_第一性原理.md)** - 从根本问题出发理解为什么需要 Alembic
3. **[最小可用](./04_最小可用.md)** - 20%核心知识解决80%问题
4. **[双重类比](./05_双重类比.md)** - 前端开发类比 + 日常生活类比
5. **[反直觉点](./06_反直觉点.md)** - 3个最常见的误区
6. **[一句话总结](./10_一句话总结.md)** - 完整总结 Alembic

### 核心概念（3个独立文件）

7. **[核心概念1：迁移文件结构](./03_核心概念_01_迁移文件结构.md)**
   - 迁移文件的生成方式（autogenerate vs 手动创建）
   - 迁移文件的结构详解（revision、upgrade、downgrade）
   - 常用的 op.* 操作（表、列、索引、约束）
   - 迁移文件的命名规范和存放位置

8. **[核心概念2：版本控制机制](./03_核心概念_02_版本控制机制.md)**
   - alembic_version 表的作用和原理
   - 线性版本链的数据结构
   - 版本标识符（Revision ID）的生成
   - 版本指针（head、base、current）
   - 版本链的分支与合并

9. **[核心概念3：自动生成与手动编辑](./03_核心概念_03_自动生成与手动编辑.md)**
   - autogenerate 的工作原理（4个步骤）
   - autogenerate 能检测的变更（表、列、索引、外键）
   - autogenerate 无法检测的变更（重命名、约束、特殊类型）
   - 手动编辑迁移脚本的最佳实践
   - 自定义 autogenerate 行为

### 实战代码（3个场景文件）

10. **[实战代码1：基础迁移操作](./07_实战代码_01_基础迁移操作.md)**
    - 项目初始化和配置
    - 创建第一个迁移
    - 应用迁移到数据库
    - 添加新字段和回滚迁移
    - 查看迁移历史

11. **[实战代码2：数据迁移与复杂变更](./07_实战代码_02_数据迁移与复杂变更.md)**
    - 字段重命名（保留数据）
    - 字段类型转换（带数据迁移）
    - 合并字段（数据迁移）
    - 添加外键关系
    - 批量数据迁移（使用 ORM）
    - 添加向量存储字段（pgvector）
    - 添加全文搜索索引

12. **[实战代码3：生产环境部署与 CI/CD](./07_实战代码_03_生产环境部署.md)**
    - Docker 容器化
    - GitHub Actions CI/CD
    - 零停机迁移策略
    - 生产环境迁移脚本
    - 回滚策略
    - 健康检查端点

### 进阶维度

13. **[面试必问](./08_面试必问.md)** - 4个高频面试问题及出彩回答
14. **[化骨绵掌](./09_化骨绵掌.md)** - 10个2分钟知识卡片

---

## 快速导航

### 我是初学者，从哪里开始？

**推荐学习路径：**
1. 阅读 [30字核心](./01_30字核心.md) - 快速理解 Alembic 是什么
2. 阅读 [第一性原理](./02_第一性原理.md) - 理解为什么需要 Alembic
3. 阅读 [最小可用](./04_最小可用.md) - 掌握5个核心操作
4. 实践 [实战代码1](./07_实战代码_01_基础迁移操作.md) - 动手操作

**预计学习时间：** 1-2小时

### 我想快速上手，有速查表吗？

**常用命令速查：**

```bash
# 初始化
alembic init alembic

# 生成迁移
alembic revision --autogenerate -m "描述"

# 应用迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1

# 查看当前版本
alembic current

# 查看历史
alembic history
```

详见 [最小可用](./04_最小可用.md) 的命令速查表。

### 我遇到了具体问题，如何快速找到答案？

**常见问题索引：**

| 问题 | 查看章节 |
|------|---------|
| autogenerate 没有检测到变更 | [核心概念3](./03_核心概念_03_自动生成与手动编辑.md) |
| 如何重命名字段而不丢失数据 | [实战代码2](./07_实战代码_02_数据迁移与复杂变更.md) - 场景1 |
| 如何修改字段类型 | [实战代码2](./07_实战代码_02_数据迁移与复杂变更.md) - 场景2 |
| 多人协作时的迁移冲突 | [核心概念2](./03_核心概念_02_版本控制机制.md) - 版本链的分支与合并 |
| 生产环境如何安全迁移 | [实战代码3](./07_实战代码_03_生产环境部署.md) |
| 如何实现零停机迁移 | [实战代码3](./07_实战代码_03_生产环境部署.md) - 零停机迁移策略 |
| 迁移失败如何回滚 | [实战代码3](./07_实战代码_03_生产环境部署.md) - 回滚策略 |

### 我要准备面试，重点看什么？

**面试重点：**
1. [面试必问](./08_面试必问.md) - 4个高频问题及出彩回答
2. [反直觉点](./06_反直觉点.md) - 3个常见误区
3. [化骨绵掌](./09_化骨绵掌.md) - 10个核心概念卡片

**核心考点：**
- Alembic 的工作原理（版本链、alembic_version 表）
- autogenerate 的限制和手动编辑
- 生产环境迁移的安全策略
- 多分支开发中的冲突处理

---

## 核心概念速览

### 1. Alembic 是什么？

**Alembic = 数据库的 Git**

就像 Git 管理代码变更，Alembic 管理数据库 schema 变更：
- Git commit = Alembic revision（创建版本）
- Git log = Alembic history（查看历史）
- Git checkout = Alembic upgrade/downgrade（切换版本）

### 2. 核心机制

**版本控制三要素：**

1. **alembic_version 表**：单行单列，存储当前数据库版本号
2. **版本链**：线性链表，每个迁移指向父迁移
3. **迁移脚本**：包含 upgrade（正向）和 downgrade（反向）函数

```python
# 版本链示例
None -> abc123 -> def456 -> ghi789 -> head
        ↑        ↑        ↑
      版本1    版本2    版本3

# alembic_version 表
SELECT * FROM alembic_version;
-- version_num
-- -----------
-- ghi789
```

### 3. 工作流程

```bash
# 1. 修改 SQLAlchemy 模型
class User(Base):
    avatar = Column(String)  # 新增字段

# 2. 生成迁移脚本
alembic revision --autogenerate -m "add avatar"

# 3. 检查生成的脚本
cat alembic/versions/abc123_add_avatar.py

# 4. 应用迁移
alembic upgrade head

# 5. 验证
alembic current
```

### 4. 关键特性

| 特性 | 说明 | 类比 |
|------|------|------|
| 版本化 | 每个变更都有唯一版本号 | Git commit hash |
| 可追溯 | 可以查看完整的变更历史 | Git log |
| 可回滚 | 可以回退到之前的版本 | Git revert |
| 自动生成 | autogenerate 自动检测变更 | TypeScript 类型推断 |
| 团队协作 | 通过版本链管理多人协作 | Git 分支合并 |

---

## 在 AI Agent 后端开发中的应用

### 典型场景

**场景1：添加对话历史表**
```python
# 1. 定义模型
class Conversation(Base):
    __tablename__ = "conversations"
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    title = Column(String)

# 2. 生成迁移
alembic revision --autogenerate -m "add conversations table"

# 3. 应用迁移
alembic upgrade head
```

**场景2：添加向量存储字段**
```python
# 1. 定义模型（使用 pgvector）
from pgvector.sqlalchemy import Vector

class Document(Base):
    embedding = Column(Vector(1536))  # OpenAI embedding

# 2. 手动创建迁移（autogenerate 无法识别）
alembic revision -m "add embedding"

# 3. 手动编写迁移脚本
def upgrade():
    op.execute("CREATE EXTENSION IF NOT EXISTS vector")
    op.add_column('documents', sa.Column('embedding', Vector(1536)))
```

**场景3：生产环境部署**
```yaml
# CI/CD 自动化
- name: Run migrations
  run: alembic upgrade head

- name: Verify
  run: alembic current
```

---

## 学习检查清单

完成本知识点后，你应该能够：

### 基础能力
- [ ] 理解 Alembic 的核心概念（版本链、alembic_version 表）
- [ ] 初始化 Alembic 项目并配置数据库连接
- [ ] 使用 autogenerate 生成迁移脚本
- [ ] 应用迁移到数据库（upgrade）
- [ ] 回滚迁移（downgrade）
- [ ] 查看迁移历史和当前版本

### 进阶能力
- [ ] 理解 autogenerate 的限制，能手动编辑迁移脚本
- [ ] 处理字段重命名、类型转换等复杂变更
- [ ] 编写数据迁移逻辑（修改现有数据）
- [ ] 处理多分支开发中的迁移冲突
- [ ] 为特殊类型（pgvector、全文搜索）编写迁移

### 生产能力
- [ ] 在生产环境安全地执行迁移（备份、验证、监控）
- [ ] 实现零停机迁移策略
- [ ] 集成 CI/CD 自动化迁移流程
- [ ] 处理迁移失败和回滚
- [ ] 建立迁移的监控和告警机制

---

## 常见误区

### ❌ 误区1：autogenerate 能检测所有变更
**正确理解：** autogenerate 只能检测基本变更（表、列、索引），无法检测重命名、约束、特殊类型。

### ❌ 误区2：迁移脚本可以随意修改
**正确理解：** 已应用的迁移脚本不能修改，只能创建新迁移。

### ❌ 误区3：downgrade 总是安全的
**正确理解：** 涉及数据删除的回滚不安全，数据无法恢复。

详见 [反直觉点](./06_反直觉点.md)。

---

## 最佳实践

### 开发流程
1. **修改模型** → 定义 SQLAlchemy 模型
2. **生成迁移** → `alembic revision --autogenerate`
3. **检查脚本** → 人工检查生成的迁移脚本
4. **测试迁移** → 在开发环境测试
5. **提交代码** → 将迁移脚本提交到 Git
6. **应用迁移** → 在测试/生产环境应用

### 团队协作
1. **频繁同步** → 经常 pull main 分支
2. **一个 PR 一个迁移** → 避免冲突
3. **尽早合并** → 迁移脚本尽快合并到 main
4. **使用 pre-commit hook** → 自动检查迁移脚本

### 生产环境
1. **备份数据库** → 迁移前必须备份
2. **在测试环境验证** → 先在测试环境测试
3. **预览 SQL** → 使用 `--sql` 预览变更
4. **低峰期执行** → 选择低峰期执行迁移
5. **监控验证** → 执行后验证数据库状态

---

## 与其他工具对比

| 工具 | 语言 | 框架绑定 | 自动生成 | 适用场景 |
|------|------|---------|---------|---------|
| **Alembic** | Python | SQLAlchemy | ✅ | FastAPI/Flask 项目 |
| Django Migrations | Python | Django ORM | ✅ | Django 项目 |
| Prisma Migrate | TypeScript | Prisma | ✅ | Node.js 项目 |
| Flyway | Java/SQL | 无 | ❌ | 企业级 Java 项目 |
| Liquibase | Java/SQL | 无 | ❌ | 企业级多数据库项目 |

**Alembic 的优势：**
- ✅ SQLAlchemy 官方工具，集成度高
- ✅ 支持 autogenerate，减少手写
- ✅ Python 代码，灵活性强
- ✅ 支持复杂的数据迁移逻辑

---

## 参考资源

### 官方文档
- [Alembic 官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 官方文档](https://www.sqlalchemy.org/)

### 推荐阅读
- [Alembic Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)
- [Auto Generating Migrations](https://alembic.sqlalchemy.org/en/latest/autogenerate.html)
- [Cookbook](https://alembic.sqlalchemy.org/en/latest/cookbook.html)

### 相关知识点
- **前置知识**：SQLAlchemy ORM 基础、Session 管理
- **后续学习**：连接池配置、向量检索 pgvector
- **相关技能**：Docker 容器化、CI/CD 集成

---

## 版本信息

**文档版本：** v1.0
**最后更新：** 2026-02-11
**适用版本：** Alembic 1.13+, SQLAlchemy 2.0+, Python 3.13+
**维护者：** Claude Code

---

## 开始学习

**推荐学习顺序：**

1. **快速入门（1小时）**
   - [30字核心](./01_30字核心.md)
   - [第一性原理](./02_第一性原理.md)
   - [最小可用](./04_最小可用.md)

2. **核心概念（2小时）**
   - [核心概念1：迁移文件结构](./03_核心概念_01_迁移文件结构.md)
   - [核心概念2：版本控制机制](./03_核心概念_02_版本控制机制.md)
   - [核心概念3：自动生成与手动编辑](./03_核心概念_03_自动生成与手动编辑.md)

3. **实战练习（3小时）**
   - [实战代码1：基础迁移操作](./07_实战代码_01_基础迁移操作.md)
   - [实战代码2：数据迁移与复杂变更](./07_实战代码_02_数据迁移与复杂变更.md)
   - [实战代码3：生产环境部署](./07_实战代码_03_生产环境部署.md)

4. **深入理解（1小时）**
   - [双重类比](./05_双重类比.md)
   - [反直觉点](./06_反直觉点.md)
   - [化骨绵掌](./09_化骨绵掌.md)

5. **面试准备（30分钟）**
   - [面试必问](./08_面试必问.md)

**总计学习时间：** 约7.5小时

---

**记住：**
> Alembic 是数据库的 Git，用版本化的 Python 脚本管理数据库变更，核心是 alembic_version 表 + 线性版本链 + upgrade/downgrade 双向迁移。

**开始学习 →** [30字核心](./01_30字核心.md)
