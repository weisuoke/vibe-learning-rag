# 实战代码 - 场景1：基础迁移操作

**本场景演示 Alembic 的基础迁移操作，包括初始化、创建迁移、应用迁移、回滚等核心流程。**

---

## 场景概述

**目标：** 从零开始搭建一个 AI Agent 后端项目，使用 Alembic 管理数据库迁移。

**技术栈：**
- Python 3.13+
- FastAPI
- SQLAlchemy 2.0
- PostgreSQL 14+
- Alembic

---

## 完整代码示例

### 1. 项目初始化

```bash
# 创建项目目录
mkdir ai-agent-api && cd ai-agent-api

# 初始化 Python 项目
uv init

# 安装依赖
uv add fastapi uvicorn sqlalchemy psycopg2-binary alembic python-dotenv

# 创建项目结构
mkdir -p app/{api,models,core}
touch app/__init__.py
touch app/main.py
```

### 2. 配置数据库连接

```python
# app/core/config.py
"""
应用配置
"""
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    """应用配置"""
    # 数据库配置
    DATABASE_URL: str = "postgresql://user:password@localhost:5432/ai_agent_db"

    # 应用配置
    APP_NAME: str = "AI Agent API"
    DEBUG: bool = True

    class Config:
        env_file = ".env"

settings = Settings()
```

```python
# app/core/database.py
"""
数据库连接配置
"""
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

from app.core.config import settings

# 创建数据库引擎
engine = create_engine(
    settings.DATABASE_URL,
    echo=settings.DEBUG,  # 开发环境打印 SQL
    pool_pre_ping=True,   # 连接池健康检查
)

# 创建会话工厂
SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)

# 创建 Base 类（所有模型的基类）
Base = declarative_base()

# 依赖注入：获取数据库会话
def get_db():
    """获取数据库会话"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 3. 定义数据模型

```python
# app/models/user.py
"""
用户模型
"""
from sqlalchemy import Column, Integer, String, DateTime
from datetime import datetime

from app.core.database import Base

class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    username = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    def __repr__(self):
        return f"<User(id={self.id}, email={self.email})>"
```

### 4. 初始化 Alembic

```bash
# 初始化 Alembic
alembic init alembic

# 生成的目录结构：
# alembic/
# ├── env.py           # 环境配置
# ├── script.py.mako   # 迁移脚本模板
# └── versions/        # 迁移脚本目录
# alembic.ini          # Alembic 配置文件
```

### 5. 配置 Alembic

```ini
# alembic.ini
[alembic]
# 迁移脚本位置
script_location = alembic

# 数据库连接（从环境变量读取）
# sqlalchemy.url = driver://user:pass@localhost/dbname
# 注意：这里注释掉，在 env.py 中动态设置

# 其他配置
file_template = %%(year)d%%(month).2d%%(day).2d_%%(hour).2d%%(minute).2d_%%(rev)s_%%(slug)s
```

```python
# alembic/env.py
"""
Alembic 环境配置
"""
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context

# 导入配置和模型
from app.core.config import settings
from app.core.database import Base
from app.models.user import User  # 导入所有模型

# Alembic Config 对象
config = context.config

# 设置数据库 URL（从环境变量读取）
config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)

# 配置日志
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# 设置 target_metadata（用于 autogenerate）
target_metadata = Base.metadata

def run_migrations_offline() -> None:
    """离线模式：生成 SQL 脚本"""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()

def run_migrations_online() -> None:
    """在线模式：连接数据库执行迁移"""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True,  # 比较列类型
            compare_server_default=True,  # 比较默认值
        )

        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

### 6. 创建第一个迁移

```bash
# 自动生成迁移脚本
alembic revision --autogenerate -m "create users table"

# 输出：
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.autogenerate.compare] Detected added table 'users'
# INFO  [alembic.autogenerate.compare] Detected added index 'ix_users_email' on '['email']'
# INFO  [alembic.autogenerate.compare] Detected added index 'ix_users_id' on '['id']'
# INFO  [alembic.autogenerate.compare] Detected added index 'ix_users_username' on '['username']'
# Generating /path/to/alembic/versions/20260211_1430_abc123_create_users_table.py ... done
```

**生成的迁移脚本：**

```python
# alembic/versions/20260211_1430_abc123_create_users_table.py
"""create users table

Revision ID: abc123def456
Revises:
Create Date: 2026-02-11 14:30:00.123456

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'abc123def456'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # 创建 users 表
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(), nullable=False),
        sa.Column('username', sa.String(), nullable=False),
        sa.Column('hashed_password', sa.String(), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )

    # 创建索引
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_index(op.f('ix_users_username'), 'users', ['username'], unique=True)

def downgrade():
    # 删除索引
    op.drop_index(op.f('ix_users_username'), table_name='users')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')

    # 删除表
    op.drop_table('users')
```

### 7. 应用迁移

```bash
# 查看当前数据库版本
alembic current
# 输出：(empty)

# 查看待执行的迁移
alembic history
# 输出：
# abc123def456 -> head, create users table

# 应用迁移到数据库
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.runtime.migration] Running upgrade  -> abc123def456, create users table

# 验证当前版本
alembic current
# 输出：
# abc123def456 (head)
```

**验证数据库：**

```sql
-- 连接数据库
psql -U user -d ai_agent_db

-- 查看所有表
\dt
-- 输出：
--              List of relations
--  Schema |      Name       | Type  | Owner
-- --------+-----------------+-------+-------
--  public | alembic_version | table | user
--  public | users           | table | user

-- 查看 users 表结构
\d users
-- 输出：
--                                      Table "public.users"
--      Column      |            Type             | Collation | Nullable |              Default
-- -----------------+-----------------------------+-----------+----------+-----------------------------------
--  id              | integer                     |           | not null | nextval('users_id_seq'::regclass)
--  email           | character varying           |           | not null |
--  username        | character varying           |           | not null |
--  hashed_password | character varying           |           | not null |
--  created_at      | timestamp without time zone |           |          |
--  updated_at      | timestamp without time zone |           |          |
-- Indexes:
--     "users_pkey" PRIMARY KEY, btree (id)
--     "ix_users_email" UNIQUE, btree (email)
--     "ix_users_username" UNIQUE, btree (username)
--     "ix_users_id" btree (id)

-- 查看 alembic_version 表
SELECT * FROM alembic_version;
-- 输出：
--  version_num
-- --------------
--  abc123def456
```

### 8. 添加新字段

```python
# app/models/user.py
"""
用户模型（添加新字段）
"""
from sqlalchemy import Column, Integer, String, DateTime, Boolean

from app.core.database import Base

class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    username = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)  # 新增：是否激活
    is_superuser = Column(Boolean, default=False)  # 新增：是否超级用户
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

```bash
# 生成新迁移
alembic revision --autogenerate -m "add is_active and is_superuser to users"

# 输出：
# INFO  [alembic.autogenerate.compare] Detected added column 'users.is_active'
# INFO  [alembic.autogenerate.compare] Detected added column 'users.is_superuser'
# Generating /path/to/alembic/versions/20260211_1445_def456_add_is_active_and_is_superuser_to_users.py ... done
```

**生成的迁移脚本：**

```python
# alembic/versions/20260211_1445_def456_add_is_active_and_is_superuser_to_users.py
"""add is_active and is_superuser to users

Revision ID: def456ghi789
Revises: abc123def456
Create Date: 2026-02-11 14:45:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'def456ghi789'
down_revision = 'abc123def456'
branch_labels = None
depends_on = None

def upgrade():
    # 添加新字段
    op.add_column('users', sa.Column('is_active', sa.Boolean(), nullable=True))
    op.add_column('users', sa.Column('is_superuser', sa.Boolean(), nullable=True))

def downgrade():
    # 删除字段
    op.drop_column('users', 'is_superuser')
    op.drop_column('users', 'is_active')
```

```bash
# 应用新迁移
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Running upgrade abc123def456 -> def456ghi789, add is_active and is_superuser to users

# 验证当前版本
alembic current
# 输出：
# def456ghi789 (head)
```

### 9. 回滚迁移

```bash
# 回滚到上一个版本
alembic downgrade -1

# 输出：
# INFO  [alembic.runtime.migration] Running downgrade def456ghi789 -> abc123def456, add is_active and is_superuser to users

# 验证当前版本
alembic current
# 输出：
# abc123def456

# 验证数据库（is_active 和 is_superuser 字段已删除）
psql -U user -d ai_agent_db -c "\d users"
```

```bash
# 重新应用迁移
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Running upgrade abc123def456 -> def456ghi789, add is_active and is_superuser to users
```

### 10. 查看迁移历史

```bash
# 查看迁移历史
alembic history

# 输出：
# def456ghi789 -> head, add is_active and is_superuser to users
# abc123def456, create users table
# <base> -> abc123def456, create users table

# 详细输出
alembic history --verbose

# 输出：
# Rev: def456ghi789 (head)
# Parent: abc123def456
# Path: /path/to/alembic/versions/20260211_1445_def456_add_is_active_and_is_superuser_to_users.py
#
#     add is_active and is_superuser to users
#
# Rev: abc123def456
# Parent: <base>
# Path: /path/to/alembic/versions/20260211_1430_abc123_create_users_table.py
#
#     create users table
```

---

## 运行输出示例

```bash
# 完整的开发流程
$ alembic init alembic
Creating directory /path/to/alembic ... done
Creating directory /path/to/alembic/versions ... done
Generating /path/to/alembic/env.py ... done
Generating /path/to/alembic/script.py.mako ... done
Generating /path/to/alembic.ini ... done

$ alembic revision --autogenerate -m "create users table"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'users'
Generating /path/to/alembic/versions/abc123_create_users_table.py ... done

$ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> abc123def456, create users table

$ alembic current
abc123def456 (head)

$ alembic revision --autogenerate -m "add is_active to users"
INFO  [alembic.autogenerate.compare] Detected added column 'users.is_active'
Generating /path/to/alembic/versions/def456_add_is_active_to_users.py ... done

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade abc123def456 -> def456ghi789, add is_active to users

$ alembic downgrade -1
INFO  [alembic.runtime.migration] Running downgrade def456ghi789 -> abc123def456, add is_active to users

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade abc123def456 -> def456ghi789, add is_active to users
```

---

## 关键要点

1. **初始化配置**：正确配置 `alembic/env.py`，导入所有模型
2. **自动生成**：使用 `--autogenerate` 快速生成迁移脚本
3. **人工检查**：生成后必须检查迁移脚本，确保正确
4. **应用迁移**：使用 `upgrade head` 应用所有迁移
5. **版本追踪**：通过 `alembic_version` 表追踪当前版本
6. **安全回滚**：使用 `downgrade` 回滚到之前的版本
7. **历史查看**：使用 `history` 查看迁移历史

---

## 常见问题

### 问题1：ImportError: cannot import name 'User'

**原因：** `alembic/env.py` 中没有导入模型

**解决：**
```python
# alembic/env.py
from app.models.user import User  # 必须导入所有模型
```

### 问题2：autogenerate 没有检测到变更

**原因：** 模型没有被 `target_metadata` 包含

**解决：**
```python
# alembic/env.py
from app.core.database import Base
target_metadata = Base.metadata  # 确保所有模型都继承自 Base
```

### 问题3：数据库连接失败

**原因：** 数据库 URL 配置错误

**解决：**
```python
# app/core/config.py
DATABASE_URL: str = "postgresql://user:password@localhost:5432/ai_agent_db"

# 或使用环境变量
# .env
DATABASE_URL=postgresql://user:password@localhost:5432/ai_agent_db
```

---

## 下一步

完成基础迁移操作后，可以学习：
- 场景2：复杂表关系迁移（外键、一对多、多对多）
- 场景3：数据迁移（修改现有数据）
- 场景4：生产环境部署（CI/CD 集成）
