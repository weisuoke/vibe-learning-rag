# bash 工具详解

> 深入理解 Pi 的命令执行工具：spawn hooks、沙箱、安全机制、远程执行

---

## 概述

**bash 工具**是 Pi 的 4 个基础工具之一，负责执行 shell 命令。它是最灵活的工具，通过 spawn hooks 机制支持高度定制。

**核心职责：**
- 执行 shell 命令
- 返回命令输出
- 支持 spawn hooks 定制
- 支持沙箱和远程执行

---

## 设计哲学

### 1. 通用执行接口

**bash 工具可以执行任何 shell 命令**

```typescript
// bash 工具的语义
await bash("npm test")

// 语义：执行这个命令
// 返回：命令的标准输出
// 用途：运行测试、构建、Git 操作等
```

**为什么不提供专用工具？**
- `run_tests` = `bash npm test`
- `git_commit` = `bash git commit -m "message"`
- `format_code` = `bash prettier --write .`

**Pi 的选择：** 一个通用的 bash 工具 > 20 个专用工具

---

### 2. Spawn Hooks 机制

**在命令执行前后插入自定义逻辑**

```typescript
// Spawn hooks 允许拦截和修改命令
hooks.beforeSpawn = async (command: string) => {
  // 可以修改命令
  // 可以拦截危险命令
  // 可以转发到远程服务器
  return modifiedCommand
}

hooks.afterSpawn = async (command: string, output: string) => {
  // 可以处理输出
  // 可以记录日志
  // 可以触发其他操作
}
```

**来源：**
- [pi-mono extensions.md](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md) - Spawn hooks 文档，2026
- [pi-mono CHANGELOG](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md) - Spawn hooks 添加 (#1160)，2026

---

### 3. 安全优先

**通过机制而非限制保证安全**

```typescript
// 不是限制命令白名单
// 而是提供安全机制

// 机制 1: Spawn hooks - 拦截危险命令
// 机制 2: Sandbox - 隔离执行环境
// 机制 3: 权限系统 - 用户确认
// 机制 4: 审计日志 - 记录所有操作
```

---

## 实现细节

### 1. 核心实现

**基于 Node.js child_process**

```typescript
// 简化的实现
class BashTool {
  async execute(command: string): Promise<string> {
    // 1. 触发 beforeSpawn hooks
    const modifiedCommand = await this.hooks.beforeSpawn(command)

    // 2. 执行命令
    const output = execSync(modifiedCommand, {
      encoding: 'utf-8',
      cwd: this.workingDirectory,
      env: process.env
    })

    // 3. 触发 afterSpawn hooks
    await this.hooks.afterSpawn(command, output)

    return output
  }
}
```

**来源：**
- [pi-mono bash.ts](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/tools/bash.ts) - 核心实现，2026

---

### 2. Spawn Hooks 详解

**beforeSpawn Hook**

```typescript
// 在命令执行前调用
interface BeforeSpawnHook {
  (command: string, options: {
    cwd: string
    env: Record<string, string>
  }): Promise<{
    command?: string  // 修改后的命令
    cwd?: string      // 修改后的工作目录
    env?: Record<string, string>  // 修改后的环境变量
  }>
}

// 示例：拦截危险命令
hooks.beforeSpawn = async (command, options) => {
  if (command.includes('rm -rf /')) {
    throw new Error('Dangerous command blocked')
  }
  return { command, ...options }
}
```

**afterSpawn Hook**

```typescript
// 在命令执行后调用
interface AfterSpawnHook {
  (command: string, output: string, exitCode: number): Promise<void>
}

// 示例：记录日志
hooks.afterSpawn = async (command, output, exitCode) => {
  console.log(`Executed: ${command}`)
  console.log(`Exit code: ${exitCode}`)
  console.log(`Output length: ${output.length} bytes`)
}
```

**来源：**
- [pi-mono extensions.md](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md) - Spawn hooks 详细说明，2026

---

### 3. 工作目录和环境变量

**默认在项目根目录执行**

```typescript
class BashTool {
  private workingDirectory: string

  constructor(projectRoot: string) {
    this.workingDirectory = projectRoot
  }

  async execute(command: string): Promise<string> {
    return execSync(command, {
      cwd: this.workingDirectory,  // 项目根目录
      env: process.env              // 继承环境变量
    })
  }
}
```

**通过 hooks 修改：**

```typescript
// 修改工作目录
hooks.beforeSpawn = async (command, options) => {
  return {
    command,
    cwd: '/custom/directory',  // 自定义目录
    env: options.env
  }
}

// 修改环境变量
hooks.beforeSpawn = async (command, options) => {
  return {
    command,
    cwd: options.cwd,
    env: {
      ...options.env,
      CUSTOM_VAR: 'value'  // 添加环境变量
    }
  }
}
```

---

## 高级特性

### 1. 远程执行（SSH Extension）

**通过 SSH 在远程服务器执行命令**

```typescript
// pi-ssh-remote Extension
extensions.register({
  name: 'ssh-remote',
  hooks: {
    beforeSpawn: async (command, options) => {
      // 转发到远程服务器
      return {
        command: `ssh user@remote "${command}"`,
        cwd: options.cwd,
        env: options.env
      }
    }
  }
})

// 使用
await bash("npm test")  // 在远程服务器执行
```

**来源：**
- [pi-ssh-remote](https://github.com/cv/pi-ssh-remote) - SSH 远程执行扩展，2025

---

### 2. 沙箱执行

**在隔离环境中执行命令**

```typescript
// Docker 沙箱
extensions.register({
  name: 'docker-sandbox',
  hooks: {
    beforeSpawn: async (command, options) => {
      return {
        command: `docker run --rm -v ${options.cwd}:/workspace alpine sh -c "${command}"`,
        cwd: options.cwd,
        env: options.env
      }
    }
  }
})

// 使用
await bash("npm test")  // 在 Docker 容器中执行
```

---

### 3. 安全拦截

**拦截危险命令**

```typescript
// 安全 Extension
extensions.register({
  name: 'security',
  hooks: {
    beforeSpawn: async (command, options) => {
      // 检测危险命令
      const dangerousPatterns = [
        /rm\s+-rf\s+\//,
        /dd\s+if=/,
        /mkfs/,
        /:\(\)\{\s*:\|:&\s*\};:/  // Fork bomb
      ]

      for (const pattern of dangerousPatterns) {
        if (pattern.test(command)) {
          throw new Error(`Dangerous command blocked: ${command}`)
        }
      }

      // 检测敏感操作
      if (command.includes('git push --force')) {
        const confirmed = await askUser('Force push?')
        if (!confirmed) {
          throw new Error('Force push blocked by user')
        }
      }

      return { command, ...options }
    }
  }
})
```

**来源：**
- [awesome-pi-agent](https://github.com/qualisero/awesome-pi-agent) - 安全 hooks 示例，2025

---

### 4. 命令日志和审计

**记录所有命令执行**

```typescript
// 审计日志 Extension
extensions.register({
  name: 'audit-log',
  hooks: {
    beforeSpawn: async (command, options) => {
      // 记录命令
      auditLog.record({
        timestamp: new Date(),
        command,
        cwd: options.cwd,
        user: process.env.USER
      })
      return { command, ...options }
    },
    afterSpawn: async (command, output, exitCode) => {
      // 记录结果
      auditLog.record({
        timestamp: new Date(),
        command,
        exitCode,
        outputLength: output.length
      })
    }
  }
})
```

---

## 实际应用场景

### 场景 1：运行测试

```typescript
// 1. 运行所有测试
await bash("npm test")

// 2. 运行特定测试
await bash("npm test -- src/app.test.ts")

// 3. 监听模式
await bash("npm test -- --watch")

// 4. 覆盖率报告
await bash("npm test -- --coverage")
```

---

### 场景 2：Git 操作

```typescript
// 1. 查看状态
await bash("git status")

// 2. 添加文件
await bash("git add .")

// 3. 提交
await bash('git commit -m "feat: add new feature"')

// 4. 推送
await bash("git push origin main")

// 5. 创建分支
await bash("git checkout -b feature/new-feature")
```

---

### 场景 3：构建和部署

```typescript
// 1. 安装依赖
await bash("npm install")

// 2. 构建项目
await bash("npm run build")

// 3. 运行 linter
await bash("npm run lint")

// 4. 格式化代码
await bash("npm run format")

// 5. 部署
await bash("npm run deploy")
```

---

### 场景 4：文件操作

```typescript
// 1. 查找文件
await bash("find src -name '*.ts'")

// 2. 搜索内容
await bash("grep -r 'TODO' src/")

// 3. 创建目录
await bash("mkdir -p src/features/auth")

// 4. 复制文件
await bash("cp src/template.ts src/new-file.ts")

// 5. 删除文件
await bash("rm temp-file.ts")
```

---

## 与其他工具的协作

### bash + read

**执行后读取结果**

```typescript
// 1. 运行测试生成报告
await bash("npm test -- --json > test-report.json")

// 2. 读取报告
const report = await read("test-report.json")

// 3. Agent 分析报告
```

---

### bash + write

**生成后执行**

```typescript
// 1. 生成脚本
await write("deploy.sh", `
#!/bin/bash
npm run build
npm run deploy
`)

// 2. 添加执行权限
await bash("chmod +x deploy.sh")

// 3. 执行脚本
await bash("./deploy.sh")
```

---

### bash + edit

**修改后验证**

```typescript
// 1. 修改代码
await edit("src/app.ts", oldCode, newCode)

// 2. 运行测试
await bash("npm test")

// 3. 如果失败，继续修改
await edit("src/app.ts", buggyCode, fixedCode)
```

---

## 常见问题

### Q1: bash 工具安全吗？

**A:** 通过 spawn hooks、沙箱、权限系统保证安全。

```typescript
// 多层安全机制
// 1. Spawn hooks - 拦截危险命令
// 2. Sandbox - 隔离执行
// 3. 权限系统 - 用户确认
// 4. 审计日志 - 记录操作
```

---

### Q2: bash 工具在哪个目录执行？

**A:** 默认在项目根目录，可通过 hooks 修改。

```typescript
// 默认：项目根目录
await bash("pwd")  // 输出：/path/to/project

// 通过 hooks 修改
hooks.beforeSpawn = async (command, options) => {
  return { command, cwd: '/custom/dir', env: options.env }
}
```

---

### Q3: bash 工具支持管道和重定向吗？

**A:** 支持，因为它执行的是 shell 命令。

```typescript
// 管道
await bash("cat file.txt | grep 'pattern' | wc -l")

// 重定向
await bash("npm test > test-output.txt 2>&1")

// 后台执行（不推荐）
await bash("npm run dev &")  // 可能导致问题
```

---

### Q4: bash 工具能执行交互式命令吗？

**A:** 不能，只支持非交互式命令。

```typescript
// ❌ 不支持：交互式命令
await bash("vim file.txt")  // 会失败

// ✅ 支持：非交互式命令
await bash("cat file.txt")
```

---

### Q5: bash 工具有超时限制吗？

**A:** 通常有，具体取决于实现（如 2 分钟）。

```typescript
// 长时间运行的命令可能超时
await bash("npm run long-task")  // 可能超时

// 解决方案：后台运行或增加超时
```

---

## 2025-2026 最新发展

### Spawn Hooks 机制

2026 年引入的 spawn hooks 是 bash 工具的重要增强：

**用途：**
- 拦截和修改命令
- 修改工作目录和环境变量
- 实现远程执行
- 实现沙箱隔离
- 实现安全拦截

**来源：**
- [pi-mono extensions.md](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md) - Spawn hooks 文档，2026
- [pi-mono CHANGELOG](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md) - Spawn hooks 添加，2026

---

### SSH 远程执行

pi-ssh-remote Extension 展示了 spawn hooks 的强大能力：

**功能：**
- 通过 SSH 在远程服务器执行命令
- 重定向 read/write/edit 工具到远程
- 支持远程沙箱

**来源：**
- [pi-ssh-remote](https://github.com/cv/pi-ssh-remote) - SSH 远程执行，2025

---

### 安全增强

社区开发了多个安全相关的 Extensions：

**功能：**
- 阻挡危险命令
- 沙箱工具
- 审计日志
- 权限控制

**来源：**
- [awesome-pi-agent](https://github.com/qualisero/awesome-pi-agent) - 安全扩展列表，2025

---

## 最佳实践

### 1. 避免长时间运行的命令

```typescript
// ❌ 不好的做法
await bash("npm run dev")  // 会一直运行

// ✅ 好的做法
// 建议用户手动运行
// 或使用后台任务
```

---

### 2. 使用绝对路径或相对于项目根目录

```typescript
// ✅ 好的做法
await bash("npm test")  // 在项目根目录执行

// ❌ 不好的做法
await bash("cd src && npm test")  // cd 不会持久化
```

---

### 3. 处理命令失败

```typescript
// ✅ 好的做法
try {
  await bash("npm test")
} catch (error) {
  // 处理失败
  console.error("Tests failed:", error.message)
}
```

---

### 4. 使用 spawn hooks 增强安全性

```typescript
// ✅ 好的做法
extensions.register({
  name: 'security',
  hooks: {
    beforeSpawn: async (command, options) => {
      // 拦截危险命令
      if (isDangerous(command)) {
        throw new Error('Blocked')
      }
      return { command, ...options }
    }
  }
})
```

---

## 延伸阅读

### 官方文档
- [pi-mono bash.ts](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/tools/bash.ts) - 核心实现
- [pi-mono extensions.md](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md) - Spawn hooks 文档

### 社区资源
- [pi-ssh-remote](https://github.com/cv/pi-ssh-remote) - SSH 远程执行
- [awesome-pi-agent](https://github.com/qualisero/awesome-pi-agent) - 安全扩展

---

## 下一步学习

完成 bash 工具学习后，建议学习：

### 实战应用
- [07_实战代码_04_bash工具实战](./07_实战代码_04_bash工具实战.md) - bash 工具实战
- [07_实战代码_05_工具组合模式](./07_实战代码_05_工具组合模式.md) - 工具组合
- [07_实战代码_07_扩展与定制](./07_实战代码_07_扩展与定制.md) - Spawn hooks 开发

---

**版本：** v1.0
**最后更新：** 2026-02-19
**维护者：** Claude Code
