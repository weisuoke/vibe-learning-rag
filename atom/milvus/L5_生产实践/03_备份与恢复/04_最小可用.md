# æœ€å°å¯ç”¨

> ç”¨æœ€å°‘çš„ä»£ç å®ç° Milvus æ•°æ®å¤‡ä»½ä¸æ¢å¤

---

## ç›®æ ‡

ç”¨ **20 è¡Œä»£ç ** å®ç°ï¼š
- âœ… Collection æ•°æ®å¯¼å‡º
- âœ… Collection æ•°æ®å¯¼å…¥
- âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§

---

## æœ€å°å¯ç”¨ä»£ç 

```python
from pymilvus import connections, Collection, utility
import json

# è¿æ¥ Milvus
connections.connect(host="localhost", port="19530")

# 1. å¯¼å‡º Collection æ•°æ®ï¼ˆå¤‡ä»½ï¼‰
collection = Collection("my_collection")
collection.load()

# å¯¼å‡ºæ‰€æœ‰æ•°æ®
results = collection.query(expr="id >= 0", output_fields=["*"])
with open("backup.json", "w") as f:
    json.dump(results, f)

print(f"âœ… å¤‡ä»½å®Œæˆï¼š{len(results)} æ¡æ•°æ®")

# 2. å¯¼å…¥ Collection æ•°æ®ï¼ˆæ¢å¤ï¼‰
with open("backup.json", "r") as f:
    data = json.load(f)

# é‡æ–°æ’å…¥æ•°æ®
collection.insert(data)
collection.flush()

print(f"âœ… æ¢å¤å®Œæˆï¼š{len(data)} æ¡æ•°æ®")
```

---

## è¿è¡Œæ•ˆæœ

```bash
$ python minimal_backup.py
âœ… å¤‡ä»½å®Œæˆï¼š1000 æ¡æ•°æ®
âœ… æ¢å¤å®Œæˆï¼š1000 æ¡æ•°æ®
```

---

## æ ¸å¿ƒè¦ç‚¹

### 1. å¯¼å‡ºæ•°æ®

```python
# æŸ¥è¯¢æ‰€æœ‰æ•°æ®
results = collection.query(expr="id >= 0", output_fields=["*"])
```

**å…³é”®ç‚¹ï¼š**
- `expr="id >= 0"`ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼ˆå‡è®¾ id ä» 0 å¼€å§‹ï¼‰
- `output_fields=["*"]`ï¼šå¯¼å‡ºæ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬å‘é‡ï¼‰

### 2. ä¿å­˜æ•°æ®

```python
# ä¿å­˜ä¸º JSON æ–‡ä»¶
with open("backup.json", "w") as f:
    json.dump(results, f)
```

**å…³é”®ç‚¹ï¼š**
- JSON æ ¼å¼æ˜“äºé˜…è¯»å’Œè°ƒè¯•
- åŒ…å«æ‰€æœ‰å­—æ®µå’Œå‘é‡æ•°æ®

### 3. æ¢å¤æ•°æ®

```python
# é‡æ–°æ’å…¥æ•°æ®
collection.insert(data)
collection.flush()
```

**å…³é”®ç‚¹ï¼š**
- `insert()`ï¼šæ‰¹é‡æ’å…¥æ•°æ®
- `flush()`ï¼šç¡®ä¿æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜

---

## å±€é™æ€§

è¿™ä¸ªæœ€å°å®ç°æœ‰ä»¥ä¸‹å±€é™ï¼š

| å±€é™ | è¯´æ˜ | ç”Ÿäº§ç¯å¢ƒè§£å†³æ–¹æ¡ˆ |
|------|------|------------------|
| **å¤§æ•°æ®é‡** | ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ | åˆ†æ‰¹å¯¼å‡ºï¼ˆä½¿ç”¨ offset/limitï¼‰ |
| **å‘é‡ç²¾åº¦** | JSON å¯èƒ½æŸå¤±æµ®ç‚¹ç²¾åº¦ | ä½¿ç”¨ NumPy äºŒè¿›åˆ¶æ ¼å¼ |
| **ç´¢å¼•ä¸¢å¤±** | åªå¤‡ä»½æ•°æ®ï¼Œä¸å¤‡ä»½ç´¢å¼• | ä½¿ç”¨ Milvus Backup å·¥å…· |
| **Schema ä¸¢å¤±** | ä¸å¤‡ä»½ Collection Schema | å¯¼å‡º Schema å®šä¹‰ |
| **æ— å¢é‡å¤‡ä»½** | æ¯æ¬¡å…¨é‡å¤‡ä»½ | ä½¿ç”¨æ—¶é—´æˆ³å­—æ®µå®ç°å¢é‡ |

---

## æ‰©å±•æ–¹å‘

### 1. åˆ†æ‰¹å¯¼å‡ºï¼ˆå¤„ç†å¤§æ•°æ®é‡ï¼‰

```python
# åˆ†æ‰¹å¯¼å‡º
batch_size = 1000
offset = 0

while True:
    results = collection.query(
        expr="id >= 0",
        output_fields=["*"],
        limit=batch_size,
        offset=offset
    )

    if not results:
        break

    # ä¿å­˜æ‰¹æ¬¡æ•°æ®
    with open(f"backup_batch_{offset}.json", "w") as f:
        json.dump(results, f)

    offset += batch_size
```

### 2. å¤‡ä»½ Schema

```python
# å¯¼å‡º Schema
schema = collection.schema
schema_dict = {
    "fields": [
        {
            "name": field.name,
            "dtype": str(field.dtype),
            "dim": field.params.get("dim") if hasattr(field, "params") else None
        }
        for field in schema.fields
    ]
}

with open("schema.json", "w") as f:
    json.dump(schema_dict, f)
```

### 3. å¢é‡å¤‡ä»½

```python
# åªå¤‡ä»½æœ€è¿‘æ›´æ–°çš„æ•°æ®
last_backup_time = 1704067200  # ä¸Šæ¬¡å¤‡ä»½æ—¶é—´æˆ³

results = collection.query(
    expr=f"timestamp > {last_backup_time}",
    output_fields=["*"]
)
```

---

## åœ¨ RAG ç³»ç»Ÿä¸­çš„åº”ç”¨

### åœºæ™¯ï¼šçŸ¥è¯†åº“å¤‡ä»½

```python
# å¤‡ä»½ RAG çŸ¥è¯†åº“
def backup_rag_knowledge_base(collection_name: str, backup_dir: str):
    """å¤‡ä»½ RAG çŸ¥è¯†åº“"""
    collection = Collection(collection_name)
    collection.load()

    # å¯¼å‡ºæ–‡æ¡£æ•°æ®
    docs = collection.query(expr="id >= 0", output_fields=["*"])

    # ä¿å­˜å¤‡ä»½
    backup_file = f"{backup_dir}/{collection_name}_backup.json"
    with open(backup_file, "w") as f:
        json.dump(docs, f)

    print(f"âœ… çŸ¥è¯†åº“å¤‡ä»½å®Œæˆï¼š{len(docs)} ä¸ªæ–‡æ¡£")
    return backup_file

# ä½¿ç”¨ç¤ºä¾‹
backup_file = backup_rag_knowledge_base("rag_docs", "./backups")
```

---

## æ€»ç»“

**æœ€å°å¯ç”¨å®ç°çš„ä»·å€¼ï¼š**
- âœ… 20 è¡Œä»£ç å®ç°åŸºç¡€å¤‡ä»½æ¢å¤
- âœ… é€‚åˆå°è§„æ¨¡æ•°æ®å’Œå¼€å‘ç¯å¢ƒ
- âœ… ç†è§£å¤‡ä»½æ¢å¤çš„æ ¸å¿ƒåŸç†

**ç”Ÿäº§ç¯å¢ƒéœ€è¦ï¼š**
- ğŸ”§ ä½¿ç”¨ Milvus Backup å·¥å…·
- ğŸ”§ å®ç°åˆ†æ‰¹å¯¼å‡ºå’Œå¢é‡å¤‡ä»½
- ğŸ”§ å¤‡ä»½ Schema å’Œç´¢å¼•é…ç½®
- ğŸ”§ è‡ªåŠ¨åŒ–å¤‡ä»½å’Œç›‘æ§

---

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹ å®Œæ•´çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆ â†’ [ç¬¬ä¸€æ€§åŸç†](./02_ç¬¬ä¸€æ€§åŸç†.md)
