# 实战代码：Chain-of-Thought场景

## 场景描述

**目标：** 构建一个代码审查助手，使用CoT引导模型逐步分析代码问题

**技术栈：** Python 3.13+, OpenAI API

**难度：** 中级

---

## 完整代码

```python
"""
Chain-of-Thought实战示例
演示：代码审查助手

来源：基于Chain-of-Thought Prompting (2022)最佳实践
"""

from openai import OpenAI
from dotenv import load_dotenv
from typing import Dict, List

load_dotenv()

class CodeReviewer:
    """CoT代码审查助手"""
    
    def __init__(self, client: OpenAI):
        self.client = client
    
    def review_with_cot(self, code: str, model: str = "gpt-4o-mini") -> Dict:
        """使用CoT审查代码"""
        prompt = f"""
请审查以下代码，找出潜在问题。

代码：
```python
{code}
```

让我们一步步分析：
1. 首先检查语法和逻辑错误
2. 然后检查性能问题
3. 接着检查安全问题
4. 最后给出改进建议

分析：
"""
        
        response = self.client.chat.completions.create(
            model=model,
            messages=[{"role": "user", "content": prompt}]
        )
        
        return {
            "code": code,
            "review": response.choices[0].message.content
        }

# 测试
client = OpenAI()
reviewer = CodeReviewer(client)

code = """
def calculate_average(numbers):
    total = 0
    for num in numbers:
        total += num
    return total / len(numbers)
"""

result = reviewer.review_with_cot(code)
print(result['review'])
```

---

## RAG集成示例

```python
import chromadb

class RAGCodeReviewer:
    """RAG + CoT代码审查"""
    
    def __init__(self, client: OpenAI, collection):
        self.client = client
        self.collection = collection
    
    def review_with_context(self, code: str) -> Dict:
        """基于最佳实践审查代码"""
        # 检索相关最佳实践
        results = self.collection.query(
            query_texts=["代码审查最佳实践"],
            n_results=3
        )
        best_practices = results['documents'][0]
        
        prompt = f"""
参考最佳实践：
{chr(10).join(f"{i+1}. {p}" for i, p in enumerate(best_practices))}

代码：
```python
{code}
```

让我们一步步审查：
1. 对照最佳实践检查
2. 识别潜在问题
3. 给出改进建议

审查：
"""
        
        response = self.client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}]
        )
        
        return {
            "code": code,
            "best_practices": best_practices,
            "review": response.choices[0].message.content
        }
```

---

## 参考资源

- [Chain-of-Thought Prompting (2022)](https://arxiv.org/abs/2201.11903)
- [Prompt Engineering Guide - CoT](https://www.promptingguide.ai/techniques/cot)
