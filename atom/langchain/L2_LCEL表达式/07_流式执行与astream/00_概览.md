# 概览

## 流式执行与 astream 完整学习指南

本文档是 LangChain 流式执行的完整学习指南，涵盖基础原理、核心概念、实战代码和最佳实践。

---

## 学习路径

### 第一步：理解核心概念（必读）

1. **01_30字核心** - 快速理解流式执行的本质
2. **10_一句话总结** - 核心要点总结
3. **04_最小可用** - 掌握最小必要知识

### 第二步：深入理解原理

4. **02_第一性原理** - 深入理解设计哲学和实现机制
5. **05_双重类比** - 通过类比建立直觉理解
6. **06_反直觉点** - 避免常见误区

### 第三步：掌握核心概念

7. **03_核心概念_01_Stream模式详解** - 三种流式模式详解
8. **03_核心概念_02_Agent进度流式** - updates 模式深入
9. **03_核心概念_03_LLM令牌流式** - messages 模式深入
10. **03_核心概念_04_自定义数据流式** - custom 模式深入
11. **03_核心概念_05_性能优化与异步** - 性能优化策略

### 第四步：实战应用

12. **07_实战代码_01_基础流式模式** - 基础代码示例
13. **07_实战代码_02_实时LLM响应** - 实时响应应用
14. **07_实战代码_03_自定义进度更新** - 进度追踪
15. **07_实战代码_04_高级过滤与组合** - 高级技巧
16. **07_实战代码_05_生产环境优化** - 生产级优化

### 第五步：巩固记忆

17. **08_面试必问** - 面试题和详细答案
18. **09_化骨绵掌** - 知识卡片速查

---

## 核心知识点

### 流式执行三要素

1. **AsyncIterator** - 异步迭代器
2. **回调系统** - 捕获 LLM tokens
3. **Transform 方法** - 流式组合

### 三种流式模式

| 模式 | 用途 | 返回数据 | 适用场景 |
|------|------|----------|----------|
| **updates** | Agent 步骤追踪 | `{node: state}` | 监控、调试 |
| **messages** | LLM 实时输出 | `(token, metadata)` | 对话、长文本 |
| **custom** | 自定义进度 | 任意数据 | 业务进度 |

### 性能数据（2025-2026）

```
流式开销: <10%
TTFB 提升: 50 倍
用户体验提升: 显著
```

---

## 快速开始

### 基础示例

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

model = ChatOpenAI(model="gpt-4o-mini")
prompt = ChatPromptTemplate.from_template("{input}")
chain = prompt | model

# 流式输出
async for chunk in chain.astream({"input": "介绍Python"}):
    print(chunk.content, end="", flush=True)
```

### Agent 进度追踪

```python
from langchain.agents import create_agent

agent = create_agent(model="gpt-4o-mini", tools=[...])

for chunk in agent.stream(input, stream_mode="updates"):
    for node_name, data in chunk.items():
        print(f"[{node_name}] 执行完成")
```

### 自定义进度

```python
from langgraph.config import get_stream_writer

def my_tool(query: str) -> str:
    writer = get_stream_writer()
    writer("步骤 1...")
    writer("步骤 2...")
    return "Done"
```

---

## 最佳实践

1. **使用 astream 而非 stream**
2. **所有 print 添加 flush=True**
3. **正确解构 messages 模式返回值**
4. **实现错误处理和降级方案**
5. **监控性能指标（TTFB、总时间）**

---

## 参考资源

- **官方文档**: https://docs.langchain.com/oss/python/langchain/streaming/overview
- **源码位置**: `langchain_core/runnables/base.py:132`

---

**版本**: LangChain 0.3.x (2025-2026)
**最后更新**: 2026-02-21

**完成状态**: 全部 18 个文件已生成 ✅
