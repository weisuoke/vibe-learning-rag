# 实战代码1：自定义异常体系

**场景：** 为 AI Agent API 设计完整的自定义异常体系

---

## 完整代码

```python
"""
自定义异常体系
适用于 AI Agent API
"""

from typing import Optional, Dict, Any

# ===== 基础异常 =====
class AppError(Exception):
    """应用基础异常"""
    def __init__(
        self,
        message: str,
        error_code: Optional[str] = None,
        status_code: int = 500,
        details: Optional[Dict[str, Any]] = None
    ):
        self.message = message
        self.error_code = error_code or self.__class__.__name__
        self.status_code = status_code
        self.details = details or {}
        super().__init__(message)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "error": self.message,
            "error_code": self.error_code,
            "details": self.details
        }

# ===== 错误类型分类 =====
class BusinessError(AppError):
    """业务异常"""
    def __init__(self, message: str, error_code: str = None, details: dict = None):
        super().__init__(message, error_code, 422, details)

class SystemError(AppError):
    """系统异常"""
    def __init__(self, message: str, error_code: str = None, details: dict = None):
        super().__init__(message, error_code, 500, details)

class ExternalError(AppError):
    """外部服务异常"""
    def __init__(self, message: str, error_code: str = None, details: dict = None):
        super().__init__(message, error_code, 503, details)

# ===== 业务异常 =====
class ValidationError(BusinessError):
    """参数验证失败"""
    def __init__(self, field: str, message: str):
        super().__init__(
            f"参数验证失败: {field} - {message}",
            "VALIDATION_ERROR",
            {"field": field, "message": message}
        )

class TextTooLongError(BusinessError):
    """文本过长"""
    def __init__(self, max_length: int, actual_length: int):
        super().__init__(
            f"输入文本过长，请缩短至 {max_length} 字以内",
            "TEXT_TOO_LONG",
            {"max_length": max_length, "actual_length": actual_length}
        )

class ResourceNotFoundError(BusinessError):
    """资源不存在"""
    def __init__(self, resource_type: str, resource_id: str):
        super().__init__(
            f"{resource_type} 不存在: {resource_id}",
            "RESOURCE_NOT_FOUND",
            {"resource_type": resource_type, "resource_id": resource_id}
        )
        self.status_code = 404

# ===== 系统异常 =====
class DatabaseError(SystemError):
    """数据库错误"""
    def __init__(self, operation: str, error: str):
        super().__init__(
            f"数据库操作失败: {operation}",
            "DATABASE_ERROR",
            {"operation": operation, "error": error}
        )

# ===== 外部服务异常 =====
class LLMError(ExternalError):
    """LLM 服务错误"""
    def __init__(self, provider: str, error: str):
        super().__init__(
            f"LLM 服务暂时不可用: {provider}",
            "LLM_ERROR",
            {"provider": provider, "error": error}
        )

class LLMTimeoutError(LLMError):
    """LLM 超时"""
    def __init__(self, provider: str, timeout: float):
        super().__init__(provider, f"请求超时（{timeout}s）")
        self.error_code = "LLM_TIMEOUT"

class LLMRateLimitError(LLMError):
    """LLM Rate Limit"""
    def __init__(self, provider: str, retry_after: int = None):
        super().__init__(provider, "请求频率过高")
        self.error_code = "LLM_RATE_LIMIT"
        self.status_code = 429
        if retry_after:
            self.details["retry_after"] = retry_after

# ===== FastAPI 集成 =====
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse

app = FastAPI()

@app.exception_handler(BusinessError)
async def business_error_handler(request: Request, exc: BusinessError):
    return JSONResponse(status_code=exc.status_code, content=exc.to_dict())

@app.exception_handler(SystemError)
async def system_error_handler(request: Request, exc: SystemError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"error": "服务暂时不可用", "error_code": exc.error_code}
    )

# ===== 使用示例 =====
@app.post("/chat")
async def chat(message: str):
    if len(message) > 2000:
        raise TextTooLongError(max_length=2000, actual_length=len(message))

    try:
        response = await call_llm(message)
        return {"response": response}
    except Timeout:
        raise LLMTimeoutError(provider="OpenAI", timeout=30.0)
```

---

## 运行输出

```bash
# 正常请求
curl -X POST "http://localhost:8000/chat" -d '{"message": "你好"}'
# → {"response": "你好！"}

# 文本过长
curl -X POST "http://localhost:8000/chat" -d '{"message": "很长的文本..."}'
# → {
#   "error": "输入文本过长，请缩短至 2000 字以内",
#   "error_code": "TEXT_TOO_LONG",
#   "details": {"max_length": 2000, "actual_length": 3500}
# }

# LLM 超时
# → {
#   "error": "服务暂时不可用",
#   "error_code": "LLM_TIMEOUT"
# }
```
