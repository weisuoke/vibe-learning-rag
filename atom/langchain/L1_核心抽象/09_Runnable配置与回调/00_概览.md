# Runnable配置与回调 - 概览

> **LangChain 可观测性基础设施的完整学习指南**

---

## 文档导航

本知识点包含 **20 个文件**，分为 4 个部分：

### 📚 基础维度（8 个文件）

| 文件 | 内容 | 阅读时间 |
|------|------|----------|
| [01_30字核心](./01_30字核心.md) | 核心概念速览 | 2 分钟 |
| [10_一句话总结](./10_一句话总结.md) | 最精炼总结 | 1 分钟 |
| [02_第一性原理](./02_第一性原理.md) | 深入理解设计哲学 | 15 分钟 |
| [04_最小可用](./04_最小可用.md) | 20% 核心知识 | 10 分钟 |
| [05_双重类比](./05_双重类比.md) | 前端 + 生活类比 | 10 分钟 |
| [06_反直觉点](./06_反直觉点.md) | 常见误区 | 10 分钟 |
| [08_面试必问](./08_面试必问.md) | 高频面试题 | 15 分钟 |
| [09_化骨绵掌](./09_化骨绵掌.md) | 10 张速查卡片 | 5 分钟 |

### 🔬 核心概念（5 个文件）

| 文件 | 内容 | 阅读时间 |
|------|------|----------|
| [03_核心概念_01_RunnableConfig结构](./03_核心概念_01_RunnableConfig结构.md) | 8 个核心字段详解 | 20 分钟 |
| [03_核心概念_02_回调系统架构](./03_核心概念_02_回调系统架构.md) | 生命周期与事件传播 | 20 分钟 |
| [03_核心概念_03_BaseCallbackHandler](./03_核心概念_03_BaseCallbackHandler.md) | 15+ 回调方法详解 | 15 分钟 |
| [03_核心概念_04_可配置字段](./03_核心概念_04_可配置字段.md) | 动态参数调整 | 15 分钟 |
| [03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md) | 官方监控平台 | 15 分钟 |

### 💻 实战代码（6 个文件）

| 文件 | 内容 | 阅读时间 |
|------|------|----------|
| [07_实战代码_01_基础配置](./07_实战代码_01_基础配置.md) | 配置传递方式 | 10 分钟 |
| [07_实战代码_02_自定义日志](./07_实战代码_02_自定义日志.md) | 结构化日志系统 | 15 分钟 |
| [07_实战代码_03_成本追踪](./07_实战代码_03_成本追踪.md) | Token 计数与预算 | 15 分钟 |
| [07_实战代码_04_LangSmith集成](./07_实战代码_04_LangSmith集成.md) | 零配置追踪 | 10 分钟 |
| [07_实战代码_05_动态配置](./07_实战代码_05_动态配置.md) | A/B 测试与模型切换 | 15 分钟 |
| [07_实战代码_06_生产监控](./07_实战代码_06_生产监控.md) | 完整监控方案 | 20 分钟 |

---

## 学习路径

### 🚀 快速入门（30 分钟）

适合快速了解核心概念：

1. [01_30字核心](./01_30字核心.md) - 2 分钟
2. [04_最小可用](./04_最小可用.md) - 10 分钟
3. [05_双重类比](./05_双重类比.md) - 10 分钟
4. [09_化骨绵掌](./09_化骨绵掌.md) - 5 分钟

**学完后你将掌握**：
- RunnableConfig 的 3 个核心字段
- BaseCallbackHandler 的 3 个核心方法
- 成本追踪的基本实现
- LangSmith 的零配置启用

---

### 📖 系统学习（3 小时）

适合深入理解原理和实践：

**第一阶段：理解原理（1 小时）**
1. [02_第一性原理](./02_第一性原理.md) - 15 分钟
2. [03_核心概念_01_RunnableConfig结构](./03_核心概念_01_RunnableConfig结构.md) - 20 分钟
3. [03_核心概念_02_回调系统架构](./03_核心概念_02_回调系统架构.md) - 20 分钟

**第二阶段：掌握方法（1 小时）**
1. [03_核心概念_03_BaseCallbackHandler](./03_核心概念_03_BaseCallbackHandler.md) - 15 分钟
2. [03_核心概念_04_可配置字段](./03_核心概念_04_可配置字段.md) - 15 分钟
3. [03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md) - 15 分钟
4. [06_反直觉点](./06_反直觉点.md) - 10 分钟

**第三阶段：实战应用（1 小时）**
1. [07_实战代码_01_基础配置](./07_实战代码_01_基础配置.md) - 10 分钟
2. [07_实战代码_02_自定义日志](./07_实战代码_02_自定义日志.md) - 15 分钟
3. [07_实战代码_03_成本追踪](./07_实战代码_03_成本追踪.md) - 15 分钟
4. [07_实战代码_05_动态配置](./07_实战代码_05_动态配置.md) - 15 分钟

**学完后你将掌握**：
- RunnableConfig 的完整设计哲学
- 回调系统的执行流程和事件传播
- 生产环境的监控方案
- 成本优化和动态配置策略

---

### 🎯 面试准备（1 小时）

适合准备技术面试：

1. [08_面试必问](./08_面试必问.md) - 15 分钟
2. [06_反直觉点](./06_反直觉点.md) - 10 分钟
3. [09_化骨绵掌](./09_化骨绵掌.md) - 5 分钟
4. [03_核心概念_01_RunnableConfig结构](./03_核心概念_01_RunnableConfig结构.md) - 20 分钟
5. [03_核心概念_02_回调系统架构](./03_核心概念_02_回调系统架构.md) - 20 分钟

**学完后你将掌握**：
- 10 个高频面试题及标准答案
- 10 个反直觉的设计决策
- RunnableConfig 和回调系统的核心原理

---

### 🏭 生产落地（2 小时）

适合实际项目应用：

1. [07_实战代码_02_自定义日志](./07_实战代码_02_自定义日志.md) - 15 分钟
2. [07_实战代码_03_成本追踪](./07_实战代码_03_成本追踪.md) - 15 分钟
3. [07_实战代码_04_LangSmith集成](./07_实战代码_04_LangSmith集成.md) - 10 分钟
4. [07_实战代码_05_动态配置](./07_实战代码_05_动态配置.md) - 15 分钟
5. [07_实战代码_06_生产监控](./07_实战代码_06_生产监控.md) - 20 分钟
6. [03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md) - 15 分钟

**学完后你将掌握**：
- 完整的生产监控系统
- 成本追踪和预算告警
- LangSmith 集成方案
- 动态配置和 A/B 测试

---

## 核心知识点

### RunnableConfig 的 8 个字段

| 字段 | 用途 | 优先级 |
|------|------|--------|
| `callbacks` | 监控、日志、成本追踪 | ⭐⭐⭐ |
| `tags` | 过滤、分类 | ⭐⭐⭐ |
| `metadata` | 追踪、归因 | ⭐⭐⭐ |
| `run_name` | 可读标识 | ⭐⭐ |
| `run_id` | 唯一标识 | ⭐ |
| `max_concurrency` | 并发控制 | ⭐⭐ |
| `recursion_limit` | 递归限制 | ⭐⭐ |
| `configurable` | 动态配置 | ⭐⭐⭐ |

### BaseCallbackHandler 的核心方法

| 方法 | 触发时机 | 使用频率 |
|------|----------|----------|
| `on_llm_start` | LLM 开始调用 | ⭐⭐⭐ |
| `on_llm_end` | LLM 调用结束 | ⭐⭐⭐ |
| `on_llm_error` | LLM 调用失败 | ⭐⭐⭐ |
| `on_llm_new_token` | Token 生成（流式） | ⭐⭐ |
| `on_chain_start` | Chain 开始执行 | ⭐⭐ |
| `on_chain_end` | Chain 执行结束 | ⭐⭐ |
| `on_retriever_end` | 检索完成 | ⭐⭐ |

---

## 应用场景

### 1. 成本追踪

**文件**：[07_实战代码_03_成本追踪](./07_实战代码_03_成本追踪.md)

**核心代码**：
```python
class CostTracker(BaseCallbackHandler):
    def on_llm_end(self, response, **kwargs):
        usage = response.llm_output["token_usage"]
        cost = usage["prompt_tokens"] * 0.00003 + usage["completion_tokens"] * 0.00006
        self.total_cost += cost
```

---

### 2. 性能监控

**文件**：[07_实战代码_02_自定义日志](./07_实战代码_02_自定义日志.md)

**核心代码**：
```python
class PerformanceMonitor(BaseCallbackHandler):
    def on_llm_start(self, serialized, prompts, **kwargs):
        self.start_time = time.time()

    def on_llm_end(self, response, **kwargs):
        duration = time.time() - self.start_time
        print(f"耗时: {duration:.2f}s")
```

---

### 3. LangSmith 集成

**文件**：[07_实战代码_04_LangSmith集成](./07_实战代码_04_LangSmith集成.md)

**核心代码**：
```bash
export LANGCHAIN_TRACING_V2=true
export LANGCHAIN_API_KEY=your_key
export LANGCHAIN_PROJECT=my_project
```

---

### 4. 动态模型切换

**文件**：[07_实战代码_05_动态配置](./07_实战代码_05_动态配置.md)

**核心代码**：
```python
llm = ChatOpenAI(model="gpt-3.5-turbo").configurable_fields(
    model=ConfigurableField(id="model")
)

config = RunnableConfig(configurable={"model": "gpt-4"})
llm.invoke("你好", config=config)
```

---

## 常见问题

### Q1: RunnableConfig 和回调系统的关系？

**答案**：RunnableConfig 是配置容器，callbacks 是其中一个字段。回调系统通过 RunnableConfig 传递给链。

**详见**：[02_第一性原理](./02_第一性原理.md)

---

### Q2: Tags 和 Metadata 有什么区别？

**答案**：
- **Tags**：简单字符串列表，用于过滤和分类
- **Metadata**：键值对字典，用于追踪和归因

**详见**：[03_核心概念_01_RunnableConfig结构](./03_核心概念_01_RunnableConfig结构.md)

---

### Q3: 如何实现按用户统计成本？

**答案**：在 metadata 中传入 user_id，在回调中读取并归因。

**详见**：[07_实战代码_03_成本追踪](./07_实战代码_03_成本追踪.md)

---

### Q4: LangSmith 是必需的吗？

**答案**：不是。LangSmith 是可选的，可以使用自定义回调实现监控。

**详见**：[03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md)

---

### Q5: 回调会拖慢执行速度吗？

**答案**：不会。回调开销 < 0.5%，可忽略不计。

**详见**：[06_反直觉点](./06_反直觉点.md)

---

## 2025-2026 新特性

### 1. LangSmith 实时告警（2025）

**功能**：成本、延迟、错误率超过阈值时自动告警

**详见**：[03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md)

---

### 2. 多轮评估（2025）

**功能**：评估对话式应用的多轮交互质量

**详见**：[03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md)

---

### 3. OpenTelemetry 集成（2025）

**功能**：与 OpenTelemetry 标准集成，支持分布式追踪

**详见**：[03_核心概念_05_LangSmith监控](./03_核心概念_05_LangSmith监控.md)

---

## 参考资料

### 官方文档

- [RunnableConfig API Reference](https://reference.langchain.com/v0.3/python/core/runnables/langchain_core.runnables.config.RunnableConfig.html)
- [BaseCallbackHandler API Reference](https://reference.langchain.com/v0.3/python/core/callbacks/langchain_core.callbacks.base.BaseCallbackHandler.html)
- [LangChain Custom Callbacks Guide](https://python.langchain.com/docs/how_to/custom_callbacks/)
- [LangSmith Observability Platform](https://www.langchain.com/langsmith/observability)

### 相关知识点

- **L1_核心抽象/01_Runnable接口与LCEL基础** - Runnable 接口基础
- **L1_核心抽象/08_RunnableSequence序列执行** - 配置在链中的传播
- **L2_LLM核心/02_大模型API调用** - LLM 调用与回调

---

## 学习建议

### 初学者

1. 先看 [01_30字核心](./01_30字核心.md) 和 [04_最小可用](./04_最小可用.md)
2. 跟着 [07_实战代码_01_基础配置](./07_实战代码_01_基础配置.md) 动手实践
3. 遇到问题查阅 [09_化骨绵掌](./09_化骨绵掌.md)

### 进阶学习者

1. 深入理解 [02_第一性原理](./02_第一性原理.md)
2. 系统学习 5 个核心概念文件
3. 实现完整的生产监控系统

### 面试准备

1. 重点看 [08_面试必问](./08_面试必问.md)
2. 理解 [06_反直觉点](./06_反直觉点.md) 中的设计决策
3. 能够手写成本追踪和性能监控代码

---

## 总结

**RunnableConfig 和回调系统是 LangChain 的可观测性基础设施**，掌握它们对于构建生产级 AI 应用至关重要。

**核心要点**：
- RunnableConfig 的 3 个核心字段：callbacks、tags、metadata
- BaseCallbackHandler 的 3 个核心方法：on_llm_start/end/error
- LangSmith 的零配置追踪
- 成本追踪和预算告警
- 动态配置和 A/B 测试

**下一步**：
- 学习 **L1_核心抽象/10_RunnableWithFallbacks容错处理** - 错误处理和降级策略
- 学习 **L2_LLM核心/05_Prompt_Engineering进阶** - 结合回调优化 Prompt
- 学习 **L5_框架与落地/05_部署与监控** - 生产环境部署

---

**版本**：v1.0
**最后更新**：2025-02-19
**维护者**：Claude Code
