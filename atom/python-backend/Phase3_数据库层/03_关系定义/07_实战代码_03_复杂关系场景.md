# 实战代码3：复杂关系场景 - 完整的 AI Agent 数据模型

> 综合运用一对多、多对多、一对一关系，构建完整的 AI Agent 系统

---

## 场景描述

实现一个完整的 AI Agent 系统，包含：
- 用户管理（用户 → 设置，一对一）
- 对话管理（用户 → 对话，一对多）
- 消息管理（对话 → 消息，一对多）
- 标签系统（对话 ↔ 标签，多对多）
- 关注系统（用户 ↔ 用户，多对多自引用）

---

## 完整代码

```python
"""
完整的 AI Agent 数据模型
综合运用所有关系类型
"""

from datetime import datetime
from typing import List, Optional
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text, Float, JSON, Table, create_engine
from sqlalchemy.orm import relationship, DeclarativeBase, Session

# ===== 1. 基础配置 =====

class Base(DeclarativeBase):
    pass

# ===== 2. 中间表定义 =====

# 对话-标签（多对多）
conversation_tags = Table(
    'conversation_tags',
    Base.metadata,
    Column('conversation_id', ForeignKey('conversations.id'), primary_key=True),
    Column('tag_id', ForeignKey('tags.id'), primary_key=True),
    Column('created_at', DateTime, default=datetime.utcnow)
)

# 用户关注（多对多自引用）
user_follows = Table(
    'user_follows',
    Base.metadata,
    Column('follower_id', ForeignKey('users.id'), primary_key=True),
    Column('followed_id', ForeignKey('users.id'), primary_key=True),
    Column('created_at', DateTime, default=datetime.utcnow)
)

# ===== 3. 数据模型 =====

class User(Base):
    """用户模型"""
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    avatar = Column(String(200))
    created_at = Column(DateTime, default=datetime.utcnow)

    # 一对一：用户设置
    settings = relationship(
        "UserSettings",
        uselist=False,
        back_populates="user",
        cascade="all, delete-orphan"
    )

    # 一对多：用户的对话
    conversations = relationship(
        "Conversation",
        back_populates="user",
        lazy='selectin',
        cascade="all, delete-orphan",
        order_by="Conversation.created_at.desc()"
    )

    # 多对多：关注的人
    following = relationship(
        "User",
        secondary=user_follows,
        primaryjoin=id == user_follows.c.follower_id,
        secondaryjoin=id == user_follows.c.followed_id,
        back_populates="followers"
    )

    # 多对多：粉丝
    followers = relationship(
        "User",
        secondary=user_follows,
        primaryjoin=id == user_follows.c.followed_id,
        secondaryjoin=id == user_follows.c.follower_id,
        back_populates="following"
    )

    def __repr__(self):
        return f"<User(id={self.id}, username='{self.username}')>"


class UserSettings(Base):
    """用户设置模型（一对一）"""
    __tablename__ = 'user_settings'

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), unique=True, nullable=False)

    # AI 设置
    default_model = Column(String(50), default="gpt-4")
    temperature = Column(Float, default=0.7)
    max_tokens = Column(Integer, default=2000)
    system_prompt = Column(Text)
    preferences = Column(JSON)

    # 反向关系
    user = relationship("User", back_populates="settings")


class Conversation(Base):
    """对话模型"""
    __tablename__ = 'conversations'

    id = Column(Integer, primary_key=True)
    title = Column(String(200), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 外键：用户
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False, index=True)

    # 多对一：对话属于哪个用户
    user = relationship("User", back_populates="conversations")

    # 一对多：对话的消息
    messages = relationship(
        "Message",
        back_populates="conversation",
        lazy='selectin',
        cascade="all, delete-orphan",
        order_by="Message.created_at"
    )

    # 多对多：对话的标签
    tags = relationship(
        "Tag",
        secondary=conversation_tags,
        back_populates="conversations",
        lazy='selectin'
    )


class Message(Base):
    """消息模型"""
    __tablename__ = 'messages'

    id = Column(Integer, primary_key=True)
    role = Column(String(20), nullable=False)
    content = Column(Text, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    # 外键：对话
    conversation_id = Column(Integer, ForeignKey('conversations.id'), nullable=False, index=True)

    # 多对一：消息属于哪个对话
    conversation = relationship("Conversation", back_populates="messages")


class Tag(Base):
    """标签模型"""
    __tablename__ = 'tags'

    id = Column(Integer, primary_key=True)
    name = Column(String(50), unique=True, nullable=False, index=True)
    color = Column(String(7), default="#3B82F6")
    created_at = Column(DateTime, default=datetime.utcnow)

    # 多对多：标签的对话
    conversations = relationship(
        "Conversation",
        secondary=conversation_tags,
        back_populates="tags",
        lazy='selectin'
    )


# ===== 4. 数据库初始化 =====

def init_db(db_url: str = "sqlite:///./ai_agent_full.db"):
    engine = create_engine(db_url, echo=False)
    Base.metadata.create_all(engine)
    return engine


# ===== 5. 使用示例 =====

def main():
    engine = init_db()
    session = Session(engine)

    print("=== 1. 创建用户和设置（一对一）===")
    alice = User(username="alice", email="alice@example.com")
    alice_settings = UserSettings(
        user=alice,
        default_model="gpt-4-turbo",
        temperature=0.8,
        system_prompt="你是一个友好的AI助手"
    )

    bob = User(username="bob", email="bob@example.com")
    bob_settings = UserSettings(user=bob)

    session.add_all([alice, bob])
    session.commit()
    print(f"创建用户: {alice.username}, {bob.username}")

    print("\n=== 2. 创建对话（一对多）===")
    conv1 = Conversation(title="Python学习", user=alice)
    conv2 = Conversation(title="AI Agent开发", user=alice)
    conv3 = Conversation(title="FastAPI教程", user=bob)

    session.add_all([conv1, conv2, conv3])
    session.commit()
    print(f"创建对话: {conv1.title}, {conv2.title}, {conv3.title}")

    print("\n=== 3. 创建消息（一对多）===")
    msg1 = Message(role="user", content="什么是Python?", conversation=conv1)
    msg2 = Message(role="assistant", content="Python是一种编程语言", conversation=conv1)
    msg3 = Message(role="user", content="如何开发AI Agent?", conversation=conv2)

    session.add_all([msg1, msg2, msg3])
    session.commit()
    print(f"创建消息: {len([msg1, msg2, msg3])} 条")

    print("\n=== 4. 创建标签（多对多）===")
    tag1 = Tag(name="编程", color="#FF5733")
    tag2 = Tag(name="教育", color="#33FF57")
    tag3 = Tag(name="AI", color="#3357FF")

    conv1.tags.extend([tag1, tag2])
    conv2.tags.extend([tag1, tag3])
    conv3.tags.append(tag1)

    session.commit()
    print(f"创建标签: {tag1.name}, {tag2.name}, {tag3.name}")

    print("\n=== 5. 建立关注关系（多对多自引用）===")
    alice.following.append(bob)
    session.commit()
    print(f"{alice.username} 关注了 {bob.username}")

    print("\n=== 6. 完整的数据访问 ===")
    print(f"\n{alice.username} 的信息:")
    print(f"  - 默认模型: {alice.settings.default_model}")
    print(f"  - 对话数: {len(alice.conversations)}")
    print(f"  - 关注数: {len(alice.following)}")
    print(f"  - 粉丝数: {len(alice.followers)}")

    print(f"\n{alice.username} 的对话:")
    for conv in alice.conversations:
        print(f"  - {conv.title}")
        print(f"    消息数: {len(conv.messages)}")
        print(f"    标签: {[tag.name for tag in conv.tags]}")

    print(f"\n{bob.username} 的粉丝:")
    for follower in bob.followers:
        print(f"  - {follower.username}")

    print("\n=== 7. 复杂查询 ===")
    # 查询带特定标签的对话
    programming_convs = session.query(Conversation).join(
        conversation_tags
    ).join(Tag).filter(Tag.name == "编程").all()
    print(f"\n带'编程'标签的对话: {[c.title for c in programming_convs]}")

    # 查询用户的所有消息
    alice_messages = session.query(Message).join(
        Conversation
    ).filter(Conversation.user_id == alice.id).all()
    print(f"\n{alice.username} 的所有消息数: {len(alice_messages)}")

    session.close()


if __name__ == "__main__":
    main()
```

---

## 运行输出

```
=== 1. 创建用户和设置（一对一）===
创建用户: alice, bob

=== 2. 创建对话（一对多）===
创建对话: Python学习, AI Agent开发, FastAPI教程

=== 3. 创建消息（一对多）===
创建消息: 3 条

=== 4. 创建标签（多对多）===
创建标签: 编程, 教育, AI

=== 5. 建立关注关系（多对多自引用）===
alice 关注了 bob

=== 6. 完整的数据访问 ===

alice 的信息:
  - 默认模型: gpt-4-turbo
  - 对话数: 2
  - 关注数: 1
  - 粉丝数: 0

alice 的对话:
  - AI Agent开发
    消息数: 1
    标签: ['编程', 'AI']
  - Python学习
    消息数: 2
    标签: ['编程', '教育']

bob 的粉丝:
  - alice

=== 7. 复杂查询 ===

带'编程'标签的对话: ['Python学习', 'AI Agent开发', 'FastAPI教程']

alice 的所有消息数: 3
```

---

## 数据库 ER 图

```
┌─────────────┐
│    User     │
├─────────────┤
│ id (PK)     │
│ username    │
│ email       │
└─────────────┘
      │ 1:1
      ▼
┌─────────────┐
│UserSettings │
├─────────────┤
│ id (PK)     │
│ user_id(FK) │
│ model       │
└─────────────┘

      │ 1:N
      ▼
┌─────────────┐
│Conversation │
├─────────────┤
│ id (PK)     │
│ user_id(FK) │
│ title       │
└─────────────┘
      │ 1:N
      ▼
┌─────────────┐
│   Message   │
├─────────────┤
│ id (PK)     │
│ conv_id(FK) │
│ content     │
└─────────────┘

┌─────────────┐     ┌──────────────────┐     ┌─────────────┐
│Conversation │ N:M │conversation_tags │ N:M │     Tag     │
└─────────────┘────▶│ conv_id, tag_id  │◀────└─────────────┘

┌─────────────┐     ┌──────────────────┐     ┌─────────────┐
│    User     │ N:M │  user_follows    │ N:M │    User     │
└─────────────┘────▶│follower,followed │◀────└─────────────┘
```

---

## 关键技术点总结

### 1. 一对一关系（用户-设置）

```python
class User(Base):
    settings = relationship("UserSettings", uselist=False, cascade="all, delete-orphan")

class UserSettings(Base):
    user_id = Column(Integer, ForeignKey('users.id'), unique=True)
```

### 2. 一对多关系（用户-对话-消息）

```python
class User(Base):
    conversations = relationship("Conversation", cascade="all, delete-orphan")

class Conversation(Base):
    user_id = Column(Integer, ForeignKey('users.id'))
    messages = relationship("Message", cascade="all, delete-orphan")
```

### 3. 多对多关系（对话-标签）

```python
conversation_tags = Table(...)

class Conversation(Base):
    tags = relationship("Tag", secondary=conversation_tags)
```

### 4. 多对多自引用（用户关注）

```python
user_follows = Table(...)

class User(Base):
    following = relationship(
        "User",
        secondary=user_follows,
        primaryjoin=id == user_follows.c.follower_id,
        secondaryjoin=id == user_follows.c.followed_id
    )
```

---

## 总结

这个完整示例展示了：
1. ✅ 一对一关系（用户-设置）
2. ✅ 一对多关系（用户-对话-消息）
3. ✅ 多对多关系（对话-标签）
4. ✅ 多对多自引用（用户关注）
5. ✅ 级联删除
6. ✅ 复杂查询
7. ✅ 完整的数据模型设计

**适用场景：**
- AI Agent 系统
- 社交网络
- 内容管理系统
- 任何需要复杂关系的应用
