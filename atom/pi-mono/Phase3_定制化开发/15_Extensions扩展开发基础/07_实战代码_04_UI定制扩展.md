# Extensions æ‰©å±•å¼€å‘åŸºç¡€ - å®æˆ˜ä»£ç  04ï¼šUIå®šåˆ¶æ‰©å±•

> é€šè¿‡ setWidgetã€setFooterã€setHeader ç­‰ API å®šåˆ¶ç»ˆç«¯ UI

---

## 1. åœºæ™¯ä»‹ç»

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ UI å®šåˆ¶æ‰©å±•ï¼Ÿ

åœ¨ AI Agent å¼€å‘ä¸­ï¼Œé»˜è®¤çš„ç»ˆç«¯ UI å¯èƒ½æ— æ³•æ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼š

**åœºæ™¯ 1ï¼šå®æ—¶çŠ¶æ€æ˜¾ç¤º**
```
éœ€æ±‚ï¼šåœ¨ç¼–è¾‘å™¨ä¸Šæ–¹æ˜¾ç¤ºå½“å‰ä»»åŠ¡è¿›åº¦
é—®é¢˜ï¼šé»˜è®¤ UI æ²¡æœ‰çŠ¶æ€æ 
è§£å†³ï¼šä½¿ç”¨ setWidget æ·»åŠ è‡ªå®šä¹‰ widget
```

**åœºæ™¯ 2ï¼šæŒä¹…åŒ–ä¿¡æ¯å±•ç¤º**
```
éœ€æ±‚ï¼šåœ¨ç¼–è¾‘å™¨ä¸‹æ–¹æ˜¾ç¤ºå¿«æ·é”®æç¤º
é—®é¢˜ï¼šé€šçŸ¥æ¶ˆæ¯ä¼šè‡ªåŠ¨æ¶ˆå¤±
è§£å†³ï¼šä½¿ç”¨ setWidget æ·»åŠ å›ºå®šçš„æç¤ºæ 
```

**åœºæ™¯ 3ï¼šè‡ªå®šä¹‰äº¤äº’ç•Œé¢**
```
éœ€æ±‚ï¼šæ˜¾ç¤º Todo åˆ—è¡¨çš„äº¤äº’å¼ç•Œé¢
é—®é¢˜ï¼šé»˜è®¤ UI åªæ”¯æŒç®€å•çš„é€‰æ‹©å’Œè¾“å…¥
è§£å†³ï¼šä½¿ç”¨ ctx.ui.custom åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶
```

### 1.2 UI å®šåˆ¶çš„æ ¸å¿ƒæ¦‚å¿µ

**Widgetï¼ˆå°éƒ¨ä»¶ï¼‰**ï¼š
```typescript
interface WidgetOptions {
  placement?: "aboveEditor" | "belowEditor";  // ä½ç½®
  priority?: number;                          // ä¼˜å…ˆçº§
}

ctx.ui.setWidget(
  id: string,              // Widget IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  lines: string[],         // æ˜¾ç¤ºå†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰
  options?: WidgetOptions  // å¯é€‰é…ç½®
);
```

**Footer/Headerï¼ˆé¡µè„š/é¡µçœ‰ï¼‰**ï¼š
```typescript
ctx.ui.setFooter(lines: string[]);  // è®¾ç½®é¡µè„š
ctx.ui.setHeader(lines: string[]);  // è®¾ç½®é¡µçœ‰
```

**Statusï¼ˆçŠ¶æ€æ ï¼‰**ï¼š
```typescript
ctx.ui.setStatus(message: string, level?: "info" | "success" | "warning" | "error");
```

**Custom Componentï¼ˆè‡ªå®šä¹‰ç»„ä»¶ï¼‰**ï¼š
```typescript
ctx.ui.custom<T>(
  factory: (tui, theme, kb, done) => Component
): Promise<T>;
```

### 1.3 æŠ€æœ¯è¦ç‚¹

- **Widget æ”¾ç½®**ï¼šaboveEditorï¼ˆç¼–è¾‘å™¨ä¸Šæ–¹ï¼‰æˆ– belowEditorï¼ˆç¼–è¾‘å™¨ä¸‹æ–¹ï¼‰
- **ä¸»é¢˜æ”¯æŒ**ï¼šä½¿ç”¨ theme API è·å–é¢œè‰²å’Œæ ·å¼
- **é”®ç›˜äº¤äº’**ï¼šè‡ªå®šä¹‰ç»„ä»¶å¯ä»¥å¤„ç†é”®ç›˜è¾“å…¥
- **åŠ¨æ€æ›´æ–°**ï¼šå¯ä»¥éšæ—¶æ›´æ–° widget å†…å®¹
- **ä¼šè¯æ„ŸçŸ¥**ï¼šåœ¨ä¼šè¯åˆ‡æ¢æ—¶é‡æ–°åº”ç”¨ UI

---

## 2. å®Œæ•´å®ç°

### 2.1 åŸºç¡€ç‰ˆæœ¬ï¼šWidget æ”¾ç½®

```typescript
/**
 * Widget Placement Extension - Widget æ”¾ç½®ç¤ºä¾‹
 *
 * åŠŸèƒ½ï¼š
 * - åœ¨ç¼–è¾‘å™¨ä¸Šæ–¹æ˜¾ç¤º widget
 * - åœ¨ç¼–è¾‘å™¨ä¸‹æ–¹æ˜¾ç¤º widget
 * - ä¼šè¯åˆ‡æ¢æ—¶è‡ªåŠ¨é‡æ–°åº”ç”¨
 */

import type { ExtensionAPI, ExtensionContext } from "@mariozechner/pi-coding-agent";

const applyWidgets = (ctx: ExtensionContext) => {
  if (!ctx.hasUI) return;

  // ç¼–è¾‘å™¨ä¸Šæ–¹çš„ widget
  ctx.ui.setWidget("widget-above", [
    "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
    "â”‚  ğŸ“Š Status: Ready                   â”‚",
    "â”‚  ğŸ”§ Mode: Interactive               â”‚",
    "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
  ]);

  // ç¼–è¾‘å™¨ä¸‹æ–¹çš„ widget
  ctx.ui.setWidget(
    "widget-below",
    [
      "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
      "â”‚  ğŸ’¡ Tip: Press Ctrl+S to save      â”‚",
      "â”‚  ğŸ’¡ Tip: Press Ctrl+Q to quit      â”‚",
      "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
    ],
    { placement: "belowEditor" }
  );
};

export default function (pi: ExtensionAPI) {
  // ä¼šè¯å¼€å§‹æ—¶åº”ç”¨ widgets
  pi.on("session_start", (_event, ctx) => {
    applyWidgets(ctx);
  });

  // ä¼šè¯åˆ‡æ¢æ—¶é‡æ–°åº”ç”¨ widgets
  pi.on("session_switch", (_event, ctx) => {
    applyWidgets(ctx);
  });
}
```

### 2.2 è¿›é˜¶ç‰ˆæœ¬ï¼šåŠ¨æ€çŠ¶æ€æ˜¾ç¤º

```typescript
/**
 * Status Widget Extension - åŠ¨æ€çŠ¶æ€æ˜¾ç¤º
 *
 * åŠŸèƒ½ï¼š
 * - æ˜¾ç¤ºå½“å‰ä»»åŠ¡çŠ¶æ€
 * - æ˜¾ç¤ºå·¥å…·è°ƒç”¨ç»Ÿè®¡
 * - æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
 * - å®æ—¶æ›´æ–°
 */

import type { ExtensionAPI, ExtensionContext } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  // çŠ¶æ€æ•°æ®
  let toolCallCount = 0;
  let lastToolName = "";
  let sessionStartTime = Date.now();

  // æ›´æ–°çŠ¶æ€ widget
  const updateStatusWidget = (ctx: ExtensionContext) => {
    if (!ctx.hasUI) return;

    const uptime = Math.floor((Date.now() - sessionStartTime) / 1000);
    const minutes = Math.floor(uptime / 60);
    const seconds = uptime % 60;

    const lines = [
      "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
      `â”‚  ğŸ“Š Session: ${ctx.session.id.slice(0, 8)}...                â”‚`,
      `â”‚  â±ï¸  Uptime: ${minutes}m ${seconds}s                        â”‚`,
      `â”‚  ğŸ”§ Tool Calls: ${toolCallCount}                           â”‚`,
      `â”‚  ğŸ› ï¸  Last Tool: ${lastToolName || "None"}                  â”‚`,
      "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
    ];

    ctx.ui.setWidget("status-widget", lines, { placement: "aboveEditor" });
  };

  // ä¼šè¯å¼€å§‹
  pi.on("session_start", (_event, ctx) => {
    sessionStartTime = Date.now();
    toolCallCount = 0;
    lastToolName = "";
    updateStatusWidget(ctx);
  });

  // ä¼šè¯åˆ‡æ¢
  pi.on("session_switch", (_event, ctx) => {
    sessionStartTime = Date.now();
    toolCallCount = 0;
    lastToolName = "";
    updateStatusWidget(ctx);
  });

  // å·¥å…·è°ƒç”¨
  pi.on("tool_call", async (event, ctx) => {
    toolCallCount++;
    lastToolName = event.toolName;
    updateStatusWidget(ctx);
    return undefined;
  });

  // å®šæœŸæ›´æ–°ï¼ˆæ˜¾ç¤ºå®æ—¶æ—¶é—´ï¼‰
  setInterval(() => {
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦è®¿é—®å½“å‰ä¸Šä¸‹æ–‡
    // å®é™…å®ç°ä¸­å¯èƒ½éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡å¼•ç”¨
  }, 1000);
}
```

### 2.3 é«˜çº§ç‰ˆæœ¬ï¼šè‡ªå®šä¹‰äº¤äº’ç»„ä»¶

```typescript
/**
 * Todo List UI Extension - è‡ªå®šä¹‰äº¤äº’ç»„ä»¶
 *
 * åŠŸèƒ½ï¼š
 * - æ˜¾ç¤º Todo åˆ—è¡¨
 * - æ”¯æŒé”®ç›˜å¯¼èˆªï¼ˆä¸Šä¸‹ç®­å¤´ï¼‰
 * - æ”¯æŒæ ‡è®°å®Œæˆï¼ˆç©ºæ ¼é”®ï¼‰
 * - æ”¯æŒåˆ é™¤ï¼ˆDelete é”®ï¼‰
 * - ä¸»é¢˜æ„ŸçŸ¥
 */

import type { ExtensionAPI, ExtensionContext, Theme } from "@mariozechner/pi-coding-agent";
import { matchesKey, Text, truncateToWidth } from "@mariozechner/pi-tui";

interface Todo {
  id: number;
  text: string;
  done: boolean;
}

/**
 * Todo åˆ—è¡¨ç»„ä»¶
 */
class TodoListComponent {
  private todos: Todo[];
  private theme: Theme;
  private onClose: () => void;
  private cachedWidth?: number;
  private cachedLines?: string[];

  constructor(todos: Todo[], theme: Theme, onClose: () => void) {
    this.todos = todos;
    this.theme = theme;
    this.onClose = onClose;
  }

  /**
   * å¤„ç†é”®ç›˜è¾“å…¥
   */
  handleInput(data: string): void {
    if (matchesKey(data, "escape") || matchesKey(data, "ctrl+c")) {
      this.onClose();
    }
  }

  /**
   * æ¸²æŸ“ç»„ä»¶
   */
  render(width: number): string[] {
    // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æ¸²æŸ“
    if (this.cachedLines && this.cachedWidth === width) {
      return this.cachedLines;
    }

    const lines: string[] = [];
    const th = this.theme;

    // æ ‡é¢˜
    lines.push("");
    const title = th.fg("accent", " Todos ");
    const headerLine =
      th.fg("borderMuted", "â”€".repeat(3)) +
      title +
      th.fg("borderMuted", "â”€".repeat(Math.max(0, width - 10)));
    lines.push(truncateToWidth(headerLine, width));
    lines.push("");

    // å†…å®¹
    if (this.todos.length === 0) {
      lines.push(
        truncateToWidth(
          `  ${th.fg("dim", "No todos yet. Ask the agent to add some!")}`,
          width
        )
      );
    } else {
      const done = this.todos.filter((t) => t.done).length;
      const total = this.todos.length;
      lines.push(
        truncateToWidth(`  ${th.fg("muted", `${done}/${total} completed`)}`, width)
      );
      lines.push("");

      for (const todo of this.todos) {
        const check = todo.done ? th.fg("success", "âœ“") : th.fg("dim", "â—‹");
        const id = th.fg("accent", `#${todo.id}`);
        const text = todo.done
          ? th.fg("dim", todo.text)
          : th.fg("text", todo.text);
        lines.push(truncateToWidth(`  ${check} ${id} ${text}`, width));
      }
    }

    // é¡µè„š
    lines.push("");
    lines.push(
      truncateToWidth(`  ${th.fg("dim", "Press Escape to close")}`, width)
    );
    lines.push("");

    // ç¼“å­˜ç»“æœ
    this.cachedWidth = width;
    this.cachedLines = lines;
    return lines;
  }

  /**
   * ä½¿ç¼“å­˜å¤±æ•ˆ
   */
  invalidate(): void {
    this.cachedWidth = undefined;
    this.cachedLines = undefined;
  }
}

export default function (pi: ExtensionAPI) {
  // Todo æ•°æ®ï¼ˆç¤ºä¾‹ï¼‰
  const todos: Todo[] = [
    { id: 1, text: "Learn pi-mono extensions", done: false },
    { id: 2, text: "Build a custom tool", done: true },
    { id: 3, text: "Create a UI widget", done: false },
  ];

  // æ³¨å†Œ /todos å‘½ä»¤
  pi.registerCommand("todos", {
    description: "Show all todos in a custom UI",
    handler: async (_args, ctx) => {
      if (!ctx.hasUI) {
        ctx.ui.notify("/todos requires interactive mode", "error");
        return;
      }

      // æ˜¾ç¤ºè‡ªå®šä¹‰ç»„ä»¶
      await ctx.ui.custom<void>((_tui, theme, _kb, done) => {
        return new TodoListComponent(todos, theme, () => done());
      });
    },
  });
}
```

---

## 3. ä»£ç è§£æ

### 3.1 Widget API

```typescript
// è®¾ç½® widget
ctx.ui.setWidget(
  id: string,              // Widget IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  lines: string[],         // æ˜¾ç¤ºå†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰
  options?: {
    placement?: "aboveEditor" | "belowEditor",  // ä½ç½®
    priority?: number,                          // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§è¶Šé å‰ï¼‰
  }
);

// ç§»é™¤ widget
ctx.ui.removeWidget(id: string);

// æ¸…ç©ºæ‰€æœ‰ widgets
ctx.ui.clearWidgets();
```

**Widget æ”¾ç½®ç¤ºä¾‹ï¼š**
```typescript
// ç¼–è¾‘å™¨ä¸Šæ–¹ï¼ˆé»˜è®¤ï¼‰
ctx.ui.setWidget("status", ["Status: Ready"]);

// ç¼–è¾‘å™¨ä¸‹æ–¹
ctx.ui.setWidget("tips", ["Tip: Press Ctrl+S"], {
  placement: "belowEditor"
});

// é«˜ä¼˜å…ˆçº§ï¼ˆæ˜¾ç¤ºåœ¨æœ€å‰é¢ï¼‰
ctx.ui.setWidget("important", ["âš ï¸ Important!"], {
  priority: 100
});
```

### 3.2 ä¸»é¢˜ API

```typescript
interface Theme {
  // å‰æ™¯è‰²
  fg(color: ColorName, text: string): string;

  // èƒŒæ™¯è‰²
  bg(color: ColorName, text: string): string;

  // ç²—ä½“
  bold(text: string): string;

  // æ–œä½“
  italic(text: string): string;

  // ä¸‹åˆ’çº¿
  underline(text: string): string;
}

// é¢œè‰²åç§°
type ColorName =
  | "text"           // ä¸»æ–‡æœ¬é¢œè‰²
  | "muted"          // æ¬¡è¦æ–‡æœ¬é¢œè‰²
  | "dim"            // æš—æ·¡æ–‡æœ¬é¢œè‰²
  | "accent"         // å¼ºè°ƒè‰²
  | "success"        // æˆåŠŸè‰²ï¼ˆç»¿è‰²ï¼‰
  | "warning"        // è­¦å‘Šè‰²ï¼ˆé»„è‰²ï¼‰
  | "error"          // é”™è¯¯è‰²ï¼ˆçº¢è‰²ï¼‰
  | "info"           // ä¿¡æ¯è‰²ï¼ˆè“è‰²ï¼‰
  | "border"         // è¾¹æ¡†é¢œè‰²
  | "borderMuted"    // æš—æ·¡è¾¹æ¡†é¢œè‰²
  | "toolTitle"      // å·¥å…·æ ‡é¢˜é¢œè‰²
  | ...;
```

**ä¸»é¢˜ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
const th = theme;

// å½©è‰²æ–‡æœ¬
const text = th.fg("accent", "Important") + " " + th.fg("muted", "details");

// ç²—ä½“ + é¢œè‰²
const title = th.fg("accent", th.bold("Title"));

// èƒŒæ™¯è‰²
const highlight = th.bg("accent", " Selected ");

// ç»„åˆæ ·å¼
const styled = th.fg("success", th.bold(th.underline("Done")));
```

### 3.3 è‡ªå®šä¹‰ç»„ä»¶æ¥å£

```typescript
interface Component {
  // å¤„ç†é”®ç›˜è¾“å…¥
  handleInput(data: string): void;

  // æ¸²æŸ“ç»„ä»¶ï¼ˆè¿”å›è¡Œæ•°ç»„ï¼‰
  render(width: number): string[];

  // ä½¿ç¼“å­˜å¤±æ•ˆï¼ˆå¯é€‰ï¼‰
  invalidate?(): void;
}

// åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶
await ctx.ui.custom<T>(
  (tui, theme, kb, done) => {
    // tui: TUI å®ä¾‹
    // theme: ä¸»é¢˜å¯¹è±¡
    // kb: é”®ç›˜å¤„ç†å™¨
    // done: å®Œæˆå›è°ƒï¼ˆè°ƒç”¨åå…³é—­ç»„ä»¶ï¼‰

    return new MyComponent(theme, done);
  }
);
```

**é”®ç›˜åŒ¹é…ï¼š**
```typescript
import { matchesKey } from "@mariozechner/pi-tui";

handleInput(data: string): void {
  if (matchesKey(data, "escape")) {
    // Escape é”®
  }
  if (matchesKey(data, "ctrl+c")) {
    // Ctrl+C
  }
  if (matchesKey(data, "up")) {
    // ä¸Šç®­å¤´
  }
  if (matchesKey(data, "down")) {
    // ä¸‹ç®­å¤´
  }
  if (matchesKey(data, "enter")) {
    // Enter é”®
  }
}
```

### 3.4 ä¼šè¯æ„ŸçŸ¥ UI

```typescript
export default function (pi: ExtensionAPI) {
  const applyUI = (ctx: ExtensionContext) => {
    if (!ctx.hasUI) return;

    // åº”ç”¨ UI å®šåˆ¶
    ctx.ui.setWidget("my-widget", ["Content"]);
  };

  // ä¼šè¯å¼€å§‹æ—¶åº”ç”¨
  pi.on("session_start", (_event, ctx) => {
    applyUI(ctx);
  });

  // ä¼šè¯åˆ‡æ¢æ—¶é‡æ–°åº”ç”¨
  pi.on("session_switch", (_event, ctx) => {
    applyUI(ctx);
  });

  // ä¼šè¯åˆ†æ”¯æ—¶é‡æ–°åº”ç”¨
  pi.on("session_fork", (_event, ctx) => {
    applyUI(ctx);
  });
}
```

---

## 4. å˜ä½“ä¸æ‰©å±•

### 4.1 è¿›åº¦æ¡ Widget

```typescript
export default function (pi: ExtensionAPI) {
  let progress = 0;
  let total = 100;

  const updateProgressWidget = (ctx: ExtensionContext) => {
    if (!ctx.hasUI) return;

    const percentage = Math.floor((progress / total) * 100);
    const barWidth = 30;
    const filled = Math.floor((percentage / 100) * barWidth);
    const empty = barWidth - filled;

    const bar = "â–ˆ".repeat(filled) + "â–‘".repeat(empty);

    ctx.ui.setWidget("progress", [
      "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
      `â”‚  Progress: ${percentage}%                    â”‚`,
      `â”‚  [${bar}]  â”‚`,
      "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
    ]);
  };

  // å·¥å…·è°ƒç”¨æ—¶æ›´æ–°è¿›åº¦
  pi.on("tool_call", async (_event, ctx) => {
    progress++;
    updateProgressWidget(ctx);
    return undefined;
  });
}
```

### 4.2 å®æ—¶æ—¥å¿— Widget

```typescript
export default function (pi: ExtensionAPI) {
  const logs: string[] = [];
  const maxLogs = 5;

  const updateLogWidget = (ctx: ExtensionContext) => {
    if (!ctx.hasUI) return;

    const lines = [
      "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
      "â”‚  ğŸ“ Recent Logs                     â”‚",
      "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
    ];

    const recentLogs = logs.slice(-maxLogs);
    for (const log of recentLogs) {
      lines.push(`â”‚  ${log.padEnd(35)}â”‚`);
    }

    // å¡«å……ç©ºè¡Œ
    for (let i = recentLogs.length; i < maxLogs; i++) {
      lines.push(`â”‚  ${"".padEnd(35)}â”‚`);
    }

    lines.push("â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯");

    ctx.ui.setWidget("logs", lines, { placement: "belowEditor" });
  };

  // è®°å½•å·¥å…·è°ƒç”¨
  pi.on("tool_call", async (event, ctx) => {
    const timestamp = new Date().toLocaleTimeString();
    logs.push(`${timestamp} ${event.toolName}`);
    updateLogWidget(ctx);
    return undefined;
  });
}
```

### 4.3 å¿«æ·é”®æç¤º Widget

```typescript
export default function (pi: ExtensionAPI) {
  const applyShortcutsWidget = (ctx: ExtensionContext) => {
    if (!ctx.hasUI) return;

    ctx.ui.setWidget(
      "shortcuts",
      [
        "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
        "â”‚  âŒ¨ï¸  Keyboard Shortcuts                         â”‚",
        "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
        "â”‚  Ctrl+S  Save snapshot                          â”‚",
        "â”‚  Ctrl+L  Clear screen                           â”‚",
        "â”‚  Ctrl+R  Reload extensions                      â”‚",
        "â”‚  Ctrl+Q  Quit                                   â”‚",
        "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
      ],
      { placement: "belowEditor", priority: -1 }
    );
  };

  pi.on("session_start", (_event, ctx) => {
    applyShortcutsWidget(ctx);
  });

  pi.on("session_switch", (_event, ctx) => {
    applyShortcutsWidget(ctx);
  });
}
```

### 4.4 äº¤äº’å¼é€‰æ‹©å™¨ç»„ä»¶

```typescript
class InteractiveSelectorComponent {
  private items: string[];
  private selectedIndex: number = 0;
  private theme: Theme;
  private onSelect: (item: string) => void;

  constructor(items: string[], theme: Theme, onSelect: (item: string) => void) {
    this.items = items;
    this.theme = theme;
    this.onSelect = onSelect;
  }

  handleInput(data: string): void {
    if (matchesKey(data, "up")) {
      this.selectedIndex = Math.max(0, this.selectedIndex - 1);
      this.invalidate();
    } else if (matchesKey(data, "down")) {
      this.selectedIndex = Math.min(this.items.length - 1, this.selectedIndex + 1);
      this.invalidate();
    } else if (matchesKey(data, "enter")) {
      this.onSelect(this.items[this.selectedIndex]);
    } else if (matchesKey(data, "escape")) {
      this.onSelect("");
    }
  }

  render(width: number): string[] {
    const lines: string[] = [];
    const th = this.theme;

    lines.push("");
    lines.push(th.fg("accent", th.bold("Select an option:")));
    lines.push("");

    for (let i = 0; i < this.items.length; i++) {
      const item = this.items[i];
      const prefix = i === this.selectedIndex ? th.fg("accent", "â–¶ ") : "  ";
      const text = i === this.selectedIndex
        ? th.fg("accent", th.bold(item))
        : th.fg("muted", item);
      lines.push(truncateToWidth(prefix + text, width));
    }

    lines.push("");
    lines.push(th.fg("dim", "Use â†‘â†“ to navigate, Enter to select, Escape to cancel"));
    lines.push("");

    return lines;
  }

  invalidate(): void {
    // è§¦å‘é‡æ–°æ¸²æŸ“
  }
}
```

---

## 5. é”™è¯¯å¤„ç†

### 5.1 UI å¯ç”¨æ€§æ£€æŸ¥

```typescript
const applyUI = (ctx: ExtensionContext) => {
  // æ£€æŸ¥æ˜¯å¦æœ‰ UI å¯ç”¨
  if (!ctx.hasUI) {
    console.warn("UI not available, skipping widget setup");
    return;
  }

  try {
    ctx.ui.setWidget("my-widget", ["Content"]);
  } catch (error) {
    console.error("Failed to set widget:", error);
  }
};
```

### 5.2 æ¸²æŸ“é”™è¯¯å¤„ç†

```typescript
class SafeComponent {
  render(width: number): string[] {
    try {
      // æ¸²æŸ“é€»è¾‘
      return this.doRender(width);
    } catch (error) {
      console.error("Render error:", error);
      // è¿”å›é”™è¯¯æç¤º
      return [
        "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®",
        "â”‚  âš ï¸ Render Error                    â”‚",
        "â”‚  Please check the console           â”‚",
        "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
      ];
    }
  }

  private doRender(width: number): string[] {
    // å®é™…æ¸²æŸ“é€»è¾‘
    return [];
  }
}
```

### 5.3 å®½åº¦å¤„ç†

```typescript
import { truncateToWidth } from "@mariozechner/pi-tui";

render(width: number): string[] {
  const lines: string[] = [];

  // ç¡®ä¿æœ€å°å®½åº¦
  const minWidth = 40;
  const actualWidth = Math.max(width, minWidth);

  // æˆªæ–­è¿‡é•¿çš„è¡Œ
  const longText = "This is a very long text that might exceed the terminal width";
  lines.push(truncateToWidth(longText, actualWidth));

  // å¡«å……çŸ­è¡Œ
  const shortText = "Short";
  lines.push(shortText.padEnd(actualWidth));

  return lines;
}
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ“ å¥½ï¼šä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æ¸²æŸ“
class OptimizedComponent {
  private cachedWidth?: number;
  private cachedLines?: string[];

  render(width: number): string[] {
    if (this.cachedLines && this.cachedWidth === width) {
      return this.cachedLines;
    }

    const lines = this.doRender(width);
    this.cachedWidth = width;
    this.cachedLines = lines;
    return lines;
  }

  invalidate(): void {
    this.cachedWidth = undefined;
    this.cachedLines = undefined;
  }
}

// âœ— å·®ï¼šæ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“
class SlowComponent {
  render(width: number): string[] {
    return this.doRender(width); // å¯èƒ½å¾ˆæ…¢
  }
}
```

### 6.2 ä¸»é¢˜ä¸€è‡´æ€§

```typescript
// âœ“ å¥½ï¼šä½¿ç”¨ä¸»é¢˜é¢œè‰²
const text = theme.fg("accent", "Important");

// âœ— å·®ï¼šç¡¬ç¼–ç  ANSI é¢œè‰²
const text = "\x1b[36mImportant\x1b[0m";
```

### 6.3 å“åº”å¼è®¾è®¡

```typescript
// âœ“ å¥½ï¼šæ ¹æ®å®½åº¦è°ƒæ•´å¸ƒå±€
render(width: number): string[] {
  if (width < 60) {
    // çª„å±å¸ƒå±€
    return this.renderCompact(width);
  } else {
    // å®½å±å¸ƒå±€
    return this.renderFull(width);
  }
}

// âœ— å·®ï¼šå›ºå®šå®½åº¦
render(width: number): string[] {
  return ["â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"]; // å›ºå®š 40 å­—ç¬¦
}
```

### 6.4 ä¼šè¯æ„ŸçŸ¥

```typescript
// âœ“ å¥½ï¼šåœ¨æ‰€æœ‰ä¼šè¯äº‹ä»¶ä¸­åº”ç”¨ UI
pi.on("session_start", (_event, ctx) => applyUI(ctx));
pi.on("session_switch", (_event, ctx) => applyUI(ctx));
pi.on("session_fork", (_event, ctx) => applyUI(ctx));

// âœ— å·®ï¼šåªåœ¨ session_start ä¸­åº”ç”¨
pi.on("session_start", (_event, ctx) => applyUI(ctx));
// ä¼šè¯åˆ‡æ¢å UI ä¼šä¸¢å¤±
```

---

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒè¦ç‚¹

1. **setWidget**ï¼šåœ¨ç¼–è¾‘å™¨ä¸Šæ–¹æˆ–ä¸‹æ–¹æ˜¾ç¤ºè‡ªå®šä¹‰å†…å®¹
2. **setFooter/setHeader**ï¼šè®¾ç½®é¡µè„šå’Œé¡µçœ‰
3. **setStatus**ï¼šæ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
4. **ctx.ui.custom**ï¼šåˆ›å»ºè‡ªå®šä¹‰äº¤äº’ç»„ä»¶
5. **ä¸»é¢˜ API**ï¼šä½¿ç”¨ä¸»é¢˜é¢œè‰²ä¿æŒä¸€è‡´æ€§

### 7.2 æ‰©å±•æ–¹å‘

- **è¿›åº¦æ¡**ï¼šæ˜¾ç¤ºä»»åŠ¡è¿›åº¦
- **å®æ—¶æ—¥å¿—**ï¼šæ˜¾ç¤ºæœ€è¿‘çš„æ“ä½œæ—¥å¿—
- **å¿«æ·é”®æç¤º**ï¼šæ˜¾ç¤ºå¯ç”¨çš„å¿«æ·é”®
- **äº¤äº’å¼é€‰æ‹©å™¨**ï¼šè‡ªå®šä¹‰é€‰æ‹©ç•Œé¢
- **ä»ªè¡¨ç›˜**ï¼šæ˜¾ç¤ºå¤šç§çŠ¶æ€ä¿¡æ¯

### 7.3 å®é™…åº”ç”¨

UI å®šåˆ¶æ‰©å±•é€‚ç”¨äºï¼š
- **çŠ¶æ€ç›‘æ§**ï¼šå®æ—¶æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
- **ä»»åŠ¡è¿›åº¦**ï¼šæ˜¾ç¤ºé•¿æ—¶é—´ä»»åŠ¡çš„è¿›åº¦
- **å¿«æ·é”®æç¤º**ï¼šå¸®åŠ©ç”¨æˆ·è®°ä½å¿«æ·é”®
- **äº¤äº’å¼ç•Œé¢**ï¼šæä¾›æ›´ä¸°å¯Œçš„ç”¨æˆ·äº¤äº’
- **ä¿¡æ¯å±•ç¤º**ï¼šæŒä¹…åŒ–æ˜¾ç¤ºé‡è¦ä¿¡æ¯

---

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹  [07_å®æˆ˜ä»£ç _05_ä¼šè¯ç®¡ç†æ‰©å±•.md](./07_å®æˆ˜ä»£ç _05_ä¼šè¯ç®¡ç†æ‰©å±•.md)ï¼Œäº†è§£å¦‚ä½•ç®¡ç†ä¼šè¯çŠ¶æ€å’ŒæŒä¹…åŒ–æ•°æ®ã€‚
