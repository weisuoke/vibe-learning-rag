# 向量检索 pgvector - 概览

> **AI Agent 的向量检索能力**：pgvector 是 PostgreSQL 的向量扩展，为 AI Agent 提供高性能的语义检索能力，是 RAG 系统的数据库基础。

---

## 知识点定位

**所属阶段：** Phase3_数据库层（第6个知识点）

**前置知识：**
- SQLAlchemy ORM 基础
- Session 管理
- 关系定义
- 数据库迁移 Alembic
- 连接池配置

**后续学习：**
- Phase4_AI_Agent 开发
- RAG 检索链
- 向量检索优化

---

## 学习目标

完成本知识点后，你将能够：

- [ ] 理解 pgvector 的核心原理和应用场景
- [ ] 在 PostgreSQL 中创建和操作向量表
- [ ] 使用三种距离函数进行相似度检索
- [ ] 创建和优化 HNSW/IVFFlat 索引
- [ ] 构建完整的 RAG 文档问答系统
- [ ] 评估和优化向量检索性能

---

## 文档结构

本知识点包含10个维度的详细文档：

### 基础维度

| 文件 | 内容 | 预计阅读时间 |
|------|------|-------------|
| [01_30字核心.md](./01_30字核心.md) | 一句话说清 pgvector | 1 分钟 |
| [10_一句话总结.md](./10_一句话总结.md) | 完整总结 pgvector | 1 分钟 |

### 核心理论

| 文件 | 内容 | 预计阅读时间 |
|------|------|-------------|
| [02_第一性原理.md](./02_第一性原理.md) | 从根本原理理解 pgvector | 15 分钟 |
| [03_核心概念.md](./03_核心概念.md) | 3个核心概念导航 | 2 分钟 |
| [03_核心概念_1_向量存储.md](./03_核心概念_1_向量存储.md) | vector 数据类型和 CRUD | 20 分钟 |
| [03_核心概念_2_相似度搜索.md](./03_核心概念_2_相似度搜索.md) | 三种距离函数和 Top-K 检索 | 25 分钟 |
| [03_核心概念_3_索引策略.md](./03_核心概念_3_索引策略.md) | HNSW 和 IVFFlat 索引 | 30 分钟 |

### 实用技巧

| 文件 | 内容 | 预计阅读时间 |
|------|------|-------------|
| [04_最小可用.md](./04_最小可用.md) | 20%核心知识解决80%问题 | 15 分钟 |
| [05_双重类比.md](./05_双重类比.md) | 前端类比 + 日常生活类比 | 10 分钟 |
| [06_反直觉点.md](./06_反直觉点.md) | 5个常见误区和正确理解 | 10 分钟 |

### 实战代码

| 文件 | 内容 | 预计阅读时间 |
|------|------|-------------|
| [07_实战代码.md](./07_实战代码.md) | 4个场景导航 | 2 分钟 |
| [07_实战代码_1_基础CRUD.md](./07_实战代码_1_基础CRUD.md) | 向量的增删改查 | 20 分钟 |
| [07_实战代码_2_相似度检索.md](./07_实战代码_2_相似度检索.md) | 距离函数和过滤条件 | 25 分钟 |
| [07_实战代码_3_RAG集成.md](./07_实战代码_3_RAG集成.md) | 完整的 RAG 系统实现 | 35 分钟 |
| [07_实战代码_4_索引优化.md](./07_实战代码_4_索引优化.md) | 性能测试和参数调优 | 30 分钟 |

### 进阶内容

| 文件 | 内容 | 预计阅读时间 |
|------|------|-------------|
| [08_面试必问.md](./08_面试必问.md) | 3个高频面试问题 | 15 分钟 |
| [09_化骨绵掌.md](./09_化骨绵掌.md) | 10个2分钟知识卡片 | 20 分钟 |

---

## 学习路径建议

### 快速入门（1小时）

适合快速了解 pgvector 的基本用法：

1. **30字核心**（1分钟）→ 快速理解是什么
2. **最小可用**（15分钟）→ 掌握核心操作
3. **实战代码_1_基础CRUD**（20分钟）→ 动手实践
4. **实战代码_2_相似度检索**（25分钟）→ 学会检索

### 系统学习（4小时）

适合系统掌握 pgvector 的完整知识：

1. **第一性原理**（15分钟）→ 理解根本原理
2. **核心概念_1_向量存储**（20分钟）→ 掌握数据类型
3. **核心概念_2_相似度搜索**（25分钟）→ 掌握检索方法
4. **核心概念_3_索引策略**（30分钟）→ 掌握性能优化
5. **实战代码_3_RAG集成**（35分钟）→ 构建完整系统
6. **实战代码_4_索引优化**（30分钟）→ 性能调优
7. **双重类比**（10分钟）→ 加深理解
8. **反直觉点**（10分钟）→ 避免误区
9. **面试必问**（15分钟）→ 准备面试
10. **化骨绵掌**（20分钟）→ 系统复习

### 实战导向（2小时）

适合快速上手构建 RAG 系统：

1. **30字核心**（1分钟）→ 快速理解
2. **最小可用**（15分钟）→ 核心操作
3. **实战代码_1_基础CRUD**（20分钟）→ 基础操作
4. **实战代码_3_RAG集成**（35分钟）→ 完整系统
5. **实战代码_4_索引优化**（30分钟）→ 性能优化
6. **反直觉点**（10分钟）→ 避免误区
7. **化骨绵掌**（20分钟）→ 快速复习

---

## 核心知识地图

```
pgvector 向量检索
│
├─ 向量存储
│  ├─ vector(N) 数据类型
│  ├─ 向量 CRUD 操作
│  └─ 存储优化（halfvec、分区）
│
├─ 相似度搜索
│  ├─ 余弦距离（<=>）- 文本
│  ├─ 欧氏距离（<->）- 图像
│  ├─ 内积距离（<#>）- 推荐
│  ├─ Top-K 检索
│  └─ 过滤条件组合
│
├─ 索引策略
│  ├─ HNSW 索引
│  │  ├─ 多层图结构
│  │  ├─ 参数：m, ef_construction, ef_search
│  │  └─ 适用：查询频繁、高召回率
│  │
│  └─ IVFFlat 索引
│     ├─ 聚类 + 倒排索引
│     ├─ 参数：lists, probes
│     └─ 适用：插入频繁、内存受限
│
└─ RAG 应用
   ├─ 文档入库（Embedding）
   ├─ 向量检索（Top-K）
   ├─ 上下文注入
   └─ LLM 生成回答
```

---

## 关键概念速查

### 数据类型

```sql
vector(1536)   -- OpenAI text-embedding-3-small
vector(3072)   -- OpenAI text-embedding-3-large
vector(384)    -- Sentence-Transformers
halfvec(1536)  -- 半精度，减少存储50%
```

### 距离函数

```sql
embedding <=> query_embedding  -- 余弦距离（推荐用于文本）
embedding <-> query_embedding  -- 欧氏距离（用于图像）
embedding <#> query_embedding  -- 内积距离（用于推荐）
```

### 索引创建

```sql
-- HNSW 索引（推荐）
CREATE INDEX ON documents USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- IVFFlat 索引
CREATE INDEX ON documents USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

### 查询参数

```sql
-- HNSW 查询参数
SET hnsw.ef_search = 100;

-- IVFFlat 查询参数
SET ivfflat.probes = 10;
```

---

## 性能参考

### 数据规模建议

| 向量数量 | 推荐方案 | 查询延迟 | 召回率 |
|---------|---------|---------|--------|
| < 10,000 | 无索引 | < 100ms | 100% |
| 10,000 - 100,000 | IVFFlat | < 50ms | 85-95% |
| 100,000 - 1,000,000 | HNSW | < 30ms | 95-99% |
| > 1,000,000 | 专用向量库 | < 10ms | 95-99% |

### 索引参数推荐

**HNSW：**
- 默认：`m=16, ef_construction=64, ef_search=40`
- 平衡：`m=16, ef_construction=64, ef_search=100`（推荐）
- 高召回率：`m=32, ef_construction=128, ef_search=200`

**IVFFlat：**
- lists：`sqrt(N)`（N 为向量总数）
- probes：`lists / 10`

---

## 常见问题快速索引

### 基础问题

- **Q: pgvector 和专用向量库的区别？** → [面试必问.md](./08_面试必问.md)
- **Q: 如何选择向量维度？** → [核心概念_1_向量存储.md](./03_核心概念_1_向量存储.md)
- **Q: 余弦距离和欧氏距离的区别？** → [反直觉点.md](./06_反直觉点.md)

### 性能问题

- **Q: 如何优化查询性能？** → [面试必问.md](./08_面试必问.md)
- **Q: HNSW 和 IVFFlat 如何选择？** → [核心概念_3_索引策略.md](./03_核心概念_3_索引策略.md)
- **Q: 索引参数如何调优？** → [实战代码_4_索引优化.md](./07_实战代码_4_索引优化.md)

### 应用问题

- **Q: 如何构建 RAG 系统？** → [实战代码_3_RAG集成.md](./07_实战代码_3_RAG集成.md)
- **Q: 如何处理长文档？** → [实战代码_3_RAG集成.md](./07_实战代码_3_RAG集成.md)
- **Q: 如何提高召回率？** → [实战代码_4_索引优化.md](./07_实战代码_4_索引优化.md)

---

## 实战项目建议

### 项目1：基础向量检索系统（入门）

**目标：** 实现基础的向量存储和检索

**步骤：**
1. 安装 PostgreSQL + pgvector
2. 创建向量表
3. 插入测试数据（100条）
4. 实现 Top-K 检索
5. 测试三种距离函数

**参考文档：**
- [实战代码_1_基础CRUD.md](./07_实战代码_1_基础CRUD.md)
- [实战代码_2_相似度检索.md](./07_实战代码_2_相似度检索.md)

### 项目2：RAG 文档问答系统（进阶）

**目标：** 构建完整的 RAG 系统

**步骤：**
1. 文档入库（Embedding 生成）
2. 向量检索（Top-K）
3. LLM 生成回答
4. FastAPI 封装
5. 创建 HNSW 索引优化性能

**参考文档：**
- [实战代码_3_RAG集成.md](./07_实战代码_3_RAG集成.md)
- [核心概念_3_索引策略.md](./03_核心概念_3_索引策略.md)

### 项目3：性能优化实战（高级）

**目标：** 优化向量检索性能

**步骤：**
1. 准备大规模测试数据（10万+）
2. 对比无索引 vs HNSW vs IVFFlat
3. 调优索引参数
4. 评估召回率
5. 实现混合检索（向量 + 全文）

**参考文档：**
- [实战代码_4_索引优化.md](./07_实战代码_4_索引优化.md)
- [面试必问.md](./08_面试必问.md)

---

## 学习检查清单

完成本知识点后，确认你能够：

### 基础能力
- [ ] 在 PostgreSQL 中启用 pgvector 扩展
- [ ] 创建包含 vector 列的表
- [ ] 插入和查询向量数据
- [ ] 使用余弦距离进行 Top-K 检索

### 核心能力
- [ ] 理解三种距离函数的区别和适用场景
- [ ] 创建 HNSW 索引并调整参数
- [ ] 创建 IVFFlat 索引并调整参数
- [ ] 使用 EXPLAIN ANALYZE 验证索引效果

### 高级能力
- [ ] 构建完整的 RAG 文档问答系统
- [ ] 评估和优化向量检索性能
- [ ] 处理大规模向量数据（10万+）
- [ ] 实现混合检索（向量 + 全文）

### 生产能力
- [ ] 选择合适的索引类型和参数
- [ ] 监控索引使用情况和查询性能
- [ ] 处理向量维度不匹配等常见问题
- [ ] 在 FastAPI 中集成 pgvector

---

## 扩展学习资源

### 官方文档
- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)

### 相关知识点
- **前置**：SQLAlchemy ORM、Session 管理
- **后续**：RAG 检索链、LangChain 集成
- **相关**：Embedding 模型、向量数据库对比

### 进阶主题
- 混合检索（向量 + 全文 + 关键词）
- 多模态检索（文本 + 图像）
- 分布式向量检索
- 向量量化和压缩
- ReRank 重排序

---

## 版本信息

**文档版本：** v1.0
**最后更新：** 2026-02-11
**适用 pgvector 版本：** 0.5.0+
**适用 PostgreSQL 版本：** 14+

---

## 开始学习

根据你的学习目标选择合适的路径：

- **快速入门** → 从 [最小可用.md](./04_最小可用.md) 开始
- **系统学习** → 从 [第一性原理.md](./02_第一性原理.md) 开始
- **实战导向** → 从 [实战代码_1_基础CRUD.md](./07_实战代码_1_基础CRUD.md) 开始
- **面试准备** → 从 [面试必问.md](./08_面试必问.md) 开始
- **快速复习** → 从 [化骨绵掌.md](./09_化骨绵掌.md) 开始

**记住：** pgvector 是 RAG 系统的数据层基础，掌握向量存储、相似度检索、索引优化三大核心，就能构建高性能的向量检索系统。

祝学习顺利！🚀
