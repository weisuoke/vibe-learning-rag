# 化骨绵掌

10 个 2 分钟知识卡片，全面掌握事件系统与钩子。

---

## 卡片 1：直觉理解 - 事件系统是什么？

**一句话：** 事件系统是一种"订阅通知"机制，让你在 Agent 运行的关键时刻自动执行自定义逻辑。

**类比：**
- 就像订阅 YouTube 频道，当有新视频时你会收到通知
- pi-mono 核心代码是 YouTube，你的 Extension 是订阅者
- 当事件发生（新视频发布），所有订阅者都会收到通知

**核心价值：**
- 不修改核心代码就能扩展功能
- 多个 Extension 可以独立监听同一事件
- 发布者和订阅者完全解耦

**应用：** 监听 `session_start` 事件，在会话开始时初始化你的 Extension。

---

## 卡片 2：形式化定义 - 双层事件总线

**一句话：** pi-mono 采用双层事件总线架构：`pi.on()` 用于生命周期事件，`pi.events` 用于自定义事件。

**精确定义：**

```typescript
// 层 1：生命周期事件总线
interface ExtensionAPI {
  on(event: 'session_start', handler: (session: Session) => void): void;
  on(event: 'tool_call', handler: (tool: Tool, args: any) => void): void;
  // ... 40+ 预定义事件
}

// 层 2：自定义事件总线
interface EventBus {
  emit(event: string, ...args: any[]): void;
  on(event: string, handler: (...args: any[]) => void): void;
}
```

**设计理念：**
- **pi.on()**：观察核心流程，单向通信（核心 → 扩展）
- **pi.events**：扩展间协作，双向通信（扩展 ↔ 扩展）

**应用：** 使用 `pi.on()` 监听 Agent 运行，使用 `pi.events` 实现扩展间通信。

---

## 卡片 3：关键概念 1 - 生命周期钩子

**一句话：** 生命周期钩子是在 Agent 运行的特定时刻自动触发的 40+ 个预定义事件。

**7 大类钩子：**

| 类别 | 典型事件 | 用途 |
|------|---------|------|
| Session Events | session_start, session_shutdown | 会话管理 |
| Agent Events | before_agent_start, agent_end | Agent 控制 |
| Message Events | message_start, message_end | 消息处理 |
| Tool Events | tool_call, tool_result | 工具监控 |
| Model Events | model_select | 模型切换 |
| User Events | user_bash, input | 用户交互 |
| Resource Events | resources_discover | 资源发现 |

**最重要的 3 个钩子：**
1. `before_agent_start` - 可以修改消息数组
2. `tool_call` - 监控所有工具调用
3. `session_shutdown` - 清理资源

**应用：** 在 `before_agent_start` 注入项目上下文，定制 Agent 行为。

---

## 卡片 4：关键概念 2 - Spawn Hooks

**一句话：** Spawn Hooks 是专门用于拦截和修改 bash 命令执行的特殊钩子。

**核心特点：**
- **只拦截 bash**：不影响 read、write、edit 等其他工具
- **可以修改**：command、cwd、env 三个参数
- **必须返回**：`{ command, cwd, env }` 对象

**典型用法：**

```typescript
pi.registerSpawnHook((command, cwd, env) => {
  // 注入环境变量
  env.NODE_ENV = 'development';
  env.PROJECT_ROOT = cwd;

  // 必须返回所有参数
  return { command, cwd, env };
});
```

**与 tool_call 的区别：**
- `tool_call` 只能观察，不能修改
- Spawn Hooks 可以拦截和修改

**应用：** 注入开发环境变量，实现命令安全过滤。

---

## 卡片 5：编程实现 - 基础事件监听

**一句话：** 使用 `pi.on()` 注册事件监听器，在事件触发时自动执行。

**完整示例：**

```typescript
export default function myExtension(pi: ExtensionAPI) {
  // 监听 session 启动
  pi.on('session_start', (session) => {
    console.log('Session started:', session.id);
  });

  // 监听工具调用
  pi.on('tool_call', (tool, args) => {
    console.log('Tool called:', tool.name);
  });

  // 监听 session 关闭
  pi.on('session_shutdown', (session) => {
    console.log('Session shutdown:', session.id);
  });
}
```

**关键点：**
- 监听器按注册顺序执行
- 支持异步处理器（async/await）
- 错误会被自动捕获，不会中断 Agent

**应用：** 构建监控扩展，记录 Agent 运行状态。

---

## 卡片 6：对比区分 - 三种事件机制

**一句话：** pi-mono 有三种事件机制：生命周期钩子、自定义事件、Spawn Hooks，各有不同用途。

**对比表：**

| 特性 | 生命周期钩子 | 自定义事件 | Spawn Hooks |
|------|------------|-----------|-------------|
| 注册方式 | pi.on() | pi.events.on() | registerSpawnHook() |
| 事件来源 | 核心代码 | 用户扩展 | bash 工具 |
| 事件名称 | 预定义 | 自定义 | 无（直接拦截） |
| 修改能力 | 部分可修改 | 不可修改 | 可修改 command/cwd/env |
| 返回值 | 无需返回 | 无需返回 | 必须返回对象 |

**选择指南：**
- 监控 Agent 运行 → 生命周期钩子
- 扩展间通信 → 自定义事件
- 修改 bash 命令 → Spawn Hooks

**应用：** 根据需求选择合适的事件机制。

---

## 卡片 7：进阶理解 - 事件驱动架构

**一句话：** 事件系统是事件驱动架构（EDA）的实现，通过发布-订阅模式实现松耦合。

**核心原理：**

```
发布者（Publisher）
  ↓ emit
事件总线（Event Bus）
  ↓ dispatch
订阅者（Subscriber）
```

**三大优势：**

1. **解耦**：发布者和订阅者不直接依赖
   ```typescript
   // 发布者不知道有哪些订阅者
   pi.events.emit('data-ready', { data });

   // 订阅者可以独立开发
   pi.events.on('data-ready', ({ data }) => { /* ... */ });
   ```

2. **可扩展**：可以动态添加订阅者
   ```typescript
   // 添加新的订阅者不影响现有代码
   pi.events.on('data-ready', newHandler);
   ```

3. **可观测**：可以监控系统状态
   ```typescript
   // 监控所有工具调用
   pi.on('tool_call', (tool, args) => {
     metrics.track('tool_call', { tool: tool.name });
   });
   ```

**应用：** 构建模块化的 Extension 架构。

---

## 卡片 8：高级应用 - 扩展间通信模式

**一句话：** 使用 `pi.events` 实现扩展间的四种通信模式。

**模式 1：发布-订阅**
```typescript
// 一对多通信
pi.events.emit('data-ready', { data });
pi.events.on('data-ready', handler1);
pi.events.on('data-ready', handler2);
```

**模式 2：请求-响应**
```typescript
// 一对一通信
const requestId = generateId();
pi.events.emit('data-request', { requestId, query });
pi.events.once('data-response', ({ requestId: respId, data }) => {
  if (respId === requestId) { /* 处理响应 */ }
});
```

**模式 3：事件链**
```typescript
// 链式处理
data:loaded → data:validated → data:transformed → data:saved
```

**模式 4：广播通知**
```typescript
// 广播给所有监听者
pi.events.emit('agent-completed', { timestamp });
```

**应用：** 构建数据处理管道，实现扩展协作。

---

## 卡片 9：在 AI Agent 开发中的使用

**一句话：** 事件系统是 AI Agent 定制化开发的核心，支持监控、定制、协作三大场景。

**场景 1：监控和日志**
```typescript
pi.on('tool_call', (tool, args) => {
  logger.info('Tool called', {
    tool: tool.name,
    args: JSON.stringify(args),
    timestamp: Date.now()
  });
});
```

**场景 2：定制 Agent 行为**
```typescript
pi.on('before_agent_start', (messages) => {
  messages.push({
    role: 'system',
    content: loadProjectContext()
  });
});
```

**场景 3：扩展协作**
```typescript
// Extension A：数据提供者
pi.events.emit('data-ready', { data });

// Extension B：数据消费者
pi.events.on('data-ready', ({ data }) => {
  processData(data);
});
```

**实际价值：**
- 不修改核心代码就能定制 Agent
- 模块化开发，易于维护
- 团队协作，统一规范

**应用：** 构建企业级 AI Agent 应用。

---

## 卡片 10：总结与延伸

**一句话：** 事件系统是 pi-mono 可扩展性的核心，掌握它就能构建强大的 AI Agent 应用。

**核心要点总结：**

1. **双层架构**：pi.on() + pi.events
2. **40+ 钩子**：覆盖 Agent 完整生命周期
3. **Spawn Hooks**：专门拦截 bash 命令
4. **松耦合**：发布-订阅模式
5. **类型安全**：TypeScript 接口定义

**学习路径：**
```
基础监听 → 生命周期钩子 → 自定义事件 → Spawn Hooks → 实战项目
```

**进阶方向：**
- 性能优化：事件批处理、异步处理
- 错误处理：错误隔离、重试机制
- 分布式：跨进程事件传播
- 可观测性：事件追踪、性能监控

**延伸阅读：**
- Node.js EventEmitter 文档
- 事件驱动架构（EDA）模式
- 微服务间通信模式
- React Hooks 设计理念

**最后的建议：**
- 从简单的事件监听开始
- 逐步尝试更复杂的钩子
- 实践中学习，构建实际项目
- 阅读 pi-mono 源码，理解实现细节

**应用：** 持续学习，构建更强大的 AI Agent 应用。

---

## 快速复习卡片

### 30 秒速记

1. **事件系统** = 订阅通知机制
2. **双层总线** = pi.on() + pi.events
3. **40+ 钩子** = 生命周期节点
4. **Spawn Hooks** = bash 命令拦截
5. **发布-订阅** = 松耦合通信
6. **before_agent_start** = 注入上下文
7. **tool_call** = 监控工具
8. **pi.events** = 扩展通信
9. **类型安全** = TypeScript 接口
10. **实战应用** = 监控 + 定制 + 协作

### 1 分钟速记

**核心概念：**
- 事件系统是 pi-mono 的可扩展性基础
- 双层事件总线：生命周期 + 自定义
- 40+ 生命周期钩子覆盖完整流程
- Spawn Hooks 专门拦截 bash 命令

**关键用法：**
- `pi.on('session_start', handler)` - 监听生命周期
- `pi.on('before_agent_start', handler)` - 注入上下文
- `pi.events.emit('my-event', data)` - 发送自定义事件
- `pi.registerSpawnHook(hook)` - 拦截命令

**实战价值：**
- 监控 Agent 运行状态
- 定制 Agent 行为
- 实现扩展间协作
- 构建模块化架构

---

**版本：** v1.0
**最后更新：** 2026-02-21
**维护者：** Claude Code
