# 实战代码：基础路由

> 完整可运行的路由示例，从简单到复杂

---

## 场景1：基础 CRUD API

**目标：** 实现一个简单的商品管理 API

```python
"""
基础 CRUD API 示例
演示：GET/POST/PUT/DELETE 路由的基本用法
"""

from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime

app = FastAPI(title="商品管理 API", version="1.0.0")

# ===== 数据模型 =====

class ItemBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=100, description="商品名称")
    description: Optional[str] = Field(None, max_length=500, description="商品描述")
    price: float = Field(..., gt=0, description="商品价格")
    in_stock: bool = Field(True, description="是否有货")

class ItemCreate(ItemBase):
    pass

class ItemUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=100)
    description: Optional[str] = None
    price: Optional[float] = Field(None, gt=0)
    in_stock: Optional[bool] = None

class ItemResponse(ItemBase):
    id: int
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True

# ===== 模拟数据库 =====

items_db = {}
next_id = 1

# ===== 路由定义 =====

@app.get("/", tags=["根路径"])
async def root():
    """API 根路径"""
    return {
        "message": "商品管理 API",
        "version": "1.0.0",
        "endpoints": {
            "items": "/items",
            "docs": "/docs"
        }
    }

# CREATE - 创建商品
@app.post(
    "/items",
    response_model=ItemResponse,
    status_code=status.HTTP_201_CREATED,
    tags=["商品管理"],
    summary="创建商品",
    description="创建一个新的商品"
)
async def create_item(item: ItemCreate):
    """
    创建新商品：
    - **name**: 商品名称（必需）
    - **description**: 商品描述（可选）
    - **price**: 商品价格（必需，大于0）
    - **in_stock**: 是否有货（默认 True）
    """
    global next_id

    # 创建商品对象
    new_item = {
        "id": next_id,
        "name": item.name,
        "description": item.description,
        "price": item.price,
        "in_stock": item.in_stock,
        "created_at": datetime.now(),
        "updated_at": datetime.now()
    }

    items_db[next_id] = new_item
    next_id += 1

    return new_item

# READ - 获取商品列表
@app.get(
    "/items",
    response_model=List[ItemResponse],
    tags=["商品管理"],
    summary="获取商品列表"
)
async def list_items(
    skip: int = 0,
    limit: int = 10,
    in_stock: Optional[bool] = None
):
    """
    获取商品列表：
    - **skip**: 跳过的数量（分页）
    - **limit**: 返回的数量（分页）
    - **in_stock**: 过滤是否有货（可选）
    """
    # 过滤
    items = list(items_db.values())
    if in_stock is not None:
        items = [item for item in items if item["in_stock"] == in_stock]

    # 分页
    return items[skip : skip + limit]

# READ - 获取单个商品
@app.get(
    "/items/{item_id}",
    response_model=ItemResponse,
    tags=["商品管理"],
    summary="获取商品详情"
)
async def get_item(item_id: int):
    """
    获取单个商品的详细信息
    """
    if item_id not in items_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"商品 {item_id} 不存在"
        )

    return items_db[item_id]

# UPDATE - 更新商品
@app.put(
    "/items/{item_id}",
    response_model=ItemResponse,
    tags=["商品管理"],
    summary="更新商品"
)
async def update_item(item_id: int, item: ItemUpdate):
    """
    更新商品信息（部分更新）
    """
    if item_id not in items_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"商品 {item_id} 不存在"
        )

    # 获取现有商品
    existing_item = items_db[item_id]

    # 更新字段（只更新提供的字段）
    update_data = item.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        existing_item[field] = value

    # 更新时间戳
    existing_item["updated_at"] = datetime.now()

    return existing_item

# DELETE - 删除商品
@app.delete(
    "/items/{item_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    tags=["商品管理"],
    summary="删除商品"
)
async def delete_item(item_id: int):
    """
    删除商品
    """
    if item_id not in items_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"商品 {item_id} 不存在"
        )

    del items_db[item_id]
    return None

# ===== 运行服务器 =====

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**运行和测试：**

```bash
# 1. 安装依赖
uv add fastapi uvicorn

# 2. 运行服务器
python 09_实战代码_基础路由.py

# 3. 测试 API

# 创建商品
curl -X POST http://localhost:8000/items \
  -H "Content-Type: application/json" \
  -d '{"name": "Laptop", "price": 999.99, "description": "High-end laptop"}'

# 获取商品列表
curl http://localhost:8000/items

# 获取单个商品
curl http://localhost:8000/items/1

# 更新商品
curl -X PUT http://localhost:8000/items/1 \
  -H "Content-Type: application/json" \
  -d '{"price": 899.99}'

# 删除商品
curl -X DELETE http://localhost:8000/items/1

# 4. 访问 API 文档
# 打开浏览器：http://localhost:8000/docs
```

---

## 场景2：路径参数和查询参数

**目标：** 演示路径参数和查询参数的各种用法

```python
"""
路径参数和查询参数示例
演示：参数类型、验证、默认值
"""

from fastapi import FastAPI, Path, Query, HTTPException
from typing import Optional, List
from enum import Enum

app = FastAPI()

# ===== 枚举类型 =====

class SortOrder(str, Enum):
    asc = "asc"
    desc = "desc"

class UserRole(str, Enum):
    admin = "admin"
    user = "user"
    guest = "guest"

# ===== 路径参数示例 =====

@app.get("/users/{user_id}")
async def get_user(
    user_id: int = Path(..., ge=1, le=10000, description="用户ID")
):
    """路径参数：整数验证"""
    return {"user_id": user_id}

@app.get("/users/{username}/profile")
async def get_user_profile(
    username: str = Path(
        ...,
        min_length=3,
        max_length=50,
        regex="^[a-zA-Z0-9_]+$",
        description="用户名"
    )
):
    """路径参数：字符串验证"""
    return {"username": username}

@app.get("/users/role/{role}")
async def get_users_by_role(role: UserRole):
    """路径参数：枚举类型"""
    return {"role": role.value, "users": []}

@app.get("/files/{file_path:path}")
async def get_file(file_path: str):
    """路径参数：包含斜杠的路径"""
    # /files/docs/readme.md → file_path = "docs/readme.md"
    return {"file_path": file_path}

# ===== 查询参数示例 =====

@app.get("/search")
async def search(
    q: str = Query(..., min_length=3, max_length=50, description="搜索关键词"),
    page: int = Query(1, ge=1, description="页码"),
    page_size: int = Query(10, ge=1, le=100, description="每页数量"),
    sort: SortOrder = Query(SortOrder.desc, description="排序方式")
):
    """查询参数：基础用法"""
    return {
        "query": q,
        "page": page,
        "page_size": page_size,
        "sort": sort.value
    }

@app.get("/items")
async def list_items(
    tags: List[str] = Query(None, description="标签列表"),
    min_price: Optional[float] = Query(None, ge=0, description="最低价格"),
    max_price: Optional[float] = Query(None, ge=0, description="最高价格")
):
    """查询参数：列表和可选参数"""
    filters = {}
    if tags:
        filters["tags"] = tags
    if min_price is not None:
        filters["min_price"] = min_price
    if max_price is not None:
        filters["max_price"] = max_price

    return {"filters": filters}

# ===== 混合使用 =====

@app.get("/users/{user_id}/posts")
async def get_user_posts(
    user_id: int = Path(..., ge=1),
    status: str = Query("published", regex="^(draft|published|archived)$"),
    limit: int = Query(10, ge=1, le=100)
):
    """混合使用路径参数和查询参数"""
    return {
        "user_id": user_id,
        "status": status,
        "limit": limit,
        "posts": []
    }

# ===== 运行服务器 =====

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**测试：**

```bash
# 路径参数
curl http://localhost:8000/users/123
curl http://localhost:8000/users/alice/profile
curl http://localhost:8000/users/role/admin
curl http://localhost:8000/files/docs/readme.md

# 查询参数
curl "http://localhost:8000/search?q=laptop&page=1&page_size=20&sort=asc"
curl "http://localhost:8000/items?tags=python&tags=fastapi&min_price=10&max_price=100"

# 混合使用
curl "http://localhost:8000/users/123/posts?status=published&limit=5"
```

---

## 场景3：请求体和表单

**目标：** 演示请求体、表单数据、文件上传

```python
"""
请求体和表单示例
演示：JSON 请求体、表单数据、文件上传
"""

from fastapi import FastAPI, File, UploadFile, Form, Body
from pydantic import BaseModel, Field, EmailStr
from typing import List, Optional
from datetime import datetime

app = FastAPI()

# ===== 数据模型 =====

class Address(BaseModel):
    street: str
    city: str
    country: str
    postal_code: str

class User(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    full_name: Optional[str] = None
    age: int = Field(..., ge=0, le=150)
    address: Optional[Address] = None

class UserResponse(BaseModel):
    id: int
    username: str
    email: str
    created_at: datetime

# ===== JSON 请求体 =====

@app.post("/users", response_model=UserResponse)
async def create_user(user: User):
    """JSON 请求体：Pydantic 模型"""
    return UserResponse(
        id=1,
        username=user.username,
        email=user.email,
        created_at=datetime.now()
    )

@app.post("/users/bulk")
async def create_users(users: List[User]):
    """JSON 请求体：列表"""
    return {"count": len(users), "users": users}

@app.post("/items")
async def create_item(
    name: str = Body(...),
    price: float = Body(...),
    description: Optional[str] = Body(None)
):
    """JSON 请求体：单个字段"""
    return {"name": name, "price": price, "description": description}

# ===== 表单数据 =====

@app.post("/login")
async def login(
    username: str = Form(...),
    password: str = Form(...)
):
    """表单数据：登录"""
    # 验证用户名和密码
    if username == "admin" and password == "secret":
        return {"message": "Login successful", "token": "fake-token"}
    else:
        return {"message": "Invalid credentials"}

@app.post("/register")
async def register(
    username: str = Form(..., min_length=3),
    email: str = Form(...),
    password: str = Form(..., min_length=8),
    age: int = Form(..., ge=18)
):
    """表单数据：注册"""
    return {
        "message": "User registered",
        "username": username,
        "email": email
    }

# ===== 文件上传 =====

@app.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    """单文件上传"""
    contents = await file.read()
    return {
        "filename": file.filename,
        "content_type": file.content_type,
        "size": len(contents)
    }

@app.post("/upload-multiple")
async def upload_multiple_files(files: List[UploadFile] = File(...)):
    """多文件上传"""
    results = []
    for file in files:
        contents = await file.read()
        results.append({
            "filename": file.filename,
            "size": len(contents)
        })
    return {"files": results}

@app.post("/upload-with-form")
async def upload_with_form(
    file: UploadFile = File(...),
    title: str = Form(...),
    description: Optional[str] = Form(None)
):
    """文件上传 + 表单数据"""
    contents = await file.read()
    return {
        "title": title,
        "description": description,
        "filename": file.filename,
        "size": len(contents)
    }

# ===== 运行服务器 =====

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**测试：**

```bash
# JSON 请求体
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "alice",
    "email": "alice@example.com",
    "age": 25,
    "address": {
      "street": "123 Main St",
      "city": "New York",
      "country": "USA",
      "postal_code": "10001"
    }
  }'

# 表单数据
curl -X POST http://localhost:8000/login \
  -F "username=admin" \
  -F "password=secret"

# 文件上传
curl -X POST http://localhost:8000/upload \
  -F "file=@test.txt"

# 文件上传 + 表单
curl -X POST http://localhost:8000/upload-with-form \
  -F "file=@test.txt" \
  -F "title=Test Document" \
  -F "description=This is a test"
```

---

## 场景4：路由组织和 APIRouter

**目标：** 使用 APIRouter 组织大型应用的路由

```python
"""
路由组织示例
演示：使用 APIRouter 模块化路由
"""

from fastapi import FastAPI, APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import List

# ===== 数据模型 =====

class User(BaseModel):
    id: int
    username: str
    email: str

class Post(BaseModel):
    id: int
    title: str
    content: str
    author_id: int

# ===== 用户路由 =====

users_router = APIRouter(
    prefix="/users",
    tags=["用户管理"],
    responses={404: {"description": "用户不存在"}}
)

@users_router.get("/", response_model=List[User])
async def list_users():
    """获取用户列表"""
    return [
        User(id=1, username="alice", email="alice@example.com"),
        User(id=2, username="bob", email="bob@example.com")
    ]

@users_router.get("/{user_id}", response_model=User)
async def get_user(user_id: int):
    """获取用户详情"""
    if user_id == 1:
        return User(id=1, username="alice", email="alice@example.com")
    raise HTTPException(status_code=404, detail="用户不存在")

@users_router.post("/", response_model=User, status_code=201)
async def create_user(user: User):
    """创建用户"""
    return user

# ===== 文章路由 =====

posts_router = APIRouter(
    prefix="/posts",
    tags=["文章管理"],
    responses={404: {"description": "文章不存在"}}
)

@posts_router.get("/", response_model=List[Post])
async def list_posts():
    """获取文章列表"""
    return [
        Post(id=1, title="First Post", content="Content", author_id=1)
    ]

@posts_router.get("/{post_id}", response_model=Post)
async def get_post(post_id: int):
    """获取文章详情"""
    if post_id == 1:
        return Post(id=1, title="First Post", content="Content", author_id=1)
    raise HTTPException(status_code=404, detail="文章不存在")

# ===== 管理员路由 =====

admin_router = APIRouter(
    prefix="/admin",
    tags=["管理员"],
    # dependencies=[Depends(verify_admin)]  # 所有路由都需要管理员权限
)

@admin_router.get("/stats")
async def get_stats():
    """获取统计信息"""
    return {
        "users_count": 100,
        "posts_count": 500,
        "active_users": 50
    }

@admin_router.delete("/users/{user_id}")
async def delete_user(user_id: int):
    """删除用户"""
    return {"message": f"User {user_id} deleted"}

# ===== 主应用 =====

app = FastAPI(
    title="博客 API",
    description="一个简单的博客 API 示例",
    version="1.0.0"
)

# 包含路由器
app.include_router(users_router)
app.include_router(posts_router)
app.include_router(admin_router)

@app.get("/")
async def root():
    """API 根路径"""
    return {
        "message": "博客 API",
        "docs": "/docs",
        "endpoints": {
            "users": "/users",
            "posts": "/posts",
            "admin": "/admin"
        }
    }

# ===== 运行服务器 =====

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**项目结构建议：**

```
my_api/
├── app/
│   ├── __init__.py
│   ├── main.py              # 主应用
│   ├── api/
│   │   ├── __init__.py
│   │   ├── users.py         # 用户路由
│   │   ├── posts.py         # 文章路由
│   │   └── admin.py         # 管理员路由
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py          # 用户模型
│   │   └── post.py          # 文章模型
│   └── core/
│       ├── __init__.py
│       └── config.py        # 配置
└── requirements.txt
```

---

## 总结

### 学到的技能

1. **CRUD API** - 完整的增删改查接口
2. **参数验证** - 路径参数、查询参数的验证
3. **请求体** - JSON、表单、文件上传
4. **路由组织** - 使用 APIRouter 模块化

### 下一步

- 学习依赖注入（数据库连接、认证）
- 学习响应模型（数据过滤、验证）
- 学习中间件和异常处理

---

**记住：** 这些示例都是完整可运行的，可以直接复制运行！
