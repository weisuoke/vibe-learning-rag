# å®æˆ˜ä»£ç  04ï¼šæˆæœ¬ä¼˜åŒ–å®æˆ˜

> **æ™ºèƒ½æ¨¡å‹é€‰æ‹©ä¸æˆæœ¬è·Ÿè¸ªç³»ç»Ÿ**

---

## ä»»åŠ¡åˆ†ç±»å™¨

### åŸºäºå…³é”®è¯

```typescript
// task-classifier.ts
interface TaskComplexity {
  level: 'simple' | 'medium' | 'complex';
  confidence: number;
  reason: string;
}

function classifyTask(prompt: string): TaskComplexity {
  const lowerPrompt = prompt.toLowerCase();

  // ç®€å•ä»»åŠ¡å…³é”®è¯
  const simpleKeywords = [
    'format', 'fix typo', 'add comment', 'rename',
    'delete', 'remove', 'update version', 'change color'
  ];

  // å¤æ‚ä»»åŠ¡å…³é”®è¯
  const complexKeywords = [
    'architecture', 'design system', 'optimize algorithm',
    'refactor entire', 'migrate', 'implement from scratch',
    'security audit', 'performance optimization'
  ];

  // æ£€æŸ¥ç®€å•ä»»åŠ¡
  const simpleMatches = simpleKeywords.filter(k => lowerPrompt.includes(k));
  if (simpleMatches.length > 0) {
    return {
      level: 'simple',
      confidence: 0.9,
      reason: `Matched keywords: ${simpleMatches.join(', ')}`
    };
  }

  // æ£€æŸ¥å¤æ‚ä»»åŠ¡
  const complexMatches = complexKeywords.filter(k => lowerPrompt.includes(k));
  if (complexMatches.length > 0) {
    return {
      level: 'complex',
      confidence: 0.9,
      reason: `Matched keywords: ${complexMatches.join(', ')}`
    };
  }

  // é»˜è®¤ä¸­ç­‰
  return {
    level: 'medium',
    confidence: 0.5,
    reason: 'No specific keywords matched'
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const task1 = classifyTask('Format this JSON file');
console.log(task1);
// { level: 'simple', confidence: 0.9, reason: 'Matched keywords: format' }

const task2 = classifyTask('Design a scalable microservices architecture');
console.log(task2);
// { level: 'complex', confidence: 0.9, reason: 'Matched keywords: architecture' }
```

### åŸºäºä»£ç è¡Œæ•°

```typescript
// complexity-by-size.ts
function classifyBySize(codeLines: number): TaskComplexity {
  if (codeLines < 50) {
    return {
      level: 'simple',
      confidence: 0.8,
      reason: `Small codebase (${codeLines} lines)`
    };
  } else if (codeLines < 500) {
    return {
      level: 'medium',
      confidence: 0.8,
      reason: `Medium codebase (${codeLines} lines)`
    };
  } else {
    return {
      level: 'complex',
      confidence: 0.8,
      reason: `Large codebase (${codeLines} lines)`
    };
  }
}
```

---

## æ™ºèƒ½æ¨¡å‹é€‰æ‹©å™¨

### å®Œæ•´å®ç°

```typescript
// model-selector.ts
interface ModelConfig {
  id: string;
  cost: { input: number; output: number };
  performance: number;
}

const models: Record<string, ModelConfig> = {
  haiku: {
    id: 'claude-3-5-haiku-20241022',
    cost: { input: 0.8, output: 4.0 },
    performance: 7
  },
  sonnet: {
    id: 'claude-3-5-sonnet-20241022',
    cost: { input: 3.0, output: 15.0 },
    performance: 9
  },
  opus: {
    id: 'claude-opus-4-20250514',
    cost: { input: 15.0, output: 75.0 },
    performance: 10
  }
};

class ModelSelector {
  selectModel(prompt: string): string {
    const complexity = classifyTask(prompt);

    switch (complexity.level) {
      case 'simple':
        return models.haiku.id;
      case 'medium':
        return models.sonnet.id;
      case 'complex':
        return models.opus.id;
    }
  }

  selectWithBudget(prompt: string, monthlyBudget: number, currentSpend: number): string {
    const complexity = classifyTask(prompt);
    const remainingBudget = monthlyBudget - currentSpend;

    // é¢„ç®—ä¸è¶³ï¼Œé™çº§
    if (remainingBudget < 10) {
      console.warn('âš ï¸ Low budget, using Haiku');
      return models.haiku.id;
    }

    // æ­£å¸¸é€‰æ‹©
    return this.selectModel(prompt);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const selector = new ModelSelector();

const model1 = selector.selectModel('Format this code');
console.log(model1); // claude-3-5-haiku-20241022

const model2 = selector.selectModel('Design the architecture');
console.log(model2); // claude-opus-4-20250514
```

---

## æˆæœ¬è·Ÿè¸ªç³»ç»Ÿ

### å®Œæ•´å®ç°

```typescript
// cost-tracker.ts
import { writeFileSync, readFileSync, existsSync } from 'fs';
import { join } from 'path';

interface UsageLog {
  timestamp: Date;
  model: string;
  inputTokens: number;
  outputTokens: number;
  cost: number;
  task: string;
}

class CostTracker {
  private logFile: string;
  private logs: UsageLog[] = [];

  constructor(logFile: string = '.pi-cost-log.json') {
    this.logFile = logFile;
    this.loadLogs();
  }

  private loadLogs() {
    if (existsSync(this.logFile)) {
      const data = readFileSync(this.logFile, 'utf-8');
      this.logs = JSON.parse(data);
    }
  }

  private saveLogs() {
    writeFileSync(this.logFile, JSON.stringify(this.logs, null, 2));
  }

  log(
    model: string,
    inputTokens: number,
    outputTokens: number,
    task: string
  ) {
    const modelConfig = this.getModelConfig(model);
    const cost = this.calculateCost(inputTokens, outputTokens, modelConfig);

    this.logs.push({
      timestamp: new Date(),
      model,
      inputTokens,
      outputTokens,
      cost,
      task
    });

    this.saveLogs();
  }

  private getModelConfig(model: string) {
    const configs: Record<string, { input: number; output: number }> = {
      'claude-3-5-haiku-20241022': { input: 0.8, output: 4.0 },
      'claude-3-5-sonnet-20241022': { input: 3.0, output: 15.0 },
      'claude-opus-4-20250514': { input: 15.0, output: 75.0 }
    };
    return configs[model] || { input: 0, output: 0 };
  }

  private calculateCost(
    inputTokens: number,
    outputTokens: number,
    config: { input: number; output: number }
  ): number {
    const inputCost = (inputTokens / 1_000_000) * config.input;
    const outputCost = (outputTokens / 1_000_000) * config.output;
    return inputCost + outputCost;
  }

  getDailyCost(): number {
    const today = new Date().toDateString();
    return this.logs
      .filter(log => new Date(log.timestamp).toDateString() === today)
      .reduce((sum, log) => sum + log.cost, 0);
  }

  getMonthlyCost(): number {
    const thisMonth = new Date().getMonth();
    const thisYear = new Date().getFullYear();
    return this.logs
      .filter(log => {
        const date = new Date(log.timestamp);
        return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
      })
      .reduce((sum, log) => sum + log.cost, 0);
  }

  getModelBreakdown(): Record<string, { cost: number; count: number }> {
    const breakdown: Record<string, { cost: number; count: number }> = {};

    for (const log of this.logs) {
      if (!breakdown[log.model]) {
        breakdown[log.model] = { cost: 0, count: 0 };
      }
      breakdown[log.model].cost += log.cost;
      breakdown[log.model].count += 1;
    }

    return breakdown;
  }

  generateReport(): string {
    const dailyCost = this.getDailyCost();
    const monthlyCost = this.getMonthlyCost();
    const breakdown = this.getModelBreakdown();

    let report = '# Cost Report\n\n';
    report += `## Summary\n`;
    report += `- Daily Cost: $${dailyCost.toFixed(2)}\n`;
    report += `- Monthly Cost: $${monthlyCost.toFixed(2)}\n\n`;

    report += `## Model Breakdown\n`;
    for (const [model, stats] of Object.entries(breakdown)) {
      const shortName = model.split('-')[0];
      report += `- ${shortName}: $${stats.cost.toFixed(2)} (${stats.count} calls)\n`;
    }

    return report;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const tracker = new CostTracker();

// è®°å½•ä½¿ç”¨
tracker.log('claude-3-5-haiku-20241022', 5000, 1000, 'Format code');
tracker.log('claude-3-5-sonnet-20241022', 10000, 2000, 'Refactor component');

// ç”ŸæˆæŠ¥å‘Š
console.log(tracker.generateReport());
```

---

## é¢„ç®—ç®¡ç†å™¨

```typescript
// budget-manager.ts
class BudgetManager {
  private monthlyBudget: number;
  private tracker: CostTracker;

  constructor(monthlyBudget: number, tracker: CostTracker) {
    this.monthlyBudget = monthlyBudget;
    this.tracker = tracker;
  }

  getRemainingBudget(): number {
    const spent = this.tracker.getMonthlyCost();
    return this.monthlyBudget - spent;
  }

  getBudgetUsagePercent(): number {
    const spent = this.tracker.getMonthlyCost();
    return (spent / this.monthlyBudget) * 100;
  }

  shouldDowngrade(): boolean {
    return this.getBudgetUsagePercent() > 80;
  }

  getRecommendedModel(baseModel: string): string {
    if (this.shouldDowngrade()) {
      // é™çº§ç­–ç•¥
      const downgrades: Record<string, string> = {
        'claude-opus-4-20250514': 'claude-3-5-sonnet-20241022',
        'claude-3-5-sonnet-20241022': 'claude-3-5-haiku-20241022',
        'claude-3-5-haiku-20241022': 'claude-3-5-haiku-20241022'
      };
      return downgrades[baseModel] || baseModel;
    }
    return baseModel;
  }

  generateAlert(): string | null {
    const usage = this.getBudgetUsagePercent();

    if (usage > 90) {
      return `ğŸš¨ CRITICAL: ${usage.toFixed(0)}% budget used`;
    } else if (usage > 80) {
      return `âš ï¸ WARNING: ${usage.toFixed(0)}% budget used`;
    } else if (usage > 70) {
      return `â„¹ï¸ INFO: ${usage.toFixed(0)}% budget used`;
    }

    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const tracker = new CostTracker();
const budget = new BudgetManager(100, tracker);

console.log(`Remaining: $${budget.getRemainingBudget().toFixed(2)}`);
console.log(`Usage: ${budget.getBudgetUsagePercent().toFixed(0)}%`);

const alert = budget.generateAlert();
if (alert) {
  console.log(alert);
}
```

---

## CLI å·¥å…·

### æˆæœ¬æŸ¥è¯¢å·¥å…·

```bash
#!/bin/bash
# pi-cost

COMMAND=$1

case $COMMAND in
  today)
    node -e "
      const tracker = require('./cost-tracker').CostTracker;
      const t = new tracker();
      console.log('Today: \$' + t.getDailyCost().toFixed(2));
    "
    ;;

  month)
    node -e "
      const tracker = require('./cost-tracker').CostTracker;
      const t = new tracker();
      console.log('This month: \$' + t.getMonthlyCost().toFixed(2));
    "
    ;;

  report)
    node -e "
      const tracker = require('./cost-tracker').CostTracker;
      const t = new tracker();
      console.log(t.generateReport());
    "
    ;;

  *)
    echo "Usage: pi-cost [today|month|report]"
    ;;
esac
```

---

## å®Œæ•´ç¤ºä¾‹

### é›†æˆç³»ç»Ÿ

```typescript
// cost-optimizer.ts
import { spawn } from 'child_process';

class CostOptimizer {
  private selector: ModelSelector;
  private tracker: CostTracker;
  private budget: BudgetManager;

  constructor(monthlyBudget: number) {
    this.selector = new ModelSelector();
    this.tracker = new CostTracker();
    this.budget = new BudgetManager(monthlyBudget, this.tracker);
  }

  async execute(prompt: string): Promise<string> {
    // 1. é€‰æ‹©æ¨¡å‹
    let model = this.selector.selectModel(prompt);

    // 2. æ£€æŸ¥é¢„ç®—
    model = this.budget.getRecommendedModel(model);

    // 3. æ˜¾ç¤ºè­¦å‘Š
    const alert = this.budget.generateAlert();
    if (alert) {
      console.log(alert);
    }

    // 4. æ‰§è¡Œä»»åŠ¡
    console.log(`Using model: ${model}`);
    const result = await this.callPi(model, prompt);

    // 5. è®°å½•æˆæœ¬
    this.tracker.log(model, 5000, 1000, prompt);

    return result;
  }

  private async callPi(model: string, prompt: string): Promise<string> {
    return new Promise((resolve, reject) => {
      const pi = spawn('pi', ['--model', model], {
        stdio: ['pipe', 'pipe', 'pipe']
      });

      let output = '';

      pi.stdout.on('data', (data) => {
        output += data.toString();
      });

      pi.stdin.write(prompt + '\n');
      pi.stdin.end();

      pi.on('close', (code) => {
        if (code === 0) {
          resolve(output);
        } else {
          reject(new Error(`Pi exited with code ${code}`));
        }
      });
    });
  }

  getReport(): string {
    return this.tracker.generateReport();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function main() {
  const optimizer = new CostOptimizer(100); // $100/æœˆé¢„ç®—

  // æ‰§è¡Œä»»åŠ¡
  await optimizer.execute('Format this JSON');
  await optimizer.execute('Refactor this component');
  await optimizer.execute('Design the architecture');

  // ç”ŸæˆæŠ¥å‘Š
  console.log(optimizer.getReport());
}

main();
```

---

## ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor-cost.sh

while true; do
  clear
  echo "=== Pi Cost Monitor ==="
  echo ""

  # ä»Šæ—¥æˆæœ¬
  TODAY=$(node -e "
    const { CostTracker } = require('./cost-tracker');
    const t = new CostTracker();
    console.log(t.getDailyCost().toFixed(2));
  ")
  echo "Today: \$$TODAY"

  # æœ¬æœˆæˆæœ¬
  MONTH=$(node -e "
    const { CostTracker } = require('./cost-tracker');
    const t = new CostTracker();
    console.log(t.getMonthlyCost().toFixed(2));
  ")
  echo "This month: \$$MONTH"

  # é¢„ç®—ä½¿ç”¨ç‡
  USAGE=$(node -e "
    const { CostTracker } = require('./cost-tracker');
    const { BudgetManager } = require('./budget-manager');
    const t = new CostTracker();
    const b = new BudgetManager(100, t);
    console.log(b.getBudgetUsagePercent().toFixed(0));
  ")
  echo "Budget usage: $USAGE%"

  echo ""
  echo "Press Ctrl+C to exit"

  sleep 5
done
```

---

**è®°ä½**ï¼šæˆæœ¬ä¼˜åŒ–ä¸æ˜¯é™ä½è´¨é‡ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªä»»åŠ¡é€‰æ‹©åˆé€‚çš„å·¥å…·ã€‚
