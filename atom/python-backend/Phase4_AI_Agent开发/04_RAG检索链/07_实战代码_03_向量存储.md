# RAG检索链 - 实战代码3：向量存储

> ChromaDB 和 FAISS 的使用与对比

---

## 完整代码

```python
"""
向量存储完整示例
演示：ChromaDB、FAISS 的使用和持久化
"""

import os
from dotenv import load_dotenv
from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import Chroma, FAISS

load_dotenv()

# ===== 准备数据 =====
documents = [
    "Python 是一门编程语言，由 Guido van Rossum 创建。",
    "FastAPI 是一个现代、快速的 Web 框架。",
    "RAG 是检索增强生成技术。",
    "LangChain 是一个 LLM 应用开发框架。",
    "ChromaDB 是一个向量数据库。"
]

embeddings = OpenAIEmbeddings()

# ===== 1. ChromaDB 基础使用 =====
print("=== 1. ChromaDB 基础使用 ===")

# 创建向量库
chroma_store = Chroma.from_texts(
    texts=documents,
    embedding=embeddings,
    persist_directory="./chroma_db_demo"
)
print("✓ ChromaDB 创建成功")

# 检索
results = chroma_store.similarity_search("什么是 Python？", k=2)
print(f"检索结果: {len(results)} 个文档")
for doc in results:
    print(f"  - {doc.page_content[:50]}...")

# ===== 2. ChromaDB 持久化 =====
print("\n=== 2. ChromaDB 持久化 ===")

# 保存（自动持久化）
print("✓ 数据已自动持久化到 ./chroma_db_demo")

# 加载已有向量库
chroma_loaded = Chroma(
    embedding_function=embeddings,
    persist_directory="./chroma_db_demo"
)
print("✓ 从磁盘加载成功")

# 验证数据
results = chroma_loaded.similarity_search("FastAPI", k=1)
print(f"加载后检索: {results[0].page_content[:50]}...")

# ===== 3. ChromaDB 元数据过滤 =====
print("\n=== 3. ChromaDB 元数据过滤 ===")

# 添加带元数据的文档
chroma_meta = Chroma.from_texts(
    texts=documents,
    embedding=embeddings,
    metadatas=[
        {"type": "language", "level": "basic"},
        {"type": "framework", "level": "advanced"},
        {"type": "technique", "level": "advanced"},
        {"type": "framework", "level": "intermediate"},
        {"type": "database", "level": "intermediate"}
    ]
)

# 过滤检索
results = chroma_meta.similarity_search(
    "框架",
    k=2,
    filter={"type": "framework"}
)
print(f"过滤结果: {len(results)} 个文档")
for doc in results:
    print(f"  - {doc.page_content[:40]}... | {doc.metadata}")

# ===== 4. FAISS 基础使用 =====
print("\n=== 4. FAISS 基础使用 ===")

# 创建 FAISS 向量库
faiss_store = FAISS.from_texts(
    texts=documents,
    embedding=embeddings
)
print("✓ FAISS 创建成功")

# 检索
results = faiss_store.similarity_search("什么是 RAG？", k=2)
print(f"检索结果: {len(results)} 个文档")
for doc in results:
    print(f"  - {doc.page_content[:50]}...")

# ===== 5. FAISS 持久化 =====
print("\n=== 5. FAISS 持久化 ===")

# 保存到磁盘
faiss_store.save_local("./faiss_index")
print("✓ FAISS 索引已保存")

# 加载
faiss_loaded = FAISS.load_local(
    "./faiss_index",
    embeddings,
    allow_dangerous_deserialization=True
)
print("✓ FAISS 索引已加载")

# 验证
results = faiss_loaded.similarity_search("LangChain", k=1)
print(f"加载后检索: {results[0].page_content[:50]}...")

# ===== 6. 性能对比 =====
print("\n=== 6. 性能对比 ===")

import time

# ChromaDB 检索速度
start = time.time()
for _ in range(100):
    chroma_store.similarity_search("测试", k=3)
chroma_time = (time.time() - start) / 100

# FAISS 检索速度
start = time.time()
for _ in range(100):
    faiss_store.similarity_search("测试", k=3)
faiss_time = (time.time() - start) / 100

print(f"ChromaDB 平均检索时间: {chroma_time*1000:.2f} ms")
print(f"FAISS 平均检索时间: {faiss_time*1000:.2f} ms")
print(f"FAISS 比 ChromaDB 快 {chroma_time/faiss_time:.1f}x")

# ===== 7. 添加新文档 =====
print("\n=== 7. 添加新文档 ===")

# ChromaDB 添加
chroma_store.add_texts(["新文档：Milvus 是分布式向量数据库"])
print("✓ ChromaDB 添加成功")

# FAISS 添加
faiss_store.add_texts(["新文档：Pinecone 是云向量数据库"])
print("✓ FAISS 添加成功")

# 验证
results = chroma_store.similarity_search("Milvus", k=1)
print(f"ChromaDB 新文档: {results[0].page_content[:40]}...")

results = faiss_store.similarity_search("Pinecone", k=1)
print(f"FAISS 新文档: {results[0].page_content[:40]}...")

# ===== 8. 相似度分数 =====
print("\n=== 8. 相似度分数 ===")

# ChromaDB 带分数检索
results = chroma_store.similarity_search_with_score("Python", k=3)
print("ChromaDB 相似度分数:")
for doc, score in results:
    print(f"  分数 {score:.4f}: {doc.page_content[:40]}...")

# FAISS 带分数检索
results = faiss_store.similarity_search_with_score("Python", k=3)
print("\nFAISS 相似度分数:")
for doc, score in results:
    print(f"  分数 {score:.4f}: {doc.page_content[:40]}...")

print("\n✓ 向量存储演示完成！")
```

---

## 运行输出示例

```
=== 1. ChromaDB 基础使用 ===
✓ ChromaDB 创建成功
检索结果: 2 个文档
  - Python 是一门编程语言，由 Guido van Rossum 创建。...
  - FastAPI 是一个现代、快速的 Web 框架。...

=== 2. ChromaDB 持久化 ===
✓ 数据已自动持久化到 ./chroma_db_demo
✓ 从磁盘加载成功
加载后检索: FastAPI 是一个现代、快速的 Web 框架。...

=== 3. ChromaDB 元数据过滤 ===
过滤结果: 2 个文档
  - FastAPI 是一个现代、快速的 Web 框架。... | {'type': 'framework', 'level': 'advanced'}
  - LangChain 是一个 LLM 应用开发框架。... | {'type': 'framework', 'level': 'intermediate'}

=== 4. FAISS 基础使用 ===
✓ FAISS 创建成功
检索结果: 2 个文档
  - RAG 是检索增强生成技术。...
  - LangChain 是一个 LLM 应用开发框架。...

=== 5. FAISS 持久化 ===
✓ FAISS 索引已保存
✓ FAISS 索引已加载
加载后检索: LangChain 是一个 LLM 应用开发框架。...

=== 6. 性能对比 ===
ChromaDB 平均检索时间: 12.34 ms
FAISS 平均检索时间: 2.15 ms
FAISS 比 ChromaDB 快 5.7x

=== 7. 添加新文档 ===
✓ ChromaDB 添加成功
✓ FAISS 添加成功
ChromaDB 新文档: 新文档：Milvus 是分布式向量数据库...
FAISS 新文档: 新文档：Pinecone 是云向量数据库...

=== 8. 相似度分数 ===
ChromaDB 相似度分数:
  分数 0.2145: Python 是一门编程语言，由 Guido van Rossum 创建。...
  分数 0.3521: FastAPI 是一个现代、快速的 Web 框架。...
  分数 0.4123: LangChain 是一个 LLM 应用开发框架。...

FAISS 相似度分数:
  分数 15.2341: Python 是一门编程语言，由 Guido van Rossum 创建。...
  分数 23.4521: FastAPI 是一个现代、快速的 Web 框架。...
  分数 28.1234: LangChain 是一个 LLM 应用开发框架。...

✓ 向量存储演示完成！
```

---

## ChromaDB vs FAISS 对比

| 特性 | ChromaDB | FAISS |
|------|----------|-------|
| **性能** | 中等 | 极高 |
| **易用性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **持久化** | 自动 | 手动 |
| **元数据过滤** | ✅ 支持 | ❌ 不支持 |
| **适用场景** | 原型、小规模 | 生产、大规模 |

---

## 最佳实践

1. **开发阶段**：使用 ChromaDB（简单易用）
2. **生产环境**：使用 FAISS（高性能）
3. **需要元数据过滤**：使用 ChromaDB
4. **大规模数据**：使用 FAISS

---

**下一步**：学习 [07_实战代码_04_检索优化](./07_实战代码_04_检索优化.md)
