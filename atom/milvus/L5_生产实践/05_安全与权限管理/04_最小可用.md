# 最小可用

掌握以下内容，就能开始使用 Milvus 安全与权限管理：

## 4.1 启用认证机制

**最基础的安全措施：要求用户名和密码**

```yaml
# milvus.yaml 配置文件
common:
  security:
    authorizationEnabled: true  # 启用认证
```

```python
from pymilvus import connections

# 使用认证连接
connections.connect(
    alias="default",
    host="localhost",
    port="19530",
    user="root",        # 默认管理员用户
    password="Milvus"   # 默认密码（生产环境必须修改！）
)
```

**为什么重要：**
- 防止未授权访问
- 生产环境的第一道防线
- 满足基本合规要求

---

## 4.2 创建用户和角色

**实现最小权限原则**

```python
from pymilvus import utility

# 1. 创建只读用户（适合数据分析师）
utility.create_user(
    user="analyst",
    password="SecurePass123!"
)

# 2. 创建角色
utility.create_role(role_name="readonly")

# 3. 授予查询权限
utility.grant_privilege(
    role_name="readonly",
    object_type="Collection",
    privilege="Search",
    object_name="*"  # 所有 Collection
)

# 4. 将用户绑定到角色
utility.add_user_to_role(
    username="analyst",
    role_name="readonly"
)
```

**在 RAG 中的应用：**
```python
# 场景：客服人员只能查询知识库，不能修改
# 1. 创建 customer_service 角色
# 2. 只授予 Search 权限
# 3. 禁止 Insert/Delete 权限
```

---

## 4.3 配置 TLS 加密传输

**保护数据在网络中的安全**

```yaml
# milvus.yaml
proxy:
  tls:
    enabled: true
    serverPemPath: /path/to/server.pem
    serverKeyPath: /path/to/server.key
    caPemPath: /path/to/ca.pem  # 可选
```

```python
# 客户端使用 TLS 连接
connections.connect(
    alias="default",
    host="milvus.example.com",
    port="19530",
    user="admin",
    password="SecurePass",
    secure=True,  # 启用 TLS
    server_pem_path="/path/to/server.pem",
    server_name="milvus.example.com"
)
```

**为什么重要：**
- 防止中间人攻击
- 保护敏感查询内容
- 金融/医疗行业合规要求

---

## 4.4 多租户数据隔离

**确保不同客户的数据互不可见**

```python
# 方案1：每个租户独立的 Collection
from pymilvus import Collection, FieldSchema, CollectionSchema, DataType

# 租户A的 Collection
collection_a = Collection("tenant_a_docs")

# 租户B的 Collection
collection_b = Collection("tenant_b_docs")

# 通过用户权限控制访问
# 用户A只能访问 tenant_a_docs
# 用户B只能访问 tenant_b_docs
```

```python
# 方案2：使用 Partition 隔离（同一 Collection）
collection = Collection("shared_docs")

# 创建租户分区
collection.create_partition("tenant_a")
collection.create_partition("tenant_b")

# 查询时指定分区
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    partition_names=["tenant_a"]  # 只搜索租户A的数据
)
```

**在 RAG 中的应用：**
```python
# SaaS 知识库服务
# - 客户A：电商公司，存储产品文档
# - 客户B：金融公司，存储合规文档
#
# 隔离策略：
# 1. 独立 Collection：tenant_a_kb, tenant_b_kb
# 2. 用户权限：user_a 只能访问 tenant_a_kb
# 3. API 层验证：检查 JWT token 中的 tenant_id
```

---

## 4.5 基本审计日志

**追踪谁做了什么操作**

```python
import logging
from datetime import datetime

# 简单的审计日志包装器
class AuditLogger:
    def __init__(self, user):
        self.user = user
        self.logger = logging.getLogger("milvus_audit")

    def log_search(self, collection_name, query):
        self.logger.info(
            f"[{datetime.now()}] User={self.user} "
            f"Action=SEARCH Collection={collection_name} "
            f"Query={query[:50]}..."
        )

    def log_insert(self, collection_name, count):
        self.logger.info(
            f"[{datetime.now()}] User={self.user} "
            f"Action=INSERT Collection={collection_name} "
            f"Count={count}"
        )

# 使用示例
audit = AuditLogger(user="analyst")
audit.log_search("docs", "如何配置 Milvus")
# 输出：[2025-02-10 10:30:00] User=analyst Action=SEARCH Collection=docs Query=如何配置 Milvus
```

**为什么重要：**
- 安全事件追溯
- 合规审计要求
- 发现异常行为

---

## 这些知识足以：

✅ **部署生产级安全的 Milvus 实例**
- 启用认证，防止未授权访问
- 配置 TLS，保护数据传输
- 创建用户和角色，实现权限控制

✅ **实现多租户 RAG 系统**
- 使用 Collection 或 Partition 隔离租户数据
- 基于用户身份控制访问权限
- 记录审计日志，追踪操作

✅ **满足基本合规要求**
- 身份认证和授权
- 数据传输加密
- 操作审计追踪

✅ **为后续学习打基础**
- 理解认证、授权、加密的基本概念
- 掌握 pymilvus 的安全 API
- 了解多租户隔离的实现方式

---

## 快速检查清单

在生产环境部署前，确保：

- [ ] 已启用认证（`authorizationEnabled: true`）
- [ ] 已修改默认密码（不使用 `root/Milvus`）
- [ ] 已配置 TLS 加密（`secure=True`）
- [ ] 已创建非管理员用户（遵循最小权限原则）
- [ ] 已实现多租户隔离（Collection 或 Partition）
- [ ] 已配置审计日志（记录敏感操作）
- [ ] 已定期审查用户和权限（删除不再需要的账户）

---

## 常见错误

### ❌ 错误1：生产环境使用默认密码

```python
# 危险！默认密码
connections.connect(
    user="root",
    password="Milvus"  # ❌ 容易被猜到
)
```

**正确做法：**
```python
# 使用强密码
connections.connect(
    user="admin",
    password=os.getenv("MILVUS_PASSWORD")  # ✅ 从环境变量读取
)
```

### ❌ 错误2：所有用户都是管理员

```python
# 危险！给所有用户管理员权限
utility.add_user_to_role(
    username="analyst",
    role_name="admin"  # ❌ 权限过大
)
```

**正确做法：**
```python
# 只给必需的权限
utility.add_user_to_role(
    username="analyst",
    role_name="readonly"  # ✅ 最小权限
)
```

### ❌ 错误3：不使用 TLS 加密

```python
# 危险！明文传输
connections.connect(
    host="milvus.example.com",
    secure=False  # ❌ 数据可被窃听
)
```

**正确做法：**
```python
# 使用 TLS 加密
connections.connect(
    host="milvus.example.com",
    secure=True,  # ✅ 加密传输
    server_pem_path="/path/to/cert.pem"
)
```

---

## 下一步学习

掌握最小可用知识后，可以深入学习：

1. **核心概念1：认证机制** - 深入理解认证原理和高级配置
2. **核心概念2：授权机制** - 掌握 RBAC 的完整实现
3. **核心概念3：数据加密** - 学习 TLS 配置和证书管理
4. **实战代码** - 实现企业级安全架构

---

**记住：** 安全不是可选项，是生产环境的必需品！
