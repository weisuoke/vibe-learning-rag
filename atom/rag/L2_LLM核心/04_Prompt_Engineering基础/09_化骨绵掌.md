# 化骨绵掌

## 什么是化骨绵掌？

**化骨绵掌**是10个快速参考卡片，每个2分钟，帮你在实战中快速回忆和应用 Prompt Engineering 的核心技巧。

---

## 卡片 1：角色设定速查（2分钟）

### 核心公式

```
System Prompt = 身份 + 风格 + 约束
```

### 快速模板

```python
ROLE = """
你是 [专业领域] 专家。

回答风格：
- [特点1]：如"简洁专业"
- [特点2]：如"JSON格式"

约束：
- [约束1]：如"只基于上下文"
- [约束2]：如"不确定时说明"
"""
```

### RAG 应用

| 场景 | 角色设定 |
|------|---------|
| 技术文档 | "你是技术文档分析师" |
| 客服 | "你是友好的客服助手" |
| 代码审查 | "你是严格的代码审查员" |

### 记忆口诀

**"身风约"** - 身份、风格、约束

---

## 卡片 2：指令清晰速查（2分钟）

### 核心公式

```
清晰指令 = 任务 + 步骤 + 标准 + 示例
```

### 快速模板

```python
INSTRUCTION = """
任务：[一句话描述]

步骤：
1. [步骤1]
2. [步骤2]

成功标准：
- [标准1]
- [标准2]

示例：
输入：[示例]
输出：[示例]
"""
```

### 检查清单

- [ ] 任务是否明确？
- [ ] 步骤是否具体？
- [ ] 标准是否可验证？
- [ ] 是否有示例？

### 记忆口诀

**"任步标例"** - 任务、步骤、标准、示例

---

## 卡片 3：格式控制速查（2分钟）

### 核心公式

```
格式控制 = JSON Mode + Schema 验证
```

### 快速代码

```python
# 启用 JSON Mode
response = client.chat.completions.create(
    model="gpt-4",
    response_format={"type": "json_object"},  # 关键
    messages=[
        {"role": "system", "content": "你总是返回 JSON"},
        {"role": "user", "content": "..."}
    ]
)

# 解析和验证
result = json.loads(response.choices[0].message.content)
validate(result, schema=SCHEMA)
```

### RAG 标准格式

```json
{
  "answer": "答案",
  "sources": ["来源"],
  "confidence": 0.0-1.0,
  "has_sufficient_context": true/false
}
```

### 记忆口诀

**"JSON验"** - JSON Mode + 验证

---

## 卡片 4：上下文工程速查（2分钟）⭐

### 核心公式

```
上下文优化 = ReRank + Token预算 + 动态选择
```

### 快速代码

```python
# 三步优化
# 1. ReRank 重排序
scores = reranker.predict([(query, doc) for doc in docs])
ranked = sorted(zip(docs, scores), key=lambda x: x[1], reverse=True)

# 2. Token 预算
selected = []
current_tokens = 0
for doc, score in ranked:
    tokens = len(doc) // 4
    if current_tokens + tokens <= max_tokens:
        selected.append((doc, score))
        current_tokens += tokens

# 3. 构建上下文
context = "\n\n".join([f"文档{i}: {doc}" for i, (doc, _) in enumerate(selected)])
```

### 黄金比例

```
Context Window (8192) 分配：
- System Prompt: 200 (2.4%)
- History: 1500 (18.3%)
- Retrieved: 6000 (73.2%)
- Query: 50 (0.6%)
- Output: 442 (5.4%)
```

### 记忆口诀

**"排预选"** - 重排序、预算、选择

---

## 卡片 5：输出质量控制速查（2分钟）⭐

### 核心公式

```
质量控制 = 约束 + 验证 + 置信度
```

### 快速模板

```python
QUALITY_PROMPT = """
任务：[任务描述]

约束：
- 必须基于上下文
- 不能编造信息
- 长度：50-200字

验证清单：
- [ ] 事实都能找到？
- [ ] 是否标注来源？
- [ ] 格式是否正确？

返回：
{{
  "answer": "...",
  "confidence": 0.0-1.0,
  "validation_passed": true/false
}}
"""
```

### 风险级别策略

| 风险 | 置信度阈值 | 验证层数 |
|------|-----------|---------|
| LOW | 0.6 | 1 |
| MEDIUM | 0.75 | 2 |
| HIGH | 0.9 | 3 |

### 记忆口诀

**"约验信"** - 约束、验证、置信度

---

## 卡片 6：RAG 完整流程速查（2分钟）

### 五步流程

```
1. 向量检索 → 召回候选文档
2. ReRank → 精排序
3. 上下文优化 → Token预算管理
4. 生成答案 → 应用五大技巧
5. 质量验证 → 多层验证
```

### 快速代码框架

```python
def rag_query(question: str) -> Dict:
    # 1. 检索
    docs = vector_db.search(question, top_k=20)

    # 2. ReRank
    ranked = reranker.rank(question, docs)

    # 3. 优化上下文
    context = optimizer.optimize(question, ranked[:3])

    # 4. 生成（应用五大技巧）
    response = client.chat.completions.create(
        model="gpt-4",
        response_format={"type": "json_object"},  # 技巧3
        messages=[
            {"role": "system", "content": ROLE},  # 技巧1
            {"role": "user", "content": f"""
{CLEAR_INSTRUCTION}  # 技巧2
上下文：{context}  # 技巧4
问题：{question}
            """}
        ]
    )

    result = json.loads(response.choices[0].message.content)

    # 5. 验证（技巧5）
    if not validate(result):
        return error_response()

    return result
```

### 记忆口诀

**"检排优生验"** - 检索、排序、优化、生成、验证

---

## 卡片 7：常见错误速查（2分钟）

### 三大误区

| 误区 | 正确做法 |
|------|---------|
| **Prompt 越长越好** | 清晰 > 冗长 |
| **Temperature 越高越好** | RAG 用 0.1-0.3 |
| **塞入所有检索结果** | Top-K + ReRank |

### 快速诊断

```python
# 检查你的 Prompt
def diagnose_prompt(prompt: str) -> Dict:
    issues = []

    if len(prompt) > 2000:
        issues.append("Prompt 过长")

    if "JSON" not in prompt and response_format != "json_object":
        issues.append("未启用 JSON Mode")

    if "步骤" not in prompt:
        issues.append("缺少明确步骤")

    if "约束" not in prompt:
        issues.append("缺少约束条件")

    return {"issues": issues, "score": 10 - len(issues)*2}
```

### 记忆口诀

**"长温塞"** - 不要长、不要高温、不要塞满

---

## 卡片 8：性能优化速查（2分钟）

### 优化策略

| 策略 | 效果 | 成本 |
|------|------|------|
| **使用 JSON Mode** | 可靠性 +100% | 无 |
| **ReRank 重排序** | 准确度 +40% | 中 |
| **Token 预算管理** | 效率 +50% | 低 |
| **多层验证** | 可靠性 +70% | 高 |

### 成本控制

```python
# 根据场景选择策略
if risk_level == "LOW":
    # 快速模式
    validation_layers = 1
    top_k = 3
    temperature = 0.3
elif risk_level == "MEDIUM":
    # 平衡模式
    validation_layers = 2
    top_k = 5
    temperature = 0.1
else:  # HIGH
    # 严格模式
    validation_layers = 3
    top_k = 3
    temperature = 0.0
```

### 记忆口诀

**"JSON排预验"** - JSON、排序、预算、验证

---

## 卡片 9：调试技巧速查（2分钟）

### 调试清单

```python
# 1. 检查输入
print(f"Query: {question}")
print(f"Context length: {len(context)}")
print(f"Docs retrieved: {len(docs)}")

# 2. 检查 Prompt
print(f"Prompt length: {len(prompt)}")
print(f"Has JSON Mode: {response_format == 'json_object'}")

# 3. 检查输出
print(f"Response: {response}")
print(f"Is valid JSON: {is_valid_json(response)}")
print(f"Has required fields: {has_required_fields(result)}")

# 4. 检查质量
print(f"Confidence: {result.get('confidence')}")
print(f"Validation passed: {result.get('validation_passed')}")
```

### 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 输出不是 JSON | 未启用 JSON Mode | 添加 response_format |
| 答案不准确 | 上下文质量差 | 使用 ReRank |
| 响应太慢 | 验证层数过多 | 根据风险调整 |
| 幻觉严重 | 缺少约束 | 添加质量控制 |

### 记忆口诀

**"入出质"** - 检查输入、输出、质量

---

## 卡片 10：生产环境速查（2分钟）

### 生产级检查清单

```python
# 部署前检查
PRODUCTION_CHECKLIST = {
    "角色设定": {
        "有 System Prompt": True,
        "定义了行为规范": True,
        "指定了输出格式": True
    },
    "指令清晰": {
        "任务明确": True,
        "步骤具体": True,
        "标准可验证": True
    },
    "格式控制": {
        "启用 JSON Mode": True,
        "有 Schema 验证": True
    },
    "上下文工程": {
        "使用 ReRank": True,
        "有 Token 预算": True,
        "动态选择文档": True
    },
    "质量控制": {
        "有约束条件": True,
        "有验证机制": True,
        "有置信度评估": True
    }
}
```

### 监控指标

```python
# 关键指标
METRICS = {
    "准确度": "> 90%",
    "平均置信度": "> 0.85",
    "响应时间": "< 3秒",
    "成功率": "> 95%",
    "幻觉率": "< 5%"
}
```

### 记忆口诀

**"角指格上质"** - 五大技巧全覆盖

---

## 快速参考总表

| 技巧 | 核心公式 | 口诀 | RAG 应用 |
|------|---------|------|---------|
| **角色设定** | 身份+风格+约束 | 身风约 | 一致的助手风格 |
| **指令清晰** | 任务+步骤+标准+示例 | 任步标例 | 精确控制流程 |
| **格式控制** | JSON Mode+验证 | JSON验 | 输出可解析 |
| **上下文工程** ⭐ | ReRank+预算+选择 | 排预选 | 优化检索质量 |
| **质量控制** ⭐ | 约束+验证+置信度 | 约验信 | 防止幻觉 |

---

## 使用建议

### 场景 1：快速开发

**只用前3个技巧：**
1. 角色设定（卡片1）
2. 指令清晰（卡片2）
3. 格式控制（卡片3）

**时间：** 10分钟
**效果：** 基础可用

### 场景 2：生产环境

**用全部5个技巧：**
1. 角色设定（卡片1）
2. 指令清晰（卡片2）
3. 格式控制（卡片3）
4. 上下文工程（卡片4）⭐
5. 质量控制（卡片5）⭐

**时间：** 30分钟
**效果：** 生产级质量

### 场景 3：问题排查

**使用调试卡片：**
- 卡片7：常见错误
- 卡片9：调试技巧

**时间：** 5分钟
**效果：** 快速定位问题

---

## 记忆技巧

### 总口诀

**"角指格上质，排预选约验"**

- **角**色设定：定义"我是谁"
- **指**令清晰：说明"做什么"
- **格**式控制：规定"怎么输出"
- **上**下文工程：优化"看什么"⭐
- **质**量控制：确保"不出错"⭐

### 数字记忆

- **5** 大技巧
- **3** 步上下文优化（排预选）
- **2** 个新重点（上下文工程、质量控制）
- **1** 个目标（可靠的 RAG 系统）

---

## 下一步

**已掌握：** ✅ 10个快速参考卡片

**实践建议：**
1. 打印这10张卡片
2. 放在工作台旁边
3. 开发时随时查阅
4. 每周复习一次

**深入学习：**
- 回顾 `03_核心概念_01-05.md` 深入理解
- 实践 `07_实战代码_01-06.md` 巩固技能
- 阅读 `00_概览.md` 了解完整体系

---

**版本：** v1.0 | **更新：** 2026-02-14 | **阅读时间：** 20分钟（10张卡片 × 2分钟）
