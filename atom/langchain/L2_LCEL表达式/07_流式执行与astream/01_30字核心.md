# 30字核心

## 核心定义

**流式执行（Streaming）是 LangChain 中让 AI 应用实时输出中间结果的机制，通过 `astream()` 方法以异步迭代器形式逐步返回数据，显著提升用户体验。**

---

## 一句话理解

把 AI 的"思考过程"实时展示出来，而不是等全部完成才返回结果。

---

## 核心价值

### 1. 用户体验提升
- **即时反馈**：用户无需等待完整响应，立即看到输出开始
- **感知速度**：即使总时间相同，流式输出让用户感觉更快
- **进度可见**：多步推理任务中，用户能看到每一步的进展

### 2. 应用场景适配
- **对话应用**：ChatGPT 式的逐字输出体验
- **长文本生成**：文章、报告等长内容的实时展示
- **多步 Agent**：工具调用、推理步骤的实时追踪
- **调试监控**：开发阶段实时查看执行流程

---

## 三种流式模式（2025-2026）

### 1. `stream_mode="updates"`
**Agent 进度流式** - 每个节点执行后返回状态更新

```python
for chunk in agent.stream(input, stream_mode="updates"):
    print(chunk)  # {'node_name': {'messages': [...]}}
```

### 2. `stream_mode="messages"`
**LLM 令牌流式** - 实时返回 LLM 生成的每个 token

```python
for token, metadata in agent.stream(input, stream_mode="messages"):
    print(token.text, end="")  # 逐字输出
```

### 3. `stream_mode="custom"`
**自定义数据流式** - 通过 `get_stream_writer()` 发送任意数据

```python
from langgraph.config import get_stream_writer

def my_tool(query: str) -> str:
    writer = get_stream_writer()
    writer("Processing step 1...")
    writer("Processing step 2...")
    return result
```

---

## 与传统调用的对比

| 特性 | `invoke()` | `stream()` / `astream()` |
|------|-----------|--------------------------|
| **返回方式** | 一次性返回完整结果 | 逐步返回中间结果 |
| **用户体验** | 需要等待全部完成 | 立即看到输出开始 |
| **适用场景** | 批处理、后台任务 | 实时对话、长文本生成 |
| **性能开销** | 无额外开销 | <10% 额外开销（2025 优化后） |
| **调试能力** | 只能看最终结果 | 可追踪每一步执行 |

---

## 最小示例

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

# 创建链
model = ChatOpenAI(model="gpt-4o-mini")
prompt = ChatPromptTemplate.from_template("讲一个关于{topic}的笑话")
chain = prompt | model

# 流式执行
async for chunk in chain.astream({"topic": "程序员"}):
    print(chunk.content, end="", flush=True)
```

**输出效果**：
```
为什么程序员总是分不清万圣节和圣诞节？

因为 Oct 31 == Dec 25
```

---

## 关键要点

1. **异步优先**：`astream()` 是推荐方式，`stream()` 是同步版本
2. **多模式组合**：可同时使用多种模式 `stream_mode=["updates", "messages"]`
3. **性能优化**：2025 年后流式开销降至 <10%，生产环境可放心使用
4. **Python 版本**：Python < 3.11 需要手动传递 `RunnableConfig`

---

## 2025-2026 新特性

- ✅ **Subgraph 流式**：`subgraphs=True` 支持嵌套 Agent 的流式输出
- ✅ **Human-in-the-loop 流式**：中断点也能流式处理
- ✅ **性能优化**：流式开销从 ~20% 降至 <10%
- ✅ **更好的元数据**：`metadata["lc_agent_name"]` 标识多 Agent 场景

---

## 参考资源

- **官方文档**：https://docs.langchain.com/oss/python/langchain/streaming/overview
- **源码位置**：`langchain_core/runnables/base.py:132` (astream 方法)
- **相关知识点**：
  - L2_06 链式调试与日志
  - L2_08 批处理与并发控制
  - L7_01 LangGraph 工作流基础

---

**版本**：LangChain 0.3.x (2025-2026)
**最后更新**：2026-02-21
