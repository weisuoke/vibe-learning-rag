# 核心概念4：安全最佳实践

## 概述

容器安全是生产环境部署的关键，涉及用户权限、密钥管理、镜像扫描等多个方面。

---

## 1. 非 root 用户运行

### 为什么需要非 root 用户？

**问题：** 默认情况下，容器内进程以 root 用户运行。

```bash
# 运行容器
docker run -d --name api my-app

# 查看进程用户
docker exec api whoami
# root

# 如果容器被攻破，攻击者拥有 root 权限
```

**风险：**
- ❌ 容器逃逸后，攻击者可能获得宿主机 root 权限
- ❌ 容器内的恶意代码可以修改系统文件
- ❌ 不符合最小权限原则

### 创建非 root 用户

```dockerfile
FROM python:3.13-slim

# 创建用户组和用户
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# 安装依赖（需要 root 权限）
COPY requirements.txt .
RUN pip install -r requirements.txt

# 复制应用代码并设置所有者
COPY --chown=appuser:appuser . .

# 切换到非 root 用户
USER appuser

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
```

### 验证用户

```bash
# 构建镜像
docker build -t my-app .

# 运行容器
docker run -d --name api my-app

# 验证用户
docker exec api whoami
# appuser

docker exec api id
# uid=999(appuser) gid=999(appuser) groups=999(appuser)
```

---

## 2. Secrets 管理

### 不要硬编码敏感信息

```dockerfile
# ❌ 错误：硬编码 API Key
ENV OPENAI_API_KEY=sk-1234567890
ENV DATABASE_PASSWORD=secret123

# ✅ 正确：运行时传递
# docker run -e OPENAI_API_KEY=${OPENAI_API_KEY} my-app
```

### 使用环境变量

```bash
# 方法1：命令行传递
docker run -e OPENAI_API_KEY=${OPENAI_API_KEY} my-app

# 方法2：.env 文件
docker run --env-file .env my-app

# 方法3：docker-compose
docker-compose up -d
```

### 使用 Docker Secrets（Swarm）

```bash
# 创建 Secret
echo "sk-1234567890" | docker secret create openai_api_key -

# 使用 Secret
docker service create \
  --name api \
  --secret openai_api_key \
  my-app
```

### 使用外部密钥管理

```python
# app/core/config.py
import os
from typing import Optional

class Settings:
    # 从环境变量读取
    OPENAI_API_KEY: Optional[str] = os.getenv("OPENAI_API_KEY")
    DATABASE_URL: Optional[str] = os.getenv("DATABASE_URL")

    # 从 AWS Secrets Manager 读取
    @classmethod
    def from_aws_secrets(cls):
        import boto3
        client = boto3.client('secretsmanager')
        secret = client.get_secret_value(SecretId='my-app-secrets')
        return cls(**json.loads(secret['SecretString']))
```

---

## 3. 最小权限原则

### 只读文件系统

```bash
# 运行容器时设置只读文件系统
docker run --read-only \
  --tmpfs /tmp \
  --tmpfs /app/logs \
  my-app
```

```dockerfile
# Dockerfile 中声明只读
FROM python:3.13-slim
# ...
VOLUME ["/tmp", "/app/logs"]
```

### 限制容器能力

```bash
# 删除所有能力
docker run --cap-drop=ALL my-app

# 只添加必要的能力
docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE my-app
```

### 禁用特权模式

```bash
# ❌ 错误：特权模式（容器拥有宿主机所有权限）
docker run --privileged my-app

# ✅ 正确：非特权模式
docker run my-app
```

---

## 4. 镜像扫描

### 使用 Trivy 扫描镜像

```bash
# 安装 Trivy
brew install trivy

# 扫描镜像
trivy image my-app:v1.0

# 输出示例
my-app:v1.0 (debian 12.4)
==========================
Total: 15 (UNKNOWN: 0, LOW: 5, MEDIUM: 8, HIGH: 2, CRITICAL: 0)

┌───────────────┬────────────────┬──────────┬───────────────────┐
│   Library     │ Vulnerability  │ Severity │ Installed Version │
├───────────────┼────────────────┼──────────┼───────────────────┤
│ openssl       │ CVE-2023-1234  │ HIGH     │ 3.0.11-1          │
│ libcurl       │ CVE-2023-5678  │ MEDIUM   │ 7.88.1-10         │
└───────────────┴────────────────┴──────────┴───────────────────┘
```

### 修复漏洞

```dockerfile
# 更新基础镜像
FROM python:3.13-slim

# 更新系统包
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
```

### CI/CD 集成

```yaml
# .github/workflows/security.yml
name: Security Scan

on: [push]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build image
        run: docker build -t my-app:${{ github.sha }} .

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: my-app:${{ github.sha }}
          exit-code: 1  # 发现高危漏洞时失败
          severity: 'CRITICAL,HIGH'
```

---

## 5. 依赖漏洞检测

### 使用 Safety 检查 Python 依赖

```bash
# 安装 Safety
pip install safety

# 检查依赖
safety check -r requirements.txt

# 输出示例
+==============================================================================+
|                                                                              |
|                               /$$$$$$            /$$                         |
|                              /$$__  $$          | $$                         |
|           /$$$$$$$  /$$$$$$ | $$  \__//$$$$$$  /$$$$$$   /$$   /$$           |
|          /$$_____/ |____  $$| $$$$   /$$__  $$|_  $$_/  | $$  | $$           |
|         |  $$$$$$   /$$$$$$$| $$_/  | $$$$$$$$  | $$    | $$  | $$           |
|          \____  $$ /$$__  $$| $$    | $$_____/  | $$ /$$| $$  | $$           |
|          /$$$$$$$/|  $$$$$$$| $$    |  $$$$$$$  |  $$$$/|  $$$$$$$           |
|         |_______/  \_______/|__/     \_______/   \___/   \____  $$           |
|                                                            /$$  | $$           |
|                                                           |  $$$$$$/           |
|  by pyup.io                                                \______/            |
|                                                                              |
+==============================================================================+

 REPORT

  Safety is using PyUp's free open-source vulnerability database.

  Scanning dependencies in your requirements file:

  -> requests==2.25.0 (CVE-2023-1234) - High severity
     Description: Requests allows attackers to...
     Fix: Upgrade to requests>=2.31.0
```

### 在 Dockerfile 中集成

```dockerfile
FROM python:3.13-slim AS builder

WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 检查依赖漏洞
RUN pip install safety && \
    safety check -r requirements.txt || exit 1

# 安装依赖
RUN pip install -r requirements.txt
```

---

## 6. 网络安全

### 限制网络访问

```bash
# 禁用网络
docker run --network none my-app

# 只允许特定网络
docker run --network my-network my-app
```

### 使用防火墙规则

```bash
# 限制容器只能访问特定 IP
docker run --add-host=api.openai.com:104.18.7.192 my-app
```

---

## 7. 完整示例：安全的 AI Agent API Dockerfile

```dockerfile
# ===== 构建阶段 =====
FROM python:3.13-slim AS builder

WORKDIR /app

# 更新系统包（修复已知漏洞）
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 安装构建工具
RUN pip install --no-cache-dir uv

# 复制依赖文件
COPY pyproject.toml uv.lock ./

# 安装依赖
RUN uv sync --frozen --no-dev

# ===== 运行阶段 =====
FROM python:3.13-slim

# 更新系统包
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 创建非 root 用户
RUN groupadd -r appuser && \
    useradd -r -g appuser appuser && \
    mkdir -p /app/logs && \
    chown -R appuser:appuser /app

WORKDIR /app

# 从构建阶段复制依赖
COPY --from=builder /app/.venv /app/.venv

# 复制应用代码并设置所有者
COPY --chown=appuser:appuser app/ app/

# 设置环境变量
ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 切换到非 root 用户
USER appuser

# 声明端口
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health')"

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 8. 安全检查清单

**构建时：**
- [ ] 使用官方基础镜像
- [ ] 更新系统包（apt-get upgrade）
- [ ] 扫描镜像漏洞（Trivy）
- [ ] 检查依赖漏洞（Safety）
- [ ] 不硬编码敏感信息

**运行时：**
- [ ] 使用非 root 用户
- [ ] 限制容器能力（--cap-drop）
- [ ] 使用只读文件系统（--read-only）
- [ ] 限制资源使用（--memory, --cpus）
- [ ] 使用自定义网络（隔离）

**密钥管理：**
- [ ] 环境变量传递敏感信息
- [ ] 不在镜像中存储密钥
- [ ] 使用 .env 文件（不提交到 Git）
- [ ] 考虑使用外部密钥管理（AWS Secrets Manager）

---

## 总结

**安全最佳实践：**
1. ✅ 使用非 root 用户运行容器
2. ✅ 不硬编码敏感信息
3. ✅ 扫描镜像和依赖漏洞
4. ✅ 更新系统包修复已知漏洞
5. ✅ 限制容器权限和能力
6. ✅ 使用只读文件系统
7. ✅ 定期更新基础镜像

---

**版本：** v1.0
**最后更新：** 2026-02-12
**适用于：** Python 3.13+ / FastAPI / AI Agent 后端开发
