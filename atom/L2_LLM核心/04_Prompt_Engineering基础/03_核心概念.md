# 核心概念

RAG Prompt 设计有三个核心概念，掌握它们就能设计出高质量的 RAG 系统。

---

## 核心概念1：系统提示词（System Prompt）

**系统提示词是给 LLM 的"工作说明书"，定义它的角色、能力边界和行为规则。**

### 系统提示词的四个要素

```python
system_prompt = """
# 1. 角色设定（你是谁）
你是一个专业的客服助手，专门回答关于产品使用的问题。

# 2. 能力边界（你能做什么、不能做什么）
你只能基于提供的文档内容回答问题。
你不能回答与产品无关的问题。
你不能编造文档中没有的信息。

# 3. 行为规则（怎么做）
- 回答要简洁明了，控制在3句话以内
- 如果不确定，要明确说明
- 使用友好但专业的语气

# 4. 输出格式（输出什么样子）
请按以下格式回答：
【答案】：直接回答用户问题
【来源】：引用文档中的相关内容
"""
```

### 为什么需要系统提示词？

| 没有系统提示词 | 有系统提示词 |
|--------------|-------------|
| LLM 不知道自己的角色 | 明确知道"我是客服助手" |
| 可能回答任何问题 | 只回答产品相关问题 |
| 可能编造信息 | 只基于文档内容回答 |
| 输出格式随意 | 按指定格式输出 |

### 在 RAG 中的应用

```python
# RAG 系统的典型系统提示词
RAG_SYSTEM_PROMPT = """
你是一个知识库问答助手。

## 你的任务
根据提供的参考文档，准确回答用户的问题。

## 重要规则
1. 只使用参考文档中的信息回答问题
2. 如果文档中没有相关信息，明确告知用户
3. 不要编造或推测文档中没有的内容
4. 如果信息来自多个文档，综合后回答

## 回答格式
- 先给出直接答案
- 再提供支持答案的文档依据
"""
```

---

## 核心概念2：上下文注入模板（Context Injection）

**上下文注入是将检索到的文档片段结构化地放入 Prompt 的技术。**

### 基本注入格式

```python
def create_context_prompt(documents: list[str], query: str) -> str:
    """创建带上下文的 Prompt"""

    # 格式化文档内容
    context = "\n\n".join([
        f"【文档 {i+1}】\n{doc}"
        for i, doc in enumerate(documents)
    ])

    prompt = f"""
## 参考文档

{context}

## 用户问题

{query}

请基于以上参考文档回答用户问题。
"""
    return prompt
```

### 带元数据的注入格式

```python
def create_context_with_metadata(chunks: list[dict], query: str) -> str:
    """创建带元数据的上下文 Prompt"""

    context_parts = []
    for i, chunk in enumerate(chunks):
        context_parts.append(f"""
【文档 {i+1}】
来源：{chunk['source']}
页码：{chunk.get('page', 'N/A')}
内容：
{chunk['content']}
""")

    context = "\n---\n".join(context_parts)

    prompt = f"""
## 参考文档

{context}

## 用户问题

{query}

请基于以上参考文档回答问题。回答时请注明信息来源。
"""
    return prompt
```

### 上下文注入的最佳实践

| 实践 | 说明 |
|------|------|
| **清晰分隔** | 用明显的分隔符区分不同文档 |
| **标注来源** | 包含文档名、页码等元数据 |
| **编号标识** | 给每个文档编号，方便引用 |
| **相关性排序** | 最相关的文档放在前面 |

### 在 RAG 中的应用

```python
# 完整的 RAG 上下文注入示例
def build_rag_prompt(
    system_prompt: str,
    retrieved_docs: list[dict],
    user_query: str
) -> list[dict]:
    """构建完整的 RAG Prompt"""

    # 格式化检索结果
    context = format_documents(retrieved_docs)

    # 构建消息列表
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": f"""
## 参考文档

{context}

## 我的问题

{user_query}
"""}
    ]

    return messages
```

---

## 核心概念3：用户问题模板（Query Template）

**用户问题模板是格式化用户原始问题的结构，让 LLM 更好地理解任务。**

### 为什么需要格式化用户问题？

用户的原始问题可能：
- 太简短，缺少上下文
- 太模糊，不够具体
- 没有明确期望的输出格式

```python
# 用户原始问题
raw_query = "退款怎么办"

# 格式化后的问题
formatted_query = """
## 用户问题
退款怎么办

## 问题类型
操作流程咨询

## 期望回答
请提供具体的退款操作步骤
"""
```

### 常用的问题模板

#### 模板1：简单问答

```python
SIMPLE_QA_TEMPLATE = """
问题：{query}

请基于提供的文档直接回答这个问题。
"""
```

#### 模板2：带约束的问答

```python
CONSTRAINED_QA_TEMPLATE = """
问题：{query}

回答要求：
- 控制在100字以内
- 使用简体中文
- 如果无法回答，说明原因
"""
```

#### 模板3：结构化输出

```python
STRUCTURED_QA_TEMPLATE = """
问题：{query}

请按以下格式回答：
1. 简短回答（1-2句话）
2. 详细解释（如需要）
3. 相关建议（如有）
"""
```

### 在 RAG 中的应用

```python
def format_user_query(
    query: str,
    output_format: str = "default"
) -> str:
    """格式化用户问题"""

    templates = {
        "default": "问题：{query}\n\n请基于参考文档回答。",
        "concise": "问题：{query}\n\n请用一句话回答。",
        "detailed": "问题：{query}\n\n请详细回答，并引用文档来源。",
        "step_by_step": "问题：{query}\n\n请分步骤回答。"
    }

    template = templates.get(output_format, templates["default"])
    return template.format(query=query)
```

---

## 三个概念的协作关系

```
┌─────────────────────────────────────────────────────────┐
│                    完整的 RAG Prompt                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │           系统提示词 (System Prompt)              │    │
│  │  - 角色：知识库问答助手                           │    │
│  │  - 约束：只基于文档回答                           │    │
│  │  - 规则：不编造、不推测                           │    │
│  └─────────────────────────────────────────────────┘    │
│                          ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │           上下文注入 (Context)                    │    │
│  │  【文档1】产品退款政策...                         │    │
│  │  【文档2】退款操作流程...                         │    │
│  │  【文档3】特殊情况处理...                         │    │
│  └─────────────────────────────────────────────────┘    │
│                          ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │           用户问题 (Query)                        │    │
│  │  问题：如何申请退款？                             │    │
│  │  期望：请提供具体步骤                             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
                        LLM
                          ↓
                      生成回答
```

---

## 完整代码示例

```python
"""
RAG Prompt 三个核心概念的完整示例
"""

# 1. 系统提示词
SYSTEM_PROMPT = """
你是一个专业的知识库问答助手。

## 核心规则
- 只基于提供的参考文档回答问题
- 不编造文档中没有的信息
- 如果无法回答，明确告知用户

## 回答风格
- 简洁准确
- 引用文档来源
- 友好专业
"""

# 2. 上下文注入函数
def inject_context(documents: list[dict]) -> str:
    """将检索结果注入为上下文"""
    parts = []
    for i, doc in enumerate(documents, 1):
        parts.append(f"""
【文档 {i}】
来源：{doc.get('source', '未知')}
内容：{doc['content']}
""")
    return "\n---\n".join(parts)

# 3. 用户问题模板
def format_query(query: str) -> str:
    """格式化用户问题"""
    return f"""
## 用户问题
{query}

请基于以上参考文档回答这个问题。如果文档中没有相关信息，请明确说明。
"""

# 组合使用
def build_rag_messages(
    documents: list[dict],
    query: str
) -> list[dict]:
    """构建完整的 RAG 消息"""

    context = inject_context(documents)
    formatted_query = format_query(query)

    return [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "user", "content": f"""
## 参考文档

{context}

{formatted_query}
"""}
    ]

# 使用示例
if __name__ == "__main__":
    docs = [
        {"source": "退款政策.pdf", "content": "用户可在购买后7天内申请退款..."},
        {"source": "操作指南.pdf", "content": "退款步骤：1. 登录账户 2. 进入订单页..."}
    ]

    messages = build_rag_messages(docs, "如何申请退款？")
    print(messages)
```

---

**下一步：** [04_最小可用](./04_最小可用.md) - 掌握20%核心知识解决80%问题
