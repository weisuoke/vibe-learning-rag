# 核心概念 04：安全与认证

> **深入理解 MCP 的安全模型、OAuth 2.1 认证和威胁防护**

---

## 安全概述

MCP 协议的安全机制建立在成熟的 OAuth 2.1 标准之上，为 HTTP 传输提供可选的授权能力。

**核心原则**：
- 授权是**可选的**（OPTIONAL）
- HTTP 传输**应该**遵循 OAuth 2.1 规范
- stdio 传输**不应该**使用 OAuth（从环境获取凭证）
- 所有实现**必须**遵循安全最佳实践

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## OAuth 2.1 基础

### 角色定义

```
MCP 授权角色：
├─ MCP Server → OAuth 2.1 资源服务器（Resource Server）
├─ MCP Client → OAuth 2.1 客户端（Client）
└─ Authorization Server → 授权服务器（发放访问令牌）
```

### 标准合规性

MCP 授权机制基于以下规范：
- OAuth 2.1 IETF DRAFT (draft-ietf-oauth-v2-1-13)
- OAuth 2.0 Authorization Server Metadata (RFC8414)
- OAuth 2.0 Dynamic Client Registration Protocol (RFC7591)
- OAuth 2.0 Protected Resource Metadata (RFC9728)
- OAuth Client ID Metadata Documents

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 授权服务器发现

### 发现机制

MCP 服务器**必须**实现 OAuth 2.0 Protected Resource Metadata (RFC9728) 来指示授权服务器位置。

**两种发现方式**：

1. **WWW-Authenticate 头**：
```http
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Bearer resource_metadata="https://mcp.example.com/.well-known/oauth-protected-resource",
                         scope="files:read"
```

2. **Well-Known URI**：
- 端点路径：`https://example.com/.well-known/oauth-protected-resource/public/mcp`
- 根路径：`https://example.com/.well-known/oauth-protected-resource`

客户端**必须**支持两种机制，优先使用 WWW-Authenticate 头中的 URL。

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 客户端注册

### 三种注册机制

**优先级顺序**：

1. **Client ID Metadata Documents**（最常见）
   - 适用场景：客户端和服务器无预先关系
   - 使用 HTTPS URL 作为客户端标识符
   - URL 指向包含客户端元数据的 JSON 文档

2. **预注册（Pre-registration）**
   - 适用场景：客户端和服务器有现有关系
   - 硬编码客户端 ID 或通过 UI 输入

3. **动态客户端注册（Dynamic Client Registration）**
   - 适用场景：向后兼容或特定需求
   - 使用 OAuth 2.0 Dynamic Client Registration Protocol (RFC7591)

### Client ID Metadata Documents 示例

```json
{
  "client_id": "https://app.example.com/oauth/client-metadata.json",
  "client_name": "Example MCP Client",
  "client_uri": "https://app.example.com",
  "redirect_uris": [
    "http://127.0.0.1:3000/callback",
    "http://localhost:3000/callback"
  ],
  "grant_types": ["authorization_code"],
  "response_types": ["code"],
  "token_endpoint_auth_method": "none"
}
```

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 授权流程

### 完整流程步骤

1. **客户端发现 MCP 服务器**，收到 401 Unauthorized 响应
2. **客户端获取 Protected Resource Metadata** 文档
3. **客户端发现授权服务器**
4. **客户端确定注册方法**并获取客户端标识符
5. **客户端启动 OAuth 2.1 授权码流程**（带 PKCE）
6. **授权服务器认证资源所有者**并获取用户同意
7. **授权服务器发放授权码**
8. **客户端交换授权码获取访问令牌**
9. **客户端使用访问令牌**访问 MCP 服务器
10. **MCP 服务器验证访问令牌**并响应请求

### Resource 参数

客户端**必须**实现 Resource Indicators for OAuth 2.0 (RFC 8707)：

```http
&resource=https%3A%2F%2Fmcp.example.com
```

**要求**：
- **必须**在授权请求和令牌请求中包含
- **必须**标识客户端打算使用令牌的 MCP 服务器
- **必须**使用 MCP 服务器的规范 URI

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 访问令牌使用

### 令牌要求

**客户端**：

```http
GET /mcp HTTP/1.1
Host: mcp.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

**要求**：
- **必须**使用 Authorization 请求头
- **必须**在每个 HTTP 请求中包含授权
- **不得**在 URI 查询字符串中包含访问令牌

**服务器**：
- **必须**验证访问令牌
- **必须**验证令牌是专门为其发放的（受众验证）
- **必须**对无效或过期令牌返回 HTTP 401

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 作用域管理

### 作用域选择策略

客户端**应该**遵循最小权限原则，仅请求必要的作用域。

**优先级顺序**：

1. 使用初始 401 响应的 WWW-Authenticate 头中的 `scope` 参数
2. 如果 scope 不可用，使用 Protected Resource Metadata 中的 `scopes_supported`

### 作用域挑战处理

**运行时权限不足错误**：

```http
HTTP/1.1 403 Forbidden
WWW-Authenticate: Bearer error="insufficient_scope",
                         scope="files:read files:write user:profile",
                         resource_metadata="https://mcp.example.com/.well-known/oauth-protected-resource",
                         error_description="Additional file write permission required"
```

**Step-Up 授权流程**：

1. 解析错误信息
2. 确定所需作用域
3. 启动（重新）授权
4. 使用新授权重试原始请求

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 安全威胁与防护

### 1. 令牌盗窃（Token Theft）

**威胁**：攻击者获取存储的令牌可以访问受保护资源

**防护措施**：
- 客户端和服务器**必须**实现安全令牌存储
- 授权服务器**应该**发放短期访问令牌
- 公共客户端**必须**轮换刷新令牌

### 2. 授权码保护

**威胁**：攻击者拦截授权码

**防护措施**：
- 客户端**必须**实现 PKCE (Proof Key for Code Exchange)
- 客户端**必须**使用 `S256` 代码挑战方法
- 客户端**必须**验证 PKCE 支持后再继续授权

**PKCE 验证**：

```json
// OAuth 2.0 Authorization Server Metadata
{
  "code_challenge_methods_supported": ["S256"]
}
```

如果 `code_challenge_methods_supported` 不存在，客户端**必须**拒绝继续。

### 3. 开放重定向（Open Redirection）

**威胁**：攻击者构造恶意重定向 URI 导向钓鱼网站

**防护措施**：
- 客户端**必须**向授权服务器注册重定向 URI
- 授权服务器**必须**验证精确的重定向 URI
- 客户端**应该**使用和验证 state 参数

### 4. 混淆代理问题（Confused Deputy）

**威胁**：攻击者利用 MCP 服务器作为中介访问第三方 API

**防护措施**：
- MCP 代理服务器**必须**为每个动态注册的客户端获取用户同意
- 实现适当的令牌受众绑定

### 5. 访问令牌权限限制

**威胁**：MCP 服务器接受为其他资源发放的令牌

**防护措施**：
- MCP 服务器**必须**验证访问令牌
- MCP 服务器**必须**确保令牌专门为其发放
- MCP 服务器**必须**验证受众声明
- MCP 服务器**不得**传递令牌到上游 API

**令牌传递禁止**：

```
❌ 错误：MCP Server 将收到的令牌传递给上游 API
✅ 正确：MCP Server 作为 OAuth 客户端获取新令牌访问上游 API
```

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 通信安全

### HTTPS 要求

实现**必须**遵循 OAuth 2.1 Section 1.5 通信安全要求：

1. 所有授权服务器端点**必须**通过 HTTPS 提供服务
2. 所有重定向 URI **必须**是 localhost 或使用 HTTPS

### Client ID Metadata Document 安全

**SSRF 风险**：

授权服务器获取元数据文档时**应该**考虑服务器端请求伪造（SSRF）风险：
- 验证 URL 格式
- 限制可访问的域
- 实现超时机制
- 避免访问内部网络

**Localhost 重定向 URI 风险**：

Client ID Metadata Documents 无法单独防止 `localhost` URL 冒充。

**防护措施**：
- 授权服务器**应该**对仅 localhost 的重定向 URI 显示额外警告
- **可以**要求额外的证明机制
- **必须**在授权期间清楚显示重定向 URI 主机名

[Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)

---

## 错误处理

### HTTP 状态码

| 状态码 | 描述 | 使用场景 |
|--------|------|---------|
| 401 | Unauthorized | 需要授权或令牌无效 |
| 403 | Forbidden | 作用域无效或权限不足 |
| 400 | Bad Request | 授权请求格式错误 |

### 错误响应示例

**协议错误**：

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32602,
    "message": "Invalid authorization"
  }
}
```

**作用域不足错误**：

```http
HTTP/1.1 403 Forbidden
WWW-Authenticate: Bearer error="insufficient_scope",
                         scope="required_scope1 required_scope2"
```

---

## 安全最佳实践

### 服务器端

**必须**：
- 验证所有访问令牌
- 实现适当的访问控制
- 限制令牌调用速率
- 清理令牌输出
- 验证令牌受众

**应该**：
- 发放短期访问令牌
- 实现令牌轮换
- 记录所有授权事件
- 监控异常访问模式

### 客户端端

**必须**：
- 实现 PKCE
- 安全存储令牌
- 使用 HTTPS
- 验证重定向 URI
- 包含 resource 参数

**应该**：
- 在敏感操作上提示用户确认
- 在调用服务器前向用户显示工具输入
- 验证令牌结果
- 实现令牌调用超时
- 记录令牌使用以供审计

---

## stdio 传输的安全

**重要**：stdio 传输**不应该**使用 OAuth 2.1 授权。

**替代方案**：
- 从环境变量获取凭证
- 使用进程隔离
- 依赖操作系统级别的权限控制

**原因**：
- stdio 传输是本地进程通信
- 不涉及网络传输
- 进程级别的隔离已提供足够安全性

---

## 安全检查清单

### 实现前检查

- [ ] 确定是否需要授权（HTTP 传输需要，stdio 不需要）
- [ ] 选择合适的客户端注册机制
- [ ] 配置 HTTPS 端点
- [ ] 实现 PKCE 支持
- [ ] 配置令牌存储

### 部署前检查

- [ ] 验证所有端点使用 HTTPS
- [ ] 测试 PKCE 流程
- [ ] 验证令牌受众检查
- [ ] 测试作用域挑战处理
- [ ] 验证错误处理
- [ ] 检查日志和监控

### 运行时监控

- [ ] 监控令牌使用模式
- [ ] 检测异常访问
- [ ] 审计授权事件
- [ ] 监控错误率
- [ ] 跟踪令牌刷新频率

---

## 总结

### 核心要点

1. **OAuth 2.1 基础**：MCP 授权基于成熟的 OAuth 2.1 标准
2. **可选但推荐**：HTTP 传输应该实现授权
3. **PKCE 必需**：防止授权码拦截攻击
4. **令牌受众验证**：防止令牌滥用
5. **多层防护**：结合多种安全机制

### 关键约束

- ✅ HTTP 传输：必须使用 OAuth 2.1
- ✅ stdio 传输：不应使用 OAuth（环境凭证）
- ✅ PKCE：必须实现，使用 S256 方法
- ✅ HTTPS：所有授权端点必须使用 HTTPS
- ✅ 令牌受众：必须验证令牌为服务器发放

### 下一步

- 阅读 [03_核心概念_05_Server架构设计](./03_核心概念_05_Server架构设计.md) 了解服务器实现
- 阅读 [07_实战代码_01_简单MCP_Server](./07_实战代码_01_简单MCP_Server.md) 查看安全实现

---

**参考资源**：
- [Source: Authorization - Model Context Protocol](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization)
- [Source: MCP Security Best Practices](https://modelcontextprotocol.io/docs/tutorials/security/security_best_practices)
- [Source: OAuth 2.1 IETF DRAFT](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13)
