# 实战代码 03：测试发布与集成

## 场景 1：单元测试技能

### 需求

为技能创建单元测试，确保技能按预期工作。

### 实现

**步骤 1：创建测试框架**

```typescript
// tests/skill-tester.ts
import { readFileSync } from 'fs';
import { parseFrontmatter } from '../src/utils/frontmatter';

interface SkillTest {
  name: string;
  skillPath: string;
  testCases: TestCase[];
}

interface TestCase {
  name: string;
  input: string;
  expectedKeywords: string[];
  notExpectedKeywords?: string[];
}

class SkillTester {
  async testSkill(test: SkillTest): Promise<TestResult> {
    console.log(`\nTesting skill: ${test.name}`);

    const results: TestCaseResult[] = [];

    for (const testCase of test.testCases) {
      const result = await this.runTestCase(test.skillPath, testCase);
      results.push(result);
    }

    const passed = results.filter(r => r.passed).length;
    const total = results.length;

    return {
      skillName: test.name,
      passed,
      total,
      results
    };
  }

  private async runTestCase(
    skillPath: string,
    testCase: TestCase
  ): Promise<TestCaseResult> {
    console.log(`  Testing: ${testCase.name}`);

    // 读取技能文件
    const content = readFileSync(skillPath, 'utf-8');
    const { frontmatter, body } = parseFrontmatter(content);

    // 验证 frontmatter
    if (!frontmatter.name || !frontmatter.description) {
      return {
        name: testCase.name,
        passed: false,
        error: 'Invalid frontmatter'
      };
    }

    // 模拟技能执行（简化版）
    const output = this.simulateSkillExecution(body, testCase.input);

    // 检查预期关键词
    const hasExpected = testCase.expectedKeywords.every(keyword =>
      output.toLowerCase().includes(keyword.toLowerCase())
    );

    // 检查不应出现的关键词
    const hasUnexpected = testCase.notExpectedKeywords?.some(keyword =>
      output.toLowerCase().includes(keyword.toLowerCase())
    ) ?? false;

    const passed = hasExpected && !hasUnexpected;

    console.log(`    Result: ${passed ? '✅ PASS' : '❌ FAIL'}`);

    return {
      name: testCase.name,
      passed,
      output: passed ? undefined : output,
      expectedKeywords: passed ? undefined : testCase.expectedKeywords
    };
  }

  private simulateSkillExecution(skillBody: string, input: string): string {
    // 简化的模拟：返回技能内容 + 输入
    return `${skillBody}\n\nInput: ${input}`;
  }
}

// 导出
export { SkillTester, SkillTest, TestCase };
```

**步骤 2：创建测试用例**

```typescript
// tests/code-review.test.ts
import { SkillTester } from './skill-tester';

const codeReviewTests: SkillTest = {
  name: 'code-review',
  skillPath: '~/.pi/agent/skills/code-review/SKILL.md',
  testCases: [
    {
      name: 'SQL Injection Detection',
      input: 'db.query(`SELECT * FROM users WHERE id = ${userId}`)',
      expectedKeywords: ['sql injection', 'vulnerability', 'parameterized'],
      notExpectedKeywords: ['no issues', 'looks good']
    },
    {
      name: 'Secure Code Recognition',
      input: 'db.query("SELECT * FROM users WHERE id = ?", [userId])',
      expectedKeywords: ['secure', 'parameterized', 'good'],
      notExpectedKeywords: ['vulnerability', 'injection']
    },
    {
      name: 'Performance Issue Detection',
      input: 'for (let i = 0; i < n; i++) { for (let j = 0; j < n; j++) { ... } }',
      expectedKeywords: ['complexity', 'o(n²)', 'performance'],
      notExpectedKeywords: ['no issues']
    }
  ]
};

// 运行测试
const tester = new SkillTester();
tester.testSkill(codeReviewTests).then(result => {
  console.log(`\nTest Summary: ${result.passed}/${result.total} passed`);
  process.exit(result.passed === result.total ? 0 : 1);
});
```

**步骤 3：运行测试**

```bash
# 添加到 package.json
{
  "scripts": {
    "test:skills": "ts-node tests/code-review.test.ts"
  }
}

# 运行测试
npm run test:skills
```

**预期输出：**

```
Testing skill: code-review

  Testing: SQL Injection Detection
    Result: ✅ PASS
  Testing: Secure Code Recognition
    Result: ✅ PASS
  Testing: Performance Issue Detection
    Result: ✅ PASS

Test Summary: 3/3 passed
```

---

## 场景 2：集成测试

### 需求

测试技能在实际 Agent 环境中的表现。

### 实现

**步骤 1：创建集成测试脚本**

```bash
#!/bin/bash
# tests/integration-test.sh

set -e

echo "Running integration tests for skills..."

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 测试计数
PASSED=0
FAILED=0

# 测试函数
run_test() {
  local test_name=$1
  local command=$2
  local expected_pattern=$3

  echo ""
  echo "Test: $test_name"

  # 运行命令并捕获输出
  output=$(eval "$command" 2>&1)

  # 检查预期模式
  if echo "$output" | grep -q "$expected_pattern"; then
    echo -e "${GREEN}✅ PASS${NC}"
    ((PASSED++))
  else
    echo -e "${RED}❌ FAIL${NC}"
    echo "Expected pattern: $expected_pattern"
    echo "Actual output: $output"
    ((FAILED++))
  fi
}

# Test 1: 技能加载
run_test "Skill Loading" \
  "echo '/skills' | pi --non-interactive" \
  "code-review"

# Test 2: 基本调用
run_test "Basic Invocation" \
  "echo '/skill:code-review src/app.ts' | pi --non-interactive" \
  "Strengths\|Issues\|Suggestions"

# Test 3: 参数传递
run_test "Parameter Passing" \
  "echo '/skill:code-review security src/app.ts' | pi --non-interactive" \
  "Security\|security"

# Test 4: 错误处理
run_test "Error Handling" \
  "echo '/skill:nonexistent' | pi --non-interactive" \
  "not found\|unknown"

# Test 5: 技能组合
run_test "Skill Composition" \
  "echo '/skill:full-workflow \"Add feature\"' | pi --non-interactive" \
  "Step 1\|Step 2"

# 总结
echo ""
echo "================================"
echo "Integration Test Summary"
echo "================================"
echo -e "Passed: ${GREEN}$PASSED${NC}"
echo -e "Failed: ${RED}$FAILED${NC}"
echo "Total: $((PASSED + FAILED))"

# 退出码
if [ $FAILED -eq 0 ]; then
  echo -e "\n${GREEN}All tests passed!${NC}"
  exit 0
else
  echo -e "\n${RED}Some tests failed!${NC}"
  exit 1
fi
```

**步骤 2：运行集成测试**

```bash
chmod +x tests/integration-test.sh
./tests/integration-test.sh
```

**预期输出：**

```
Running integration tests for skills...

Test: Skill Loading
✅ PASS

Test: Basic Invocation
✅ PASS

Test: Parameter Passing
✅ PASS

Test: Error Handling
✅ PASS

Test: Skill Composition
✅ PASS

================================
Integration Test Summary
================================
Passed: 5
Failed: 0
Total: 5

All tests passed!
```

---

## 场景 3：发布到 GitHub

### 需求

将技能发布到 GitHub，供他人使用。

### 实现

**步骤 1：准备发布**

```bash
# 创建仓库结构
mkdir my-skills
cd my-skills

# 初始化 Git
git init

# 创建 README.md
cat > README.md << 'EOF'
# My Skills Collection

A collection of AI agent skills for software development.

## Skills

### code-review
Review code for quality, security, and performance issues.

**Usage:**
```bash
/skill:code-review src/app.ts
```

### test-generation
Generate unit tests for TypeScript functions using Jest.

**Usage:**
```bash
/skill:test-generation src/utils.ts
```

## Installation

```bash
# Global installation
git clone https://github.com/user/my-skills ~/.pi/agent/skills/my-skills

# Project installation
git clone https://github.com/user/my-skills .pi/skills/my-skills
```

## License

MIT License - see LICENSE file for details.
EOF

# 创建 LICENSE
cat > LICENSE << 'EOF'
MIT License

Copyright (c) 2026 Your Name

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
EOF

# 创建 CHANGELOG.md
cat > CHANGELOG.md << 'EOF'
# Changelog

All notable changes to this project will be documented in this file.

## [1.0.0] - 2026-02-20

### Added
- Initial release
- code-review skill
- test-generation skill
- debugging skill
EOF

# 创建 .gitignore
cat > .gitignore << 'EOF'
node_modules/
.DS_Store
*.log
.env
EOF
```

**步骤 2：提交代码**

```bash
# 添加所有文件
git add .

# 创建初始提交
git commit -m "Initial commit: Add code-review, test-generation, debugging skills"

# 创建 GitHub 仓库（使用 gh CLI）
gh repo create my-skills \
  --public \
  --source=. \
  --remote=origin \
  --description="AI agent skills for software development"

# 推送到 GitHub
git push -u origin main
```

**步骤 3：创建 Release**

```bash
# 创建 tag
git tag v1.0.0

# 推送 tag
git push origin v1.0.0

# 创建 GitHub release
gh release create v1.0.0 \
  --title "v1.0.0 - Initial Release" \
  --notes "## Features

- **code-review**: Review code for quality and security
- **test-generation**: Generate unit tests
- **debugging**: Debug issues systematically

## Installation

\`\`\`bash
git clone https://github.com/user/my-skills ~/.pi/agent/skills/my-skills
\`\`\`

## Usage

\`\`\`bash
/skill:code-review src/app.ts
/skill:test-generation src/utils.ts
/skill:debugging \"User cannot login\"
\`\`\`"
```

**步骤 4：添加主题标签**

```bash
# 添加 GitHub topics
gh repo edit --add-topic agent-skills
gh repo edit --add-topic ai
gh repo edit --add-topic claude-code
gh repo edit --add-topic skills
```

---

## 场景 4：CI/CD 集成

### 需求

设置 CI/CD 流程，自动测试和发布技能。

### 实现

**步骤 1：创建 GitHub Actions 工作流**

```yaml
# .github/workflows/test.yml
name: Test Skills

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run unit tests
      run: npm run test:skills

    - name: Run integration tests
      run: ./tests/integration-test.sh

    - name: Validate skill format
      run: npm run validate:skills
```

**步骤 2：创建验证脚本**

```typescript
// scripts/validate-skills.ts
import { readdirSync, readFileSync, statSync } from 'fs';
import { join } from 'path';
import { parseFrontmatter } from '../src/utils/frontmatter';

interface ValidationResult {
  valid: boolean;
  errors: string[];
}

function validateSkill(skillPath: string): ValidationResult {
  const errors: string[] = [];

  try {
    // 检查 SKILL.md 文件存在
    const skillFile = join(skillPath, 'SKILL.md');
    if (!statSync(skillFile).isFile()) {
      errors.push('SKILL.md file not found');
      return { valid: false, errors };
    }

    // 读取并解析
    const content = readFileSync(skillFile, 'utf-8');
    const { frontmatter } = parseFrontmatter(content);

    // 验证 name
    if (!frontmatter.name) {
      errors.push('Missing name in frontmatter');
    } else {
      // 检查 name 格式
      if (!/^[a-z0-9-]+$/.test(frontmatter.name)) {
        errors.push('Invalid name format (must be lowercase, numbers, hyphens only)');
      }

      // 检查 name 与目录名匹配
      const dirName = skillPath.split('/').pop();
      if (frontmatter.name !== dirName) {
        errors.push(`Name "${frontmatter.name}" does not match directory "${dirName}"`);
      }
    }

    // 验证 description
    if (!frontmatter.description) {
      errors.push('Missing description in frontmatter');
    } else if (frontmatter.description.length > 1024) {
      errors.push('Description exceeds 1024 characters');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  } catch (error) {
    errors.push(`Error reading skill: ${error.message}`);
    return { valid: false, errors };
  }
}

// 验证所有技能
const skillsDir = 'skills';
const skills = readdirSync(skillsDir);

let allValid = true;

for (const skill of skills) {
  const skillPath = join(skillsDir, skill);
  if (!statSync(skillPath).isDirectory()) continue;

  console.log(`\nValidating: ${skill}`);
  const result = validateSkill(skillPath);

  if (result.valid) {
    console.log('  ✅ Valid');
  } else {
    console.log('  ❌ Invalid');
    result.errors.forEach(error => console.log(`    - ${error}`));
    allValid = false;
  }
}

console.log(`\n${allValid ? '✅ All skills valid' : '❌ Some skills invalid'}`);
process.exit(allValid ? 0 : 1);
```

**步骤 3：创建发布工作流**

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: |
        npm run test:skills
        ./tests/integration-test.sh

    - name: Validate skills
      run: npm run validate:skills

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes
          See CHANGELOG.md for details.

          ## Installation
          ```bash
          git clone --branch ${{ github.ref }} https://github.com/${{ github.repository }} ~/.pi/agent/skills/my-skills
          ```
        draft: false
        prerelease: false
```

**步骤 4：添加到 package.json**

```json
{
  "name": "my-skills",
  "version": "1.0.0",
  "scripts": {
    "test:skills": "ts-node tests/code-review.test.ts",
    "validate:skills": "ts-node scripts/validate-skills.ts",
    "test": "npm run test:skills && npm run validate:skills"
  },
  "devDependencies": {
    "@types/node": "^18.0.0",
    "ts-node": "^10.9.0",
    "typescript": "^5.0.0"
  }
}
```

**步骤 5：测试 CI/CD**

```bash
# 提交更改
git add .github/workflows/ scripts/ package.json
git commit -m "Add CI/CD workflows"
git push

# 创建新版本
git tag v1.0.1
git push origin v1.0.1

# GitHub Actions 会自动运行测试和发布
```

---

## 完整示例：端到端发布流程

### 需求

从开发到发布的完整流程。

### 实现步骤

**1. 开发技能**

```bash
# 创建技能
mkdir -p skills/my-skill
cat > skills/my-skill/SKILL.md << 'EOF'
---
name: my-skill
description: My custom skill
---

Skill logic here...
EOF
```

**2. 本地测试**

```bash
# 单元测试
npm run test:skills

# 集成测试
./tests/integration-test.sh

# 验证格式
npm run validate:skills
```

**3. 提交代码**

```bash
git add skills/my-skill
git commit -m "feat: add my-skill"
git push
```

**4. 创建 Pull Request**

```bash
gh pr create \
  --title "Add my-skill" \
  --body "## Description
New skill for...

## Testing
- [x] Unit tests pass
- [x] Integration tests pass
- [x] Format validation pass"
```

**5. 合并后发布**

```bash
# 更新 CHANGELOG
cat >> CHANGELOG.md << 'EOF'

## [1.1.0] - 2026-02-21

### Added
- my-skill: Custom skill for...
EOF

# 提交 CHANGELOG
git add CHANGELOG.md
git commit -m "docs: update CHANGELOG for v1.1.0"
git push

# 创建 release
git tag v1.1.0
git push origin v1.1.0

# GitHub Actions 自动发布
```

**6. 验证发布**

```bash
# 检查 GitHub release
gh release view v1.1.0

# 测试安装
git clone --branch v1.1.0 https://github.com/user/my-skills /tmp/test-install
ls /tmp/test-install/skills/my-skill
```

---

## 最佳实践

### 测试策略

**1. 测试金字塔**

```
        /\
       /  \
      / E2E\     少量端到端测试
     /______\
    /        \
   /Integration\ 适量集成测试
  /__________\
 /            \
/  Unit Tests  \  大量单元测试
/________________\
```

**2. 测试覆盖率**

- 单元测试：80%+ 覆盖率
- 集成测试：关键路径覆盖
- E2E 测试：核心用户场景

**3. 测试自动化**

- 每次提交运行测试
- PR 合并前必须通过测试
- 定期运行完整测试套件

### 发布策略

**1. 语义化版本**

```
v1.0.0 - 初始版本
v1.1.0 - 新功能（向后兼容）
v1.1.1 - Bug 修复（向后兼容）
v2.0.0 - 破坏性变更
```

**2. 发布检查清单**

- [ ] 所有测试通过
- [ ] 更新 CHANGELOG
- [ ] 更新 README
- [ ] 创建 Git tag
- [ ] 创建 GitHub release
- [ ] 通知用户

**3. 回滚策略**

```bash
# 如果发布有问题，快速回滚
git revert v1.1.0
git tag v1.1.1
git push origin v1.1.1
```

### CI/CD 最佳实践

**1. 快速反馈**

- 测试应在 5 分钟内完成
- 失败时立即通知
- 清晰的错误信息

**2. 环境一致性**

- 使用 Docker 容器
- 锁定依赖版本
- 环境变量管理

**3. 安全性**

- 不在代码中存储密钥
- 使用 GitHub Secrets
- 定期更新依赖

---

## 总结

**测试发布流程：**

1. **单元测试** - 验证技能格式和逻辑
2. **集成测试** - 测试实际环境表现
3. **发布到 GitHub** - 版本控制和分发
4. **CI/CD 集成** - 自动化测试和发布

**关键要点：**

- **自动化测试** - 确保质量
- **语义化版本** - 清晰的版本管理
- **CI/CD 流程** - 自动化发布
- **文档完善** - README + CHANGELOG

**下一步：**

- 【概览】- 回顾整个 Skills 技能包开发体系

---

**版本：** v1.0
**最后更新：** 2026-02-20
**维护者：** Claude Code
