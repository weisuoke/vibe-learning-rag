# 05_æ ¸å¿ƒæ¦‚å¿µ_å¥åº·æ£€æŸ¥

> æ·±å…¥ç†è§£ Milvus å¥åº·æ£€æŸ¥æœºåˆ¶å’Œæœ€ä½³å®è·µ

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥

### 1.1 ç”Ÿäº§ç¯å¢ƒå¯é æ€§

**å¥åº·æ£€æŸ¥æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡åŠŸèƒ½**ï¼Œç”¨äºç¡®ä¿æœåŠ¡çš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ã€‚

```
æ²¡æœ‰å¥åº·æ£€æŸ¥çš„ç³»ç»Ÿï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Milvus æœåŠ¡ï¼ˆå¯èƒ½å·²æŒ‚æ‰ï¼‰â†’ è¶…æ—¶/é”™è¯¯ â†’ ç”¨æˆ·ä½“éªŒå·®

æœ‰å¥åº·æ£€æŸ¥çš„ç³»ç»Ÿï¼š
å¥åº·æ£€æŸ¥ â†’ å‘ç°é—®é¢˜ â†’ è‡ªåŠ¨é‡å¯/å‘Šè­¦ â†’ ç”¨æˆ·è¯·æ±‚ â†’ æ­£å¸¸å“åº”
```

**æ ¸å¿ƒä»·å€¼ï¼š**
- **ä¸»åŠ¨å‘ç°é—®é¢˜**ï¼šåœ¨ç”¨æˆ·å‘ç°å‰æ£€æµ‹åˆ°æ•…éšœ
- **å¿«é€Ÿæ¢å¤**ï¼šè‡ªåŠ¨é‡å¯æˆ–åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹
- **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶é€šçŸ¥è¿ç»´äººå‘˜
- **æœåŠ¡é™çº§**ï¼šåœ¨éƒ¨åˆ†æ•…éšœæ—¶æä¾›é™çº§æœåŠ¡

---

### 1.2 æœåŠ¡å¯ç”¨æ€§ç›‘æ§

**å¯ç”¨æ€§çš„å®šä¹‰ï¼š**

```
å¯ç”¨æ€§ = (æ€»æ—¶é—´ - æ•…éšœæ—¶é—´) / æ€»æ—¶é—´ Ã— 100%

ä¾‹å¦‚ï¼š
- 99.9% å¯ç”¨æ€§ = æ¯æœˆæœ€å¤š 43 åˆ†é’Ÿæ•…éšœæ—¶é—´
- 99.99% å¯ç”¨æ€§ = æ¯æœˆæœ€å¤š 4.3 åˆ†é’Ÿæ•…éšœæ—¶é—´
- 99.999% å¯ç”¨æ€§ = æ¯æœˆæœ€å¤š 26 ç§’æ•…éšœæ—¶é—´
```

**å¥åº·æ£€æŸ¥çš„ä½œç”¨ï¼š**

| æŒ‡æ ‡ | æ— å¥åº·æ£€æŸ¥ | æœ‰å¥åº·æ£€æŸ¥ |
|------|------------|------------|
| **æ•…éšœå‘ç°æ—¶é—´** | ç”¨æˆ·æŠ¥å‘Šï¼ˆåˆ†é’Ÿçº§ï¼‰ | è‡ªåŠ¨æ£€æµ‹ï¼ˆç§’çº§ï¼‰ |
| **æ¢å¤æ—¶é—´** | æ‰‹åŠ¨ä»‹å…¥ï¼ˆå°æ—¶çº§ï¼‰ | è‡ªåŠ¨æ¢å¤ï¼ˆåˆ†é’Ÿçº§ï¼‰ |
| **å¯ç”¨æ€§** | 95-98% | 99.9%+ |
| **ç”¨æˆ·ä½“éªŒ** | é¢‘ç¹è¶…æ—¶ | ç¨³å®šå¯é  |

---

### 1.3 è‡ªåŠ¨åŒ–è¿ç»´éœ€æ±‚

**ä¼ ç»Ÿè¿ç»´ vs è‡ªåŠ¨åŒ–è¿ç»´ï¼š**

```python
# ä¼ ç»Ÿè¿ç»´ï¼ˆæ‰‹åŠ¨ï¼‰
# 1. ç”¨æˆ·æŠ¥å‘Šé—®é¢˜
# 2. è¿ç»´äººå‘˜ç™»å½•æœåŠ¡å™¨
# 3. æ£€æŸ¥æ—¥å¿—
# 4. é‡å¯æœåŠ¡
# 5. éªŒè¯æ¢å¤
# æ€»è€—æ—¶ï¼š30-60 åˆ†é’Ÿ

# è‡ªåŠ¨åŒ–è¿ç»´ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
def health_check_loop():
    while True:
        if not is_healthy():
            send_alert()  # å‘é€å‘Šè­¦
            restart_service()  # è‡ªåŠ¨é‡å¯
            verify_recovery()  # éªŒè¯æ¢å¤
        time.sleep(60)
# æ€»è€—æ—¶ï¼š1-2 åˆ†é’Ÿ
```

**è‡ªåŠ¨åŒ–è¿ç»´çš„ä¼˜åŠ¿ï¼š**
- **24/7 ç›‘æ§**ï¼šä¸éœ€è¦äººå·¥å€¼å®ˆ
- **å¿«é€Ÿå“åº”**ï¼šç§’çº§å‘ç°å’Œæ¢å¤
- **é™ä½æˆæœ¬**ï¼šå‡å°‘äººå·¥ä»‹å…¥
- **æé«˜å¯é æ€§**ï¼šé¿å…äººä¸ºé”™è¯¯

---

## 2. è¿æ¥å¥åº·æ£€æŸ¥

### 2.1 utility.get_server_version()

**æœ€åŸºæœ¬çš„å¥åº·æ£€æŸ¥æ–¹æ³•**ï¼šè·å–æœåŠ¡å™¨ç‰ˆæœ¬ã€‚

```python
from pymilvus import connections, utility

# å»ºç«‹è¿æ¥
connections.connect("default", host="localhost", port="19530")

# è·å–æœåŠ¡å™¨ç‰ˆæœ¬
try:
    version = utility.get_server_version()
    print(f"âœ… Milvus å¥åº·ï¼Œç‰ˆæœ¬: {version}")
except Exception as e:
    print(f"âŒ Milvus ä¸å¥åº·: {e}")
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ³•æœ‰æ•ˆï¼Ÿ**
- éœ€è¦å»ºç«‹è¿æ¥ï¼ˆéªŒè¯ç½‘ç»œï¼‰
- éœ€è¦æœåŠ¡å™¨å“åº”ï¼ˆéªŒè¯æœåŠ¡è¿è¡Œï¼‰
- è¿”å›ç‰ˆæœ¬ä¿¡æ¯ï¼ˆéªŒè¯æœåŠ¡æ­£å¸¸ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¯åŠ¨æ—¶æ£€æŸ¥
- å®šæ—¶å¥åº·æ£€æŸ¥
- è¿æ¥å‰éªŒè¯

---

### 2.2 è¿æ¥çŠ¶æ€éªŒè¯

**æ£€æŸ¥è¿æ¥æ˜¯å¦å­˜åœ¨ï¼š**

```python
from pymilvus import connections

# æ£€æŸ¥è¿æ¥æ˜¯å¦å­˜åœ¨
if connections.has_connection("default"):
    print("âœ… è¿æ¥å­˜åœ¨")
else:
    print("âŒ è¿æ¥ä¸å­˜åœ¨")
```

**æ£€æŸ¥è¿æ¥æ˜¯å¦å¯ç”¨ï¼š**

```python
def is_connection_alive(alias="default"):
    """æ£€æŸ¥è¿æ¥æ˜¯å¦å¯ç”¨"""
    try:
        if not connections.has_connection(alias):
            return False

        # å°è¯•æ‰§è¡Œä¸€ä¸ªç®€å•æ“ä½œ
        from pymilvus import utility
        utility.get_server_version()
        return True
    except Exception as e:
        print(f"è¿æ¥ä¸å¯ç”¨: {e}")
        return False

# ä½¿ç”¨
if is_connection_alive():
    print("âœ… è¿æ¥å¯ç”¨")
else:
    print("âŒ è¿æ¥ä¸å¯ç”¨")
```

---

### 2.3 è¶…æ—¶æ£€æµ‹

**è®¾ç½®è¶…æ—¶æ—¶é—´ï¼š**

```python
from pymilvus import connections
import time

def connect_with_timeout(timeout=10):
    """å¸¦è¶…æ—¶çš„è¿æ¥"""
    start_time = time.time()

    try:
        connections.connect(
            alias="default",
            host="localhost",
            port="19530",
            timeout=timeout
        )

        elapsed = time.time() - start_time
        print(f"âœ… è¿æ¥æˆåŠŸï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
        return True
    except Exception as e:
        elapsed = time.time() - start_time
        print(f"âŒ è¿æ¥å¤±è´¥ï¼Œè€—æ—¶: {elapsed:.2f}ç§’ï¼Œé”™è¯¯: {e}")
        return False

# ä½¿ç”¨
connect_with_timeout(timeout=5)
```

**è¶…æ—¶æ£€æµ‹çš„é‡è¦æ€§ï¼š**

```python
# åœºæ™¯ï¼šMilvus æœåŠ¡å“åº”ç¼“æ…¢

# æ²¡æœ‰è¶…æ—¶æ£€æµ‹
connections.connect("default", host="slow-server", port="19530")
# å¯èƒ½ç­‰å¾…å¾ˆä¹…ï¼ˆé»˜è®¤è¶…æ—¶å¯èƒ½æ˜¯å‡ åˆ†é’Ÿï¼‰

# æœ‰è¶…æ—¶æ£€æµ‹
connections.connect("default", host="slow-server", port="19530", timeout=5)
# 5ç§’åè¶…æ—¶ï¼Œå¿«é€Ÿå¤±è´¥
```

---

## 3. æœåŠ¡å¥åº·æ£€æŸ¥

### 3.1 Collection å¯ç”¨æ€§æ£€æŸ¥

**æ£€æŸ¥ Collection æ˜¯å¦å­˜åœ¨ï¼š**

```python
from pymilvus import utility

def check_collection_health(collection_name):
    """æ£€æŸ¥ Collection å¥åº·çŠ¶æ€"""
    try:
        # 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
        if not utility.has_collection(collection_name):
            return False, "Collection ä¸å­˜åœ¨"

        # 2. æ£€æŸ¥æ˜¯å¦åŠ è½½
        load_state = utility.load_state(collection_name)
        if load_state.get("state") != "Loaded":
            return False, f"Collection æœªåŠ è½½ï¼ŒçŠ¶æ€: {load_state}"

        # 3. æ£€æŸ¥æ•°æ®é‡
        from pymilvus import Collection
        collection = Collection(collection_name)
        num_entities = collection.num_entities
        print(f"âœ… Collection å¥åº·ï¼Œæ•°æ®é‡: {num_entities}")
        return True, f"æ•°æ®é‡: {num_entities}"

    except Exception as e:
        return False, f"æ£€æŸ¥å¤±è´¥: {e}"

# ä½¿ç”¨
is_healthy, message = check_collection_health("my_collection")
if is_healthy:
    print(f"âœ… {message}")
else:
    print(f"âŒ {message}")
```

---

### 3.2 ç´¢å¼•çŠ¶æ€æ£€æŸ¥

**æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼š**

```python
from pymilvus import Collection

def check_index_health(collection_name, field_name="embedding"):
    """æ£€æŸ¥ç´¢å¼•å¥åº·çŠ¶æ€"""
    try:
        collection = Collection(collection_name)

        # æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
        index = collection.index()
        if index is None:
            return False, "ç´¢å¼•ä¸å­˜åœ¨"

        # è·å–ç´¢å¼•ä¿¡æ¯
        index_params = index.params
        print(f"âœ… ç´¢å¼•å¥åº·")
        print(f"   ç´¢å¼•ç±»å‹: {index_params.get('index_type')}")
        print(f"   åº¦é‡ç±»å‹: {index_params.get('metric_type')}")
        return True, "ç´¢å¼•æ­£å¸¸"

    except Exception as e:
        return False, f"æ£€æŸ¥å¤±è´¥: {e}"

# ä½¿ç”¨
is_healthy, message = check_index_health("my_collection")
```

---

### 3.3 èµ„æºä½¿ç”¨æƒ…å†µ

**æ£€æŸ¥å†…å­˜ä½¿ç”¨ï¼š**

```python
from pymilvus import utility

def check_resource_usage():
    """æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ"""
    try:
        # è·å–æŸ¥è¯¢èŠ‚ç‚¹ä¿¡æ¯
        query_nodes = utility.get_query_segment_info("my_collection")

        total_memory = 0
        for node in query_nodes:
            total_memory += node.mem_size

        print(f"âœ… èµ„æºä½¿ç”¨æƒ…å†µ")
        print(f"   å†…å­˜ä½¿ç”¨: {total_memory / 1024 / 1024:.2f} MB")
        print(f"   æ®µæ•°é‡: {len(query_nodes)}")

        # è®¾ç½®å‘Šè­¦é˜ˆå€¼
        if total_memory > 1024 * 1024 * 1024:  # 1GB
            print("âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜")
            return False, "å†…å­˜ä½¿ç”¨è¿‡é«˜"

        return True, "èµ„æºä½¿ç”¨æ­£å¸¸"

    except Exception as e:
        return False, f"æ£€æŸ¥å¤±è´¥: {e}"

# ä½¿ç”¨
is_healthy, message = check_resource_usage()
```

---

## 4. å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ

### 4.1 æ£€æŸ¥é¢‘ç‡è®¾ç½®

**ä¸åŒåœºæ™¯çš„æ£€æŸ¥é¢‘ç‡ï¼š**

| åœºæ™¯ | æ£€æŸ¥é¢‘ç‡ | åŸå›  |
|------|----------|------|
| **å¯åŠ¨æ—¶** | ä¸€æ¬¡ | ç¡®ä¿æœåŠ¡å¯ç”¨åå†å¯åŠ¨åº”ç”¨ |
| **å¼€å‘ç¯å¢ƒ** | 5-10 åˆ†é’Ÿ | å¿«é€Ÿå‘ç°é—®é¢˜ |
| **æµ‹è¯•ç¯å¢ƒ** | 2-5 åˆ†é’Ÿ | åŠæ—¶å‘ç°æµ‹è¯•ä¸­çš„é—®é¢˜ |
| **ç”Ÿäº§ç¯å¢ƒ** | 1-2 åˆ†é’Ÿ | å¿«é€Ÿå‘ç°å’Œæ¢å¤ |
| **é«˜å¯ç”¨ç¯å¢ƒ** | 30-60 ç§’ | æœ€å°åŒ–æ•…éšœæ—¶é—´ |

**å®ç°ç¤ºä¾‹ï¼š**

```python
import time
import threading

def health_check_loop(interval=60):
    """å®šæ—¶å¥åº·æ£€æŸ¥"""
    while True:
        try:
            # æ‰§è¡Œå¥åº·æ£€æŸ¥
            is_healthy = check_milvus_health()

            if is_healthy:
                print(f"âœ… [{time.strftime('%Y-%m-%d %H:%M:%S')}] Milvus å¥åº·")
            else:
                print(f"âŒ [{time.strftime('%Y-%m-%d %H:%M:%S')}] Milvus ä¸å¥åº·")
                # å‘é€å‘Šè­¦
                send_alert("Milvus å¥åº·æ£€æŸ¥å¤±è´¥")

        except Exception as e:
            print(f"âŒ å¥åº·æ£€æŸ¥å¼‚å¸¸: {e}")

        time.sleep(interval)

# åœ¨åå°çº¿ç¨‹è¿è¡Œ
health_thread = threading.Thread(target=health_check_loop, args=(60,), daemon=True)
health_thread.start()
```

---

### 4.2 å‘Šè­¦é˜ˆå€¼é…ç½®

**å¤šçº§å‘Šè­¦ç­–ç•¥ï¼š**

```python
class HealthCheckConfig:
    """å¥åº·æ£€æŸ¥é…ç½®"""

    # è¿æ¥è¶…æ—¶é˜ˆå€¼
    CONNECTION_TIMEOUT = 10  # ç§’

    # å“åº”æ—¶é—´é˜ˆå€¼
    RESPONSE_TIME_WARNING = 1.0  # ç§’ï¼ˆè­¦å‘Šï¼‰
    RESPONSE_TIME_CRITICAL = 5.0  # ç§’ï¼ˆä¸¥é‡ï¼‰

    # å†…å­˜ä½¿ç”¨é˜ˆå€¼
    MEMORY_WARNING = 1024 * 1024 * 1024  # 1GBï¼ˆè­¦å‘Šï¼‰
    MEMORY_CRITICAL = 2 * 1024 * 1024 * 1024  # 2GBï¼ˆä¸¥é‡ï¼‰

    # è¿ç»­å¤±è´¥æ¬¡æ•°
    MAX_CONSECUTIVE_FAILURES = 3  # è¿ç»­å¤±è´¥3æ¬¡è§¦å‘å‘Šè­¦

def check_with_thresholds():
    """å¸¦é˜ˆå€¼çš„å¥åº·æ£€æŸ¥"""
    import time

    start_time = time.time()

    try:
        # æ‰§è¡Œå¥åº·æ£€æŸ¥
        from pymilvus import utility
        version = utility.get_server_version()

        elapsed = time.time() - start_time

        # æ£€æŸ¥å“åº”æ—¶é—´
        if elapsed > HealthCheckConfig.RESPONSE_TIME_CRITICAL:
            return "CRITICAL", f"å“åº”æ—¶é—´è¿‡é•¿: {elapsed:.2f}ç§’"
        elif elapsed > HealthCheckConfig.RESPONSE_TIME_WARNING:
            return "WARNING", f"å“åº”æ—¶é—´è¾ƒæ…¢: {elapsed:.2f}ç§’"
        else:
            return "OK", f"å¥åº·ï¼Œå“åº”æ—¶é—´: {elapsed:.2f}ç§’"

    except Exception as e:
        return "CRITICAL", f"å¥åº·æ£€æŸ¥å¤±è´¥: {e}"

# ä½¿ç”¨
status, message = check_with_thresholds()
print(f"[{status}] {message}")
```

---

### 4.3 è‡ªåŠ¨é‡è¿æœºåˆ¶

**å®ç°è‡ªåŠ¨é‡è¿ï¼š**

```python
import time
from pymilvus import connections, MilvusException

class MilvusConnectionManager:
    """Milvus è¿æ¥ç®¡ç†å™¨ï¼ˆå¸¦è‡ªåŠ¨é‡è¿ï¼‰"""

    def __init__(self, alias="default", host="localhost", port="19530", max_retries=3):
        self.alias = alias
        self.host = host
        self.port = port
        self.max_retries = max_retries
        self.consecutive_failures = 0

    def connect(self):
        """å»ºç«‹è¿æ¥"""
        for attempt in range(self.max_retries):
            try:
                connections.connect(
                    alias=self.alias,
                    host=self.host,
                    port=self.port,
                    timeout=10
                )
                print(f"âœ… è¿æ¥æˆåŠŸ")
                self.consecutive_failures = 0
                return True
            except MilvusException as e:
                print(f"âŒ è¿æ¥å¤±è´¥ (å°è¯• {attempt + 1}/{self.max_retries}): {e}")
                if attempt < self.max_retries - 1:
                    time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
                else:
                    self.consecutive_failures += 1
                    return False

    def ensure_connection(self):
        """ç¡®ä¿è¿æ¥å¯ç”¨"""
        if not connections.has_connection(self.alias):
            return self.connect()

        # æ£€æŸ¥è¿æ¥æ˜¯å¦å¯ç”¨
        try:
            from pymilvus import utility
            utility.get_server_version()
            self.consecutive_failures = 0
            return True
        except Exception:
            print("âš ï¸ è¿æ¥ä¸å¯ç”¨ï¼Œå°è¯•é‡è¿...")
            connections.disconnect(self.alias)
            return self.connect()

    def should_alert(self):
        """æ˜¯å¦åº”è¯¥å‘é€å‘Šè­¦"""
        return self.consecutive_failures >= 3

# ä½¿ç”¨
manager = MilvusConnectionManager()

# å®šæ—¶æ£€æŸ¥å¹¶è‡ªåŠ¨é‡è¿
def auto_reconnect_loop():
    while True:
        if not manager.ensure_connection():
            if manager.should_alert():
                send_alert("Milvus è¿æ¥æŒç»­å¤±è´¥")
        time.sleep(60)

import threading
reconnect_thread = threading.Thread(target=auto_reconnect_loop, daemon=True)
reconnect_thread.start()
```

---

### 4.4 å¥åº·æ£€æŸ¥ API å®ç°

**FastAPI å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š**

```python
from fastapi import FastAPI, status
from fastapi.responses import JSONResponse
from pymilvus import connections, utility
import time

app = FastAPI()

# å…¨å±€å¥åº·çŠ¶æ€
health_status = {
    "status": "unknown",
    "last_check": None,
    "details": {}
}

def perform_health_check():
    """æ‰§è¡Œå¥åº·æ£€æŸ¥"""
    global health_status

    start_time = time.time()
    checks = {}

    # 1. æ£€æŸ¥è¿æ¥
    try:
        if connections.has_connection("default"):
            checks["connection"] = "OK"
        else:
            checks["connection"] = "FAIL"
            health_status["status"] = "unhealthy"
            return
    except Exception as e:
        checks["connection"] = f"ERROR: {e}"
        health_status["status"] = "unhealthy"
        return

    # 2. æ£€æŸ¥æœåŠ¡å™¨
    try:
        version = utility.get_server_version()
        checks["server"] = f"OK (version: {version})"
    except Exception as e:
        checks["server"] = f"ERROR: {e}"
        health_status["status"] = "unhealthy"
        return

    # 3. æ£€æŸ¥å“åº”æ—¶é—´
    elapsed = time.time() - start_time
    checks["response_time"] = f"{elapsed:.3f}s"

    if elapsed > 5.0:
        health_status["status"] = "degraded"
    else:
        health_status["status"] = "healthy"

    health_status["last_check"] = time.strftime("%Y-%m-%d %H:%M:%S")
    health_status["details"] = checks

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    perform_health_check()

    if health_status["status"] == "healthy":
        return JSONResponse(
            status_code=status.HTTP_200_OK,
            content=health_status
        )
    elif health_status["status"] == "degraded":
        return JSONResponse(
            status_code=status.HTTP_200_OK,
            content=health_status
        )
    else:
        return JSONResponse(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            content=health_status
        )

@app.get("/health/liveness")
async def liveness_check():
    """å­˜æ´»æ£€æŸ¥ï¼ˆKubernetesï¼‰"""
    # ç®€å•æ£€æŸ¥ï¼šåº”ç”¨æ˜¯å¦è¿è¡Œ
    return {"status": "alive"}

@app.get("/health/readiness")
async def readiness_check():
    """å°±ç»ªæ£€æŸ¥ï¼ˆKubernetesï¼‰"""
    # è¯¦ç»†æ£€æŸ¥ï¼šæ˜¯å¦å¯ä»¥å¤„ç†è¯·æ±‚
    perform_health_check()

    if health_status["status"] in ["healthy", "degraded"]:
        return JSONResponse(
            status_code=status.HTTP_200_OK,
            content={"status": "ready"}
        )
    else:
        return JSONResponse(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            content={"status": "not ready"}
        )

# å¯åŠ¨æ—¶å»ºç«‹è¿æ¥
@app.on_event("startup")
async def startup_event():
    connections.connect("default", host="localhost", port="19530")
    perform_health_check()

# å…³é—­æ—¶æ–­å¼€è¿æ¥
@app.on_event("shutdown")
async def shutdown_event():
    connections.disconnect("default")
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```bash
# å¯åŠ¨ API
uvicorn main:app --host 0.0.0.0 --port 8000

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# è¾“å‡ºç¤ºä¾‹ï¼š
# {
#   "status": "healthy",
#   "last_check": "2026-02-09 12:34:56",
#   "details": {
#     "connection": "OK",
#     "server": "OK (version: 2.4.0)",
#     "response_time": "0.123s"
#   }
# }
```

---

## 5. åœ¨ RAG ä¸­çš„åº”ç”¨

### 5.1 RAG æœåŠ¡å¯åŠ¨å‰æ£€æŸ¥

**å¯åŠ¨å‰éªŒè¯ï¼š**

```python
from pymilvus import connections, utility

def startup_health_check():
    """å¯åŠ¨å‰å¥åº·æ£€æŸ¥"""
    print("=== RAG æœåŠ¡å¯åŠ¨å‰æ£€æŸ¥ ===")

    # 1. æ£€æŸ¥ Milvus è¿æ¥
    print("1. æ£€æŸ¥ Milvus è¿æ¥...")
    try:
        connections.connect("default", host="localhost", port="19530", timeout=10)
        print("   âœ… è¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"   âŒ è¿æ¥å¤±è´¥: {e}")
        return False

    # 2. æ£€æŸ¥æœåŠ¡å™¨ç‰ˆæœ¬
    print("2. æ£€æŸ¥æœåŠ¡å™¨ç‰ˆæœ¬...")
    try:
        version = utility.get_server_version()
        print(f"   âœ… ç‰ˆæœ¬: {version}")
    except Exception as e:
        print(f"   âŒ è·å–ç‰ˆæœ¬å¤±è´¥: {e}")
        return False

    # 3. æ£€æŸ¥ Collection
    print("3. æ£€æŸ¥ Collection...")
    try:
        if utility.has_collection("rag_documents"):
            from pymilvus import Collection
            collection = Collection("rag_documents")
            print(f"   âœ… Collection å­˜åœ¨ï¼Œæ•°æ®é‡: {collection.num_entities}")
        else:
            print("   âš ï¸ Collection ä¸å­˜åœ¨ï¼Œéœ€è¦åˆå§‹åŒ–")
    except Exception as e:
        print(f"   âŒ æ£€æŸ¥å¤±è´¥: {e}")
        return False

    print("=== æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ŒæœåŠ¡å¯ä»¥å¯åŠ¨ ===")
    return True

# åœ¨ main å‡½æ•°ä¸­ä½¿ç”¨
if __name__ == "__main__":
    if startup_health_check():
        # å¯åŠ¨ RAG æœåŠ¡
        start_rag_service()
    else:
        print("âŒ å¯åŠ¨å‰æ£€æŸ¥å¤±è´¥ï¼ŒæœåŠ¡æ— æ³•å¯åŠ¨")
        exit(1)
```

---

### 5.2 å®šæ—¶å¥åº·ç›‘æ§

**åå°ç›‘æ§çº¿ç¨‹ï¼š**

```python
import threading
import time
from pymilvus import connections, utility

class RAGHealthMonitor:
    """RAG ç³»ç»Ÿå¥åº·ç›‘æ§"""

    def __init__(self, check_interval=60):
        self.check_interval = check_interval
        self.is_running = False
        self.thread = None

    def start(self):
        """å¯åŠ¨ç›‘æ§"""
        self.is_running = True
        self.thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self.thread.start()
        print("âœ… å¥åº·ç›‘æ§å·²å¯åŠ¨")

    def stop(self):
        """åœæ­¢ç›‘æ§"""
        self.is_running = False
        if self.thread:
            self.thread.join()
        print("âœ… å¥åº·ç›‘æ§å·²åœæ­¢")

    def _monitor_loop(self):
        """ç›‘æ§å¾ªç¯"""
        while self.is_running:
            try:
                self._perform_check()
            except Exception as e:
                print(f"âŒ ç›‘æ§å¼‚å¸¸: {e}")

            time.sleep(self.check_interval)

    def _perform_check(self):
        """æ‰§è¡Œæ£€æŸ¥"""
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")

        # 1. æ£€æŸ¥è¿æ¥
        if not connections.has_connection("default"):
            print(f"[{timestamp}] âŒ Milvus è¿æ¥æ–­å¼€")
            self._send_alert("Milvus è¿æ¥æ–­å¼€")
            return

        # 2. æ£€æŸ¥æœåŠ¡å™¨
        try:
            version = utility.get_server_version()
            print(f"[{timestamp}] âœ… Milvus å¥åº· (ç‰ˆæœ¬: {version})")
        except Exception as e:
            print(f"[{timestamp}] âŒ Milvus ä¸å¥åº·: {e}")
            self._send_alert(f"Milvus ä¸å¥åº·: {e}")

    def _send_alert(self, message):
        """å‘é€å‘Šè­¦"""
        # å®ç°å‘Šè­¦é€»è¾‘ï¼ˆé‚®ä»¶ã€Slackã€é’‰é’‰ç­‰ï¼‰
        print(f"ğŸš¨ å‘Šè­¦: {message}")

# ä½¿ç”¨
monitor = RAGHealthMonitor(check_interval=60)
monitor.start()

# åœ¨åº”ç”¨å…³é—­æ—¶åœæ­¢ç›‘æ§
import atexit
atexit.register(monitor.stop)
```

---

### 5.3 é™çº§ç­–ç•¥

**æœåŠ¡é™çº§ç¤ºä¾‹ï¼š**

```python
from pymilvus import connections, Collection

class RAGService:
    """RAG æœåŠ¡ï¼ˆå¸¦é™çº§ç­–ç•¥ï¼‰"""

    def __init__(self):
        self.milvus_available = True
        self.fallback_cache = {}  # é™çº§ç¼“å­˜

    def search(self, query):
        """æ£€ç´¢ï¼ˆå¸¦é™çº§ï¼‰"""
        # 1. å°è¯•ä½¿ç”¨ Milvus
        if self.milvus_available:
            try:
                return self._search_milvus(query)
            except Exception as e:
                print(f"âš ï¸ Milvus æ£€ç´¢å¤±è´¥: {e}")
                self.milvus_available = False
                # é™çº§åˆ°ç¼“å­˜

        # 2. é™çº§ï¼šä½¿ç”¨ç¼“å­˜
        print("âš ï¸ ä½¿ç”¨é™çº§ç­–ç•¥ï¼šç¼“å­˜æ£€ç´¢")
        return self._search_cache(query)

    def _search_milvus(self, query):
        """Milvus æ£€ç´¢"""
        collection = Collection("rag_documents")
        # ... æ‰§è¡Œæ£€ç´¢ ...
        return results

    def _search_cache(self, query):
        """ç¼“å­˜æ£€ç´¢ï¼ˆé™çº§ï¼‰"""
        # ä»ç¼“å­˜ä¸­æŸ¥æ‰¾
        if query in self.fallback_cache:
            return self.fallback_cache[query]
        else:
            return []  # è¿”å›ç©ºç»“æœ

    def health_check(self):
        """å¥åº·æ£€æŸ¥"""
        try:
            from pymilvus import utility
            utility.get_server_version()
            self.milvus_available = True
            print("âœ… Milvus æ¢å¤æ­£å¸¸")
        except Exception:
            self.milvus_available = False

# ä½¿ç”¨
service = RAGService()

# å®šæ—¶å¥åº·æ£€æŸ¥
def health_check_loop():
    while True:
        service.health_check()
        time.sleep(60)

import threading
health_thread = threading.Thread(target=health_check_loop, daemon=True)
health_thread.start()
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥
- [ ] ä½¿ç”¨ utility.get_server_version() æ£€æŸ¥æœåŠ¡å™¨
- [ ] éªŒè¯è¿æ¥çŠ¶æ€
- [ ] å®ç°è¶…æ—¶æ£€æµ‹
- [ ] æ£€æŸ¥ Collection å¯ç”¨æ€§
- [ ] æ£€æŸ¥ç´¢å¼•çŠ¶æ€
- [ ] ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- [ ] è®¾ç½®åˆç†çš„æ£€æŸ¥é¢‘ç‡
- [ ] é…ç½®å‘Šè­¦é˜ˆå€¼
- [ ] å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
- [ ] åˆ›å»ºå¥åº·æ£€æŸ¥ API
- [ ] åœ¨ RAG ç³»ç»Ÿä¸­åº”ç”¨å¥åº·æ£€æŸ¥
- [ ] å®ç°æœåŠ¡é™çº§ç­–ç•¥

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

- **å®æˆ˜ä»£ç **ï¼ˆ09-12_å®æˆ˜ä»£ç _åœºæ™¯*.mdï¼‰
  - åŠ¨æ‰‹å®è·µå®Œæ•´çš„å¥åº·æ£€æŸ¥æµç¨‹

- **é¢è¯•å¿…é—®**ï¼ˆ13_é¢è¯•å¿…é—®.mdï¼‰
  - å‡†å¤‡å¥åº·æ£€æŸ¥ç›¸å…³çš„é¢è¯•é—®é¢˜

---

**è®°ä½ï¼š** å¥åº·æ£€æŸ¥æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡åŠŸèƒ½ï¼Œä¸»åŠ¨ç›‘æ§æ¯”è¢«åŠ¨å“åº”æ›´é‡è¦ï¼
