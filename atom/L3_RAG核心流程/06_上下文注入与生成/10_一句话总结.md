# 一句话总结

**上下文注入与生成是将检索到的文档块通过结构化 Prompt 模板组装后调用 LLM 生成答案的过程，是 RAG 系统将"检索能力"转化为"回答能力"的关键环节，决定了最终答案的质量、准确性和可追溯性。**

---

## 核心要点回顾

| 维度 | 核心内容 |
|------|----------|
| 30字核心 | 上下文注入 = Prompt 组装 + LLM 调用 |
| 第一性原理 | 给 LLM "递参考资料"，让它有据可查 |
| 核心概念 | Prompt 模板、Lost in the Middle、Token 预算 |
| 最小可用 | 三段式模板 + LangChain LCEL 链 |
| 双重类比 | API 请求组装 / 给厨师下单 |
| 反直觉点 | 上下文不是越多越好、需要格式化、LLM 不会自动过滤 |
| 实战代码 | 完整的 LangChain RAG 生成链 |
| 面试必问 | 三层优化（上下文质量 > Prompt > 参数） |
| 化骨绵掌 | 10个知识卡片，从基础到生产实践 |

---

## 学习检查清单

### 基础理解 ✓

- [ ] 能说出上下文注入的定义和作用
- [ ] 理解 Prompt 的三层结构（System + Context + Query）
- [ ] 知道为什么需要格式化检索结果

### 核心技能 ✓

- [ ] 能写出一个基础的 RAG Prompt 模板
- [ ] 能用 LangChain 构建简单的 RAG 生成链
- [ ] 理解 Lost in the Middle 现象及解决方案
- [ ] 能进行基本的 Token 预算管理

### 进阶能力 ✓

- [ ] 能设计包含四要素的 System Prompt
- [ ] 能实现流式输出
- [ ] 能让 LLM 在回答中标注来源
- [ ] 理解幻觉防控的三层防线

### 实战应用 ✓

- [ ] 能独立构建一个 RAG 问答系统的生成模块
- [ ] 能根据场景选择合适的生成参数
- [ ] 能处理"找不到答案"的边界情况
- [ ] 能在面试中系统性回答 RAG 生成优化问题

---

## 快速参考卡

```
┌─────────────────────────────────────────────────────────────┐
│                上下文注入与生成 速查表                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Prompt 结构：System + Context + Query                      │
│                                                             │
│  System Prompt 四要素：角色 + 约束 + 格式 + 引用规范          │
│                                                             │
│  Context 格式化：编号 + 来源 + 分隔符                        │
│                                                             │
│  Lost in the Middle：重要内容放开头和结尾                    │
│                                                             │
│  Token 预算：System(8%) + Context(65%) + Query(4%) + 输出(23%)│
│                                                             │
│  生成参数：问答用 temperature=0                              │
│                                                             │
│  幻觉防控：检索过滤 + Prompt 约束 + 参数控制                  │
│                                                             │
│  最佳实践：检索质量 > Prompt 设计 > 生成参数                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 与其他章节的关系

```
┌─────────────────────────────────────────────────────────────┐
│                    L3_RAG核心流程 完整链路                    │
│                                                             │
│  文档加载 → 文本分块 → 向量存储 → 检索器 → ★上下文注入与生成★ │
│     ↓          ↓          ↓         ↓              ↓        │
│  原始数据    文档块      向量索引   Top-K文档     最终答案     │
│                                                             │
│  离线索引阶段 ─────────────────────┼───── 在线查询阶段       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 下一步学习

完成 L3_RAG核心流程 后，建议学习：

- **L4_RAG进阶优化**
  - 混合检索策略
  - ReRank 重排序
  - Query 改写
  - 评估与调优

---

## 参考资源

- [LangChain RAG 文档](https://python.langchain.com/docs/tutorials/rag/)
- [Lost in the Middle 论文](https://arxiv.org/abs/2307.03172)
- [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)

---

**恭喜完成本章学习！** 🎉

你已经掌握了 RAG 系统的最后一环——如何将检索结果转化为高质量答案。
