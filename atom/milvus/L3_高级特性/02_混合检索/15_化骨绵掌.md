# 化骨绵掌

10个2分钟知识卡片，快速掌握混合检索核心要点。

---

## 卡片1：混合检索的本质

**一句话**：混合检索 = 向量检索（语义相似）∩ 标量过滤（精确条件）

**举例**：
```python
# 向量检索：找到语义相似的文档
# 标量过滤：只要2024年的文档
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr="year == 2024"  # 交集运算
)
```

**应用**：在 RAG 系统中，既要"语义相关"（向量检索），又要"符合条件"（标量过滤）。

---

## 卡片2：两种执行策略

**一句话**：Filter-then-Search（先过滤后检索）vs Search-then-Filter（先检索后过滤）

**决策规则**：
```
过滤选择性 > 90% → Filter-then-Search（快10-100倍）
过滤选择性 < 50% → Search-then-Filter
```

**举例**：
- `tenant_id == 'A'`（选择性99%）→ Filter-then-Search
- `age > 18`（选择性10%）→ Search-then-Filter

**应用**：Milvus 自动选择最优策略，用户无需手动指定。

---

## 卡片3：高选择性过滤的威力

**一句话**：高选择性过滤（过滤掉>90%数据）可以将性能提升10-100倍

**数学原理**：
```
无过滤：100万条 × 768维 = 7.68亿次计算
高选择性过滤：1万条 × 768维 = 768万次计算
性能提升：7.68亿 / 768万 = 100倍
```

**举例**：
```python
# 多租户场景
expr = "tenant_id == 'A'"  # 过滤掉99%数据
# 性能：从45ms降到5ms（9倍提升）
```

**应用**：为高选择性字段（如tenant_id）创建索引，性能提升最明显。

---

## 卡片4：标量索引的重要性

**一句话**：为高选择性字段创建索引，过滤性能提升2-10倍

**对比**：
```
有索引（tenant_id）：5.67ms
无索引（age）：      12.34ms
加速：2.18倍
```

**举例**：
```python
# 创建标量索引
collection.create_index(
    field_name="tenant_id",
    index_name="tenant_id_index"
)
```

**应用**：为常用过滤字段（tenant_id、year、category）创建索引。

---

## 卡片5：表达式语法速查

**一句话**：Milvus 支持丰富的表达式语法（==, >, <, in, and, or, not）

**常用模式**：
```python
# 相等
expr = "city == 'Beijing'"

# 范围
expr = "age > 18 and age < 60"

# IN
expr = "category in ['tutorial', 'guide', 'documentation']"

# 逻辑组合
expr = "(year == 2024 or year == 2023) and rating >= 4.5"

# NOT
expr = "category not in ['blog', 'paper']"
```

**应用**：使用 IN 代替多个 OR，性能提升15-20%。

---

## 卡片6：常见误区

**一句话**：标量过滤不是越多越好，低选择性过滤反而降低性能

**误区**：
```python
# ❌ 错误：过多低选择性条件
expr = "age > 18 and gender == 'M' and city != 'Beijing'"
# 问题：3个条件，评估成本高，且选择性低

# ✅ 正确：高选择性条件 + 必要的低选择性条件
expr = "tenant_id == 'A' and age > 18"
```

**数据**：
- 高选择性过滤（99%）：性能提升8倍
- 低选择性过滤（5%）：性能下降6%

**应用**：只使用高选择性条件，避免过多低选择性条件。

---

## 卡片7：在 RAG 中的作用

**一句话**：混合检索是 RAG 系统的核心能力，决定了最终答案的质量

**四大价值**：
1. **精准召回**：30% → 90%+
2. **性能优化**：10-100倍
3. **数据安全**：多租户隔离
4. **上下文相关性**：减少幻觉

**举例**：
```python
# RAG 场景：查询"2024年Q1的销售报告"
query_vector = embed("销售报告")
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=5,
    expr="year == 2024 and quarter == 'Q1'"
)
# 结果：只返回2024年Q1的销售报告（精准）
```

**应用**：在 RAG 系统中，混合检索是必备功能，不是可选功能。

---

## 卡片8：性能优化四层面

**一句话**：混合检索性能优化包含索引层、表达式层、架构层、数据层

**四个层面**：
```
1. 索引层：标量索引 + 向量索引
2. 表达式层：高选择性条件前置，使用 IN
3. 架构层：分区 + 标量过滤组合
4. 数据层：维度、量化、分布
```

**性能提升**：
```
基准（无优化）：45ms
+ 标量索引：    12ms（3.75x）
+ 高选择性过滤：5ms（9x）
+ 分区组合：    2ms（22.5x）
```

**应用**：系统化优化，而不是单点优化。

---

## 卡片9：Top-K 的影响

**一句话**：Top-K 越大，性能越差，推荐10-100

**数据**：
```
Top-10:  5.67ms（基准）
Top-50:  6.23ms（+10%）
Top-100: 7.45ms（+31%）
Top-500: 12.89ms（+127%）
```

**举例**：
```python
# ✅ 推荐：10-100
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,  # 合理
    expr="tenant_id == 'A'"
)

# ❌ 不推荐：> 500
limit=1000  # 过大，性能差
```

**应用**：根据实际需求控制 Top-K，不要盲目增大。

---

## 卡片10：最佳实践总结

**一句话**：信任 Milvus 的自动优化，专注于业务逻辑

**最佳实践**：
1. ✅ 为高选择性字段创建索引（tenant_id）
2. ✅ 高选择性条件前置（虽然 Milvus 会自动优化）
3. ✅ 使用 IN 代替多个 OR
4. ✅ 控制 Top-K 大小（10-100）
5. ✅ 在 Milvus 内部执行过滤（不要在应用层）
6. ✅ 组合分区 + 标量过滤（最优性能）
7. ❌ 避免过多低选择性条件
8. ❌ 避免复杂的 NOT
9. ❌ 避免 LIKE（性能差）
10. ❌ 避免在应用层过滤（慢100倍）

**核心原则**：
- 高选择性优先
- 索引加速
- 信任自动优化
- 系统化思考

**应用**：遵循最佳实践，避免常见误区，性能提升10-100倍。

---

## 快速记忆口诀

**混合检索 = 语义 + 精确**
- 向量检索：理解语义（模糊）
- 标量过滤：精确条件（精确）
- 执行策略：自动优化（智能）

**性能优化 = 高选择性 + 索引**
- 高选择性：过滤掉>90%数据
- 标量索引：加速2-10倍
- 分区组合：加速10-50倍

**RAG 应用 = 精准 + 快速 + 安全**
- 精准召回：30% → 90%+
- 性能优化：10-100倍
- 数据安全：多租户隔离

**避坑指南 = 不要在应用层过滤**
- ❌ 应用层过滤：慢100倍
- ❌ 低选择性条件：反而慢
- ❌ 过大 Top-K：性能差

---

## 学习检查清单

### 基础理解
- [ ] 理解混合检索的定义（向量检索 ∩ 标量过滤）
- [ ] 知道两种执行策略（Filter-then-Search vs Search-then-Filter）
- [ ] 理解选择性的概念（过滤后剩余数据比例）
- [ ] 掌握基础表达式语法（==, >, <, in, and, or）

### 性能优化
- [ ] 知道如何创建标量索引
- [ ] 理解高选择性过滤的威力（10-100倍）
- [ ] 掌握表达式优化技巧（IN 代替 OR）
- [ ] 了解 Top-K 对性能的影响

### 实战应用
- [ ] 能在 RAG 系统中使用混合检索
- [ ] 能设计多租户数据隔离方案
- [ ] 能进行性能对比测试
- [ ] 能避免常见误区

### 深入理解
- [ ] 理解执行策略的成本模型
- [ ] 知道 Milvus 的自动优化机制
- [ ] 能进行系统化性能优化
- [ ] 能回答面试问题

---

## 下一步学习

### 如果你是初学者
1. 重点学习：卡片1、2、3、5、7
2. 动手实践：场景1（基础混合检索操作）
3. 理解原理：第一性原理、双重类比

### 如果你是进阶学习者
1. 重点学习：卡片4、6、8、9、10
2. 动手实践：场景3（性能对比测试）、场景4（RAG场景）
3. 深入理解：执行策略、性能优化

### 如果你准备面试
1. 重点学习：全部10个卡片
2. 背诵记忆：快速记忆口诀
3. 准备案例：面试必问中的5个问题

---

## 总结

**混合检索的核心**：
- 本质：向量检索 ∩ 标量过滤
- 策略：自动选择最优执行顺序
- 优化：高选择性 + 索引 + 分区
- 应用：RAG 系统的核心能力

**记住**：混合检索不是可选功能，而是生产级 RAG 系统的必备能力。掌握混合检索，就掌握了 RAG 系统的核心。
