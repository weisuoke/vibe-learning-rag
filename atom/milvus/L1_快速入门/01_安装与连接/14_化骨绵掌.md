# 14_化骨绵掌

> 10个2分钟知识卡片，系统掌握 Milvus 安装与连接

---

## 卡片1：Docker 是 Milvus 部署的最佳选择

**一句话：** Docker 将 Milvus 及其依赖（etcd、MinIO）打包成一个镜像，一行命令即可启动。

**为什么选择 Docker？**
- **环境隔离**：不污染系统环境
- **快速启动**：30秒内完成部署
- **版本管理**：轻松切换不同版本
- **跨平台**：Linux、macOS、Windows 通用

**对比：**
```bash
# 手动安装（复杂）
安装 etcd → 配置 etcd → 安装 MinIO → 配置 MinIO → 安装 Milvus → 配置通信
耗时：2-4小时

# Docker 安装（简单）
docker run -d -p 19530:19530 milvusdb/milvus:latest
耗时：30秒
```

**应用：** 在 RAG 开发中，使用 Docker 可以快速搭建开发环境，避免环境配置问题。

---

## 卡片2：Standalone vs Cluster 的选择标准

**一句话：** Standalone 适合开发和小规模应用，Cluster 适合生产和大规模应用。

**选择标准：**

| 指标 | Standalone | Cluster |
|------|------------|---------|
| 数据量 | < 100万向量 | 亿级向量 |
| QPS | < 1000 | > 10000 |
| 可用性 | 单点故障 | 高可用 |
| 扩展性 | 不支持 | 水平扩展 |
| 资源 | 4GB RAM | 16GB+ RAM |

**决策树：**
```
是否生产环境？
├─ 否 → Standalone
└─ 是 → 数据量 > 1000万？
    ├─ 否 → Standalone
    └─ 是 → Cluster
```

**应用：** RAG 原型开发用 Standalone，生产部署用 Cluster。

---

## 卡片3：pymilvus 连接的三个关键参数

**一句话：** host、port、alias 是连接 Milvus 的三个核心参数。

**参数详解：**
```python
connections.connect(
    alias="default",      # 连接别名（多连接管理）
    host="localhost",     # Milvus 服务器地址
    port="19530"          # gRPC 端口
)
```

**alias 的作用：**
- 管理多个连接（dev、test、prod）
- 在不同连接间切换
- 默认使用 "default"

**常见场景：**
```python
# 场景1：本地开发
connections.connect("dev", host="localhost", port="19530")

# 场景2：远程服务器
connections.connect("prod", host="milvus.prod.com", port="19530")

# 场景3：使用不同连接
Collection("my_collection", using="dev")   # 开发环境
Collection("my_collection", using="prod")  # 生产环境
```

**应用：** 在 RAG 系统中，使用不同 alias 管理多环境连接。

---

## 卡片4：连接池是生产环境的必备组件

**一句话：** 连接池复用连接，避免频繁创建和销毁，提升性能 5-10 倍。

**为什么需要连接池？**
```python
# 无连接池（慢）
for i in range(100):
    connections.connect("default", ...)  # 每次创建新连接
    # 执行操作
    connections.disconnect("default")    # 每次销毁连接
# 耗时：~15秒

# 有连接池（快）
pool = MilvusConnectionPool(size=10)
for i in range(100):
    alias = pool.get_connection()  # 从池中获取
    # 执行操作
    pool.return_connection(alias)  # 归还到池
# 耗时：~2秒
```

**连接池设计：**
- 使用 `queue.Queue` 管理连接
- 线程安全
- 连接验证和自动重建

**应用：** RAG API 服务使用连接池处理并发请求。

---

## 卡片5：健康检查的三个层次

**一句话：** 连接检查、服务检查、业务检查，层层递进确保系统可用。

**三个层次：**

**1. 连接层**
```python
# 检查连接是否存在
connections.has_connection("default")

# 验证连接可用
utility.get_server_version()
```

**2. 服务层**
```python
# Collection 可用性
utility.has_collection("my_collection")

# 索引状态
collection.index().params
```

**3. 业务层**
```python
# 执行测试查询
results = collection.search(test_vector, ...)

# 验证结果正确性
assert len(results) > 0
```

**检查频率：**
- 开发环境：5分钟
- 生产环境：1分钟
- 高可用环境：30秒

**应用：** RAG 服务启动前执行完整健康检查，运行时定期检查服务层。

---

## 卡片6：数据持久化的两种方案

**一句话：** Docker Volumes 和本地目录挂载，前者更简单，后者更灵活。

**方案对比：**

**方案1：Docker Volumes（推荐）**
```bash
docker volume create milvus-data
docker run -d -v milvus-data:/var/lib/milvus milvusdb/milvus:latest
```
- ✅ Docker 管理，自动备份
- ✅ 跨平台兼容
- ❌ 不能直接访问文件

**方案2：本地目录**
```bash
docker run -d -v /data/milvus:/var/lib/milvus milvusdb/milvus:latest
```
- ✅ 直接访问数据文件
- ✅ 便于备份和迁移
- ❌ 需要管理权限

**验证持久化：**
```python
# 1. 插入数据
collection.insert(data)
collection.flush()

# 2. 重启容器
# docker restart milvus-standalone

# 3. 验证数据还在
assert collection.num_entities > 0
```

**应用：** 开发环境用 Volumes，生产环境用本地目录 + 远程备份。

---

## 卡片7：端口映射的原理和配置

**一句话：** 端口映射将容器内部端口暴露到宿主机，实现外部访问。

**映射格式：**
```bash
-p <宿主机端口>:<容器端口>

# 标准映射
-p 19530:19530  # 外部 19530 → 容器 19530

# 自定义映射
-p 8080:19530   # 外部 8080 → 容器 19530
```

**Milvus 的端口：**
- **19530**：gRPC 端口（客户端连接）✅ 必需
- **9091**：Metrics 端口（监控）⚠️ 推荐
- **2379**：etcd 端口（内部使用）❌ 不暴露
- **9000**：MinIO 端口（内部使用）❌ 不暴露

**端口冲突解决：**
```bash
# 检查端口占用
lsof -i :19530

# 使用其他端口
docker run -d -p 19531:19530 milvusdb/milvus:latest

# Python 连接时使用新端口
connections.connect("default", host="localhost", port="19531")
```

**应用：** 在同一台机器上运行多个 Milvus 实例（dev、test）。

---

## 卡片8：docker-compose 的优势

**一句话：** docker-compose 用 YAML 文件管理多容器应用，配置版本化，一键启动。

**优势对比：**

| 特性 | docker run | docker-compose |
|------|------------|----------------|
| 配置方式 | 命令行参数 | YAML 文件 |
| 多容器 | 手动启动 | 一键启动 |
| 版本控制 | ❌ | ✅ |
| 团队协作 | ❌ | ✅ |
| 依赖管理 | 手动 | 自动 |

**基本用法：**
```bash
# 启动所有服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose stop

# 清理资源
docker-compose down -v
```

**应用：** 生产环境使用 docker-compose 管理 Milvus + RAG API + Redis + PostgreSQL。

---

## 卡片9：异常处理和自动重连

**一句话：** 生产环境必须处理连接异常，实现自动重连和降级策略。

**异常处理模式：**
```python
def connect_with_retry(max_retries=3):
    """带重试的连接"""
    for attempt in range(max_retries):
        try:
            connections.connect("default", ...)
            return True
        except Exception as e:
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)  # 指数退避
            else:
                return False
```

**自动重连机制：**
```python
class MilvusConnectionManager:
    def ensure_connection(self):
        """确保连接可用"""
        if not connections.has_connection("default"):
            return self.connect()
        
        # 验证连接
        try:
            utility.get_server_version()
            return True
        except:
            # 重建连接
            connections.disconnect("default")
            return self.connect()
```

**降级策略：**
```python
def search_with_fallback(query):
    """带降级的检索"""
    try:
        return milvus_search(query)
    except:
        # 降级到缓存
        return cache_search(query)
```

**应用：** RAG 服务实现自动重连，确保高可用性。

---

## 卡片10：完整的 RAG 部署流程

**一句话：** 从 Docker 部署到向量检索，7个步骤构建完整的 RAG 系统。

**7步流程：**

```
1. 部署 Milvus
   ↓
2. 创建 Collection
   ↓
3. 加载文档
   ↓
4. 生成 Embeddings
   ↓
5. 插入向量
   ↓
6. 语义检索
   ↓
7. 生成答案
```

**关键代码：**
```python
# 1. 部署
docker run -d -p 19530:19530 milvusdb/milvus:latest

# 2. 创建 Collection
collection = Collection("rag_docs", schema)

# 3-4. 文档 → Embeddings
embeddings = openai.embeddings.create(input=texts, ...)

# 5. 插入向量
collection.insert([texts, embeddings])
collection.create_index("embedding", index_params)
collection.load()

# 6. 检索
results = collection.search(query_embedding, ...)

# 7. 生成答案
answer = openai.chat.completions.create(
    messages=[{"role": "user", "content": f"基于：{context}\n回答：{query}"}]
)
```

**应用：** 这是 RAG 系统的标准流程，掌握后可以快速搭建原型。

---

## 知识卡片总结

| 卡片 | 主题 | 核心要点 |
|------|------|----------|
| 1 | Docker 部署 | 环境隔离、快速启动 |
| 2 | Standalone vs Cluster | 根据数据量和 QPS 选择 |
| 3 | 连接参数 | host、port、alias |
| 4 | 连接池 | 复用连接，提升性能 |
| 5 | 健康检查 | 三个层次：连接、服务、业务 |
| 6 | 数据持久化 | Volumes vs 本地目录 |
| 7 | 端口映射 | 暴露容器端口到宿主机 |
| 8 | docker-compose | YAML 配置，一键启动 |
| 9 | 异常处理 | 重试、重连、降级 |
| 10 | RAG 流程 | 7步构建完整系统 |

---

## 学习路径建议

**第1周：基础掌握**
- 卡片 1-3：Docker 部署和连接管理
- 实践：本地部署 Milvus 并连接

**第2周：进阶理解**
- 卡片 4-6：连接池、健康检查、持久化
- 实践：实现连接池和健康监控

**第3周：生产准备**
- 卡片 7-9：端口映射、docker-compose、异常处理
- 实践：使用 docker-compose 部署完整环境

**第4周：RAG 集成**
- 卡片 10：完整 RAG 流程
- 实践：构建端到端 RAG 系统

---

## 快速参考

**常用命令：**
```bash
# Docker 部署
docker run -d --name milvus -p 19530:19530 milvusdb/milvus:latest

# 查看状态
docker ps | grep milvus

# 查看日志
docker logs -f milvus

# 停止容器
docker stop milvus

# 删除容器
docker rm milvus
```

**常用代码：**
```python
# 连接
from pymilvus import connections
connections.connect("default", host="localhost", port="19530")

# 健康检查
from pymilvus import utility
version = utility.get_server_version()

# 断开连接
connections.disconnect("default")
```

---

**记住：** 这10个知识卡片覆盖了 Milvus 安装与连接的所有核心知识，每天复习一遍，一周内即可熟练掌握！
