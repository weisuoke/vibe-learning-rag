# æ ¸å¿ƒæ¦‚å¿µ 02ï¼šæŠ€èƒ½è°ƒç”¨ä¸åŠ è½½æœºåˆ¶

## æŠ€èƒ½åŠ è½½æµç¨‹

### å®Œæ•´åŠ è½½æµç¨‹å›¾

```
å¯åŠ¨ Agent
    â†“
æ‰«ææŠ€èƒ½ç›®å½•
    â†“
é€’å½’éå†å­ç›®å½•
    â†“
å‘ç° SKILL.md æ–‡ä»¶
    â†“
è¯»å–æ–‡ä»¶å†…å®¹
    â†“
è§£æ YAML frontmatter
    â†“
éªŒè¯ name å’Œ description
    â†“
åˆ›å»º Skill å¯¹è±¡
    â†“
æ³¨å†Œåˆ°æŠ€èƒ½åˆ—è¡¨
    â†“
æ ¼å¼åŒ–ä¸º System Prompt
    â†“
Agent å°±ç»ª
```

### è¯¦ç»†å®ç°åˆ†æ

**æ­¥éª¤ 1ï¼šå¯åŠ¨æ—¶è§¦å‘åŠ è½½**

æ¥è‡ª `resource-loader.ts:150-199`ï¼š

```typescript
export class DefaultResourceLoader implements ResourceLoader {
  private skills: Skill[];
  private skillDiagnostics: ResourceDiagnostic[];
  
  constructor(options: DefaultResourceLoaderOptions) {
    // åˆå§‹åŒ–æ—¶åŠ è½½æŠ€èƒ½
    this.loadResources();
  }
  
  private loadResources(): void {
    // åŠ è½½å…¨å±€æŠ€èƒ½
    const globalSkills = loadSkillsFromDir({
      dir: join(this.agentDir, 'skills'),
      source: 'global'
    });
    
    // åŠ è½½é¡¹ç›®æŠ€èƒ½
    const projectSkills = loadSkillsFromDir({
      dir: join(this.cwd, '.pi', 'skills'),
      source: 'project'
    });
    
    // åˆå¹¶æŠ€èƒ½ï¼ˆé¡¹ç›®æŠ€èƒ½ä¼˜å…ˆï¼‰
    this.skills = [...projectSkills.skills, ...globalSkills.skills];
    this.skillDiagnostics = [
      ...projectSkills.diagnostics,
      ...globalSkills.diagnostics
    ];
  }
}
```

**æ­¥éª¤ 2ï¼šé€’å½’æ‰«æç›®å½•**

æ¥è‡ª `skills.ts:151-230`ï¼š

```typescript
function loadSkillsFromDirInternal(
  dir: string,
  source: string,
  includeRootFiles: boolean,
  ignoreMatcher?: IgnoreMatcher,
  rootDir?: string,
): LoadSkillsResult {
  const skills: Skill[] = [];
  const diagnostics: ResourceDiagnostic[] = [];

  if (!existsSync(dir)) {
    return { skills, diagnostics };
  }

  const root = rootDir ?? dir;
  const ig = ignoreMatcher ?? ignore();
  
  // è¯»å– .gitignore ç­‰å¿½ç•¥è§„åˆ™
  addIgnoreRules(ig, dir, root);

  // åŒæ­¥è¯»å–ç›®å½•
  const entries = readdirSync(dir, { withFileTypes: true });

  for (const entry of entries) {
    // è·³è¿‡éšè—æ–‡ä»¶
    if (entry.name.startsWith(".")) continue;
    
    // è·³è¿‡ node_modules
    if (entry.name === "node_modules") continue;

    const fullPath = join(dir, entry.name);

    // å¤„ç†ç¬¦å·é“¾æ¥
    let isDirectory = entry.isDirectory();
    let isFile = entry.isFile();
    if (entry.isSymbolicLink()) {
      try {
        const stats = statSync(fullPath);
        isDirectory = stats.isDirectory();
        isFile = stats.isFile();
      } catch {
        continue; // è·³è¿‡æ–­å¼€çš„ç¬¦å·é“¾æ¥
      }
    }

    // æ£€æŸ¥å¿½ç•¥è§„åˆ™
    const relPath = toPosixPath(relative(root, fullPath));
    const ignorePath = isDirectory ? `${relPath}/` : relPath;
    if (ig.ignores(ignorePath)) continue;

    // é€’å½’æ‰«æå­ç›®å½•
    if (isDirectory) {
      const subResult = loadSkillsFromDirInternal(
        fullPath, source, false, ig, root
      );
      skills.push(...subResult.skills);
      diagnostics.push(...subResult.diagnostics);
      continue;
    }

    if (!isFile) continue;

    // æ£€æŸ¥æ–‡ä»¶å
    const isRootMd = includeRootFiles && entry.name.endsWith(".md");
    const isSkillMd = !includeRootFiles && entry.name === "SKILL.md";
    if (!isRootMd && !isSkillMd) continue;

    // åŠ è½½æŠ€èƒ½æ–‡ä»¶
    const result = loadSkillFromFile(fullPath, source);
    if (result.skill) {
      skills.push(result.skill);
    }
    diagnostics.push(...result.diagnostics);
  }

  return { skills, diagnostics };
}
```

**å…³é”®ç‰¹æ€§ï¼š**
1. **é€’å½’æ‰«æ** - æ”¯æŒä»»æ„æ·±åº¦çš„å­ç›®å½•
2. **Ignore è§„åˆ™** - å°Šé‡ .gitignore ç­‰å¿½ç•¥æ–‡ä»¶
3. **ç¬¦å·é“¾æ¥æ”¯æŒ** - è‡ªåŠ¨è·Ÿéšç¬¦å·é“¾æ¥
4. **é”™è¯¯å®¹å¿** - å•ä¸ªæ–‡ä»¶å¤±è´¥ä¸å½±å“å…¶ä»–æ–‡ä»¶

**æ­¥éª¤ 3ï¼šè§£æå’ŒéªŒè¯**

æ¥è‡ª `skills.ts:232-280`ï¼š

```typescript
function loadSkillFromFile(
  filePath: string,
  source: string,
): { skill: Skill | null; diagnostics: ResourceDiagnostic[] } {
  const diagnostics: ResourceDiagnostic[] = [];

  try {
    // è¯»å–æ–‡ä»¶å†…å®¹
    const rawContent = readFileSync(filePath, "utf-8");
    
    // è§£æ frontmatter
    const { frontmatter } = parseFrontmatter<SkillFrontmatter>(rawContent);
    
    const skillDir = dirname(filePath);
    const parentDirName = basename(skillDir);

    // éªŒè¯ description
    const descErrors = validateDescription(frontmatter.description);
    for (const error of descErrors) {
      diagnostics.push({ 
        type: "warning", 
        message: error, 
        path: filePath 
      });
    }

    // ä½¿ç”¨ frontmatter ä¸­çš„ nameï¼Œæˆ–å›é€€åˆ°ç›®å½•å
    const name = frontmatter.name || parentDirName;

    // éªŒè¯ name
    const nameErrors = validateName(name, parentDirName);
    for (const error of nameErrors) {
      diagnostics.push({ 
        type: "warning", 
        message: error, 
        path: filePath 
      });
    }

    // å³ä½¿æœ‰è­¦å‘Šä¹ŸåŠ è½½æŠ€èƒ½ï¼ˆé™¤é description å®Œå…¨ç¼ºå¤±ï¼‰
    if (!frontmatter.description || frontmatter.description.trim() === "") {
      return { skill: null, diagnostics };
    }

    return {
      skill: {
        name,
        description: frontmatter.description,
        filePath,
        baseDir: skillDir,
        source,
        disableModelInvocation: 
          frontmatter["disable-model-invocation"] === true,
      },
      diagnostics,
    };
  } catch (error) {
    const message = error instanceof Error 
      ? error.message 
      : "failed to parse skill file";
    diagnostics.push({ 
      type: "warning", 
      message, 
      path: filePath 
    });
    return { skill: null, diagnostics };
  }
}
```

**éªŒè¯è§„åˆ™ï¼š**
1. **name éªŒè¯** - å¿…é¡»ä¸ç›®å½•ååŒ¹é…ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦
2. **description éªŒè¯** - å¿…éœ€å­—æ®µï¼Œæœ€å¤š 1024 å­—ç¬¦
3. **å®¹é”™å¤„ç†** - å³ä½¿æœ‰è­¦å‘Šä¹Ÿå°è¯•åŠ è½½æŠ€èƒ½

**æ­¥éª¤ 4ï¼šæ³¨å†Œåˆ°æŠ€èƒ½åˆ—è¡¨**

```typescript
// æŠ€èƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­
private skills: Skill[] = [];

// åŠ è½½åæ³¨å†Œ
this.skills = [...projectSkills.skills, ...globalSkills.skills];
```

**ä¼˜å…ˆçº§è§„åˆ™ï¼š**
- é¡¹ç›®æŠ€èƒ½ä¼˜å…ˆäºå…¨å±€æŠ€èƒ½
- åŒåæŠ€èƒ½ï¼Œé¡¹ç›®æŠ€èƒ½è¦†ç›–å…¨å±€æŠ€èƒ½

---

## æŠ€èƒ½è°ƒç”¨æœºåˆ¶

### è°ƒç”¨æµç¨‹

```
ç”¨æˆ·è¾“å…¥: /skill:code-review src/app.ts
    â†“
è§£æå‘½ä»¤
    â†“
æå–æŠ€èƒ½åç§°: code-review
æå–å‚æ•°: src/app.ts
    â†“
æŸ¥æ‰¾æŠ€èƒ½
    â†“
è¯»å– SKILL.md æ–‡ä»¶
    â†“
å»é™¤ frontmatter
    â†“
å±•å¼€ä¸º XML å—
    â†“
æ‹¼æ¥å‚æ•°
    â†“
æ³¨å…¥åˆ° LLM ä¸Šä¸‹æ–‡
    â†“
LLM å¤„ç†å¹¶ç”Ÿæˆå“åº”
```

### è¯¦ç»†å®ç°åˆ†æ

**æ­¥éª¤ 1ï¼šå‘½ä»¤è§£æ**

æ¥è‡ª `agent-session.ts:883-907`ï¼š

```typescript
private _expandSkillCommand(text: string): string {
  // æ£€æŸ¥æ˜¯å¦ä¸ºæŠ€èƒ½å‘½ä»¤
  if (!text.startsWith("/skill:")) return text;

  // è§£ææŠ€èƒ½åç§°å’Œå‚æ•°
  const spaceIndex = text.indexOf(" ");
  const skillName = spaceIndex === -1 
    ? text.slice(7) 
    : text.slice(7, spaceIndex);
  const args = spaceIndex === -1 
    ? "" 
    : text.slice(spaceIndex + 1).trim();

  // æŸ¥æ‰¾æŠ€èƒ½
  const skill = this.resourceLoader
    .getSkills()
    .skills
    .find((s) => s.name === skillName);
    
  if (!skill) return text; // æ‰¾ä¸åˆ°æŠ€èƒ½ï¼Œè¿”å›åŸæ–‡æœ¬

  try {
    // è¯»å–æ–‡ä»¶å†…å®¹
    const content = readFileSync(skill.filePath, 'utf-8');
    const body = stripFrontmatter(content).trim();

    // å±•å¼€ä¸º XML å—
    const skillBlock = `<skill name="${skill.name}" location="${skill.filePath}">
References are relative to ${skill.baseDir}.

${body}
</skill>`;

    // æ‹¼æ¥å‚æ•°
    return args ? `${skillBlock}\n\n${args}` : skillBlock;
  } catch (err) {
    // é”™è¯¯å¤„ç†
    this._extensionRunner?.emitError({
      extensionPath: skill.filePath,
      event: "skill_expansion",
      error: err instanceof Error ? err.message : String(err),
    });
    return text;
  }
}
```

**å…³é”®ç‚¹ï¼š**
1. **æ–‡æœ¬å±•å¼€** - ä¸æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæ˜¯æ–‡æœ¬æ›¿æ¢
2. **XML æ ¼å¼** - ä½¿ç”¨ XML å—åŒ…è£…æŠ€èƒ½å†…å®¹
3. **å‚æ•°æ‹¼æ¥** - å‚æ•°ä½œä¸ºè‡ªç”±æ–‡æœ¬æ‹¼æ¥åœ¨åé¢
4. **é”™è¯¯å¤„ç†** - å¤±è´¥æ—¶è¿”å›åŸæ–‡æœ¬

**æ­¥éª¤ 2ï¼šæŠ€èƒ½å±•å¼€ç¤ºä¾‹**

```bash
# è¾“å…¥
/skill:code-review src/app.ts

# å±•å¼€ä¸º
<skill name="code-review" location="~/.pi/agent/skills/code-review/SKILL.md">
References are relative to ~/.pi/agent/skills/code-review.

You are an expert code reviewer with 10+ years of experience.

## Review Process
1. Understand the context
2. Analyze security
3. Review performance
4. Assess code quality

## Output Format
### âœ… Strengths
### âš ï¸ Issues
### ğŸ’¡ Suggestions
</skill>

src/app.ts
```

**æ­¥éª¤ 3ï¼šæ³¨å…¥åˆ° LLM ä¸Šä¸‹æ–‡**

å±•å¼€åçš„æ–‡æœ¬ä¼šè¢«æ·»åŠ åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­ï¼Œå‘é€ç»™ LLMï¼š

```typescript
// ç”¨æˆ·æ¶ˆæ¯
const userMessage = {
  role: "user",
  content: expandedSkillText
};

// å‘é€ç»™ LLM
const response = await llm.generate([
  systemPrompt,
  ...conversationHistory,
  userMessage
]);
```

---

## System Prompt é›†æˆ

### é›†æˆæœºåˆ¶

**æŠ€èƒ½å¦‚ä½•å‡ºç°åœ¨ System Prompt ä¸­ï¼š**

æ¥è‡ª `skills.ts:290-316`ï¼š

```typescript
export function formatSkillsForPrompt(skills: Skill[]): string {
  // è¿‡æ»¤æ‰ disableModelInvocation=true çš„æŠ€èƒ½
  const visibleSkills = skills.filter((s) => !s.disableModelInvocation);

  if (visibleSkills.length === 0) {
    return "";
  }

  const lines = [
    "\n\nThe following skills provide specialized instructions for specific tasks.",
    "Use the read tool to load a skill's file when the task matches its description.",
    "When a skill file references a relative path, resolve it against the skill directory (parent of SKILL.md / dirname of the path) and use that absolute path in tool commands.",
    "",
    "<available_skills>",
  ];

  for (const skill of visibleSkills) {
    lines.push("  <skill>");
    lines.push(`    <name>${escapeXml(skill.name)}</name>`);
    lines.push(`    <description>${escapeXml(skill.description)}</description>`);
    lines.push(`    <location>${escapeXml(skill.filePath)}</location>`);
    lines.push("  </skill>");
  }

  lines.push("</available_skills>");

  return lines.join("\n");
}
```

**System Prompt ç¤ºä¾‹ï¼š**

```xml
The following skills provide specialized instructions for specific tasks.
Use the read tool to load a skill's file when the task matches its description.

<available_skills>
  <skill>
    <name>code-review</name>
    <description>Review code for quality, security, and performance issues</description>
    <location>/Users/user/.pi/agent/skills/code-review/SKILL.md</location>
  </skill>
  <skill>
    <name>test-generation</name>
    <description>Generate unit tests for TypeScript functions</description>
    <location>/Users/user/.pi/agent/skills/test-generation/SKILL.md</location>
  </skill>
  <skill>
    <name>debugging</name>
    <description>Debug issues systematically using structured approach</description>
    <location>/Users/user/.pi/agent/skills/debugging/SKILL.md</location>
  </skill>
</available_skills>
```

**LLM å¦‚ä½•ä½¿ç”¨æŠ€èƒ½ï¼š**

1. **è‡ªåŠ¨è¯†åˆ«** - LLM çœ‹åˆ° System Prompt ä¸­çš„æŠ€èƒ½åˆ—è¡¨
2. **åŒ¹é…ä»»åŠ¡** - å½“ç”¨æˆ·ä»»åŠ¡åŒ¹é…æŠ€èƒ½æè¿°æ—¶
3. **ä¸»åŠ¨è°ƒç”¨** - LLM å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ Read å·¥å…·è¯»å–æŠ€èƒ½æ–‡ä»¶
4. **æ‰§è¡Œé€»è¾‘** - æŒ‰ç…§æŠ€èƒ½æ–‡ä»¶ä¸­çš„æŒ‡ä»¤æ‰§è¡Œ

**disable-model-invocation çš„ä½œç”¨ï¼š**

```yaml
# æŠ€èƒ½ä¸ä¼šå‡ºç°åœ¨ System Prompt ä¸­
---
name: dangerous-operation
description: Perform dangerous system operations
disable-model-invocation: true
---

# åªèƒ½é€šè¿‡ /skill:dangerous-operation æ˜¾å¼è°ƒç”¨
```

---

## Resource Loader æ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
DefaultResourceLoader
    â†“
â”œâ”€â”€ Skills (æŠ€èƒ½)
â”œâ”€â”€ Prompt Templates (æç¤ºè¯æ¨¡æ¿)
â”œâ”€â”€ Extensions (æ‰©å±•)
â”œâ”€â”€ Themes (ä¸»é¢˜)
â””â”€â”€ System Prompt (ç³»ç»Ÿæç¤ºè¯)
```

### æ ¸å¿ƒæ¥å£

æ¥è‡ª `resource-loader.ts:114-148`ï¼š

```typescript
export interface DefaultResourceLoaderOptions {
  cwd?: string;                          // å·¥ä½œç›®å½•
  agentDir?: string;                     // Agent ç›®å½•
  settingsManager?: SettingsManager;     // è®¾ç½®ç®¡ç†å™¨
  eventBus?: EventBus;                   // äº‹ä»¶æ€»çº¿
  
  // é¢å¤–è·¯å¾„
  additionalSkillPaths?: string[];       // é¢å¤–æŠ€èƒ½è·¯å¾„
  additionalPromptTemplatePaths?: string[];
  additionalExtensionPaths?: string[];
  additionalThemePaths?: string[];
  
  // ç¦ç”¨é€‰é¡¹
  noSkills?: boolean;                    // ç¦ç”¨æŠ€èƒ½
  noPromptTemplates?: boolean;
  noExtensions?: boolean;
  noThemes?: boolean;
  
  // è¦†ç›–é’©å­
  skillsOverride?: (base: LoadSkillsResult) => LoadSkillsResult;
  promptsOverride?: (base: LoadPromptsResult) => LoadPromptsResult;
  extensionsOverride?: (base: LoadExtensionsResult) => LoadExtensionsResult;
}
```

### åŠ è½½é¡ºåº

```typescript
export class DefaultResourceLoader implements ResourceLoader {
  constructor(options: DefaultResourceLoaderOptions) {
    // 1. åŠ è½½æ‰©å±•
    this.extensionsResult = this.loadExtensions();
    
    // 2. åŠ è½½æŠ€èƒ½
    const skillsResult = this.loadSkills();
    this.skills = skillsResult.skills;
    this.skillDiagnostics = skillsResult.diagnostics;
    
    // 3. åŠ è½½æç¤ºè¯æ¨¡æ¿
    const promptsResult = this.loadPrompts();
    this.prompts = promptsResult.prompts;
    this.promptDiagnostics = promptsResult.diagnostics;
    
    // 4. åŠ è½½ä¸»é¢˜
    const themesResult = this.loadThemes();
    this.themes = themesResult.themes;
    this.themeDiagnostics = themesResult.diagnostics;
    
    // 5. åŠ è½½ç³»ç»Ÿæç¤ºè¯
    this.systemPrompt = this.loadSystemPrompt();
    this.appendSystemPrompt = this.loadAppendSystemPrompt();
  }
  
  private loadSkills(): LoadSkillsResult {
    if (this.noSkills) {
      return { skills: [], diagnostics: [] };
    }
    
    const results: LoadSkillsResult[] = [];
    
    // åŠ è½½å…¨å±€æŠ€èƒ½
    results.push(loadSkillsFromDir({
      dir: join(this.agentDir, 'skills'),
      source: 'global'
    }));
    
    // åŠ è½½é¡¹ç›®æŠ€èƒ½
    results.push(loadSkillsFromDir({
      dir: join(this.cwd, '.pi', 'skills'),
      source: 'project'
    }));
    
    // åŠ è½½é¢å¤–è·¯å¾„çš„æŠ€èƒ½
    for (const path of this.additionalSkillPaths) {
      results.push(loadSkillsFromDir({
        dir: path,
        source: 'additional'
      }));
    }
    
    // åˆå¹¶ç»“æœ
    const skills = results.flatMap(r => r.skills);
    const diagnostics = results.flatMap(r => r.diagnostics);
    
    // åº”ç”¨è¦†ç›–é’©å­
    if (this.skillsOverride) {
      return this.skillsOverride({ skills, diagnostics });
    }
    
    return { skills, diagnostics };
  }
}
```

### å¤šæºåŠ è½½ç­–ç•¥

**åŠ è½½é¡ºåºï¼š**
1. å…¨å±€æŠ€èƒ½ï¼š`~/.pi/agent/skills/`
2. é¡¹ç›®æŠ€èƒ½ï¼š`./.pi/skills/`
3. é¢å¤–è·¯å¾„ï¼šé€šè¿‡é…ç½®æŒ‡å®š

**ä¼˜å…ˆçº§è§„åˆ™ï¼š**
- ååŠ è½½çš„æŠ€èƒ½ä¼˜å…ˆ
- é¡¹ç›®æŠ€èƒ½è¦†ç›–å…¨å±€æŠ€èƒ½
- é¢å¤–è·¯å¾„æŠ€èƒ½ä¼˜å…ˆçº§æœ€é«˜

**å»é‡ç­–ç•¥ï¼š**
```typescript
// æŒ‰åç§°å»é‡ï¼Œä¿ç•™æœ€åä¸€ä¸ª
const uniqueSkills = skills.reduce((acc, skill) => {
  acc.set(skill.name, skill);
  return acc;
}, new Map<string, Skill>());

return Array.from(uniqueSkills.values());
```

---

## Extension API é›†æˆ

### æ‰©å±•å¦‚ä½•æä¾›æŠ€èƒ½

æ¥è‡ª `extensions/types.ts:200-220`ï¼š

```typescript
export interface ResourcesDiscoverEvent {
  type: 'resources_discover';
  cwd: string;
  agentDir: string;
}

export interface ResourcesDiscoverResult {
  skills?: Skill[];
  promptTemplates?: PromptTemplate[];
  themes?: Theme[];
}

// æ‰©å±•å¯ä»¥é€šè¿‡äº‹ä»¶æä¾›æŠ€èƒ½
extension.on('resources_discover', (event: ResourcesDiscoverEvent) => {
  return {
    skills: [
      {
        name: 'my-extension-skill',
        description: 'Skill provided by extension',
        filePath: '/path/to/skill/SKILL.md',
        baseDir: '/path/to/skill',
        source: 'extension',
        disableModelInvocation: false
      }
    ]
  };
});
```

### æ‰©å±•æŠ€èƒ½åŠ è½½æµç¨‹

```typescript
// 1. è§¦å‘ resources_discover äº‹ä»¶
const results = await this.extensionRunner.emit('resources_discover', {
  type: 'resources_discover',
  cwd: this.cwd,
  agentDir: this.agentDir
});

// 2. æ”¶é›†æ‰©å±•æä¾›çš„æŠ€èƒ½
const extensionSkills: Skill[] = [];
for (const result of results) {
  if (result.skills) {
    extensionSkills.push(...result.skills);
  }
}

// 3. åˆå¹¶åˆ°æŠ€èƒ½åˆ—è¡¨
this.skills = [
  ...fileSystemSkills,
  ...extensionSkills
];
```

### æ‰©å±•æŠ€èƒ½ç¤ºä¾‹

```typescript
// my-extension/index.ts
export function activate(context: ExtensionContext) {
  context.on('resources_discover', () => {
    return {
      skills: [
        {
          name: 'ai-commit',
          description: 'Generate AI-powered commit messages',
          filePath: join(__dirname, 'skills', 'ai-commit', 'SKILL.md'),
          baseDir: join(__dirname, 'skills', 'ai-commit'),
          source: 'extension:my-extension',
          disableModelInvocation: false
        }
      ]
    };
  });
}
```

---

## çƒ­é‡è½½æœºåˆ¶

### å½“å‰å®ç°

**Pi-mono ç›®å‰ä¸æ”¯æŒçƒ­é‡è½½ï¼š**
- æŠ€èƒ½åœ¨å¯åŠ¨æ—¶ä¸€æ¬¡æ€§åŠ è½½
- ä¿®æ”¹æŠ€èƒ½æ–‡ä»¶éœ€è¦é‡å¯ Agent
- æ·»åŠ æ–°æŠ€èƒ½éœ€è¦é‡å¯ Agent

### ä¸ºä»€ä¹ˆä¸æ”¯æŒçƒ­é‡è½½ï¼Ÿ

**è®¾è®¡è€ƒè™‘ï¼š**
1. **ç®€å•æ€§** - é¿å…æ–‡ä»¶ç›‘å¬çš„å¤æ‚æ€§
2. **ä¸€è‡´æ€§** - ç¡®ä¿ä¼šè¯æœŸé—´æŠ€èƒ½åˆ—è¡¨ç¨³å®š
3. **æ€§èƒ½** - é¿å…è¿è¡Œæ—¶çš„æ–‡ä»¶ç³»ç»Ÿ I/O
4. **ä½¿ç”¨åœºæ™¯** - Agent ä¼šè¯é€šå¸¸è¾ƒçŸ­ï¼Œé‡å¯æˆæœ¬ä½

### å®ç°çƒ­é‡è½½çš„æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ–‡ä»¶ç›‘å¬**

```typescript
import { watch } from 'fs';

class HotReloadableResourceLoader extends DefaultResourceLoader {
  private watcher: FSWatcher;
  
  constructor(options: DefaultResourceLoaderOptions) {
    super(options);
    this.setupWatcher();
  }
  
  private setupWatcher(): void {
    const skillDirs = [
      join(this.agentDir, 'skills'),
      join(this.cwd, '.pi', 'skills')
    ];
    
    for (const dir of skillDirs) {
      this.watcher = watch(dir, { recursive: true }, (event, filename) => {
        if (filename && filename.endsWith('SKILL.md')) {
          this.reloadSkills();
        }
      });
    }
  }
  
  private reloadSkills(): void {
    const skillsResult = this.loadSkills();
    this.skills = skillsResult.skills;
    this.skillDiagnostics = skillsResult.diagnostics;
    
    // è§¦å‘äº‹ä»¶é€šçŸ¥ Agent
    this.eventBus.emit('skills_reloaded', {
      skills: this.skills
    });
  }
}
```

**æ–¹æ¡ˆ 2ï¼šæ‰‹åŠ¨é‡è½½å‘½ä»¤**

```typescript
// æ·»åŠ  /reload-skills å‘½ä»¤
if (text === '/reload-skills') {
  this.resourceLoader.reloadSkills();
  return 'Skills reloaded successfully';
}
```

**æ–¹æ¡ˆ 3ï¼šå®šæœŸè½®è¯¢**

```typescript
setInterval(() => {
  const currentSkills = this.loadSkills();
  if (hasChanged(currentSkills, this.skills)) {
    this.skills = currentSkills.skills;
    this.eventBus.emit('skills_reloaded');
  }
}, 5000); // æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡
```

### çƒ­é‡è½½çš„æŒ‘æˆ˜

**æŒ‘æˆ˜ 1ï¼šçŠ¶æ€ç®¡ç†**
- æŠ€èƒ½é‡è½½åï¼Œæ­£åœ¨è¿›è¡Œçš„ä¼šè¯å¦‚ä½•å¤„ç†ï¼Ÿ
- System Prompt æ˜¯å¦éœ€è¦æ›´æ–°ï¼Ÿ
- å·²å±•å¼€çš„æŠ€èƒ½æ˜¯å¦éœ€è¦é‡æ–°å±•å¼€ï¼Ÿ

**æŒ‘æˆ˜ 2ï¼šæ€§èƒ½å½±å“**
- æ–‡ä»¶ç›‘å¬çš„æ€§èƒ½å¼€é”€
- é¢‘ç¹é‡è½½çš„å½±å“
- å¤§é‡æŠ€èƒ½æ—¶çš„æ‰«ææˆæœ¬

**æŒ‘æˆ˜ 3ï¼šä¸€è‡´æ€§ä¿è¯**
- å¦‚ä½•ç¡®ä¿æŠ€èƒ½åˆ—è¡¨çš„ä¸€è‡´æ€§ï¼Ÿ
- å¦‚ä½•å¤„ç†æŠ€èƒ½åˆ é™¤çš„æƒ…å†µï¼Ÿ
- å¦‚ä½•å¤„ç†æŠ€èƒ½é‡å‘½åçš„æƒ…å†µï¼Ÿ

---

## æ€»ç»“

**æŠ€èƒ½åŠ è½½æœºåˆ¶ï¼š**
1. **å¯åŠ¨æ—¶åŠ è½½** - ä¸€æ¬¡æ€§æ‰«ææ‰€æœ‰æŠ€èƒ½ç›®å½•
2. **é€’å½’æ‰«æ** - æ”¯æŒä»»æ„æ·±åº¦çš„å­ç›®å½•
3. **éªŒè¯æœºåˆ¶** - ä¸¥æ ¼éªŒè¯ name å’Œ description
4. **å¤šæºæ”¯æŒ** - å…¨å±€ + é¡¹ç›® + æ‰©å±•
5. **ä¼˜å…ˆçº§è§„åˆ™** - é¡¹ç›®æŠ€èƒ½è¦†ç›–å…¨å±€æŠ€èƒ½

**æŠ€èƒ½è°ƒç”¨æœºåˆ¶ï¼š**
1. **æ–‡æœ¬å±•å¼€** - ä¸æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæ˜¯æ–‡æœ¬æ›¿æ¢
2. **XML æ ¼å¼** - ä½¿ç”¨ XML å—åŒ…è£…æŠ€èƒ½å†…å®¹
3. **å‚æ•°æ‹¼æ¥** - å‚æ•°ä½œä¸ºè‡ªç”±æ–‡æœ¬æ‹¼æ¥
4. **LLM å¤„ç†** - æœ€ç»ˆç”± LLM ç†è§£å’Œæ‰§è¡Œ

**System Prompt é›†æˆï¼š**
1. **è‡ªåŠ¨æ³¨å…¥** - æŠ€èƒ½åˆ—è¡¨è‡ªåŠ¨æ·»åŠ åˆ° System Prompt
2. **LLM å¯è§** - LLM å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¯ç”¨æŠ€èƒ½
3. **ä¸»åŠ¨è°ƒç”¨** - LLM å¯ä»¥ä¸»åŠ¨ä½¿ç”¨æŠ€èƒ½
4. **ç¦ç”¨é€‰é¡¹** - disable-model-invocation æ§åˆ¶å¯è§æ€§

**Resource Loader æ¶æ„ï¼š**
1. **ç»Ÿä¸€ç®¡ç†** - ç»Ÿä¸€ç®¡ç†æŠ€èƒ½ã€æ¨¡æ¿ã€æ‰©å±•ç­‰èµ„æº
2. **å¤šæºåŠ è½½** - æ”¯æŒå¤šä¸ªæ¥æºçš„èµ„æº
3. **æ‰©å±•é›†æˆ** - æ‰©å±•å¯ä»¥æä¾›æŠ€èƒ½
4. **è¦†ç›–é’©å­** - æ”¯æŒè‡ªå®šä¹‰åŠ è½½é€»è¾‘

**çƒ­é‡è½½ï¼š**
1. **å½“å‰ä¸æ”¯æŒ** - éœ€è¦é‡å¯ Agent
2. **è®¾è®¡è€ƒè™‘** - ç®€å•æ€§ã€ä¸€è‡´æ€§ã€æ€§èƒ½
3. **å®ç°æ–¹æ¡ˆ** - æ–‡ä»¶ç›‘å¬ã€æ‰‹åŠ¨é‡è½½ã€å®šæœŸè½®è¯¢
4. **æŒ‘æˆ˜** - çŠ¶æ€ç®¡ç†ã€æ€§èƒ½å½±å“ã€ä¸€è‡´æ€§ä¿è¯

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-20
**ç»´æŠ¤è€…ï¼š** Claude Code
