# 最小可用知识

> 掌握以下内容，就能开始使用相似度度量

---

## 核心知识点

### 6.1 三种度量的快速理解

**一句话记忆：**
- **L2距离**：测量两点间的直线距离（越小越相似）
- **内积IP**：测量方向一致性×幅度（越大越相似）
- **余弦相似度COSINE**：测量纯方向一致性（越大越相似）

**代码示例：**
```python
import numpy as np

# 两个向量
x = np.array([1.0, 2.0, 3.0])
y = np.array([2.0, 3.0, 4.0])

# L2距离
l2 = np.linalg.norm(x - y)
print(f"L2距离: {l2:.4f}")  # 1.7321（越小越相似）

# 内积IP
ip = np.dot(x, y)
print(f"内积IP: {ip:.4f}")  # 20.0000（越大越相似）

# 余弦相似度COSINE
cosine = np.dot(x, y) / (np.linalg.norm(x) * np.linalg.norm(y))
print(f"余弦相似度: {cosine:.4f}")  # 0.9746（越大越相似）
```

---

### 6.2 选择度量的决策树

```
你的Embedding模型是否归一化？
├─ 是（‖x‖ = 1）
│   └─ 使用 COSINE 或 IP（等价，IP更快）
│
└─ 否（‖x‖ ≠ 1）
    └─ 根据业务场景
        ├─ 语义搜索 → COSINE（只关注方向）
        ├─ 推荐系统 → IP（考虑方向+幅度）
        └─ 物理距离 → L2（空间距离概念）
```

**快速判断：**
```python
# 检查向量是否归一化
embedding = model.encode("hello world")
norm = np.linalg.norm(embedding)

if abs(norm - 1.0) < 0.01:
    print("向量已归一化，推荐使用 COSINE 或 IP")
else:
    print("向量未归一化，根据场景选择")
```

---

### 6.3 在Milvus中配置度量

**创建索引时指定：**
```python
from pymilvus import Collection

collection = Collection("my_collection")

# 创建索引，指定度量方式
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "COSINE",  # 或 "L2", "IP"
    "params": {"nlist": 128}
}

collection.create_index(
    field_name="embedding",
    index_params=index_params
)
```

**搜索时使用相同度量：**
```python
# 搜索参数必须与索引一致
search_params = {
    "metric_type": "COSINE",  # 与索引保持一致
    "params": {"nprobe": 10}
}

results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param=search_params,
    limit=10
)
```

**⚠️ 重要：** 搜索时的metric_type必须与创建索引时一致！

---

### 6.4 常见Embedding模型的推荐度量

| Embedding模型 | 是否归一化 | 推荐度量 |
|--------------|-----------|---------|
| OpenAI text-embedding-3 | ✅ 是 | COSINE |
| sentence-transformers | ✅ 通常是 | COSINE |
| BGE系列 | ✅ 是 | COSINE |
| Word2Vec | ❌ 否 | L2 或 COSINE |
| BERT (原始) | ❌ 否 | COSINE |

**默认建议：** 如果不确定，优先选择 **COSINE**，适用于90%的场景。

---

### 6.5 归一化技巧（性能优化）

**如果向量已归一化，IP = COSINE，但IP更快：**

```python
# 方案1：直接用COSINE（简单）
index_params = {"metric_type": "COSINE", ...}

# 方案2：归一化 + IP（更快10-20%）
# 步骤1：插入前归一化向量
def normalize(vector):
    return vector / np.linalg.norm(vector)

embeddings = [normalize(emb) for emb in raw_embeddings]

# 步骤2：使用IP度量
index_params = {"metric_type": "IP", ...}

# 结果：IP(x, y) = COSINE(x, y)（当向量归一化时）
```

---

### 6.6 调试度量选择错误

**问题：检索结果不准确**

**检查清单：**
```python
# 1. 检查向量是否归一化
norm = np.linalg.norm(embedding)
print(f"向量范数: {norm:.4f}")
# 如果接近1.0 → 已归一化
# 如果不是1.0 → 未归一化

# 2. 检查度量方式是否匹配
# 归一化向量 → 用COSINE或IP
# 未归一化向量 → 根据场景选择

# 3. 验证搜索参数与索引一致
# 索引：metric_type="COSINE"
# 搜索：metric_type="COSINE"（必须一致）

# 4. 手动计算验证
query = np.array([0.1, 0.2, 0.3])
result_vec = np.array([0.15, 0.25, 0.35])

# 计算三种度量
l2 = np.linalg.norm(query - result_vec)
ip = np.dot(query, result_vec)
cosine = ip / (np.linalg.norm(query) * np.linalg.norm(result_vec))

print(f"L2={l2:.4f}, IP={ip:.4f}, COSINE={cosine:.4f}")
# 检查哪个度量的排序符合预期
```

---

## 这些知识足以

掌握以上6个核心知识点，你就能：

✅ **选择合适的度量方式**
- 根据Embedding模型特性选择
- 根据业务场景选择
- 理解归一化的影响

✅ **在Milvus中正确配置**
- 创建索引时指定度量
- 搜索时使用一致的度量
- 避免常见配置错误

✅ **调试度量问题**
- 检查向量归一化状态
- 验证度量选择是否合理
- 手动计算验证结果

✅ **优化性能**
- 使用归一化+IP优化COSINE
- 理解不同度量的性能差异

✅ **为后续学习打基础**
- 理解三种度量的本质区别
- 掌握度量选择的决策逻辑
- 具备实际应用能力

---

## 快速参考卡

### 度量选择速查

```
场景：语义搜索（文档检索、问答系统）
推荐：COSINE
原因：只关注语义方向，不关注幅度

场景：推荐系统（商品推荐、内容推荐）
推荐：IP
原因：需要考虑热度、强度等幅度信息

场景：图像检索（相似图片搜索）
推荐：L2 或 COSINE
原因：取决于特征提取方式

场景：不确定
推荐：COSINE
原因：适用于90%的场景，最安全的选择
```

### Milvus配置模板

```python
# 模板1：COSINE度量（最常用）
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "COSINE",
    "params": {"nlist": 128}
}

# 模板2：IP度量（归一化向量，性能优化）
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "IP",
    "params": {"nlist": 128}
}

# 模板3：L2度量（未归一化向量）
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "L2",
    "params": {"nlist": 128}
}
```

---

## 下一步学习

**深入理解：**
- [03_核心概念_L2距离.md](./03_核心概念_L2距离.md) - L2距离的数学原理
- [04_核心概念_内积IP.md](./04_核心概念_内积IP.md) - 内积的几何意义
- [05_核心概念_余弦相似度COSINE.md](./05_核心概念_余弦相似度COSINE.md) - 余弦相似度详解

**实战练习：**
- [09_实战代码_场景1_L2距离实战.md](./09_实战代码_场景1_L2距离实战.md)
- [10_实战代码_场景2_内积IP实战.md](./10_实战代码_场景2_内积IP实战.md)
- [11_实战代码_场景3_余弦相似度实战.md](./11_实战代码_场景3_余弦相似度实战.md)

**对比分析：**
- [12_实战代码_场景4_度量选型对比.md](./12_实战代码_场景4_度量选型对比.md)

---

**记住：** 20%的核心知识解决80%的问题，这6个知识点就是那20%！
