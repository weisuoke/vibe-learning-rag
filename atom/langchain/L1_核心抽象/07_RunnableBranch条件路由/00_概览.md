# RunnableBranch条件路由 - 完整学习指南

欢迎学习 RunnableBranch！本文档提供完整的导航和学习路径。

---

## 📚 文档导航

| 文件 | 主题 | 难度 | 预计时间 |
|------|------|------|----------|
| **01_30字核心.md** | 快速理解核心概念 | ⭐ | 2分钟 |
| **02_第一性原理.md** | 从根本理解为什么需要 | ⭐⭐⭐ | 15分钟 |
| **03_核心概念_01_条件路由基础.md** | 类定义、参数、基础用法 | ⭐⭐ | 20分钟 |
| **03_核心概念_02_分支条件设计.md** | 条件函数设计与优化 | ⭐⭐⭐ | 20分钟 |
| **03_核心概念_03_路由执行流程.md** | 执行机制、生命周期 | ⭐⭐⭐ | 20分钟 |
| **03_核心概念_04_与其他路由对比.md** | 对比分析、选择标准 | ⭐⭐⭐⭐ | 25分钟 |
| **04_最小可用.md** | 20%核心知识快速上手 | ⭐⭐ | 10分钟 |
| **05_双重类比.md** | 前端+日常生活类比 | ⭐ | 15分钟 |
| **06_反直觉点.md** | 3个常见误区 | ⭐⭐ | 10分钟 |
| **07_实战代码_01_基础条件路由.md** | 7个基础示例 | ⭐⭐ | 30分钟 |
| **07_实战代码_02_复杂分支场景.md** | 8个高级示例 | ⭐⭐⭐ | 40分钟 |
| **07_实战代码_03_性能优化与生产实践.md** | 生产环境最佳实践 | ⭐⭐⭐⭐ | 40分钟 |
| **08_面试必问.md** | 2个高频面试问题 | ⭐⭐⭐ | 10分钟 |
| **09_化骨绵掌.md** | 10个2分钟知识卡片 | ⭐-⭐⭐⭐⭐ | 20分钟 |
| **10_一句话总结.md** | 完整总结与检查清单 | ⭐ | 5分钟 |

**总计**：约 4-5 小时完整学习

---

## 🎯 学习路径

### 路径1：快速入门（30分钟）

**目标**：快速理解 RunnableBranch 并能写出基础代码

**学习顺序**：
1. **01_30字核心.md** - 2分钟理解是什么
2. **05_双重类比.md** - 15分钟通过类比理解
3. **04_最小可用.md** - 10分钟掌握核心用法
4. **07_实战代码_01_基础条件路由.md** - 选2-3个示例运行

**学习成果**：
- ✅ 理解 RunnableBranch 的核心概念
- ✅ 能够创建简单的条件路由
- ✅ 知道如何与 LCEL 组合

---

### 路径2：系统学习（3小时）

**目标**：全面掌握 RunnableBranch 的原理和应用

**学习顺序**：
1. **01_30字核心.md** - 快速概览
2. **02_第一性原理.md** - 深入理解本质
3. **03_核心概念_01_条件路由基础.md** - 基础知识
4. **03_核心概念_02_分支条件设计.md** - 条件设计
5. **03_核心概念_03_路由执行流程.md** - 执行机制
6. **03_核心概念_04_与其他路由对比.md** - 对比分析
7. **06_反直觉点.md** - 避免常见误区
8. **07_实战代码_01_基础条件路由.md** - 基础实战
9. **07_实战代码_02_复杂分支场景.md** - 高级实战
10. **10_一句话总结.md** - 总结回顾

**学习成果**：
- ✅ 深入理解 RunnableBranch 的设计原理
- ✅ 掌握条件函数的设计方法
- ✅ 能够处理复杂的路由场景
- ✅ 理解与其他路由方式的区别

---

### 路径3：面试准备（1小时）

**目标**：准备技术面试，展示深度理解

**学习顺序**：
1. **01_30字核心.md** - 快速回顾
2. **02_第一性原理.md** - 理解本质（重点）
3. **06_反直觉点.md** - 掌握常见误区
4. **08_面试必问.md** - 高频问题（重点）
5. **03_核心概念_04_与其他路由对比.md** - 对比分析（重点）
6. **09_化骨绵掌.md** - 快速复习所有知识点

**学习成果**：
- ✅ 能够清晰解释 RunnableBranch 的本质
- ✅ 能够对比不同路由方式的优劣
- ✅ 能够回答高频面试问题
- ✅ 展示实战经验和深度思考

---

### 路径4：生产实践（2小时）

**目标**：在生产环境中正确使用 RunnableBranch

**学习顺序**：
1. **04_最小可用.md** - 快速回顾基础
2. **03_核心概念_02_分支条件设计.md** - 条件设计最佳实践
3. **07_实战代码_02_复杂分支场景.md** - 复杂场景处理
4. **07_实战代码_03_性能优化与生产实践.md** - 生产实践（重点）
5. **03_核心概念_04_与其他路由对比.md** - 选择合适的路由方式

**学习成果**：
- ✅ 掌握性能优化技巧
- ✅ 了解生产环境最佳实践
- ✅ 能够处理错误和监控
- ✅ 知道何时使用 RunnableBranch

---

### 路径5：碎片化学习（10天）

**目标**：每天2分钟，10天掌握 RunnableBranch

**学习计划**：
- **第1天**：09_化骨绵掌.md - 卡片1（直觉理解）
- **第2天**：09_化骨绵掌.md - 卡片2（形式化定义）
- **第3天**：09_化骨绵掌.md - 卡片3（条件函数设计）
- **第4天**：09_化骨绵掌.md - 卡片4（顺序评估机制）
- **第5天**：09_化骨绵掌.md - 卡片5（默认分支的作用）
- **第6天**：09_化骨绵掌.md - 卡片6（与 if-else 的区别）
- **第7天**：09_化骨绵掌.md - 卡片7（与其他路由方式对比）
- **第8天**：09_化骨绵掌.md - 卡片8（LCEL 组合）
- **第9天**：09_化骨绵掌.md - 卡片9（性能优化技巧）
- **第10天**：09_化骨绵掌.md - 卡片10（生产环境最佳实践）

**周末复习**：
- 阅读 07_实战代码_01_基础条件路由.md
- 运行 2-3 个示例
- 总结学习心得

---

## 🔧 前置知识

学习 RunnableBranch 前，建议先掌握：

### 必须掌握
- ✅ **Python 基础**：lambda 函数、类型提示
- ✅ **Runnable 接口**：理解 Runnable 协议
- ✅ **LCEL 基础**：管道操作符 `|` 的使用

### 推荐掌握
- ⭐ **ChatModel**：LLM 调用基础
- ⭐ **PromptTemplate**：提示词模板
- ⭐ **RunnableLambda**：自定义 Runnable

### 相关知识点
- **RunnableParallel**：并行执行（可与 RunnableBranch 组合）
- **Agent**：智能路由（更高级的路由方式）
- **LangGraph**：状态管理和复杂工作流

---

## 🎓 学习目标

完成本知识点学习后，你应该能够：

### 基础理解
- [ ] 理解 RunnableBranch 的核心概念和作用
- [ ] 掌握条件函数的设计方法
- [ ] 理解顺序评估和第一匹配原则
- [ ] 知道默认分支的作用和必要性

### 实战能力
- [ ] 能够创建基础的条件路由
- [ ] 能够设计复杂的分支条件
- [ ] 能够与 LCEL 链式组合
- [ ] 能够处理异步执行场景

### 进阶掌握
- [ ] 理解与其他路由方式的区别
- [ ] 掌握性能优化技巧
- [ ] 了解 2025-2026 的迁移趋势
- [ ] 能够在生产环境中应用

### 面试准备
- [ ] 能够解释 RunnableBranch 与 if-else 的区别
- [ ] 能够说明何时使用 RunnableBranch vs RunnableLambda
- [ ] 理解条件路由的常见误区
- [ ] 掌握实际应用场景和最佳实践

---

## 💻 环境配置

### Python 环境

```bash
# 1. 确认 Python 版本
python --version  # 需要 3.13+

# 2. 安装依赖
uv sync

# 3. 激活虚拟环境
source .venv/bin/activate

# 4. 配置 API 密钥
cp .env.example .env
# 编辑 .env，添加 OPENAI_API_KEY
```

### 依赖库

本知识点的代码示例使用以下库：

| 库 | 用途 | 版本要求 |
|---|------|----------|
| `langchain-core` | 核心框架 | 最新 |
| `langchain-openai` | OpenAI 集成 | 最新 |
| `python-dotenv` | 环境变量管理 | 最新 |

### 验证环境

```python
# 运行此代码验证环境
from langchain_core.runnables import RunnableBranch, RunnableLambda

branch = RunnableBranch(
    (lambda x: x > 0, RunnableLambda(lambda x: "Positive")),
    RunnableLambda(lambda x: "Non-positive")
)

print(branch.invoke(10))  # 应输出：Positive
print(branch.invoke(-5))  # 应输出：Non-positive
```

---

## 📖 核心概念速查

### 基本结构

```python
from langchain_core.runnables import RunnableBranch

branch = RunnableBranch(
    (condition1, branch1),  # 条件-分支对
    (condition2, branch2),  # 条件-分支对
    default_branch          # 默认分支（必须）
)
```

### 关键特性

| 特性 | 说明 |
|------|------|
| **顺序评估** | 从上到下检查条件 |
| **第一匹配** | 只执行第一个匹配的分支 |
| **默认分支** | 必须提供，作为兜底 |
| **LCEL 组合** | 可用 `\|` 连接其他 Runnable |
| **异步支持** | 支持 ainvoke/astream |
| **可观测性** | 支持 LangSmith 追踪 |

### 常见模式

```python
# 1. 关键词路由
branch = RunnableBranch(
    (lambda x: "code" in x, code_handler),
    (lambda x: "math" in x, math_handler),
    general_handler
)

# 2. 阈值路由
branch = RunnableBranch(
    (lambda x: x["score"] > 0.8, high_handler),
    (lambda x: x["score"] > 0.5, medium_handler),
    low_handler
)

# 3. 类型路由
branch = RunnableBranch(
    (lambda x: isinstance(x, dict), dict_handler),
    (lambda x: isinstance(x, str), str_handler),
    default_handler
)
```

---

## ⚠️ 常见误区

1. **条件会并行评估** ❌
   - 实际：顺序评估，第一个匹配就停止

2. **所有匹配的分支都会执行** ❌
   - 实际：只执行第一个匹配的分支

3. **RunnableBranch 已弃用不能用** ❌
   - 实际：标记为 legacy 但仍可用，简单场景推荐

4. **条件顺序不重要** ❌
   - 实际：顺序决定优先级，从具体到通用

5. **默认分支可选** ❌
   - 实际：必须提供默认分支

---

## 🔗 相关资源

### 官方文档
- [LangChain RunnableBranch API](https://python.langchain.com/docs/expression_language/primitives/branching)
- [LCEL 表达式语言](https://python.langchain.com/docs/expression_language/)

### 相关知识点
- **L1_核心抽象/01_Runnable接口与LCEL基础** - 前置知识
- **L1_核心抽象/05_RunnablePassthrough与RunnableLambda** - 相关概念
- **L1_核心抽象/06_RunnableParallel并行执行** - 可组合使用

### 下一步学习
- **L2_LCEL表达式** - 深入学习 LCEL
- **L4_Agent系统** - 学习智能路由
- **L7_LangGraph与状态管理** - 学习复杂工作流

---

## 📝 实战练习

### 练习1：意图识别路由（初级）

**任务**：创建一个意图识别路由，根据用户输入路由到不同处理器

**要求**：
- 识别问候、问题、命令三种意图
- 使用关键词匹配
- 提供默认处理

**提示**：参考 07_实战代码_01_基础条件路由.md 示例3

---

### 练习2：多模型路由（中级）

**任务**：根据任务复杂度选择不同的 LLM 模型

**要求**：
- 计算任务复杂度（长度、关键词、多步骤）
- 高复杂度用 GPT-4，低复杂度用 GPT-4o-mini
- 记录每次路由决策

**提示**：参考 07_实战代码_02_复杂分支场景.md 示例3

---

### 练习3：生产环境路由（高级）

**任务**：实现一个生产级的路由系统

**要求**：
- 错误处理和重试
- 监控和日志
- 性能优化（缓存、批处理）
- 配置管理

**提示**：参考 07_实战代码_03_性能优化与生产实践.md

---

## 🎯 学习检查清单

完成学习后，检查是否达到以下标准：

### 理论理解
- [ ] 能用一句话解释 RunnableBranch 是什么
- [ ] 理解顺序评估和第一匹配原则
- [ ] 知道为什么需要默认分支
- [ ] 理解与 if-else 的区别
- [ ] 知道何时使用 RunnableBranch vs RunnableLambda

### 实践能力
- [ ] 能创建简单的条件路由
- [ ] 能设计复杂的条件函数
- [ ] 能与 LCEL 链式组合
- [ ] 能处理错误和异常
- [ ] 能优化性能

### 面试准备
- [ ] 能回答"RunnableBranch 和 if-else 有什么区别？"
- [ ] 能回答"何时使用 RunnableBranch vs RunnableLambda？"
- [ ] 能举例说明实际应用场景
- [ ] 能解释常见误区

---

## 📊 版本信息

**文档版本**：v1.0
**最后更新**：2026-02-18
**LangChain 版本**：0.3.x (2025-2026)
**Python 版本**：3.13+

**重要变更**：
- RunnableBranch 标记为 "legacy"（2025）
- 官方推荐新项目使用 RunnableLambda
- 现有项目不强制迁移

---

## 🤝 贡献与反馈

如果你发现文档中的错误或有改进建议，欢迎：
- 提交 Issue
- 提交 Pull Request
- 分享学习心得

---

## 🚀 开始学习

选择适合你的学习路径，开始学习 RunnableBranch！

**推荐起点**：
- 新手：从 **01_30字核心.md** 开始
- 有经验：从 **02_第一性原理.md** 开始
- 面试准备：从 **08_面试必问.md** 开始
- 生产应用：从 **07_实战代码_03_性能优化与生产实践.md** 开始

**祝学习愉快！** 🎉
