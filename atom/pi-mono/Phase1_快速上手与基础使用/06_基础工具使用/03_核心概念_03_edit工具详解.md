# edit 工具详解

> 深入理解 Pi 的精确编辑工具：diff 生成、hash-anchored edits、编辑策略

---

## 概述

**edit 工具**是 Pi 的 4 个基础工具之一，负责精确修改文件内容。它通过替换特定文本实现修改，并生成 diff 显示变更。

**核心职责：**
- 精确替换文本
- 生成 diff 显示变更
- 保留其他内容不变
- 失败保护（找不到旧内容时不修改）

---

## 设计哲学

### 1. 命令式语义

**edit 工具表达"把 A 改成 B"**

```typescript
// edit 工具的语义
await edit("src/app.ts", "const port = 3000", "const port = 8080")

// 语义：我知道要改什么
// 关心：旧内容必须精确匹配
// 结果：只修改指定部分，其他内容保持不变
```

**对比 write 工具：**
```typescript
// write 工具的语义
await write("src/app.ts", entireNewContent)

// 语义：我知道文件的最终状态
// 不关心：文件之前是什么样子
// 结果：文件内容完全替换
```

---

### 2. 精确匹配原则

**旧内容必须精确匹配，否则编辑失败**

```typescript
// 文件内容：const port  =  3000  (多个空格)

// ❌ 失败：空格不匹配
await edit("src/app.ts", "const port = 3000", "const port = 8080")

// ✅ 成功：精确匹配
await edit("src/app.ts", "const port  =  3000", "const port = 8080")
```

**为什么重要？**
- 避免误修改
- 保证修改的确定性
- 强制 Agent 先 read 确认内容

---

### 3. Diff 生成

**edit 工具自动生成 diff 显示变更**

```typescript
await edit("src/app.ts", "const port = 3000", "const port = 8080")

// 输出 diff：
// --- src/app.ts
// +++ src/app.ts
// @@ -1,1 +1,1 @@
// -const port = 3000
// +const port = 8080
```

**优势：**
- 清晰显示修改内容
- 便于审查和调试
- 类似 Git diff

---

## 实现细节

### 1. 基础实现

**基于字符串替换**

```typescript
// 简化的实现
class EditTool {
  async execute(path: string, oldText: string, newText: string): Promise<Diff> {
    // 1. 读取文件
    const content = fs.readFileSync(path, 'utf-8')

    // 2. 检查旧文本是否存在
    if (!content.includes(oldText)) {
      throw new Error(`Old text not found in ${path}`)
    }

    // 3. 替换文本
    const newContent = content.replace(oldText, newText)

    // 4. 生成 diff
    const diff = this.generateDiff(content, newContent)

    // 5. 写入文件
    fs.writeFileSync(path, newContent, 'utf-8')

    return diff
  }

  private generateDiff(old: string, new_: string): Diff {
    // 使用 diff 算法生成差异
    return computeDiff(old, new_)
  }
}
```

**来源：**
- [pi-mono edit.ts](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/tools/edit.ts) - 核心实现，2026

---

### 2. Hash-Anchored Edits（oh-my-pi）

**oh-my-pi 的重要增强：基于哈希锚点的精确编辑**

传统 edit 的问题：
- 空格差异导致匹配失败
- 字符串未找到错误
- 模糊匹配不可靠

**Hash-Anchored 解决方案：**

```typescript
// oh-my-pi 的 hash-anchored edits
class HashAnchoredEditTool {
  async execute(path: string, oldText: string, newText: string): Promise<Diff> {
    // 1. 读取文件并解析 AST
    const ast = parseCode(path)

    // 2. 为每行计算哈希
    const lineHashes = ast.lines.map(line => computeHash(line.content))

    // 3. 计算旧文本的哈希
    const oldHash = computeHash(oldText)

    // 4. 在 AST 中定位（基于哈希而非文本）
    const location = findByHash(lineHashes, oldHash)

    if (!location) {
      throw new Error(`Hash not found in ${path}`)
    }

    // 5. 精确替换
    replaceAtLocation(ast, location, newText)

    // 6. 生成 diff
    return generateDiff(oldText, newText)
  }
}
```

**优势：**
- 不受空格影响
- 更精确的定位
- 避免常见编辑失败
- 支持安全拒绝变更

**来源：**
- [oh-my-pi GitHub](https://github.com/can1357/oh-my-pi) - Hash-anchored edits 实现，2025
- [oh-my-pi CHANGELOG](https://github.com/can1357/oh-my-pi/blob/main/packages/coding-agent/CHANGELOG.md) - Hashline 编辑模式，2025-2026

---

### 3. 三种编辑模式（oh-my-pi）

**oh-my-pi 支持三种编辑模式：**

**模式 1: Replace（替换）**
```typescript
// 简单文本替换
await edit("file.ts", "old text", "new text")
```

**模式 2: Patch（补丁）**
```typescript
// 应用 unified diff 补丁
await edit("file.ts", patchContent, { mode: "patch" })
```

**模式 3: Hashline（哈希锚点）**
```typescript
// 基于哈希锚点的精确编辑
await edit("file.ts", oldText, newText, { mode: "hashline" })
```

**来源：**
- [oh-my-pi CHANGELOG](https://github.com/can1357/oh-my-pi/blob/main/packages/coding-agent/CHANGELOG.md) - 三种编辑模式，2026

---

## 高级特性

### 1. Intra-line Diff 高亮

**Pi 支持行内差异高亮**

```typescript
// 传统 diff：整行标记
// -const port = 3000
// +const port = 8080

// Intra-line diff：只高亮变化部分
// const port = [3000 → 8080]
```

**来源：**
- [pi-mono CHANGELOG](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md) - Intra-line diff 高亮，2026

---

### 2. 多行变更预览

**支持多行变更的清晰预览**

```typescript
await edit("file.ts", `
function old() {
  return 1
}
`, `
function new() {
  return 2
}
`)

// 预览：
// @@ -1,3 +1,3 @@
// -function old() {
// -  return 1
// +function new() {
// +  return 2
//  }
```

---

### 3. 错误处理

**清晰的错误信息**

```typescript
class EditTool {
  async execute(path: string, oldText: string, newText: string): Promise<Diff> {
    try {
      const content = fs.readFileSync(path, 'utf-8')

      // 检查旧文本是否存在
      if (!content.includes(oldText)) {
        throw new Error(
          `Old text not found in ${path}.\n` +
          `Expected: ${oldText.substring(0, 50)}...\n` +
          `Hint: Use read tool to verify exact content`
        )
      }

      // 检查是否有多个匹配
      const matches = content.split(oldText).length - 1
      if (matches > 1) {
        throw new Error(
          `Multiple matches found (${matches}) in ${path}.\n` +
          `Provide more context to make oldText unique`
        )
      }

      // 执行替换
      const newContent = content.replace(oldText, newText)
      fs.writeFileSync(path, newContent, 'utf-8')

      return this.generateDiff(content, newContent)
    } catch (error) {
      if (error.code === 'ENOENT') {
        throw new Error(`File not found: ${path}`)
      }
      throw error
    }
  }
}
```

---

## 实际应用场景

### 场景 1：修复 Bug

```typescript
// 1. 读取代码
await read("src/calculator.ts")
// 发现：return a - b  // Bug!

// 2. 修复
await edit("src/calculator.ts", "return a - b", "return a + b")

// 3. 验证
await bash("npm test")
```

---

### 场景 2：重构代码

```typescript
// 1. 重命名函数
await edit("src/api.ts", "function oldName(", "function newName(")

// 2. 更新调用
await edit("src/app.ts", "oldName()", "newName()")

// 3. 测试
await bash("npm test")
```

---

### 场景 3：更新配置

```typescript
// 1. 修改端口
await edit("src/config.ts", "port: 3000", "port: 8080")

// 2. 修改主机
await edit("src/config.ts", "host: 'localhost'", "host: '0.0.0.0'")

// 3. 重启服务
await bash("npm run dev")
```

---

### 场景 4：批量修改

```typescript
// 修改多个文件中的相同内容
await edit("src/app.ts", "oldValue", "newValue")
await edit("src/config.ts", "oldValue", "newValue")
await edit("src/utils.ts", "oldValue", "newValue")
```

---

## 与其他工具的协作

### read + edit

**最常见的组合**

```typescript
// 1. 读取文件
const content = await read("src/app.ts")

// 2. Agent 分析内容

// 3. 精确修改
await edit("src/app.ts", oldCode, newCode)
```

---

### edit + bash

**修改后验证**

```typescript
// 1. 修改代码
await edit("src/feature.ts", buggyCode, fixedCode)

// 2. 运行测试
await bash("npm test")

// 3. 如果失败，继续修改
await edit("src/feature.ts", stillBuggy, finalFix)
```

---

### edit + write

**微调已创建的文件**

```typescript
// 1. 创建基础文件
await write("src/api.ts", baseCode)

// 2. 微调特定部分
await edit("src/api.ts", "localhost", "production.com")
```

---

## 常见问题

### Q1: edit 和 write 有什么区别？

**A:** edit 只修改特定部分，write 覆盖整个文件。

```typescript
// edit：保留其他内容
await edit("file.ts", "old", "new")  // 只改一行

// write：覆盖整个文件
await write("file.ts", entireNewContent)  // 所有内容替换
```

---

### Q2: edit 失败怎么办？

**A:** 先用 read 确认精确内容。

```typescript
// 1. 读取文件
await read("src/app.ts")

// 2. 确认精确内容（包括空格）
// 看到：const port  =  3000  (多个空格)

// 3. 使用精确内容
await edit("src/app.ts", "const port  =  3000", "const port = 8080")
```

---

### Q3: 如何修改多处相同内容？

**A:** 多次调用 edit，或提供更多上下文使每次匹配唯一。

```typescript
// 方案 1：多次调用
await edit("file.ts", "value", "newValue")  // 第一处
await edit("file.ts", "value", "newValue")  // 第二处

// 方案 2：提供上下文
await edit("file.ts", "const x = value", "const x = newValue")
await edit("file.ts", "const y = value", "const y = newValue")
```

---

### Q4: edit 支持正则表达式吗？

**A:** 默认不支持，但可以通过 Extensions 扩展。

```typescript
// 默认：字符串替换
await edit("file.ts", "old", "new")

// 通过 Extension：支持正则
extensions.register({
  name: "regex-edit",
  tool: {
    name: "edit",
    override: true,
    execute: async (path, pattern, replacement) => {
      const content = fs.readFileSync(path, 'utf-8')
      const newContent = content.replace(new RegExp(pattern), replacement)
      fs.writeFileSync(path, newContent, 'utf-8')
    }
  }
})
```

---

### Q5: edit 会生成 diff 吗？

**A:** 是的，edit 自动生成 diff 显示变更。

```typescript
await edit("file.ts", "old", "new")

// 输出：
// --- file.ts
// +++ file.ts
// @@ -1,1 +1,1 @@
// -old
// +new
```

---

## 2025-2026 最新发展

### Hash-Anchored Edits（oh-my-pi）

2025 年 oh-my-pi 引入的革命性特性：基于哈希锚点的精确编辑。

**解决的问题：**
- 空格差异导致的匹配失败
- 字符串未找到错误
- 模糊匹配的不可靠性

**工作原理：**
1. 为每行代码计算内容哈希
2. Agent 引用哈希而非重现文本
3. 基于哈希精确定位
4. 避免空格和格式问题

**来源：**
- [oh-my-pi GitHub](https://github.com/can1357/oh-my-pi) - Hash-anchored edits，2025

---

### 三种编辑模式

oh-my-pi 支持三种编辑模式，适应不同场景：
- **Replace**: 简单文本替换
- **Patch**: 应用 unified diff 补丁
- **Hashline**: 基于哈希锚点的精确编辑

**来源：**
- [oh-my-pi CHANGELOG](https://github.com/can1357/oh-my-pi/blob/main/packages/coding-agent/CHANGELOG.md) - 三种编辑模式，2026

---

## 最佳实践

### 1. 先 read 后 edit

```typescript
// ✅ 好的做法
await read("src/app.ts")  // 先读取
await edit("src/app.ts", exactOldText, newText)  // 再修改

// ❌ 不好的做法
await edit("src/app.ts", guessedOldText, newText)  // 可能失败
```

---

### 2. 提供足够上下文

```typescript
// ✅ 好的做法：提供上下文
await edit("file.ts", `
function calculate() {
  return a + b
}
`, `
function calculate() {
  return a + b + c
}
`)

// ❌ 不好的做法：上下文不足
await edit("file.ts", "return a + b", "return a + b + c")  // 可能匹配多处
```

---

### 3. 修改后验证

```typescript
// ✅ 好的做法
await edit("src/app.ts", old, new)
await bash("npm test")  // 验证

// ❌ 不好的做法
await edit("src/app.ts", old, new)
// 没有验证，可能引入错误
```

---

### 4. 使用 hash-anchored edits（oh-my-pi）

```typescript
// ✅ 好的做法：使用 hash-anchored
await edit("file.ts", oldText, newText, { mode: "hashline" })

// 优势：
// - 不受空格影响
// - 更精确的定位
// - 避免常见失败
```

---

## 延伸阅读

### 官方文档
- [pi-mono edit.ts](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/tools/edit.ts) - 核心实现
- [pi-mono CHANGELOG](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md) - Intra-line diff

### 社区资源
- [oh-my-pi](https://github.com/can1357/oh-my-pi) - Hash-anchored edits
- [oh-my-pi CHANGELOG](https://github.com/can1357/oh-my-pi/blob/main/packages/coding-agent/CHANGELOG.md) - 三种编辑模式

---

## 下一步学习

完成 edit 工具学习后，建议学习：

### 其他工具
- [03_核心概念_01_read工具详解](./03_核心概念_01_read工具详解.md) - read 工具深入
- [03_核心概念_02_write工具详解](./03_核心概念_02_write工具详解.md) - write 工具深入
- [03_核心概念_04_bash工具详解](./03_核心概念_04_bash工具详解.md) - bash 工具深入

### 实战应用
- [07_实战代码_03_edit工具实战](./07_实战代码_03_edit工具实战.md) - edit 工具实战
- [07_实战代码_05_工具组合模式](./07_实战代码_05_工具组合模式.md) - 工具组合

---

**版本：** v1.0
**最后更新：** 2026-02-19
**维护者：** Claude Code
