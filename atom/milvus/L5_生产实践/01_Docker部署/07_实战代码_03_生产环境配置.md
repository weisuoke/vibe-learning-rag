# 实战代码3：生产环境配置

> 生产级 Milvus 部署配置，包含资源限制、健康检查、日志管理和安全配置

---

## 概述

生产环境配置的关键要素：
- 资源限制和优化
- 健康检查和自动恢复
- 日志管理和轮转
- 安全配置和访问控制
- 监控和告警

---

## 1. 生产级配置文件

```yaml
version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: milvus-etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 40s
    networks:
      - milvus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: milvus-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 40s
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    networks:
      - milvus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  milvus:
    image: milvusdb/milvus:v2.4.0
    container_name: milvus-standalone
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      CACHE_SIZE: ${CACHE_SIZE:-8}
    volumes:
      - milvus_data:/var/lib/milvus
      - ./configs/milvus.yaml:/milvus/configs/milvus.yaml:ro
      - /var/log/milvus:/var/log/milvus
    ports:
      - "127.0.0.1:19530:19530"
      - "127.0.0.1:9091:9091"
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 90s
    networks:
      - milvus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G
        reservations:
          cpus: '4'
          memory: 8G
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "5"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock:
        soft: -1
        hard: -1

networks:
  milvus:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500

volumes:
  etcd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/milvus/etcd
    labels:
      project: milvus
      environment: production

  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/milvus/minio
    labels:
      project: milvus
      environment: production

  milvus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/ssd/milvus/data
    labels:
      project: milvus
      environment: production
```

---

## 2. 环境变量配置

```bash
# .env.production
MILVUS_VERSION=v2.4.0
ETCD_VERSION=v3.5.5
MINIO_VERSION=RELEASE.2023-03-20T20-16-18Z

# MinIO 凭证（生产环境使用强密码）
MINIO_ROOT_USER=milvus_admin
MINIO_ROOT_PASSWORD=your_secure_password_here

# Milvus 配置
LOG_LEVEL=warn
CACHE_SIZE=16

# 资源限制
MILVUS_CPU_LIMIT=8
MILVUS_MEMORY_LIMIT=16G
```

---

## 3. Milvus 配置文件

```yaml
# configs/milvus.yaml
etcd:
  endpoints:
    - etcd:2379
  rootPath: by-dev
  metaSubPath: meta
  kvSubPath: kv

minio:
  address: minio:9000
  accessKeyID: minioadmin
  secretAccessKey: minioadmin
  useSSL: false
  bucketName: milvus-bucket

log:
  level: info
  file:
    rootPath: /var/log/milvus
    maxSize: 300
    maxAge: 10
    maxBackups: 20

rootCoord:
  dmlChannelNum: 16
  maxPartitionNum: 4096

dataCoord:
  segment:
    maxSize: 512
    sealProportion: 0.25

queryCoord:
  autoBalance: true
  balanceIntervalSeconds: 60

common:
  retentionDuration: 432000
  entityExpiration: -1
```

---

## 4. 监控配置

### 4.1 Prometheus 配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

rule_files:
  - "alerts.yml"

scrape_configs:
  - job_name: 'milvus'
    static_configs:
      - targets:
          - 'milvus:9091'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'milvus-standalone'
```

### 4.2 告警规则

```yaml
# alerts.yml
groups:
  - name: milvus_alerts
    interval: 30s
    rules:
      - alert: MilvusDown
        expr: up{job="milvus"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Milvus is down"
          description: "Milvus has been down for more than 1 minute"

      - alert: HighMemoryUsage
        expr: milvus_proxy_memory_usage_bytes / 1024 / 1024 / 1024 > 14
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 14GB"

      - alert: HighQPS
        expr: rate(milvus_proxy_req_count[1m]) > 1000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "High QPS detected"
          description: "QPS is above 1000"

      - alert: SlowQuery
        expr: histogram_quantile(0.99, rate(milvus_query_node_search_latency_bucket[5m])) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow queries detected"
          description: "P99 latency is above 1000ms"
```

---

## 5. 备份脚本

```bash
#!/bin/bash
# backup_production.sh

set -e

BACKUP_DIR="/opt/backups/milvus"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

echo "=== Milvus 生产环境备份 ==="
echo "时间: $DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# 停止 Milvus（可选，确保数据一致性）
echo "停止 Milvus..."
docker-compose stop milvus

# 备份 etcd
echo "备份 etcd..."
docker run --rm \
  -v milvus_etcd_data:/data \
  -v $BACKUP_DIR/$DATE:/backup \
  ubuntu tar czf /backup/etcd.tar.gz /data

# 备份 MinIO
echo "备份 MinIO..."
docker run --rm \
  -v milvus_minio_data:/data \
  -v $BACKUP_DIR/$DATE:/backup \
  ubuntu tar czf /backup/minio.tar.gz /data

# 备份 Milvus
echo "备份 Milvus..."
docker run --rm \
  -v milvus_data:/data \
  -v $BACKUP_DIR/$DATE:/backup \
  ubuntu tar czf /backup/milvus.tar.gz /data

# 备份配置文件
echo "备份配置文件..."
cp docker-compose.yml $BACKUP_DIR/$DATE/
cp .env.production $BACKUP_DIR/$DATE/
cp -r configs $BACKUP_DIR/$DATE/

# 重启 Milvus
echo "重启 Milvus..."
docker-compose start milvus

# 上传到远程存储（可选）
if [ -n "$S3_BUCKET" ]; then
    echo "上传到 S3..."
    aws s3 sync $BACKUP_DIR/$DATE s3://$S3_BUCKET/milvus-backups/$DATE/
fi

# 清理旧备份
echo "清理旧备份..."
find $BACKUP_DIR -type d -mtime +$RETENTION_DAYS -exec rm -rf {} +

# 生成备份报告
BACKUP_SIZE=$(du -sh $BACKUP_DIR/$DATE | cut -f1)
echo ""
echo "=== 备份完成 ==="
echo "备份位置: $BACKUP_DIR/$DATE"
echo "备份大小: $BACKUP_SIZE"
echo "保留天数: $RETENTION_DAYS"

# 发送通知（可选）
if [ -n "$SLACK_WEBHOOK" ]; then
    curl -X POST $SLACK_WEBHOOK \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"Milvus 备份完成: $DATE, 大小: $BACKUP_SIZE\"}"
fi
```

---

## 6. 健康检查脚本

```bash
#!/bin/bash
# healthcheck.sh

set -e

echo "=== Milvus 健康检查 ==="

# 检查容器状态
echo "1. 容器状态:"
docker-compose ps

# 检查健康状态
echo ""
echo "2. 健康状态:"
for service in etcd minio milvus; do
    health=$(docker inspect --format='{{.State.Health.Status}}' milvus-$service 2>/dev/null || echo "no healthcheck")
    echo "  $service: $health"
done

# 检查资源使用
echo ""
echo "3. 资源使用:"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" | grep milvus

# 检查磁盘空间
echo ""
echo "4. 磁盘空间:"
df -h /mnt/ssd/milvus

# 检查 Milvus 连接
echo ""
echo "5. Milvus 连接:"
python3 << EOF
from pymilvus import connections, utility
try:
    connections.connect(host="localhost", port="19530")
    version = utility.get_server_version()
    print(f"  ✅ 连接成功，版本: {version}")
    connections.disconnect("default")
except Exception as e:
    print(f"  ❌ 连接失败: {e}")
    exit(1)
EOF

# 检查关键指标
echo ""
echo "6. 关键指标:"
curl -s http://localhost:9091/metrics | grep -E "milvus_proxy_req_count|milvus_query_node_search_latency" | head -5

echo ""
echo "=== 健康检查完成 ==="
```

---

## 7. 部署检查清单

### 7.1 部署前检查

```bash
# 系统资源检查
- [ ] CPU: 至少 8 核
- [ ] 内存: 至少 16GB
- [ ] 磁盘: 至少 100GB SSD
- [ ] 网络: 稳定的网络连接

# 软件环境检查
- [ ] Docker 版本 >= 20.10
- [ ] Docker Compose 版本 >= 2.0
- [ ] Python 版本 >= 3.9

# 配置文件检查
- [ ] docker-compose.yml 已配置
- [ ] .env.production 已配置
- [ ] configs/milvus.yaml 已配置
- [ ] 所有密码已修改为强密码

# 存储检查
- [ ] /mnt/ssd/milvus 目录已创建
- [ ] 目录权限正确
- [ ] 磁盘空间充足
```

### 7.2 部署后检查

```bash
# 服务状态检查
- [ ] 所有容器都在运行
- [ ] 所有健康检查都通过
- [ ] 端口正确映射

# 功能检查
- [ ] 可以连接到 Milvus
- [ ] 可以创建 Collection
- [ ] 可以插入数据
- [ ] 可以执行检索

# 监控检查
- [ ] Prometheus 正常采集指标
- [ ] Grafana 可以访问
- [ ] 告警规则已配置

# 备份检查
- [ ] 备份脚本可以正常运行
- [ ] 备份文件完整
- [ ] 恢复流程已测试
```

---

## 8. 安全加固

### 8.1 网络安全

```yaml
# 只允许本地访问
ports:
  - "127.0.0.1:19530:19530"
  - "127.0.0.1:9091:9091"

# 使用内部网络
networks:
  milvus:
    internal: true  # 不能访问外部网络
```

### 8.2 访问控制

```yaml
# Milvus 配置文件
common:
  security:
    authorizationEnabled: true

# 创建用户和角色
```

```python
from pymilvus import connections, utility

connections.connect(host="localhost", port="19530")

# 创建用户
utility.create_user("admin", "admin_password")
utility.create_user("readonly", "readonly_password")

# 创建角色
utility.create_role("admin_role")
utility.create_role("readonly_role")

# 授权
utility.grant_role("admin", "admin_role")
utility.grant_role("readonly", "readonly_role")
```

---

## 9. 故障恢复

### 9.1 恢复脚本

```bash
#!/bin/bash
# restore.sh

BACKUP_DATE=$1

if [ -z "$BACKUP_DATE" ]; then
    echo "用法: $0 <backup_date>"
    echo "示例: $0 20240210_020000"
    exit 1
fi

BACKUP_DIR="/opt/backups/milvus/$BACKUP_DATE"

if [ ! -d "$BACKUP_DIR" ]; then
    echo "备份不存在: $BACKUP_DIR"
    exit 1
fi

echo "=== 恢复 Milvus 数据 ==="
echo "备份时间: $BACKUP_DATE"

# 停止服务
echo "停止服务..."
docker-compose down

# 删除旧数据
echo "删除旧数据..."
docker volume rm milvus_etcd_data milvus_minio_data milvus_data

# 创建新 volumes
echo "创建新 volumes..."
docker volume create milvus_etcd_data
docker volume create milvus_minio_data
docker volume create milvus_data

# 恢复 etcd
echo "恢复 etcd..."
docker run --rm \
  -v milvus_etcd_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar xzf /backup/etcd.tar.gz -C /

# 恢复 MinIO
echo "恢复 MinIO..."
docker run --rm \
  -v milvus_minio_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar xzf /backup/minio.tar.gz -C /

# 恢复 Milvus
echo "恢复 Milvus..."
docker run --rm \
  -v milvus_data:/data \
  -v $BACKUP_DIR:/backup \
  ubuntu tar xzf /backup/milvus.tar.gz -C /

# 启动服务
echo "启动服务..."
docker-compose up -d

echo ""
echo "=== 恢复完成 ==="
echo "请等待服务启动（约 90 秒）"
```

---

## 关键要点

1. **资源限制**
   - 使用 deploy.resources 限制 CPU 和内存
   - 防止资源滥用

2. **健康检查**
   - 所有服务都配置 healthcheck
   - 自动重启失败的服务

3. **日志管理**
   - 使用 json-file 驱动
   - 配置日志轮转

4. **安全配置**
   - 只允许本地访问
   - 使用强密码
   - 启用访问控制

5. **监控告警**
   - Prometheus 采集指标
   - 配置告警规则
   - 及时发现问题

6. **备份恢复**
   - 定期自动备份
   - 测试恢复流程
   - 保留多个版本

---

## 下一步

完成生产环境配置后，建议：
- 定期检查系统健康状态
- 优化资源配置
- 监控性能指标
- 定期测试备份恢复
