# 核心概念1：过滤表达式语法

> 掌握 Milvus 过滤表达式的完整语法规则

---

## 什么是过滤表达式？

**过滤表达式是一个字符串，描述了数据需要满足的条件，类似于 SQL 的 WHERE 子句。**

```python
# SQL 风格
WHERE year = 2024 AND category = 'tech'

# Milvus 风格
expr = "year == 2024 and category == 'tech'"
```

---

## 1. 基础语法规则

### 1.1 字段引用

**直接使用字段名，不需要引号**

```python
# ✅ 正确：直接使用字段名
expr = "year == 2024"
expr = "category == 'tech'"
expr = "price > 100"

# ❌ 错误：字段名不要加引号
expr = "'year' == 2024"  # 错误！
```

### 1.2 字符串值

**字符串值必须用单引号 `'`**

```python
# ✅ 正确：字符串用单引号
expr = "category == 'tech'"
expr = "title like 'Python%'"

# ❌ 错误：不能用双引号
expr = "category == \"tech\""  # 错误！

# ❌ 错误：不能不加引号
expr = "category == tech"  # 错误！
```

**转义特殊字符**

```python
# 字符串中包含单引号，需要转义
expr = "title == 'It\\'s a book'"  # It's a book

# 或者使用双引号包裹整个表达式
expr = 'title == "It\'s a book"'  # 不推荐，容易混淆
```

### 1.3 数值

**数值直接写，不需要引号**

```python
# 整数
expr = "year == 2024"
expr = "count > 100"

# 浮点数
expr = "price >= 99.99"
expr = "score < 0.5"

# 负数
expr = "temperature < -10"
```

### 1.4 布尔值

**使用 `true` 和 `false`（小写）**

```python
# ✅ 正确：小写
expr = "is_published == true"
expr = "is_deleted == false"

# ❌ 错误：大写或其他形式
expr = "is_published == True"   # 错误！
expr = "is_published == TRUE"   # 错误！
expr = "is_published == 1"      # 错误！
```

---

## 2. 比较运算符

### 2.1 相等性运算符

| 运算符 | 含义 | 示例 | 说明 |
|--------|------|------|------|
| `==` | 等于 | `year == 2024` | 精确匹配 |
| `!=` | 不等于 | `status != 'deleted'` | 排除特定值 |

```python
# 等于
expr = "category == 'tech'"
expr = "year == 2024"
expr = "is_published == true"

# 不等于
expr = "status != 'deleted'"
expr = "year != 2023"
expr = "is_deleted != true"
```

**注意**：
- 使用 `==` 而非 `=`（这是与 SQL 的主要区别）
- 字符串比较区分大小写

### 2.2 大小比较运算符

| 运算符 | 含义 | 示例 | 说明 |
|--------|------|------|------|
| `>` | 大于 | `price > 100` | 严格大于 |
| `<` | 小于 | `age < 18` | 严格小于 |
| `>=` | 大于等于 | `score >= 60` | 大于或等于 |
| `<=` | 小于等于 | `year <= 2024` | 小于或等于 |

```python
# 数值比较
expr = "price > 100"           # 价格大于100
expr = "age >= 18"             # 年龄大于等于18
expr = "score < 60"            # 分数小于60
expr = "year <= 2024"          # 年份小于等于2024

# 时间戳比较（存储为整数）
expr = "publish_time > 1704067200"  # 2024-01-01 00:00:00 UTC

# 浮点数比较
expr = "similarity >= 0.8"     # 相似度大于等于0.8
```

**注意**：
- 只能用于数值类型（INT8, INT16, INT32, INT64, FLOAT, DOUBLE）
- 不能用于字符串的字典序比较（Milvus 不支持）

---

## 3. 成员检查运算符

### 3.1 IN 运算符

**检查字段值是否在给定集合中**

```python
# 基础语法
expr = "field in [value1, value2, value3]"

# 字符串列表
expr = "category in ['tech', 'ai', 'ml']"

# 数值列表
expr = "year in [2023, 2024, 2025]"
expr = "user_id in [101, 102, 103]"

# 布尔值列表（较少使用）
expr = "is_featured in [true]"  # 等价于 is_featured == true
```

**使用场景**：
- 多分类筛选
- 白名单过滤
- 批量ID查询

**性能提示**：
- `in` 比多个 `or` 更高效
- 列表长度建议不超过1000个元素

```python
# ✅ 推荐：使用 in
expr = "category in ['tech', 'ai', 'ml', 'data']"

# ❌ 不推荐：使用多个 or
expr = "category == 'tech' or category == 'ai' or category == 'ml' or category == 'data'"
```

### 3.2 NOT IN 运算符（Milvus 2.3+）

**检查字段值是否不在给定集合中**

```python
# 排除特定值
expr = "category not in ['spam', 'deleted']"

# 排除特定用户
expr = "user_id not in [101, 102, 103]"

# 排除特定年份
expr = "year not in [2020, 2021]"
```

**等价写法**：

```python
# 使用 not in
expr = "category not in ['spam', 'deleted']"

# 等价于（但更繁琐）
expr = "not (category in ['spam', 'deleted'])"
```

---

## 4. 模糊匹配运算符

### 4.1 LIKE 运算符

**字符串模糊匹配，支持通配符**

**通配符**：
- `%`：匹配任意多个字符（包括0个）
- `_`：匹配单个字符

```python
# 前缀匹配：以 Python 开头
expr = "title like 'Python%'"
# 匹配：Python教程, Python入门, Python3.9

# 后缀匹配：以 教程 结尾
expr = "title like '%教程'"
# 匹配：Python教程, Java教程, 机器学习教程

# 包含匹配：包含 机器学习
expr = "title like '%机器学习%'"
# 匹配：Python机器学习, 机器学习入门, 深度学习与机器学习

# 单字符通配符
expr = "code like 'A_01'"
# 匹配：AA01, AB01, AC01
# 不匹配：A01, AAA01

# 组合使用
expr = "title like 'Python%教程'"
# 匹配：Python基础教程, Python进阶教程
```

**注意事项**：
- 区分大小写
- `%` 可以匹配0个字符
- 性能：前缀匹配最快，包含匹配最慢

```python
# 性能对比（从快到慢）
expr = "title like 'Python%'"      # 快：前缀匹配，可以使用索引
expr = "title like '%教程'"         # 中：后缀匹配
expr = "title like '%机器学习%'"    # 慢：包含匹配，需要全表扫描
```

### 4.2 大小写敏感性

**LIKE 运算符区分大小写**

```python
# 数据库中存储：Python教程
expr = "title like 'python%'"  # ❌ 匹配不到（小写p）
expr = "title like 'Python%'"  # ✅ 匹配成功（大写P）
```

**解决方案：统一大小写**

```python
# 方案1：插入数据时统一转为小写
data = [
    {"id": 1, "title": "Python教程".lower(), ...},
    {"id": 2, "title": "JAVA教程".lower(), ...}
]
collection.insert(data)

# 查询时也使用小写
expr = "title like 'python%'"  # ✅ 匹配成功

# 方案2：插入数据时统一转为大写
# 查询时也使用大写
```

---

## 5. 完整语法示例

### 5.1 单条件

```python
# 相等性
expr = "year == 2024"
expr = "category == 'tech'"
expr = "is_published == true"

# 大小比较
expr = "price > 100"
expr = "age >= 18"
expr = "score < 60"

# 成员检查
expr = "category in ['tech', 'ai', 'ml']"
expr = "user_id not in [101, 102, 103]"

# 模糊匹配
expr = "title like 'Python%'"
expr = "content like '%机器学习%'"
```

### 5.2 多条件（下一节详细讲解）

```python
# AND 组合
expr = "year == 2024 and category == 'tech'"

# OR 组合
expr = "category == 'tech' or category == 'ai'"

# 混合组合
expr = "(category == 'tech' or category == 'ai') and year == 2024"
```

---

## 6. 数据类型对应表

| Milvus 数据类型 | 支持的运算符 | 示例 |
|----------------|-------------|------|
| INT8, INT16, INT32, INT64 | ==, !=, >, <, >=, <=, in, not in | `year == 2024` |
| FLOAT, DOUBLE | ==, !=, >, <, >=, <=, in, not in | `price > 99.99` |
| BOOL | ==, != | `is_published == true` |
| VARCHAR | ==, !=, in, not in, like | `category == 'tech'` |
| JSON | 不支持直接过滤 | 需要提取为独立字段 |
| ARRAY | 不支持直接过滤 | 需要提取为独立字段 |

---

## 7. 常见错误和解决方案

### 错误1：使用 `=` 而非 `==`

```python
# ❌ 错误
expr = "year = 2024"

# ✅ 正确
expr = "year == 2024"
```

### 错误2：字符串使用双引号

```python
# ❌ 错误
expr = "category == \"tech\""

# ✅ 正确
expr = "category == 'tech'"
```

### 错误3：布尔值使用大写

```python
# ❌ 错误
expr = "is_published == True"

# ✅ 正确
expr = "is_published == true"
```

### 错误4：字段名加引号

```python
# ❌ 错误
expr = "'year' == 2024"

# ✅ 正确
expr = "year == 2024"
```

### 错误5：IN 列表使用圆括号

```python
# ❌ 错误
expr = "category in ('tech', 'ai')"

# ✅ 正确
expr = "category in ['tech', 'ai']"
```

---

## 8. 实战示例

### 示例1：电商商品筛选

```python
from pymilvus import Collection, connections

connections.connect("default", host="localhost", port="19530")
collection = Collection("products")

# 查询：2024年发布的、价格在100-500之间的、科技类商品
expr = """
    year == 2024
    and price >= 100
    and price <= 500
    and category == 'electronics'
"""

results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=20,
    expr=expr,
    output_fields=["title", "price", "category"]
)
```

### 示例2：内容管理系统

```python
# 查询：已发布的、未删除的、标题包含"Python"的文章
expr = """
    is_published == true
    and is_deleted == false
    and title like '%Python%'
"""

results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr=expr,
    output_fields=["title", "author", "publish_time"]
)
```

### 示例3：多租户知识库

```python
# 查询：特定用户的、特定分类的文档
user_id = 12345
allowed_categories = ['tech', 'ai', 'ml', 'data']

expr = f"""
    user_id == {user_id}
    and category in {allowed_categories}
    and status == 'active'
"""

results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr=expr
)
```

---

## 9. 性能优化建议

### 9.1 使用索引

```python
# 为高频过滤字段创建索引
collection.create_index(
    field_name="year",
    index_name="year_index"
)
collection.create_index(
    field_name="category",
    index_name="category_index"
)
```

### 9.2 优化表达式

```python
# ✅ 推荐：使用 in
expr = "category in ['tech', 'ai', 'ml']"

# ❌ 不推荐：使用多个 or
expr = "category == 'tech' or category == 'ai' or category == 'ml'"

# ✅ 推荐：前缀匹配
expr = "title like 'Python%'"

# ❌ 不推荐：包含匹配（慢）
expr = "title like '%Python%'"
```

### 9.3 选择性优化

```python
# ✅ 推荐：高选择性条件在前
expr = "user_id == 12345 and category == 'tech'"  # user_id 选择性高

# ❌ 不推荐：低选择性条件在前
expr = "category == 'tech' and user_id == 12345"  # category 选择性低
```

---

## 核心要点总结

1. **字段名**：直接使用，不加引号
2. **字符串值**：必须用单引号 `'`
3. **数值**：直接写，不加引号
4. **布尔值**：小写 `true` / `false`
5. **比较运算符**：使用 `==` 而非 `=`
6. **IN 列表**：使用方括号 `[]`
7. **LIKE 通配符**：`%` 匹配多个，`_` 匹配单个
8. **大小写**：字符串比较区分大小写

**记住**：Milvus 表达式语法与 Python 高度一致，学习成本低。
