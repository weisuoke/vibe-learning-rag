# docker-compose编排 - 概览

## 学习路线图

```
1. 理解 docker-compose 的价值
   ↓
2. 掌握基础配置（services, ports, volumes）
   ↓
3. 学习依赖管理（depends_on, healthcheck）
   ↓
4. 掌握环境配置（environment, env_file）
   ↓
5. 理解网络和数据持久化
   ↓
6. 实战：搭建完整开发环境
   ↓
7. 进阶：多环境配置和生产优化
```

## 快速开始

### 5分钟上手

**场景：** 启动 FastAPI + PostgreSQL 开发环境

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/mydb
    depends_on:
      - db

  db:
    image: postgres:14-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

**运行：**
```bash
# 启动所有服务
docker-compose up

# 后台运行
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 核心概念速览

### 1. 服务定义（Services）
- 每个服务是一个容器
- 定义镜像、端口、环境变量等
- 服务间可以通过服务名通信

### 2. 依赖管理（Dependencies）
- `depends_on` 控制启动顺序
- `healthcheck` 确保服务就绪
- `condition` 指定等待条件

### 3. 数据持久化（Volumes）
- 命名卷：Docker 管理的持久化存储
- 绑定挂载：映射主机目录
- 用于数据库数据和代码热重载

### 4. 网络配置（Networks）
- 默认创建桥接网络
- 服务间通过服务名访问
- 可自定义网络配置

### 5. 环境配置（Environment）
- `environment` 直接定义变量
- `env_file` 引用 .env 文件
- `profiles` 支持多环境

## 学习检查清单

### 基础知识（必须掌握）
- [ ] 理解 docker-compose 的作用和价值
- [ ] 能编写基础的 docker-compose.yml
- [ ] 掌握 services、ports、volumes 配置
- [ ] 理解 depends_on 的作用和局限
- [ ] 能使用 docker-compose up/down 命令

### 进阶知识（推荐掌握）
- [ ] 掌握 healthcheck 健康检查
- [ ] 理解 networks 网络配置
- [ ] 能使用 env_file 管理环境变量
- [ ] 掌握 profiles 多环境配置
- [ ] 理解 volumes 和 bind mounts 的区别

### 生产实践（深入理解）
- [ ] 掌握资源限制配置
- [ ] 理解日志管理策略
- [ ] 能配置优雅关闭
- [ ] 理解 docker-compose 的适用场景
- [ ] 知道何时应该用 Kubernetes

## 常见问题

### Q1: docker-compose 和 Dockerfile 有什么区别？

**A:**
- **Dockerfile**：定义**单个**容器镜像的构建过程
- **docker-compose**：编排**多个**容器的运行和依赖关系

**类比：**
- Dockerfile = 单个零件的制造图纸
- docker-compose = 整个产品的组装说明书

### Q2: depends_on 为什么不等待服务就绪？

**A:**
`depends_on` 只等待容器启动，不等待服务就绪。

**原因：** Docker 无法判断服务何时"就绪"（数据库可能启动了但还在初始化）

**解决方案：** 使用 `healthcheck` + `condition: service_healthy`

```yaml
services:
  api:
    depends_on:
      db:
        condition: service_healthy

  db:
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
      timeout: 3s
      retries: 5
```

### Q3: 开发环境和生产环境应该用同一个 docker-compose.yml 吗？

**A:** 不应该。推荐使用多文件策略：

```bash
# 基础配置
docker-compose.yml

# 开发环境覆盖
docker-compose.dev.yml

# 生产环境覆盖
docker-compose.prod.yml
```

**使用：**
```bash
# 开发环境
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# 生产环境
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
```

### Q4: volumes 和 bind mounts 应该用哪个？

**A:** 根据场景选择：

| 场景 | 推荐方案 | 原因 |
|------|---------|------|
| 数据库数据 | volumes | Docker 管理，跨平台兼容 |
| 开发代码热重载 | bind mounts | 直接映射主机目录 |
| 配置文件 | bind mounts | 方便修改和查看 |
| 生产环境数据 | volumes | 更安全，性能更好 |

### Q5: docker-compose 适合生产环境吗？

**A:** 看规模：

- ✅ **适合**：单机部署、小型项目、测试环境
- ❌ **不适合**：多机集群、高可用要求、大规模应用

**生产环境推荐：**
- 小规模：docker-compose + 监控
- 中大规模：Kubernetes、Docker Swarm

## 在 AI Agent 开发中的应用

### 典型场景

**1. 本地开发环境**
```yaml
services:
  api:          # FastAPI 应用
  db:           # PostgreSQL 数据库
  redis:        # Redis 缓存
  pgadmin:      # 数据库管理工具
```

**2. 测试环境**
```yaml
services:
  api:          # 待测试的 API
  test-db:      # 隔离的测试数据库
  mock-llm:     # Mock LLM 服务
```

**3. 演示环境**
```yaml
services:
  api:          # 生产级配置
  db:           # 持久化数据
  nginx:        # 反向代理
```

### 实际价值

**开发效率提升：**
- 一键启动完整环境（API + DB + Redis）
- 新成员快速上手（无需手动配置）
- 环境一致性（避免"我这里能跑"问题）

**成本节约：**
- 本地开发无需云资源
- 测试环境快速创建和销毁
- 多项目隔离（不同端口和网络）

## 下一步学习

### 推荐顺序

1. **先学习：** 02_第一性原理.md - 理解为什么需要 docker-compose
2. **再学习：** 04_最小可用.md - 掌握核心配置
3. **然后学习：** 03_核心概念_*.md - 深入各个技术点
4. **最后实战：** 07_实战代码_*.md - 完整项目示例

### 配套资源

**官方文档：**
- [Docker Compose 官方文档](https://docs.docker.com/compose/)
- [Compose 文件规范](https://docs.docker.com/compose/compose-file/)

**实战项目：**
- `examples/docker-compose/basic/` - 基础示例
- `examples/docker-compose/ai-agent/` - AI Agent 完整环境

## 预期学习成果

学完本知识点后，你将能够：

1. ✅ 独立编写 docker-compose.yml 配置文件
2. ✅ 搭建 FastAPI + PostgreSQL + Redis 开发环境
3. ✅ 配置服务依赖和健康检查
4. ✅ 管理多环境配置（开发/测试/生产）
5. ✅ 理解 docker-compose 的适用场景和局限
6. ✅ 解决常见的容器编排问题

---

**版本：** v1.0
**最后更新：** 2026-02-12
**预计学习时间：** 完整学习约 4-6 小时，快速上手约 1 小时
