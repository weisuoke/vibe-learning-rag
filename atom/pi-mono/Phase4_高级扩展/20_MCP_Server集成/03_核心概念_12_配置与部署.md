# 核心概念 12：配置与部署

> **深入理解 pi-mono 扩展的配置管理、包管理和部署策略**

---

## 概述

pi-mono 提供了灵活的配置系统和包管理机制，支持全局配置、项目配置、npm 包、git 仓库和本地路径等多种扩展来源。

```
配置与部署核心：
├─ settings.json → 全局与项目配置
├─ 包管理 → npm、git、本地路径
├─ 扩展加载 → 自动发现与手动配置
└─ 热重载 → /reload 命令
```

**本质**：配置与部署是 pi-mono 扩展生态的基础设施，通过标准化的配置文件和包管理工具，让扩展能够轻松分发、安装和更新，同时支持全局共享和项目隔离。

[Source: pi-mono Settings Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/settings.md)
[Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)

---

## settings.json 配置

### 配置文件位置

pi-mono 使用 JSON 配置文件，项目配置覆盖全局配置：

| 位置 | 作用域 | 优先级 |
|------|--------|--------|
| `~/.pi/agent/settings.json` | 全局（所有项目） | 低 |
| `.pi/settings.json` | 项目（当前目录） | 高 |

**配置合并规则**：

```json
// ~/.pi/agent/settings.json (全局)
{
  "theme": "dark",
  "compaction": { "enabled": true, "reserveTokens": 16384 }
}

// .pi/settings.json (项目)
{
  "compaction": { "reserveTokens": 8192 }
}

// 最终结果
{
  "theme": "dark",
  "compaction": { "enabled": true, "reserveTokens": 8192 }
}
```

嵌套对象会被合并，项目配置中的字段覆盖全局配置。

### 扩展相关配置

**packages 配置**：

```json
{
  "packages": [
    "pi-skills",                    // 字符串形式：加载所有资源
    "@org/my-extension",
    {
      "source": "npm:my-package",   // 对象形式：过滤资源
      "extensions": ["extensions/*.ts", "!extensions/legacy.ts"],
      "skills": [],
      "prompts": ["prompts/review.md"],
      "themes": ["+themes/legacy.json"]
    }
  ]
}
```

**extensions 配置**：

```json
{
  "extensions": [
    "./extensions",                 // 本地目录
    "./extensions/my-ext.ts",       // 单个文件
    "!./extensions/disabled.ts"     // 排除文件
  ]
}
```

**路径解析规则**：

- `~/.pi/agent/settings.json` 中的路径相对于 `~/.pi/agent`
- `.pi/settings.json` 中的路径相对于 `.pi`
- 支持绝对路径和 `~` 扩展
- 支持 glob 模式和排除模式

[Source: pi-mono Settings Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/settings.md)

---

## 包管理

### 安装与管理命令

**基本命令**：

```bash
# 安装包
pi install npm:@foo/bar@1.0.0
pi install git:github.com/user/repo@v1
pi install https://github.com/user/repo
pi install /absolute/path/to/package
pi install ./relative/path/to/package

# 移除包
pi remove npm:@foo/bar

# 列出已安装包
pi list

# 更新所有未固定版本的包
pi update
```

**作用域控制**：

```bash
# 默认：写入全局配置
pi install npm:@foo/bar

# -l 标志：写入项目配置
pi install -l npm:@foo/bar

# 临时试用（不安装）
pi -e npm:@foo/bar
pi -e git:github.com/user/repo
```

### 包来源类型

**npm 包**：

```
npm:@scope/pkg@1.2.3    # 固定版本（不会被 pi update 更新）
npm:pkg                  # 最新版本
```

- 全局安装使用 `npm install -g`
- 项目安装到 `.pi/npm/`

**git 仓库**：

```
git:github.com/user/repo@v1
git:git@github.com:user/repo@v1
https://github.com/user/repo@v1
ssh://git@github.com/user/repo@v1
```

- 不带 `git:` 前缀时，只接受协议 URL（`https://`、`http://`、`ssh://`、`git://`）
- 带 `git:` 前缀时，支持简写格式（`github.com/user/repo`、`git@github.com:user/repo`）
- SSH URL 自动使用配置的 SSH 密钥（遵循 `~/.ssh/config`）
- 带 ref 的包会被固定，不会被 `pi update` 更新
- 克隆到 `~/.pi/agent/git/<host>/<path>`（全局）或 `.pi/git/<host>/<path>`（项目）
- 克隆或拉取后，如果存在 `package.json`，会运行 `npm install`

**SSH 示例**：

```bash
# git@host:path 简写（需要 git: 前缀）
pi install git:git@github.com:user/repo

# ssh:// 协议格式
pi install ssh://git@github.com/user/repo

# 带版本 ref
pi install git:git@github.com:user/repo@v1.0.0
```

**本地路径**：

```
/absolute/path/to/package
./relative/path/to/package
```

- 本地路径指向磁盘上的文件或目录，添加到配置时不会复制
- 相对路径相对于配置文件所在目录解析
- 如果路径是文件，作为单个扩展加载
- 如果路径是目录，使用包规则加载资源

[Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)

---

## 创建 Pi 包

### 包结构

**使用 package.json 清单**：

```json
{
  "name": "my-package",
  "keywords": ["pi-package"],
  "pi": {
    "extensions": ["./extensions"],
    "skills": ["./skills"],
    "prompts": ["./prompts"],
    "themes": ["./themes"]
  }
}
```

路径相对于包根目录，数组支持 glob 模式和 `!exclusions`。

**约定目录**：

如果没有 `pi` 清单，pi 会自动从以下目录发现资源：

- `extensions/` 加载 `.ts` 和 `.js` 文件
- `skills/` 递归查找 `SKILL.md` 文件夹，加载顶层 `.md` 文件
- `prompts/` 加载 `.md` 文件
- `themes/` 加载 `.json` 文件

### 依赖管理

**核心包（peerDependencies）**：

```json
{
  "peerDependencies": {
    "@mariozechner/pi-ai": "*",
    "@mariozechner/pi-agent-core": "*",
    "@mariozechner/pi-coding-agent": "*",
    "@mariozechner/pi-tui": "*",
    "@sinclair/typebox": "*"
  }
}
```

pi 内置这些核心包，不要打包它们。

**其他依赖（bundledDependencies）**：

```json
{
  "dependencies": {
    "shitty-extensions": "^1.0.1"
  },
  "bundledDependencies": ["shitty-extensions"],
  "pi": {
    "extensions": ["extensions", "node_modules/shitty-extensions/extensions"],
    "skills": ["skills", "node_modules/shitty-extensions/skills"]
  }
}
```

其他 pi 包必须打包到 tarball 中，通过 `node_modules/` 路径引用。

### 包过滤

**在 settings.json 中过滤资源**：

```json
{
  "packages": [
    "npm:simple-pkg",
    {
      "source": "npm:my-package",
      "extensions": ["extensions/*.ts", "!extensions/legacy.ts"],
      "skills": [],
      "prompts": ["prompts/review.md"],
      "themes": ["+themes/legacy.json"]
    }
  ]
}
```

**过滤规则**：

- 省略键：加载该类型的所有资源
- `[]`：不加载该类型的资源
- `!pattern`：排除匹配项
- `+path`：强制包含精确路径
- `-path`：强制排除精确路径
- 过滤器叠加在清单之上，缩小已允许的范围

[Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)

---

## 扩展加载机制

### 自动发现

pi 自动从以下位置加载扩展：

| 位置 | 作用域 |
|------|--------|
| `~/.pi/agent/extensions/*.ts` | 全局（所有项目） |
| `~/.pi/agent/extensions/*/index.ts` | 全局（子目录） |
| `.pi/extensions/*.ts` | 项目本地 |
| `.pi/extensions/*/index.ts` | 项目本地（子目录） |

**2025-2026 更新**：

从 0.54.0 版本开始，pi 还支持 `.agents/skills` 位置的自动发现：

- 项目技能：从当前目录和祖先目录的 `.agents/skills`（直到 git 仓库根目录或文件系统根目录）
- 全局技能：从 `~/.agents/skills`

[Source: pi-mono CHANGELOG 0.54.0](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md)

### 手动配置

**通过 settings.json 配置**：

```json
{
  "extensions": [
    "./extensions",
    "./extensions/my-ext.ts",
    "!./extensions/disabled.ts"
  ],
  "packages": [
    "npm:@org/my-extension",
    "git:github.com/user/repo"
  ]
}
```

**通过命令行参数**：

```bash
# 禁用扩展发现，但允许显式 -e 路径
pi --no-extensions

# 临时加载扩展（不安装）
pi -e npm:@foo/bar
pi -e ./local/extension.ts
```

### 加载顺序

1. 全局扩展目录（`~/.pi/agent/extensions/`）
2. 项目扩展目录（`.pi/extensions/`）
3. 全局包（`~/.pi/agent/settings.json` 中的 `packages`）
4. 项目包（`.pi/settings.json` 中的 `packages`）
5. 命令行 `-e` 参数

后加载的扩展可以覆盖或修改先加载的扩展行为。

[Source: pi-mono Extensions Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md)

---

## 热重载

### /reload 命令

在开发扩展时，使用 `/reload` 命令重新加载所有扩展，无需重启 pi：

```bash
# 在 pi 交互模式中
/reload
```

**重载行为**：

- 重新加载所有扩展文件
- 重新注册工具和命令
- 重新订阅事件
- 保留当前会话状态

### ctx.reload() API

扩展可以通过 `ctx.reload()` 触发完整的运行时重载：

```typescript
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.registerCommand("reload-config", {
    description: "Reload configuration and restart",
    handler: async (args, ctx) => {
      // 重新加载配置
      await loadConfig();

      // 触发运行时重载
      ctx.reload();
    }
  });
}
```

**使用场景**：

- 热重载配置文件
- 重启代理
- 应用配置更改

[Source: pi-mono CHANGELOG 0.52.9](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md)

---

## 部署策略

### 开发环境

**本地开发**：

```bash
# 1. 创建扩展目录
mkdir -p ~/.pi/agent/extensions/my-extension

# 2. 创建扩展文件
cat > ~/.pi/agent/extensions/my-extension/index.ts << 'EOF'
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "hello",
    // ...
  });
}
EOF

# 3. 启动 pi（自动加载扩展）
pi

# 4. 修改扩展后重载
# 在 pi 中执行：/reload
```

**项目本地扩展**：

```bash
# 1. 创建项目扩展目录
mkdir -p .pi/extensions

# 2. 创建扩展文件
cat > .pi/extensions/project-ext.ts << 'EOF'
// 项目特定扩展
EOF

# 3. 添加到 .gitignore（如果不想提交）
echo ".pi/extensions/" >> .gitignore

# 或者提交到版本控制（团队共享）
git add .pi/extensions/
git commit -m "Add project extensions"
```

### 生产环境

**npm 包发布**：

```bash
# 1. 创建包结构
mkdir my-pi-extension
cd my-pi-extension

# 2. 初始化 package.json
npm init -y

# 3. 添加 pi 清单
cat > package.json << 'EOF'
{
  "name": "@org/my-extension",
  "version": "1.0.0",
  "keywords": ["pi-package"],
  "pi": {
    "extensions": ["./extensions"]
  },
  "peerDependencies": {
    "@mariozechner/pi-coding-agent": "*"
  }
}
EOF

# 4. 创建扩展
mkdir extensions
cat > extensions/index.ts << 'EOF'
// 扩展实现
EOF

# 5. 发布到 npm
npm publish

# 6. 用户安装
pi install npm:@org/my-extension
```

**git 仓库部署**：

```bash
# 1. 创建 git 仓库
git init my-pi-extension
cd my-pi-extension

# 2. 创建包结构（同上）

# 3. 推送到 GitHub
git remote add origin git@github.com:user/my-extension.git
git push -u origin main

# 4. 用户安装
pi install git:github.com/user/my-extension@v1.0.0
```

### 团队共享

**项目配置共享**：

```bash
# 1. 创建项目配置
cat > .pi/settings.json << 'EOF'
{
  "packages": [
    "npm:@org/team-extensions",
    "git:github.com/org/internal-tools"
  ]
}
EOF

# 2. 提交到版本控制
git add .pi/settings.json
git commit -m "Add team extensions"

# 3. 团队成员克隆后自动安装
git clone <repo>
cd <repo>
pi  # 自动安装缺失的包
```

[Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)

---

## 最佳实践

### 配置管理

**全局 vs 项目配置**：

```
✅ 全局配置：
- 个人偏好（主题、UI 设置）
- 通用工具和技能
- API 密钥和认证

✅ 项目配置：
- 项目特定扩展
- 团队共享工具
- 项目特定设置
```

**配置分离**：

```json
// ~/.pi/agent/settings.json（个人）
{
  "theme": "dark",
  "defaultProvider": "anthropic",
  "packages": ["pi-skills"]
}

// .pi/settings.json（团队）
{
  "packages": [
    "npm:@org/team-extensions"
  ],
  "extensions": [
    "./extensions/project-specific.ts"
  ]
}
```

### 包管理

**版本固定**：

```bash
# ✅ 生产环境：固定版本
pi install npm:@foo/bar@1.2.3
pi install git:github.com/user/repo@v1.0.0

# ❌ 开发环境：使用最新版本
pi install npm:@foo/bar
pi install git:github.com/user/repo
```

**依赖隔离**：

```json
{
  "dependencies": {
    "axios": "^1.0.0"
  },
  "bundledDependencies": ["axios"],
  "pi": {
    "extensions": ["./extensions"]
  }
}
```

每个包有独立的模块根，避免依赖冲突。

### 安全考虑

**审查第三方包**：

```bash
# ⚠️ 安装前审查源代码
git clone https://github.com/user/extension
cd extension
# 审查代码
cat extensions/index.ts

# ✅ 确认安全后安装
pi install git:github.com/user/extension
```

**权限控制**：

- 扩展以完整系统权限运行
- 可以执行任意代码
- 仅从信任的来源安装

[Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)

---

## 常见问题

### 扩展未加载

**问题**：扩展文件存在但未加载

**解决方案**：

```bash
# 1. 检查文件位置
ls -la ~/.pi/agent/extensions/
ls -la .pi/extensions/

# 2. 检查 settings.json
cat ~/.pi/agent/settings.json
cat .pi/settings.json

# 3. 检查扩展语法
# 扩展必须导出默认函数
cat > test.ts << 'EOF'
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  // 正确
}
EOF

# 4. 重载扩展
pi
/reload
```

### 包安装失败

**问题**：`pi install` 失败

**解决方案**：

```bash
# npm 包：检查包名和版本
npm view @foo/bar versions

# git 包：检查仓库 URL 和权限
git clone git@github.com:user/repo.git

# 本地路径：检查路径是否存在
ls -la /path/to/package
```

### 配置冲突

**问题**：全局和项目配置冲突

**解决方案**：

```json
// 项目配置覆盖全局配置
// 使用项目配置禁用全局包
{
  "packages": []  // 清空全局包
}

// 或者使用过滤器
{
  "packages": [
    {
      "source": "npm:global-pkg",
      "extensions": []  // 禁用扩展
    }
  ]
}
```

---

## 总结

### 核心要点

1. **settings.json**：全局配置 + 项目配置，嵌套对象合并
2. **包管理**：npm、git、本地路径三种来源
3. **扩展加载**：自动发现 + 手动配置
4. **热重载**：/reload 命令和 ctx.reload() API
5. **部署策略**：开发环境、生产环境、团队共享

### 关键约束

- ✅ 项目配置覆盖全局配置
- ✅ 固定版本用于生产环境
- ✅ 审查第三方包源代码
- ✅ 使用 /reload 热重载扩展
- ✅ 团队共享通过项目配置

### 下一步

- 阅读 [07_实战代码_05_基础Extension开发](./07_实战代码_05_基础Extension开发.md) 查看扩展开发实战
- 阅读 [07_实战代码_08_生产环境部署](./07_实战代码_08_生产环境部署.md) 查看部署实战

---

**参考资源**：
- [Source: pi-mono Settings Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/settings.md)
- [Source: pi-mono Packages Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/packages.md)
- [Source: pi-mono CHANGELOG](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/CHANGELOG.md)
