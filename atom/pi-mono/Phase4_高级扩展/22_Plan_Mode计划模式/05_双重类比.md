# 双重类比

> **核心理念：** 通过 TypeScript/Node.js 类比和日常生活类比，帮助理解 Plan Mode 的核心概念。

---

## 类比 1：Plan Mode 是什么？

### TypeScript/Node.js 类比

**Plan Mode 就像 TypeScript 的类型检查阶段**

```typescript
// 编译时（Plan Mode）：只检查类型，不执行代码
function add(a: number, b: number): number {
  return a + b; // 类型检查通过
}

// 运行时（Execute Mode）：实际执行代码
const result = add(1, 2); // 返回 3
```

**关键相似点：**
- **Plan Mode**：只读探索，不修改文件
- **TypeScript 编译**：只检查类型，不执行代码
- **Execute Mode**：实际修改文件
- **JavaScript 运行**：实际执行代码

### 日常生活类比

**Plan Mode 就像建筑师画图纸**

- **规划阶段（Plan Mode）**：
  - 建筑师画图纸
  - 标注尺寸、材料、结构
  - 不动一砖一瓦
  - 可以随时修改图纸

- **执行阶段（Execute Mode）**：
  - 工人按图纸施工
  - 实际搬砖、浇筑、装修
  - 修改成本高
  - 需要严格按计划执行

**关键洞察：** 规划阶段的错误成本低，执行阶段的错误成本高。

---

## 类比 2：为什么不是内置功能？

### TypeScript/Node.js 类比

**Pi-mono 的设计哲学就像 Unix 哲学**

```bash
# Unix 哲学：小工具组合
cat file.txt | grep "error" | wc -l

# Pi-mono 哲学：扩展组合
api.tools.read() | planMode() | execute()
```

**对比：**

| 工具 | 哲学 | 例子 |
|------|------|------|
| **Pi-mono** | 提供原语，用户组合 | `write()`, `read()`, `setState()` |
| **Claude Code** | 提供完整功能 | 内置 Plan Mode |
| **Unix** | 小工具组合 | `cat`, `grep`, `wc` |
| **Windows** | 大型应用 | Word, Excel |

**关键洞察：** 原语可组合，功能难组合。

### 日常生活类比

**Pi-mono 就像乐高积木，Claude Code 就像成品玩具**

- **乐高积木（Pi-mono）**：
  - 提供基本积木块
  - 用户自由组合
  - 可以搭建任何东西
  - 需要创造力

- **成品玩具（Claude Code）**：
  - 提供完整玩具
  - 开箱即用
  - 功能固定
  - 简单方便

**关键洞察：** 灵活性 vs. 便利性的权衡。

---

## 类比 3：文件式规划

### TypeScript/Node.js 类比

**文件式规划就像 package.json**

```json
// package.json：项目的"计划文件"
{
  "name": "my-project",
  "version": "1.0.0",
  "scripts": {
    "build": "tsc",
    "test": "jest",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "express": "^4.18.0"
  }
}
```

**关键相似点：**
- **Plan 文件**：存储计划内容
- **package.json**：存储项目配置
- **都是文本文件**：可以手动编辑
- **都可版本控制**：用 Git 追踪变化

### 日常生活类比

**文件式规划就像购物清单**

- **写购物清单**：
  - 用纸笔写下要买的东西
  - 可以随时添加、删除
  - 可以给家人看
  - 去超市时带着清单

- **文件式规划**：
  - 用文本文件写下计划
  - 可以随时修改
  - 可以与团队分享
  - 执行时参考计划

**关键洞察：** 简单、直观、可共享。

---

## 类比 4：扩展式规划

### TypeScript/Node.js 类比

**扩展式规划就像 Express 中间件**

```typescript
// Express 中间件：扩展功能
app.use(logger);      // 日志中间件
app.use(auth);        // 认证中间件
app.use(planMode);    // 规划模式中间件

// Pi-mono 扩展：扩展功能
api.registerCommand('plan', planHandler);
api.registerCommand('execute', executeHandler);
```

**关键相似点：**
- **扩展**：添加新功能
- **中间件**：拦截请求，添加功能
- **可组合**：多个扩展/中间件组合
- **可插拔**：可以启用/禁用

### 日常生活类比

**扩展式规划就像手机 App**

- **手机系统（Pi-mono 核心）**：
  - 提供基本功能：打电话、发短信
  - 保持简单、稳定

- **App（扩展）**：
  - 添加新功能：微信、支付宝、地图
  - 用户选择安装
  - 可以卸载

**关键洞察：** 核心简单，功能丰富。

---

## 类比 5：Session 状态管理

### TypeScript/Node.js 类比

**Session 就像 Git 分支**

```bash
# Git 分支：隔离开发
git checkout -b feature/plan-mode  # 创建分支
git commit -m "Add plan"           # 提交变更
git checkout main                  # 切换回主分支
git merge feature/plan-mode        # 合并分支

# Pi-mono Session：隔离状态
api.createSession({ labels: ['planning'] })  # 创建 Session
api.addSessionEntry(...)                     # 添加记录
api.switchSession(mainSessionId)             # 切换 Session
mergeSessions(planSession, mainSession)      # 合并 Session
```

**关键相似点：**
- **Session**：隔离状态
- **Git 分支**：隔离代码
- **可切换**：在不同 Session/分支间切换
- **可合并**：合并 Session/分支

### 日常生活类比

**Session 就像笔记本的不同章节**

- **笔记本（Pi-mono）**：
  - 第一章：项目 A 的规划
  - 第二章：项目 B 的规划
  - 第三章：项目 C 的规划

- **Session**：
  - Session 1：项目 A 的状态
  - Session 2：项目 B 的状态
  - Session 3：项目 C 的状态

**关键洞察：** 隔离、组织、易于管理。

---

## 类比 6：CustomEntry（自定义条目）

### TypeScript/Node.js 类比

**CustomEntry 就像 Git commit**

```bash
# Git commit：记录变更
git commit -m "Add user authentication"
git commit -m "Fix login bug"
git commit -m "Update README"

# CustomEntry：记录事件
api.addSessionEntry({
  type: 'system',
  content: 'Entered plan mode',
  timestamp: Date.now()
});
```

**关键相似点：**
- **CustomEntry**：记录事件
- **Git commit**：记录变更
- **时间戳**：记录时间
- **可追溯**：查看历史

### 日常生活类比

**CustomEntry 就像日记**

- **写日记**：
  - 2026-02-21 10:00：开始规划
  - 2026-02-21 10:30：完成任务分解
  - 2026-02-21 11:00：批准计划

- **CustomEntry**：
  - Entry 1：Entered plan mode
  - Entry 2：Created 4 tasks
  - Entry 3：Plan approved

**关键洞察：** 记录、追溯、审计。

---

## 类比 7：Labels（标签系统）

### TypeScript/Node.js 类比

**Labels 就像 npm tags**

```bash
# npm tags：标记版本
npm publish --tag latest
npm publish --tag beta
npm publish --tag deprecated

# Pi-mono labels：标记 Session
api.addSessionLabel(sessionId, 'active');
api.addSessionLabel(sessionId, 'approved');
api.addSessionLabel(sessionId, 'archived');
```

**关键相似点：**
- **Labels**：分类 Session
- **npm tags**：分类版本
- **可查询**：按标签查找
- **可批量操作**：对带特定标签的对象批量操作

### 日常生活类比

**Labels 就像文件夹标签**

- **文件夹标签**：
  - 红色标签：紧急
  - 黄色标签：待处理
  - 绿色标签：已完成

- **Session Labels**：
  - `active`：活跃
  - `draft`：草稿
  - `completed`：已完成

**关键洞察：** 分类、查找、管理。

---

## 类比 8：工具控制（disableTools / enableTools）

### TypeScript/Node.js 类比

**工具控制就像文件权限**

```bash
# 文件权限：控制访问
chmod 444 file.txt  # 只读
chmod 644 file.txt  # 可读写

# Pi-mono 工具控制：控制操作
api.disableTools(['write', 'edit']);  # 只读模式
api.enableTools(['write', 'edit']);   # 可读写模式
```

**关键相似点：**
- **工具控制**：控制代理能做什么
- **文件权限**：控制用户能做什么
- **安全性**：防止意外修改
- **可切换**：根据模式切换权限

### 日常生活类比

**工具控制就像驾驶模式**

- **自动驾驶模式（Execute Mode）**：
  - 车辆可以加速、刹车、转向
  - 完全控制

- **巡航模式（Plan Mode）**：
  - 车辆只能保持速度
  - 不能转向、变道
  - 安全、可预测

**关键洞察：** 限制操作，提高安全性。

---

## 类比 9：事件处理（on / emit）

### TypeScript/Node.js 类比

**事件处理就像 EventEmitter**

```typescript
// Node.js EventEmitter
const emitter = new EventEmitter();

emitter.on('plan:entered', (data) => {
  console.log('Entered plan mode:', data);
});

emitter.emit('plan:entered', { task: 'auth system' });

// Pi-mono 事件处理
api.on('plan:entered', (data) => {
  console.log('Entered plan mode:', data);
});

api.emit('plan:entered', { task: 'auth system' });
```

**关键相似点：**
- **事件监听**：注册处理器
- **事件触发**：发送事件
- **解耦**：发送者和接收者解耦
- **异步**：事件处理异步执行

### 日常生活类比

**事件处理就像闹钟**

- **设置闹钟（监听事件）**：
  - 早上 7:00 响铃
  - 提醒起床

- **闹钟响起（触发事件）**：
  - 发出声音
  - 执行预设动作

**关键洞察：** 自动化、响应式。

---

## 类比 10：状态持久化

### TypeScript/Node.js 类比

**状态持久化就像数据库**

```typescript
// 数据库：持久化数据
await db.save({ mode: 'plan', task: 'auth system' });
const state = await db.load();

// Pi-mono 状态持久化：持久化状态
await api.setState({ mode: 'plan', task: 'auth system' });
const state = api.getState();
```

**关键相似点：**
- **持久化**：数据不会丢失
- **自动保存**：状态自动保存到文件
- **恢复**：重启后恢复状态
- **版本控制**：可以用 Git 追踪

### 日常生活类比

**状态持久化就像书签**

- **读书时放书签**：
  - 记录当前页码
  - 下次打开书时，从书签处继续

- **Pi-mono 状态持久化**：
  - 记录当前状态
  - 重启后，从上次状态继续

**关键洞察：** 连续性、可恢复。

---

## 类比总结表

| 概念 | TypeScript/Node.js 类比 | 日常生活类比 |
|------|------------------------|-------------|
| **Plan Mode** | TypeScript 类型检查 | 建筑师画图纸 |
| **极简哲学** | Unix 哲学（小工具组合） | 乐高积木 |
| **文件式规划** | package.json | 购物清单 |
| **扩展式规划** | Express 中间件 | 手机 App |
| **Session** | Git 分支 | 笔记本章节 |
| **CustomEntry** | Git commit | 日记 |
| **Labels** | npm tags | 文件夹标签 |
| **工具控制** | 文件权限 | 驾驶模式 |
| **事件处理** | EventEmitter | 闹钟 |
| **状态持久化** | 数据库 | 书签 |

---

## 深度类比：完整工作流

### TypeScript/Node.js 类比

**完整的 Plan Mode 工作流就像 CI/CD 流程**

```yaml
# CI/CD 流程
stages:
  - plan:      # 规划阶段
      - lint
      - type-check
      - test
  - execute:   # 执行阶段
      - build
      - deploy

# Pi-mono Plan Mode 工作流
stages:
  - plan:      # 规划阶段
      - read codebase
      - analyze requirements
      - create plan
  - execute:   # 执行阶段
      - write code
      - run tests
      - commit changes
```

**关键相似点：**
1. **分阶段**：规划和执行分离
2. **门控**：规划通过后才能执行
3. **可回滚**：执行失败可以回到规划
4. **可追踪**：每个阶段都有记录

### 日常生活类比

**完整的 Plan Mode 工作流就像做菜**

**规划阶段（Plan Mode）：**
1. **看菜谱**：了解需要做什么
2. **列清单**：列出需要的食材
3. **检查库存**：看看家里有什么
4. **规划步骤**：确定做菜顺序

**执行阶段（Execute Mode）：**
1. **买食材**：去超市购买
2. **洗切**：清洗、切配
3. **烹饪**：炒、煮、炖
4. **上菜**：装盘、上桌

**关键洞察：**
- 规划阶段不动刀，执行阶段才动刀
- 规划错了可以重新规划，执行错了食材浪费
- 规划充分，执行顺利

---

## 反向类比：什么不是 Plan Mode？

### TypeScript/Node.js 反向类比

**Plan Mode 不是：**

❌ **不是 Dry Run**
```bash
# Dry run：模拟执行，但不实际执行
npm install --dry-run

# Plan Mode：只读探索，不是模拟执行
```

❌ **不是 Transaction**
```typescript
// Transaction：可以回滚
await db.transaction(async (tx) => {
  await tx.insert(...);
  await tx.update(...);
  // 如果失败，自动回滚
});

// Plan Mode：不是事务，是规划
```

❌ **不是 Preview**
```typescript
// Preview：预览结果
const preview = generatePreview(data);

// Plan Mode：不是预览，是规划
```

### 日常生活反向类比

**Plan Mode 不是：**

❌ **不是试穿衣服**
- 试穿：实际穿上，看效果
- Plan Mode：不实际执行，只规划

❌ **不是试吃**
- 试吃：实际吃，尝味道
- Plan Mode：不实际执行，只规划

❌ **不是试驾**
- 试驾：实际开车，体验性能
- Plan Mode：不实际执行，只规划

**关键洞察：** Plan Mode 是规划，不是模拟执行或预览。

---

## 类比应用：选择实现方式

### TypeScript/Node.js 类比

| 实现方式 | 类比 | 适用场景 |
|---------|------|----------|
| **文件式** | 直接写 JSON 文件 | 快速原型 |
| **扩展式** | 创建 npm 包 | 频繁使用 |
| **Session 集成** | 使用数据库 | 复杂项目 |

### 日常生活类比

| 实现方式 | 类比 | 适用场景 |
|---------|------|----------|
| **文件式** | 用纸笔记录 | 简单任务 |
| **扩展式** | 用手机 App | 频繁使用 |
| **Session 集成** | 用专业软件 | 复杂项目 |

---

## 参考资源

### 官方资源

- [Pi-mono GitHub](https://github.com/badlogic/pi-mono)
- [Extension API Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md)

### 研究资料

- `temp/03_grok_pi_mono_extensions.md` - Pi-mono 扩展 API
- `temp/04_grok_pi_mono_examples.md` - Pi-mono 扩展示例

---

## 下一步

- **06_反直觉点.md**：学习 Plan Mode 的反直觉设计决策
- **07_实战代码_*.md**：查看完整的可运行代码示例
