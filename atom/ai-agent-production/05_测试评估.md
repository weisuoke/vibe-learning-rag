# 测试与评估体系

**知识点数**: 8个 | **学习时长**: 1周 | **优先级**: P1

---

## 概览

**为什么重要**: "Evaluation frameworks" 是企业采用AI的关键。

**核心内容**: 单元测试 → 集成测试 → 端到端测试 → 性能测试 → CI/CD集成

---

## 核心知识点

### 01_单元测试策略

**核心概念**: Agent组件级别的测试。

**实战代码**:
```python
import pytest
from unittest.mock import Mock, patch

class TestAgent:
    @pytest.fixture
    def mock_llm(self):
        llm = Mock()
        llm.complete.return_value = "Mocked response"
        return llm

    def test_agent_run(self, mock_llm):
        agent = Agent(llm=mock_llm)
        result = agent.run("test query")

        assert result == "Mocked response"
        mock_llm.complete.assert_called_once()

    def test_agent_with_tools(self, mock_llm):
        tool = Mock()
        tool.run.return_value = "Tool result"

        agent = Agent(llm=mock_llm, tools=[tool])
        result = agent.run("use tool")

        tool.run.assert_called()
```

---

### 02_集成测试

**核心概念**: 多组件协作测试。

**实战代码**:
```python
@pytest.mark.integration
class TestAgentIntegration:
    def test_agent_with_rag(self):
        # 使用真实的向量数据库
        vectorstore = ChromaDB()
        retriever = Retriever(vectorstore)
        agent = RAGAgent(retriever=retriever)

        result = agent.run("What is RAG?")
        assert "retrieval" in result.lower()

    def test_multi_agent_collaboration(self):
        researcher = ResearchAgent()
        writer = WriterAgent()

        research_result = researcher.run("AI trends")
        article = writer.run(f"Write about: {research_result}")

        assert len(article) > 100
```

---

### 03_端到端测试

**核心概念**: 完整用户场景测试。

**实战代码**:
```python
from fastapi.testclient import TestClient

@pytest.mark.e2e
class TestE2E:
    def test_complete_workflow(self):
        client = TestClient(app)

        # 1. 创建会话
        response = client.post("/sessions", json={"user_id": "test"})
        session_id = response.json()["session_id"]

        # 2. 发送查询
        response = client.post(
            f"/sessions/{session_id}/query",
            json={"query": "What is AI?"}
        )
        assert response.status_code == 200

        # 3. 获取历史
        response = client.get(f"/sessions/{session_id}/history")
        assert len(response.json()["messages"]) > 0
```

---

### 04_性能基准测试

**核心概念**: 量化性能指标。

**实战代码**:
```python
import time
from locust import HttpUser, task, between

class AgentLoadTest(HttpUser):
    wait_time = between(1, 3)

    @task
    def query_agent(self):
        self.client.post("/agent/run", json={
            "query": "What is machine learning?"
        })

# 运行: locust -f test_load.py --host=http://localhost:8000
```

**性能指标**:
```python
class PerformanceMetrics:
    def measure_latency(self, func, iterations=100):
        latencies = []
        for _ in range(iterations):
            start = time.time()
            func()
            latencies.append(time.time() - start)

        return {
            "p50": np.percentile(latencies, 50),
            "p95": np.percentile(latencies, 95),
            "p99": np.percentile(latencies, 99),
            "mean": np.mean(latencies)
        }
```

---

### 05_回归测试自动化

**核心概念**: 防止功能退化。

**实战代码**:
```python
import json

class RegressionTest:
    def __init__(self):
        self.baseline = self.load_baseline()

    def load_baseline(self):
        with open("baseline_results.json") as f:
            return json.load(f)

    def test_against_baseline(self, test_cases):
        results = []
        for case in test_cases:
            current = agent.run(case["query"])
            baseline = self.baseline[case["id"]]

            similarity = self.calculate_similarity(current, baseline)
            results.append({
                "case_id": case["id"],
                "similarity": similarity,
                "passed": similarity > 0.8
            })

        return results
```

---

### 06_测试数据生成

**核心概念**: 生成多样化测试数据。

**实战代码**:
```python
from faker import Faker
from hypothesis import given, strategies as st

fake = Faker()

class TestDataGenerator:
    def generate_queries(self, count=100):
        return [fake.sentence() for _ in range(count)]

    def generate_edge_cases(self):
        return [
            "",  # 空查询
            "a" * 10000,  # 超长查询
            "🔥" * 100,  # 特殊字符
            "\n\n\n",  # 只有换行
        ]

# 使用Hypothesis进行属性测试
@given(st.text(min_size=1, max_size=1000))
def test_agent_handles_any_text(query):
    result = agent.run(query)
    assert isinstance(result, str)
```

---

### 07_Mock与Stub策略

**核心概念**: 隔离测试环境。

**实战代码**:
```python
from unittest.mock import Mock, patch
import responses

# Mock LLM
@patch('openai.ChatCompletion.create')
def test_with_mock_llm(mock_create):
    mock_create.return_value = {
        "choices": [{"message": {"content": "Mocked response"}}]
    }
    result = agent.run("test")
    assert result == "Mocked response"

# Mock HTTP请求
@responses.activate
def test_with_mock_api():
    responses.add(
        responses.POST,
        "https://api.example.com/search",
        json={"results": ["result1", "result2"]},
        status=200
    )

    result = search_tool.run("query")
    assert len(result) == 2
```

---

### 08_CI/CD集成

**核心概念**: 自动化测试流程。

**GitHub Actions配置**:
```yaml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest tests/ --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

---

## 核心20%（3个知识点）

1. ⭐⭐⭐ **单元测试策略**
2. ⭐⭐⭐ **Mock与Stub策略**
3. ⭐⭐⭐ **CI/CD集成**

---

## 实战项目

### 项目: 完整测试套件

**目标**: 为Agent系统建立完整的测试体系。

**测试金字塔**:
```
        /\
       /E2E\      (10%)
      /------\
     /Integration\ (30%)
    /------------\
   /  Unit Tests  \ (60%)
  /----------------\
```

**验收标准**:
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖核心流程
- [ ] 端到端测试覆盖主要场景
- [ ] CI/CD自动运行测试
- [ ] 性能基准测试建立

---

## 学习资源

- [pytest文档](https://docs.pytest.org/)
- [Hypothesis属性测试](https://hypothesis.readthedocs.io/)
- [Locust性能测试](https://locust.io/)

---

## 常见误区

1. ❌ "只测试成功路径" → ✅ 边界和异常更重要
2. ❌ "测试覆盖率越高越好" → ✅ 关注关键路径
3. ❌ "Mock所有外部依赖" → ✅ 集成测试需要真实环境

---

**版本**: v1.0 | **最后更新**: 2026-02-12
