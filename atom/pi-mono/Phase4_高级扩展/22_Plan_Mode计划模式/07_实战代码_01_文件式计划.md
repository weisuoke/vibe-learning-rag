# å®æˆ˜ä»£ç  01ï¼šæ–‡ä»¶å¼è®¡åˆ’

> **æ ¸å¿ƒç†å¿µï¼š** æ–‡ä»¶å¼è§„åˆ’æ˜¯æœ€ç®€å•çš„ Plan Mode å®ç°æ–¹å¼ï¼Œé€šè¿‡ç›´æ¥æ“ä½œæ–‡ä»¶å®ç°è§„åˆ’åŠŸèƒ½ã€‚

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### æ–‡ä»¶ç»“æ„

```
project/
â”œâ”€â”€ .pi/
â”‚   â”œâ”€â”€ plans/
â”‚   â”‚   â”œâ”€â”€ plan-001.md
â”‚   â”‚   â””â”€â”€ plan-002.md
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ plan-template.md
â””â”€â”€ src/
    â””â”€â”€ plan-file.ts
```

### plan-file.tsï¼ˆå®Œæ•´å®ç°ï¼‰

```typescript
/**
 * æ–‡ä»¶å¼è§„åˆ’å®ç°
 *
 * åŠŸèƒ½ï¼š
 * - åˆ›å»ºè®¡åˆ’æ–‡ä»¶
 * - è¯»å–è®¡åˆ’æ–‡ä»¶
 * - æ›´æ–°è®¡åˆ’æ–‡ä»¶
 * - åˆ—å‡ºæ‰€æœ‰è®¡åˆ’
 * - åˆ é™¤è®¡åˆ’æ–‡ä»¶
 */

import { ExtensionAPI } from '@pi/extension-api';
import { readFile, writeFile, readdir, unlink } from 'fs/promises';
import { join } from 'path';

// ============================================================================
// ç±»å‹å®šä¹‰
// ============================================================================

interface Plan {
  id: string;
  goal: string;
  context: string;
  tasks: Task[];
  status: 'draft' | 'approved' | 'executing' | 'completed';
  createdAt: string;
  updatedAt: string;
}

interface Task {
  id: string;
  title: string;
  description: string;
  status: 'pending' | 'in_progress' | 'completed';
  dependencies: string[];
}

// ============================================================================
// æ ¸å¿ƒåŠŸèƒ½
// ============================================================================

/**
 * åˆ›å»ºæ–°è®¡åˆ’
 */
async function createPlan(
  api: ExtensionAPI,
  goal: string,
  context: string = ''
): Promise<Plan> {
  // ç”Ÿæˆè®¡åˆ’ ID
  const planId = `plan-${Date.now()}`;

  // åˆ›å»ºè®¡åˆ’å¯¹è±¡
  const plan: Plan = {
    id: planId,
    goal,
    context,
    tasks: [],
    status: 'draft',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  // ç”Ÿæˆ Markdown å†…å®¹
  const content = generateMarkdown(plan);

  // å†™å…¥æ–‡ä»¶
  const planFile = `.pi/plans/${planId}.md`;
  await api.tools.write(planFile, content);

  console.log(`âœ… Created plan: ${planFile}`);
  return plan;
}

/**
 * è¯»å–è®¡åˆ’
 */
async function readPlan(
  api: ExtensionAPI,
  planId: string
): Promise<Plan> {
  const planFile = `.pi/plans/${planId}.md`;
  const content = await api.tools.read(planFile);

  // è§£æ Markdown å†…å®¹
  const plan = parseMarkdown(content, planId);

  return plan;
}

/**
 * æ›´æ–°è®¡åˆ’
 */
async function updatePlan(
  api: ExtensionAPI,
  planId: string,
  updates: Partial<Plan>
): Promise<Plan> {
  // è¯»å–ç°æœ‰è®¡åˆ’
  const plan = await readPlan(api, planId);

  // åˆå¹¶æ›´æ–°
  const updatedPlan: Plan = {
    ...plan,
    ...updates,
    updatedAt: new Date().toISOString()
  };

  // ç”Ÿæˆæ–°å†…å®¹
  const content = generateMarkdown(updatedPlan);

  // å†™å…¥æ–‡ä»¶
  const planFile = `.pi/plans/${planId}.md`;
  await api.tools.write(planFile, content);

  console.log(`âœ… Updated plan: ${planFile}`);
  return updatedPlan;
}

/**
 * æ·»åŠ ä»»åŠ¡
 */
async function addTask(
  api: ExtensionAPI,
  planId: string,
  task: Omit<Task, 'id'>
): Promise<Plan> {
  // è¯»å–ç°æœ‰è®¡åˆ’
  const plan = await readPlan(api, planId);

  // ç”Ÿæˆä»»åŠ¡ ID
  const taskId = `task-${Date.now()}`;

  // æ·»åŠ ä»»åŠ¡
  const newTask: Task = {
    id: taskId,
    ...task
  };

  plan.tasks.push(newTask);
  plan.updatedAt = new Date().toISOString();

  // ä¿å­˜è®¡åˆ’
  const content = generateMarkdown(plan);
  const planFile = `.pi/plans/${planId}.md`;
  await api.tools.write(planFile, content);

  console.log(`âœ… Added task ${taskId} to plan ${planId}`);
  return plan;
}

/**
 * æ›´æ–°ä»»åŠ¡çŠ¶æ€
 */
async function updateTaskStatus(
  api: ExtensionAPI,
  planId: string,
  taskId: string,
  status: Task['status']
): Promise<Plan> {
  // è¯»å–ç°æœ‰è®¡åˆ’
  const plan = await readPlan(api, planId);

  // æŸ¥æ‰¾å¹¶æ›´æ–°ä»»åŠ¡
  const task = plan.tasks.find(t => t.id === taskId);
  if (!task) {
    throw new Error(`Task ${taskId} not found in plan ${planId}`);
  }

  task.status = status;
  plan.updatedAt = new Date().toISOString();

  // ä¿å­˜è®¡åˆ’
  const content = generateMarkdown(plan);
  const planFile = `.pi/plans/${planId}.md`;
  await api.tools.write(planFile, content);

  console.log(`âœ… Updated task ${taskId} status to ${status}`);
  return plan;
}

/**
 * åˆ—å‡ºæ‰€æœ‰è®¡åˆ’
 */
async function listPlans(api: ExtensionAPI): Promise<Plan[]> {
  const plansDir = '.pi/plans';

  // è¯»å–ç›®å½•
  const files = await readdir(plansDir);

  // è¿‡æ»¤ .md æ–‡ä»¶
  const planFiles = files.filter(f => f.endsWith('.md'));

  // è¯»å–æ‰€æœ‰è®¡åˆ’
  const plans: Plan[] = [];
  for (const file of planFiles) {
    const planId = file.replace('.md', '');
    try {
      const plan = await readPlan(api, planId);
      plans.push(plan);
    } catch (error) {
      console.error(`Failed to read plan ${planId}:`, error);
    }
  }

  // æŒ‰åˆ›å»ºæ—¶é—´æ’åº
  plans.sort((a, b) =>
    new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
  );

  return plans;
}

/**
 * åˆ é™¤è®¡åˆ’
 */
async function deletePlan(
  api: ExtensionAPI,
  planId: string
): Promise<void> {
  const planFile = `.pi/plans/${planId}.md`;
  await unlink(planFile);
  console.log(`âœ… Deleted plan: ${planFile}`);
}

// ============================================================================
// Markdown ç”Ÿæˆä¸è§£æ
// ============================================================================

/**
 * ç”Ÿæˆ Markdown å†…å®¹
 */
function generateMarkdown(plan: Plan): string {
  const statusEmoji = {
    draft: 'ğŸ“',
    approved: 'âœ…',
    executing: 'ğŸ”„',
    completed: 'âœ”ï¸'
  };

  const taskStatusEmoji = {
    pending: 'â³',
    in_progress: 'ğŸ”„',
    completed: 'âœ…'
  };

  return `# Plan: ${plan.goal}

**ID**: ${plan.id}
**Status**: ${statusEmoji[plan.status]} ${plan.status}
**Created**: ${plan.createdAt}
**Updated**: ${plan.updatedAt}

## Goal

${plan.goal}

## Context

${plan.context || 'No context provided'}

## Tasks

${plan.tasks.map((task, index) => `
### Task ${index + 1}: ${task.title}

**ID**: ${task.id}
**Status**: ${taskStatusEmoji[task.status]} ${task.status}
**Dependencies**: ${task.dependencies.length > 0 ? task.dependencies.join(', ') : 'none'}

${task.description}
`).join('\n')}

${plan.tasks.length === 0 ? '- No tasks yet' : ''}

## Progress

- Total tasks: ${plan.tasks.length}
- Completed: ${plan.tasks.filter(t => t.status === 'completed').length}
- In progress: ${plan.tasks.filter(t => t.status === 'in_progress').length}
- Pending: ${plan.tasks.filter(t => t.status === 'pending').length}

---

*Generated by Pi Plan Mode*
`;
}

/**
 * è§£æ Markdown å†…å®¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
 */
function parseMarkdown(content: string, planId: string): Plan {
  // æå–åŸºæœ¬ä¿¡æ¯
  const goalMatch = content.match(/# Plan: (.+)/);
  const statusMatch = content.match(/\*\*Status\*\*: .+ (.+)/);
  const createdMatch = content.match(/\*\*Created\*\*: (.+)/);
  const updatedMatch = content.match(/\*\*Updated\*\*: (.+)/);

  // æå– Context
  const contextMatch = content.match(/## Context\n\n(.+?)\n\n## Tasks/s);

  // æå– Tasksï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥æ›´å¤æ‚ï¼‰
  const tasks: Task[] = [];
  const taskMatches = content.matchAll(/### Task \d+: (.+)\n\n\*\*ID\*\*: (.+)\n\*\*Status\*\*: .+ (.+)\n\*\*Dependencies\*\*: (.+)\n\n(.+?)(?=\n###|\n##|$)/gs);

  for (const match of taskMatches) {
    tasks.push({
      id: match[2].trim(),
      title: match[1].trim(),
      status: match[3].trim() as Task['status'],
      dependencies: match[4].trim() === 'none' ? [] : match[4].split(',').map(d => d.trim()),
      description: match[5].trim()
    });
  }

  return {
    id: planId,
    goal: goalMatch?.[1] || '',
    context: contextMatch?.[1] || '',
    tasks,
    status: (statusMatch?.[1] as Plan['status']) || 'draft',
    createdAt: createdMatch?.[1] || new Date().toISOString(),
    updatedAt: updatedMatch?.[1] || new Date().toISOString()
  };
}

// ============================================================================
// ä½¿ç”¨ç¤ºä¾‹
// ============================================================================

/**
 * ç¤ºä¾‹ï¼šåˆ›å»ºå¹¶ç®¡ç†è®¡åˆ’
 */
async function example(api: ExtensionAPI) {
  // 1. åˆ›å»ºè®¡åˆ’
  const plan = await createPlan(
    api,
    'Implement user authentication system',
    'Current system has no authentication. Need to add JWT-based auth.'
  );

  console.log('Created plan:', plan.id);

  // 2. æ·»åŠ ä»»åŠ¡
  await addTask(api, plan.id, {
    title: 'Design database schema',
    description: 'Create users table with id, email, password_hash',
    status: 'pending',
    dependencies: []
  });

  await addTask(api, plan.id, {
    title: 'Implement registration API',
    description: 'POST /api/auth/register endpoint',
    status: 'pending',
    dependencies: ['task-001']
  });

  await addTask(api, plan.id, {
    title: 'Implement login API',
    description: 'POST /api/auth/login endpoint with JWT',
    status: 'pending',
    dependencies: ['task-001']
  });

  // 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
  await updateTaskStatus(api, plan.id, 'task-001', 'completed');
  await updateTaskStatus(api, plan.id, 'task-002', 'in_progress');

  // 4. æ›´æ–°è®¡åˆ’çŠ¶æ€
  await updatePlan(api, plan.id, {
    status: 'executing'
  });

  // 5. åˆ—å‡ºæ‰€æœ‰è®¡åˆ’
  const allPlans = await listPlans(api);
  console.log(`Total plans: ${allPlans.length}`);
  allPlans.forEach(p => {
    console.log(`- ${p.id}: ${p.goal} (${p.status})`);
  });

  // 6. è¯»å–è®¡åˆ’
  const updatedPlan = await readPlan(api, plan.id);
  console.log('Updated plan:', updatedPlan);
}

// ============================================================================
// å¯¼å‡º
// ============================================================================

export {
  Plan,
  Task,
  createPlan,
  readPlan,
  updatePlan,
  addTask,
  updateTaskStatus,
  listPlans,
  deletePlan,
  generateMarkdown,
  parseMarkdown
};
```

---

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```typescript
import { ExtensionAPI } from '@pi/extension-api';
import { createPlan, addTask, updateTaskStatus } from './plan-file';

export default async function(api: ExtensionAPI) {
  // åˆ›å»ºè®¡åˆ’
  const plan = await createPlan(
    api,
    'Build a REST API',
    'Need to create a RESTful API for the mobile app'
  );

  // æ·»åŠ ä»»åŠ¡
  await addTask(api, plan.id, {
    title: 'Design API endpoints',
    description: 'Define all REST endpoints',
    status: 'pending',
    dependencies: []
  });

  // æ›´æ–°ä»»åŠ¡çŠ¶æ€
  await updateTaskStatus(api, plan.id, 'task-001', 'completed');
}
```

### 2. é›†æˆåˆ°æ‰©å±•

```typescript
// ~/.pi/extensions/plan-file/index.ts
import { ExtensionAPI } from '@pi/extension-api';
import { createPlan, listPlans, readPlan } from './plan-file';

export default function(api: ExtensionAPI) {
  // æ³¨å†Œ /plan-create å‘½ä»¤
  api.registerCommand({
    name: 'plan-create',
    description: 'Create a new plan',
    handler: async (args) => {
      const goal = args.join(' ');
      const plan = await createPlan(api, goal);
      return `Created plan: ${plan.id}`;
    }
  });

  // æ³¨å†Œ /plan-list å‘½ä»¤
  api.registerCommand({
    name: 'plan-list',
    description: 'List all plans',
    handler: async () => {
      const plans = await listPlans(api);
      return plans.map(p =>
        `${p.id}: ${p.goal} (${p.status})`
      ).join('\n');
    }
  });

  // æ³¨å†Œ /plan-show å‘½ä»¤
  api.registerCommand({
    name: 'plan-show',
    description: 'Show plan details',
    handler: async (args) => {
      const planId = args[0];
      const plan = await readPlan(api, planId);
      return `Plan: ${plan.goal}\nTasks: ${plan.tasks.length}`;
    }
  });
}
```

---

## æµ‹è¯•ä»£ç 

```typescript
/**
 * æµ‹è¯•æ–‡ä»¶å¼è§„åˆ’
 */
import { ExtensionAPI } from '@pi/extension-api';
import {
  createPlan,
  addTask,
  updateTaskStatus,
  listPlans,
  readPlan
} from './plan-file';

async function testPlanFile(api: ExtensionAPI) {
  console.log('=== Testing File-Based Planning ===\n');

  // Test 1: Create plan
  console.log('Test 1: Create plan');
  const plan = await createPlan(
    api,
    'Test Plan',
    'This is a test plan'
  );
  console.log(`âœ… Created plan: ${plan.id}\n`);

  // Test 2: Add tasks
  console.log('Test 2: Add tasks');
  await addTask(api, plan.id, {
    title: 'Task 1',
    description: 'First task',
    status: 'pending',
    dependencies: []
  });
  await addTask(api, plan.id, {
    title: 'Task 2',
    description: 'Second task',
    status: 'pending',
    dependencies: ['task-001']
  });
  console.log(`âœ… Added 2 tasks\n`);

  // Test 3: Update task status
  console.log('Test 3: Update task status');
  await updateTaskStatus(api, plan.id, 'task-001', 'completed');
  console.log(`âœ… Updated task status\n`);

  // Test 4: Read plan
  console.log('Test 4: Read plan');
  const updatedPlan = await readPlan(api, plan.id);
  console.log(`âœ… Read plan: ${updatedPlan.tasks.length} tasks\n`);

  // Test 5: List plans
  console.log('Test 5: List plans');
  const allPlans = await listPlans(api);
  console.log(`âœ… Found ${allPlans.length} plans\n`);

  console.log('=== All tests passed ===');
}

export { testPlanFile };
```

---

## ä¼˜åŠ¿ä¸åŠ£åŠ¿

### ä¼˜åŠ¿

1. **ç®€å•ç›´æ¥**ï¼šåªéœ€è¦æ–‡ä»¶æ“ä½œï¼Œæ— éœ€å¤æ‚çš„ API
2. **å¯è§‚å¯Ÿæ€§å¼º**ï¼šè®¡åˆ’å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥çœ‹
3. **æ˜“äºç¼–è¾‘**ï¼šç”¨æˆ·å¯ä»¥ç”¨ä»»ä½•ç¼–è¾‘å™¨ç¼–è¾‘è®¡åˆ’
4. **ç‰ˆæœ¬æ§åˆ¶å‹å¥½**ï¼šå¯ä»¥ç”¨ Git è¿½è¸ªè®¡åˆ’å˜åŒ–
5. **æ— ä¾èµ–**ï¼šä¸éœ€è¦æ•°æ®åº“æˆ–å…¶ä»–å¤–éƒ¨æœåŠ¡

### åŠ£åŠ¿

1. **æ—  UI é›†æˆ**ï¼šæ²¡æœ‰å›¾å½¢ç•Œé¢
2. **æ— å¿«æ·é”®**ï¼šéœ€è¦æ‰‹åŠ¨è¾“å…¥å‘½ä»¤
3. **è§£æå¤æ‚**ï¼šMarkdown è§£æå¯èƒ½ä¸å¤Ÿç²¾ç¡®
4. **å¹¶å‘é—®é¢˜**ï¼šå¤šä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹æ–‡ä»¶å¯èƒ½å†²çª
5. **æ€§èƒ½é™åˆ¶**ï¼šå¤§é‡è®¡åˆ’æ—¶æ€§èƒ½å¯èƒ½ä¸‹é™

---

## æœ€ä½³å®è·µ

### 1. æ–‡ä»¶å‘½åè§„èŒƒ

```typescript
// ä½¿ç”¨æ—¶é—´æˆ³ + æè¿°æ€§åç§°
const planId = `plan-${Date.now()}-auth-system`;
```

### 2. ç›®å½•ç»„ç»‡

```
.pi/
â”œâ”€â”€ plans/
â”‚   â”œâ”€â”€ active/          # æ´»è·ƒè®¡åˆ’
â”‚   â”œâ”€â”€ completed/       # å·²å®Œæˆè®¡åˆ’
â”‚   â””â”€â”€ archived/        # å½’æ¡£è®¡åˆ’
â””â”€â”€ templates/
    â””â”€â”€ plan-template.md # è®¡åˆ’æ¨¡æ¿
```

### 3. é”™è¯¯å¤„ç†

```typescript
async function createPlan(api: ExtensionAPI, goal: string): Promise<Plan> {
  try {
    // åˆ›å»ºè®¡åˆ’é€»è¾‘
    const plan = { /* ... */ };
    await api.tools.write(planFile, content);
    return plan;
  } catch (error) {
    console.error('Failed to create plan:', error);
    throw new Error(`Failed to create plan: ${error.message}`);
  }
}
```

### 4. å¤‡ä»½æœºåˆ¶

```typescript
async function backupPlan(api: ExtensionAPI, planId: string): Promise<void> {
  const planFile = `.pi/plans/${planId}.md`;
  const backupFile = `.pi/plans/backups/${planId}-${Date.now()}.md`;

  const content = await api.tools.read(planFile);
  await api.tools.write(backupFile, content);
}
```

---

## æ‰©å±•åŠŸèƒ½

### 1. è®¡åˆ’æ¨¡æ¿

```typescript
async function createPlanFromTemplate(
  api: ExtensionAPI,
  templateName: string,
  goal: string
): Promise<Plan> {
  // è¯»å–æ¨¡æ¿
  const templateFile = `.pi/templates/${templateName}.md`;
  const template = await api.tools.read(templateFile);

  // æ›¿æ¢å ä½ç¬¦
  const content = template
    .replace('{{GOAL}}', goal)
    .replace('{{DATE}}', new Date().toISOString());

  // åˆ›å»ºè®¡åˆ’
  const planId = `plan-${Date.now()}`;
  const planFile = `.pi/plans/${planId}.md`;
  await api.tools.write(planFile, content);

  return readPlan(api, planId);
}
```

### 2. è®¡åˆ’æœç´¢

```typescript
async function searchPlans(
  api: ExtensionAPI,
  query: string
): Promise<Plan[]> {
  const allPlans = await listPlans(api);

  return allPlans.filter(plan =>
    plan.goal.toLowerCase().includes(query.toLowerCase()) ||
    plan.context.toLowerCase().includes(query.toLowerCase())
  );
}
```

### 3. è®¡åˆ’ç»Ÿè®¡

```typescript
async function getPlanStats(api: ExtensionAPI): Promise<{
  total: number;
  byStatus: Record<Plan['status'], number>;
  totalTasks: number;
  completedTasks: number;
}> {
  const plans = await listPlans(api);

  const stats = {
    total: plans.length,
    byStatus: {
      draft: 0,
      approved: 0,
      executing: 0,
      completed: 0
    },
    totalTasks: 0,
    completedTasks: 0
  };

  plans.forEach(plan => {
    stats.byStatus[plan.status]++;
    stats.totalTasks += plan.tasks.length;
    stats.completedTasks += plan.tasks.filter(t => t.status === 'completed').length;
  });

  return stats;
}
```

---

## å‚è€ƒèµ„æº

### å®˜æ–¹èµ„æº

- [Pi-mono GitHub](https://github.com/badlogic/pi-mono)
- [Extension API Documentation](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/extensions.md)

### ç ”ç©¶èµ„æ–™

- `temp/03_grok_pi_mono_extensions.md` - Pi-mono æ‰©å±• API
- `temp/04_grok_pi_mono_examples.md` - Pi-mono æ‰©å±•ç¤ºä¾‹

---

## ä¸‹ä¸€æ­¥

- **07_å®æˆ˜ä»£ç _02_Extensionå‘½ä»¤å®ç°.md**ï¼šå­¦ä¹ å¦‚ä½•é€šè¿‡æ‰©å±•å‘½ä»¤å®ç° Plan Mode
- **03_æ ¸å¿ƒæ¦‚å¿µ_01_Planè¡¨ç¤ºä¸æ–‡ä»¶å­˜å‚¨.md**ï¼šæ·±å…¥ç†è§£æ–‡ä»¶å­˜å‚¨æ¨¡å¼
