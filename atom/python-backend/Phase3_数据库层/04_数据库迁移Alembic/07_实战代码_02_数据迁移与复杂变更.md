# 实战代码 - 场景2：数据迁移与复杂变更

**本场景演示 Alembic 的数据迁移和复杂 schema 变更，包括字段重命名、类型转换、数据清洗等高级操作。**

---

## 场景概述

**目标：** 在 AI Agent 后端项目中，重构用户表和对话历史表，涉及字段重命名、数据迁移、表关系调整。

**技术栈：**
- Python 3.13+
- FastAPI
- SQLAlchemy 2.0
- PostgreSQL 14+
- Alembic

---

## 完整代码示例

### 场景1：字段重命名（保留数据）

**需求：** 将 `users.username` 重命名为 `users.display_name`

```python
# app/models/user.py
"""
用户模型（重命名字段）
"""
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from datetime import datetime

from app.core.database import Base

class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    display_name = Column(String, unique=True, index=True, nullable=False)  # 重命名：username -> display_name
    hashed_password = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
```

```bash
# 1. 运行 autogenerate（会生成错误的迁移）
alembic revision --autogenerate -m "rename username to display_name"

# autogenerate 会生成：
# - op.drop_column('users', 'username')
# - op.add_column('users', sa.Column('display_name', sa.String()))
# 问题：数据会丢失！
```

**手动编辑迁移脚本：**

```python
# alembic/versions/20260211_1500_abc123_rename_username_to_display_name.py
"""rename username to display_name

Revision ID: abc123def456
Revises: previous_revision
Create Date: 2026-02-11 15:00:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'abc123def456'
down_revision = 'previous_revision'
branch_labels = None
depends_on = None

def upgrade():
    """重命名字段（保留数据）"""
    # 方式1：直接重命名（PostgreSQL）
    op.alter_column('users', 'username', new_column_name='display_name')

    # 注意：索引名称也需要更新
    op.drop_index('ix_users_username', table_name='users')
    op.create_index('ix_users_display_name', 'users', ['display_name'], unique=True)

def downgrade():
    """回滚：重命名回去"""
    op.drop_index('ix_users_display_name', table_name='users')
    op.create_index('ix_users_username', 'users', ['username'], unique=True)
    op.alter_column('users', 'display_name', new_column_name='username')
```

```bash
# 应用迁移
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Running upgrade previous_revision -> abc123def456, rename username to display_name

# 验证数据保留
psql -U user -d ai_agent_db -c "SELECT id, display_name FROM users LIMIT 5;"
```

---

### 场景2：字段类型转换（带数据迁移）

**需求：** 将 `users.age` 从 `String` 改为 `Integer`

```python
# app/models/user.py
class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String, nullable=False)
    age = Column(Integer)  # 从 String 改为 Integer
```

```bash
# 创建手动迁移
alembic revision -m "change age type from string to integer"
```

**手动编写迁移脚本：**

```python
# alembic/versions/20260211_1510_def456_change_age_type.py
"""change age type from string to integer

Revision ID: def456ghi789
Revises: abc123def456
Create Date: 2026-02-11 15:10:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'def456ghi789'
down_revision = 'abc123def456'
branch_labels = None
depends_on = None

def upgrade():
    """将 age 从 String 转换为 Integer"""
    # 步骤1：添加临时字段
    op.add_column('users', sa.Column('age_new', sa.Integer(), nullable=True))

    # 步骤2：迁移数据（处理无效值）
    op.execute("""
        UPDATE users
        SET age_new = CASE
            WHEN age ~ '^[0-9]+$' THEN CAST(age AS INTEGER)  -- 有效数字
            ELSE NULL  -- 无效值设为 NULL
        END
        WHERE age IS NOT NULL
    """)

    # 步骤3：删除旧字段
    op.drop_column('users', 'age')

    # 步骤4：重命名新字段
    op.alter_column('users', 'age_new', new_column_name='age')

def downgrade():
    """回滚：Integer -> String"""
    # 添加临时字段
    op.add_column('users', sa.Column('age_old', sa.String(), nullable=True))

    # 迁移数据
    op.execute("""
        UPDATE users
        SET age_old = CAST(age AS VARCHAR)
        WHERE age IS NOT NULL
    """)

    # 删除旧字段
    op.drop_column('users', 'age')

    # 重命名
    op.alter_column('users', 'age_old', new_column_name='age')
```

```bash
# 应用迁移
alembic upgrade head

# 验证数据类型
psql -U user -d ai_agent_db -c "\d users"
# age 字段类型应该是 integer
```

---

### 场景3：合并字段（数据迁移）

**需求：** 将 `users.first_name` 和 `users.last_name` 合并为 `users.full_name`

```python
# app/models/user.py
class User(Base):
    """用户表"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String, nullable=False)
    full_name = Column(String, nullable=False)  # 新字段：合并 first_name 和 last_name
    # 删除：first_name, last_name
```

```bash
# 创建手动迁移
alembic revision -m "merge first_name and last_name to full_name"
```

**手动编写迁移脚本：**

```python
# alembic/versions/20260211_1520_ghi789_merge_name_fields.py
"""merge first_name and last_name to full_name

Revision ID: ghi789jkl012
Revises: def456ghi789
Create Date: 2026-02-11 15:20:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'ghi789jkl012'
down_revision = 'def456ghi789'
branch_labels = None
depends_on = None

def upgrade():
    """合并 first_name 和 last_name 为 full_name"""
    # 步骤1：添加新字段（可空）
    op.add_column('users', sa.Column('full_name', sa.String(), nullable=True))

    # 步骤2：迁移数据
    op.execute("""
        UPDATE users
        SET full_name = TRIM(COALESCE(first_name, '') || ' ' || COALESCE(last_name, ''))
        WHERE full_name IS NULL
    """)

    # 步骤3：处理空值（设置默认值）
    op.execute("""
        UPDATE users
        SET full_name = email
        WHERE full_name IS NULL OR full_name = ''
    """)

    # 步骤4：设置为非空
    op.alter_column('users', 'full_name',
        existing_type=sa.String(),
        nullable=False
    )

    # 步骤5：删除旧字段
    op.drop_column('users', 'first_name')
    op.drop_column('users', 'last_name')

def downgrade():
    """拆分 full_name 为 first_name 和 last_name"""
    # 添加旧字段
    op.add_column('users', sa.Column('first_name', sa.String(), nullable=True))
    op.add_column('users', sa.Column('last_name', sa.String(), nullable=True))

    # 拆分数据（简化处理：第一个单词作为 first_name，其余作为 last_name）
    op.execute("""
        UPDATE users
        SET first_name = split_part(full_name, ' ', 1),
            last_name = CASE
                WHEN position(' ' IN full_name) > 0
                THEN substring(full_name FROM position(' ' IN full_name) + 1)
                ELSE ''
            END
    """)

    # 删除新字段
    op.drop_column('users', 'full_name')
```

---

### 场景4：添加外键关系（对话历史表）

**需求：** 创建 `conversations` 表，并建立与 `users` 表的外键关系

```python
# app/models/conversation.py
"""
对话模型
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from datetime import datetime

from app.core.database import Base

class Conversation(Base):
    """对话表"""
    __tablename__ = "conversations"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    title = Column(String, nullable=False)
    summary = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 关系
    user = relationship("User", back_populates="conversations")

    def __repr__(self):
        return f"<Conversation(id={self.id}, title={self.title})>"
```

```python
# app/models/user.py（添加反向关系）
from sqlalchemy.orm import relationship

class User(Base):
    """用户表"""
    __tablename__ = "users"

    # ... 其他字段 ...

    # 关系
    conversations = relationship("Conversation", back_populates="user", cascade="all, delete-orphan")
```

```bash
# 自动生成迁移
alembic revision --autogenerate -m "create conversations table with foreign key"
```

**生成的迁移脚本：**

```python
# alembic/versions/20260211_1530_jkl012_create_conversations_table.py
"""create conversations table with foreign key

Revision ID: jkl012mno345
Revises: ghi789jkl012
Create Date: 2026-02-11 15:30:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'jkl012mno345'
down_revision = 'ghi789jkl012'
branch_labels = None
depends_on = None

def upgrade():
    # 创建 conversations 表
    op.create_table('conversations',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('title', sa.String(), nullable=False),
        sa.Column('summary', sa.Text(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )

    # 创建索引
    op.create_index(op.f('ix_conversations_id'), 'conversations', ['id'], unique=False)

def downgrade():
    # 删除索引
    op.drop_index(op.f('ix_conversations_id'), table_name='conversations')

    # 删除表（外键会自动删除）
    op.drop_table('conversations')
```

```bash
# 应用迁移
alembic upgrade head

# 验证外键关系
psql -U user -d ai_agent_db -c "\d conversations"
# 应该看到：
# Foreign-key constraints:
#     "conversations_user_id_fkey" FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### 场景5：批量数据迁移（使用 ORM）

**需求：** 为所有现有用户创建默认对话

```bash
# 创建手动迁移
alembic revision -m "create default conversations for existing users"
```

**手动编写迁移脚本：**

```python
# alembic/versions/20260211_1540_mno345_create_default_conversations.py
"""create default conversations for existing users

Revision ID: mno345pqr678
Revises: jkl012mno345
Create Date: 2026-02-11 15:40:00.123456

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.orm import Session
from datetime import datetime

revision = 'mno345pqr678'
down_revision = 'jkl012mno345'
branch_labels = None
depends_on = None

def upgrade():
    """为所有现有用户创建默认对话"""
    # 获取数据库连接
    bind = op.get_bind()
    session = Session(bind=bind)

    # 查询所有用户
    users = session.execute(
        sa.text("SELECT id, email FROM users")
    ).fetchall()

    # 为每个用户创建默认对话
    for user_id, email in users:
        session.execute(
            sa.text("""
                INSERT INTO conversations (user_id, title, summary, created_at, updated_at)
                VALUES (:user_id, :title, :summary, :created_at, :updated_at)
            """),
            {
                "user_id": user_id,
                "title": f"Welcome, {email}!",
                "summary": "Your first conversation with AI Agent",
                "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow()
            }
        )

    session.commit()

    # 打印统计信息
    print(f"Created default conversations for {len(users)} users")

def downgrade():
    """删除默认对话"""
    bind = op.get_bind()
    session = Session(bind=bind)

    # 删除标题包含 "Welcome" 的对话
    result = session.execute(
        sa.text("DELETE FROM conversations WHERE title LIKE 'Welcome,%'")
    )

    session.commit()

    print(f"Deleted {result.rowcount} default conversations")
```

```bash
# 应用迁移
alembic upgrade head

# 输出：
# Created default conversations for 10 users
# INFO  [alembic.runtime.migration] Running upgrade jkl012mno345 -> mno345pqr678, create default conversations for existing users

# 验证数据
psql -U user -d ai_agent_db -c "SELECT user_id, title FROM conversations LIMIT 5;"
```

---

### 场景6：添加向量存储字段（pgvector）

**需求：** 为对话添加向量 embedding 字段，用于语义搜索

```python
# app/models/conversation.py
from pgvector.sqlalchemy import Vector

class Conversation(Base):
    """对话表"""
    __tablename__ = "conversations"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    title = Column(String, nullable=False)
    summary = Column(Text)
    embedding = Column(Vector(1536))  # OpenAI embedding 维度
    created_at = Column(DateTime, default=datetime.utcnow)
```

```bash
# 创建手动迁移（autogenerate 无法识别 Vector 类型）
alembic revision -m "add embedding to conversations"
```

**手动编写迁移脚本：**

```python
# alembic/versions/20260211_1550_pqr678_add_embedding_to_conversations.py
"""add embedding to conversations

Revision ID: pqr678stu901
Revises: mno345pqr678
Create Date: 2026-02-11 15:50:00.123456

"""
from alembic import op
import sqlalchemy as sa
from pgvector.sqlalchemy import Vector

revision = 'pqr678stu901'
down_revision = 'mno345pqr678'
branch_labels = None
depends_on = None

def upgrade():
    """添加向量字段和索引"""
    # 步骤1：启用 pgvector 扩展
    op.execute("CREATE EXTENSION IF NOT EXISTS vector")

    # 步骤2：添加向量字段
    op.add_column('conversations',
        sa.Column('embedding', Vector(1536), nullable=True))

    # 步骤3：创建向量索引（IVFFlat 索引，加速相似度搜索）
    op.execute("""
        CREATE INDEX idx_conversations_embedding
        ON conversations
        USING ivfflat (embedding vector_cosine_ops)
        WITH (lists = 100)
    """)

    print("Added embedding field and vector index to conversations table")

def downgrade():
    """删除向量字段和索引"""
    # 删除索引
    op.drop_index('idx_conversations_embedding', table_name='conversations')

    # 删除字段
    op.drop_column('conversations', 'embedding')

    print("Removed embedding field and vector index from conversations table")
```

```bash
# 应用迁移
alembic upgrade head

# 验证向量字段
psql -U user -d ai_agent_db -c "\d conversations"
# 应该看到：
# embedding | vector(1536) |

# 验证向量索引
psql -U user -d ai_agent_db -c "\di idx_conversations_embedding"
```

---

### 场景7：添加全文搜索索引

**需求：** 为对话标题和摘要添加全文搜索索引

```bash
# 创建手动迁移
alembic revision -m "add fulltext search to conversations"
```

**手动编写迁移脚本：**

```python
# alembic/versions/20260211_1600_stu901_add_fulltext_search.py
"""add fulltext search to conversations

Revision ID: stu901vwx234
Revises: pqr678stu901
Create Date: 2026-02-11 16:00:00.123456

"""
from alembic import op
import sqlalchemy as sa

revision = 'stu901vwx234'
down_revision = 'pqr678stu901'
branch_labels = None
depends_on = None

def upgrade():
    """添加全文搜索索引"""
    # PostgreSQL 全文搜索索引（GIN 索引）
    op.execute("""
        CREATE INDEX idx_conversations_title_fts
        ON conversations
        USING gin(to_tsvector('english', title))
    """)

    op.execute("""
        CREATE INDEX idx_conversations_summary_fts
        ON conversations
        USING gin(to_tsvector('english', COALESCE(summary, '')))
    """)

    print("Added fulltext search indexes to conversations table")

def downgrade():
    """删除全文搜索索引"""
    op.drop_index('idx_conversations_summary_fts', table_name='conversations')
    op.drop_index('idx_conversations_title_fts', table_name='conversations')

    print("Removed fulltext search indexes from conversations table")
```

```bash
# 应用迁移
alembic upgrade head

# 测试全文搜索
psql -U user -d ai_agent_db -c "
SELECT id, title
FROM conversations
WHERE to_tsvector('english', title) @@ to_tsquery('english', 'welcome')
LIMIT 5;
"
```

---

## 运行输出示例

```bash
# 完整的数据迁移流程
$ alembic revision -m "rename username to display_name"
Generating /path/to/alembic/versions/abc123_rename_username_to_display_name.py ... done

$ # 手动编辑迁移脚本...

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade previous -> abc123, rename username to display_name

$ alembic revision -m "change age type"
Generating /path/to/alembic/versions/def456_change_age_type.py ... done

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade abc123 -> def456, change age type

$ alembic revision -m "merge name fields"
Generating /path/to/alembic/versions/ghi789_merge_name_fields.py ... done

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade def456 -> ghi789, merge name fields

$ alembic revision --autogenerate -m "create conversations table"
INFO  [alembic.autogenerate.compare] Detected added table 'conversations'
Generating /path/to/alembic/versions/jkl012_create_conversations_table.py ... done

$ alembic upgrade head
INFO  [alembic.runtime.migration] Running upgrade ghi789 -> jkl012, create conversations table

$ alembic revision -m "create default conversations"
Generating /path/to/alembic/versions/mno345_create_default_conversations.py ... done

$ alembic upgrade head
Created default conversations for 10 users
INFO  [alembic.runtime.migration] Running upgrade jkl012 -> mno345, create default conversations

$ alembic revision -m "add embedding"
Generating /path/to/alembic/versions/pqr678_add_embedding.py ... done

$ alembic upgrade head
Added embedding field and vector index to conversations table
INFO  [alembic.runtime.migration] Running upgrade mno345 -> pqr678, add embedding

$ alembic revision -m "add fulltext search"
Generating /path/to/alembic/versions/stu901_add_fulltext_search.py ... done

$ alembic upgrade head
Added fulltext search indexes to conversations table
INFO  [alembic.runtime.migration] Running upgrade pqr678 -> stu901, add fulltext search
```

---

## 关键要点

1. **字段重命名**：使用 `alter_column` 而非删除+创建
2. **类型转换**：通过临时字段迁移数据，处理无效值
3. **字段合并**：先添加新字段，迁移数据，再删除旧字段
4. **外键关系**：autogenerate 可以检测，但要注意 `ondelete` 行为
5. **批量数据迁移**：使用 SQLAlchemy ORM 或原生 SQL
6. **特殊类型**：pgvector、全文搜索等需要手动编写迁移
7. **分步迁移**：复杂变更拆分成多个小迁移，每步可独立回滚

---

## 下一步

完成数据迁移场景后，可以学习：
- 场景3：生产环境部署（零停机迁移、CI/CD 集成）
- 场景4：团队协作（分支合并、冲突解决）
