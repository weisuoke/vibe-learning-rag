# åç›´è§‰ç‚¹

## è¯¯åŒº1ï¼šRedisç¼“å­˜è¶Šå¤šè¶Šå¥½ï¼Œåº”è¯¥ç¼“å­˜æ‰€æœ‰æ•°æ® âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

Redisæ˜¯å†…å­˜æ•°æ®åº“ï¼Œå†…å­˜æ˜¯æœ‰é™ä¸”æ˜‚è´µçš„èµ„æºã€‚ç›²ç›®ç¼“å­˜æ‰€æœ‰æ•°æ®ä¼šå¯¼è‡´ï¼š

1. **å†…å­˜æº¢å‡º**ï¼šRediså†…å­˜ä¸è¶³æ—¶ä¼šè§¦å‘æ·˜æ±°ç­–ç•¥ï¼Œå¯¼è‡´é‡è¦æ•°æ®è¢«åˆ é™¤
2. **ç¼“å­˜æ±¡æŸ“**ï¼šä½é¢‘è®¿é—®çš„æ•°æ®å ç”¨å†…å­˜ï¼ŒæŒ¤å‹é«˜é¢‘æ•°æ®
3. **æˆæœ¬æµªè´¹**ï¼šäº‘æœåŠ¡çš„RedisæŒ‰å†…å­˜æ”¶è´¹ï¼Œç¼“å­˜æ— ç”¨æ•°æ®æµªè´¹æˆæœ¬
4. **ç»´æŠ¤å¤æ‚**ï¼šç¼“å­˜æ•°æ®è¶Šå¤šï¼Œç¼“å­˜å¤±æ•ˆå’Œä¸€è‡´æ€§é—®é¢˜è¶Šå¤æ‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

- **ç›´è§‰è¯¯å¯¼**ï¼š"ç¼“å­˜èƒ½æå‡æ€§èƒ½" â†’ "ç¼“å­˜è¶Šå¤šæ€§èƒ½è¶Šå¥½"
- **å¿½ç•¥æˆæœ¬**ï¼šå¼€å‘ç¯å¢ƒå†…å­˜å……è¶³ï¼Œæ²¡æœ‰æ„è¯†åˆ°ç”Ÿäº§ç¯å¢ƒçš„å†…å­˜é™åˆ¶
- **è¿‡åº¦ä¼˜åŒ–**ï¼šæ‹…å¿ƒæ€§èƒ½é—®é¢˜ï¼Œæå‰ç¼“å­˜æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„æ•°æ®

**æ­£ç¡®ç†è§£ï¼š**

åªç¼“å­˜**é«˜é¢‘è®¿é—®**ä¸”**è®¡ç®—æˆæœ¬é«˜**çš„æ•°æ®ï¼š

```python
# âŒ é”™è¯¯ï¼šç¼“å­˜æ‰€æœ‰ç”¨æˆ·æ•°æ®
def get_user(user_id: int):
    cache_key = f"user:{user_id}"
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    user = db.query(User).filter_by(id=user_id).first()
    redis_client.setex(cache_key, 86400, json.dumps(user))  # ç¼“å­˜24å°æ—¶
    return user

# âœ… æ­£ç¡®ï¼šåªç¼“å­˜æ´»è·ƒç”¨æˆ·
def get_user(user_id: int):
    # å…ˆæŸ¥æ•°æ®åº“
    user = db.query(User).filter_by(id=user_id).first()

    # åªç¼“å­˜æœ€è¿‘7å¤©æ´»è·ƒçš„ç”¨æˆ·
    if user.last_active_at > datetime.now() - timedelta(days=7):
        cache_key = f"user:{user_id}"
        redis_client.setex(cache_key, 3600, json.dumps(user))  # ç¼“å­˜1å°æ—¶

    return user
```

**ç¼“å­˜å†³ç­–çŸ©é˜µï¼š**

| æ•°æ®ç±»å‹ | è®¿é—®é¢‘ç‡ | è®¡ç®—æˆæœ¬ | æ˜¯å¦ç¼“å­˜ | TTL |
|---------|---------|---------|---------|-----|
| LLMå“åº” | é«˜ | é«˜ï¼ˆAPIè°ƒç”¨ï¼‰ | âœ… æ˜¯ | 1å°æ—¶ |
| Embedding | ä¸­ | é«˜ï¼ˆæ¨¡å‹æ¨ç†ï¼‰ | âœ… æ˜¯ | 24å°æ—¶ |
| ç”¨æˆ·ä¿¡æ¯ | é«˜ | ä½ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰ | âš ï¸ é€‰æ‹©æ€§ | 30åˆ†é’Ÿ |
| å†å²æ—¥å¿— | ä½ | ä½ | âŒ å¦ | - |
| é…ç½®æ•°æ® | é«˜ | ä½ | âœ… æ˜¯ | 5åˆ†é’Ÿ |

---

## è¯¯åŒº2ï¼šç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ï¼Œåº”è¯¥è®¾ç½®å¾ˆé•¿çš„TTL âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

é•¿TTLè™½ç„¶èƒ½æé«˜å‘½ä¸­ç‡ï¼Œä½†ä¼šå¯¼è‡´ä¸¥é‡çš„**æ•°æ®ä¸€è‡´æ€§é—®é¢˜**ï¼š

1. **æ•°æ®è¿‡æœŸ**ï¼šç¼“å­˜çš„æ•°æ®ä¸æ•°æ®åº“ä¸ä¸€è‡´ï¼Œç”¨æˆ·çœ‹åˆ°æ—§æ•°æ®
2. **ä¸šåŠ¡é€»è¾‘é”™è¯¯**ï¼šåŸºäºè¿‡æœŸæ•°æ®åšå†³ç­–ï¼Œå¯¼è‡´ä¸šåŠ¡é”™è¯¯
3. **éš¾ä»¥è°ƒè¯•**ï¼šç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´æ—¶ï¼Œé—®é¢˜éš¾ä»¥å®šä½

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

- **æŒ‡æ ‡å¯¼å‘**ï¼šåªå…³æ³¨ç¼“å­˜å‘½ä¸­ç‡ï¼Œå¿½ç•¥æ•°æ®æ–°é²œåº¦
- **æ€§èƒ½ç„¦è™‘**ï¼šæ‹…å¿ƒé¢‘ç¹æŸ¥è¯¢æ•°æ®åº“å½±å“æ€§èƒ½
- **ç®€åŒ–æ€ç»´**ï¼š"TTLè¶Šé•¿ï¼Œç¼“å­˜è¶Šæœ‰æ•ˆ"

**æ­£ç¡®ç†è§£ï¼š**

TTLåº”è¯¥æ ¹æ®**æ•°æ®æ›´æ–°é¢‘ç‡**å’Œ**ä¸šåŠ¡å®¹å¿åº¦**è®¾ç½®ï¼š

```python
# âŒ é”™è¯¯ï¼šæ‰€æœ‰æ•°æ®éƒ½è®¾ç½®24å°æ—¶TTL
TTL_CONFIG = {
    "user_profile": 86400,      # 24å°æ—¶
    "llm_response": 86400,      # 24å°æ—¶
    "product_price": 86400,     # 24å°æ—¶ï¼ˆä»·æ ¼å¯èƒ½å˜åŒ–ï¼ï¼‰
    "inventory": 86400,         # 24å°æ—¶ï¼ˆåº“å­˜å®æ—¶å˜åŒ–ï¼ï¼‰
}

# âœ… æ­£ç¡®ï¼šæ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®ä¸åŒTTL
TTL_CONFIG = {
    # é™æ€æ•°æ®ï¼šé•¿TTL
    "llm_response": 3600,           # 1å°æ—¶ï¼ˆLLMå“åº”ä¸å˜ï¼‰
    "embedding": 86400,             # 24å°æ—¶ï¼ˆEmbeddingä¸å˜ï¼‰

    # åŠé™æ€æ•°æ®ï¼šä¸­ç­‰TTL
    "user_profile": 1800,           # 30åˆ†é’Ÿï¼ˆç”¨æˆ·ä¿¡æ¯å¶å°”æ›´æ–°ï¼‰
    "config": 300,                  # 5åˆ†é’Ÿï¼ˆé…ç½®å¶å°”æ›´æ–°ï¼‰

    # åŠ¨æ€æ•°æ®ï¼šçŸ­TTLæˆ–ä¸ç¼“å­˜
    "product_price": 60,            # 1åˆ†é’Ÿï¼ˆä»·æ ¼å¯èƒ½å˜åŒ–ï¼‰
    "inventory": 10,                # 10ç§’ï¼ˆåº“å­˜å®æ—¶å˜åŒ–ï¼‰
    "real_time_data": 0,            # ä¸ç¼“å­˜ï¼ˆå®æ—¶æ•°æ®ï¼‰
}
```

**TTLè®¾ç½®åŸåˆ™ï¼š**

```python
def calculate_ttl(data_type: str, update_frequency: str) -> int:
    """æ ¹æ®æ•°æ®ç±»å‹å’Œæ›´æ–°é¢‘ç‡è®¡ç®—TTL"""

    # æ•°æ®æ›´æ–°é¢‘ç‡
    if update_frequency == "never":        # æ°¸ä¸æ›´æ–°ï¼ˆå¦‚LLMå“åº”ï¼‰
        return 3600                        # 1å°æ—¶
    elif update_frequency == "daily":      # æ¯å¤©æ›´æ–°
        return 1800                        # 30åˆ†é’Ÿ
    elif update_frequency == "hourly":     # æ¯å°æ—¶æ›´æ–°
        return 300                         # 5åˆ†é’Ÿ
    elif update_frequency == "minutely":   # æ¯åˆ†é’Ÿæ›´æ–°
        return 30                          # 30ç§’
    else:                                  # å®æ—¶æ›´æ–°
        return 0                           # ä¸ç¼“å­˜
```

---

## è¯¯åŒº3ï¼šè¯­ä¹‰ç¼“å­˜åªéœ€è¦è®¡ç®—ç›¸ä¼¼åº¦ï¼Œç›¸ä¼¼åº¦é«˜å°±è¿”å›ç¼“å­˜ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è¯­ä¹‰ç¼“å­˜ä¸ä»…ä»…æ˜¯ç›¸ä¼¼åº¦åŒ¹é…ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š

1. **ä¸Šä¸‹æ–‡å·®å¼‚**ï¼šç›¸ä¼¼çš„é—®é¢˜åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­ç­”æ¡ˆå¯èƒ½ä¸åŒ
2. **æ—¶æ•ˆæ€§**ï¼šç›¸ä¼¼çš„é—®é¢˜åœ¨ä¸åŒæ—¶é—´ç­”æ¡ˆå¯èƒ½ä¸åŒ
3. **ç”¨æˆ·æ„å›¾**ï¼šè¡¨é¢ç›¸ä¼¼çš„é—®é¢˜ï¼Œç”¨æˆ·æ„å›¾å¯èƒ½å®Œå…¨ä¸åŒ

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

- **æŠ€æœ¯å¯¼å‘**ï¼šåªå…³æ³¨æŠ€æœ¯å®ç°ï¼ˆEmbedding + ç›¸ä¼¼åº¦ï¼‰ï¼Œå¿½ç•¥ä¸šåŠ¡é€»è¾‘
- **ç®€åŒ–æ€ç»´**ï¼š"ç›¸ä¼¼åº¦>0.9å°±æ˜¯ç›¸åŒé—®é¢˜"
- **å¿½ç•¥è¾¹ç•Œ**ï¼šæ²¡æœ‰è€ƒè™‘è¯­ä¹‰ç¼“å­˜çš„é€‚ç”¨è¾¹ç•Œ

**æ­£ç¡®ç†è§£ï¼š**

è¯­ä¹‰ç¼“å­˜éœ€è¦**å¤šç»´åº¦åˆ¤æ–­**ï¼š

```python
# âŒ é”™è¯¯ï¼šåªçœ‹ç›¸ä¼¼åº¦
def semantic_cache_lookup(query: str, threshold: float = 0.9):
    query_embedding = get_embedding(query)

    # æŸ¥æ‰¾ç›¸ä¼¼ç¼“å­˜
    similar_cache = find_similar_cache(query_embedding, threshold)
    if similar_cache:
        return similar_cache["response"]  # ç›´æ¥è¿”å›

    return None

# âœ… æ­£ç¡®ï¼šå¤šç»´åº¦åˆ¤æ–­
def semantic_cache_lookup(
    query: str,
    user_id: int,
    context: dict,
    threshold: float = 0.9
):
    query_embedding = get_embedding(query)

    # 1. æŸ¥æ‰¾ç›¸ä¼¼ç¼“å­˜
    similar_caches = find_similar_caches(query_embedding, threshold)

    for cache in similar_caches:
        # 2. æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…
        if not context_matches(cache["context"], context):
            continue

        # 3. æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆä¸åŒç”¨æˆ·å¯èƒ½çœ‹åˆ°ä¸åŒç­”æ¡ˆï¼‰
        if cache.get("user_id") and cache["user_id"] != user_id:
            continue

        # 4. æ£€æŸ¥æ—¶æ•ˆæ€§ï¼ˆæ–°é—»ç±»é—®é¢˜éœ€è¦æœ€æ–°ç­”æ¡ˆï¼‰
        if is_time_sensitive(query) and cache_expired(cache, max_age=3600):
            continue

        # 5. æ£€æŸ¥æ„å›¾æ˜¯å¦ä¸€è‡´
        if not intent_matches(query, cache["query"]):
            continue

        # æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œè¿”å›ç¼“å­˜
        return cache["response"]

    return None

def context_matches(cache_context: dict, current_context: dict) -> bool:
    """æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…"""
    # ä¾‹å¦‚ï¼šå¯¹è¯å†å²ã€ç”¨æˆ·è§’è‰²ã€ä¸šåŠ¡åœºæ™¯ç­‰
    return cache_context.get("role") == current_context.get("role")

def is_time_sensitive(query: str) -> bool:
    """åˆ¤æ–­é—®é¢˜æ˜¯å¦æ—¶æ•ˆæ€§æ•æ„Ÿ"""
    time_keywords = ["ä»Šå¤©", "æœ€æ–°", "ç°åœ¨", "å½“å‰", "ä»Šå¹´"]
    return any(keyword in query for keyword in time_keywords)

def intent_matches(query1: str, query2: str) -> bool:
    """åˆ¤æ–­ä¸¤ä¸ªé—®é¢˜çš„æ„å›¾æ˜¯å¦ä¸€è‡´"""
    # å¯ä»¥ä½¿ç”¨ç®€å•çš„å…³é”®è¯åŒ¹é…æˆ–æ›´å¤æ‚çš„æ„å›¾åˆ†ç±»æ¨¡å‹
    # ä¾‹å¦‚ï¼š"å¦‚ä½•å­¦Python"å’Œ"Pythonæ€ä¹ˆå­¦"æ„å›¾ä¸€è‡´
    # ä½†"Pythonæ˜¯ä»€ä¹ˆ"å’Œ"Pythonæ€ä¹ˆå­¦"æ„å›¾ä¸ä¸€è‡´
    return True  # ç®€åŒ–ç¤ºä¾‹
```

**è¯­ä¹‰ç¼“å­˜é€‚ç”¨åœºæ™¯ï¼š**

| åœºæ™¯ | æ˜¯å¦é€‚ç”¨ | åŸå›  |
|------|---------|------|
| FAQé—®ç­” | âœ… é€‚ç”¨ | é—®é¢˜å›ºå®šï¼Œç­”æ¡ˆä¸å˜ |
| æ–‡æ¡£é—®ç­” | âœ… é€‚ç”¨ | æ–‡æ¡£å†…å®¹ä¸å˜ |
| æ–°é—»é—®ç­” | âŒ ä¸é€‚ç”¨ | ç­”æ¡ˆéšæ—¶é—´å˜åŒ– |
| ä¸ªæ€§åŒ–æ¨è | âŒ ä¸é€‚ç”¨ | æ¯ä¸ªç”¨æˆ·ç­”æ¡ˆä¸åŒ |
| è®¡ç®—ä»»åŠ¡ | âœ… é€‚ç”¨ | è¾“å…¥ç›¸åŒï¼Œè¾“å‡ºç›¸åŒ |
| å®æ—¶æ•°æ®æŸ¥è¯¢ | âŒ ä¸é€‚ç”¨ | æ•°æ®å®æ—¶å˜åŒ– |

---

## è¯¯åŒº4ï¼šRedisè¿æ¥æ± è¶Šå¤§è¶Šå¥½ï¼Œè®¾ç½®max_connections=1000 âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è¿æ¥æ± è¿‡å¤§ä¼šå¯¼è‡´ï¼š

1. **èµ„æºæµªè´¹**ï¼šå¤§é‡ç©ºé—²è¿æ¥å ç”¨å†…å­˜å’Œæ–‡ä»¶æè¿°ç¬¦
2. **Rediså‹åŠ›**ï¼šRediséœ€è¦ç»´æŠ¤æ‰€æœ‰è¿æ¥ï¼Œæ¶ˆè€—CPUå’Œå†…å­˜
3. **æ€§èƒ½ä¸‹é™**ï¼šè¿æ¥è¿‡å¤šæ—¶ï¼ŒRedisçš„è¿æ¥ç®¡ç†å¼€é”€å¢åŠ 

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

- **æ•°æ®åº“æ€ç»´**ï¼šæŠŠRediså½“æˆæ•°æ®åº“ï¼Œè®¤ä¸ºè¿æ¥æ± è¶Šå¤§è¶Šå¥½
- **æ€§èƒ½ç„¦è™‘**ï¼šæ‹…å¿ƒè¿æ¥ä¸å¤Ÿç”¨ï¼Œè®¾ç½®å¾ˆå¤§çš„è¿æ¥æ± 
- **å¿½ç•¥ç‰¹æ€§**ï¼šRedisæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œè¿æ¥è¿‡å¤šåè€Œé™ä½æ€§èƒ½

**æ­£ç¡®ç†è§£ï¼š**

Redisè¿æ¥æ± å¤§å°åº”è¯¥æ ¹æ®**å¹¶å‘è¯·æ±‚æ•°**å’Œ**Redisæ€§èƒ½**è®¾ç½®ï¼š

```python
# âŒ é”™è¯¯ï¼šè¿æ¥æ± è¿‡å¤§
pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    max_connections=1000,  # è¿‡å¤§ï¼
    decode_responses=True
)

# âœ… æ­£ç¡®ï¼šæ ¹æ®å®é™…å¹¶å‘è®¾ç½®
import os

# è®¡ç®—åˆç†çš„è¿æ¥æ± å¤§å°
# å…¬å¼ï¼šmax_connections = workeræ•° * 2 + å¤‡ç”¨è¿æ¥
worker_count = int(os.getenv("WORKER_COUNT", "4"))
max_connections = worker_count * 2 + 2  # 4 * 2 + 2 = 10

pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    max_connections=max_connections,
    socket_timeout=5,           # è¿æ¥è¶…æ—¶
    socket_connect_timeout=5,   # å»ºç«‹è¿æ¥è¶…æ—¶
    retry_on_timeout=True,      # è¶…æ—¶é‡è¯•
    decode_responses=True
)

print(f"âœ… Redisè¿æ¥æ± å¤§å°: {max_connections}")
```

**è¿æ¥æ± å¤§å°è®¡ç®—å…¬å¼ï¼š**

```python
def calculate_pool_size(
    worker_count: int,
    avg_request_time: float,
    requests_per_second: int
) -> int:
    """
    è®¡ç®—åˆç†çš„è¿æ¥æ± å¤§å°

    å‚æ•°ï¼š
    - worker_count: FastAPI workeræ•°é‡
    - avg_request_time: å¹³å‡è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆç§’ï¼‰
    - requests_per_second: æ¯ç§’è¯·æ±‚æ•°
    """
    # æ¯ä¸ªworkeråŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°
    concurrent_per_worker = avg_request_time * (requests_per_second / worker_count)

    # æ€»å¹¶å‘æ•°
    total_concurrent = concurrent_per_worker * worker_count

    # åŠ ä¸Š20%çš„ç¼“å†²
    pool_size = int(total_concurrent * 1.2)

    # æœ€å°å€¼å’Œæœ€å¤§å€¼é™åˆ¶
    pool_size = max(10, min(pool_size, 50))

    return pool_size

# ç¤ºä¾‹ï¼š4ä¸ªworkerï¼Œå¹³å‡è¯·æ±‚æ—¶é—´0.1ç§’ï¼Œæ¯ç§’100ä¸ªè¯·æ±‚
pool_size = calculate_pool_size(
    worker_count=4,
    avg_request_time=0.1,
    requests_per_second=100
)
print(f"æ¨èè¿æ¥æ± å¤§å°: {pool_size}")  # çº¦12ä¸ªè¿æ¥
```

**ä¸åŒåœºæ™¯çš„è¿æ¥æ± é…ç½®ï¼š**

| åœºæ™¯ | Workeræ•° | å¹¶å‘è¯·æ±‚ | æ¨èè¿æ¥æ± å¤§å° |
|------|---------|---------|---------------|
| å¼€å‘ç¯å¢ƒ | 1 | ä½ | 5-10 |
| å°å‹åº”ç”¨ | 4 | ä¸­ | 10-20 |
| ä¸­å‹åº”ç”¨ | 8 | é«˜ | 20-30 |
| å¤§å‹åº”ç”¨ | 16+ | å¾ˆé«˜ | 30-50 |

---

## è¯¯åŒº5ï¼šç¼“å­˜ç©¿é€ç”¨å¸ƒéš†è¿‡æ»¤å™¨å°±å¤Ÿäº†ï¼Œä¸éœ€è¦å…¶ä»–é˜²æŠ¤ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

å¸ƒéš†è¿‡æ»¤å™¨åªèƒ½é˜²æ­¢**æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®**ï¼Œä½†æ— æ³•é˜²æ­¢ï¼š

1. **ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ç‚¹æ•°æ®è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“
2. **ç¼“å­˜é›ªå´©**ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œæ•°æ®åº“å‹åŠ›æ¿€å¢
3. **æ¶æ„æ”»å‡»**ï¼šæ”»å‡»è€…æ•…æ„æŸ¥è¯¢å­˜åœ¨ä½†æœªç¼“å­˜çš„æ•°æ®

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

- **å•ä¸€æ€ç»´**ï¼šåªå…³æ³¨ä¸€ç§æ”»å‡»æ–¹å¼ï¼Œå¿½ç•¥å…¶ä»–é£é™©
- **æŠ€æœ¯å´‡æ‹œ**ï¼šè®¤ä¸ºå¸ƒéš†è¿‡æ»¤å™¨æ˜¯"é“¶å¼¹"ï¼Œèƒ½è§£å†³æ‰€æœ‰é—®é¢˜
- **å¿½ç•¥ç»„åˆ**ï¼šæ²¡æœ‰æ„è¯†åˆ°éœ€è¦å¤šå±‚é˜²æŠ¤

**æ­£ç¡®ç†è§£ï¼š**

éœ€è¦**å¤šå±‚é˜²æŠ¤ç­–ç•¥**ï¼š

```python
import asyncio
from typing import Optional
from datetime import datetime, timedelta

class CacheProtection:
    """ç¼“å­˜å¤šå±‚é˜²æŠ¤"""

    def __init__(self):
        self.bloom_filter = BloomFilter()  # å¸ƒéš†è¿‡æ»¤å™¨
        self.locks = {}                    # äº’æ–¥é”ï¼ˆé˜²å‡»ç©¿ï¼‰
        self.null_cache = {}               # ç©ºå€¼ç¼“å­˜ï¼ˆé˜²ç©¿é€ï¼‰

    async def get_with_protection(
        self,
        key: str,
        fetch_func,
        ttl: int = 3600
    ) -> Optional[str]:
        """å¸¦å¤šå±‚é˜²æŠ¤çš„ç¼“å­˜è·å–"""

        # 1. å¸ƒéš†è¿‡æ»¤å™¨ï¼šå¿«é€Ÿåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨
        if not self.bloom_filter.might_exist(key):
            print(f"ğŸ›¡ï¸ å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª: {key}")
            return None

        # 2. æŸ¥è¯¢ç¼“å­˜
        cached = redis_client.get(key)
        if cached:
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºå€¼ç¼“å­˜
            if cached == "NULL":
                print(f"ğŸ›¡ï¸ ç©ºå€¼ç¼“å­˜æ‹¦æˆª: {key}")
                return None
            return cached

        # 3. äº’æ–¥é”ï¼šé˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼ˆåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¯·æ±‚æŸ¥æ•°æ®åº“ï¼‰
        if key not in self.locks:
            self.locks[key] = asyncio.Lock()

        async with self.locks[key]:
            # åŒé‡æ£€æŸ¥ï¼šå¯èƒ½å…¶ä»–è¯·æ±‚å·²ç»åŠ è½½äº†ç¼“å­˜
            cached = redis_client.get(key)
            if cached:
                return cached if cached != "NULL" else None

            # 4. æŸ¥è¯¢æ•°æ®åº“
            print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {key}")
            data = await fetch_func(key)

            if data:
                # 5. éšæœºTTLï¼šé˜²æ­¢ç¼“å­˜é›ªå´©
                random_ttl = ttl + random.randint(-300, 300)  # Â±5åˆ†é’Ÿ
                redis_client.setex(key, random_ttl, data)
                print(f"âœ… ç¼“å­˜è®¾ç½®æˆåŠŸï¼ŒTTL={random_ttl}ç§’")
            else:
                # 6. ç©ºå€¼ç¼“å­˜ï¼šé˜²æ­¢ç¼“å­˜ç©¿é€
                redis_client.setex(key, 60, "NULL")  # ç©ºå€¼ç¼“å­˜60ç§’
                print(f"ğŸ›¡ï¸ è®¾ç½®ç©ºå€¼ç¼“å­˜: {key}")

            return data

    def add_to_bloom_filter(self, key: str):
        """æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨"""
        self.bloom_filter.add(key)

# ä½¿ç”¨ç¤ºä¾‹
protection = CacheProtection()

async def get_user_with_protection(user_id: int):
    """å¸¦é˜²æŠ¤çš„ç”¨æˆ·æŸ¥è¯¢"""

    async def fetch_user(key: str):
        # ä»æ•°æ®åº“æŸ¥è¯¢
        user = await db.query(User).filter_by(id=user_id).first()
        return json.dumps(user) if user else None

    return await protection.get_with_protection(
        key=f"user:{user_id}",
        fetch_func=fetch_user,
        ttl=3600
    )
```

**å¤šå±‚é˜²æŠ¤å¯¹æ¯”ï¼š**

| é˜²æŠ¤æªæ–½ | é˜²æŠ¤å¯¹è±¡ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| å¸ƒéš†è¿‡æ»¤å™¨ | ç¼“å­˜ç©¿é€ | å¿«é€Ÿåˆ¤æ–­ï¼Œå†…å­˜å ç”¨å° | æœ‰è¯¯åˆ¤ç‡ |
| ç©ºå€¼ç¼“å­˜ | ç¼“å­˜ç©¿é€ | å‡†ç¡®ï¼Œæ— è¯¯åˆ¤ | å ç”¨ç¼“å­˜ç©ºé—´ |
| äº’æ–¥é” | ç¼“å­˜å‡»ç©¿ | é¿å…å¹¶å‘æŸ¥è¯¢æ•°æ®åº“ | å¯èƒ½é˜»å¡è¯·æ±‚ |
| éšæœºTTL | ç¼“å­˜é›ªå´© | é¿å…åŒæ—¶è¿‡æœŸ | å®ç°ç®€å• |
| é™æµ | æ¶æ„æ”»å‡» | ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ | å¯èƒ½è¯¯ä¼¤æ­£å¸¸ç”¨æˆ· |

---

## æ€»ç»“ï¼šRedisç¼“å­˜çš„5ä¸ªåç›´è§‰ç‚¹

1. **ç¼“å­˜ä¸æ˜¯è¶Šå¤šè¶Šå¥½**ï¼šåªç¼“å­˜é«˜é¢‘ä¸”è®¡ç®—æˆæœ¬é«˜çš„æ•°æ®
2. **TTLä¸æ˜¯è¶Šé•¿è¶Šå¥½**ï¼šæ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡å’Œä¸šåŠ¡å®¹å¿åº¦è®¾ç½®
3. **è¯­ä¹‰ç¼“å­˜ä¸åªæ˜¯ç›¸ä¼¼åº¦**ï¼šéœ€è¦å¤šç»´åº¦åˆ¤æ–­ï¼ˆä¸Šä¸‹æ–‡ã€æ—¶æ•ˆæ€§ã€æ„å›¾ï¼‰
4. **è¿æ¥æ± ä¸æ˜¯è¶Šå¤§è¶Šå¥½**ï¼šæ ¹æ®å®é™…å¹¶å‘è®¾ç½®ï¼Œè¿‡å¤§åè€Œé™ä½æ€§èƒ½
5. **é˜²æŠ¤ä¸æ˜¯å•ä¸€æªæ–½**ï¼šéœ€è¦å¤šå±‚é˜²æŠ¤ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ + äº’æ–¥é” + éšæœºTTLï¼‰

**è®°ä½ï¼š** ç¼“å­˜æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œç”¨å¥½äº†èƒ½å¤§å¹…æå‡æ€§èƒ½ï¼Œç”¨ä¸å¥½ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§ã€å†…å­˜æµªè´¹ã€ç³»ç»Ÿå¤æ‚åº¦ç­‰é—®é¢˜ã€‚ç†è§£è¿™äº›åç›´è§‰ç‚¹ï¼Œæ‰èƒ½åœ¨AI Agentå¼€å‘ä¸­æ­£ç¡®ä½¿ç”¨Redisç¼“å­˜ï¼
