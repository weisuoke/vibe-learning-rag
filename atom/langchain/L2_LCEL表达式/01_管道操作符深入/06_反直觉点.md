# åç›´è§‰ç‚¹

> æ­ç¤ºç®¡é“æ“ä½œç¬¦çš„3ä¸ªå¸¸è§è¯¯åŒº

---

## è¯¯åŒº1ï¼šç®¡é“æ“ä½œç¬¦åªæ˜¯è¯­æ³•ç³–ï¼Œæ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿ âŒ

### é”™è¯¯è§‚ç‚¹

"ç®¡é“æ“ä½œç¬¦ `|` åªæ˜¯è®©ä»£ç çœ‹èµ·æ¥æ›´å¥½çœ‹ï¼Œå®é™…ä¸Šå’ŒåµŒå¥—å‡½æ•°è°ƒç”¨æ²¡æœ‰åŒºåˆ«ï¼Œç”šè‡³å¯èƒ½æ›´æ…¢ã€‚"

### ä¸ºä»€ä¹ˆé”™ï¼Ÿ

**RunnableSequence æœ‰ä¼˜åŒ–çš„æ‰§è¡Œå¼•æ“**

```python
# è¯¯è§£ï¼šè®¤ä¸ºè¿™ä¸¤ç§æ–¹å¼æ€§èƒ½ç›¸åŒ
# æ–¹å¼1ï¼šåµŒå¥—è°ƒç”¨
result = parser(llm(prompt(input)))

# æ–¹å¼2ï¼šç®¡é“æ“ä½œç¬¦
chain = prompt | llm | parser
result = chain.invoke(input)
```

**å®é™…æƒ…å†µ**ï¼šRunnableSequence æä¾›äº†å¤šç§æ€§èƒ½ä¼˜åŒ–ï¼š

1. **æµå¼æ‰§è¡Œä¼˜åŒ–**ï¼ˆé™ä½å»¶è¿Ÿ 67%ï¼‰
   ```python
   # ä¼ ç»Ÿæ–¹å¼ï¼šå¿…é¡»ç­‰å¾…å®Œæ•´å“åº”
   result = llm.invoke(prompt)  # ç­‰å¾… 2.5s
   print(result)

   # LCEL æµå¼ï¼šé€æ­¥è¾“å‡º
   for chunk in chain.stream(input):  # 0.8s åå¼€å§‹è¾“å‡º
       print(chunk, end="")
   # é¦– token å»¶è¿Ÿé™ä½ 67%
   ```

2. **å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–**ï¼ˆæå‡åå 40-50%ï¼‰
   ```python
   # RunnableParallel è‡ªåŠ¨å¹¶è¡Œ
   parallel = RunnableParallel({
       "search": search_tool,
       "calc": calc_tool
   })
   # ä¸¤ä¸ªå·¥å…·å¹¶è¡Œæ‰§è¡Œï¼Œæ€»æ—¶é—´ = max(time1, time2)
   ```

3. **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼ˆé™ä½æˆæœ¬ 50%ï¼‰
   ```python
   # æ‰¹å¤„ç† API è°ƒç”¨
   results = chain.batch(inputs)
   # ä½¿ç”¨æ‰¹å¤„ç† APIï¼Œæˆæœ¬é™ä½ 50%
   ```

**æ•°æ®æ”¯æŒ**ï¼ˆ2025-2026ï¼‰ï¼š
- æµå¼æ‰§è¡Œï¼š2.5s â†’ 0.8sï¼ˆ67% å»¶è¿Ÿé™ä½ï¼‰
- å¹¶è¡Œæ‰§è¡Œï¼š40-50% ååæå‡
- æ‰¹å¤„ç†ï¼š50% æˆæœ¬é™ä½

**å‚è€ƒèµ„æº**ï¼š
- [LangChain æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://blog.langchain.com/how-do-i-speed-up-my-agent)
- [ç”Ÿäº§çº§ LCEL æŒ‡å—](https://medium.com/@sajo02/building-production-ready-ai-pipelines-with-langchain-runnables-a-complete-lcel-guide-2f9b27f6d557)

### ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ

**å¿ƒç†åŸå› **ï¼š
- **è¡¨é¢ç›¸ä¼¼æ€§**ï¼š`a | b | c` çœ‹èµ·æ¥åƒç®€å•çš„è¯­æ³•ç³–
- **éšè—å¤æ‚æ€§**ï¼šä¼˜åŒ–å‘ç”Ÿåœ¨åº•å±‚ï¼Œä¸ç›´æ¥å¯è§
- **ç»éªŒè¿ç§»**ï¼šå…¶ä»–è¯­è¨€çš„ç®¡é“æ“ä½œç¬¦ç¡®å®åªæ˜¯è¯­æ³•ç³–

**è®¤çŸ¥åå·®**ï¼š
- åªçœ‹åˆ°è¯­æ³•å±‚é¢ï¼Œå¿½ç•¥äº†æ‰§è¡Œå¼•æ“çš„ä¼˜åŒ–
- æ²¡æœ‰å®é™…æµ‹é‡æ€§èƒ½ï¼Œå‡­ç›´è§‰åˆ¤æ–­

### æ­£ç¡®ç†è§£

**ç®¡é“æ“ä½œç¬¦ = å£°æ˜å¼æ¥å£ + ä¼˜åŒ–æ‰§è¡Œå¼•æ“**

```python
# è¡¨é¢ï¼šç®€æ´çš„è¯­æ³•
chain = prompt | llm | parser

# åº•å±‚ï¼šä¼˜åŒ–çš„æ‰§è¡Œå¼•æ“
class RunnableSequence:
    def stream(self, input):
        # æµå¼ä¼˜åŒ–
        for step in self.steps[:-1]:
            input = step.invoke(input)
        for chunk in self.steps[-1].stream(input):
            yield chunk  # é€æ­¥è¾“å‡º

    def batch(self, inputs):
        # æ‰¹å¤„ç†ä¼˜åŒ–
        return self._batch_with_concurrency(inputs)
```

**å…³é”®æ´å¯Ÿ**ï¼š
- è¯­æ³•ç®€æ´ â‰  æ€§èƒ½å·®
- å£°æ˜å¼ç¼–ç¨‹å…è®¸æ¡†æ¶è¿›è¡Œä¼˜åŒ–
- RunnableSequence æ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„æ‰§è¡Œå®¹å™¨

---

## è¯¯åŒº2ï¼šç±»å‹æ¨æ–­ä¼šé™ä½è¿è¡Œæ—¶æ€§èƒ½ âŒ

### é”™è¯¯è§‚ç‚¹

"ä½¿ç”¨ TypedDict å’Œ Pydantic æ¨¡å‹ä¼šè®©ä»£ç å˜æ…¢ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥é¿å…ä½¿ç”¨ã€‚"

### ä¸ºä»€ä¹ˆé”™ï¼Ÿ

**ç±»å‹æ£€æŸ¥åœ¨å¼€å‘æ—¶å®Œæˆï¼Œè¿è¡Œæ—¶é›¶å¼€é”€**

```python
from typing import TypedDict

class QueryInput(TypedDict):
    query: str
    max_docs: int

# è¯¯è§£ï¼šè®¤ä¸ºè¿™ä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹
chain: Runnable[QueryInput, str] = prompt | llm | parser

# å®é™…ï¼šç±»å‹æç¤ºåœ¨è¿è¡Œæ—¶è¢«å¿½ç•¥
result = chain.invoke({"query": "...", "max_docs": 5})
# æ²¡æœ‰ç±»å‹æ£€æŸ¥å¼€é”€
```

**Python ç±»å‹æç¤ºçš„ç‰¹æ€§**ï¼š
- ç±»å‹æç¤ºæ˜¯**å¯é€‰çš„**
- ç±»å‹æ£€æŸ¥ç”±**é™æ€åˆ†æå·¥å…·**ï¼ˆmypyã€pyrightï¼‰å®Œæˆ
- è¿è¡Œæ—¶**å®Œå…¨å¿½ç•¥**ç±»å‹æç¤º
- **é›¶æ€§èƒ½å¼€é”€**

**Pydantic éªŒè¯çš„å¼€é”€**ï¼š

```python
from pydantic import BaseModel
import time

class Data(BaseModel):
    value: int

# æµ‹è¯• Pydantic å¼€é”€
start = time.time()
for i in range(10000):
    Data(value=i)
elapsed_pydantic = time.time() - start

# æµ‹è¯•æ— éªŒè¯
start = time.time()
for i in range(10000):
    {"value": i}
elapsed_dict = time.time() - start

print(f"Pydantic: {elapsed_pydantic:.3f}s")  # ~0.15s
print(f"Dict: {elapsed_dict:.3f}s")          # ~0.001s
print(f"å¼€é”€: {elapsed_pydantic / elapsed_dict:.1f}x")  # ~150x

# ä½†æ˜¯ï¼š
# 1. åªåœ¨è¾“å…¥è¾¹ç•ŒéªŒè¯ï¼ˆæ¯ä¸ªè¯·æ±‚1æ¬¡ï¼‰
# 2. æ¢æ¥ç±»å‹å®‰å…¨å’Œæ•°æ®éªŒè¯
# 3. é¿å…è¿è¡Œæ—¶é”™è¯¯çš„æˆæœ¬è¿œé«˜äºéªŒè¯å¼€é”€
```

**æœ€ä½³å®è·µ**ï¼š
```python
# âœ… åœ¨è¾¹ç•ŒéªŒè¯ï¼ˆAPI è¾“å…¥ï¼‰
def api_endpoint(input: dict) -> dict:
    validated = UserInput(**input)  # Pydantic éªŒè¯
    result = internal_process(validated)  # å†…éƒ¨ä¸éªŒè¯
    return result

# âŒ ä¸è¦åœ¨æ¯ä¸ªå†…éƒ¨å‡½æ•°éƒ½éªŒè¯
def internal_function(input: UserInput) -> dict:
    # ä¸éœ€è¦å†æ¬¡éªŒè¯
    pass
```

### ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ

**å¿ƒç†åŸå› **ï¼š
- **è¿‡åº¦ä¼˜åŒ–**ï¼šæ‹…å¿ƒä»»ä½•é¢å¤–å¼€é”€
- **è¯¯è§£æœºåˆ¶**ï¼šä¸äº†è§£ç±»å‹æç¤ºçš„å·¥ä½œåŸç†
- **ç»éªŒè¿ç§»**ï¼šå…¶ä»–è¯­è¨€çš„ç±»å‹ç³»ç»Ÿç¡®å®æœ‰è¿è¡Œæ—¶å¼€é”€

**è®¤çŸ¥åå·®**ï¼š
- åªçœ‹åˆ° Pydantic çš„éªŒè¯å¼€é”€ï¼Œå¿½ç•¥äº†ç±»å‹æç¤ºçš„é›¶å¼€é”€
- æ²¡æœ‰è€ƒè™‘ç±»å‹å®‰å…¨é¿å…çš„é”™è¯¯æˆæœ¬

### æ­£ç¡®ç†è§£

**ç±»å‹ç³»ç»Ÿçš„ä»·å€¼ >> è½»å¾®çš„éªŒè¯å¼€é”€**

```python
# åœºæ™¯ï¼šAPI æ¥æ”¶ç”¨æˆ·è¾“å…¥
# æ— éªŒè¯ï¼šè¿è¡Œæ—¶é”™è¯¯ï¼Œç”¨æˆ·ä½“éªŒå·®ï¼Œè°ƒè¯•å›°éš¾
def process_query(input: dict):
    query = input["query"]  # ğŸ’¥ KeyErrorï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    max_docs = input["max_docs"]  # ğŸ’¥ KeyError
    # ... æ›´å¤šé”™è¯¯

# æœ‰éªŒè¯ï¼šå¼€å‘æ—¶å‘ç°é”™è¯¯ï¼Œç”Ÿäº§ç¯å¢ƒç¨³å®š
class QueryInput(BaseModel):
    query: str = Field(min_length=1)
    max_docs: int = Field(ge=1, le=100)

def process_query(input: dict):
    validated = QueryInput(**input)  # éªŒè¯ä¸€æ¬¡ï¼ˆ~0.01msï¼‰
    # åç»­ä»£ç ä¿è¯ç±»å‹æ­£ç¡®
    # é¿å…ç”Ÿäº§ç¯å¢ƒé”™è¯¯ï¼ˆä»·å€¼ >> 0.01msï¼‰
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
- ç±»å‹æç¤ºï¼š0ms å¼€é”€
- Pydantic éªŒè¯ï¼š~0.01ms/æ¬¡ï¼ˆåªåœ¨è¾¹ç•Œï¼‰
- ç”Ÿäº§ç¯å¢ƒé”™è¯¯ï¼šæ•°å°æ—¶è°ƒè¯• + ç”¨æˆ·æµå¤±

**å…³é”®æ´å¯Ÿ**ï¼š
- ç±»å‹å®‰å…¨æ˜¯**æŠ•èµ„**ï¼Œä¸æ˜¯æˆæœ¬
- å¼€å‘æ—¶å‘ç°é”™è¯¯ >> ç”Ÿäº§æ—¶å‘ç°é”™è¯¯
- è½»å¾®çš„éªŒè¯å¼€é”€æ¢æ¥ç¨³å®šæ€§

---

## è¯¯åŒº3ï¼šæ‰€æœ‰ Runnable éƒ½å¯ä»¥è‡ªç”±ç»„åˆ âŒ

### é”™è¯¯è§‚ç‚¹

"åªè¦æ˜¯ Runnableï¼Œå°±å¯ä»¥ç”¨ `|` éšæ„ç»„åˆï¼ŒLangChain ä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡ã€‚"

### ä¸ºä»€ä¹ˆé”™ï¼Ÿ

**è¾“å…¥è¾“å‡ºç±»å‹å¿…é¡»åŒ¹é…**

```python
from langchain_core.runnables import Runnable
from typing import TypedDict

class StepAOutput(TypedDict):
    result: str

class StepBInput(TypedDict):
    data: int  # ä¸åŒ¹é…ï¼

step_a: Runnable[dict, StepAOutput] = ...  # è¾“å‡º {"result": "..."}
step_b: Runnable[StepBInput, str] = ...    # éœ€è¦ {"data": 123}

# âŒ ç±»å‹ä¸åŒ¹é…
chain = step_a | step_b
result = chain.invoke({"input": "test"})
# ğŸ’¥ è¿è¡Œæ—¶é”™è¯¯ï¼šstep_b æœŸæœ› "data" å­—æ®µï¼Œä½†æ”¶åˆ° "result"
```

**è‡ªåŠ¨è½¬æ¢çš„é™åˆ¶**ï¼š

LangChain åªèƒ½è‡ªåŠ¨è½¬æ¢**å°‘æ•°ç‰¹å®šç±»å‹**ï¼š

```python
# âœ… è‡ªåŠ¨è½¬æ¢ï¼šstr â†’ ChatPromptValue
prompt = ChatPromptTemplate.from_template("...")
llm = ChatOpenAI()
chain = prompt | llm  # prompt è¾“å‡º ChatPromptValueï¼Œllm æ¥å—

# âœ… è‡ªåŠ¨è½¬æ¢ï¼šdict â†’ RunnableParallel
chain = {"key": runnable} | next_step

# âŒ ä¸èƒ½è‡ªåŠ¨è½¬æ¢ï¼šä»»æ„ç±»å‹ä¸åŒ¹é…
class OutputA(TypedDict):
    field1: str

class InputB(TypedDict):
    field2: str  # ä¸åŒå­—æ®µå

step_a: Runnable[dict, OutputA] = ...
step_b: Runnable[InputB, str] = ...
chain = step_a | step_b  # ğŸ’¥ è¿è¡Œæ—¶é”™è¯¯
```

**å¸¸è§é”™è¯¯åœºæ™¯**ï¼š

```python
# åœºæ™¯1ï¼šå­—æ®µåä¸åŒ¹é…
retriever_output = {"docs": [...]}
formatter_input = {"documents": [...]}  # æœŸæœ›ä¸åŒå­—æ®µå
chain = retriever | formatter  # ğŸ’¥ é”™è¯¯

# åœºæ™¯2ï¼šæ•°æ®ç»“æ„ä¸åŒ¹é…
step1_output = ["item1", "item2"]  # åˆ—è¡¨
step2_input = {"items": [...]}     # æœŸæœ›å­—å…¸
chain = step1 | step2  # ğŸ’¥ é”™è¯¯

# åœºæ™¯3ï¼šç±»å‹å®Œå…¨ä¸åŒ
step1_output = "string"
step2_input = 123  # æœŸæœ›æ•´æ•°
chain = step1 | step2  # ğŸ’¥ é”™è¯¯
```

### ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ

**å¿ƒç†åŸå› **ï¼š
- **è¿‡åº¦ä¿¡ä»»**ï¼šè®¤ä¸ºæ¡†æ¶ä¼š"æ™ºèƒ½"å¤„ç†ä¸€åˆ‡
- **ç±»æ¯”é”™è¯¯**ï¼šUnix ç®¡é“å¯ä»¥è¿æ¥ä»»æ„å‘½ä»¤ï¼ˆå› ä¸ºéƒ½æ˜¯æ–‡æœ¬æµï¼‰
- **æ–‡æ¡£è¯¯å¯¼**ï¼šç¤ºä¾‹ä»£ç éƒ½æ˜¯ç±»å‹åŒ¹é…çš„ï¼Œæ²¡æœ‰å±•ç¤ºå¤±è´¥æ¡ˆä¾‹

**è®¤çŸ¥åå·®**ï¼š
- åªçœ‹åˆ°æˆåŠŸçš„ç»„åˆï¼Œå¿½ç•¥äº†ç±»å‹åŒ¹é…çš„å‰æ
- æ²¡æœ‰ç†è§£ Runnable çš„ç±»å‹ç³»ç»Ÿ

### æ­£ç¡®ç†è§£

**ç®¡é“ç»„åˆ = ç±»å‹å®‰å…¨çš„å‡½æ•°ç»„åˆ**

```python
# ç±»æ¯”ï¼šå‡½æ•°ç»„åˆ
def f(x: int) -> str:
    return str(x)

def g(x: str) -> float:
    return float(x)

# âœ… ç±»å‹åŒ¹é…
result = g(f(5))  # int â†’ str â†’ float

# âŒ ç±»å‹ä¸åŒ¹é…
def h(x: list) -> int:
    return len(x)

result = h(f(5))  # ğŸ’¥ é”™è¯¯ï¼šf è¿”å› strï¼Œh æœŸæœ› list
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨é€‚é…å™¨ Runnable**
   ```python
   from langchain_core.runnables import RunnableLambda

   # é€‚é…å™¨ï¼šè½¬æ¢æ•°æ®æ ¼å¼
   adapter = RunnableLambda(lambda x: {"documents": x["docs"]})

   # ç»„åˆ
   chain = retriever | adapter | formatter
   ```

2. **ä½¿ç”¨ RunnablePassthrough.assign()**
   ```python
   from langchain_core.runnables import RunnablePassthrough

   # ä¿æŒåŸå§‹æ•°æ®ï¼Œæ·»åŠ æ–°å­—æ®µ
   chain = (
       retriever
       | RunnablePassthrough.assign(
           formatted=formatter
       )
   )
   ```

3. **æ˜ç¡®ç±»å‹å¹¶éªŒè¯**
   ```python
   from typing import TypedDict

   class StepAOutput(TypedDict):
       result: str

   class StepBInput(TypedDict):
       result: str  # ç¡®ä¿åŒ¹é…

   step_a: Runnable[dict, StepAOutput] = ...
   step_b: Runnable[StepBInput, str] = ...
   chain = step_a | step_b  # âœ… ç±»å‹åŒ¹é…
   ```

**å…³é”®æ´å¯Ÿ**ï¼š
- ç®¡é“æ“ä½œç¬¦ä¸æ˜¯é­”æ³•ï¼Œéµå¾ªç±»å‹è§„åˆ™
- ç±»å‹ä¸åŒ¹é…ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
- ä½¿ç”¨ç±»å‹æç¤ºå’Œ IDE æå‰å‘ç°é—®é¢˜

---

## æ€»ç»“

### ä¸‰å¤§è¯¯åŒºå¯¹æ¯”

| è¯¯åŒº | é”™è¯¯è§‚ç‚¹ | æ­£ç¡®ç†è§£ |
|------|----------|----------|
| æ€§èƒ½ | åªæ˜¯è¯­æ³•ç³–ï¼Œæ— æ€§èƒ½ä¼˜åŠ¿ | ä¼˜åŒ–çš„æ‰§è¡Œå¼•æ“ï¼Œæµå¼é™ä½å»¶è¿Ÿ 67% |
| ç±»å‹ | ç±»å‹æ¨æ–­é™ä½æ€§èƒ½ | å¼€å‘æ—¶æ£€æŸ¥ï¼Œè¿è¡Œæ—¶é›¶å¼€é”€ |
| ç»„åˆ | æ‰€æœ‰ Runnable å¯è‡ªç”±ç»„åˆ | å¿…é¡»ç±»å‹åŒ¹é…ï¼Œéœ€è¦é€‚é…å™¨ |

### é¿å…è¯¯åŒºçš„æ–¹æ³•

1. **å®é™…æµ‹é‡æ€§èƒ½**
   - ä¸è¦å‡­ç›´è§‰åˆ¤æ–­
   - ä½¿ç”¨ profiler æµ‹é‡
   - å¯¹æ¯”ä¸åŒå®ç°æ–¹å¼

2. **ç†è§£åº•å±‚æœºåˆ¶**
   - é˜…è¯»æºç 
   - ç†è§£ç±»å‹ç³»ç»Ÿ
   - äº†è§£ä¼˜åŒ–ç­–ç•¥

3. **ä½¿ç”¨ç±»å‹æç¤º**
   - å¼€å‘æ—¶å‘ç°é—®é¢˜
   - IDE è‡ªåŠ¨è¡¥å…¨
   - é¿å…è¿è¡Œæ—¶é”™è¯¯

4. **é€æ­¥è°ƒè¯•**
   - æµ‹è¯•æ¯ä¸ªæ­¥éª¤
   - éªŒè¯è¾“å…¥è¾“å‡º
   - ä½¿ç”¨è°ƒè¯•å·¥å…·

### æ·±å…¥å­¦ä¹ èµ„æº

- [LangChain æ€§èƒ½ä¼˜åŒ–](https://blog.langchain.com/how-do-i-speed-up-my-agent)
- [LCEL ç”Ÿäº§å®è·µ](https://medium.com/@sajo02/building-production-ready-ai-pipelines-with-langchain-runnables-a-complete-lcel-guide-2f9b27f6d557)
- [ç®¡é“æ“ä½œç¬¦åŸç†](https://medium.com/@MichaelHashimoto/why-the-pipe-character-works-in-langchains-lcel-b4e8685855f5)

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-19
**ç»´æŠ¤è€…**: Claude Code

**ä¸‹ä¸€æ­¥**: é˜…è¯» `08_é¢è¯•å¿…é—®.md` å‡†å¤‡é¢è¯•é—®é¢˜
