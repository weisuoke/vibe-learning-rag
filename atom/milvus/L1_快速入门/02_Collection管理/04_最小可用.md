# 最小可用知识

掌握以下内容，就能开始使用 Collection 管理功能：

## 4.1 创建一个基本的 Collection

**核心步骤：定义 Schema → 创建 Collection**

```python
from pymilvus import Collection, CollectionSchema, FieldSchema, DataType, connections

# 1. 连接到 Milvus
connections.connect(host="localhost", port="19530")

# 2. 定义 Schema（3个必需字段）
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=False),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768),
    FieldSchema(name="text", dtype=DataType.VARCHAR, max_length=500)
]

schema = CollectionSchema(fields=fields, description="我的第一个 Collection")

# 3. 创建 Collection
collection = Collection(name="my_collection", schema=schema)

print(f"✅ Collection '{collection.name}' 创建成功！")
```

**记住这3个要点：**
- 主键字段：`is_primary=True`
- 向量字段：必须指定 `dim`
- VARCHAR 字段：必须指定 `max_length`

## 4.2 检查和获取 Collection

**核心操作：检查存在 → 获取 Collection**

```python
from pymilvus import utility, Collection

# 检查 Collection 是否存在
if utility.has_collection("my_collection"):
    print("✅ Collection 存在")

    # 获取 Collection 对象
    collection = Collection("my_collection")

    # 查看基本信息
    print(f"字段数量: {len(collection.schema.fields)}")
    print(f"数据量: {collection.num_entities}")
else:
    print("❌ Collection 不存在")
```

**记住这2个方法：**
- `utility.has_collection(name)`: 检查是否存在
- `Collection(name)`: 获取 Collection 对象

## 4.3 加载 Collection 到内存

**核心操作：加载 → 检索 → 释放**

```python
from pymilvus import Collection

collection = Collection("my_collection")

# 加载到内存（检索前必须执行）
collection.load()
print("✅ Collection 已加载")

# ... 执行检索操作 ...

# 释放内存（可选）
collection.release()
print("✅ Collection 已释放")
```

**记住这个规则：**
- 检索前必须 `load()`
- 不用时可以 `release()` 释放内存

## 4.4 删除 Collection

**核心操作：确认 → 删除**

```python
from pymilvus import utility

# 删除 Collection（不可逆！）
if utility.has_collection("my_collection"):
    utility.drop_collection("my_collection")
    print("✅ Collection 已删除")
```

**⚠️ 警告：删除操作不可逆，请谨慎使用！**

## 4.5 完整的最小示例

```python
"""
Collection 管理最小示例
演示：创建 → 使用 → 删除的完整流程
"""

from pymilvus import connections, Collection, CollectionSchema, FieldSchema, DataType, utility

# ===== 1. 连接 Milvus =====
connections.connect(host="localhost", port="19530")
print("✅ 已连接到 Milvus")

# ===== 2. 创建 Collection =====
collection_name = "demo_collection"

# 检查是否已存在
if utility.has_collection(collection_name):
    print(f"⚠️  Collection '{collection_name}' 已存在，先删除")
    utility.drop_collection(collection_name)

# 定义 Schema
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=False),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=128),
    FieldSchema(name="title", dtype=DataType.VARCHAR, max_length=200)
]

schema = CollectionSchema(fields=fields, description="演示 Collection")

# 创建 Collection
collection = Collection(name=collection_name, schema=schema)
print(f"✅ Collection '{collection_name}' 创建成功")

# ===== 3. 查看 Collection 信息 =====
print(f"\n📊 Collection 信息:")
print(f"  - 名称: {collection.name}")
print(f"  - 描述: {collection.description}")
print(f"  - 字段数量: {len(collection.schema.fields)}")
print(f"  - 数据量: {collection.num_entities}")

# 遍历字段
print(f"\n📋 字段列表:")
for field in collection.schema.fields:
    print(f"  - {field.name} ({field.dtype})")

# ===== 4. 插入示例数据 =====
import random

data = [
    {
        "id": i,
        "embedding": [random.random() for _ in range(128)],
        "title": f"文档 {i}"
    }
    for i in range(10)
]

collection.insert(data)
print(f"\n✅ 插入了 {len(data)} 条数据")

# 刷新数据（确保数据持久化）
collection.flush()
print("✅ 数据已刷新")

# ===== 5. 创建索引（检索前必需）=====
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "L2",
    "params": {"nlist": 128}
}

collection.create_index(field_name="embedding", index_params=index_params)
print("✅ 索引创建成功")

# ===== 6. 加载 Collection =====
collection.load()
print("✅ Collection 已加载到内存")

# ===== 7. 执行检索 =====
query_vector = [random.random() for _ in range(128)]

search_params = {"metric_type": "L2", "params": {"nprobe": 10}}

results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param=search_params,
    limit=3,
    output_fields=["title"]
)

print(f"\n🔍 检索结果（Top 3）:")
for hits in results:
    for hit in hits:
        print(f"  - ID: {hit.id}, 距离: {hit.distance:.4f}, 标题: {hit.entity.get('title')}")

# ===== 8. 释放 Collection =====
collection.release()
print("\n✅ Collection 已释放")

# ===== 9. 删除 Collection（可选）=====
# utility.drop_collection(collection_name)
# print(f"✅ Collection '{collection_name}' 已删除")

print("\n🎉 完成！")
```

**运行输出示例：**
```
✅ 已连接到 Milvus
✅ Collection 'demo_collection' 创建成功

📊 Collection 信息:
  - 名称: demo_collection
  - 描述: 演示 Collection
  - 字段数量: 3
  - 数据量: 0

📋 字段列表:
  - id (DataType.INT64)
  - embedding (DataType.FLOAT_VECTOR)
  - title (DataType.VARCHAR)

✅ 插入了 10 条数据
✅ 数据已刷新
✅ 索引创建成功
✅ Collection 已加载到内存

🔍 检索结果（Top 3）:
  - ID: 5, 距离: 12.3456, 标题: 文档 5
  - ID: 2, 距离: 13.7890, 标题: 文档 2
  - ID: 8, 距离: 14.2345, 标题: 文档 8

✅ Collection 已释放

🎉 完成！
```

## 这些知识足以：

1. ✅ **创建自己的 Collection**
   - 定义 Schema（主键 + 向量 + 标量字段）
   - 创建 Collection

2. ✅ **管理 Collection 生命周期**
   - 检查 Collection 是否存在
   - 获取 Collection 信息
   - 加载和释放 Collection
   - 删除 Collection

3. ✅ **为 RAG 系统打基础**
   - 存储文档向量
   - 执行相似度检索
   - 管理元数据

## 下一步学习建议

掌握了最小可用知识后，可以继续学习：

1. **索引优化**（L2_核心功能/01_向量索引类型）
   - 不同索引类型的选择
   - 索引参数调优

2. **标量过滤**（L2_核心功能/03_标量过滤）
   - 结合向量检索和标量过滤
   - 提高检索精度

3. **分区管理**（L3_高级特性/01_分区管理）
   - 按业务逻辑分区
   - 提高检索效率

4. **性能优化**（L4_性能优化）
   - 索引参数调优
   - 查询优化
   - 资源配置

## 常见问题速查

### Q1: 创建 Collection 时报错 "collection already exists"

```python
# 解决方案：先检查是否存在
if utility.has_collection("my_collection"):
    utility.drop_collection("my_collection")

# 然后再创建
collection = Collection(name="my_collection", schema=schema)
```

### Q2: 检索时报错 "collection not loaded"

```python
# 解决方案：检索前必须加载
collection.load()

# 然后再检索
results = collection.search(...)
```

### Q3: 向量维度不匹配

```python
# 错误：Schema 定义 768 维，但插入 1536 维
# 解决方案：确保向量维度与 Schema 一致

# Schema 定义
FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768)

# 插入数据时
data = [{
    "id": 1,
    "embedding": [0.1] * 768  # 必须是 768 维
}]
```

### Q4: VARCHAR 字段报错 "max_length is required"

```python
# 错误：未指定 max_length
FieldSchema(name="title", dtype=DataType.VARCHAR)

# 解决方案：必须指定 max_length
FieldSchema(name="title", dtype=DataType.VARCHAR, max_length=200)
```

### Q5: 如何查看 Collection 的所有数据？

```python
# 使用 query 方法（不是 search）
collection.load()

# 查询所有数据（限制返回数量）
results = collection.query(
    expr="id >= 0",  # 查询条件
    output_fields=["id", "title"],  # 返回字段
    limit=100  # 限制返回数量
)

for result in results:
    print(result)
```

## 总结

**最小可用知识的5个核心操作：**

1. **创建**：`Collection(name, schema)`
2. **检查**：`utility.has_collection(name)`
3. **加载**：`collection.load()`
4. **释放**：`collection.release()`
5. **删除**：`utility.drop_collection(name)`

**记住这3个规则：**
- 主键字段必须有 `is_primary=True`
- 向量字段必须指定 `dim`
- VARCHAR 字段必须指定 `max_length`

**记住这1个流程：**
```
创建 Collection → 插入数据 → 创建索引 → 加载 → 检索
```

掌握了这些，你就可以开始构建自己的向量检索系统了！
