# 化骨绵掌：10 个知识卡片

## 卡片 1：Sub-Agent 的本质

**一句话：** Sub-Agent 是运行在独立 `pi` 进程中的 AI 代理，有自己的上下文窗口和工具集。

**举例：**
```typescript
// 主 Agent（进程 1）
上下文: 150K tokens
内存: 200MB

// Sub-Agent（进程 2 - 独立）
上下文: 0 tokens（全新）
内存: 50MB
```

**应用：** 在 pi-mono 中，通过进程隔离实现上下文独立，避免上下文污染，突破上下文限制。

---

## 卡片 2：三种执行模式

**一句话：** Single（单任务）、Parallel（并行）、Chain（链式）满足不同的任务协作需求。

**举例：**
- Single: `{ agent: "scout", task: "Find code" }`
- Parallel: `{ tasks: [task1, task2, task3] }`
- Chain: `{ chain: [step1, step2, step3] }`

**应用：** 根据任务依赖关系选择模式：有依赖用 Chain，无依赖用 Parallel，单任务用 Single。

---

## 卡片 3：Agent 定义格式

**一句话：** Markdown + YAML frontmatter 定义 Agent 的名称、工具集、模型和系统提示。

**举例：**
```markdown
---
name: scout
description: Fast reconnaissance
tools: read, grep, find, ls
model: claude-haiku-4-5
---

You are a fast scout agent...
```

**应用：** 创建专业化 Agent，如 Scout（侦查）、Planner（计划）、Worker（实现）、Reviewer（审查）。

---

## 卡片 4：Agent 发现机制

**一句话：** 动态扫描 `~/.pi/agent/agents/`（用户）和 `.pi/agents/`（项目）目录发现 Agents。

**举例：**
```typescript
const agents = discoverAgents(cwd, "both");
// 返回所有可用的 agents
```

**应用：** 支持热重载，编辑 Agent 文件后立即生效，无需重启 pi。

---

## 卡片 5：安全模型

**一句话：** 用户 Agents 完全信任，项目 Agents 需要审查和确认。

**举例：**
```
Run project-local agents?
Agents: custom-scout
Source: /path/to/project/.pi/agents

[Yes] [No]
```

**应用：** 默认只使用用户 Agents（`agentScope: "user"`），只在信任的仓库中启用项目 Agents。

---

## 卡片 6：{previous} 占位符

**一句话：** Chain Mode 中，`{previous}` 被替换为上一步的最终文本输出。

**举例：**
```typescript
// Step 1 输出
"Found auth code in src/auth.ts"

// Step 2 任务
"Based on {previous}, create plan"
// 实际接收
"Based on Found auth code in src/auth.ts, create plan"
```

**应用：** 设计好每一步的输出格式，确保包含必要信息供下一步使用。

---

## 卡片 7：流式更新

**一句话：** 通过 `onUpdate` 回调提供实时进度，显示工具调用和输出。

**举例：**
```
✓ scout (user)
→ grep /auth/ in src/
→ read src/auth.ts
Found authentication code...
3 turns ↑5k ↓2k $0.01
```

**应用：** 提升用户体验，让用户看到 Sub-Agent 的执行过程和进度。

---

## 卡片 8：错误处理策略

**一句话：** Chain 失败停止，Parallel 部分失败继续，Single 直接返回错误。

**举例：**
```typescript
// Chain: Step 2 失败 → 停止
Step 1: ✓
Step 2: ✗ → 停止
Step 3: ⊘ 未执行

// Parallel: Task 2 失败 → 继续
Task 1: ✓
Task 2: ✗
Task 3: ✓
```

**应用：** Chain 适合严格工作流，Parallel 适合信息收集。

---

## 卡片 9：Usage 追踪

**一句话：** 实时追踪 tokens（输入/输出/缓存）和成本，支持聚合统计。

**举例：**
```
3 turns ↑5.2k ↓1.8k R10k W2k $0.0234 claude-sonnet-4
```

**应用：** 监控成本，选择合适的模型（Haiku 便宜、Sonnet 平衡、Opus 强大）。

---

## 卡片 10：最佳实践

**一句话：** 清晰职责、最小权限、合适模型、结构化输出、错误处理。

**举例：**
- Scout: 只读工具 + Haiku 模型
- Planner: 只读工具 + Sonnet 模型
- Worker: 完整工具 + Sonnet 模型

**应用：** 在 pi-mono 中，根据任务复杂度和安全需求设计 Agent，实现成本优化和安全保证。

---

## 学习路径

1. **快速上手**：卡片 1-3（本质、模式、定义）
2. **深入理解**：卡片 4-6（发现、安全、上下文）
3. **实战应用**：卡片 7-10（流式、错误、追踪、实践）

**记住**：Sub-Agents 是"独立的 AI 助手"，不是"函数调用"。理解这个区别是正确使用 Sub-Agents 的关键。
