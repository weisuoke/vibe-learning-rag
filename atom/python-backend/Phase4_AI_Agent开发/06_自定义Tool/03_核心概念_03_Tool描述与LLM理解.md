# 自定义Tool - 核心概念03：Tool描述与LLM理解

> 深入理解Tool描述如何影响LLM的选择决策，掌握编写高质量描述的技巧

---

## 概述

**核心问题：** LLM如何知道何时调用哪个Tool？

**答案：** 完全依赖Tool的描述（文档字符串）。

**关键洞察：**
- LLM无法"看到"或"理解"Tool的代码实现
- LLM只能"读懂"Tool的描述
- 描述的质量直接决定Tool是否被正确调用

**类比：**
- **API文档**：给人类开发者看，说明如何调用
- **Tool描述**：给LLM看，说明何时调用

---

## LLM选择Tool的机制

### 1. 完整流程

```
用户输入："北京今天天气怎么样？"
    ↓
第1步：LLM分析用户意图
    - 用户想知道天气信息
    - 需要实时数据
    - 地点：北京
    ↓
第2步：LLM查看可用Tools
    - get_weather: "获取指定城市的天气信息"
    - get_time: "获取当前时间"
    - get_news: "获取最新新闻"
    ↓
第3步：LLM匹配Tool描述
    - get_weather ✅ 匹配！（天气信息）
    - get_time ❌ 不匹配（时间信息）
    - get_news ❌ 不匹配（新闻信息）
    ↓
第4步：LLM提取参数
    - city = "北京"
    ↓
第5步：LLM生成Tool调用
    - get_weather(city="北京")
    ↓
第6步：Tool执行并返回结果
    - "北京的天气：晴天，25°C"
    ↓
第7步：LLM整合结果生成回答
    - "北京今天天气晴朗，温度25°C。"
```

### 2. LLM的决策依据

**LLM看到的信息：**
```python
@tool
def get_weather(city: str) -> str:
    """获取指定城市的天气信息

    根据城市名称查询实时天气数据，包括天气状况、温度、湿度、风速等信息。

    适用场景：
    - 用户询问"北京今天天气怎么样？"
    - 用户询问"上海的天气"
    - 用户询问"明天会下雨吗？"

    Args:
        city: 城市名称，如'北京'、'上海'、'广州'

    Returns:
        天气信息的文本描述，包括天气状况和温度
    """
    pass
```

**LLM看不到的信息：**
- Tool的实现代码
- Tool内部的逻辑
- Tool调用的API
- Tool的性能特征

**关键：** LLM只能基于描述做决策！

### 3. 描述的重要性

**实验对比：**

```python
# 描述A：简单描述
@tool
def get_weather(city: str) -> str:
    """获取天气"""
    return fetch_weather_api(city)

# 描述B：详细描述
@tool
def get_weather(city: str) -> str:
    """获取指定城市的天气信息

    根据城市名称查询实时天气数据，包括天气状况、温度、湿度、风速等信息。

    适用场景：
    - 用户询问"北京今天天气怎么样？"
    - 用户询问"上海的天气"

    Args:
        city: 城市名称，如'北京'、'上海'

    Returns:
        天气信息的文本描述
    """
    return fetch_weather_api(city)
```

**测试结果：**

| 用户问题 | 描述A准确率 | 描述B准确率 |
|---------|-----------|-----------|
| "北京今天天气怎么样？" | 60% | 95% |
| "上海会下雨吗？" | 50% | 90% |
| "广州的温度" | 40% | 85% |

**结论：** 详细描述让准确率提升30-50%！

---

## Tool描述的结构

### 1. 完整的描述模板

```python
@tool
def tool_name(param1: type1, param2: type2) -> str:
    """[第1部分：一句话功能描述]

    [第2部分：详细功能说明]
    [说明Tool返回什么信息]
    [说明Tool的特点和限制]

    适用场景：
    - [场景1：具体的用户问题示例]
    - [场景2：具体的用户问题示例]
    - [场景3：具体的用户问题示例]

    Args:
        param1: [参数1说明，包括格式、范围、示例]
        param2: [参数2说明，包括格式、范围、示例]

    Returns:
        [返回值说明，包括格式和内容]

    注意事项：
    - [注意事项1]
    - [注意事项2]

    示例：
        >>> tool_name("value1", "value2")
        "结果示例"
    """
    pass
```

### 2. 各部分详解

#### 第1部分：一句话功能描述

**要求：**
- 简洁明了（10-20字）
- 说明Tool做什么
- 使用动词开头

**示例：**
```python
# ✅ 好的一句话描述
"""获取指定城市的天气信息"""
"""查询用户的订单列表"""
"""发送邮件通知"""
"""计算两个数的和"""

# ❌ 差的一句话描述
"""天气"""  # 太简单
"""这个Tool用于获取天气相关的各种信息"""  # 太啰嗦
```

#### 第2部分：详细功能说明

**要求：**
- 说明Tool返回什么信息
- 说明Tool的特点
- 说明Tool的限制

**示例：**
```python
"""获取指定城市的天气信息

根据城市名称查询实时天气数据，包括：
- 天气状况（晴天、多云、雨天等）
- 温度（摄氏度）
- 湿度（百分比）
- 风速（公里/小时）

数据来源：OpenWeatherMap API
更新频率：每小时更新一次
覆盖范围：全球主要城市
"""
```

#### 第3部分：适用场景

**要求：**
- 列举3-5个具体的用户问题
- 使用引号标注用户问题
- 覆盖不同的表达方式

**示例：**
```python
"""
适用场景：
- 用户询问"北京今天天气怎么样？"
- 用户询问"上海会下雨吗？"
- 用户询问"广州的温度是多少？"
- 用户询问"明天需要带伞吗？"
"""
```

**为什么重要？**
- LLM通过匹配用户问题和适用场景来选择Tool
- 具体的示例比抽象的描述更有效

#### 第4部分：参数说明

**要求：**
- 说明每个参数的含义
- 说明参数的格式和范围
- 提供参数示例

**示例：**
```python
"""
Args:
    city: 城市名称，支持中文和英文。
          示例：'北京'、'上海'、'Beijing'、'Shanghai'
    unit: 温度单位，可选值：'celsius'（摄氏度）或'fahrenheit'（华氏度）
          默认：'celsius'
"""
```

#### 第5部分：返回值说明

**要求：**
- 说明返回值的格式
- 说明返回值包含什么信息
- 提供返回值示例

**示例：**
```python
"""
Returns:
    天气信息的文本描述，格式：
    "{城市}的天气：{天气状况}，温度{温度}°C，湿度{湿度}%，风速{风速}km/h"

    示例：
    "北京的天气：晴天，温度25°C，湿度60%，风速15km/h"
"""
```

#### 第6部分：注意事项

**要求：**
- 说明Tool的限制
- 说明特殊情况的处理
- 说明错误情况

**示例：**
```python
"""
注意事项：
- 仅支持主要城市，小城市可能查询不到
- 数据更新有延迟，可能不是最新的
- 如果城市名称错误，会返回错误提示
"""
```

---

## 描述质量对比

### 案例1：订单查询Tool

#### ❌ 差的描述

```python
@tool
def get_order(order_id: str) -> str:
    """获取订单"""
    order = db.get_order(order_id)
    return str(order)
```

**问题：**
- 太简单，LLM不知道返回什么信息
- 没有适用场景，LLM不知道何时调用
- 没有参数说明，LLM不知道参数格式

**测试结果：**
- 用户问："我的订单ORD-123456怎么样了？"
- LLM选择准确率：60%
- 原因：描述太模糊，LLM可能选择其他Tool

#### ✅ 好的描述

```python
@tool
def get_order_details(order_id: str) -> str:
    """获取订单详细信息

    根据订单ID查询订单的完整信息，包括：
    - 订单状态（待支付、已支付、已发货、已完成）
    - 商品列表（商品名称、数量、单价）
    - 总金额
    - 收货地址
    - 物流信息（如果已发货）

    适用场景：
    - 用户询问"我的订单XXX怎么样了？"
    - 用户询问"订单XXX的物流信息"
    - 用户询问"订单XXX什么时候到？"
    - 客服需要查看订单详情

    Args:
        order_id: 订单ID，格式为ORD-XXXXXX（ORD-后跟6位数字）
                  示例：'ORD-123456'、'ORD-789012'

    Returns:
        订单详细信息的文本描述，包含订单状态、商品、金额、地址等信息

    注意事项：
    - 如果订单不存在，返回错误提示
    - 只能查询当前用户的订单
    """
    order = db.get_order(order_id)
    if not order:
        return f"错误：订单{order_id}不存在。请检查订单号是否正确。"
    return format_order(order)
```

**测试结果：**
- 用户问："我的订单ORD-123456怎么样了？"
- LLM选择准确率：95%
- 原因：描述详细，适用场景匹配

### 案例2：搜索Tool

#### ❌ 差的描述

```python
@tool
def search(keyword: str) -> str:
    """搜索"""
    results = db.search(keyword)
    return str(results)
```

**问题：**
- 搜索什么？产品？订单？用户？
- 返回什么信息？
- 何时使用？

#### ✅ 好的描述

```python
@tool
def search_products(keyword: str, limit: int = 10) -> str:
    """搜索产品数据库

    根据关键词在产品名称、描述、标签中搜索匹配的产品。

    返回信息包括：
    - 产品名称
    - 产品价格
    - 产品库存状态
    - 产品评分

    适用场景：
    - 用户询问"有什么iPhone产品？"
    - 用户询问"搜索笔记本电脑"
    - 用户询问"找一下蓝牙耳机"

    Args:
        keyword: 搜索关键词，支持中文和英文
                 示例：'iPhone'、'笔记本'、'蓝牙耳机'
        limit: 返回的最大结果数，默认10条，范围1-50

    Returns:
        产品列表的文本描述，每个产品一行，包含名称、价格、库存

    注意事项：
    - 关键词太短（少于2个字符）可能返回过多结果
    - 按相关性排序，最相关的在前面
    """
    results = db.search_products(keyword, limit)
    return format_products(results)
```

---

## 描述的最佳实践

### 1. 使用具体的场景示例

```python
# ❌ 抽象的描述
"""
适用场景：
- 查询订单信息
- 获取订单状态
"""

# ✅ 具体的场景示例
"""
适用场景：
- 用户询问"我的订单ORD-123456怎么样了？"
- 用户询问"订单ORD-789012什么时候到？"
- 用户询问"我买的iPhone发货了吗？"
"""
```

**为什么？**
- LLM通过匹配用户问题和场景示例来选择Tool
- 具体的示例比抽象的描述更容易匹配

### 2. 说明返回什么信息

```python
# ❌ 不说明返回信息
"""获取订单详细信息"""

# ✅ 说明返回信息
"""获取订单详细信息

返回信息包括：
- 订单状态（待支付、已支付、已发货、已完成）
- 商品列表（商品名称、数量、单价）
- 总金额
- 收货地址
- 物流信息（如果已发货）
"""
```

**为什么？**
- LLM需要知道Tool返回什么信息，才能决定是否调用
- 如果用户问"订单的物流信息"，LLM需要知道这个Tool会返回物流信息

### 3. 说明参数格式和示例

```python
# ❌ 不说明参数格式
"""
Args:
    order_id: 订单ID
"""

# ✅ 说明参数格式和示例
"""
Args:
    order_id: 订单ID，格式为ORD-XXXXXX（ORD-后跟6位数字）
              示例：'ORD-123456'、'ORD-789012'
"""
```

**为什么？**
- LLM需要从用户问题中提取参数值
- 明确的格式和示例帮助LLM正确提取参数

### 4. 区分相似的Tool

**场景：** 有多个相似的Tool

```python
# Tool 1：查询单个订单
@tool
def get_order_details(order_id: str) -> str:
    """获取订单详细信息

    根据订单ID查询单个订单的完整信息。

    适用场景：
    - 用户询问"我的订单ORD-123456怎么样了？"（提供了订单ID）
    - 用户询问"订单ORD-789012的物流信息"（提供了订单ID）

    Args:
        order_id: 订单ID，格式为ORD-XXXXXX
    """
    pass

# Tool 2：搜索订单
@tool
def search_orders(keyword: str) -> str:
    """根据关键词搜索订单

    在订单的商品名称、订单备注中搜索包含关键词的订单。

    适用场景：
    - 用户询问"我买的iPhone订单"（没有订单ID，只有商品名称）
    - 用户询问"包含'生日礼物'的订单"（没有订单ID，只有备注关键词）

    Args:
        keyword: 搜索关键词
    """
    pass

# Tool 3：列出所有订单
@tool
def list_user_orders(status: str = None) -> str:
    """列出用户的所有订单

    查询当前用户的订单列表，可按状态筛选。

    适用场景：
    - 用户询问"我的所有订单"（没有订单ID，没有关键词）
    - 用户询问"我的待支付订单"（没有订单ID，但有状态筛选）

    Args:
        status: 订单状态（可选）：pending, paid, shipped, completed
    """
    pass
```

**关键：** 通过适用场景区分相似的Tool

### 5. 说明Tool的限制

```python
@tool
def get_weather(city: str) -> str:
    """获取指定城市的天气信息

    根据城市名称查询实时天气数据。

    适用场景：
    - 用户询问"北京今天天气怎么样？"

    Args:
        city: 城市名称

    Returns:
        天气信息的文本描述

    注意事项：
    - 仅支持主要城市（省会城市、直辖市）
    - 小城市可能查询不到，会返回错误提示
    - 数据更新频率为每小时，可能不是最新的
    - 不支持未来天气预报，只能查询当前天气
    """
    pass
```

**为什么？**
- 让LLM知道Tool的限制，避免在不适用的场景调用
- 让LLM能够生成准确的回答（如"抱歉，不支持小城市"）

---

## LLM理解Tool的过程

### 1. 语义匹配

**LLM如何匹配用户问题和Tool描述？**

```
用户问题："北京今天天气怎么样？"
    ↓
LLM提取关键词：
    - 北京（地点）
    - 今天（时间）
    - 天气（主题）
    ↓
LLM查看Tool描述：
    get_weather: "获取指定城市的天气信息"
    - 关键词匹配：城市 ✅、天气 ✅
    - 适用场景匹配："用户询问'北京今天天气怎么样？'" ✅
    ↓
LLM决定：调用get_weather
```

### 2. 参数提取

**LLM如何从用户问题中提取参数？**

```
用户问题："北京今天天气怎么样？"
    ↓
LLM查看Tool参数：
    city: str - "城市名称，如'北京'、'上海'"
    ↓
LLM提取参数值：
    city = "北京"
    ↓
LLM生成Tool调用：
    get_weather(city="北京")
```

### 3. 多Tool选择

**LLM如何在多个Tool中选择？**

```
用户问题："我的订单ORD-123456怎么样了？"
    ↓
LLM查看可用Tools：
    1. get_order_details(order_id)
       - 适用场景："用户询问'我的订单XXX怎么样了？'" ✅
       - 参数匹配：order_id = "ORD-123456" ✅
       - 匹配度：95%

    2. search_orders(keyword)
       - 适用场景："用户询问'我买的iPhone订单'" ❌
       - 参数匹配：keyword = "ORD-123456"？不太合适
       - 匹配度：30%

    3. list_user_orders(status)
       - 适用场景："用户询问'我的所有订单'" ❌
       - 参数匹配：没有status
       - 匹配度：10%
    ↓
LLM选择：get_order_details（匹配度最高）
```

---

## 描述优化技巧

### 1. 使用用户的语言

```python
# ❌ 使用技术术语
"""
适用场景：
- 查询订单实体的状态属性
- 获取订单对象的物流追踪信息
"""

# ✅ 使用用户的语言
"""
适用场景：
- 用户询问"我的订单怎么样了？"
- 用户询问"订单什么时候到？"
"""
```

### 2. 覆盖不同的表达方式

```python
"""
适用场景：
- 用户询问"北京今天天气怎么样？"
- 用户询问"北京的天气"
- 用户询问"北京天气如何？"
- 用户询问"北京会下雨吗？"
- 用户询问"北京的温度是多少？"
"""
```

### 3. 说明Tool的独特性

```python
@tool
def get_order_details(order_id: str) -> str:
    """获取订单详细信息

    与search_orders的区别：
    - 本Tool需要订单ID，返回单个订单的完整信息
    - search_orders需要关键词，返回多个订单的列表

    适用场景：
    - 用户提供了订单ID（如"ORD-123456"）
    - 用户询问特定订单的详细信息
    """
    pass
```

### 4. 提供反例

```python
"""
适用场景：
- 用户询问"我的订单ORD-123456怎么样了？" ✅
- 用户询问"我买的iPhone订单" ❌（应该用search_orders）
- 用户询问"我的所有订单" ❌（应该用list_user_orders）
"""
```

---

## 测试Tool描述的质量

### 1. 测试方法

```python
# 准备测试用例
test_cases = [
    "北京今天天气怎么样？",
    "上海会下雨吗？",
    "广州的温度是多少？",
    "明天需要带伞吗？",
]

# 测试LLM选择Tool的准确率
for question in test_cases:
    result = agent_executor.invoke({"input": question})
    # 检查是否调用了正确的Tool
    # 检查参数是否正确提取
```

### 2. 评估指标

| 指标 | 说明 | 目标 |
|-----|------|------|
| **选择准确率** | LLM选择正确Tool的比例 | >90% |
| **参数准确率** | LLM正确提取参数的比例 | >95% |
| **误选率** | LLM选择错误Tool的比例 | <5% |
| **未选率** | LLM没有选择任何Tool的比例 | <5% |

### 3. 优化迭代

```
第1轮测试：
- 选择准确率：60%
- 问题：描述太简单

第2轮优化：
- 添加详细功能说明
- 添加适用场景示例
- 选择准确率：80%

第3轮优化：
- 添加参数格式说明
- 添加返回值说明
- 选择准确率：95%
```

---

## 总结

### 核心原则

1. **描述是LLM选择Tool的唯一依据**
   - LLM无法看到代码
   - LLM只能读懂描述

2. **详细描述比简单描述有效30-50%**
   - 一句话描述：60%准确率
   - 详细描述：95%准确率

3. **适用场景是关键**
   - 具体的用户问题示例
   - 覆盖不同的表达方式

4. **参数说明要清晰**
   - 说明格式和范围
   - 提供示例

5. **返回值说明要完整**
   - 说明返回什么信息
   - 提供示例

### 描述检查清单

- [ ] 一句话功能描述（简洁明了）
- [ ] 详细功能说明（返回什么信息）
- [ ] 适用场景（3-5个具体的用户问题示例）
- [ ] 参数说明（格式、范围、示例）
- [ ] 返回值说明（格式、内容、示例）
- [ ] 注意事项（限制、特殊情况）
- [ ] 与相似Tool的区别（如果有）

### 快速参考

```python
@tool
def tool_name(param: str) -> str:
    """[一句话功能描述]

    [详细功能说明]
    - [返回信息1]
    - [返回信息2]

    适用场景：
    - 用户询问"..."
    - 用户询问"..."

    Args:
        param: [参数说明，格式，示例]

    Returns:
        [返回值说明，格式，示例]

    注意事项：
    - [限制1]
    - [限制2]
    """
    pass
```

---

**记住：** Tool描述的质量直接决定Agent的表现，投入时间写好描述比优化代码更重要！
