# 核心概念3：容器网络与数据持久化

## 概述

容器网络和数据持久化是 Docker 容器化的两个关键概念，决定了容器如何与外界通信以及如何保存数据。

---

## 一、容器网络

### 1. Docker 网络模式

Docker 提供了多种网络模式，适用于不同场景。

| 网络模式 | 说明 | 使用场景 |
|---------|------|---------|
| bridge | 默认模式，容器通过虚拟网桥通信 | ✅ 单机多容器应用 |
| host | 容器直接使用宿主机网络 | 性能要求高的场景 |
| none | 容器没有网络 | 安全隔离场景 |
| container | 容器共享另一个容器的网络 | 特殊场景 |

### 2. Bridge 网络（默认）

**工作原理：**

```
宿主机
├── docker0（虚拟网桥）
│   ├── 容器1（172.17.0.2）
│   ├── 容器2（172.17.0.3）
│   └── 容器3（172.17.0.4）
└── eth0（宿主机网卡）
```

**示例：**

```bash
# 运行容器（默认使用 bridge 网络）
docker run -d --name api my-app

# 查看容器 IP
docker inspect api | grep IPAddress
# "IPAddress": "172.17.0.2"

# 容器间通信
docker run -d --name db postgres:14
docker exec api ping db
# ping: db: Name or service not known（默认无法通过容器名通信）
```

### 3. 自定义网络（推荐）

**优势：**
- ✅ 容器间可以通过容器名通信
- ✅ 更好的隔离性
- ✅ 支持 DNS 解析

**创建自定义网络：**

```bash
# 创建自定义网络
docker network create my-network

# 运行容器并连接到自定义网络
docker run -d --name api --network my-network my-app
docker run -d --name db --network my-network postgres:14

# 容器间通信（通过容器名）
docker exec api ping db
# PING db (172.18.0.3): 56 data bytes
# 64 bytes from 172.18.0.3: icmp_seq=0 ttl=64 time=0.123 ms
```

### 4. 端口映射

**语法：**

```bash
docker run -p <宿主机端口>:<容器端口> my-app
```

**示例：**

```bash
# 映射单个端口
docker run -p 8000:8000 my-app
# 宿主机 8000 → 容器 8000

# 映射多个端口
docker run -p 8000:8000 -p 5678:5678 my-app

# 映射到不同端口
docker run -p 8080:8000 my-app
# 宿主机 8080 → 容器 8000

# 映射所有端口
docker run -P my-app
# 自动映射 EXPOSE 声明的端口
```

### 5. 容器间通信

**场景：** AI Agent API 需要连接 PostgreSQL 和 Redis

**方法1：使用自定义网络（推荐）**

```bash
# 创建网络
docker network create aiagent-network

# 运行数据库
docker run -d \
  --name db \
  --network aiagent-network \
  -e POSTGRES_PASSWORD=secret \
  postgres:14

# 运行 Redis
docker run -d \
  --name redis \
  --network aiagent-network \
  redis:7-alpine

# 运行 API
docker run -d \
  --name api \
  --network aiagent-network \
  -p 8000:8000 \
  -e DATABASE_URL=postgresql://postgres:secret@db:5432/aiagent \
  -e REDIS_URL=redis://redis:6379/0 \
  ai-agent-api:v1.0

# API 可以通过容器名访问数据库
# postgresql://postgres:secret@db:5432/aiagent
#                              ↑ 容器名
```

**方法2：使用 --link（已废弃）**

```bash
# ❌ 不推荐：使用 --link
docker run -d --name db postgres:14
docker run -d --name api --link db:db my-app
```

### 6. 网络管理命令

```bash
# 查看所有网络
docker network ls

# 查看网络详情
docker network inspect my-network

# 连接容器到网络
docker network connect my-network api

# 断开容器与网络的连接
docker network disconnect my-network api

# 删除网络
docker network rm my-network

# 清理未使用的网络
docker network prune
```

---

## 二、数据持久化

### 1. 容器文件系统的问题

**问题：** 容器删除后，容器内的数据会丢失。

```bash
# 运行 PostgreSQL 容器
docker run -d --name db postgres:14

# 写入数据
docker exec -it db psql -U postgres -c "CREATE TABLE users (id INT);"

# 删除容器
docker rm -f db

# 重新运行容器
docker run -d --name db postgres:14

# 数据丢失！
docker exec -it db psql -U postgres -c "SELECT * FROM users;"
# ERROR: relation "users" does not exist
```

### 2. Volume（数据卷）

**Volume 是 Docker 管理的持久化存储，独立于容器生命周期。**

**创建和使用 Volume：**

```bash
# 创建 Volume
docker volume create postgres_data

# 挂载 Volume
docker run -d \
  --name db \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:14

# 写入数据
docker exec -it db psql -U postgres -c "CREATE TABLE users (id INT);"

# 删除容器
docker rm -f db

# 重新运行容器（挂载同一个 Volume）
docker run -d \
  --name db \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:14

# 数据还在！
docker exec -it db psql -U postgres -c "SELECT * FROM users;"
# users
# ------
```

### 3. Bind Mount（绑定挂载）

**Bind Mount 将宿主机目录挂载到容器。**

**使用场景：**
- 开发环境（代码热更新）
- 配置文件挂载
- 日志文件挂载

**示例：**

```bash
# 挂载宿主机目录
docker run -d \
  --name api \
  -v /Users/wuxiao/project/app:/app \
  -p 8000:8000 \
  my-app

# 修改宿主机代码
echo "print('Hello')" >> /Users/wuxiao/project/app/main.py

# 容器内立即生效（如果使用 --reload）
```

### 4. Volume vs Bind Mount

| 特性 | Volume | Bind Mount |
|-----|--------|-----------|
| 管理方式 | Docker 管理 | 用户管理 |
| 存储位置 | /var/lib/docker/volumes/ | 用户指定路径 |
| 跨平台 | ✅ 好 | ⚠️ 路径不同 |
| 性能 | ✅ 好 | ✅ 好 |
| 推荐场景 | 生产环境数据持久化 | 开发环境代码挂载 |

### 5. 数据持久化最佳实践

**AI Agent API 数据持久化策略：**

```bash
# 1. 数据库数据（使用 Volume）
docker run -d \
  --name db \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:14

# 2. Redis 数据（使用 Volume）
docker run -d \
  --name redis \
  -v redis_data:/data \
  redis:7-alpine

# 3. 日志文件（使用 Volume）
docker run -d \
  --name api \
  -v api_logs:/app/logs \
  my-app

# 4. 上传文件（使用 Volume）
docker run -d \
  --name api \
  -v uploads:/app/uploads \
  my-app

# 5. 配置文件（使用 Bind Mount）
docker run -d \
  --name api \
  -v /path/to/config.yaml:/app/config.yaml:ro \
  my-app
```

### 6. Volume 管理命令

```bash
# 查看所有 Volume
docker volume ls

# 查看 Volume 详情
docker volume inspect postgres_data

# 删除 Volume
docker volume rm postgres_data

# 清理未使用的 Volume
docker volume prune

# 备份 Volume
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres_data.tar.gz /data

# 恢复 Volume
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/postgres_data.tar.gz -C /
```

---

## 三、实际应用：AI Agent API 网络与数据配置

### 完整示例

```bash
# 1. 创建自定义网络
docker network create aiagent-network

# 2. 创建 Volume
docker volume create postgres_data
docker volume create redis_data
docker volume create api_logs

# 3. 运行 PostgreSQL
docker run -d \
  --name db \
  --network aiagent-network \
  -v postgres_data:/var/lib/postgresql/data \
  -e POSTGRES_USER=aiagent \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=aiagent \
  postgres:14-alpine

# 4. 运行 Redis
docker run -d \
  --name redis \
  --network aiagent-network \
  -v redis_data:/data \
  redis:7-alpine

# 5. 运行 API
docker run -d \
  --name api \
  --network aiagent-network \
  -p 8000:8000 \
  -v api_logs:/app/logs \
  -e DATABASE_URL=postgresql://aiagent:secret@db:5432/aiagent \
  -e REDIS_URL=redis://redis:6379/0 \
  -e OPENAI_API_KEY=${OPENAI_API_KEY} \
  ai-agent-api:v1.0

# 6. 测试连接
curl http://localhost:8000/health
# {"status":"healthy","database":"connected","redis":"connected"}
```

### 使用 docker-compose（推荐）

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    networks:
      - aiagent-network
    volumes:
      - api_logs:/app/logs
    environment:
      - DATABASE_URL=postgresql://aiagent:secret@db:5432/aiagent
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - db
      - redis

  db:
    image: postgres:14-alpine
    networks:
      - aiagent-network
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=aiagent
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=aiagent

  redis:
    image: redis:7-alpine
    networks:
      - aiagent-network
    volumes:
      - redis_data:/data

networks:
  aiagent-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  api_logs:
```

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止所有服务
docker-compose down

# 停止并删除 Volume
docker-compose down -v
```

---

## 四、常见问题

### Q1: 容器间无法通信怎么办？

**检查网络配置：**

```bash
# 查看容器网络
docker inspect api | grep NetworkMode
docker inspect db | grep NetworkMode

# 确保容器在同一个网络
docker network inspect aiagent-network
```

### Q2: Volume 数据在哪里？

```bash
# 查看 Volume 存储位置
docker volume inspect postgres_data
# "Mountpoint": "/var/lib/docker/volumes/postgres_data/_data"

# 查看 Volume 内容（需要 root 权限）
sudo ls /var/lib/docker/volumes/postgres_data/_data
```

### Q3: 如何备份和恢复数据？

```bash
# 备份 PostgreSQL 数据
docker exec db pg_dump -U aiagent aiagent > backup.sql

# 恢复 PostgreSQL 数据
docker exec -i db psql -U aiagent aiagent < backup.sql
```

---

## 总结

**容器网络：**
1. ✅ 使用自定义网络（容器间通过容器名通信）
2. ✅ 使用端口映射（-p）暴露服务
3. ✅ 避免使用 --link（已废弃）

**数据持久化：**
1. ✅ 数据库数据使用 Volume
2. ✅ 日志文件使用 Volume
3. ✅ 配置文件使用 Bind Mount（只读）
4. ✅ 定期备份重要数据

**最佳实践：**
1. ✅ 使用 docker-compose 编排多容器应用
2. ✅ 为每个应用创建独立的网络
3. ✅ 为每个数据库创建独立的 Volume
4. ✅ 定期清理未使用的网络和 Volume

---

**版本：** v1.0
**最后更新：** 2026-02-12
**适用于：** Python 3.13+ / FastAPI / AI Agent 后端开发
