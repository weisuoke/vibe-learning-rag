# 面试必问

> **5 个核心问题与标准答案**

---

## 问题 1：Pi 支持哪些 Provider？如何添加自定义 Provider？

### 标准答案

**内置 Provider（15+）**：
- **主流云服务**：Anthropic (Claude)、OpenAI (GPT)、xAI (Grok)、Google (Gemini)
- **其他云服务**：Mistral、Cohere、Groq、Perplexity
- **自定义集成**：Ollama、LM Studio、OpenRouter、Azure OpenAI、AWS Bedrock

**添加自定义 Provider 步骤**：

1. **编辑 models.json**：

```json
{
  "providers": {
    "custom-provider": {
      "apiType": "openai-compatible",
      "baseUrl": "http://localhost:11434",
      "models": {
        "custom-model": {
          "id": "custom-model",
          "name": "Custom Model",
          "contextWindow": 8192,
          "maxOutput": 2048,
          "cost": { "input": 0.0, "output": 0.0 }
        }
      }
    }
  }
}
```

2. **配置认证（如需要）**：

```json
// auth.json
{
  "custom-provider": {
    "apiKey": "your-key"
  }
}
```

3. **重载配置**：

```bash
> /reload
```

**关键点**：
- apiType 决定 API 协议（anthropic-messages、openai-completions、google-generative-ai）
- baseUrl 指向 API 端点
- 支持 OpenAI 兼容 API 的服务都可以集成

---

## 问题 2：Scoped Models 的工作原理是什么？

### 标准答案

**定义**：Scoped Models 是预配置的 3-5 个常用模型，通过键盘快捷键快速循环切换。

**工作原理**：

1. **配置阶段**：

```json
// .pi/settings.json
{
  "scopedModels": [
    "claude-3-5-haiku-20241022",    // 索引 0
    "claude-3-5-sonnet-20241022",   // 索引 1
    "claude-opus-4-20250514"        // 索引 2
  ]
}
```

2. **切换机制**：

```typescript
// 伪代码
let currentIndex = 0;

function onCtrlP() {
  currentIndex = (currentIndex + 1) % scopedModels.length;
  switchToModel(scopedModels[currentIndex]);
}

function onShiftCtrlP() {
  currentIndex = (currentIndex - 1 + scopedModels.length) % scopedModels.length;
  switchToModel(scopedModels[currentIndex]);
}
```

3. **状态管理**：
   - 当前索引存储在会话状态
   - 切换时更新当前模型
   - 显示视觉反馈（如 "2/3"）

**优势**：
- 零中断切换（不需要输入命令）
- 肌肉记忆（固定的按键次数）
- 成本优化（按成本排序，默认用最便宜的）

**最佳实践**：
- 配置 3-5 个模型（太多会降低效率）
- 按成本递增排序
- 不同项目使用不同配置

---

## 问题 3：配置文件的优先级顺序是什么？

### 标准答案

**优先级顺序（从高到低）**：

```
1. 运行时命令 (/model, /provider)
2. CLI 参数 (--model, --provider)
3. 项目配置 (.pi/settings.json)
4. 全局配置 (~/.pi/agent/settings.json)
5. 环境变量 (ANTHROPIC_MODEL)
6. 默认值
```

**示例说明**：

```bash
# 场景：多层配置
# 全局配置
~/.pi/agent/settings.json:
{
  "defaultModel": "claude-3-5-haiku-20241022"
}

# 项目配置
.pi/settings.json:
{
  "defaultModel": "claude-3-5-sonnet-20241022"
}

# CLI 参数
pi --model claude-opus-4-20250514

# 实际使用：claude-opus-4-20250514（CLI 参数优先级最高）
```

**配置合并策略**：
- **深度合并**：不同字段会合并
- **覆盖规则**：相同字段高优先级覆盖低优先级

**实际应用**：
- **全局配置**：常用 Provider 和默认模型
- **项目配置**：项目特定的模型选择（如本地开发用 Ollama）
- **CLI 参数**：临时测试或脚本自动化
- **运行时命令**：会话内临时切换

**热重载**：
- 配置文件修改后使用 `/reload` 命令
- 无需重启 Pi
- 对话历史保留

---

## 问题 4：如何实现成本优化的模型切换策略？

### 标准答案

**核心策略**：根据任务复杂度选择合适的模型

**1. 任务分级**：

```typescript
interface TaskClassification {
  simple: string[];    // 格式化、简单修复
  medium: string[];    // 代码重构、功能开发
  complex: string[];   // 架构设计、算法优化
}

const strategy: TaskClassification = {
  simple: ['claude-3-5-haiku-20241022'],     // $0.8/MTok
  medium: ['claude-3-5-sonnet-20241022'],    // $3/MTok
  complex: ['claude-opus-4-20250514']        // $15/MTok
};
```

**2. 自动分类器**：

```typescript
function classifyTask(prompt: string): 'simple' | 'medium' | 'complex' {
  const simpleKeywords = ['format', 'fix typo', 'add comment'];
  const complexKeywords = ['architecture', 'design system', 'optimize'];

  if (simpleKeywords.some(k => prompt.toLowerCase().includes(k))) {
    return 'simple';
  }
  if (complexKeywords.some(k => prompt.toLowerCase().includes(k))) {
    return 'complex';
  }
  return 'medium';
}
```

**3. 成本对比**：

| 策略 | 日成本 | 月成本 | 节省 |
|------|--------|--------|------|
| 全部用 Opus | $15 | $450 | 0% |
| 智能选择 (80% Haiku + 15% Sonnet + 5% Opus) | $1.84 | $55 | 88% |

**4. 实施步骤**：

```bash
# 1. 配置 Scoped Models（按成本排序）
{
  "scopedModels": [
    "claude-3-5-haiku-20241022",
    "claude-3-5-sonnet-20241022",
    "claude-opus-4-20250514"
  ]
}

# 2. 默认使用 Haiku
pi  # 启动时使用第一个模型

# 3. 遇到复杂任务时按 Ctrl+P 升级
# 4. 任务完成后按 Shift+Ctrl+P 降级
```

**5. 监控与调整**：

```bash
# 查看成本
> /session

# 目标分布：80% Haiku, 15% Sonnet, 5% Opus
```

**关键指标**：
- **成本节省**：88%
- **质量保证**：简单任务 Haiku 成功率 95%+
- **效率提升**：快捷键切换 < 2 秒

---

## 问题 5：热重载机制是如何工作的？

### 标准答案

**定义**：热重载允许在不重启 Pi 的情况下重新加载配置文件。

**工作原理**：

1. **文件监听**：

```typescript
// 伪代码
const watchedFiles = [
  '~/.pi/agent/models.json',
  '~/.pi/agent/auth.json',
  '~/.pi/agent/settings.json',
  '.pi/settings.json',
  '.pi/SYSTEM.md',
  '.pi/AGENTS.md'
];

watchFiles(watchedFiles, (file) => {
  console.log(`File changed: ${file}`);
  reloadConfiguration();
});
```

2. **重载流程**：

```typescript
function reloadConfiguration() {
  // 1. 重新读取配置文件
  const models = loadJSON('~/.pi/agent/models.json');
  const auth = loadJSON('~/.pi/agent/auth.json');
  const settings = loadJSON('~/.pi/agent/settings.json');

  // 2. 合并配置（优先级）
  const config = mergeConfigs(models, auth, settings);

  // 3. 更新内部状态
  updateProviders(config.providers);
  updateModels(config.models);

  // 4. 通知用户
  console.log('✓ Configuration reloaded');
}
```

3. **使用方式**：

```bash
# 方式 1：手动重载
> /reload

# 方式 2：自动监听（如果启用）
# 修改配置文件后自动重载
```

**支持的配置**：
- ✅ models.json（模型定义）
- ✅ auth.json（API 密钥）
- ✅ settings.json（用户设置）
- ✅ SYSTEM.md（系统提示词）
- ✅ AGENTS.md（自定义 Agent）

**不支持热重载**：
- ❌ 环境变量（需要重启终端）
- ❌ CLI 参数（需要重新启动 Pi）

**优势**：
- **零中断**：对话历史保留
- **快速生效**：1-2 秒
- **开发友好**：快速迭代配置

**实际应用**：

```bash
# 场景：添加本地模型

# 1. Pi 保持运行
pi

# 2. 编辑配置（另一个终端）
vim ~/.pi/agent/models.json
# 添加 Ollama 配置

# 3. 重载配置
> /reload
✓ Configuration reloaded

# 4. 立即使用新模型
> /model
# 应该显示新添加的模型
```

**性能对比**：

| 操作 | 重启方式 | 热重载方式 |
|------|----------|------------|
| 时间 | 10-15 秒 | 1-2 秒 |
| 对话历史 | 丢失 | 保留 |
| 工作流中断 | 是 | 否 |

---

## 加分回答

### 问题 1 加分点

- 提到 apiType 的三种类型及其适用场景
- 说明 OpenAI 兼容 API 的广泛支持
- 提到企业代理配置

### 问题 2 加分点

- 解释为什么 3-5 个模型是最优选择
- 提到肌肉记忆和效率提升
- 说明不同项目可以有不同配置

### 问题 3 加分点

- 解释深度合并 vs 完全覆盖
- 提到安全性（auth.json 权限 0600）
- 说明项目配置的隔离性

### 问题 4 加分点

- 提供具体的成本数据（88% 节省）
- 解释 80/20 法则的应用
- 提到预算管理和监控

### 问题 5 加分点

- 解释文件监听机制
- 对比重启 vs 热重载的性能差异
- 提到哪些配置不支持热重载及原因

---

## 面试技巧

### 回答结构

1. **定义**：简洁定义概念
2. **原理**：解释工作机制
3. **示例**：提供代码或配置示例
4. **优势**：说明为什么这样设计
5. **实践**：实际应用场景

### 常见追问

**Q: 为什么不支持更多 Scoped Models？**
A: 3-5 个是认知负荷的最优解，超过 5 个会导致选择困难和切换效率降低。

**Q: 配置文件为什么要分层？**
A: 满足不同场景需求：全局配置通用设置，项目配置特定需求，CLI 参数临时测试。

**Q: 热重载会影响性能吗？**
A: 不会。文件监听是异步的，重载只在配置变化时触发，对正常使用无影响。

---

**记住**：理解原理比记住答案更重要，能够解释"为什么"比知道"是什么"更有价值。
