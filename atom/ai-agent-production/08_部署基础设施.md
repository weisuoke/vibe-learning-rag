# 部署与基础设施

**知识点数**: 12个 | **学习时长**: 2周 | **优先级**: P2

---

## 概览

**适合人群**: 运维方向、DevOps

**学习路径**: 容器化（4个）→ 云平台（4个）→ 运维自动化（4个）

---

## L1_容器化（4个知识点）

### 01_Docker基础

**核心概念**: 容器化AI应用。

**Dockerfile示例**:
```dockerfile
FROM python:3.13-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**构建和运行**:
```bash
# 构建镜像
docker build -t agent-app:latest .

# 运行容器
docker run -d -p 8000:8000 \
  -e OPENAI_API_KEY=$OPENAI_API_KEY \
  agent-app:latest
```

---

### 02_多阶段构建

**核心概念**: 优化镜像大小。

**多阶段Dockerfile**:
```dockerfile
# 构建阶段
FROM python:3.13 as builder

WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# 运行阶段
FROM python:3.13-slim

WORKDIR /app

# 只复制必要的文件
COPY --from=builder /root/.local /root/.local
COPY . .

ENV PATH=/root/.local/bin:$PATH

CMD ["uvicorn", "main:app", "--host", "0.0.0.0"]
```

---

### 03_Docker Compose

**核心概念**: 多容器编排。

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://user:pass@db:5432/agent
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=agent
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/chroma

volumes:
  postgres_data:
  chroma_data:
```

**使用**:
```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down
```

---

### 04_容器安全

**核心概念**: 保护容器安全。

**安全最佳实践**:
```dockerfile
# 使用非root用户
FROM python:3.13-slim

RUN useradd -m -u 1000 appuser

WORKDIR /app
COPY --chown=appuser:appuser . .

USER appuser

# 只读文件系统
CMD ["uvicorn", "main:app", "--host", "0.0.0.0"]
```

**安全扫描**:
```bash
# 使用Trivy扫描镜像
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image agent-app:latest
```

---

## L2_云平台（4个知识点）

### 01_AWS部署

**核心概念**: 在AWS上部署AI应用。

**使用ECS部署**:
```bash
# 1. 推送镜像到ECR
aws ecr get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin <account>.dkr.ecr.us-east-1.amazonaws.com

docker tag agent-app:latest <account>.dkr.ecr.us-east-1.amazonaws.com/agent-app:latest
docker push <account>.dkr.ecr.us-east-1.amazonaws.com/agent-app:latest

# 2. 创建ECS任务定义
aws ecs register-task-definition --cli-input-json file://task-definition.json

# 3. 创建服务
aws ecs create-service \
  --cluster agent-cluster \
  --service-name agent-service \
  --task-definition agent-task \
  --desired-count 2
```

**使用Lambda部署**:
```python
# lambda_handler.py
import json
from mangum import Mangum
from main import app

handler = Mangum(app)
```

---

### 02_GCP部署

**核心概念**: 在GCP上部署AI应用。

**使用Cloud Run部署**:
```bash
# 1. 构建并推送镜像
gcloud builds submit --tag gcr.io/PROJECT_ID/agent-app

# 2. 部署到Cloud Run
gcloud run deploy agent-service \
  --image gcr.io/PROJECT_ID/agent-app \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars OPENAI_API_KEY=$OPENAI_API_KEY
```

---

### 03_Azure部署

**核心概念**: 在Azure上部署AI应用。

**使用Azure Container Instances**:
```bash
# 创建容器实例
az container create \
  --resource-group agent-rg \
  --name agent-app \
  --image <registry>.azurecr.io/agent-app:latest \
  --dns-name-label agent-app \
  --ports 8000 \
  --environment-variables OPENAI_API_KEY=$OPENAI_API_KEY
```

---

### 04_云平台对比

**功能对比**:

| 特性 | AWS | GCP | Azure |
|------|-----|-----|-------|
| 容器服务 | ECS/EKS | Cloud Run/GKE | ACI/AKS |
| 无服务器 | Lambda | Cloud Functions | Functions |
| 托管数据库 | RDS | Cloud SQL | Azure SQL |
| 对象存储 | S3 | Cloud Storage | Blob Storage |
| 价格 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| 易用性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## L3_运维自动化（4个知识点）

### 01_Kubernetes基础

**核心概念**: K8s编排AI应用。

**Deployment配置**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agent
  template:
    metadata:
      labels:
        app: agent
    spec:
      containers:
      - name: agent
        image: agent-app:latest
        ports:
        - containerPort: 8000
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: agent-secrets
              key: openai-api-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
```

**Service配置**:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: agent-service
spec:
  selector:
    app: agent
  ports:
  - port: 80
    targetPort: 8000
  type: LoadBalancer
```

---

### 02_Helm包管理

**核心概念**: 简化K8s部署。

**Chart结构**:
```
agent-chart/
├── Chart.yaml
├── values.yaml
└── templates/
    ├── deployment.yaml
    ├── service.yaml
    └── ingress.yaml
```

**values.yaml**:
```yaml
replicaCount: 3

image:
  repository: agent-app
  tag: latest
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  port: 80

env:
  - name: OPENAI_API_KEY
    valueFrom:
      secretKeyRef:
        name: agent-secrets
        key: openai-api-key
```

**部署**:
```bash
# 安装
helm install agent-app ./agent-chart

# 升级
helm upgrade agent-app ./agent-chart

# 回滚
helm rollback agent-app 1
```

---

### 03_GitOps实践

**核心概念**: 声明式部署。

**ArgoCD配置**:
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: agent-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/org/agent-app
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

### 04_监控告警

**核心概念**: 全面监控系统。

**Prometheus配置**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s

    scrape_configs:
    - job_name: 'agent-app'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: agent
```

**Grafana Dashboard**:
```json
{
  "dashboard": {
    "title": "Agent Monitoring",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])"
          }
        ]
      }
    ]
  }
}
```

---

## 核心20%（3个知识点）

1. ⭐⭐⭐ **Docker基础**
2. ⭐⭐⭐ **Docker Compose**
3. ⭐⭐⭐ **Kubernetes基础**

---

## 实战项目

### 项目: 生产级部署

**目标**: 将Agent应用部署到生产环境。

**架构**:
```
用户 → Load Balancer → K8s Cluster
                         ├─ Agent Pods (3个)
                         ├─ PostgreSQL
                         ├─ Redis
                         └─ ChromaDB
```

**验收标准**:
- [ ] Docker镜像构建成功
- [ ] K8s部署成功
- [ ] 自动扩缩容配置
- [ ] 监控告警配置
- [ ] GitOps自动部署

---

## 学习资源

- [Docker文档](https://docs.docker.com/)
- [Kubernetes文档](https://kubernetes.io/docs/)
- [Helm文档](https://helm.sh/docs/)
- [ArgoCD文档](https://argo-cd.readthedocs.io/)

---

## 常见误区

1. ❌ "容器化会降低性能" → ✅ 开销很小
2. ❌ "K8s太复杂" → ✅ 从简单场景开始
3. ❌ "云平台锁定" → ✅ 使用标准化工具

---

**版本**: v1.0 | **最后更新**: 2026-02-12
