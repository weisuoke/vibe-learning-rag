# 实战代码

完整可运行的向量存储示例，覆盖 ChromaDB 和 Milvus。

---

## 示例1：ChromaDB 完整 RAG 流程

```python
"""
ChromaDB 实战示例
演示：从文档到检索的完整流程
"""

import chromadb
from chromadb.utils import embedding_functions

# ===== 1. 初始化 =====
print("=== 1. 初始化 ChromaDB ===")

# 使用持久化存储
client = chromadb.PersistentClient(path="./chroma_rag_demo")

# 使用默认的 Embedding 函数（all-MiniLM-L6-v2）
# 也可以使用 OpenAI：embedding_functions.OpenAIEmbeddingFunction(api_key="...")
default_ef = embedding_functions.DefaultEmbeddingFunction()

# 创建或获取集合
collection = client.get_or_create_collection(
    name="rag_documents",
    embedding_function=default_ef,
    metadata={"hnsw:space": "cosine"}  # 使用余弦相似度
)

print(f"集合名称: {collection.name}")
print(f"当前文档数: {collection.count()}")

# ===== 2. 添加文档 =====
print("\n=== 2. 添加文档 ===")

# 模拟 RAG 场景的文档
documents = [
    "Python 是一种高级编程语言，以简洁易读著称。它支持多种编程范式，包括面向对象、函数式编程。",
    "机器学习是人工智能的一个分支，通过数据训练模型来做出预测或决策。常见算法包括线性回归、决策树、神经网络。",
    "RAG（检索增强生成）是一种结合检索和生成的技术。它先从知识库检索相关文档，再用 LLM 生成答案。",
    "向量数据库专门用于存储和检索高维向量。常见的向量数据库包括 ChromaDB、Milvus、Pinecone 等。",
    "Embedding 是将文本转换为稠密向量的技术。好的 Embedding 能捕捉文本的语义信息，使语义相似的文本向量距离更近。"
]

metadatas = [
    {"category": "programming", "year": 2024, "source": "wiki"},
    {"category": "ai", "year": 2024, "source": "textbook"},
    {"category": "ai", "year": 2024, "source": "blog"},
    {"category": "database", "year": 2024, "source": "docs"},
    {"category": "ai", "year": 2024, "source": "paper"}
]

ids = [f"doc_{i}" for i in range(len(documents))]

# 添加文档（如果已存在则跳过）
if collection.count() == 0:
    collection.add(
        ids=ids,
        documents=documents,
        metadatas=metadatas
    )
    print(f"添加了 {len(documents)} 个文档")
else:
    print("文档已存在，跳过添加")

# ===== 3. 基本查询 =====
print("\n=== 3. 基本查询 ===")

query = "什么是 RAG？"
results = collection.query(
    query_texts=[query],
    n_results=3
)

print(f"查询: {query}")
print(f"返回 {len(results['documents'][0])} 个结果:")
for i, (doc, distance) in enumerate(zip(results['documents'][0], results['distances'][0])):
    print(f"  {i+1}. [相似度: {1-distance:.3f}] {doc[:50]}...")

# ===== 4. 带元数据过滤的查询 =====
print("\n=== 4. 带元数据过滤的查询 ===")

query = "人工智能相关技术"
results = collection.query(
    query_texts=[query],
    n_results=3,
    where={"category": {"$eq": "ai"}}  # 只搜索 AI 类别
)

print(f"查询: {query} (过滤: category=ai)")
print(f"返回 {len(results['documents'][0])} 个结果:")
for i, (doc, meta) in enumerate(zip(results['documents'][0], results['metadatas'][0])):
    print(f"  {i+1}. [{meta['source']}] {doc[:50]}...")

# ===== 5. 更新文档 =====
print("\n=== 5. 更新文档 ===")

collection.update(
    ids=["doc_0"],
    documents=["Python 是世界上最流行的编程语言之一，广泛用于 Web 开发、数据科学、人工智能等领域。"],
    metadatas=[{"category": "programming", "year": 2024, "source": "wiki", "updated": True}]
)
print("更新了 doc_0")

# ===== 6. 删除文档 =====
print("\n=== 6. 删除文档 ===")

# 按 ID 删除
# collection.delete(ids=["doc_0"])

# 按条件删除
# collection.delete(where={"year": {"$lt": 2020}})

print("删除操作示例（已注释，避免影响后续查询）")

# ===== 7. RAG 应用示例 =====
print("\n=== 7. RAG 应用示例 ===")

def simple_rag(query: str, collection, top_k: int = 3) -> str:
    """
    简单的 RAG 实现

    实际应用中，这里会调用 LLM 生成答案
    """
    # 1. 检索相关文档
    results = collection.query(
        query_texts=[query],
        n_results=top_k
    )

    # 2. 构建上下文
    context = "\n".join(results['documents'][0])

    # 3. 构建 Prompt（实际应用中发送给 LLM）
    prompt = f"""基于以下上下文回答问题：

上下文：
{context}

问题：{query}

答案："""

    return prompt

query = "向量数据库有哪些？"
prompt = simple_rag(query, collection)
print(f"生成的 RAG Prompt:\n{prompt[:500]}...")

print("\n=== 完成 ===")
```

**运行输出示例：**

```
=== 1. 初始化 ChromaDB ===
集合名称: rag_documents
当前文档数: 0

=== 2. 添加文档 ===
添加了 5 个文档

=== 3. 基本查询 ===
查询: 什么是 RAG？
返回 3 个结果:
  1. [相似度: 0.892] RAG（检索增强生成）是一种结合检索和生成的技术...
  2. [相似度: 0.654] 向量数据库专门用于存储和检索高维向量...
  3. [相似度: 0.621] Embedding 是将文本转换为稠密向量的技术...

=== 4. 带元数据过滤的查询 ===
查询: 人工智能相关技术 (过滤: category=ai)
返回 3 个结果:
  1. [textbook] 机器学习是人工智能的一个分支...
  2. [blog] RAG（检索增强生成）是一种结合检索和生成的技术...
  3. [paper] Embedding 是将文本转换为稠密向量的技术...
```

---

## 示例2：Milvus 完整 RAG 流程

```python
"""
Milvus 实战示例
演示：从文档到检索的完整流程（使用 Milvus Lite）
"""

from pymilvus import MilvusClient
from sentence_transformers import SentenceTransformer
import numpy as np

# ===== 1. 初始化 =====
print("=== 1. 初始化 Milvus ===")

# 使用 Milvus Lite（本地文件模式，无需 Docker）
client = MilvusClient("./milvus_rag_demo.db")

# 加载 Embedding 模型
model = SentenceTransformer('all-MiniLM-L6-v2')
DIMENSION = 384  # all-MiniLM-L6-v2 的维度

# 创建集合（如果不存在）
collection_name = "rag_documents"

if not client.has_collection(collection_name):
    client.create_collection(
        collection_name=collection_name,
        dimension=DIMENSION,
        metric_type="COSINE"
    )
    print(f"创建集合: {collection_name}")
else:
    print(f"集合已存在: {collection_name}")

# ===== 2. 添加文档 =====
print("\n=== 2. 添加文档 ===")

documents = [
    "Python 是一种高级编程语言，以简洁易读著称。",
    "机器学习是人工智能的一个分支，通过数据训练模型。",
    "RAG 是一种结合检索和生成的技术，先检索再生成。",
    "向量数据库专门用于存储和检索高维向量。",
    "Embedding 是将文本转换为稠密向量的技术。"
]

categories = ["programming", "ai", "ai", "database", "ai"]

# 生成 Embedding
embeddings = model.encode(documents)

# 准备数据
data = [
    {
        "id": i,
        "vector": embeddings[i].tolist(),
        "text": documents[i],
        "category": categories[i]
    }
    for i in range(len(documents))
]

# 插入数据
client.insert(collection_name=collection_name, data=data)
print(f"插入了 {len(documents)} 个文档")

# ===== 3. 基本查询 =====
print("\n=== 3. 基本查询 ===")

query = "什么是 RAG？"
query_embedding = model.encode([query])

results = client.search(
    collection_name=collection_name,
    data=query_embedding.tolist(),
    limit=3,
    output_fields=["text", "category"]
)

print(f"查询: {query}")
print(f"返回 {len(results[0])} 个结果:")
for i, hit in enumerate(results[0]):
    print(f"  {i+1}. [相似度: {hit['distance']:.3f}] {hit['entity']['text'][:50]}...")

# ===== 4. 带过滤的查询 =====
print("\n=== 4. 带过滤的查询 ===")

query = "人工智能技术"
query_embedding = model.encode([query])

results = client.search(
    collection_name=collection_name,
    data=query_embedding.tolist(),
    limit=3,
    filter='category == "ai"',  # 只搜索 AI 类别
    output_fields=["text", "category"]
)

print(f"查询: {query} (过滤: category=ai)")
print(f"返回 {len(results[0])} 个结果:")
for i, hit in enumerate(results[0]):
    print(f"  {i+1}. [{hit['entity']['category']}] {hit['entity']['text'][:50]}...")

# ===== 5. 删除数据 =====
print("\n=== 5. 删除数据 ===")

# 按 ID 删除
# client.delete(collection_name=collection_name, ids=[0])

# 按条件删除
# client.delete(collection_name=collection_name, filter='category == "programming"')

print("删除操作示例（已注释）")

# ===== 6. RAG 应用示例 =====
print("\n=== 6. RAG 应用示例 ===")

def milvus_rag(query: str, client, model, collection_name: str, top_k: int = 3) -> str:
    """Milvus RAG 实现"""
    # 1. 生成查询向量
    query_embedding = model.encode([query])

    # 2. 检索
    results = client.search(
        collection_name=collection_name,
        data=query_embedding.tolist(),
        limit=top_k,
        output_fields=["text"]
    )

    # 3. 构建上下文
    context = "\n".join([hit['entity']['text'] for hit in results[0]])

    # 4. 构建 Prompt
    prompt = f"""基于以下上下文回答问题：

上下文：
{context}

问题：{query}

答案："""

    return prompt

query = "向量数据库是什么？"
prompt = milvus_rag(query, client, model, collection_name)
print(f"生成的 RAG Prompt:\n{prompt}")

print("\n=== 完成 ===")
```

---

## 示例3：ChromaDB vs Milvus 性能对比

```python
"""
性能对比示例
演示：不同数据规模下的查询性能
"""

import time
import numpy as np

def benchmark_search(search_func, queries, name):
    """性能测试"""
    start = time.time()
    for q in queries:
        search_func(q)
    elapsed = time.time() - start
    qps = len(queries) / elapsed
    print(f"{name}: {elapsed:.3f}s, {qps:.1f} QPS")

# 生成测试数据
n_docs = 10000
n_queries = 100
dimension = 384

print(f"测试配置: {n_docs} 文档, {n_queries} 查询, {dimension} 维度")

# 实际测试代码需要初始化数据库并插入数据
# 这里只展示测试框架

"""
典型结果（参考）：

数据规模: 10,000 文档
- ChromaDB (HNSW): 0.5s, 200 QPS
- Milvus (HNSW): 0.3s, 333 QPS

数据规模: 100,000 文档
- ChromaDB (HNSW): 0.8s, 125 QPS
- Milvus (HNSW): 0.4s, 250 QPS

数据规模: 1,000,000 文档
- ChromaDB: 内存压力大
- Milvus (IVF): 0.6s, 166 QPS
"""
```

---

## 代码要点总结

| 操作 | ChromaDB | Milvus |
|------|----------|--------|
| 初始化 | `chromadb.Client()` | `MilvusClient("file.db")` |
| 创建集合 | `create_collection()` | `create_collection()` |
| 添加数据 | `collection.add()` | `client.insert()` |
| 查询 | `collection.query()` | `client.search()` |
| 过滤 | `where={"key": {"$eq": val}}` | `filter='key == val'` |
| Embedding | 自动生成 | 需要手动生成 |

---

**下一步：** [08_面试必问](./08_面试必问.md) - 面试高频问题与出彩回答
