# 一句话总结

> **用一句话记住 RunnablePassthrough 的精髓**

---

## 核心总结

**RunnablePassthrough 是 LCEL 中的"数据保险箱"，通过 assign 方法让你在不丢失任何原始信息的前提下逐步构建完整的数据上下文，是 RAG 管道中保持问题与上下文同步的关键工具。**

---

## 拆解这句话

### 1. "数据保险箱"
- 保护原始输入不被覆盖或丢失
- 确保所有历史数据在链中可访问
- 像保险箱一样安全地存储上下文

### 2. "assign 方法"
- 核心功能，区别于简单透传
- 在原有数据基础上添加新字段
- 不会破坏已有的数据结构

### 3. "不丢失任何原始信息"
- 每次 assign 都保留所有之前的字段
- 支持链式调用，逐步累积数据
- 避免数据在传递过程中丢失

### 4. "逐步构建完整的数据上下文"
- 第一步：原始输入
- 第二步：添加检索结果
- 第三步：添加生成答案
- 第四步：添加评估分数
- ...每一步都保留之前的所有数据

### 5. "RAG 管道中的关键工具"
- RAG 需要同时访问问题和检索结果
- 必须保持原始问题才能生成正确的 prompt
- 是 RAG 架构中不可或缺的组件

---

## 三个使用场景

### 场景1: RAG 上下文保持
```python
# 保持问题 + 添加检索结果
chain = RunnablePassthrough.assign(context=retriever)
```

### 场景2: 多步骤数据累积
```python
# 逐步添加：检索 → 答案 → 评分
chain = (
    RunnablePassthrough.assign(context=retriever)
    | RunnablePassthrough.assign(answer=prompt | model)
    | RunnablePassthrough.assign(score=evaluation_chain)
)
```

### 场景3: 并行处理 + 上下文保持
```python
# 保持原始输入 + 并行执行多个任务
chain = {
    "original": RunnablePassthrough(),
    "summary": summary_chain,
    "keywords": keyword_chain,
}
```

---

## 记忆口诀

**"透传保上下文，assign 添新字段，RAG 链不可缺"**

- **透传保上下文** - 核心作用是保持数据完整性
- **assign 添新字段** - 核心方法是 assign
- **RAG 链不可缺** - 核心应用是 RAG 管道

---

## 与其他工具的一句话对比

| 工具 | 一句话总结 |
|------|-----------|
| **RunnablePassthrough** | 数据保险箱，保持上下文不丢失 |
| **RunnableParallel** | 并行执行器，多任务同时跑 |
| **RunnableLambda** | 自定义转换器，任意逻辑都能写 |
| **RunnableBranch** | 条件路由器，根据条件选分支 |

---

## 什么时候用？

### ✅ 应该使用的场景
- RAG 管道需要保持原始问题
- 多步骤链需要访问所有历史数据
- 并行处理后需要保留原始输入
- 需要逐步构建复杂的数据字典

### ❌ 不需要使用的场景
- 简单的串行链（直接用 `|` 即可）
- 不需要保留中间结果
- 数据不需要在后续步骤访问
- 单步骤的简单转换

---

## 最小示例

```python
from langchain_core.runnables import RunnablePassthrough

# 保持原始输入 + 添加新字段
chain = RunnablePassthrough.assign(
    new_field=some_runnable
)

result = chain.invoke({"existing": "value"})
# {
#     "existing": "value",  # 保留
#     "new_field": ...      # 新增
# }
```

---

## 核心价值

RunnablePassthrough 解决了 LCEL 链中最常见的问题：**数据在传递过程中丢失**。

没有它，你需要：
- 手动管理变量作用域
- 手动合并字典
- 手动传递上下文

有了它，你只需：
- 使用 `RunnablePassthrough.assign()` 添加新字段
- 所有原始数据自动保留
- 链式调用自动累积数据

---

## 学习建议

1. **先理解透传** - 理解 identity 函数的概念
2. **再掌握 assign** - 理解如何添加新字段
3. **最后实践 RAG** - 在 RAG 管道中应用

---

## 参考资源

**官方文档（2025-2026）**：
- [RunnablePassthrough API Reference](https://reference.langchain.com/v0.3/python/core/runnables/langchain_core.runnables.passthrough.RunnablePassthrough.html)

**最佳实践（2025-2026）**：
- [LangChain Expression Language Explained](https://www.pinecone.io/learn/series/langchain/langchain-expression-language) - Pinecone LCEL 教程
- [Master LangChain in 2025](https://towardsai.net/p/machine-learning/master-langchain-in-2025-from-rag-to-tools-complete-guide) - 2025 完整指南

---

**版本**: v1.0
**最后更新**: 2026-02-19
**适用**: LangChain 0.3+, Python 3.13+
