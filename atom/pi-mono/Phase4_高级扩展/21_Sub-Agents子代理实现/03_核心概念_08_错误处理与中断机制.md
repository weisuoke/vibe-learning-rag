# 核心概念 08：错误处理与中断机制

## 1. 错误类型

### 1.1 Exit Code 错误

```typescript
// 进程退出码
exitCode === 0  // 成功
exitCode !== 0  // 失败

// 处理
if (result.exitCode !== 0) {
  return {
    content: [{ type: "text", text: errorMsg }],
    isError: true
  };
}
```

### 1.2 Stop Reason 错误

```typescript
// LLM 停止原因
stopReason === "end_turn"    // 正常结束
stopReason === "error"       // LLM 错误
stopReason === "aborted"     // 用户中断
stopReason === "max_tokens"  // 超出 token 限制

// 处理
if (stopReason === "error" || stopReason === "aborted") {
  return { content: [...], isError: true };
}
```

### 1.3 Stderr 错误

```typescript
// 捕获 stderr
proc.stderr.on('data', (data) => {
  currentResult.stderr += data.toString();
});

// 使用 stderr
if (result.stderr) {
  errorMsg = result.stderr;
}
```

---

## 2. Chain Mode 错误处理

### 2.1 失败停止策略

```typescript
// 任何步骤失败，整个链停止
for (let i = 0; i < chain.length; i++) {
  const result = await runSingleAgent(...);

  if (result.exitCode !== 0 || result.stopReason === "error") {
    return {
      content: [{ type: "text", text: `Chain stopped at step ${i + 1}` }],
      details: { mode: "chain", results: results },
      isError: true
    };
  }
}
```

### 2.2 错误传播

```typescript
// 错误信息包含
- 失败的步骤编号
- Agent 名称
- 错误消息
- 已完成的步骤结果

// 示例
"Chain stopped at step 2 (planner): API rate limit exceeded"
```

---

## 3. Parallel Mode 错误处理

### 3.1 部分失败策略

```typescript
// Parallel Mode：部分失败不影响其他任务
const results = await mapWithConcurrencyLimit(tasks, MAX_CONCURRENCY, ...);

// 结果包含所有任务（成功和失败）
const successCount = results.filter(r => r.exitCode === 0).length;

return {
  content: [{ type: "text", text: `Parallel: ${successCount}/${total} succeeded` }],
  details: { mode: "parallel", results }
};
```

### 3.2 错误汇总

```typescript
// 显示每个任务的状态
[scout] completed: Found frontend code
[scout] failed: API error
[scout] completed: Found database code
```

---

## 4. 中断机制

### 4.1 Abort Signal

```typescript
// 接收中断信号
async execute(toolCallId, params, signal, onUpdate, ctx) {
  // signal: AbortSignal
  if (signal) {
    signal.addEventListener('abort', () => {
      // 处理中断
    });
  }
}
```

### 4.2 进程终止

```typescript
// Ctrl+C 触发中断
if (signal) {
  const killProc = () => {
    wasAborted = true;
    proc.kill('SIGTERM');  // 优雅终止

    // 5 秒后强制终止
    setTimeout(() => {
      if (!proc.killed) proc.kill('SIGKILL');
    }, 5000);
  };

  if (signal.aborted) killProc();
  else signal.addEventListener('abort', killProc, { once: true });
}
```

### 4.3 中断传播

```typescript
// 主 Agent 中断 → Sub-Agent 中断
用户按 Ctrl+C
  ↓
signal.abort()
  ↓
killProc() 被调用
  ↓
proc.kill('SIGTERM')
  ↓
Sub-Agent 进程终止
```

---

## 5. 错误恢复

### 5.1 重试策略（未实现）

```typescript
// 未来可能支持
{
  agent: "scout",
  task: "...",
  retry: {
    maxAttempts: 3,
    backoff: "exponential"
  }
}
```

### 5.2 降级策略（未实现）

```typescript
// 未来可能支持
{
  chain: [
    { agent: "scout", task: "..." },
    { agent: "planner", task: "...", fallback: "simple-planner" }
  ]
}
```

---

## 6. 错误消息格式

### 6.1 错误优先级

```typescript
// 优先级：errorMessage > stderr > finalOutput
const errorMsg =
  result.errorMessage ||
  result.stderr ||
  getFinalOutput(result.messages) ||
  "(no output)";
```

### 6.2 错误显示

```typescript
// Single Mode
"Agent failed: API rate limit exceeded"

// Chain Mode
"Chain stopped at step 2 (planner): API rate limit exceeded"

// Parallel Mode
"Parallel: 2/3 succeeded
[scout] completed: ...
[scout] failed: API error
[scout] completed: ..."
```

---

## 7. 最佳实践

### 7.1 优雅降级

```typescript
// ✅ 好：提供有用的错误信息
if (result.exitCode !== 0) {
  return {
    content: [{ type: "text", text: `Failed: ${errorMsg}` }],
    details: { mode: "single", results: [result] },
    isError: true
  };
}

// ❌ 不好：无意义的错误
return { content: [{ type: "text", text: "Error" }] };
```

### 7.2 保留部分结果

```typescript
// Chain Mode：返回已完成的步骤
return {
  content: [{ type: "text", text: `Chain stopped at step ${i + 1}` }],
  details: { mode: "chain", results: completedResults },  // 保留已完成的
  isError: true
};
```

---

## 8. 总结

### 核心要点

1. **Exit Code**：进程退出码
2. **Stop Reason**：LLM 停止原因
3. **Chain 失败停止**：任何步骤失败，整个链停止
4. **Parallel 部分失败**：部分失败不影响其他任务
5. **Abort Signal**：Ctrl+C 中断支持

### 关键洞察

- **错误 = 透明**：清晰的错误消息
- **中断 = 优雅**：优雅终止进程
- **Chain = 严格**：失败即停止
- **Parallel = 宽松**：部分失败可接受

---

**参考资源**：
- [Node.js child_process 文档](https://nodejs.org/api/child_process.html)
- [AbortSignal 文档](https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal)
