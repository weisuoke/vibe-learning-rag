# 最小可用知识

掌握以下内容，就能开始使用 Docker 容器化 AI Agent API：

---

## 4.1 编写基础 Dockerfile

**核心知识：** 5个基础指令

```dockerfile
# 1. FROM - 指定基础镜像
FROM python:3.13-slim

# 2. WORKDIR - 设置工作目录
WORKDIR /app

# 3. COPY - 复制文件到镜像
COPY requirements.txt .

# 4. RUN - 执行命令（构建时）
RUN pip install --no-cache-dir -r requirements.txt

# 5. CMD - 启动命令（运行时）
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**实际应用：** 容器化 FastAPI 应用

```dockerfile
FROM python:3.13-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 4.2 构建和运行镜像

**核心命令：**

```bash
# 构建镜像
docker build -t my-app:v1.0 .
#            ↑ 镜像名:标签  ↑ Dockerfile 所在目录

# 运行容器
docker run -d -p 8000:8000 my-app:v1.0
#          ↑ 后台运行  ↑ 端口映射  ↑ 镜像名

# 查看运行中的容器
docker ps

# 查看日志
docker logs <container-id>

# 停止容器
docker stop <container-id>
```

**实际应用：** 部署 AI Agent API

```bash
# 1. 构建镜像
cd /path/to/ai-agent-api
docker build -t ai-agent-api:v1.0 .

# 2. 运行容器
docker run -d \
  -p 8000:8000 \
  -e OPENAI_API_KEY=${OPENAI_API_KEY} \
  --name ai-agent \
  ai-agent-api:v1.0

# 3. 测试
curl http://localhost:8000/health
# {"status":"healthy"}

# 4. 查看日志
docker logs -f ai-agent
```

---

## 4.3 环境变量配置

**核心知识：** 3种传递方式

**方式1：命令行传递**
```bash
docker run -e DATABASE_URL=postgresql://... my-app
```

**方式2：.env 文件**
```bash
# .env
DATABASE_URL=postgresql://user:pass@localhost:5432/db
OPENAI_API_KEY=sk-...

# 使用 .env 文件
docker run --env-file .env my-app
```

**方式3：Dockerfile 中设置默认值**
```dockerfile
FROM python:3.13-slim
ENV PYTHONUNBUFFERED=1
ENV LOG_LEVEL=info
```

**实际应用：** AI Agent API 环境配置

```bash
# .env
DATABASE_URL=postgresql://user:pass@db:5432/aiagent
REDIS_URL=redis://redis:6379/0
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1

# 运行容器
docker run --env-file .env -p 8000:8000 ai-agent-api:v1.0
```

**安全提示：** 不要在 Dockerfile 中硬编码敏感信息！

```dockerfile
# ❌ 错误：硬编码 API Key
ENV OPENAI_API_KEY=sk-1234567890

# ✅ 正确：运行时传递
# docker run -e OPENAI_API_KEY=${OPENAI_API_KEY} my-app
```

---

## 4.4 端口映射

**核心知识：** 容器端口映射到宿主机

```bash
docker run -p <宿主机端口>:<容器端口> my-app

# 示例
docker run -p 8000:8000 my-app
#            ↑ 宿主机    ↑ 容器
```

**实际应用：** 多个服务端口映射

```bash
# FastAPI 应用（8000）+ 调试端口（5678）
docker run -p 8000:8000 -p 5678:5678 my-app

# 访问
curl http://localhost:8000  # FastAPI
# 调试器连接 localhost:5678
```

**常见场景：**

```bash
# 场景1：宿主机端口被占用，映射到其他端口
docker run -p 8080:8000 my-app
# 访问 http://localhost:8080

# 场景2：多个容器运行同一镜像
docker run -p 8001:8000 --name app1 my-app
docker run -p 8002:8000 --name app2 my-app
# app1: http://localhost:8001
# app2: http://localhost:8002
```

---

## 4.5 数据持久化（Volume）

**核心知识：** 容器删除后数据会丢失，使用 Volume 持久化

**问题：** 容器内数据不持久

```bash
# 运行 PostgreSQL 容器
docker run -d --name db postgres:14

# 写入数据
docker exec -it db psql -U postgres -c "CREATE TABLE users (id INT);"

# 删除容器
docker rm -f db

# 重新运行
docker run -d --name db postgres:14

# 数据丢失！
docker exec -it db psql -U postgres -c "SELECT * FROM users;"
# ERROR: relation "users" does not exist
```

**解决方案：** 使用 Volume

```bash
# 创建 Volume
docker volume create postgres_data

# 挂载 Volume
docker run -d \
  --name db \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:14

# 写入数据
docker exec -it db psql -U postgres -c "CREATE TABLE users (id INT);"

# 删除容器
docker rm -f db

# 重新运行（挂载同一个 Volume）
docker run -d \
  --name db \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:14

# 数据还在！
docker exec -it db psql -U postgres -c "SELECT * FROM users;"
# users
# ------
```

**实际应用：** AI Agent API 数据持久化

```bash
# 创建 Volume
docker volume create aiagent_db
docker volume create aiagent_redis

# 运行数据库容器
docker run -d \
  --name db \
  -v aiagent_db:/var/lib/postgresql/data \
  -e POSTGRES_PASSWORD=secret \
  postgres:14

# 运行 Redis 容器
docker run -d \
  --name redis \
  -v aiagent_redis:/data \
  redis:7-alpine

# 运行 API 容器
docker run -d \
  --name api \
  -p 8000:8000 \
  -e DATABASE_URL=postgresql://postgres:secret@db:5432/aiagent \
  -e REDIS_URL=redis://redis:6379/0 \
  --link db:db \
  --link redis:redis \
  ai-agent-api:v1.0
```

**Volume 管理命令：**

```bash
# 查看所有 Volume
docker volume ls

# 查看 Volume 详情
docker volume inspect postgres_data

# 删除 Volume
docker volume rm postgres_data

# 清理未使用的 Volume
docker volume prune
```

---

## 这些知识足以

掌握以上5个核心知识点，你就能：

**基础能力：**
- ✅ 编写基础 Dockerfile 容器化 FastAPI 应用
- ✅ 构建和运行 Docker 镜像
- ✅ 配置环境变量（开发/生产环境）
- ✅ 映射端口访问容器服务
- ✅ 使用 Volume 持久化数据库数据

**实战项目：**
- ✅ 容器化简单的 AI Agent API
- ✅ 运行 PostgreSQL 和 Redis 容器
- ✅ 配置容器间通信
- ✅ 管理容器生命周期

**为后续学习打基础：**
- 多阶段构建优化镜像体积
- docker-compose 编排多容器
- 健康检查和资源限制
- 生产级安全配置

---

## 快速实战：5分钟容器化 FastAPI 应用

**步骤1：创建项目**

```bash
mkdir my-agent-api && cd my-agent-api
```

**步骤2：创建 FastAPI 应用**

```python
# app/main.py
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def root():
    return {"message": "Hello from Docker!"}

@app.get("/health")
async def health():
    return {"status": "healthy"}
```

**步骤3：创建依赖文件**

```txt
# requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
```

**步骤4：创建 Dockerfile**

```dockerfile
FROM python:3.13-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**步骤5：构建和运行**

```bash
# 构建镜像
docker build -t my-agent-api .

# 运行容器
docker run -d -p 8000:8000 --name my-api my-agent-api

# 测试
curl http://localhost:8000
# {"message":"Hello from Docker!"}

curl http://localhost:8000/health
# {"status":"healthy"}
```

**恭喜！** 你已经掌握了 Docker 容器化的最小可用知识。

---

## 常见问题

### Q1: 为什么要用 `--no-cache-dir`？

```dockerfile
RUN pip install --no-cache-dir -r requirements.txt
```

**原因：** 减小镜像体积

```bash
# 不使用 --no-cache-dir
RUN pip install -r requirements.txt
# 镜像体积：500MB（包含 pip 缓存）

# 使用 --no-cache-dir
RUN pip install --no-cache-dir -r requirements.txt
# 镜像体积：300MB（不包含 pip 缓存）
```

### Q2: 为什么要用 `--host 0.0.0.0`？

```dockerfile
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**原因：** 容器内的服务需要监听所有网络接口

```bash
# ❌ 错误：只监听 localhost
CMD ["uvicorn", "app.main:app", "--host", "127.0.0.1"]
# 宿主机无法访问容器服务

# ✅ 正确：监听所有网络接口
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
# 宿主机可以通过端口映射访问
```

### Q3: 如何调试容器内的应用？

**方法1：查看日志**
```bash
docker logs <container-id>
docker logs -f <container-id>  # 实时查看
```

**方法2：进入容器**
```bash
docker exec -it <container-id> bash
# 或
docker exec -it <container-id> sh  # alpine 镜像
```

**方法3：查看容器详情**
```bash
docker inspect <container-id>
```

### Q4: 如何更新容器？

```bash
# 1. 停止旧容器
docker stop my-api

# 2. 删除旧容器
docker rm my-api

# 3. 重新构建镜像
docker build -t my-agent-api:v2.0 .

# 4. 运行新容器
docker run -d -p 8000:8000 --name my-api my-agent-api:v2.0
```

**更好的方式：** 使用版本标签

```bash
# 构建新版本
docker build -t my-agent-api:v2.0 .

# 运行新版本
docker run -d -p 8001:8000 --name my-api-v2 my-agent-api:v2.0

# 测试新版本
curl http://localhost:8001

# 如果没问题，停止旧版本
docker stop my-api-v1

# 如果有问题，回滚
docker stop my-api-v2
docker start my-api-v1
```

### Q5: 如何清理 Docker 资源？

```bash
# 停止所有容器
docker stop $(docker ps -aq)

# 删除所有容器
docker rm $(docker ps -aq)

# 删除所有镜像
docker rmi $(docker images -q)

# 清理未使用的资源（推荐）
docker system prune -a
# 会删除：
# - 所有停止的容器
# - 所有未使用的网络
# - 所有未使用的镜像
# - 所有构建缓存
```

---

## 学习检查清单

完成本节学习后，你应该能够：

- [ ] 编写包含 FROM、WORKDIR、COPY、RUN、CMD 的 Dockerfile
- [ ] 使用 `docker build` 构建镜像
- [ ] 使用 `docker run` 运行容器
- [ ] 使用 `-p` 参数映射端口
- [ ] 使用 `-e` 或 `--env-file` 传递环境变量
- [ ] 使用 `-v` 参数挂载 Volume
- [ ] 使用 `docker ps` 查看运行中的容器
- [ ] 使用 `docker logs` 查看容器日志
- [ ] 使用 `docker exec` 进入容器
- [ ] 使用 `docker stop` 停止容器

---

## 下一步学习

掌握最小可用知识后，建议学习：

1. **多阶段构建**（核心概念2）
   - 减小镜像体积
   - 分离构建和运行环境

2. **docker-compose**（Phase6_部署与架构/02）
   - 编排多容器应用
   - 一条命令启动所有服务

3. **健康检查**（核心概念5）
   - HEALTHCHECK 指令
   - 容器自动重启

4. **安全最佳实践**（核心概念4）
   - 非 root 用户运行
   - Secrets 管理

---

**版本：** v1.0
**最后更新：** 2026-02-12
**适用于：** Python 3.13+ / FastAPI / AI Agent 后端开发
