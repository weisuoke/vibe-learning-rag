# åç›´è§‰ç‚¹

> **é‚£äº›çœ‹èµ·æ¥"åº”è¯¥è¿™æ ·"ï¼Œå®é™…ä¸Š"ä¸æ˜¯è¿™æ ·"çš„çŸ¥è¯†ç‚¹**

---

## ä¸ºä»€ä¹ˆéœ€è¦äº†è§£åç›´è§‰ç‚¹ï¼Ÿ

åœ¨å­¦ä¹  RunnablePassthrough æ—¶ï¼Œå¾ˆå¤šåˆå­¦è€…ä¼šåŸºäºç›´è§‰åšå‡ºé”™è¯¯çš„å‡è®¾ã€‚äº†è§£è¿™äº›åç›´è§‰ç‚¹å¯ä»¥ï¼š
- âœ… é¿å…å¸¸è§çš„é”™è¯¯
- âœ… åŠ æ·±å¯¹åŸç†çš„ç†è§£
- âœ… å†™å‡ºæ›´é«˜è´¨é‡çš„ä»£ç 
- âœ… åœ¨é¢è¯•ä¸­å±•ç°æ·±åº¦ç†è§£

---

## åç›´è§‰ç‚¹1: assign ä¸ä¼šè¦†ç›–å·²æœ‰å­—æ®µ

### âŒ ç›´è§‰è®¤ä¸º

"assign å°±åƒ Python çš„å­—å…¸æ›´æ–°ï¼Œä¼šè¦†ç›–å·²æœ‰å­—æ®µ"

```python
# Python å­—å…¸æ›´æ–°
d = {"name": "Alice"}
d.update({"name": "Bob"})  # è¦†ç›–
print(d)  # {"name": "Bob"}

# æ‰€ä»¥ RunnablePassthrough.assign ä¹Ÿä¼šè¦†ç›–ï¼Ÿ
chain = RunnablePassthrough.assign(name="Bob")
result = chain.invoke({"name": "Alice"})
# æœŸæœ›: {"name": "Bob"}
```

---

### âœ… å®é™…æƒ…å†µ

**assign ä¸åº”è¯¥è¦†ç›–å·²æœ‰å­—æ®µï¼Œå¦‚æœå°è¯•è¦†ç›–ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºæˆ–é”™è¯¯ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

# âŒ é”™è¯¯ï¼šå°è¯•è¦†ç›–å·²æœ‰å­—æ®µ
chain = RunnablePassthrough.assign(
    name=RunnableLambda(lambda x: "Bob")
)

result = chain.invoke({"name": "Alice"})
# å®é™…è¡Œä¸ºï¼šå¯èƒ½æŠ¥é”™æˆ–äº§ç”Ÿæ„å¤–ç»“æœ
# ä¸åŒç‰ˆæœ¬çš„ LangChain è¡Œä¸ºå¯èƒ½ä¸åŒ
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**ä½¿ç”¨ä¸åŒçš„é”®åï¼Œä¸è¦è¦†ç›–å·²æœ‰å­—æ®µ**

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸åŒçš„é”®å
chain = RunnablePassthrough.assign(
    new_name=RunnableLambda(lambda x: "Bob")
)

result = chain.invoke({"name": "Alice"})
print(result)
# {"name": "Alice", "new_name": "Bob"}
```

---

### ğŸ“š ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šassign çš„ç›®çš„æ˜¯"å¢å¼º"æ•°æ®ï¼Œè€Œä¸æ˜¯"ä¿®æ”¹"æ•°æ®ã€‚

- **å¢å¼º**ï¼šåœ¨åŸæœ‰æ•°æ®åŸºç¡€ä¸Šæ·»åŠ æ–°ä¿¡æ¯
- **ä¿®æ”¹**ï¼šæ”¹å˜åŸæœ‰æ•°æ®çš„å€¼

å¦‚æœéœ€è¦ä¿®æ”¹æ•°æ®ï¼Œåº”è¯¥ä½¿ç”¨ RunnableLambdaï¼š

```python
# å¦‚æœç¡®å®éœ€è¦ä¿®æ”¹å­—æ®µ
chain = RunnableLambda(lambda x: {
    **x,
    "name": "Bob"  # æ˜¾å¼è¦†ç›–
})
```

---

### ğŸ” 2025-2026 æœ€ä½³å®è·µ

æ ¹æ® [LangChain Best Practices (2025)](https://www.swarnendu.de/blog/langchain-best-practices)ï¼š

> "Use RunnablePassthrough.assign() to add new fields, not to modify existing ones. For modifications, use RunnableLambda with explicit dictionary merging."

---

## åç›´è§‰ç‚¹2: assign ä¸­çš„ Runnable æ¥æ”¶çš„æ˜¯åŸå§‹è¾“å…¥ï¼Œä¸æ˜¯ç´¯ç§¯åçš„è¾“å…¥

### âŒ ç›´è§‰è®¤ä¸º

"assign ä¸­çš„æ¯ä¸ª Runnable åº”è¯¥æ¥æ”¶ç´¯ç§¯åçš„è¾“å…¥"

```python
chain = RunnablePassthrough.assign(
    field1=runnable1,  # æ¥æ”¶åŸå§‹è¾“å…¥
    field2=runnable2,  # æ¥æ”¶ {åŸå§‹è¾“å…¥, field1}ï¼Ÿ
)

# æœŸæœ›ï¼šfield2 å¯ä»¥è®¿é—® field1
```

---

### âœ… å®é™…æƒ…å†µ

**assign ä¸­çš„æ‰€æœ‰ Runnable éƒ½æ¥æ”¶ç›¸åŒçš„åŸå§‹è¾“å…¥ï¼Œä¸æ˜¯ç´¯ç§¯åçš„è¾“å…¥ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

chain = RunnablePassthrough.assign(
    field1=RunnableLambda(lambda x: x["input"] + "_1"),
    field2=RunnableLambda(lambda x: x["input"] + "_2"),  # æ¥æ”¶åŸå§‹è¾“å…¥
)

result = chain.invoke({"input": "test"})
print(result)
# {
#     "input": "test",
#     "field1": "test_1",
#     "field2": "test_2"  # ä¸æ˜¯ "test_1_2"
# }
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**å¦‚æœéœ€è¦è®¿é—®å‰ä¸€æ­¥çš„ç»“æœï¼Œä½¿ç”¨é“¾å¼ assign**

```python
# âœ… æ­£ç¡®ï¼šé“¾å¼ assign
chain = (
    RunnablePassthrough.assign(
        field1=RunnableLambda(lambda x: x["input"] + "_1")
    )
    | RunnablePassthrough.assign(
        field2=RunnableLambda(lambda x: x["field1"] + "_2")  # å¯ä»¥è®¿é—® field1
    )
)

result = chain.invoke({"input": "test"})
print(result)
# {
#     "input": "test",
#     "field1": "test_1",
#     "field2": "test_1_2"  # åŸºäº field1
# }
```

---

### ğŸ“š ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šå•ä¸ª assign ä¸­çš„æ‰€æœ‰ Runnable åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚

- å¦‚æœ field2 ä¾èµ– field1ï¼Œå®ƒä»¬å°±ä¸èƒ½å¹¶è¡Œæ‰§è¡Œ
- å¿…é¡»ä¸²è¡Œæ‰§è¡Œï¼Œè¿™è¿èƒŒäº† assign çš„è®¾è®¡åˆè¡·

**é“¾å¼ assign æ˜ç¡®è¡¨è¾¾äº†ä¾èµ–å…³ç³»**ï¼š
- ç¬¬ä¸€ä¸ª assignï¼šç‹¬ç«‹çš„ Runnableï¼Œå¯ä»¥å¹¶è¡Œ
- ç¬¬äºŒä¸ª assignï¼šä¾èµ–ç¬¬ä¸€ä¸ª assign çš„ç»“æœï¼Œå¿…é¡»ä¸²è¡Œ

---

## åç›´è§‰ç‚¹3: RunnablePassthrough() ä¸æ˜¯"ä»€ä¹ˆéƒ½ä¸åš"

### âŒ ç›´è§‰è®¤ä¸º

"RunnablePassthrough() ä»€ä¹ˆéƒ½ä¸åšï¼Œæ˜¯ä¸ªå ä½ç¬¦"

```python
# æ—¢ç„¶ä»€ä¹ˆéƒ½ä¸åšï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥çœç•¥ï¼Ÿ
chain = {
    "data": RunnablePassthrough(),  # å¤šä½™ï¼Ÿ
    "processed": some_runnable,
}

# ä¸ºä»€ä¹ˆä¸å†™æˆï¼š
chain = {
    "processed": some_runnable,
}
```

---

### âœ… å®é™…æƒ…å†µ

**RunnablePassthrough() æœ‰æ˜ç¡®çš„è¯­ä¹‰ï¼šä¿æŒåŸå§‹è¾“å…¥ã€‚**

```python
# æ²¡æœ‰ RunnablePassthroughï¼šåŸå§‹è¾“å…¥ä¸¢å¤±
chain = {
    "processed": some_runnable,
}
result = chain.invoke("input")
# {"processed": ...}  # åŸå§‹è¾“å…¥ä¸¢å¤±

# æœ‰ RunnablePassthroughï¼šåŸå§‹è¾“å…¥ä¿ç•™
chain = {
    "original": RunnablePassthrough(),
    "processed": some_runnable,
}
result = chain.invoke("input")
# {"original": "input", "processed": ...}  # åŸå§‹è¾“å…¥ä¿ç•™
```

---

### ğŸ¯ æ­£ç¡®ç†è§£

**RunnablePassthrough() çš„ä½œç”¨**ï¼š
1. **ä¿æŒæ•°æ®æµçš„å®Œæ•´æ€§**ï¼šç¡®ä¿åŸå§‹è¾“å…¥ä¸ä¸¢å¤±
2. **æä¾›æ˜ç¡®çš„è¯­ä¹‰**ï¼šå‘Šè¯‰è¯»è€…"è¿™é‡Œéœ€è¦ä¿æŒåŸå§‹è¾“å…¥"
3. **æ”¯æŒåç»­æ­¥éª¤**ï¼šè®©åç»­æ­¥éª¤èƒ½è®¿é—®åŸå§‹è¾“å…¥

---

### ğŸ“š ç±»æ¯”ç†è§£

æƒ³è±¡ä¸€ä¸ªä¼šè®®ï¼š
- **æ²¡æœ‰è®°å½•å‘˜**ï¼šè®¨è®ºå†…å®¹å¯èƒ½ä¸¢å¤±
- **æœ‰è®°å½•å‘˜**ï¼šæ‰€æœ‰è®¨è®ºéƒ½è¢«è®°å½•ä¸‹æ¥

RunnablePassthrough() å°±åƒè®°å½•å‘˜ï¼Œç¡®ä¿åŸå§‹è¾“å…¥è¢«"è®°å½•"ä¸‹æ¥ã€‚

---

## åç›´è§‰ç‚¹4: assign ä¸­çš„ Runnable æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸æ˜¯å¹¶è¡Œ

### âŒ ç›´è§‰è®¤ä¸º

"assign ä¸­çš„å¤šä¸ª Runnable åº”è¯¥å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜æ€§èƒ½"

```python
chain = RunnablePassthrough.assign(
    field1=expensive_operation1,  # 2ç§’
    field2=expensive_operation2,  # 2ç§’
)

# æœŸæœ›ï¼šå¹¶è¡Œæ‰§è¡Œï¼Œæ€»æ—¶é—´ = max(2, 2) = 2ç§’
```

---

### âœ… å®é™…æƒ…å†µ

**assign ä¸­çš„ Runnable æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ€»æ—¶é—´ = 2 + 2 = 4ç§’ã€‚**

```python
import time
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

def slow_op1(x):
    time.sleep(2)
    return "result1"

def slow_op2(x):
    time.sleep(2)
    return "result2"

chain = RunnablePassthrough.assign(
    field1=RunnableLambda(slow_op1),
    field2=RunnableLambda(slow_op2),
)

start = time.time()
result = chain.invoke({"input": "test"})
elapsed = time.time() - start

print(f"è€—æ—¶: {elapsed:.1f}ç§’")  # çº¦ 4ç§’ï¼Œä¸æ˜¯ 2ç§’
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**å¦‚æœéœ€è¦å¹¶è¡Œæ‰§è¡Œï¼Œä½¿ç”¨ RunnableParallel**

```python
from langchain_core.runnables import RunnableParallel, RunnableLambda

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ RunnableParallel å¹¶è¡Œæ‰§è¡Œ
parallel_chain = RunnableParallel(
    field1=RunnableLambda(slow_op1),
    field2=RunnableLambda(slow_op2),
)

# ç„¶ååˆå¹¶åˆ°åŸå§‹è¾“å…¥
chain = RunnableLambda(lambda x: {
    **x,
    **parallel_chain.invoke(x)
})

start = time.time()
result = chain.invoke({"input": "test"})
elapsed = time.time() - start

print(f"è€—æ—¶: {elapsed:.1f}ç§’")  # çº¦ 2ç§’
```

---

### ğŸ“š ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šassign çš„è¯­ä¹‰æ˜¯"é€æ­¥æ·»åŠ å­—æ®µ"ï¼Œæš—ç¤ºäº†ä¸²è¡Œæ‰§è¡Œã€‚

- å¦‚æœéœ€è¦å¹¶è¡Œï¼Œåº”è¯¥ä½¿ç”¨ RunnableParallelï¼ˆè¯­ä¹‰æ˜ç¡®ï¼‰
- assign çš„ç®€æ´æ€§ä¼˜å…ˆäºæ€§èƒ½ä¼˜åŒ–

---

### ğŸ” 2025-2026 æ€§èƒ½ä¼˜åŒ–å»ºè®®

æ ¹æ® [Building Production-Ready AI Pipelines (2025)](https://medium.com/@sajo02/building-production-ready-ai-pipelines-with-langchain-runnables-a-complete-lcel-guide-2f9b27f6d557)ï¼š

> "For independent operations that can run in parallel, use RunnableParallel instead of RunnablePassthrough.assign() to reduce latency."

---

## åç›´è§‰ç‚¹5: ç›´æ¥é€ä¼ ä¸ä¼šå¤åˆ¶æ•°æ®

### âŒ ç›´è§‰è®¤ä¸º

"RunnablePassthrough() ä¼šå¤åˆ¶è¾“å…¥æ•°æ®ï¼Œç¡®ä¿å®‰å…¨"

```python
passthrough = RunnablePassthrough()
result = passthrough.invoke(large_data)

# æœŸæœ›ï¼šresult æ˜¯ large_data çš„å‰¯æœ¬
```

---

### âœ… å®é™…æƒ…å†µ

**RunnablePassthrough() ç›´æ¥è¿”å›è¾“å…¥å¼•ç”¨ï¼Œä¸å¤åˆ¶æ•°æ®ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough

passthrough = RunnablePassthrough()
original = {"key": "value"}
result = passthrough.invoke(original)

# result å’Œ original æ˜¯åŒä¸€ä¸ªå¯¹è±¡
print(result is original)  # True

# ä¿®æ”¹ result ä¼šå½±å“ original
result["key"] = "new_value"
print(original)  # {"key": "new_value"}
```

---

### ğŸ¯ æ­£ç¡®ç†è§£

**ä¸ºä»€ä¹ˆä¸å¤åˆ¶ï¼Ÿ**
1. **æ€§èƒ½è€ƒè™‘**ï¼šå¤åˆ¶å¤§æ•°æ®ä¼šå¾ˆæ…¢
2. **è¯­ä¹‰ä¸€è‡´**ï¼šé€ä¼ å°±æ˜¯"åŸæ ·ä¼ é€’"ï¼Œä¸åº”è¯¥ä¿®æ”¹
3. **ä¸å¯å˜æ€§å‡è®¾**ï¼šLCEL å‡è®¾æ•°æ®æ˜¯ä¸å¯å˜çš„

---

### ğŸ“š æœ€ä½³å®è·µ

**ä¸è¦åœ¨ LCEL é“¾ä¸­ä¿®æ”¹è¾“å…¥æ•°æ®**

```python
# âŒ é”™è¯¯ï¼šä¿®æ”¹è¾“å…¥æ•°æ®
def bad_function(x):
    x["new_field"] = "value"  # ä¿®æ”¹åŸå§‹æ•°æ®
    return x

# âœ… æ­£ç¡®ï¼šåˆ›å»ºæ–°å­—å…¸
def good_function(x):
    return {**x, "new_field": "value"}  # åˆ›å»ºæ–°å­—å…¸
```

---

## åç›´è§‰ç‚¹6: assign åªèƒ½ç”¨äºå­—å…¸ï¼Œä¸èƒ½ç”¨äºå…¶ä»–ç±»å‹

### âŒ ç›´è§‰è®¤ä¸º

"assign åº”è¯¥æ”¯æŒä»»ä½•ç±»å‹çš„è¾“å…¥"

```python
# æœŸæœ›ï¼šå¯¹å­—ç¬¦ä¸²ä¹Ÿèƒ½ assign
chain = RunnablePassthrough.assign(
    length=RunnableLambda(len)
)

result = chain.invoke("hello")
# æœŸæœ›: {"original": "hello", "length": 5}
```

---

### âœ… å®é™…æƒ…å†µ

**assign åªèƒ½ç”¨äºå­—å…¸è¾“å…¥ï¼Œå…¶ä»–ç±»å‹ä¼šæŠ¥é”™ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

chain = RunnablePassthrough.assign(
    length=RunnableLambda(len)
)

# âŒ æŠ¥é”™ï¼šæœŸæœ›å­—å…¸ï¼Œæ”¶åˆ°å­—ç¬¦ä¸²
try:
    result = chain.invoke("hello")
except Exception as e:
    print(f"é”™è¯¯: {e}")
    # é”™è¯¯: Expected dict, got str
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**å…ˆè½¬æ¢ä¸ºå­—å…¸ï¼Œå†ä½¿ç”¨ assign**

```python
# âœ… æ­£ç¡®ï¼šå…ˆè½¬æ¢ä¸ºå­—å…¸
chain = (
    RunnableLambda(lambda x: {"original": x})  # è½¬æ¢ä¸ºå­—å…¸
    | RunnablePassthrough.assign(
        length=RunnableLambda(lambda x: len(x["original"]))
    )
)

result = chain.invoke("hello")
print(result)
# {"original": "hello", "length": 5}
```

---

### ğŸ“š ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šassign çš„è¯­ä¹‰æ˜¯"æ·»åŠ å­—æ®µ"ï¼Œåªæœ‰å­—å…¸æœ‰"å­—æ®µ"çš„æ¦‚å¿µã€‚

- å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€æ•°å­—ç­‰ç±»å‹æ²¡æœ‰"å­—æ®µ"
- å¼ºåˆ¶ç±»å‹æ£€æŸ¥é¿å…è¯¯ç”¨

---

## åç›´è§‰ç‚¹7: é“¾å¼ assign ä¸ä¼šè‡ªåŠ¨å»é‡

### âŒ ç›´è§‰è®¤ä¸º

"å¦‚æœå¤šä¸ª assign æ·»åŠ ç›¸åŒçš„å­—æ®µï¼Œåº”è¯¥è‡ªåŠ¨å»é‡æˆ–åˆå¹¶"

```python
chain = (
    RunnablePassthrough.assign(field=runnable1)
    | RunnablePassthrough.assign(field=runnable2)  # ç›¸åŒçš„é”®å
)

# æœŸæœ›ï¼šè‡ªåŠ¨å»é‡æˆ–åˆå¹¶
```

---

### âœ… å®é™…æƒ…å†µ

**åé¢çš„ assign ä¼šè¦†ç›–å‰é¢çš„å­—æ®µï¼Œä¸ä¼šæŠ¥é”™ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

chain = (
    RunnablePassthrough.assign(
        field=RunnableLambda(lambda x: "value1")
    )
    | RunnablePassthrough.assign(
        field=RunnableLambda(lambda x: "value2")  # è¦†ç›–
    )
)

result = chain.invoke({"input": "test"})
print(result)
# {"input": "test", "field": "value2"}  # value1 è¢«è¦†ç›–
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**ä½¿ç”¨ä¸åŒçš„é”®åï¼Œé¿å…è¦†ç›–**

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸åŒçš„é”®å
chain = (
    RunnablePassthrough.assign(
        field1=RunnableLambda(lambda x: "value1")
    )
    | RunnablePassthrough.assign(
        field2=RunnableLambda(lambda x: "value2")
    )
)

result = chain.invoke({"input": "test"})
print(result)
# {"input": "test", "field1": "value1", "field2": "value2"}
```

---

### ğŸ“š ä¸ºä»€ä¹ˆå…è®¸è¦†ç›–ï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šæœ‰æ—¶ç¡®å®éœ€è¦è¦†ç›–å­—æ®µï¼ˆä¾‹å¦‚ï¼Œé‡æ–°è®¡ç®—æŸä¸ªå€¼ï¼‰ã€‚

- ä¸æŠ¥é”™ç»™äº†å¼€å‘è€…çµæ´»æ€§
- ä½†éœ€è¦å¼€å‘è€…è‡ªå·±æ³¨æ„é”®åå†²çª

---

## åç›´è§‰ç‚¹8: itemgetter æå–çš„æ˜¯å­—æ®µï¼Œä¸æ˜¯æ‰§è¡Œ Runnable

### âŒ ç›´è§‰è®¤ä¸º

"itemgetter ä¼šæ‰§è¡ŒæŸä¸ª Runnable å¹¶è¿”å›ç»“æœ"

```python
from operator import itemgetter

chain = RunnablePassthrough.assign(
    result=itemgetter("field") | some_runnable
)

# æœŸæœ›ï¼šitemgetter æ‰§è¡Œ field å¯¹åº”çš„ Runnable
```

---

### âœ… å®é™…æƒ…å†µ

**itemgetter åªæ˜¯æå–å­—å…¸ä¸­çš„å­—æ®µå€¼ï¼Œä¸æ‰§è¡Œä»»ä½• Runnableã€‚**

```python
from operator import itemgetter
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

chain = RunnablePassthrough.assign(
    result=itemgetter("question") | RunnableLambda(lambda x: x.upper())
)

result = chain.invoke({"question": "hello"})
print(result)
# {
#     "question": "hello",
#     "result": "HELLO"  # itemgetter æå– "hello"ï¼Œç„¶å upper()
# }
```

---

### ğŸ¯ æ­£ç¡®ç†è§£

**itemgetter çš„ä½œç”¨**ï¼š
1. ä»å­—å…¸ä¸­æå–æŒ‡å®šå­—æ®µçš„å€¼
2. å°†å€¼ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Runnable
3. ä¸æ‰§è¡Œä»»ä½•è®¡ç®—æˆ–è½¬æ¢

**å¸¸è§ç”¨æ³•**ï¼š
```python
# æå–å­—æ®µ â†’ ä¼ é€’ç»™ Runnable
itemgetter("question") | retriever

# ç­‰ä»·äºï¼š
RunnableLambda(lambda x: x["question"]) | retriever
```

---

## åç›´è§‰ç‚¹9: RunnablePassthrough ä¸ä¼šè‡ªåŠ¨å¤„ç†å¼‚å¸¸

### âŒ ç›´è§‰è®¤ä¸º

"RunnablePassthrough åº”è¯¥æ•è·å¼‚å¸¸ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±"

```python
chain = RunnablePassthrough.assign(
    result=failing_runnable  # ä¼šæŠ›å‡ºå¼‚å¸¸
)

# æœŸæœ›ï¼šå³ä½¿ failing_runnable å¤±è´¥ï¼ŒåŸå§‹è¾“å…¥ä¹Ÿåº”è¯¥ä¿ç•™
```

---

### âœ… å®é™…æƒ…å†µ

**å¦‚æœ assign ä¸­çš„ Runnable æŠ›å‡ºå¼‚å¸¸ï¼Œæ•´ä¸ªé“¾ä¼šå¤±è´¥ï¼ŒåŸå§‹è¾“å…¥ä¹Ÿä¼šä¸¢å¤±ã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda

def failing_function(x):
    raise ValueError("Something went wrong")

chain = RunnablePassthrough.assign(
    result=RunnableLambda(failing_function)
)

try:
    result = chain.invoke({"input": "test"})
except ValueError as e:
    print(f"é”™è¯¯: {e}")
    # æ•´ä¸ªé“¾å¤±è´¥ï¼ŒåŸå§‹è¾“å…¥ä¸¢å¤±
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**åœ¨ Runnable å†…éƒ¨å¤„ç†å¼‚å¸¸**

```python
# âœ… æ­£ç¡®ï¼šåœ¨ Runnable å†…éƒ¨æ•è·å¼‚å¸¸
def safe_function(x):
    try:
        return some_operation(x)
    except Exception as e:
        return {"error": str(e)}

chain = RunnablePassthrough.assign(
    result=RunnableLambda(safe_function)
)

result = chain.invoke({"input": "test"})
print(result)
# {
#     "input": "test",
#     "result": {"error": "..."}  # å¼‚å¸¸è¢«æ•è·
# }
```

---

### ğŸ“š 2025-2026 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

æ ¹æ® [LangChain Best Practices (2025)](https://www.swarnendu.de/blog/langchain-best-practices)ï¼š

> "Implement error handling within your Runnables using try-except blocks. Use exponential backoff for retries and custom error handlers for production reliability."

---

## åç›´è§‰ç‚¹10: assign çš„æ‰§è¡Œé¡ºåºä¸ä¿è¯

### âŒ ç›´è§‰è®¤ä¸º

"assign ä¸­çš„ Runnable æŒ‰ç…§å®šä¹‰é¡ºåºæ‰§è¡Œ"

```python
chain = RunnablePassthrough.assign(
    field1=runnable1,  # å…ˆæ‰§è¡Œ
    field2=runnable2,  # åæ‰§è¡Œ
    field3=runnable3,  # æœ€åæ‰§è¡Œ
)

# æœŸæœ›ï¼šä¸¥æ ¼æŒ‰ç…§ field1 â†’ field2 â†’ field3 çš„é¡ºåº
```

---

### âœ… å®é™…æƒ…å†µ

**assign ä¸­çš„ Runnable æ‰§è¡Œé¡ºåºä¸ä¿è¯ï¼Œå¯èƒ½æŒ‰ä»»æ„é¡ºåºæ‰§è¡Œã€‚**

```python
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
import time

def log_execution(name):
    def _log(x):
        print(f"æ‰§è¡Œ {name}")
        time.sleep(0.1)
        return name
    return RunnableLambda(_log)

chain = RunnablePassthrough.assign(
    field1=log_execution("field1"),
    field2=log_execution("field2"),
    field3=log_execution("field3"),
)

result = chain.invoke({"input": "test"})
# è¾“å‡ºé¡ºåºå¯èƒ½æ˜¯ï¼š
# æ‰§è¡Œ field1
# æ‰§è¡Œ field2
# æ‰§è¡Œ field3
# æˆ–è€…å…¶ä»–é¡ºåºï¼ˆä¸ä¿è¯ï¼‰
```

---

### ğŸ¯ æ­£ç¡®åšæ³•

**å¦‚æœéœ€è¦ä¿è¯æ‰§è¡Œé¡ºåºï¼Œä½¿ç”¨é“¾å¼ assign**

```python
# âœ… æ­£ç¡®ï¼šé“¾å¼ assign ä¿è¯é¡ºåº
chain = (
    RunnablePassthrough.assign(field1=log_execution("field1"))
    | RunnablePassthrough.assign(field2=log_execution("field2"))
    | RunnablePassthrough.assign(field3=log_execution("field3"))
)

result = chain.invoke({"input": "test"})
# è¾“å‡ºé¡ºåºä¿è¯æ˜¯ï¼š
# æ‰§è¡Œ field1
# æ‰§è¡Œ field2
# æ‰§è¡Œ field3
```

---

### ğŸ“š ä¸ºä»€ä¹ˆä¸ä¿è¯é¡ºåºï¼Ÿ

**è®¾è®¡ç†å¿µ**ï¼šå•ä¸ª assign ä¸­çš„ Runnable åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œä¸åº”è¯¥ä¾èµ–æ‰§è¡Œé¡ºåºã€‚

- å¦‚æœéœ€è¦ä¾èµ–é¡ºåºï¼Œåº”è¯¥ä½¿ç”¨é“¾å¼ assignï¼ˆæ˜ç¡®è¡¨è¾¾ä¾èµ–ï¼‰
- ä¸ä¿è¯é¡ºåºä¸ºæœªæ¥çš„å¹¶è¡Œä¼˜åŒ–ç•™ä¸‹ç©ºé—´

---

## å¸¸è§è¯¯åŒºæ€»ç»“

| è¯¯åŒº | æ­£ç¡®ç†è§£ |
|------|---------|
| assign ä¼šè¦†ç›–å·²æœ‰å­—æ®µ | assign ä¸åº”è¯¥è¦†ç›–ï¼Œä½¿ç”¨ä¸åŒé”®å |
| assign ä¸­çš„ Runnable æ¥æ”¶ç´¯ç§¯è¾“å…¥ | æ¥æ”¶åŸå§‹è¾“å…¥ï¼Œä½¿ç”¨é“¾å¼ assign è®¿é—®ç´¯ç§¯æ•°æ® |
| RunnablePassthrough ä»€ä¹ˆéƒ½ä¸åš | æœ‰æ˜ç¡®è¯­ä¹‰ï¼šä¿æŒåŸå§‹è¾“å…¥ |
| assign ä¸­çš„ Runnable å¹¶è¡Œæ‰§è¡Œ | ä¸²è¡Œæ‰§è¡Œï¼Œä½¿ç”¨ RunnableParallel å¹¶è¡Œ |
| ç›´æ¥é€ä¼ ä¼šå¤åˆ¶æ•°æ® | ä¸å¤åˆ¶ï¼Œç›´æ¥è¿”å›å¼•ç”¨ |
| assign æ”¯æŒä»»ä½•ç±»å‹ | åªæ”¯æŒå­—å…¸ |
| é“¾å¼ assign ä¼šè‡ªåŠ¨å»é‡ | åé¢çš„ä¼šè¦†ç›–å‰é¢çš„ |
| itemgetter æ‰§è¡Œ Runnable | åªæå–å­—æ®µå€¼ |
| RunnablePassthrough è‡ªåŠ¨å¤„ç†å¼‚å¸¸ | ä¸å¤„ç†ï¼Œéœ€è¦æ‰‹åŠ¨æ•è· |
| assign ä¿è¯æ‰§è¡Œé¡ºåº | ä¸ä¿è¯ï¼Œä½¿ç”¨é“¾å¼ assign ä¿è¯é¡ºåº |

---

## å­¦ä¹ å»ºè®®

1. **ä¸è¦ä¾èµ–ç›´è§‰**ï¼šRunnablePassthrough çš„è¡Œä¸ºå¯èƒ½ä¸ç›´è§‰ä¸ç¬¦
2. **é˜…è¯»å®˜æ–¹æ–‡æ¡£**ï¼šäº†è§£è®¾è®¡ç†å¿µå’Œæœ€ä½³å®è·µ
3. **å®è·µéªŒè¯**ï¼šé€šè¿‡ä»£ç éªŒè¯ä½ çš„å‡è®¾
4. **ç†è§£è®¾è®¡åŸç†**ï¼šç†è§£ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Œè€Œä¸æ˜¯æ­»è®°ç¡¬èƒŒ

---

## å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£ï¼ˆ2025-2026ï¼‰**ï¼š
- [RunnablePassthrough API Reference](https://reference.langchain.com/v0.3/python/core/runnables/langchain_core.runnables.passthrough.RunnablePassthrough.html)
- [LCEL Best Practices](https://python.langchain.com/docs/concepts/lcel)

**2025-2026 æœ€ä½³å®è·µ**ï¼š
- [LangChain Best Practices](https://www.swarnendu.de/blog/langchain-best-practices) - é”™è¯¯å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–
- [Building Production-Ready AI Pipelines](https://medium.com/@sajo02/building-production-ready-ai-pipelines-with-langchain-runnables-a-complete-lcel-guide-2f9b27f6d557) - ç”Ÿäº§çº§å®è·µ

**ç¤¾åŒºè®¨è®º**ï¼š
- [Accessing LCEL variables from prior steps](https://stackoverflow.com/questions/78379953/accessing-langchain-lcel-variables-from-prior-steps-in-the-chain) - Stack Overflow è®¨è®º

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-19
**é€‚ç”¨**: LangChain 0.3+, Python 3.13+
