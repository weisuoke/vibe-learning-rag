# Extensions æ‰©å±•å¼€å‘åŸºç¡€ - æ ¸å¿ƒæ¦‚å¿µ 04ï¼šUI å®šåˆ¶ä¸äº¤äº’

> æ·±å…¥ç†è§£ Extensions çš„ UI å®šåˆ¶èƒ½åŠ›å’Œç”¨æˆ·äº¤äº’ API

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£ Extensions çš„ UI å®šåˆ¶å’Œäº¤äº’æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- ExtensionUIContext æ¥å£å’Œ UI API
- å¯¹è¯æ¡†ï¼ˆconfirm, select, input, notifyï¼‰
- Widgetsã€Footerã€Header å®šåˆ¶
- çŠ¶æ€æ å’Œç¼–è¾‘å™¨å®šåˆ¶
- ä¸»é¢˜ç®¡ç†å’Œè‡ªå®šä¹‰æ¸²æŸ“

---

## 1. ExtensionUIContext æ¥å£

### 1.1 å®Œæ•´çš„ UI API

**ExtensionUIContext æä¾›çš„ UI èƒ½åŠ›ï¼š**

```typescript
export interface ExtensionUIContext {
  // å¯¹è¯æ¡†
  confirm(title: string, message: string, signal?: AbortSignal): Promise<boolean>;
  select<T>(title: string, items: T[], signal?: AbortSignal): Promise<T | undefined>;
  input(title: string, defaultValue?: string, signal?: AbortSignal): Promise<string | undefined>;
  notify(message: string, level: "info" | "success" | "warning" | "error"): void;

  // å¸ƒå±€å®šåˆ¶
  setWidget(placement: "above" | "below", render: () => string | Component): void;
  setFooter(render: () => string | Component): void;
  setHeader(render: () => string | Component): void;
  setStatus(text: string): void;

  // ç¼–è¾‘å™¨å®šåˆ¶
  setEditorText(text: string): void;
  setEditorComponent(component: Component): void;

  // è‡ªå®šä¹‰ UI
  custom<T>(render: CustomUIRenderer<T>): Promise<T>;
}
```

### 1.2 è®¿é—® UI API

**åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­è®¿é—®ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("tool_call", async (event, ctx) => {
    // ctx.ui æä¾›æ‰€æœ‰ UI API
    const ok = await ctx.ui.confirm("Title", "Message");
    ctx.ui.notify("Notification", "info");
    ctx.ui.setStatus("Status text");
  });

  pi.registerCommand("my_cmd", {
    handler: async (args, ctx) => {
      // å‘½ä»¤å¤„ç†å™¨ä¸­ä¹Ÿå¯ä»¥è®¿é—® ctx.ui
      const choice = await ctx.ui.select("Choose", ["A", "B", "C"]);
    },
  });
}
```

---

## 2. å¯¹è¯æ¡† API

### 2.1 ç¡®è®¤å¯¹è¯æ¡†ï¼ˆconfirmï¼‰

**è¯·æ±‚ç”¨æˆ·ç¡®è®¤æ“ä½œï¼š**

```typescript
pi.on("tool_call", async (event, ctx) => {
  if (event.toolName === "bash" && dangerous(event.input.command)) {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    const ok = await ctx.ui.confirm(
      "âš ï¸ Dangerous Command",
      `This command may be dangerous:\n\n${event.input.command}\n\nAllow execution?`
    );

    if (!ok) {
      return { block: true, reason: "Blocked by user" };
    }
  }
});
```

**å¸¦è¶…æ—¶çš„ç¡®è®¤å¯¹è¯æ¡†ï¼š**

```typescript
pi.on("tool_call", async (event, ctx) => {
  // åˆ›å»º AbortSignalï¼Œ5 ç§’åè‡ªåŠ¨å–æ¶ˆ
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 5000);

  try {
    const ok = await ctx.ui.confirm(
      "Quick Decision",
      "Approve within 5 seconds?",
      controller.signal
    );

    clearTimeout(timeout);

    if (!ok) {
      return { block: true, reason: "User denied" };
    }
  } catch (error) {
    if (error.name === "AbortError") {
      // è¶…æ—¶ï¼Œè‡ªåŠ¨æ‹’ç»
      return { block: true, reason: "Timeout" };
    }
    throw error;
  }
});
```

### 2.2 é€‰æ‹©å¯¹è¯æ¡†ï¼ˆselectï¼‰

**è®©ç”¨æˆ·ä»åˆ—è¡¨ä¸­é€‰æ‹©ï¼š**

```typescript
pi.registerCommand("theme", {
  description: "Change theme",
  handler: async (args, ctx) => {
    const themes = ["dark", "light", "auto", "custom"];

    // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
    const selected = await ctx.ui.select("Choose Theme", themes);

    if (selected) {
      ctx.ui.notify(`Theme changed to: ${selected}`, "success");
    } else {
      ctx.ui.notify("Theme change cancelled", "info");
    }
  },
});
```

**é€‰æ‹©å¤æ‚å¯¹è±¡ï¼š**

```typescript
interface Option {
  id: string;
  label: string;
  description: string;
}

pi.registerCommand("deploy", {
  handler: async (args, ctx) => {
    const environments: Option[] = [
      { id: "dev", label: "Development", description: "Local dev environment" },
      { id: "staging", label: "Staging", description: "Pre-production testing" },
      { id: "prod", label: "Production", description: "Live environment" },
    ];

    // æ˜¾ç¤ºé€‰é¡¹ï¼ˆä½¿ç”¨ labelï¼‰
    const labels = environments.map(e => `${e.label} - ${e.description}`);
    const selected = await ctx.ui.select("Deploy to", labels);

    if (selected) {
      const env = environments.find(e => selected.startsWith(e.label));
      ctx.ui.notify(`Deploying to ${env.label}...`, "info");
    }
  },
});
```

### 2.3 è¾“å…¥å¯¹è¯æ¡†ï¼ˆinputï¼‰

**è¯·æ±‚ç”¨æˆ·è¾“å…¥æ–‡æœ¬ï¼š**

```typescript
pi.registerCommand("note", {
  description: "Add a note",
  handler: async (args, ctx) => {
    // æ˜¾ç¤ºè¾“å…¥å¯¹è¯æ¡†
    const note = await ctx.ui.input("Enter note", "");

    if (note) {
      // ä¿å­˜ç¬”è®°
      ctx.ui.notify("Note saved", "success");
    } else {
      ctx.ui.notify("Note cancelled", "info");
    }
  },
});
```

**å¸¦é»˜è®¤å€¼çš„è¾“å…¥ï¼š**

```typescript
pi.registerCommand("rename", {
  handler: async (args, ctx) => {
    const currentName = "old-name";

    // æ˜¾ç¤ºè¾“å…¥å¯¹è¯æ¡†ï¼Œå¸¦é»˜è®¤å€¼
    const newName = await ctx.ui.input(
      "Enter new name",
      currentName
    );

    if (newName && newName !== currentName) {
      ctx.ui.notify(`Renamed to: ${newName}`, "success");
    }
  },
});
```

### 2.4 é€šçŸ¥ï¼ˆnotifyï¼‰

**æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("tool_call", async (event, ctx) => {
    // ä¿¡æ¯é€šçŸ¥ï¼ˆè“è‰²ï¼‰
    ctx.ui.notify("Tool called: " + event.toolName, "info");

    // æˆåŠŸé€šçŸ¥ï¼ˆç»¿è‰²ï¼‰
    ctx.ui.notify("Operation completed", "success");

    // è­¦å‘Šé€šçŸ¥ï¼ˆé»„è‰²ï¼‰
    ctx.ui.notify("This is a warning", "warning");

    // é”™è¯¯é€šçŸ¥ï¼ˆçº¢è‰²ï¼‰
    ctx.ui.notify("An error occurred", "error");
  });
}
```

**å¤šè¡Œé€šçŸ¥ï¼š**

```typescript
pi.registerCommand("status", {
  handler: async (args, ctx) => {
    const status = [
      "System Status:",
      "â”€".repeat(40),
      "CPU: 45%",
      "Memory: 2.3GB / 8GB",
      "Disk: 120GB / 500GB",
      "â”€".repeat(40),
    ].join("\n");

    ctx.ui.notify(status, "info");
  },
});
```

---

## 3. å¸ƒå±€å®šåˆ¶

### 3.1 Widgetï¼ˆabove/below editorï¼‰

**åœ¨ç¼–è¾‘å™¨ä¸Šæ–¹æˆ–ä¸‹æ–¹æ˜¾ç¤ºè‡ªå®šä¹‰å†…å®¹ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  // åœ¨ç¼–è¾‘å™¨ä¸Šæ–¹æ˜¾ç¤º widget
  pi.on("session_start", async (event, ctx) => {
    ctx.ui.setWidget("above", () => {
      return "ğŸ“Š Session started at " + new Date().toLocaleTimeString();
    });
  });

  // åœ¨ç¼–è¾‘å™¨ä¸‹æ–¹æ˜¾ç¤º widget
  pi.on("agent_turn_start", async (event, ctx) => {
    ctx.ui.setWidget("below", () => {
      return `ğŸ¤– Turn ${event.turnNumber} - Model: ${event.model}`;
    });
  });

  // æ¸…é™¤ widget
  pi.on("session_exit", async (event, ctx) => {
    ctx.ui.setWidget("above", () => "");
    ctx.ui.setWidget("below", () => "");
  });
}
```

**åŠ¨æ€æ›´æ–° widgetï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  let toolCount = 0;

  pi.on("tool_call", async (event, ctx) => {
    toolCount++;

    // æ›´æ–° widget
    ctx.ui.setWidget("above", () => {
      return `Tools called: ${toolCount}`;
    });
  });
}
```

### 3.2 Footerï¼ˆé¡µè„šï¼‰

**è‡ªå®šä¹‰é¡µè„šæ˜¾ç¤ºï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (event, ctx) => {
    // è®¾ç½®è‡ªå®šä¹‰ footer
    ctx.ui.setFooter(() => {
      const now = new Date().toLocaleTimeString();
      return `Session: ${event.sessionId.slice(0, 8)} | Time: ${now}`;
    });
  });
}
```

**æ˜¾ç¤º git ä¿¡æ¯ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (event, ctx) => {
    // è·å– git åˆ†æ”¯
    const result = await ctx.exec("git branch --show-current");
    const branch = result.stdout.trim();

    // è·å– git çŠ¶æ€
    const statusResult = await ctx.exec("git status --porcelain");
    const hasChanges = statusResult.stdout.length > 0;

    ctx.ui.setFooter(() => {
      const branchIcon = hasChanges ? "ğŸ”´" : "ğŸŸ¢";
      return `${branchIcon} ${branch}`;
    });
  });
}
```

### 3.3 Headerï¼ˆé¡µçœ‰ï¼‰

**è‡ªå®šä¹‰é¡µçœ‰æ˜¾ç¤ºï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (event, ctx) => {
    ctx.ui.setHeader(() => {
      return "ğŸš€ Custom Agent - Powered by pi-mono";
    });
  });
}
```

**æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (event, ctx) => {
    // è¯»å– package.json
    const pkgResult = await ctx.exec("cat package.json");
    const pkg = JSON.parse(pkgResult.stdout);

    ctx.ui.setHeader(() => {
      return `ğŸ“¦ ${pkg.name} v${pkg.version}`;
    });
  });
}
```

### 3.4 çŠ¶æ€æ ï¼ˆStatusï¼‰

**æ˜¾ç¤ºå½“å‰çŠ¶æ€ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.on("agent_turn_start", async (event, ctx) => {
    ctx.ui.setStatus(`ğŸ¤– Turn ${event.turnNumber} - ${event.model}`);
  });

  pi.on("agent_turn_end", async (event, ctx) => {
    ctx.ui.setStatus("âœ“ Ready");
  });

  pi.on("tool_call", async (event, ctx) => {
    ctx.ui.setStatus(`âš™ï¸ ${event.toolName}...`);
  });
}
```

---

## 4. ç¼–è¾‘å™¨å®šåˆ¶

### 4.1 è®¾ç½®ç¼–è¾‘å™¨æ–‡æœ¬ï¼ˆsetEditorTextï¼‰

**å°†æ–‡æœ¬æ’å…¥ç¼–è¾‘å™¨ï¼š**

```typescript
pi.registerCommand("template", {
  description: "Insert code template",
  handler: async (args, ctx) => {
    const template = `
function example() {
  // TODO: Implement
}
`.trim();

    // å°†æ¨¡æ¿æ’å…¥ç¼–è¾‘å™¨
    ctx.ui.setEditorText(template);
    ctx.ui.notify("Template inserted", "success");
  },
});
```

**æå–é—®é¢˜åˆ°ç¼–è¾‘å™¨ï¼š**

```typescript
export default function (pi: ExtensionAPI) {
  pi.registerCommand("extract-questions", {
    description: "Extract questions from last response",
    handler: async (args, ctx) => {
      const branch = ctx.sessionManager.getBranch();

      // æ‰¾åˆ°æœ€åä¸€æ¡ assistant æ¶ˆæ¯
      const lastAssistant = branch
        .filter(e => e.type === "message" && e.message.role === "assistant")
        .pop();

      if (!lastAssistant) {
        ctx.ui.notify("No assistant message found", "error");
        return;
      }

      // æå–é—®é¢˜ï¼ˆä»¥ ? ç»“å°¾çš„è¡Œï¼‰
      const content = lastAssistant.message.content[0];
      if (content?.type === "text") {
        const questions = content.text
          .split("\n")
          .filter(line => line.trim().endsWith("?"))
          .join("\n");

        if (questions) {
          ctx.ui.setEditorText(questions);
          ctx.ui.notify("Questions extracted", "success");
        } else {
          ctx.ui.notify("No questions found", "info");
        }
      }
    },
  });
}
```

### 4.2 è‡ªå®šä¹‰ç¼–è¾‘å™¨ç»„ä»¶ï¼ˆsetEditorComponentï¼‰

**åˆ›å»ºè‡ªå®šä¹‰ç¼–è¾‘å™¨ï¼š**

```typescript
import { Component } from "@mariozechner/pi-tui";

class CustomEditor implements Component {
  private text: string = "";

  handleInput(data: string): void {
    // å¤„ç†é”®ç›˜è¾“å…¥
    this.text += data;
  }

  render(width: number): string[] {
    // æ¸²æŸ“ç¼–è¾‘å™¨
    return [
      "Custom Editor:",
      "â”€".repeat(width),
      this.text,
      "â”€".repeat(width),
    ];
  }

  invalidate(): void {
    // æ ‡è®°éœ€è¦é‡æ–°æ¸²æŸ“
  }
}

export default function (pi: ExtensionAPI) {
  pi.registerCommand("custom-editor", {
    handler: async (args, ctx) => {
      const editor = new CustomEditor();
      ctx.ui.setEditorComponent(editor);
    },
  });
}
```

---

## 5. è‡ªå®šä¹‰ UIï¼ˆcustomï¼‰

### 5.1 å®Œå…¨è‡ªå®šä¹‰çš„ UI

**åˆ›å»ºå®Œå…¨è‡ªå®šä¹‰çš„äº¤äº’ç•Œé¢ï¼š**

```typescript
import { Component, Theme, matchesKey } from "@mariozechner/pi-tui";

class TodoListUI implements Component {
  private todos: Todo[];
  private theme: Theme;
  private onClose: () => void;

  constructor(todos: Todo[], theme: Theme, onClose: () => void) {
    this.todos = todos;
    this.theme = theme;
    this.onClose = onClose;
  }

  handleInput(data: string): void {
    // å¤„ç†é”®ç›˜è¾“å…¥
    if (matchesKey(data, "escape") || matchesKey(data, "ctrl+c")) {
      this.onClose();
    }
  }

  render(width: number): string[] {
    const lines: string[] = [];
    const th = this.theme;

    // æ ‡é¢˜
    lines.push("");
    lines.push(th.fg("accent", " Todos "));
    lines.push("");

    // åˆ—è¡¨
    if (this.todos.length === 0) {
      lines.push(th.fg("dim", "  No todos"));
    } else {
      for (const todo of this.todos) {
        const check = todo.done ? th.fg("success", "âœ“") : th.fg("dim", "â—‹");
        const text = todo.done ? th.fg("dim", todo.text) : th.fg("text", todo.text);
        lines.push(`  ${check} ${text}`);
      }
    }

    // å¸®åŠ©
    lines.push("");
    lines.push(th.fg("dim", "  Press Escape to close"));
    lines.push("");

    return lines;
  }

  invalidate(): void {
    // æ ‡è®°éœ€è¦é‡æ–°æ¸²æŸ“
  }
}

export default function (pi: ExtensionAPI) {
  let todos: Todo[] = [];

  pi.registerCommand("todos", {
    description: "Show todos",
    handler: async (args, ctx) => {
      if (!ctx.hasUI) {
        ctx.ui.notify("Requires interactive mode", "error");
        return;
      }

      // æ˜¾ç¤ºè‡ªå®šä¹‰ UI
      await ctx.ui.custom<void>((tui, theme, kb, done) => {
        return new TodoListUI(todos, theme, () => done());
      });
    },
  });
}
```

### 5.2 äº¤äº’å¼é€‰æ‹©å™¨

**åˆ›å»ºäº¤äº’å¼é€‰æ‹©å™¨ï¼š**

```typescript
class InteractiveSelector implements Component {
  private items: string[];
  private selected: number = 0;
  private theme: Theme;
  private onSelect: (item: string) => void;

  constructor(items: string[], theme: Theme, onSelect: (item: string) => void) {
    this.items = items;
    this.theme = theme;
    this.onSelect = onSelect;
  }

  handleInput(data: string): void {
    if (matchesKey(data, "up")) {
      this.selected = Math.max(0, this.selected - 1);
    } else if (matchesKey(data, "down")) {
      this.selected = Math.min(this.items.length - 1, this.selected + 1);
    } else if (matchesKey(data, "enter")) {
      this.onSelect(this.items[this.selected]);
    } else if (matchesKey(data, "escape")) {
      this.onSelect(null);
    }
  }

  render(width: number): string[] {
    const lines: string[] = [];
    const th = this.theme;

    lines.push("");
    lines.push(th.fg("accent", " Select an option "));
    lines.push("");

    for (let i = 0; i < this.items.length; i++) {
      const item = this.items[i];
      if (i === this.selected) {
        lines.push(th.fg("accent", `> ${item}`));
      } else {
        lines.push(th.fg("dim", `  ${item}`));
      }
    }

    lines.push("");
    lines.push(th.fg("dim", "  â†‘â†“: Navigate | Enter: Select | Escape: Cancel"));
    lines.push("");

    return lines;
  }

  invalidate(): void {}
}

pi.registerCommand("select", {
  handler: async (args, ctx) => {
    const items = ["Option 1", "Option 2", "Option 3"];

    const selected = await ctx.ui.custom<string>((tui, theme, kb, done) => {
      return new InteractiveSelector(items, theme, (item) => done(item));
    });

    if (selected) {
      ctx.ui.notify(`Selected: ${selected}`, "success");
    }
  },
});
```

---

## 6. ä¸»é¢˜ç®¡ç†

### 6.1 ä½¿ç”¨ä¸»é¢˜é¢œè‰²

**åœ¨è‡ªå®šä¹‰æ¸²æŸ“ä¸­ä½¿ç”¨ä¸»é¢˜ï¼š**

```typescript
pi.registerTool({
  name: "my_tool",
  renderCall(args, theme) {
    // ä½¿ç”¨ä¸»é¢˜é¢œè‰²
    const text =
      theme.fg("toolTitle", theme.bold("my_tool ")) +
      theme.fg("accent", args.param) +
      theme.fg("dim", " (optional)");

    return new Text(text, 0, 0);
  },

  renderResult(result, { expanded }, theme) {
    // æ ¹æ®ç»“æœä½¿ç”¨ä¸åŒé¢œè‰²
    const success = !result.details.error;
    const color = success ? "success" : "error";
    const icon = success ? "âœ“" : "âœ—";

    const text =
      theme.fg(color, icon) +
      " " +
      theme.fg("text", result.content[0].text);

    return new Text(text, 0, 0);
  },
});
```

### 6.2 ä¸»é¢˜é¢œè‰²åˆ—è¡¨

**å¯ç”¨çš„ä¸»é¢˜é¢œè‰²ï¼š**

```typescript
// æ–‡æœ¬é¢œè‰²
theme.fg("text", "Normal text")
theme.fg("dim", "Dimmed text")
theme.fg("muted", "Muted text")

// å¼ºè°ƒè‰²
theme.fg("accent", "Accent color")
theme.fg("toolTitle", "Tool title")

// çŠ¶æ€è‰²
theme.fg("success", "Success")
theme.fg("warning", "Warning")
theme.fg("error", "Error")
theme.fg("info", "Info")

// è¾¹æ¡†
theme.fg("border", "Border")
theme.fg("borderMuted", "Muted border")

// æ–‡æœ¬æ ·å¼
theme.bold("Bold text")
theme.italic("Italic text")
theme.underline("Underlined text")
```

---

## 7. å®é™…åº”ç”¨ç¤ºä¾‹

### 7.1 è¿›åº¦æŒ‡ç¤ºå™¨

```typescript
export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "long_task",
    parameters: Type.Object({
      steps: Type.Number(),
    }),

    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const { steps } = params as { steps: number };

      for (let i = 0; i < steps; i++) {
        if (signal.aborted) break;

        // æ›´æ–°è¿›åº¦
        const progress = Math.round(((i + 1) / steps) * 100);
        ctx.ui.setStatus(`â³ Progress: ${progress}%`);

        onUpdate({
          content: [
            {
              type: "text",
              text: `Step ${i + 1}/${steps} (${progress}%)`,
            },
          ],
        });

        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      ctx.ui.setStatus("âœ“ Complete");

      return {
        content: [{ type: "text", text: "Task completed" }],
        details: { steps },
      };
    },
  });
}
```

### 7.2 äº¤äº’å¼é…ç½®

```typescript
pi.registerCommand("config", {
  description: "Configure extension",
  handler: async (args, ctx) => {
    // 1. é€‰æ‹©é…ç½®é¡¹
    const configItems = ["Theme", "Language", "Notifications", "Shortcuts"];
    const item = await ctx.ui.select("Configure", configItems);

    if (!item) return;

    // 2. æ ¹æ®é€‰æ‹©æ˜¾ç¤ºä¸åŒçš„é…ç½®ç•Œé¢
    switch (item) {
      case "Theme": {
        const theme = await ctx.ui.select("Choose theme", ["dark", "light", "auto"]);
        if (theme) {
          ctx.ui.notify(`Theme set to: ${theme}`, "success");
        }
        break;
      }

      case "Language": {
        const lang = await ctx.ui.select("Choose language", ["en", "zh", "ja"]);
        if (lang) {
          ctx.ui.notify(`Language set to: ${lang}`, "success");
        }
        break;
      }

      case "Notifications": {
        const enabled = await ctx.ui.confirm("Notifications", "Enable notifications?");
        ctx.ui.notify(`Notifications ${enabled ? "enabled" : "disabled"}`, "success");
        break;
      }

      case "Shortcuts": {
        const shortcut = await ctx.ui.input("Enter shortcut", "ctrl+t");
        if (shortcut) {
          ctx.ui.notify(`Shortcut set to: ${shortcut}`, "success");
        }
        break;
      }
    }
  },
});
```

### 7.3 å®æ—¶ç›‘æ§é¢æ¿

```typescript
export default function (pi: ExtensionAPI) {
  const stats = {
    toolCalls: 0,
    errors: 0,
    startTime: Date.now(),
  };

  pi.on("tool_call", async (event, ctx) => {
    stats.toolCalls++;
    updateDashboard(ctx);
  });

  pi.on("tool_error", async (event, ctx) => {
    stats.errors++;
    updateDashboard(ctx);
  });

  function updateDashboard(ctx: ExtensionContext) {
    const uptime = Math.round((Date.now() - stats.startTime) / 1000);
    const errorRate = stats.toolCalls > 0
      ? Math.round((stats.errors / stats.toolCalls) * 100)
      : 0;

    ctx.ui.setWidget("above", () => {
      return [
        "ğŸ“Š Dashboard",
        "â”€".repeat(40),
        `Uptime: ${uptime}s`,
        `Tool Calls: ${stats.toolCalls}`,
        `Errors: ${stats.errors} (${errorRate}%)`,
        "â”€".repeat(40),
      ].join("\n");
    });
  }

  pi.on("session_start", async (event, ctx) => {
    updateDashboard(ctx);
  });
}
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 ç”¨æˆ·ä½“éªŒ

```typescript
// âœ… å¥½ï¼šæä¾›æ¸…æ™°çš„åé¦ˆ
ctx.ui.notify("Deploying to production...", "info");
await deploy();
ctx.ui.notify("âœ“ Deployment successful", "success");

// âŒ ä¸å¥½ï¼šæ²¡æœ‰åé¦ˆ
await deploy();
```

### 8.2 é”™è¯¯å¤„ç†

```typescript
// âœ… å¥½ï¼šæ•è·é”™è¯¯å¹¶æ˜¾ç¤ºå‹å¥½æ¶ˆæ¯
try {
  await riskyOperation();
  ctx.ui.notify("Operation successful", "success");
} catch (error) {
  ctx.ui.notify(`Error: ${error.message}`, "error");
}

// âŒ ä¸å¥½ï¼šè®©é”™è¯¯ä¼ æ’­
await riskyOperation();
```

### 8.3 æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… å¥½ï¼šç¼“å­˜æ¸²æŸ“ç»“æœ
class MyWidget implements Component {
  private cachedLines?: string[];
  private cachedWidth?: number;

  render(width: number): string[] {
    if (this.cachedLines && this.cachedWidth === width) {
      return this.cachedLines;
    }

    this.cachedLines = this.computeLines(width);
    this.cachedWidth = width;
    return this.cachedLines;
  }

  invalidate(): void {
    this.cachedLines = undefined;
  }
}

// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
class MyWidget implements Component {
  render(width: number): string[] {
    return this.computeLines(width); // æ¯æ¬¡éƒ½è®¡ç®—
  }
}
```

---

## 9. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å¯¹è¯æ¡† API**ï¼šconfirm, select, input, notify
2. **å¸ƒå±€å®šåˆ¶**ï¼šWidget, Footer, Header, Status
3. **ç¼–è¾‘å™¨å®šåˆ¶**ï¼šsetEditorText, setEditorComponent
4. **è‡ªå®šä¹‰ UI**ï¼šcustom() æ–¹æ³•åˆ›å»ºå®Œå…¨è‡ªå®šä¹‰çš„ç•Œé¢
5. **ä¸»é¢˜ç®¡ç†**ï¼šä½¿ç”¨ä¸»é¢˜é¢œè‰²ä¿æŒä¸€è‡´æ€§
6. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°çš„åé¦ˆå’Œé”™è¯¯å¤„ç†

### ä¸‹ä¸€æ­¥

- **æ ¸å¿ƒæ¦‚å¿µ 05**ï¼šProvider ä¸æ¨¡å‹ç®¡ç†
- **æ ¸å¿ƒæ¦‚å¿µ 06**ï¼šæ‰©å±•åŠ è½½ä¸çƒ­é‡è½½
- **å®æˆ˜ä»£ç **ï¼šUI å®šåˆ¶æ‰©å±•

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-20
**é€‚ç”¨äº**: pi-mono 2025-2026 ç‰ˆæœ¬
