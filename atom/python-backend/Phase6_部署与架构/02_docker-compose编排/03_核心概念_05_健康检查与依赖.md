# docker-compose编排 - 核心概念：健康检查与依赖

## 概述

**健康检查（healthcheck）** 是确保服务真正就绪的关键机制。配合 `depends_on` 的条件等待，可以实现可靠的服务启动顺序控制。

**本文涵盖：**
1. healthcheck 健康检查配置
2. depends_on 条件等待
3. 常见服务的健康检查命令
4. 启动顺序控制策略
5. 健康检查最佳实践

---

## 1. healthcheck 健康检查

### 1.1 基本配置

```yaml
services:
  db:
    image: postgres:14-alpine
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
```

**配置项说明：**

| 配置项 | 说明 | 默认值 | 推荐值 |
|--------|------|--------|--------|
| `test` | 健康检查命令 | 无 | 根据服务类型 |
| `interval` | 检查间隔 | 30s | 5-10s |
| `timeout` | 超时时间 | 30s | 3-5s |
| `retries` | 重试次数 | 3 | 3-5 |
| `start_period` | 启动宽限期 | 0s | 10-30s |

**工作流程：**
```
1. 容器启动
   ↓
2. 等待 start_period（宽限期）
   ↓
3. 每隔 interval 执行 test 命令
   ↓
4. 如果 timeout 内未返回，视为失败
   ↓
5. 连续失败 retries 次，标记为 unhealthy
   ↓
6. 成功一次，标记为 healthy
```

### 1.2 test 命令格式

**格式1：CMD 格式（推荐）**
```yaml
healthcheck:
  test: ["CMD", "pg_isready", "-U", "user"]
```

**格式2：CMD-SHELL 格式**
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U user || exit 1"]
```

**格式3：字符串格式（自动使用 shell）**
```yaml
healthcheck:
  test: pg_isready -U user
```

**前端类比：**
```javascript
// healthcheck = 心跳检测
setInterval(async () => {
  try {
    const response = await fetch('/health');
    if (response.ok) {
      console.log('Service healthy');
    } else {
      console.log('Service unhealthy');
    }
  } catch (error) {
    console.log('Service unreachable');
  }
}, 5000);  // 每5秒检查一次
```

### 1.3 禁用健康检查

```yaml
services:
  api:
    healthcheck:
      disable: true
```

---

## 2. depends_on 条件等待

### 2.1 简单依赖（不推荐）

```yaml
services:
  api:
    depends_on:
      - db  # 只等待容器启动
```

**问题：** 数据库容器启动了，但服务可能还在初始化。

### 2.2 条件依赖（推荐）

```yaml
services:
  api:
    depends_on:
      db:
        condition: service_healthy  # 等待健康检查通过
      redis:
        condition: service_started  # 等待容器启动

  db:
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s

  redis:
    image: redis:7-alpine
```

**条件类型：**

| 条件 | 说明 | 适用场景 |
|------|------|---------|
| `service_started` | 容器启动 | 启动快的服务（Redis） |
| `service_healthy` | 健康检查通过 | 需要初始化的服务（数据库） |
| `service_completed_successfully` | 容器成功退出 | 初始化任务 |

### 2.3 复杂依赖链

```yaml
services:
  # API 依赖数据库和缓存
  api:
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      migration:
        condition: service_completed_successfully

  # 数据库迁移依赖数据库
  migration:
    image: my-api:latest
    command: alembic upgrade head
    depends_on:
      db:
        condition: service_healthy

  # 数据库
  db:
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s

  # 缓存
  redis:
    image: redis:7-alpine
```

**启动顺序：**
```
1. db 启动并通过健康检查
   ↓
2. migration 运行并成功退出
   ↓
3. redis 启动
   ↓
4. api 启动
```

---

## 3. 常见服务的健康检查命令

### 3.1 PostgreSQL

```yaml
services:
  db:
    image: postgres:14-alpine
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
```

**说明：**
- `pg_isready`：PostgreSQL 自带的健康检查工具
- `-U`：指定用户名

### 3.2 MySQL

```yaml
services:
  db:
    image: mysql:8
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
```

### 3.3 Redis

```yaml
services:
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
```

### 3.4 MongoDB

```yaml
services:
  mongo:
    image: mongo:6
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
```

### 3.5 FastAPI/HTTP 服务

```yaml
services:
  api:
    build: .
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
```

**FastAPI 健康检查端点：**
```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/health")
async def health():
    return {"status": "healthy"}
```

### 3.6 Nginx

```yaml
services:
  nginx:
    image: nginx:alpine
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
```

### 3.7 Elasticsearch

```yaml
services:
  elasticsearch:
    image: elasticsearch:8.11.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
```

### 3.8 RabbitMQ

```yaml
services:
  rabbitmq:
    image: rabbitmq:3-management
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
```

---

## 4. 启动顺序控制策略

### 4.1 策略1：健康检查 + 条件等待（推荐）

```yaml
services:
  api:
    depends_on:
      db:
        condition: service_healthy

  db:
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
```

**优点：**
- ✅ 可靠（确保服务就绪）
- ✅ 标准（docker-compose 原生支持）

**缺点：**
- ❌ 需要配置健康检查

### 4.2 策略2：应用层重试

```yaml
services:
  api:
    depends_on:
      - db  # 只等待启动
```

**Python 代码：**
```python
import time
import psycopg2
from psycopg2 import OperationalError

def connect_with_retry(max_retries=5, delay=2):
    for i in range(max_retries):
        try:
            conn = psycopg2.connect(DATABASE_URL)
            print("Database connected")
            return conn
        except OperationalError:
            if i < max_retries - 1:
                print(f"Database not ready, retrying in {delay}s...")
                time.sleep(delay)
            else:
                raise

# 启动时连接
conn = connect_with_retry()
```

**优点：**
- ✅ 简单（不需要配置健康检查）
- ✅ 灵活（可以自定义重试逻辑）

**缺点：**
- ❌ 不优雅（浪费资源）
- ❌ 日志混乱（多次连接失败）

### 4.3 策略3：wait-for-it 脚本

```yaml
services:
  api:
    command: sh -c "./wait-for-it.sh db:5432 -- uvicorn app.main:app"
    depends_on:
      - db
```

**wait-for-it.sh：**
```bash
#!/bin/sh
# 等待服务就绪
until nc -z $1 $2; do
  echo "Waiting for $1:$2..."
  sleep 1
done
echo "$1:$2 is ready"
exec "$@"
```

**优点：**
- ✅ 灵活（可以等待任意服务）

**缺点：**
- ❌ 需要额外脚本
- ❌ 只检查端口，不检查服务就绪

### 4.4 策略对比

| 策略 | 可靠性 | 复杂度 | 推荐度 |
|------|--------|--------|--------|
| **健康检查 + 条件等待** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **应用层重试** | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| **wait-for-it 脚本** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ |

---

## 5. 在 AI Agent 开发中的应用

### 5.1 基础配置

```yaml
version: '3.8'

services:
  # FastAPI 应用
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/agent_db
      - REDIS_URL=redis://redis:6379
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # PostgreSQL 数据库
  db:
    image: postgres:14-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=agent_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Redis 缓存
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  postgres_data:
  redis_data:
```

### 5.2 添加数据库迁移

```yaml
services:
  # 数据库迁移（在 API 启动前运行）
  migration:
    build: .
    command: alembic upgrade head
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/agent_db
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure

  # API（依赖迁移完成）
  api:
    depends_on:
      migration:
        condition: service_completed_successfully
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
```

### 5.3 添加向量数据库

```yaml
services:
  api:
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      chroma:
        condition: service_healthy

  # ChromaDB 向量数据库
  chroma:
    image: chromadb/chroma:latest
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/chroma
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  chroma_data:
```

---

## 6. 健康检查最佳实践

### 6.1 合理设置参数

```yaml
# ✅ 推荐：根据服务特点设置
services:
  # 数据库：启动慢，检查频繁
  db:
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "user"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # API：启动慢，检查不频繁
  api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ❌ 不推荐：所有服务用相同参数
services:
  db:
    healthcheck:
      interval: 30s  # 太长
  api:
    healthcheck:
      interval: 5s   # 太频繁
```

### 6.2 健康检查端点设计

```python
from fastapi import FastAPI, status
from fastapi.responses import JSONResponse
import psycopg2

app = FastAPI()

@app.get("/health")
async def health():
    """基础健康检查"""
    return {"status": "healthy"}

@app.get("/health/ready")
async def readiness():
    """就绪检查（检查依赖服务）"""
    try:
        # 检查数据库连接
        conn = psycopg2.connect(DATABASE_URL)
        conn.close()

        # 检查 Redis 连接
        redis_client.ping()

        return {"status": "ready"}
    except Exception as e:
        return JSONResponse(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            content={"status": "not ready", "error": str(e)}
        )

@app.get("/health/live")
async def liveness():
    """存活检查（只检查应用本身）"""
    return {"status": "alive"}
```

**使用：**
```yaml
services:
  api:
    healthcheck:
      # 使用就绪检查（检查依赖）
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ready"]
      interval: 10s
```

### 6.3 避免过度检查

```yaml
# ❌ 不推荐：检查太频繁
services:
  api:
    healthcheck:
      interval: 1s  # 太频繁，浪费资源
      timeout: 10s  # 超时太长

# ✅ 推荐：合理的检查频率
services:
  api:
    healthcheck:
      interval: 10s  # 合理
      timeout: 5s    # 合理
```

### 6.4 使用 start_period

```yaml
# ✅ 推荐：给启动时间宽限期
services:
  api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      start_period: 30s  # 启动宽限期

# ❌ 不推荐：没有宽限期
services:
  api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      # 没有 start_period，启动时可能被标记为 unhealthy
```

---

## 7. 常见问题

### Q1: 健康检查一直失败怎么办？

**A:** 检查以下几点：

1. **检查命令是否正确**
   ```bash
   # 进入容器测试
   docker-compose exec db pg_isready -U user
   ```

2. **检查超时时间**
   ```yaml
   healthcheck:
     timeout: 5s  # 增加超时时间
   ```

3. **检查启动宽限期**
   ```yaml
   healthcheck:
     start_period: 30s  # 增加宽限期
   ```

4. **查看容器日志**
   ```bash
   docker-compose logs db
   ```

### Q2: 如何查看健康检查状态？

**A:** 使用 docker-compose ps

```bash
docker-compose ps

# 输出
NAME    STATUS
api     Up (healthy)
db      Up (healthy)
redis   Up (healthy)
```

### Q3: 健康检查失败后会怎样？

**A:** 取决于配置：

```yaml
services:
  api:
    restart: on-failure  # 失败后重启
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
```

**行为：**
- 健康检查失败 → 容器标记为 unhealthy
- 如果配置了 `restart: on-failure` → 容器重启
- 依赖此服务的其他服务不会启动

### Q4: 如何禁用健康检查？

**A:** 使用 disable

```yaml
services:
  api:
    healthcheck:
      disable: true
```

### Q5: 健康检查会影响性能吗？

**A:** 影响很小，但要注意：

```yaml
# ✅ 推荐：合理的检查频率
healthcheck:
  interval: 10s  # 每10秒检查一次

# ❌ 不推荐：检查太频繁
healthcheck:
  interval: 1s   # 每秒检查一次，浪费资源
```

---

## 8. 调试技巧

### 8.1 查看健康检查日志

```bash
# 查看容器健康检查历史
docker inspect --format='{{json .State.Health}}' <container_name> | jq

# 输出示例
{
  "Status": "healthy",
  "FailingStreak": 0,
  "Log": [
    {
      "Start": "2026-02-12T10:00:00Z",
      "End": "2026-02-12T10:00:01Z",
      "ExitCode": 0,
      "Output": ""
    }
  ]
}
```

### 8.2 手动测试健康检查命令

```bash
# 进入容器
docker-compose exec db sh

# 手动执行健康检查命令
pg_isready -U user

# 输出
/var/run/postgresql:5432 - accepting connections
```

### 8.3 查看启动顺序

```bash
# 查看容器启动时间
docker-compose ps --format "table {{.Name}}\t{{.Status}}"

# 输出
NAME     STATUS
db       Up 30 seconds (healthy)
redis    Up 25 seconds (healthy)
api      Up 20 seconds (healthy)
```

---

## 9. 总结

**健康检查与依赖的核心要素：**
1. **healthcheck**：定义健康检查命令和参数
2. **depends_on + condition**：条件等待（service_healthy）
3. **合理参数**：interval、timeout、retries、start_period
4. **健康检查端点**：/health、/health/ready、/health/live

**在 AI Agent 开发中：**
- 数据库使用 `pg_isready` 检查
- API 使用 `/health` 端点检查
- Redis 使用 `redis-cli ping` 检查
- 向量数据库使用 HTTP 端点检查

**最佳实践：**
- ✅ 使用健康检查 + 条件等待
- ✅ 合理设置检查参数
- ✅ 给启动时间宽限期
- ✅ 设计完善的健康检查端点
- ❌ 不要检查太频繁
- ❌ 不要忽略 start_period

---

**版本：** v1.0
**最后更新：** 2026-02-12
