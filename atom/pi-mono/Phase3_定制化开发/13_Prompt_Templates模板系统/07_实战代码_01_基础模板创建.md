# 实战代码 01: 基础模板创建

## 概述

本章节通过完整的 TypeScript 代码示例，演示如何创建和使用 Pi-mono Prompt Templates。所有代码都是可运行的，并包含详细的注释和说明。

---

## 环境准备

### 前置条件

```bash
# 1. 确保已安装 Pi-mono
npm install -g @mariozechner/pi-coding-agent

# 2. 验证安装
pi --version

# 3. 配置 API key
export ANTHROPIC_API_KEY=sk-ant-...
```

---

## 示例 1: 创建第一个模板

### 需求

创建一个简单的问候模板，接受用户名作为参数。

### 实现

```bash
#!/bin/bash

# 创建模板目录
mkdir -p ~/.pi/agent/prompts

# 创建模板文件
cat > ~/.pi/agent/prompts/greet.md << 'EOF'
---
description: Greet user by name
author: example@example.com
version: 1.0.0
created: 2026-02-20
---
Hello, $1! Welcome to Pi-mono Prompt Templates.

I'm here to help you with your coding tasks.
EOF

echo "✅ Template created: ~/.pi/agent/prompts/greet.md"
```

### 使用

```bash
# 启动 pi
pi

# 使用模板
/greet Alice

# 输出:
# Hello, Alice! Welcome to Pi-mono Prompt Templates.
# I'm here to help you with your coding tasks.
```

### TypeScript 实现（模拟）

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

/**
 * 创建基础模板
 */
function createBasicTemplate(): void {
  const promptsDir = path.join(os.homedir(), '.pi', 'agent', 'prompts');

  // 确保目录存在
  if (!fs.existsSync(promptsDir)) {
    fs.mkdirSync(promptsDir, { recursive: true });
  }

  // 模板内容
  const templateContent = `---
description: Greet user by name
author: example@example.com
version: 1.0.0
created: ${new Date().toISOString().split('T')[0]}
---
Hello, $1! Welcome to Pi-mono Prompt Templates.

I'm here to help you with your coding tasks.`;

  // 写入文件
  const templatePath = path.join(promptsDir, 'greet.md');
  fs.writeFileSync(templatePath, templateContent, 'utf-8');

  console.log(`✅ Template created: ${templatePath}`);
}

// 执行
createBasicTemplate();
```

---

## 示例 2: 创建代码审查模板

### 需求

创建一个结构化的代码审查模板，用于审查 TypeScript 代码。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/review-ts.md << 'EOF'
---
description: Comprehensive TypeScript code review
author: team@example.com
version: 2.0.0
tags: [code-review, typescript, quality]
---
# TypeScript Code Review

You are an expert TypeScript code reviewer with 10+ years of experience.

## Context
- Language: TypeScript
- Framework: React (if applicable)
- Testing: Jest
- Linting: ESLint + Prettier

## Task
Review the following TypeScript code: $1

## Review Criteria

### 1. Code Quality (40%)
- **Readability**: Clear variable names, logical structure
- **Maintainability**: Easy to modify and extend
- **Best Practices**: Follows TypeScript/React conventions

### 2. Type Safety (30%)
- **Type Annotations**: Proper use of types
- **Type Inference**: Leverages TypeScript's inference
- **Generic Types**: Appropriate use of generics

### 3. Performance (15%)
- **Efficiency**: No obvious bottlenecks
- **Optimization**: Appropriate optimizations

### 4. Security (15%)
- **Vulnerabilities**: No security issues
- **Input Validation**: Proper validation at boundaries

## Output Format

### Summary
[One paragraph overview]

### Strengths
- [2-3 things done well]

### Issues
| Severity | Issue | Location | Suggestion |
|----------|-------|----------|------------|
| High | [Description] | Line X | [Fix] |
| Medium | [Description] | Line Y | [Fix] |

### Recommendations
1. **[Category]**: [Specific recommendation]
2. **[Category]**: [Specific recommendation]

### Rating
- Code Quality: X/10
- Type Safety: X/10
- Performance: X/10
- Security: X/10
- **Overall**: X/10
EOF

echo "✅ Template created: ~/.pi/agent/prompts/review-ts.md"
```

### TypeScript 实现

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

interface TemplateMetadata {
  description: string;
  author: string;
  version: string;
  tags?: string[];
  created?: string;
  updated?: string;
}

interface TemplateContent {
  metadata: TemplateMetadata;
  body: string;
}

/**
 * 创建代码审查模板
 */
function createCodeReviewTemplate(): void {
  const metadata: TemplateMetadata = {
    description: 'Comprehensive TypeScript code review',
    author: 'team@example.com',
    version: '2.0.0',
    tags: ['code-review', 'typescript', 'quality'],
    created: new Date().toISOString().split('T')[0]
  };

  const body = `# TypeScript Code Review

You are an expert TypeScript code reviewer with 10+ years of experience.

## Context
- Language: TypeScript
- Framework: React (if applicable)
- Testing: Jest
- Linting: ESLint + Prettier

## Task
Review the following TypeScript code: $1

## Review Criteria

### 1. Code Quality (40%)
- **Readability**: Clear variable names, logical structure
- **Maintainability**: Easy to modify and extend
- **Best Practices**: Follows TypeScript/React conventions

### 2. Type Safety (30%)
- **Type Annotations**: Proper use of types
- **Type Inference**: Leverages TypeScript's inference
- **Generic Types**: Appropriate use of generics

### 3. Performance (15%)
- **Efficiency**: No obvious bottlenecks
- **Optimization**: Appropriate optimizations

### 4. Security (15%)
- **Vulnerabilities**: No security issues
- **Input Validation**: Proper validation at boundaries

## Output Format

### Summary
[One paragraph overview]

### Strengths
- [2-3 things done well]

### Issues
| Severity | Issue | Location | Suggestion |
|----------|-------|----------|------------|
| High | [Description] | Line X | [Fix] |
| Medium | [Description] | Line Y | [Fix] |

### Recommendations
1. **[Category]**: [Specific recommendation]
2. **[Category]**: [Specific recommendation]

### Rating
- Code Quality: X/10
- Type Safety: X/10
- Performance: X/10
- Security: X/10
- **Overall**: X/10`;

  const template = createTemplate(metadata, body);
  saveTemplate('review-ts.md', template);
}

/**
 * 创建模板内容
 */
function createTemplate(metadata: TemplateMetadata, body: string): string {
  const frontmatter = [
    '---',
    `description: ${metadata.description}`,
    `author: ${metadata.author}`,
    `version: ${metadata.version}`,
    metadata.tags ? `tags: [${metadata.tags.join(', ')}]` : null,
    metadata.created ? `created: ${metadata.created}` : null,
    metadata.updated ? `updated: ${metadata.updated}` : null,
    '---'
  ].filter(Boolean).join('\n');

  return `${frontmatter}\n${body}`;
}

/**
 * 保存模板到文件
 */
function saveTemplate(filename: string, content: string): void {
  const promptsDir = path.join(os.homedir(), '.pi', 'agent', 'prompts');

  if (!fs.existsSync(promptsDir)) {
    fs.mkdirSync(promptsDir, { recursive: true });
  }

  const templatePath = path.join(promptsDir, filename);
  fs.writeFileSync(templatePath, content, 'utf-8');

  console.log(`✅ Template created: ${templatePath}`);
}

// 执行
createCodeReviewTemplate();
```

---

## 示例 3: 创建测试生成模板

### 需求

创建一个模板，为 TypeScript 函数生成 Jest 单元测试。

### 实现

```bash
#!/bin/bash

cat > ~/.pi/agent/prompts/gen-test.md << 'EOF'
---
description: Generate Jest unit tests for TypeScript
author: team@example.com
version: 1.0.0
tags: [testing, jest, typescript]
---
# Unit Test Generator

You are a testing expert specializing in Jest and TypeScript.

## Context
- Framework: Jest
- Language: TypeScript
- Pattern: AAA (Arrange, Act, Assert)
- Coverage Target: 80%+

## Task
Generate comprehensive unit tests for: $1

## Test Structure

```typescript
// [filename].test.ts
import { functionName } from './filename';

describe('ComponentName', () => {
  describe('methodName', () => {
    it('should handle normal case', () => {
      // Arrange
      const input = ...;
      const expected = ...;

      // Act
      const result = methodName(input);

      // Assert
      expect(result).toBe(expected);
    });

    it('should handle edge case: empty input', () => {
      // Arrange
      const input = '';

      // Act & Assert
      expect(() => methodName(input)).toThrow();
    });
  });
});
```

## Requirements
1. Test all public methods
2. Include edge cases (null, undefined, empty, boundary values)
3. Test error scenarios
4. Use descriptive test names
5. Add comments for complex logic
6. Mock external dependencies

## Output
Generate the complete test file following the structure above.
EOF

echo "✅ Template created: ~/.pi/agent/prompts/gen-test.md"
```

### TypeScript 实现

```typescript
/**
 * 创建测试生成模板
 */
function createTestGeneratorTemplate(): void {
  const metadata: TemplateMetadata = {
    description: 'Generate Jest unit tests for TypeScript',
    author: 'team@example.com',
    version: '1.0.0',
    tags: ['testing', 'jest', 'typescript']
  };

  const body = `# Unit Test Generator

You are a testing expert specializing in Jest and TypeScript.

## Context
- Framework: Jest
- Language: TypeScript
- Pattern: AAA (Arrange, Act, Assert)
- Coverage Target: 80%+

## Task
Generate comprehensive unit tests for: $1

## Test Structure

\`\`\`typescript
// [filename].test.ts
import { functionName } from './filename';

describe('ComponentName', () => {
  describe('methodName', () => {
    it('should handle normal case', () => {
      // Arrange
      const input = ...;
      const expected = ...;

      // Act
      const result = methodName(input);

      // Assert
      expect(result).toBe(expected);
    });

    it('should handle edge case: empty input', () => {
      // Arrange
      const input = '';

      // Act & Assert
      expect(() => methodName(input)).toThrow();
    });
  });
});
\`\`\`

## Requirements
1. Test all public methods
2. Include edge cases (null, undefined, empty, boundary values)
3. Test error scenarios
4. Use descriptive test names
5. Add comments for complex logic
6. Mock external dependencies

## Output
Generate the complete test file following the structure above.`;

  const template = createTemplate(metadata, body);
  saveTemplate('gen-test.md', template);
}

// 执行
createTestGeneratorTemplate();
```

---

## 示例 4: 批量创建模板

### 需求

创建一套完整的团队模板库。

### 实现

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

interface TemplateDefinition {
  filename: string;
  metadata: TemplateMetadata;
  body: string;
}

/**
 * 批量创建模板
 */
function createTemplateLibrary(): void {
  const templates: TemplateDefinition[] = [
    {
      filename: 'review.md',
      metadata: {
        description: 'General code review',
        author: 'team@example.com',
        version: '1.0.0',
        tags: ['code-review']
      },
      body: 'Review the following code: $1\n\nFocus on quality, bugs, and best practices.'
    },
    {
      filename: 'test.md',
      metadata: {
        description: 'Generate unit tests',
        author: 'team@example.com',
        version: '1.0.0',
        tags: ['testing']
      },
      body: 'Generate unit tests for: $1\n\nInclude edge cases and error scenarios.'
    },
    {
      filename: 'docs.md',
      metadata: {
        description: 'Generate documentation',
        author: 'team@example.com',
        version: '1.0.0',
        tags: ['documentation']
      },
      body: 'Generate documentation for: $1\n\nInclude usage examples and API reference.'
    },
    {
      filename: 'refactor.md',
      metadata: {
        description: 'Suggest refactorings',
        author: 'team@example.com',
        version: '1.0.0',
        tags: ['refactoring']
      },
      body: 'Suggest refactorings for: $1\n\nFocus on maintainability and performance.'
    }
  ];

  const promptsDir = path.join(os.homedir(), '.pi', 'agent', 'prompts');

  if (!fs.existsSync(promptsDir)) {
    fs.mkdirSync(promptsDir, { recursive: true });
  }

  templates.forEach(({ filename, metadata, body }) => {
    const template = createTemplate(metadata, body);
    const templatePath = path.join(promptsDir, filename);
    fs.writeFileSync(templatePath, template, 'utf-8');
    console.log(`✅ Created: ${filename}`);
  });

  console.log(`\n✅ Created ${templates.length} templates in ${promptsDir}`);
}

// 执行
createTemplateLibrary();
```

---

## 示例 5: 项目模板创建

### 需求

为项目创建特定的模板。

### 实现

```typescript
/**
 * 创建项目模板
 */
function createProjectTemplates(projectRoot: string): void {
  const projectPromptsDir = path.join(projectRoot, '.pi', 'prompts');

  if (!fs.existsSync(projectPromptsDir)) {
    fs.mkdirSync(projectPromptsDir, { recursive: true });
  }

  // 项目特定的代码审查模板
  const projectReviewTemplate = {
    filename: 'project-review.md',
    metadata: {
      description: 'Project-specific code review',
      author: 'team@example.com',
      version: '1.0.0',
      tags: ['code-review', 'project']
    },
    body: `# Project Code Review

Review the following code according to our project standards: $1

## Project Standards
- Use TypeScript strict mode
- Follow Airbnb style guide
- Minimum 80% test coverage
- Use functional components in React
- Prefer composition over inheritance

## Focus Areas
1. Adherence to project standards
2. Code quality and maintainability
3. Test coverage
4. Performance implications

Provide specific, actionable feedback.`
  };

  const template = createTemplate(projectReviewTemplate.metadata, projectReviewTemplate.body);
  const templatePath = path.join(projectPromptsDir, projectReviewTemplate.filename);
  fs.writeFileSync(templatePath, template, 'utf-8');

  console.log(`✅ Project template created: ${templatePath}`);
}

// 使用
const projectRoot = process.cwd();
createProjectTemplates(projectRoot);
```

---

## 示例 6: 模板管理工具

### 需求

创建一个完整的模板管理工具。

### 实现

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

/**
 * 模板管理器
 */
class TemplateManager {
  private globalDir: string;
  private projectDir: string;

  constructor(projectRoot?: string) {
    this.globalDir = path.join(os.homedir(), '.pi', 'agent', 'prompts');
    this.projectDir = projectRoot
      ? path.join(projectRoot, '.pi', 'prompts')
      : path.join(process.cwd(), '.pi', 'prompts');
  }

  /**
   * 创建模板
   */
  create(filename: string, metadata: TemplateMetadata, body: string, isGlobal: boolean = true): void {
    const dir = isGlobal ? this.globalDir : this.projectDir;

    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }

    const template = createTemplate(metadata, body);
    const templatePath = path.join(dir, filename);
    fs.writeFileSync(templatePath, template, 'utf-8');

    console.log(`✅ Template created: ${templatePath}`);
  }

  /**
   * 列出所有模板
   */
  list(includeProject: boolean = true): string[] {
    const templates: string[] = [];

    // 全局模板
    if (fs.existsSync(this.globalDir)) {
      const globalFiles = fs.readdirSync(this.globalDir)
        .filter(f => f.endsWith('.md'))
        .map(f => `[global] ${f.replace('.md', '')}`);
      templates.push(...globalFiles);
    }

    // 项目模板
    if (includeProject && fs.existsSync(this.projectDir)) {
      const projectFiles = fs.readdirSync(this.projectDir)
        .filter(f => f.endsWith('.md'))
        .map(f => `[project] ${f.replace('.md', '')}`);
      templates.push(...projectFiles);
    }

    return templates;
  }

  /**
   * 删除模板
   */
  delete(filename: string, isGlobal: boolean = true): void {
    const dir = isGlobal ? this.globalDir : this.projectDir;
    const templatePath = path.join(dir, filename);

    if (fs.existsSync(templatePath)) {
      fs.unlinkSync(templatePath);
      console.log(`✅ Template deleted: ${templatePath}`);
    } else {
      console.log(`❌ Template not found: ${templatePath}`);
    }
  }

  /**
   * 读取模板
   */
  read(filename: string): string | null {
    // 先查找项目模板
    const projectPath = path.join(this.projectDir, filename);
    if (fs.existsSync(projectPath)) {
      return fs.readFileSync(projectPath, 'utf-8');
    }

    // 再查找全局模板
    const globalPath = path.join(this.globalDir, filename);
    if (fs.existsSync(globalPath)) {
      return fs.readFileSync(globalPath, 'utf-8');
    }

    return null;
  }
}

// 使用示例
const manager = new TemplateManager();

// 创建全局模板
manager.create('greet.md', {
  description: 'Greet user',
  author: 'example@example.com',
  version: '1.0.0'
}, 'Hello, $1!');

// 创建项目模板
manager.create('project-review.md', {
  description: 'Project code review',
  author: 'team@example.com',
  version: '1.0.0'
}, 'Review code: $1', false);

// 列出所有模板
console.log('\nAvailable templates:');
manager.list().forEach(t => console.log(`  ${t}`));

// 读取模板
const content = manager.read('greet.md');
console.log('\nTemplate content:', content);
```

---

## 总结

本章节演示了如何使用 TypeScript 创建和管理 Pi-mono Prompt Templates：

1. **基础模板创建** - 简单的问候模板
2. **结构化模板** - 代码审查模板
3. **专业模板** - 测试生成模板
4. **批量创建** - 模板库创建
5. **项目模板** - 项目特定模板
6. **管理工具** - 完整的模板管理器

所有代码都是完整可运行的，可以直接在项目中使用。

---

**版本：** v1.0
**最后更新：** 2026-02-20
**维护者：** Claude Code
