# 最小可用

掌握以下内容，就能开始使用 Alembic：

### 4.1 初始化 Alembic

**在 FastAPI 项目中初始化 Alembic**

```bash
# 1. 安装 Alembic
uv add alembic

# 2. 初始化 Alembic（在项目根目录）
alembic init alembic

# 生成的目录结构：
# alembic/
# ├── env.py           # 环境配置（连接数据库）
# ├── script.py.mako   # 迁移脚本模板
# └── versions/        # 迁移脚本存放目录
# alembic.ini          # Alembic 配置文件
```

**配置数据库连接（alembic/env.py）：**

```python
# alembic/env.py
from app.core.database import Base  # 导入你的 Base
from app.models import User, Post   # 导入所有模型

# 修改 target_metadata
target_metadata = Base.metadata

# 修改数据库 URL（从环境变量读取）
from app.core.config import settings
config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)
```

**这一步让你：**
- ✅ 创建 Alembic 项目结构
- ✅ 配置数据库连接
- ✅ 准备好生成迁移脚本

---

### 4.2 创建第一个迁移

**自动生成迁移脚本**

```bash
# 1. 定义 SQLAlchemy 模型
# app/models/user.py
from sqlalchemy import Column, Integer, String
from app.core.database import Base

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, index=True)
    name = Column(String)

# 2. 自动生成迁移脚本
alembic revision --autogenerate -m "create users table"

# 生成的文件：alembic/versions/abc123_create_users_table.py
```

**生成的迁移脚本：**

```python
# alembic/versions/abc123_create_users_table.py
"""create users table

Revision ID: abc123
Revises:
Create Date: 2026-02-11 14:30:00.000000
"""
from alembic import op
import sqlalchemy as sa

revision = 'abc123'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # 创建 users 表
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(), nullable=True),
        sa.Column('name', sa.String(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)

def downgrade():
    # 删除 users 表
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
```

**这一步让你：**
- ✅ 自动生成迁移脚本（不用手写 SQL）
- ✅ 理解 upgrade/downgrade 函数
- ✅ 看到版本号和依赖关系

---

### 4.3 应用迁移到数据库

**执行迁移脚本**

```bash
# 1. 查看当前数据库版本
alembic current
# 输出：(empty) 或 abc123

# 2. 查看待执行的迁移
alembic history
# 输出：
# abc123 -> head, create users table

# 3. 应用迁移到数据库
alembic upgrade head
# 输出：
# INFO  [alembic.runtime.migration] Running upgrade  -> abc123, create users table

# 4. 验证数据库
# 数据库中会创建两个表：
# - users（你的业务表）
# - alembic_version（Alembic 版本追踪表）
```

**查看 alembic_version 表：**

```sql
SELECT * FROM alembic_version;
-- 输出：
-- version_num
-- -----------
-- abc123
```

**这一步让你：**
- ✅ 应用迁移到数据库
- ✅ 理解版本追踪机制
- ✅ 验证迁移是否成功

---

### 4.4 修改模型并生成新迁移

**添加新字段**

```python
# app/models/user.py
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, index=True)
    name = Column(String)
    avatar = Column(String)  # 新增字段
```

**生成新迁移：**

```bash
# 1. 生成迁移脚本
alembic revision --autogenerate -m "add avatar to users"

# 生成的文件：alembic/versions/def456_add_avatar_to_users.py
```

**生成的迁移脚本：**

```python
# alembic/versions/def456_add_avatar_to_users.py
revision = 'def456'
down_revision = 'abc123'  # 依赖上一个迁移

def upgrade():
    op.add_column('users', sa.Column('avatar', sa.String(), nullable=True))

def downgrade():
    op.drop_column('users', 'avatar')
```

**应用新迁移：**

```bash
# 应用迁移
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Running upgrade abc123 -> def456, add avatar to users
```

**这一步让你：**
- ✅ 修改模型并生成新迁移
- ✅ 理解迁移的依赖关系（版本链）
- ✅ 应用增量变更

---

### 4.5 回滚迁移

**撤销最后一次迁移**

```bash
# 1. 回滚到上一个版本
alembic downgrade -1

# 输出：
# INFO  [alembic.runtime.migration] Running downgrade def456 -> abc123, add avatar to users

# 2. 验证数据库
# users 表中的 avatar 字段被删除

# 3. 查看当前版本
alembic current
# 输出：abc123
```

**回滚到指定版本：**

```bash
# 回滚到初始状态
alembic downgrade base

# 输出：
# INFO  [alembic.runtime.migration] Running downgrade abc123 -> , create users table

# 数据库中的 users 表被删除
```

**重新应用所有迁移：**

```bash
# 升级到最新版本
alembic upgrade head

# 输出：
# INFO  [alembic.runtime.migration] Running upgrade  -> abc123, create users table
# INFO  [alembic.runtime.migration] Running upgrade abc123 -> def456, add avatar to users
```

**这一步让你：**
- ✅ 回滚迁移（撤销变更）
- ✅ 理解 upgrade/downgrade 的双向性
- ✅ 安全地测试迁移

---

## 最小可用工作流总结

**完整的开发流程：**

```bash
# 1. 初始化 Alembic（只需一次）
alembic init alembic
# 配置 alembic/env.py

# 2. 修改 SQLAlchemy 模型
# 编辑 app/models/*.py

# 3. 生成迁移脚本
alembic revision --autogenerate -m "描述变更"

# 4. 检查生成的迁移脚本
# 查看 alembic/versions/*.py

# 5. 应用迁移
alembic upgrade head

# 6. 如果有问题，回滚
alembic downgrade -1
```

**在 AI Agent 后端开发中的应用：**

```python
# 场景：添加对话历史表

# 1. 定义模型
# app/models/conversation.py
class Conversation(Base):
    __tablename__ = "conversations"
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    title = Column(String)
    created_at = Column(DateTime, default=datetime.utcnow)

# 2. 生成迁移
alembic revision --autogenerate -m "add conversations table"

# 3. 应用迁移
alembic upgrade head

# 4. 在 FastAPI 中使用
@app.post("/conversations")
async def create_conversation(
    title: str,
    db: Session = Depends(get_db)
):
    conversation = Conversation(title=title, user_id=1)
    db.add(conversation)
    db.commit()
    return conversation
```

---

## 常用命令速查

| 命令 | 说明 | 示例 |
|------|------|------|
| `alembic init <dir>` | 初始化 Alembic | `alembic init alembic` |
| `alembic revision --autogenerate -m "<msg>"` | 自动生成迁移 | `alembic revision --autogenerate -m "add users"` |
| `alembic revision -m "<msg>"` | 手动创建空迁移 | `alembic revision -m "custom migration"` |
| `alembic upgrade head` | 升级到最新版本 | `alembic upgrade head` |
| `alembic upgrade +1` | 升级一个版本 | `alembic upgrade +1` |
| `alembic downgrade -1` | 回滚一个版本 | `alembic downgrade -1` |
| `alembic downgrade base` | 回滚到初始状态 | `alembic downgrade base` |
| `alembic current` | 查看当前版本 | `alembic current` |
| `alembic history` | 查看迁移历史 | `alembic history` |
| `alembic show <revision>` | 查看迁移详情 | `alembic show abc123` |

---

## 这些知识足以：

- ✅ 在 FastAPI 项目中集成 Alembic
- ✅ 自动生成数据库迁移脚本
- ✅ 应用迁移到开发/测试/生产环境
- ✅ 回滚错误的迁移
- ✅ 管理数据库 schema 的版本历史
- ✅ 为后续学习高级特性打基础（数据迁移、分支合并、团队协作）

---

## 下一步学习

掌握最小可用知识后，可以深入学习：

1. **手动编辑迁移脚本**：处理 autogenerate 无法识别的变更
2. **数据迁移**：在 schema 变更时迁移现有数据
3. **多分支管理**：处理团队协作中的迁移冲突
4. **生产环境部署**：零停机迁移策略
5. **与 FastAPI 集成**：启动时自动运行迁移

**记住：**
> 80% 的场景只需要这5个步骤：初始化 → 修改模型 → 生成迁移 → 应用迁移 → 回滚（如需要）
