# å®æˆ˜ä»£ç  2ï¼šç”Ÿå‘½å‘¨æœŸé’©å­åº”ç”¨

å®Œæ•´å¯è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­åº”ç”¨ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨å…³é”®æ—¶åˆ»æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

---

## ç¤ºä¾‹æ¦‚è¿°

æœ¬ç¤ºä¾‹å±•ç¤ºï¼š
1. åœ¨ Agent å¯åŠ¨å‰æ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆbefore_agent_startï¼‰
2. è‡ªå®šä¹‰ä¼šè¯å‹ç¼©ç­–ç•¥ï¼ˆsession_before_compactï¼‰
3. å›åˆç»“æŸç»Ÿè®¡åˆ†æï¼ˆturn_endï¼‰
4. å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**é€‚ç”¨åœºæ™¯ï¼š**
- å®šåˆ¶ Agent è¡Œä¸º
- ä¼˜åŒ–ä¸Šä¸‹æ–‡ç®¡ç†
- æ€§èƒ½ç›‘æ§å’Œåˆ†æ
- é¡¹ç›®ç‰¹å®šé…ç½®

---

## å®Œæ•´ä»£ç 

```typescript
/**
 * ç”Ÿå‘½å‘¨æœŸé’©å­åº”ç”¨æ‰©å±•
 *
 * åŠŸèƒ½ï¼š
 * 1. before_agent_startï¼šæ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡å’Œä»£ç è§„èŒƒ
 * 2. session_before_compactï¼šè‡ªå®šä¹‰å‹ç¼©ç­–ç•¥
 * 3. turn_endï¼šç»Ÿè®¡å›åˆæ€§èƒ½
 * 4. å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
 *
 * æ–‡ä»¶ï¼šlifecycle-hooks-app.ts
 */

import { ExtensionAPI, Session, Message } from '@mariozechner/pi-agent-core';
import fs from 'fs';
import path from 'path';

// ===== 1. ç±»å‹å®šä¹‰ =====

interface ProjectContext {
  name: string;
  framework: string;
  language: string;
  codingStandards: string[];
  dependencies: string[];
}

interface TurnStats {
  turnNumber: number;
  startTime: number;
  endTime?: number;
  duration?: number;
  toolCalls: number;
  messagesAdded: number;
}

interface CompactionStats {
  beforeCount: number;
  afterCount: number;
  removedCount: number;
  timestamp: number;
}

// ===== 2. é…ç½® =====

const CONFIG = {
  // é¡¹ç›®ä¸Šä¸‹æ–‡æ–‡ä»¶è·¯å¾„
  projectContextFile: path.join(process.cwd(), '.pi', 'project-context.json'),

  // ä»£ç è§„èŒƒæ–‡ä»¶è·¯å¾„
  codingStandardsFile: path.join(process.cwd(), '.pi', 'coding-standards.md'),

  // å‹ç¼©ç­–ç•¥
  compaction: {
    // ä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯æ•°é‡
    keepRecentMessages: 10,

    // ä¿ç•™é‡è¦æ¶ˆæ¯ï¼ˆåŒ…å«ç‰¹å®šå…³é”®è¯ï¼‰
    importantKeywords: ['error', 'warning', 'critical', 'important'],

    // ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯
    keepSystemMessages: true
  },

  // æ€§èƒ½ç›‘æ§
  performance: {
    // æ…¢å›åˆé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    slowTurnThreshold: 30000, // 30ç§’

    // å·¥å…·è°ƒç”¨è¿‡å¤šé˜ˆå€¼
    tooManyToolCallsThreshold: 20
  }
};

// ===== 3. çŠ¶æ€ç®¡ç† =====

// å›åˆç»Ÿè®¡
const turnStats = new Map<number, TurnStats>();

// å‹ç¼©å†å²
const compactionHistory: CompactionStats[] = [];

// é¡¹ç›®ä¸Šä¸‹æ–‡ç¼“å­˜
let projectContextCache: ProjectContext | null = null;

// ===== 4. è¾…åŠ©å‡½æ•° =====

/**
 * åŠ è½½é¡¹ç›®ä¸Šä¸‹æ–‡
 */
function loadProjectContext(): ProjectContext | null {
  try {
    if (fs.existsSync(CONFIG.projectContextFile)) {
      const content = fs.readFileSync(CONFIG.projectContextFile, 'utf-8');
      return JSON.parse(content);
    }
  } catch (error) {
    console.error('Failed to load project context:', error);
  }

  // è¿”å›é»˜è®¤ä¸Šä¸‹æ–‡
  return {
    name: 'Unknown Project',
    framework: 'Unknown',
    language: 'TypeScript',
    codingStandards: [
      'Use TypeScript strict mode',
      'Follow ESLint rules',
      'Write unit tests'
    ],
    dependencies: []
  };
}

/**
 * åŠ è½½ä»£ç è§„èŒƒ
 */
function loadCodingStandards(): string {
  try {
    if (fs.existsSync(CONFIG.codingStandardsFile)) {
      return fs.readFileSync(CONFIG.codingStandardsFile, 'utf-8');
    }
  } catch (error) {
    console.error('Failed to load coding standards:', error);
  }

  // è¿”å›é»˜è®¤è§„èŒƒ
  return `
# Coding Standards

- Use TypeScript strict mode
- Follow ESLint and Prettier rules
- Write unit tests for all functions
- Use async/await instead of .then()
- Add JSDoc comments for public APIs
  `.trim();
}

/**
 * åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦é‡è¦
 */
function isImportantMessage(message: Message): boolean {
  const content = message.content?.toString().toLowerCase() || '';

  return CONFIG.compaction.importantKeywords.some(keyword =>
    content.includes(keyword)
  );
}

/**
 * æ ¼å¼åŒ–æŒç»­æ—¶é—´
 */
function formatDuration(ms: number): string {
  if (ms < 1000) {
    return `${ms}ms`;
  } else if (ms < 60000) {
    return `${(ms / 1000).toFixed(2)}s`;
  } else {
    return `${(ms / 60000).toFixed(2)}min`;
  }
}

// ===== 5. Extension ä¸»å‡½æ•° =====

export default function lifecycleHooksApp(pi: ExtensionAPI) {
  console.log('ğŸ”„ Lifecycle Hooks Application Extension loaded');

  // ===== é’©å­ 1: before_agent_start =====
  // åœ¨ Agent å¯åŠ¨å‰æ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡å’Œä»£ç è§„èŒƒ

  pi.on('before_agent_start', (messages: Message[]) => {
    console.log('\nğŸ“ before_agent_start: Injecting context');

    // åŠ è½½é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    if (!projectContextCache) {
      projectContextCache = loadProjectContext();
    }

    const context = projectContextCache;

    if (context) {
      // æ³¨å…¥é¡¹ç›®ä¿¡æ¯
      messages.push({
        role: 'system',
        content: `
# Project Context

You are working on the "${context.name}" project.

**Framework:** ${context.framework}
**Language:** ${context.language}

**Dependencies:**
${context.dependencies.map(dep => `- ${dep}`).join('\n')}

Please follow the project's conventions and best practices.
        `.trim()
      });

      console.log('  âœ“ Injected project context');
    }

    // åŠ è½½ä»£ç è§„èŒƒ
    const standards = loadCodingStandards();

    messages.push({
      role: 'system',
      content: `
# Coding Standards

${standards}

Please follow these coding standards in all code you write.
      `.trim()
    });

    console.log('  âœ“ Injected coding standards');

    // æ·»åŠ è‡ªå®šä¹‰æŒ‡ä»¤
    messages.push({
      role: 'system',
      content: `
# Additional Instructions

- Always explain your reasoning before making changes
- Write clean, maintainable code
- Consider edge cases and error handling
- Add comments for complex logic
      `.trim()
    });

    console.log('  âœ“ Injected additional instructions');
    console.log(`  Total messages: ${messages.length}`);
  });

  // ===== é’©å­ 2: session_before_compact =====
  // è‡ªå®šä¹‰ä¼šè¯å‹ç¼©ç­–ç•¥

  pi.on('session_before_compact', (session: Session) => {
    console.log('\nğŸ—œï¸  session_before_compact: Custom compaction');

    const beforeCount = session.messages.length;
    console.log(`  Messages before: ${beforeCount}`);

    // è·å–æ¶ˆæ¯æ•°ç»„çš„å¼•ç”¨
    const messages = session.messages;

    // ç­–ç•¥ 1ï¼šä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯
    const recentMessages = messages.slice(-CONFIG.compaction.keepRecentMessages);

    // ç­–ç•¥ 2ï¼šä¿ç•™é‡è¦æ¶ˆæ¯
    const importantMessages = messages
      .slice(0, -CONFIG.compaction.keepRecentMessages)
      .filter(msg => {
        // ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯
        if (CONFIG.compaction.keepSystemMessages && msg.role === 'system') {
          return true;
        }

        // ä¿ç•™é‡è¦æ¶ˆæ¯
        return isImportantMessage(msg);
      });

    // åˆå¹¶æ¶ˆæ¯
    const keptMessages = [...importantMessages, ...recentMessages];

    // æ¸…ç©ºåŸæ•°ç»„å¹¶æ·»åŠ ä¿ç•™çš„æ¶ˆæ¯
    messages.length = 0;
    messages.push(...keptMessages);

    const afterCount = messages.length;
    const removedCount = beforeCount - afterCount;

    console.log(`  Messages after: ${afterCount}`);
    console.log(`  Removed: ${removedCount}`);
    console.log(`  Kept important: ${importantMessages.length}`);
    console.log(`  Kept recent: ${recentMessages.length}`);

    // è®°å½•å‹ç¼©å†å²
    compactionHistory.push({
      beforeCount,
      afterCount,
      removedCount,
      timestamp: Date.now()
    });
  });

  // ===== é’©å­ 3: turn_start =====
  // è®°å½•å›åˆå¼€å§‹

  pi.on('turn_start', (turnNumber: number) => {
    console.log(`\nğŸ”„ Turn ${turnNumber} started`);

    // åˆå§‹åŒ–å›åˆç»Ÿè®¡
    turnStats.set(turnNumber, {
      turnNumber,
      startTime: Date.now(),
      toolCalls: 0,
      messagesAdded: 0
    });
  });

  // ===== é’©å­ 4: tool_call =====
  // ç»Ÿè®¡å·¥å…·è°ƒç”¨

  pi.on('tool_call', (tool, args) => {
    // æ›´æ–°å½“å‰å›åˆçš„å·¥å…·è°ƒç”¨è®¡æ•°
    const currentTurn = getCurrentTurn();
    if (currentTurn) {
      const stats = turnStats.get(currentTurn);
      if (stats) {
        stats.toolCalls++;
      }
    }
  });

  // ===== é’©å­ 5: message_end =====
  // ç»Ÿè®¡æ¶ˆæ¯æ·»åŠ 

  pi.on('message_end', (message) => {
    // æ›´æ–°å½“å‰å›åˆçš„æ¶ˆæ¯è®¡æ•°
    const currentTurn = getCurrentTurn();
    if (currentTurn) {
      const stats = turnStats.get(currentTurn);
      if (stats) {
        stats.messagesAdded++;
      }
    }
  });

  // ===== é’©å­ 6: turn_end =====
  // å›åˆç»“æŸç»Ÿè®¡åˆ†æ

  pi.on('turn_end', (turnNumber: number) => {
    const stats = turnStats.get(turnNumber);

    if (stats) {
      stats.endTime = Date.now();
      stats.duration = stats.endTime - stats.startTime;

      console.log(`\nğŸ“Š Turn ${turnNumber} ended`);
      console.log(`  Duration: ${formatDuration(stats.duration)}`);
      console.log(`  Tool calls: ${stats.toolCalls}`);
      console.log(`  Messages added: ${stats.messagesAdded}`);

      // æ€§èƒ½åˆ†æ
      if (stats.duration > CONFIG.performance.slowTurnThreshold) {
        console.warn(`  âš ï¸  Slow turn detected (>${formatDuration(CONFIG.performance.slowTurnThreshold)})`);
      }

      if (stats.toolCalls > CONFIG.performance.tooManyToolCallsThreshold) {
        console.warn(`  âš ï¸  Too many tool calls (>${CONFIG.performance.tooManyToolCallsThreshold})`);
      }

      // æ•ˆç‡æŒ‡æ ‡
      if (stats.duration > 0) {
        const toolCallsPerSecond = (stats.toolCalls / (stats.duration / 1000)).toFixed(2);
        console.log(`  Efficiency: ${toolCallsPerSecond} tool calls/sec`);
      }
    }
  });

  // ===== é’©å­ 7: agent_end =====
  // Agent ç»“æŸæ€»ç»“

  pi.on('agent_end', (result) => {
    console.log('\nâœ… Agent ended');

    // è¾“å‡ºæ‰€æœ‰å›åˆç»Ÿè®¡
    if (turnStats.size > 0) {
      console.log('\nğŸ“ˆ Turn Statistics:');

      const turns = Array.from(turnStats.values());
      const totalDuration = turns.reduce((sum, t) => sum + (t.duration || 0), 0);
      const totalToolCalls = turns.reduce((sum, t) => sum + t.toolCalls, 0);
      const avgDuration = totalDuration / turns.length;
      const avgToolCalls = totalToolCalls / turns.length;

      console.log(`  Total turns: ${turns.length}`);
      console.log(`  Total duration: ${formatDuration(totalDuration)}`);
      console.log(`  Avg duration: ${formatDuration(avgDuration)}`);
      console.log(`  Total tool calls: ${totalToolCalls}`);
      console.log(`  Avg tool calls: ${avgToolCalls.toFixed(2)}`);

      // æ‰¾å‡ºæœ€æ…¢çš„å›åˆ
      const slowestTurn = turns.reduce((max, t) =>
        (t.duration || 0) > (max.duration || 0) ? t : max
      );

      console.log(`\n  Slowest turn: #${slowestTurn.turnNumber}`);
      console.log(`    Duration: ${formatDuration(slowestTurn.duration || 0)}`);
      console.log(`    Tool calls: ${slowestTurn.toolCalls}`);
    }

    // è¾“å‡ºå‹ç¼©å†å²
    if (compactionHistory.length > 0) {
      console.log('\nğŸ—œï¸  Compaction History:');
      console.log(`  Total compactions: ${compactionHistory.length}`);

      const totalRemoved = compactionHistory.reduce((sum, c) => sum + c.removedCount, 0);
      console.log(`  Total messages removed: ${totalRemoved}`);
    }
  });

  // ===== é’©å­ 8: session_shutdown =====
  // ä¼šè¯å…³é—­æ¸…ç†

  pi.on('session_shutdown', (session) => {
    console.log('\nğŸ”š Session shutdown');

    // æ¸…ç†çŠ¶æ€
    turnStats.clear();
    compactionHistory.length = 0;
    projectContextCache = null;

    console.log('  âœ“ Cleaned up resources');
  });

  // ===== è¾…åŠ©å‡½æ•° =====

  /**
   * è·å–å½“å‰å›åˆç¼–å·
   */
  function getCurrentTurn(): number | null {
    // ç®€åŒ–å®ç°ï¼šè¿”å›æœ€æ–°çš„å›åˆ
    const turns = Array.from(turnStats.keys());
    if (turns.length > 0) {
      return Math.max(...turns);
    }
    return null;
  }
}
```

---

## é…ç½®æ–‡ä»¶ç¤ºä¾‹

### 1. é¡¹ç›®ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼ˆ.pi/project-context.jsonï¼‰

```json
{
  "name": "My Awesome Project",
  "framework": "React + TypeScript",
  "language": "TypeScript",
  "codingStandards": [
    "Use TypeScript strict mode",
    "Follow ESLint rules",
    "Write unit tests for all components",
    "Use functional components with hooks",
    "Avoid any type"
  ],
  "dependencies": [
    "react@18.2.0",
    "typescript@5.0.0",
    "vite@4.3.0",
    "vitest@0.32.0"
  ]
}
```

### 2. ä»£ç è§„èŒƒæ–‡ä»¶ï¼ˆ.pi/coding-standards.mdï¼‰

```markdown
# Coding Standards

## TypeScript

- Use TypeScript strict mode
- Avoid `any` type
- Use interfaces for object shapes
- Use type aliases for unions

## React

- Use functional components
- Use hooks instead of class components
- Extract custom hooks for reusable logic
- Use React.memo for performance optimization

## Testing

- Write unit tests for all functions
- Use Vitest for testing
- Aim for 80%+ code coverage
- Test edge cases and error handling

## Code Style

- Follow ESLint and Prettier rules
- Use meaningful variable names
- Add JSDoc comments for public APIs
- Keep functions small and focused
```

---

## è¿è¡Œè¾“å‡ºç¤ºä¾‹

```
ğŸ”„ Lifecycle Hooks Application Extension loaded

ğŸ“ before_agent_start: Injecting context
  âœ“ Injected project context
  âœ“ Injected coding standards
  âœ“ Injected additional instructions
  Total messages: 5

ğŸ”„ Turn 1 started

ğŸ”§ Tool Called: read
ğŸ”§ Tool Called: bash
ğŸ”§ Tool Called: write

ğŸ“Š Turn 1 ended
  Duration: 15.23s
  Tool calls: 3
  Messages added: 2
  Efficiency: 0.20 tool calls/sec

ğŸ”„ Turn 2 started

ğŸ”§ Tool Called: read
ğŸ”§ Tool Called: edit
ğŸ”§ Tool Called: bash

ğŸ“Š Turn 2 ended
  Duration: 12.45s
  Tool calls: 3
  Messages added: 2
  Efficiency: 0.24 tool calls/sec

ğŸ—œï¸  session_before_compact: Custom compaction
  Messages before: 25
  Messages after: 15
  Removed: 10
  Kept important: 5
  Kept recent: 10

ğŸ”„ Turn 3 started

ğŸ”§ Tool Called: bash
ğŸ”§ Tool Called: bash
... (20 tool calls)

ğŸ“Š Turn 3 ended
  Duration: 45.67s
  Tool calls: 22
  Messages added: 3
  âš ï¸  Slow turn detected (>30.00s)
  âš ï¸  Too many tool calls (>20)
  Efficiency: 0.48 tool calls/sec

âœ… Agent ended

ğŸ“ˆ Turn Statistics:
  Total turns: 3
  Total duration: 1.23min
  Avg duration: 24.45s
  Total tool calls: 28
  Avg tool calls: 9.33

  Slowest turn: #3
    Duration: 45.67s
    Tool calls: 22

ğŸ—œï¸  Compaction History:
  Total compactions: 1
  Total messages removed: 10

ğŸ”š Session shutdown
  âœ“ Cleaned up resources
```

---

## ä»£ç è¯´æ˜

### 1. before_agent_start é’©å­

**åŠŸèƒ½ï¼š** åœ¨ Agent å¯åŠ¨å‰æ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡å’Œä»£ç è§„èŒƒ

**å®ç°ï¼š**
```typescript
pi.on('before_agent_start', (messages: Message[]) => {
  // åŠ è½½é¡¹ç›®ä¸Šä¸‹æ–‡
  const context = loadProjectContext();

  // æ³¨å…¥é¡¹ç›®ä¿¡æ¯
  messages.push({
    role: 'system',
    content: `Project: ${context.name}...`
  });

  // æ³¨å…¥ä»£ç è§„èŒƒ
  const standards = loadCodingStandards();
  messages.push({
    role: 'system',
    content: standards
  });
});
```

**ä»·å€¼ï¼š**
- å®šåˆ¶ Agent è¡Œä¸º
- ç»Ÿä¸€å›¢é˜Ÿè§„èŒƒ
- æé«˜ä»£ç è´¨é‡

### 2. session_before_compact é’©å­

**åŠŸèƒ½ï¼š** è‡ªå®šä¹‰ä¼šè¯å‹ç¼©ç­–ç•¥

**å®ç°ï¼š**
```typescript
pi.on('session_before_compact', (session: Session) => {
  const messages = session.messages;

  // ä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯
  const recentMessages = messages.slice(-10);

  // ä¿ç•™é‡è¦æ¶ˆæ¯
  const importantMessages = messages
    .slice(0, -10)
    .filter(msg => isImportantMessage(msg));

  // åˆå¹¶æ¶ˆæ¯
  messages.length = 0;
  messages.push(...importantMessages, ...recentMessages);
});
```

**ä»·å€¼ï¼š**
- ä¼˜åŒ–ä¸Šä¸‹æ–‡ä½¿ç”¨
- ä¿ç•™é‡è¦ä¿¡æ¯
- å‡å°‘ token æ¶ˆè€—

### 3. turn_end é’©å­

**åŠŸèƒ½ï¼š** å›åˆç»“æŸç»Ÿè®¡åˆ†æ

**å®ç°ï¼š**
```typescript
pi.on('turn_end', (turnNumber: number) => {
  const stats = turnStats.get(turnNumber);

  // è®¡ç®—æŒç»­æ—¶é—´
  stats.duration = Date.now() - stats.startTime;

  // æ€§èƒ½åˆ†æ
  if (stats.duration > 30000) {
    console.warn('Slow turn detected');
  }

  // æ•ˆç‡æŒ‡æ ‡
  const efficiency = stats.toolCalls / (stats.duration / 1000);
  console.log(`Efficiency: ${efficiency} tool calls/sec`);
});
```

**ä»·å€¼ï¼š**
- æ€§èƒ½ç›‘æ§
- è¯†åˆ«ç“¶é¢ˆ
- ä¼˜åŒ–ç­–ç•¥

---

## æœ€ä½³å®è·µ

### 1. ç¼“å­˜é¡¹ç›®ä¸Šä¸‹æ–‡

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ç¼“å­˜
let projectContextCache: ProjectContext | null = null;

pi.on('before_agent_start', (messages) => {
  if (!projectContextCache) {
    projectContextCache = loadProjectContext();
  }
  // ä½¿ç”¨ç¼“å­˜
});
```

### 2. å®‰å…¨ä¿®æ”¹æ¶ˆæ¯æ•°ç»„

```typescript
// âœ… æ¨èï¼šæ¸…ç©ºåé‡æ–°å¡«å……
messages.length = 0;
messages.push(...newMessages);

// âŒ ä¸æ¨èï¼šç›´æ¥èµ‹å€¼ï¼ˆä¸ä¼šç”Ÿæ•ˆï¼‰
messages = newMessages;
```

### 3. æ€§èƒ½é˜ˆå€¼é…ç½®

```typescript
// âœ… æ¨èï¼šå¯é…ç½®çš„é˜ˆå€¼
const CONFIG = {
  performance: {
    slowTurnThreshold: 30000,
    tooManyToolCallsThreshold: 20
  }
};
```

---

## å‚è€ƒèµ„æ–™

**NestJS ç”Ÿå‘½å‘¨æœŸé’©å­æ¨¡å¼ï¼š**
- OnInit / OnDestroy æ¨¡å¼
- ä¾èµ–æ³¨å…¥ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†
- èµ„æºæ¸…ç†æœ€ä½³å®è·µ

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-21
**ç»´æŠ¤è€…ï¼š** Claude Code
