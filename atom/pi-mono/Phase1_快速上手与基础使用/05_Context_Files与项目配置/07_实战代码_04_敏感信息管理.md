# 实战代码：敏感信息管理

> 完整的敏感信息管理方案，包含环境变量、API 密钥、.gitignore 配置和安全最佳实践

---

## 一、场景描述

**常见问题：**
- API 密钥不小心提交到 Git
- 环境变量管理混乱
- 不知道哪些文件应该忽略
- 团队成员配置不一致

**目标：**
- 安全管理 API 密钥和敏感信息
- 使用环境变量而非硬编码
- 正确配置 .gitignore
- 区分全局和项目级敏感信息

---

## 二、核心原则

### 2.1 三不原则

```markdown
1. **不要硬编码** - 敏感信息不要写在代码中
2. **不要提交** - 敏感信息不要提交到 Git
3. **不要共享** - 敏感信息不要在不安全的渠道共享
```

### 2.2 分层管理

```
环境变量（.env）
↓
应用配置（settings.json）
↓
代码引用
```

---

## 三、环境变量管理

### 3.1 项目结构

```bash
project/
├── .env.example          # 环境变量模板（提交到 Git）
├── .env                  # 本地环境变量（不提交）
├── .env.development      # 开发环境（不提交）
├── .env.production       # 生产环境（不提交）
├── .gitignore            # Git 忽略规则
└── src/
    └── config.ts         # 配置加载
```

### 3.2 .env.example（模板）

```bash
# .env.example（提交到 Git）
# 这是环境变量模板，不包含真实的敏感信息

# API 配置
API_BASE_URL=https://api.example.com
API_KEY=your_api_key_here
API_SECRET=your_api_secret_here

# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/dbname

# 认证配置
JWT_SECRET=your_jwt_secret_here
JWT_EXPIRES_IN=7d

# 第三方服务
STRIPE_PUBLIC_KEY=pk_test_xxxxx
STRIPE_SECRET_KEY=sk_test_xxxxx

# 邮件服务
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your_email@example.com
SMTP_PASSWORD=your_password_here

# 其他配置
NODE_ENV=development
PORT=3000
LOG_LEVEL=info
```

### 3.3 .env（实际配置）

```bash
# .env（不提交到 Git）
# 这是实际的环境变量，包含真实的敏感信息

# API 配置
API_BASE_URL=https://api.example.com
API_KEY=sk-1234567890abcdef
API_SECRET=secret-abcdef1234567890

# 数据库配置
DATABASE_URL=postgresql://admin:MySecretPassword123@localhost:5432/myapp

# 认证配置
JWT_SECRET=super-secret-jwt-key-do-not-share
JWT_EXPIRES_IN=7d

# 第三方服务
STRIPE_PUBLIC_KEY=pk_live_xxxxxxxxxxxxx
STRIPE_SECRET_KEY=sk_live_xxxxxxxxxxxxx

# 邮件服务
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=myapp@gmail.com
SMTP_PASSWORD=MyEmailPassword123

# 其他配置
NODE_ENV=production
PORT=3000
LOG_LEVEL=info
```

### 3.4 配置加载（TypeScript）

```typescript
// src/config.ts
import dotenv from 'dotenv';
import { z } from 'zod';

// 加载环境变量
dotenv.config();

// 定义配置 schema（使用 Zod 验证）
const configSchema = z.object({
  // API 配置
  apiBaseUrl: z.string().url(),
  apiKey: z.string().min(1),
  apiSecret: z.string().min(1),

  // 数据库配置
  databaseUrl: z.string().url(),

  // 认证配置
  jwtSecret: z.string().min(32),
  jwtExpiresIn: z.string(),

  // 第三方服务
  stripePublicKey: z.string().startsWith('pk_'),
  stripeSecretKey: z.string().startsWith('sk_'),

  // 邮件服务
  smtpHost: z.string(),
  smtpPort: z.number(),
  smtpUser: z.string().email(),
  smtpPassword: z.string().min(1),

  // 其他配置
  nodeEnv: z.enum(['development', 'production', 'test']),
  port: z.number(),
  logLevel: z.enum(['debug', 'info', 'warn', 'error']),
});

// 解析和验证配置
function loadConfig() {
  try {
    const config = configSchema.parse({
      // API 配置
      apiBaseUrl: process.env.API_BASE_URL,
      apiKey: process.env.API_KEY,
      apiSecret: process.env.API_SECRET,

      // 数据库配置
      databaseUrl: process.env.DATABASE_URL,

      // 认证配置
      jwtSecret: process.env.JWT_SECRET,
      jwtExpiresIn: process.env.JWT_EXPIRES_IN,

      // 第三方服务
      stripePublicKey: process.env.STRIPE_PUBLIC_KEY,
      stripeSecretKey: process.env.STRIPE_SECRET_KEY,

      // 邮件服务
      smtpHost: process.env.SMTP_HOST,
      smtpPort: parseInt(process.env.SMTP_PORT || '587', 10),
      smtpUser: process.env.SMTP_USER,
      smtpPassword: process.env.SMTP_PASSWORD,

      // 其他配置
      nodeEnv: process.env.NODE_ENV || 'development',
      port: parseInt(process.env.PORT || '3000', 10),
      logLevel: process.env.LOG_LEVEL || 'info',
    });

    return config;
  } catch (error) {
    if (error instanceof z.ZodError) {
      console.error('配置验证失败：');
      error.errors.forEach((err) => {
        console.error(`- ${err.path.join('.')}: ${err.message}`);
      });
    }
    throw new Error('配置加载失败');
  }
}

// 导出配置
export const config = loadConfig();

// 类型导出
export type Config = z.infer<typeof configSchema>;
```

### 3.5 使用配置

```typescript
// src/api/client.ts
import { config } from '@/config';

export const apiClient = axios.create({
  baseURL: config.apiBaseUrl,
  headers: {
    'Authorization': `Bearer ${config.apiKey}`,
  },
});

// src/db/connection.ts
import { config } from '@/config';

export const db = new Database(config.databaseUrl);

// src/auth/jwt.ts
import { config } from '@/config';

export function signToken(payload: any) {
  return jwt.sign(payload, config.jwtSecret, {
    expiresIn: config.jwtExpiresIn,
  });
}
```

---

## 四、Pi Agent 配置中的敏感信息

### 4.1 不要在 settings.json 中存储敏感信息

```json
// ❌ 错误：直接在 settings.json 中存储 API 密钥
{
  "shellEnv": {
    "OPENAI_API_KEY": "sk-1234567890abcdef"
  }
}
```

### 4.2 使用环境变量引用

```json
// ✅ 正确：引用环境变量
{
  "shellEnv": {
    "OPENAI_API_KEY": "${OPENAI_API_KEY}"
  }
}
```

**说明：** Pi Agent 会从系统环境变量中读取 `OPENAI_API_KEY`。

### 4.3 在 shell 配置中设置环境变量

```bash
# ~/.zshrc 或 ~/.bashrc
export OPENAI_API_KEY="sk-1234567890abcdef"
export ANTHROPIC_API_KEY="sk-ant-xxxxxxxxxxxxx"
export DATABASE_URL="postgresql://..."

# 重新加载配置
source ~/.zshrc
```

### 4.4 使用 .env 文件（推荐）

```bash
# 项目根目录 .env
OPENAI_API_KEY=sk-1234567890abcdef
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxx
DATABASE_URL=postgresql://...

# 在代码中加载
# src/index.ts
import dotenv from 'dotenv';
dotenv.config();

// 现在可以使用 process.env.OPENAI_API_KEY
```

---

## 五、.gitignore 配置

### 5.1 完整的 .gitignore

```bash
# .gitignore

# ============================================
# 环境变量和敏感信息
# ============================================
.env
.env.local
.env.*.local
.env.development
.env.production
.env.test

# ============================================
# Pi Agent 个人配置
# ============================================
.pi/settings.json
.pi/SYSTEM.md
.pi/APPEND_SYSTEM.md

# 注意：AGENTS.md 通常提交到 Git（团队共享）
# 如果包含敏感信息，也应该忽略
# .pi/AGENTS.md

# ============================================
# 依赖和构建产物
# ============================================
node_modules/
.pnpm-store/
dist/
build/
out/
.next/
.nuxt/
.cache/

# ============================================
# 日志文件
# ============================================
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# ============================================
# IDE 和编辑器
# ============================================
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store

# ============================================
# 测试覆盖率
# ============================================
coverage/
.nyc_output/
*.lcov

# ============================================
# 临时文件
# ============================================
tmp/
temp/
*.tmp
*.bak

# ============================================
# 数据库文件
# ============================================
*.sqlite
*.sqlite3
*.db

# ============================================
# 证书和密钥
# ============================================
*.pem
*.key
*.cert
*.crt
*.p12
*.pfx

# ============================================
# 云服务配置
# ============================================
.aws/
.gcloud/
.azure/

# ============================================
# 其他敏感文件
# ============================================
secrets/
credentials/
*.secret
```

### 5.2 检查是否有敏感文件被跟踪

```bash
# 检查当前被 Git 跟踪的文件
git ls-files

# 检查是否有 .env 文件被跟踪
git ls-files | grep .env

# 如果发现敏感文件被跟踪，立即移除
git rm --cached .env
git commit -m "chore: remove .env from git"
```

### 5.3 从 Git 历史中删除敏感信息

```bash
# ⚠️ 警告：这会重写 Git 历史，需要谨慎操作

# 使用 git filter-branch（旧方法）
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env" \
  --prune-empty --tag-name-filter cat -- --all

# 使用 BFG Repo-Cleaner（推荐）
# 1. 安装 BFG
brew install bfg

# 2. 删除敏感文件
bfg --delete-files .env

# 3. 清理
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 4. 强制推送（需要团队协调）
git push origin --force --all
```

---

## 六、AGENTS.md 中的敏感信息处理

### 6.1 不要在 AGENTS.md 中写敏感信息

```markdown
# ❌ 错误：在 AGENTS.md 中写 API 密钥
# 项目规范

## API 配置
- API Key: sk-1234567890abcdef
- API Secret: secret-abcdef1234567890
```

### 6.2 正确的做法：说明如何获取

```markdown
# ✅ 正确：说明如何配置环境变量
# 项目规范

## 环境变量配置
项目使用 `.env` 文件管理敏感信息。

### 设置步骤
1. 复制环境变量模板：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填入你的配置：
   - `API_KEY` - 从 https://platform.openai.com/api-keys 获取
   - `DATABASE_URL` - 数据库连接字符串
   - `JWT_SECRET` - 使用 `openssl rand -base64 32` 生成

3. 不要提交 `.env` 文件到 Git

### 环境变量列表
- `API_KEY` - OpenAI API 密钥
- `API_SECRET` - API 密钥的 Secret
- `DATABASE_URL` - 数据库连接字符串
- `JWT_SECRET` - JWT 签名密钥
- `STRIPE_SECRET_KEY` - Stripe 支付密钥

### 获取 API 密钥
- OpenAI: https://platform.openai.com/api-keys
- Stripe: https://dashboard.stripe.com/apikeys
- 数据库: 联系 DevOps 团队
```

---

## 七、团队协作中的敏感信息管理

### 7.1 新成员 Onboarding

**步骤 1：提供环境变量模板**

```bash
# 项目根目录
.env.example  # 提交到 Git
```

**步骤 2：新成员复制模板**

```bash
# 新成员执行
cp .env.example .env
```

**步骤 3：填入实际值**

```bash
# 新成员编辑 .env
# 从团队密钥管理系统获取实际值
```

### 7.2 使用密钥管理系统

**推荐工具：**
- **1Password** - 团队密码管理
- **AWS Secrets Manager** - 云端密钥管理
- **HashiCorp Vault** - 企业级密钥管理
- **Doppler** - 环境变量管理平台

**示例：使用 1Password CLI**

```bash
# 安装 1Password CLI
brew install --cask 1password-cli

# 登录
op signin

# 获取密钥
export API_KEY=$(op read "op://Development/OpenAI/api_key")
export DATABASE_URL=$(op read "op://Development/Database/connection_string")

# 运行应用
pnpm dev
```

### 7.3 CI/CD 中的敏感信息

**GitHub Actions 示例：**

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm build

      - name: Deploy
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: pnpm deploy
```

**设置 GitHub Secrets：**
1. 进入仓库 Settings → Secrets and variables → Actions
2. 点击 "New repository secret"
3. 添加密钥（如 `API_KEY`、`DATABASE_URL`）

---

## 八、安全检查清单

### 8.1 代码提交前检查

```bash
# 1. 检查是否有敏感信息
git diff --cached | grep -i "api_key\|password\|secret\|token"

# 2. 检查 .env 文件是否被忽略
git status | grep .env

# 3. 运行 git-secrets（自动检查）
git secrets --scan
```

### 8.2 安装 git-secrets

```bash
# 安装
brew install git-secrets

# 初始化
cd your-project
git secrets --install

# 添加规则
git secrets --register-aws
git secrets --add 'api[_-]?key'
git secrets --add 'password'
git secrets --add 'secret'
git secrets --add 'token'

# 扫描历史
git secrets --scan-history
```

### 8.3 使用 pre-commit hook

```bash
# .git/hooks/pre-commit
#!/bin/bash

# 检查敏感信息
if git diff --cached | grep -iE "api_key|password|secret|token" > /dev/null; then
  echo "❌ 错误：检测到可能的敏感信息"
  echo "请检查你的代码，确保没有硬编码敏感信息"
  exit 1
fi

# 检查 .env 文件
if git diff --cached --name-only | grep "^\.env$" > /dev/null; then
  echo "❌ 错误：不要提交 .env 文件"
  exit 1
fi

echo "✅ 安全检查通过"
exit 0
```

```bash
# 使其可执行
chmod +x .git/hooks/pre-commit
```

---

## 九、常见错误和修复

### 9.1 错误 1：不小心提交了 .env

**修复步骤：**

```bash
# 1. 从 Git 中移除
git rm --cached .env

# 2. 添加到 .gitignore
echo ".env" >> .gitignore

# 3. 提交修改
git add .gitignore
git commit -m "chore: remove .env from git and add to .gitignore"

# 4. 推送
git push

# 5. 如果已经推送到远程，需要重写历史（见上文）
```

### 9.2 错误 2：API 密钥泄露

**应对措施：**

```bash
# 1. 立即撤销泄露的密钥
# 登录服务提供商的控制台，撤销旧密钥

# 2. 生成新密钥
# 在服务提供商的控制台生成新密钥

# 3. 更新本地配置
# 编辑 .env 文件，使用新密钥

# 4. 通知团队
# 告知团队成员更新密钥

# 5. 从 Git 历史中删除（如果已提交）
# 使用 BFG Repo-Cleaner 或 git filter-branch
```

### 9.3 错误 3：团队成员配置不一致

**解决方案：**

```bash
# 1. 提供详细的 .env.example
# 包含所有必需的环境变量

# 2. 在 AGENTS.md 中说明配置步骤
# 详细的 Onboarding 指南

# 3. 使用配置验证
# 在应用启动时验证环境变量（见上文 config.ts）

# 4. 使用密钥管理系统
# 统一管理团队密钥
```

---

## 十、最佳实践总结

### 10.1 环境变量管理

```markdown
✅ 使用 .env 文件管理敏感信息
✅ 提供 .env.example 模板
✅ 在代码中验证环境变量
✅ 使用类型安全的配置加载（Zod）
❌ 不要硬编码敏感信息
❌ 不要提交 .env 文件到 Git
```

### 10.2 Git 管理

```markdown
✅ 配置完整的 .gitignore
✅ 使用 git-secrets 自动检查
✅ 设置 pre-commit hook
✅ 定期审查 Git 历史
❌ 不要提交敏感文件
❌ 不要在提交信息中写敏感信息
```

### 10.3 团队协作

```markdown
✅ 使用密钥管理系统
✅ 提供详细的 Onboarding 文档
✅ 在 AGENTS.md 中说明配置步骤
✅ 定期更新密钥
❌ 不要通过不安全渠道共享密钥
❌ 不要在 AGENTS.md 中写实际密钥
```

### 10.4 Pi Agent 配置

```markdown
✅ 使用环境变量引用
✅ .pi/settings.json 加入 .gitignore
✅ 在 AGENTS.md 中说明如何配置
❌ 不要在 settings.json 中硬编码密钥
❌ 不要在 AGENTS.md 中写实际密钥
```

---

## 十一、快速检查脚本

### 11.1 安全检查脚本

```bash
#!/bin/bash
# check-secrets.sh

echo "🔍 检查敏感信息..."

# 检查是否有 .env 文件被跟踪
if git ls-files | grep -q "^\.env$"; then
  echo "❌ 错误：.env 文件被 Git 跟踪"
  exit 1
fi

# 检查代码中是否有硬编码的密钥
if git grep -iE "api_key.*=.*['\"]sk-|password.*=.*['\"][^$]" -- '*.ts' '*.js' '*.tsx' '*.jsx'; then
  echo "❌ 错误：检测到硬编码的密钥"
  exit 1
fi

# 检查 .gitignore 是否包含必要的规则
if ! grep -q "^\.env$" .gitignore; then
  echo "⚠️  警告：.gitignore 中没有 .env"
fi

if ! grep -q "^\.pi/settings\.json$" .gitignore; then
  echo "⚠️  警告：.gitignore 中没有 .pi/settings.json"
fi

echo "✅ 安全检查通过"
```

### 11.2 使用脚本

```bash
# 添加到 package.json
{
  "scripts": {
    "check:secrets": "./scripts/check-secrets.sh",
    "precommit": "pnpm check:secrets && pnpm lint && pnpm test"
  }
}

# 运行检查
pnpm check:secrets
```

---

## 十二、总结

**敏感信息管理的核心要点：**

1. **环境变量** - 使用 .env 文件，不要硬编码
2. **.gitignore** - 正确配置，防止敏感文件提交
3. **密钥管理** - 使用专业工具，不要明文共享
4. **自动检查** - 使用 git-secrets 和 pre-commit hook
5. **团队协作** - 提供模板和文档，统一管理

**记住：** 敏感信息泄露可能导致严重的安全问题，预防永远比补救更重要！
