# 实战代码 03：会话管理场景

> 展示如何使用会话分支和历史追溯功能

---

## 场景 1：尝试不同技术方案

### 初始讨论

```bash
> /new
> /name auth-system-design

> 请帮我设计一个用户认证系统

AI: 我建议使用 JWT 认证方案...
[详细设计]
```

### 创建分支尝试 OAuth

```bash
> /tree
# 选择初始设计节点

> /fork
> /name auth-oauth-approach

> 如果使用 OAuth 2.0 呢？

AI: OAuth 2.0 的实现方式...
[OAuth 设计]
```

### 创建另一个分支尝试 Session

```bash
> /tree
# 回到初始设计节点

> /fork
> /name auth-session-approach

> 如果使用传统 Session 呢？

AI: Session-based 认证...
[Session 设计]
```

### 对比三种方案

```bash
> /tree

Session Tree:
└─ 初始问题
   ├─ JWT 方案 (main)
   ├─ OAuth 方案 (auth-oauth-approach)
   └─ Session 方案 (auth-session-approach)

> 请对比这三种方案的优缺点

AI: [综合对比分析]
```

---

## 场景 2：长会话压缩

### 检查 Token 使用

```bash
> /session

Session: long-project
Messages: 200
Tokens: 150K
Cost: $2.25
```

### 执行压缩

```bash
> /compact

Compacting 180 messages...
Summary generated: "This session discussed..."
Compaction complete!

New token usage: 50K
Cost saved: $1.50
```

### 验证历史保留

```bash
# JSONL 文件仍包含所有原始消息
$ cat ~/.pi/sessions/long-project.jsonl | wc -l
201  # 200 条消息 + 1 条 compaction marker
```

---

## 场景 3：项目切换

### 保存当前工作

```bash
> /name project-a-feature-auth
# 当前会话已自动保存
```

### 切换到另一个项目

```bash
> /resume project-b

Resuming session: project-b
Loaded 50 messages
Last activity: 2 hours ago
```

### 稍后返回

```bash
> /resume project-a-feature-auth

Resuming session: project-a-feature-auth
Loaded 200 messages
# 继续之前的工作
```

---

## 最佳实践

1. **使用描述性名称**
   ```bash
   /name feature-user-auth-jwt
   /name bug-fix-login-redirect
   /name refactor-api-error-handling
   ```

2. **定期压缩长会话**
   ```bash
   # 当 Token > 100K 时
   /compact
   ```

3. **使用分支探索方案**
   ```bash
   /tree → 选择节点 → /fork → 尝试新方案
   ```

4. **保持会话组织**
   ```bash
   # 为不同项目创建独立会话
   /new → /name project-name
   ```

---

**来源：**
- [Sessions 文档](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/docs/sessions.md) - 2026-02
