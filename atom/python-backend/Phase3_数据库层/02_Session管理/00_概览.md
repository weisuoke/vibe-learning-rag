# Session管理 - 概览

> 数据库会话生命周期管理，类似数据库连接管理

---

## 为什么需要 Session 管理？

在 AI Agent 后端开发中，每个 API 请求都需要与数据库交互：
- 保存用户对话历史
- 查询知识库文档
- 更新 Agent 状态

**问题：** 如果不正确管理 Session，会导致：
- 数据不一致（部分操作成功，部分失败）
- 连接泄漏（Session 没有关闭，耗尽连接池）
- 并发冲突（多个请求共享同一个 Session）

**Session 管理的核心：** 确保每个请求有独立的 Session，操作要么全部成功（commit），要么全部失败（rollback）。

---

## 本文档结构

### 基础维度
- **01_30字核心.md** - 一句话理解 Session
- **02_第一性原理.md** - Session 的本质是什么
- **04_最小可用.md** - 5分钟上手 Session
- **05_双重类比.md** - 前端 + 日常生活类比
- **06_反直觉点.md** - 常见误区
- **08_面试必问.md** - 面试高频问题
- **09_化骨绵掌.md** - 进阶技巧
- **10_一句话总结.md** - 记忆口诀

### 核心概念（3个技术方向）
- **03_核心概念_01_Session创建与配置.md** - SessionMaker、Engine、连接参数
- **03_核心概念_02_事务管理.md** - commit/rollback、ACID、隔离级别
- **03_核心概念_03_FastAPI依赖注入集成.md** - get_db、中间件、异常处理

### 实战代码（3个场景）
- **07_实战代码_01_基础Session操作场景.md** - 创建、查询、关闭、上下文管理器
- **07_实战代码_02_事务管理场景.md** - 手动事务、嵌套事务、异常回滚
- **07_实战代码_03_FastAPI集成场景.md** - 依赖注入、中间件、异步 Session

---

## 学习路径

```
Session创建与配置 → 事务管理 → FastAPI集成
       ↓               ↓            ↓
   SessionMaker      ACID原则    依赖注入
   Engine配置        隔离级别    异常处理
   连接参数          锁机制      异步Session
```

---

## 与 AI Agent 开发的关系

| 场景 | Session 的作用 |
|------|---------------|
| 用户发送消息 | 创建 Session → 保存消息 → commit → 关闭 Session |
| Agent 查询知识库 | 创建 Session → 查询文档 → 关闭 Session（只读） |
| 对话历史记录 | 创建 Session → 批量插入 → commit → 关闭 Session |
| 错误处理 | 捕获异常 → rollback → 关闭 Session |

---

## 前置知识

- ✅ SQLAlchemy ORM 基础（Model 定义、CRUD 操作）
- ✅ Python 上下文管理器（`with` 语句）
- ✅ FastAPI 依赖注入（`Depends`）
- ✅ 数据库事务基本概念（ACID）

---

## 核心要点

1. **Session 是工作空间**：所有数据库操作都在 Session 中进行
2. **每个请求独立 Session**：不要跨请求共享 Session
3. **显式管理生命周期**：创建 → 使用 → 提交/回滚 → 关闭
4. **使用上下文管理器**：自动处理关闭和异常回滚
5. **FastAPI 依赖注入**：最佳实践是用 `Depends(get_db)`

---

## 快速预览

### 最简单的 Session 使用

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 1. 创建引擎
engine = create_engine("postgresql://user:pass@localhost/db")

# 2. 创建 SessionMaker
SessionLocal = sessionmaker(bind=engine)

# 3. 使用 Session
with SessionLocal() as session:
    # 查询数据
    users = session.query(User).all()
    # Session 自动关闭
```

### FastAPI 集成

```python
from fastapi import Depends

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.post("/users")
def create_user(user: UserCreate, db: Session = Depends(get_db)):
    db_user = User(**user.dict())
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user
```

---

## 学习目标

完成本文档后，你应该能够：

- [ ] 理解 Session 的生命周期
- [ ] 正确创建和配置 SessionMaker
- [ ] 使用上下文管理器管理 Session
- [ ] 在 FastAPI 中使用依赖注入
- [ ] 处理事务和异常回滚
- [ ] 避免常见的 Session 陷阱（连接泄漏、跨请求共享）

---

**版本：** v1.0
**最后更新：** 2026-02-11
