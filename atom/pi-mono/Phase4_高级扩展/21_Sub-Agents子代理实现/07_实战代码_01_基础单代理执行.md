# åŸºç¡€å•ä»£ç†æ‰§è¡Œ - å®æˆ˜ä»£ç 

> **çŸ¥è¯†ç‚¹**: Sub-Agents å­ä»£ç†å®ç° - åŸºç¡€å•ä»£ç†æ‰§è¡Œæ¨¡å¼
> **éš¾åº¦**: â­â­â­
> **å‰ç½®çŸ¥è¯†**: Extensionå¼€å‘åŸºç¡€ã€TypeScriptã€å¼‚æ­¥ç¼–ç¨‹

---

## 1. åœºæ™¯æè¿°

åŸºç¡€å•ä»£ç†æ‰§è¡Œæ˜¯ Sub-Agents ç³»ç»Ÿä¸­æœ€ç®€å•ä½†æœ€æ ¸å¿ƒçš„æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸»ä»£ç†å°†ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡å§”æ‰˜ç»™å•ä¸ªä¸“ä¸šåŒ–å­ä»£ç†æ‰§è¡Œï¼Œç­‰å¾…å…¶å®Œæˆåè·å–ç»“æœå¹¶ç»§ç»­åç»­æµç¨‹ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**:
- ä»£ç å®¡æŸ¥ï¼šå°†ä»£ç å˜æ›´å§”æ‰˜ç»™ code-reviewer ä»£ç†
- æ–‡æ¡£ç”Ÿæˆï¼šå°† API æ–‡æ¡£ç¼–å†™å§”æ‰˜ç»™ api-documenter ä»£ç†
- å®‰å…¨æ‰«æï¼šå°†æ¼æ´æ£€æµ‹å§”æ‰˜ç»™ security-auditor ä»£ç†
- æ€§èƒ½åˆ†æï¼šå°†æ€§èƒ½ç“¶é¢ˆåˆ†æå§”æ‰˜ç»™ performance-engineer ä»£ç†

æ ¹æ® [lst97/claude-code-sub-agents](https://github.com/lst97/claude-code-sub-agents) çš„å®é™…æ¡ˆä¾‹ï¼Œå•ä»£ç†æ‰§è¡Œæ¨¡å¼åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å æ®äº†çº¦ 60% çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜¯æœ€å¸¸ç”¨çš„ä»£ç†ç¼–æ’æ¨¡å¼ã€‚

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 å•ä»£ç†æ‰§è¡Œæ¨¡å‹

å•ä»£ç†æ‰§è¡Œéµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. **å•ä¸€è´£ä»»**: æ¯ä¸ªä»£ç†ä¸“æ³¨äºä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡é¢†åŸŸ
2. **åŒæ­¥ç­‰å¾…**: ä¸»ä»£ç†ç­‰å¾…å­ä»£ç†å®Œæˆåå†ç»§ç»­
3. **ç»“æœä¼ é€’**: å­ä»£ç†çš„è¾“å‡ºä½œä¸ºä¸»ä»£ç†çš„è¾“å…¥ç»§ç»­æµç¨‹
4. **é”™è¯¯éš”ç¦»**: å­ä»£ç†çš„å¤±è´¥ä¸ä¼šå½±å“ä¸»ä»£ç†çš„å…¶ä»–æ“ä½œ

æ ¹æ® [Camunda çš„æœ€ä½³å®è·µ](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)ï¼Œå•ä»£ç†æ‰§è¡Œåº”è¯¥éµå¾ª"å°½å¿«ç¦»å¼€ä»£ç†"åŸåˆ™ï¼šä»£ç†å®Œæˆç›®æ ‡åç«‹å³è¿”å›ç¡®å®šæ€§æµç¨‹ï¼Œè¿™æ ·å¯ä»¥æä¾›æ›´å¼ºçš„æ²»ç†å’Œå¯è§£é‡Šæ€§ï¼ŒåŒæ—¶é™ä½æˆæœ¬ã€‚

### 2.2 ä¸ pi-mono çš„é›†æˆ

åœ¨ pi-mono æ¶æ„ä¸­ï¼Œå•ä»£ç†æ‰§è¡Œé€šè¿‡ `subagent` Extension å®ç°ï¼š

```typescript
// åŸºäº pi-mono ExtensionAPI
pi.registerTool({
  name: "subagent",
  description: "Delegate tasks to specialized subagents",
  parameters: SubagentParams,
  async execute(toolCallId, params, signal, onUpdate, ctx) {
    // å•ä»£ç†æ‰§è¡Œé€»è¾‘
  }
});
```

è¿™ç§è®¾è®¡ä½¿å¾—å­ä»£ç†æˆä¸ºä¸»ä»£ç†å·¥å…·ç®±ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥åƒè°ƒç”¨å…¶ä»–å·¥å…·ä¸€æ ·è°ƒç”¨å­ä»£ç†ã€‚

---

## 3. å®Œæ•´ä»£ç ç¤ºä¾‹

### 3.1 åŸºç¡€å•ä»£ç†æ‰§è¡Œå®ç°

```typescript
import { ExtensionAPI } from "@pi-mono/extension-api";
import { z } from "zod";
import { spawn } from "child_process";
import { EventEmitter } from "events";

// å®šä¹‰å­ä»£ç†å‚æ•° Schema
const SingleAgentParams = z.object({
  agent: z.string().describe("The name of the agent to invoke"),
  task: z.string().describe("The task description for the agent"),
  context: z.record(z.any()).optional().describe("Additional context for the agent"),
});

type SingleAgentParams = z.infer<typeof SingleAgentParams>;

// å®šä¹‰å­ä»£ç†ç»“æœç±»å‹
interface AgentResult {
  success: boolean;
  output: string;
  usage?: {
    inputTokens: number;
    outputTokens: number;
    totalCost: number;
  };
  error?: string;
}

/**
 * åŸºç¡€å•ä»£ç†æ‰§è¡Œå™¨
 *
 * å‚è€ƒ: https://github.com/lst97/claude-code-sub-agents
 * å®ç°å•ä¸ªå­ä»£ç†çš„åŒæ­¥æ‰§è¡Œæ¨¡å¼
 */
export class SingleAgentExecutor {
  private agentsDir: string;
  private cwd: string;

  constructor(cwd: string, agentsDir?: string) {
    this.cwd = cwd;
    this.agentsDir = agentsDir || `${process.env.HOME}/.pi/agents`;
  }

  /**
   * æ‰§è¡Œå•ä¸ªå­ä»£ç†
   *
   * @param agent - ä»£ç†åç§°
   * @param task - ä»»åŠ¡æè¿°
   * @param context - é¢å¤–ä¸Šä¸‹æ–‡
   * @param signal - ä¸­æ–­ä¿¡å·
   * @param onUpdate - è¿›åº¦æ›´æ–°å›è°ƒ
   * @returns ä»£ç†æ‰§è¡Œç»“æœ
   */
  async execute(
    agent: string,
    task: string,
    context: Record<string, any> = {},
    signal?: AbortSignal,
    onUpdate?: (update: string) => void
  ): Promise<AgentResult> {
    try {
      // 1. éªŒè¯ä»£ç†å­˜åœ¨
      const agentPath = await this.findAgent(agent);
      if (!agentPath) {
        throw new Error(`Agent '${agent}' not found in ${this.agentsDir}`);
      }

      onUpdate?.(`ğŸ” Found agent: ${agent} at ${agentPath}`);

      // 2. å‡†å¤‡æ‰§è¡Œç¯å¢ƒ
      const executionContext = {
        task,
        context,
        cwd: this.cwd,
        timestamp: new Date().toISOString(),
      };

      onUpdate?.(`ğŸš€ Starting agent execution: ${agent}`);

      // 3. å¯åŠ¨å­ä»£ç†è¿›ç¨‹
      const result = await this.spawnAgent(
        agentPath,
        executionContext,
        signal,
        onUpdate
      );

      onUpdate?.(`âœ… Agent completed: ${agent}`);

      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      onUpdate?.(`âŒ Agent failed: ${errorMessage}`);

      return {
        success: false,
        output: "",
        error: errorMessage,
      };
    }
  }

  /**
   * æŸ¥æ‰¾ä»£ç†æ–‡ä»¶
   *
   * æ”¯æŒä¸¤ä¸ªä½ç½®:
   * - User-level: ~/.pi/agents/*.md
   * - Project-level: .pi/agents/*.md
   */
  private async findAgent(agentName: string): Promise<string | null> {
    const fs = require("fs").promises;
    const path = require("path");

    // æ£€æŸ¥ user-level
    const userAgentPath = path.join(this.agentsDir, `${agentName}.md`);
    try {
      await fs.access(userAgentPath);
      return userAgentPath;
    } catch {}

    // æ£€æŸ¥ project-level
    const projectAgentPath = path.join(this.cwd, ".pi", "agents", `${agentName}.md`);
    try {
      await fs.access(projectAgentPath);
      return projectAgentPath;
    } catch {}

    return null;
  }

  /**
   * å¯åŠ¨å­ä»£ç†è¿›ç¨‹
   *
   * å‚è€ƒ: https://github.com/hatchet-dev/icepick
   * ä½¿ç”¨ç‹¬ç«‹è¿›ç¨‹éš”ç¦»ç¡®ä¿å®¹é”™æ€§
   */
  private async spawnAgent(
    agentPath: string,
    context: any,
    signal?: AbortSignal,
    onUpdate?: (update: string) => void
  ): Promise<AgentResult> {
    return new Promise((resolve, reject) => {
      // æ„å»º pi å‘½ä»¤
      const args = [
        "--mode", "json",
        "--agent", agentPath,
        "--task", context.task,
        "--context", JSON.stringify(context.context || {}),
      ];

      const child = spawn("pi", args, {
        cwd: this.cwd,
        stdio: ["ignore", "pipe", "pipe"],
      });

      let stdout = "";
      let stderr = "";
      let usage = { inputTokens: 0, outputTokens: 0, totalCost: 0 };

      // å¤„ç†æ ‡å‡†è¾“å‡º
      child.stdout?.on("data", (data) => {
        const chunk = data.toString();
        stdout += chunk;

        // è§£ææµå¼æ›´æ–°
        const lines = chunk.split("\n").filter(Boolean);
        for (const line of lines) {
          try {
            const event = JSON.parse(line);

            // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
            if (event.type === "message_start") {
              onUpdate?.(`ğŸ“ Agent started processing...`);
            } else if (event.type === "content_block_delta") {
              onUpdate?.(`ğŸ’­ ${event.delta?.text || ""}`);
            } else if (event.type === "tool_use") {
              onUpdate?.(`ğŸ”§ Using tool: ${event.name}`);
            } else if (event.type === "message_end") {
              // æå– usage ä¿¡æ¯
              if (event.usage) {
                usage = {
                  inputTokens: event.usage.input_tokens || 0,
                  outputTokens: event.usage.output_tokens || 0,
                  totalCost: this.calculateCost(event.usage),
                };
              }
            }
          } catch {
            // é JSON è¡Œï¼Œå¯èƒ½æ˜¯æ™®é€šè¾“å‡º
            onUpdate?.(chunk.trim());
          }
        }
      });

      // å¤„ç†æ ‡å‡†é”™è¯¯
      child.stderr?.on("data", (data) => {
        stderr += data.toString();
      });

      // å¤„ç†è¿›ç¨‹é€€å‡º
      child.on("close", (code) => {
        if (code === 0) {
          resolve({
            success: true,
            output: this.extractOutput(stdout),
            usage,
          });
        } else {
          reject(new Error(`Agent exited with code ${code}: ${stderr}`));
        }
      });

      // å¤„ç†ä¸­æ–­ä¿¡å·
      signal?.addEventListener("abort", () => {
        child.kill("SIGTERM");
        reject(new Error("Agent execution aborted"));
      });

      // å¤„ç†è¿›ç¨‹é”™è¯¯
      child.on("error", (error) => {
        reject(error);
      });
    });
  }

  /**
   * ä» JSON è¾“å‡ºä¸­æå–ç»“æœ
   */
  private extractOutput(stdout: string): string {
    try {
      // å°è¯•è§£ææœ€åä¸€ä¸ªå®Œæ•´çš„ JSON å¯¹è±¡
      const lines = stdout.split("\n").filter(Boolean);
      for (let i = lines.length - 1; i >= 0; i--) {
        try {
          const event = JSON.parse(lines[i]);
          if (event.type === "message_end" && event.content) {
            return event.content;
          }
        } catch {}
      }
      return stdout;
    } catch {
      return stdout;
    }
  }

  /**
   * è®¡ç®— token æˆæœ¬
   *
   * åŸºäº Claude Sonnet 4.x å®šä»·:
   * - Input: $3 / 1M tokens
   * - Output: $15 / 1M tokens
   */
  private calculateCost(usage: any): number {
    const inputCost = (usage.input_tokens || 0) * 3 / 1_000_000;
    const outputCost = (usage.output_tokens || 0) * 15 / 1_000_000;
    return inputCost + outputCost;
  }
}

/**
 * Extension æ³¨å†Œå‡½æ•°
 */
export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "execute_single_agent",
    description: "Execute a single specialized agent for a specific task",
    parameters: SingleAgentParams,
    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const executor = new SingleAgentExecutor(ctx.cwd);

      const result = await executor.execute(
        params.agent,
        params.task,
        params.context,
        signal,
        (update) => {
          onUpdate({
            type: "progress",
            content: update,
          });
        }
      );

      if (!result.success) {
        throw new Error(result.error || "Agent execution failed");
      }

      return {
        output: result.output,
        usage: result.usage,
      };
    },
  });
}
```

### 3.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
// ç¤ºä¾‹ 1: ä»£ç å®¡æŸ¥
const reviewResult = await pi.tools.execute_single_agent({
  agent: "code-reviewer",
  task: "Review the authentication changes in src/auth.ts",
  context: {
    files: ["src/auth.ts"],
    focus: ["security", "best-practices"],
  },
});

// ç¤ºä¾‹ 2: æ€§èƒ½åˆ†æ
const perfResult = await pi.tools.execute_single_agent({
  agent: "performance-engineer",
  task: "Analyze the performance bottleneck in the API endpoint",
  context: {
    endpoint: "/api/users",
    metrics: {
      p95: 2500,
      p99: 5000,
    },
  },
});

// ç¤ºä¾‹ 3: æ–‡æ¡£ç”Ÿæˆ
const docsResult = await pi.tools.execute_single_agent({
  agent: "api-documenter",
  task: "Generate OpenAPI documentation for the user service",
  context: {
    service: "user-service",
    version: "v2",
  },
});
```

---

## 4. ä»£ç è§£æ

### 4.1 æ ¸å¿ƒè®¾è®¡å†³ç­–

**1. è¿›ç¨‹éš”ç¦»**

ä½¿ç”¨ `spawn` å¯åŠ¨ç‹¬ç«‹çš„ `pi` è¿›ç¨‹æ‰§è¡Œå­ä»£ç†ï¼Œè€Œéåœ¨åŒä¸€è¿›ç¨‹ä¸­è°ƒç”¨ã€‚è¿™ç§è®¾è®¡å‚è€ƒäº† [hatchet-dev/icepick](https://github.com/hatchet-dev/icepick) çš„æŒä¹…åŒ–æ‰§è¡Œæ¨¡å¼ï¼Œæä¾›ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **å®¹é”™æ€§**: å­ä»£ç†å´©æºƒä¸ä¼šå½±å“ä¸»ä»£ç†
- **èµ„æºéš”ç¦»**: æ¯ä¸ªä»£ç†æœ‰ç‹¬ç«‹çš„å†…å­˜å’Œä¸Šä¸‹æ–‡çª—å£
- **å¯ä¸­æ–­æ€§**: å¯ä»¥é€šè¿‡ä¿¡å·ä¼˜é›…åœ°ç»ˆæ­¢å­ä»£ç†

**2. æµå¼æ›´æ–°**

é€šè¿‡ `onUpdate` å›è°ƒå®æ—¶ä¼ é€’å­ä»£ç†çš„æ‰§è¡Œè¿›åº¦ï¼š

```typescript
child.stdout?.on("data", (data) => {
  // è§£æ JSON äº‹ä»¶æµ
  const event = JSON.parse(line);
  if (event.type === "content_block_delta") {
    onUpdate?.(`ğŸ’­ ${event.delta?.text || ""}`);
  }
});
```

è¿™ç§è®¾è®¡æä¾›äº†é€æ˜çš„æ‰§è¡Œå¯è§æ€§ï¼Œç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ°å­ä»£ç†çš„æ€è€ƒè¿‡ç¨‹å’Œå·¥å…·è°ƒç”¨ã€‚

**3. Usage è¿½è¸ª**

è‡ªåŠ¨æ”¶é›†å’Œè®¡ç®— token ä½¿ç”¨æƒ…å†µå’Œæˆæœ¬ï¼š

```typescript
usage = {
  inputTokens: event.usage.input_tokens || 0,
  outputTokens: event.usage.output_tokens || 0,
  totalCost: this.calculateCost(event.usage),
};
```

æ ¹æ® [Camunda çš„å»ºè®®](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)ï¼Œç¼©å°ä»£ç†å¾ªç¯å¯ä»¥å‡å°‘ token ä½¿ç”¨ï¼Œè¿™ä¸ªè¿½è¸ªæœºåˆ¶å¸®åŠ©å¼€å‘è€…ä¼˜åŒ–æˆæœ¬ã€‚

### 4.2 é”™è¯¯å¤„ç†ç­–ç•¥

ä»£ç å®ç°äº†å¤šå±‚é”™è¯¯å¤„ç†ï¼š

1. **ä»£ç†æŸ¥æ‰¾å¤±è´¥**: è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
2. **è¿›ç¨‹å¯åŠ¨å¤±è´¥**: æ•è· spawn é”™è¯¯
3. **æ‰§è¡Œè¶…æ—¶**: æ”¯æŒ AbortSignal ä¸­æ–­
4. **éé›¶é€€å‡ºç **: è§£æ stderr æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## 5. å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹ 1: Claude Code Sub-Agents çš„ç”Ÿäº§åº”ç”¨

**æ¥æº**: [lst97/claude-code-sub-agents](https://github.com/lst97/claude-code-sub-agents)

è¿™ä¸ªé¡¹ç›®åŒ…å« 33 ä¸ªä¸“ä¸šåŒ–å­ä»£ç†ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¹¿æ³›ä½¿ç”¨å•ä»£ç†æ‰§è¡Œæ¨¡å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®é™…çš„ ExportStep ç»„ä»¶å®ç°æ¡ˆä¾‹ï¼š

**å·¥ä½œæµ**:
1. **agent-organizer** åˆ†æéœ€æ±‚å¹¶é€‰æ‹©åˆé€‚çš„ä»£ç†
2. **frontend-developer** å®ç° React ç»„ä»¶
3. **code-reviewer** å®¡æŸ¥ä»£ç è´¨é‡
4. **test-automator** ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹

**å…³é”®æŒ‡æ ‡**:
- æ€»æ‰§è¡Œæ—¶é—´: çº¦ 8-12 åˆ†é’Ÿ
- Token æ¶ˆè€—: æ¯ä¸ªä»£ç† 2000-5000 tokens
- æˆåŠŸç‡: 95%+

**ç»éªŒæ•™è®­**:
- å•ä»£ç†æ‰§è¡Œæ¨¡å¼é€‚åˆæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡
- æµå¼æ›´æ–°æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
- Usage è¿½è¸ªå¸®åŠ©è¯†åˆ«æˆæœ¬ä¼˜åŒ–æœºä¼š

### æ¡ˆä¾‹ 2: Camunda çš„ä¼ä¸šçº§ä»£ç†ç¼–æ’

**æ¥æº**: [Camunda Blog - Agentic Orchestration](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)

Camunda åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å•ä»£ç†æ‰§è¡Œå¤„ç†ä»¥ä¸‹åœºæ™¯ï¼š

**KYC å’Œå…¥èŒæ£€æŸ¥**:
- **ä»£ç†è§’è‰²**: ç¼–æ’æ•°æ®æ”¶é›†ã€æ–‡æ¡£è§£é‡Šå’Œé£é™©æ€»ç»“
- **æŠ¤æ **: æœ€ç»ˆ pass/fail å†³ç­–ä¿ç•™åœ¨ç¡®å®šæ€§ KYC å†³ç­–æ¨¡å‹ä¸­
- **ç»“æœ**: å‡å°‘ 60% çš„äººå·¥å®¡æŸ¥æ—¶é—´

**æ–‡æ¡£æå–å’Œæ€»ç»“**:
- **ä»£ç†è§’è‰²**: è¯†åˆ«æ–‡æ¡£ç±»å‹ã€æå–ç›¸å…³æ®µè½ã€ç”Ÿæˆç»“æ„åŒ–æ€»ç»“
- **æŠ¤æ **: æµç¨‹ç¼–æ’ç¡®ä¿æ•æ„Ÿä¿¡æ¯è¢«å±è”½
- **ç»“æœ**: å¤„ç†é€Ÿåº¦æå‡ 10 å€

**å…³é”®å‘ç°**:
- ç¡®å®šæ€§é€»è¾‘ä¸åŠ¨æ€é€»è¾‘åˆ†ç¦»æ˜¯å…³é”®
- "å°½å¿«ç¦»å¼€ä»£ç†"åŸåˆ™é™ä½æˆæœ¬ 40-60%
- æ˜¾å¼å¤±è´¥è·¯å¾„æé«˜ç³»ç»Ÿå¯é æ€§

### æ¡ˆä¾‹ 3: Icepick çš„å¯æ‰©å±•ä»£ç†æ‰§è¡Œ

**æ¥æº**: [hatchet-dev/icepick](https://github.com/hatchet-dev/icepick)

Icepick ä½¿ç”¨æŒä¹…åŒ–æ‰§è¡Œæ¨¡å¼æ”¯æŒå¤§è§„æ¨¡å•ä»£ç†æ‰§è¡Œï¼š

**æŠ€æœ¯ç‰¹æ€§**:
- **è‡ªåŠ¨æ£€æŸ¥ç‚¹**: ä»£ç†å¯ä»¥ä»æ•…éšœä¸­æ¢å¤
- **äº‹ä»¶æ—¥å¿—**: å®Œæ•´çš„æ‰§è¡Œå†å²è®°å½•
- **åˆ†å¸ƒå¼æ‰§è¡Œ**: è·¨æœºå™¨ç¾¤è¿è¡Œä»£ç†

**å®é™…æ•°æ®**:
- å•æ¬¡æ‰§è¡Œå¯ç”Ÿæˆæ•°åä¸‡ä¸ªä»»åŠ¡
- æ¯æœˆè¿è¡Œæ•°åäº¿ä¸ªä»»åŠ¡
- æœºå™¨æ•…éšœæ—¶è‡ªåŠ¨é‡è°ƒåº¦å’Œæ¢å¤

**æœ€ä½³å®è·µ**:
- ä»£ç†åº”è¯¥æ˜¯æ— çŠ¶æ€ reducer
- æ‰€æœ‰å·¥ä½œé‡ä½œä¸ºä»»åŠ¡æˆ–å·¥å…·è°ƒç”¨
- å°† LLM è°ƒç”¨è§†ä¸ºåº“ï¼Œæ‹¥æœ‰æ•°æ®æŸ¥æ‰¾

---

## 6. æœ€ä½³å®è·µ

### 6.1 ä»£ç†è®¾è®¡åŸåˆ™

**1. å•ä¸€è´£ä»»åŸåˆ™**

æ¯ä¸ªä»£ç†åº”è¯¥ä¸“æ³¨äºä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡é¢†åŸŸã€‚æ ¹æ® [Camunda çš„å»ºè®®](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)ï¼š

```typescript
// âœ… å¥½çš„è®¾è®¡
const result = await executor.execute(
  "code-reviewer",
  "Review security aspects of authentication code"
);

// âŒ ä¸å¥½çš„è®¾è®¡
const result = await executor.execute(
  "general-agent",
  "Review code, write tests, and deploy to production"
);
```

**2. æ˜ç¡®çš„ç›®æ ‡å®šä¹‰**

å°†ä»£ç†è§†ä¸º"æœ‰å¤§è„‘çš„æµç¨‹æ­¥éª¤"ï¼Œå®šä¹‰å…·ä½“ç›®æ ‡è€Œéæ•´ä¸ªæµç¨‹ï¼š

```typescript
// âœ… æ˜ç¡®çš„ç›®æ ‡
task: "Collect all data needed for KYC decision"

// âŒ æ¨¡ç³Šçš„ç›®æ ‡
task: "Handle customer onboarding"
```

**3. å°½å¿«ç¦»å¼€ä»£ç†**

ä»£ç†å®Œæˆç›®æ ‡åç«‹å³è¿”å›ç¡®å®šæ€§æµç¨‹ï¼š

```typescript
// ä»£ç†åªè´Ÿè´£æ•°æ®æ”¶é›†
const data = await executor.execute("data-collector", "Gather user info");

// ç¡®å®šæ€§é€»è¾‘å¤„ç†å†³ç­–
const decision = applyKYCRules(data);
```

### 6.2 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

**4. æ•™ä¼šä»£ç†å¦‚ä½•å¤±è´¥**

æ ¹æ® [Camunda çš„æŠ¤æ æ£€æŸ¥æ¸…å•](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)ï¼Œæ˜¾å¼å®šä¹‰å¤±è´¥æ¡ä»¶ï¼š

```typescript
const result = await executor.execute(
  "security-auditor",
  "Scan for vulnerabilities, stop after 3 retries if data unavailable"
);

if (!result.success) {
  // å‡çº§åˆ°äººå·¥å®¡æŸ¥
  await escalateToHuman(result.error);
}
```

**5. ä½¿ç”¨ç³»ç»Ÿæç¤ºä½œä¸ºæŠ¤æ **

åœ¨ä»£ç†å®šä¹‰ä¸­åŒ…å«æ˜ç¡®çš„æˆåŠŸ/å¤±è´¥æ¡ä»¶ï¼š

```markdown
---
name: security-auditor
---

You must:
- Use provided tools instead of guessing
- Stop after 3 retries if required data is unavailable
- Return structured "cannot complete" result with reasons
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

**6. Token ä½¿ç”¨ä¼˜åŒ–**

æ ¹æ® [Camunda çš„å»ºè®®](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)ï¼Œç¼©å°ä»£ç†ç›®æ ‡å’Œå¾ªç¯å¯ä»¥å‡å°‘ token ä½¿ç”¨ï¼š

```typescript
// âœ… ä¼˜åŒ–çš„ä»£ç†è°ƒç”¨
const summary = await executor.execute(
  "document-summarizer",
  "Summarize key points from contract (max 200 words)"
);

// âŒ æœªä¼˜åŒ–çš„è°ƒç”¨
const summary = await executor.execute(
  "document-analyzer",
  "Analyze everything about this contract"
);
```

**7. ä½¿ç”¨ RAG è€Œéæç¤ºæ•´ä¸ªçŸ¥è¯†åº“**

```typescript
// âœ… ä½¿ç”¨ RAG
context: {
  relevantDocs: await retrieveRelevantDocs(query),
}

// âŒ æç¤ºæ•´ä¸ªçŸ¥è¯†åº“
context: {
  allDocs: await loadAllDocs(),
}
```

---

## 7. å¸¸è§é—®é¢˜

### Q1: å•ä»£ç†æ‰§è¡Œ vs ç›´æ¥è°ƒç”¨ LLM çš„åŒºåˆ«ï¼Ÿ

**A**: å•ä»£ç†æ‰§è¡Œæä¾›äº†é¢å¤–çš„æŠ½è±¡å±‚å’Œæ²»ç†èƒ½åŠ›ï¼š

- **ä¸“ä¸šåŒ–**: ä»£ç†æœ‰é¢„å®šä¹‰çš„ç³»ç»Ÿæç¤ºå’Œå·¥å…·é›†
- **å¯è§‚å¯Ÿæ€§**: è‡ªåŠ¨è¿½è¸ª usage å’Œæ‰§è¡Œå†å²
- **å®¹é”™æ€§**: è¿›ç¨‹éš”ç¦»å’Œé”™è¯¯æ¢å¤æœºåˆ¶
- **å¯å¤ç”¨æ€§**: ä»£ç†å¯ä»¥åœ¨å¤šä¸ªåœºæ™¯ä¸­å¤ç”¨

æ ¹æ® [lst97/claude-code-sub-agents](https://github.com/lst97/claude-code-sub-agents)ï¼Œä½¿ç”¨ä¸“ä¸šåŒ–ä»£ç†æ¯”ç›´æ¥è°ƒç”¨ LLM çš„æˆåŠŸç‡æé«˜çº¦ 30%ã€‚

### Q2: å¦‚ä½•å¤„ç†ä»£ç†æ‰§è¡Œè¶…æ—¶ï¼Ÿ

**A**: ä½¿ç”¨ AbortSignal å’Œè¶…æ—¶æœºåˆ¶ï¼š

```typescript
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 5 * 60 * 1000); // 5åˆ†é’Ÿ

try {
  const result = await executor.execute(
    "slow-agent",
    "Complex task",
    {},
    controller.signal
  );
} finally {
  clearTimeout(timeout);
}
```

### Q3: å¦‚ä½•åœ¨ä»£ç†é—´ä¼ é€’å¤§é‡æ•°æ®ï¼Ÿ

**A**: é¿å…åœ¨ context ä¸­ä¼ é€’å¤§é‡æ•°æ®ï¼Œä½¿ç”¨å¼•ç”¨ï¼š

```typescript
// âŒ ä¸å¥½çš„åšæ³•
context: {
  fileContent: largeFileContent, // å¯èƒ½è¶…è¿‡ context window
}

// âœ… å¥½çš„åšæ³•
context: {
  filePath: "/path/to/file", // ä»£ç†è‡ªå·±è¯»å–
}
```

æ ¹æ® [Icepick çš„æœ€ä½³å®è·µ](https://github.com/hatchet-dev/icepick)ï¼Œä»£ç†åº”è¯¥æ‹¥æœ‰æ•°æ®æŸ¥æ‰¾é€»è¾‘ï¼Œè€Œéæ¥æ”¶æ‰€æœ‰æ•°æ®ã€‚

---

## 8. æ‰©å±•é˜…è¯»

### æ ¸å¿ƒèµ„æº

1. **[lst97/claude-code-sub-agents](https://github.com/lst97/claude-code-sub-agents)**
   - 33 ä¸ªç”Ÿäº§çº§ä¸“ä¸šåŒ–ä»£ç†
   - å®é™…æ¡ˆä¾‹å’Œæœ€ä½³å®è·µ
   - å¤šä»£ç†åè°ƒç¤ºä¾‹

2. **[Camunda - Guardrails and Best Practices for Agentic Orchestration](https://camunda.com/blog/2026/01/guardrails-and-best-practices-for-agentic-orchestration/)**
   - ä¼ä¸šçº§ä»£ç†ç¼–æ’æœ€ä½³å®è·µ
   - ç¡®å®šæ€§ vs åŠ¨æ€é€»è¾‘åˆ†ç¦»
   - æŠ¤æ æ£€æŸ¥æ¸…å•

3. **[hatchet-dev/icepick](https://github.com/hatchet-dev/icepick)**
   - æŒä¹…åŒ–æ‰§è¡Œæ¨¡å¼
   - å¯æ‰©å±•ä»£ç†æ¶æ„
   - å®¹é”™å’Œæ¢å¤æœºåˆ¶

### ç›¸å…³çŸ¥è¯†ç‚¹

- `03_æ ¸å¿ƒæ¦‚å¿µ_01_Sub-Agentæ¶æ„ä¸Extensionç³»ç»Ÿ.md` - æ¶æ„æ¦‚è§ˆ
- `03_æ ¸å¿ƒæ¦‚å¿µ_03_æ‰§è¡Œæ¨¡å¼è¯¦è§£.md` - ä¸‰ç§æ‰§è¡Œæ¨¡å¼å¯¹æ¯”
- `07_å®æˆ˜ä»£ç _02_å¹¶è¡Œä»£ç†æ‰§è¡Œ.md` - å¹¶è¡Œæ‰§è¡Œæ¨¡å¼

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-21
**ä½œè€…**: Claude Code
**å®¡æ ¸**: åŸºäº 2025-2026 å¹´æœ€æ–°å®è·µ
