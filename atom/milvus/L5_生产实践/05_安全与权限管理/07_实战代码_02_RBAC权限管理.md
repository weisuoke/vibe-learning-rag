# 实战代码2：RBAC权限管理

**完整的 RBAC（基于角色的访问控制）实现，包括角色管理、权限授予、多租户隔离。**

---

## 场景说明

**目标：** 为企业 RAG 系统实现完整的 RBAC 权限管理：
- 创建和管理角色
- 授予和撤销权限
- 用户角色绑定
- 多租户权限隔离
- 权限审计和监控

**适用场景：**
- 多部门企业知识库
- SaaS 多租户服务
- 分级权限管理系统

---

## 完整代码

```python
"""
Milvus RBAC 权限管理
演示：完整的基于角色的访问控制实现
"""

import os
import logging
from typing import List, Dict, Optional
from datetime import datetime
from pymilvus import connections, utility, Collection
from dotenv import load_dotenv

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


# ===== 1. 角色管理器 =====

class RoleManager:
    """角色管理器"""

    def __init__(self):
        self.logger = logging.getLogger("RoleManager")
        load_dotenv()

        # 使用管理员账号连接
        connections.connect(
            alias="default",
            host=os.getenv("MILVUS_HOST", "localhost"),
            port=os.getenv("MILVUS_PORT", "19530"),
            user=os.getenv("MILVUS_ADMIN_USER", "root"),
            password=os.getenv("MILVUS_ADMIN_PASSWORD")
        )
        self.logger.info("✅ 管理员连接成功")

    def create_role(self, role_name: str) -> bool:
        """创建角色"""
        try:
            # 检查角色是否已存在
            if self._role_exists(role_name):
                self.logger.warning(f"角色 {role_name} 已存在")
                return False

            utility.create_role(role_name)
            self.logger.info(f"✅ 角色 {role_name} 已创建")
            return True

        except Exception as e:
            self.logger.error(f"❌ 创建角色失败：{e}")
            return False

    def drop_role(self, role_name: str) -> bool:
        """删除角色"""
        try:
            if not self._role_exists(role_name):
                self.logger.warning(f"角色 {role_name} 不存在")
                return False

            utility.drop_role(role_name)
            self.logger.info(f"✅ 角色 {role_name} 已删除")
            return True

        except Exception as e:
            self.logger.error(f"❌ 删除角色失败：{e}")
            return False

    def grant_privilege(self, role_name: str, privilege: str,
                       object_name: str = "*") -> bool:
        """授予权限"""
        try:
            utility.grant_privilege(
                role_name=role_name,
                object_type="Collection",
                privilege=privilege,
                object_name=object_name
            )
            self.logger.info(
                f"✅ 已授予角色 {role_name} 权限：{privilege} on {object_name}"
            )
            return True

        except Exception as e:
            self.logger.error(f"❌ 授予权限失败：{e}")
            return False

    def revoke_privilege(self, role_name: str, privilege: str,
                        object_name: str = "*") -> bool:
        """撤销权限"""
        try:
            utility.revoke_privilege(
                role_name=role_name,
                object_type="Collection",
                privilege=privilege,
                object_name=object_name
            )
            self.logger.info(
                f"✅ 已撤销角色 {role_name} 权限：{privilege} on {object_name}"
            )
            return True

        except Exception as e:
            self.logger.error(f"❌ 撤销权限失败：{e}")
            return False

    def add_user_to_role(self, username: str, role_name: str) -> bool:
        """将用户添加到角色"""
        try:
            utility.add_user_to_role(username, role_name)
            self.logger.info(f"✅ 用户 {username} 已添加到角色 {role_name}")
            return True

        except Exception as e:
            self.logger.error(f"❌ 添加用户到角色失败：{e}")
            return False

    def remove_user_from_role(self, username: str, role_name: str) -> bool:
        """从角色移除用户"""
        try:
            utility.remove_user_from_role(username, role_name)
            self.logger.info(f"✅ 用户 {username} 已从角色 {role_name} 移除")
            return True

        except Exception as e:
            self.logger.error(f"❌ 从角色移除用户失败：{e}")
            return False

    def list_roles(self, username: str = None) -> List[str]:
        """列出角色"""
        if username:
            return utility.list_roles(username)
        # 列出所有角色需要遍历所有用户
        return []

    def list_privileges(self, role_name: str) -> List[Dict]:
        """列出角色的权限"""
        try:
            return utility.list_privileges(role_name)
        except Exception as e:
            self.logger.error(f"❌ 列出权限失败：{e}")
            return []

    def _role_exists(self, role_name: str) -> bool:
        """检查角色是否存在"""
        # Milvus 没有直接的 API，通过尝试授权来检查
        try:
            privileges = utility.list_privileges(role_name)
            return True
        except:
            return False


# ===== 2. 预定义角色模板 =====

class RoleTemplates:
    """预定义角色模板"""

    @staticmethod
    def create_readonly_role(role_manager: RoleManager, role_name: str = "readonly"):
        """创建只读角色"""
        role_manager.create_role(role_name)

        # 授予查询权限
        privileges = ["Search", "Query", "DescribeCollection", "ShowCollections"]
        for privilege in privileges:
            role_manager.grant_privilege(role_name, privilege, "*")

        logger.info(f"✅ 只读角色 {role_name} 已创建")

    @staticmethod
    def create_data_admin_role(role_manager: RoleManager, role_name: str = "data_admin"):
        """创建数据管理员角色"""
        role_manager.create_role(role_name)

        # 授予数据操作权限
        privileges = [
            "Search", "Query", "Insert", "Delete", "Upsert",
            "CreateIndex", "DropIndex", "DescribeIndex",
            "Load", "Release", "GetLoadState"
        ]
        for privilege in privileges:
            role_manager.grant_privilege(role_name, privilege, "*")

        logger.info(f"✅ 数据管理员角色 {role_name} 已创建")

    @staticmethod
    def create_system_admin_role(role_manager: RoleManager, role_name: str = "system_admin"):
        """创建系统管理员角色"""
        role_manager.create_role(role_name)

        # 授予所有权限
        all_privileges = [
            "CreateCollection", "DropCollection", "DescribeCollection",
            "ShowCollections", "RenameCollection",
            "Load", "Release", "GetLoadState",
            "Insert", "Delete", "Upsert", "Search", "Query",
            "CreateIndex", "DropIndex", "DescribeIndex",
            "CreatePartition", "DropPartition", "ShowPartitions",
            "CreateUser", "DeleteUser", "UpdateUser", "SelectUser",
            "CreateRole", "DropRole", "SelectRole",
            "GrantPrivilege", "RevokePrivilege"
        ]
        for privilege in all_privileges:
            role_manager.grant_privilege(role_name, privilege, "*")

        logger.info(f"✅ 系统管理员角色 {role_name} 已创建")

    @staticmethod
    def create_department_role(role_manager: RoleManager, department: str):
        """创建部门角色"""
        role_name = f"{department}_staff"
        collection_name = f"{department}_docs"

        role_manager.create_role(role_name)

        # 只能访问本部门的 Collection
        privileges = ["Search", "Query", "DescribeCollection"]
        for privilege in privileges:
            role_manager.grant_privilege(role_name, privilege, collection_name)

        logger.info(f"✅ 部门角色 {role_name} 已创建（只能访问 {collection_name}）")


# ===== 3. 多租户权限管理 =====

class MultiTenantRBAC:
    """多租户 RBAC 管理"""

    def __init__(self, role_manager: RoleManager):
        self.role_manager = role_manager
        self.logger = logging.getLogger("MultiTenantRBAC")

    def create_tenant_role(self, tenant_id: str) -> bool:
        """为租户创建专属角色"""
        role_name = f"tenant_{tenant_id}"
        collection_name = f"tenant_{tenant_id}_docs"

        # 创建角色
        if not self.role_manager.create_role(role_name):
            return False

        # 授予权限（只能访问自己的 Collection）
        privileges = ["Search", "Query", "Insert", "Delete", "Upsert"]
        for privilege in privileges:
            self.role_manager.grant_privilege(role_name, privilege, collection_name)

        self.logger.info(f"✅ 租户 {tenant_id} 的角色已创建")
        return True

    def assign_user_to_tenant(self, user_id: str, tenant_id: str) -> bool:
        """将用户分配到租户"""
        role_name = f"tenant_{tenant_id}"
        return self.role_manager.add_user_to_role(user_id, role_name)

    def remove_user_from_tenant(self, user_id: str, tenant_id: str) -> bool:
        """从租户移除用户"""
        role_name = f"tenant_{tenant_id}"
        return self.role_manager.remove_user_from_role(user_id, role_name)


# ===== 4. 权限审计 =====

class PermissionAuditor:
    """权限审计器"""

    def __init__(self, role_manager: RoleManager):
        self.role_manager = role_manager
        self.logger = logging.getLogger("PermissionAuditor")

    def audit_user_permissions(self, username: str) -> Dict:
        """审计用户权限"""
        self.logger.info(f"\n=== 审计用户 {username} 的权限 ===")

        # 获取用户角色
        roles = self.role_manager.list_roles(username)
        self.logger.info(f"角色：{roles}")

        # 获取每个角色的权限
        all_privileges = {}
        for role in roles:
            privileges = self.role_manager.list_privileges(role)
            all_privileges[role] = privileges
            self.logger.info(f"\n角色 {role} 的权限：")
            for priv in privileges:
                self.logger.info(f"  - {priv}")

        return {
            "username": username,
            "roles": roles,
            "privileges": all_privileges,
            "audit_time": datetime.now()
        }

    def find_over_privileged_users(self, users: List[str]) -> List[str]:
        """查找权限过大的用户"""
        over_privileged = []

        for user in users:
            roles = self.role_manager.list_roles(user)
            if any(role in ["admin", "system_admin", "root"] for role in roles):
                over_privileged.append(user)

        if over_privileged:
            self.logger.warning(
                f"⚠️ 发现 {len(over_privileged)} 个高权限用户：{over_privileged}"
            )

        return over_privileged

    def audit_role_permissions(self, role_name: str) -> Dict:
        """审计角色权限"""
        self.logger.info(f"\n=== 审计角色 {role_name} 的权限 ===")

        privileges = self.role_manager.list_privileges(role_name)

        for priv in privileges:
            self.logger.info(f"  - {priv}")

        return {
            "role_name": role_name,
            "privileges": privileges,
            "audit_time": datetime.now()
        }


# ===== 5. 企业 RAG RBAC 系统 =====

class EnterpriseRAGRBAC:
    """企业 RAG 系统的 RBAC 管理"""

    def __init__(self):
        self.role_manager = RoleManager()
        self.auditor = PermissionAuditor(self.role_manager)
        self.logger = logging.getLogger("EnterpriseRAGRBAC")

    def setup_enterprise_roles(self):
        """设置企业角色"""
        self.logger.info("=== 设置企业角色 ===\n")

        # 1. 创建基础角色
        self.logger.info("1. 创建基础角色")
        RoleTemplates.create_readonly_role(self.role_manager)
        RoleTemplates.create_data_admin_role(self.role_manager)
        RoleTemplates.create_system_admin_role(self.role_manager)

        # 2. 创建部门角色
        self.logger.info("\n2. 创建部门角色")
        departments = ["hr", "finance", "rd"]
        for dept in departments:
            RoleTemplates.create_department_role(self.role_manager, dept)

        # 3. 创建客服角色（特殊权限）
        self.logger.info("\n3. 创建客服角色")
        self.role_manager.create_role("customer_service")
        self.role_manager.grant_privilege(
            "customer_service", "Search", "product_docs"
        )
        self.role_manager.grant_privilege(
            "customer_service", "Query", "faq_docs"
        )

    def assign_users_to_roles(self):
        """分配用户到角色"""
        self.logger.info("\n=== 分配用户到角色 ===\n")

        # 假设已创建这些用户
        assignments = [
            ("analyst_001", "readonly"),
            ("analyst_002", "readonly"),
            ("data_manager", "data_admin"),
            ("ops_engineer", "system_admin"),
            ("hr_employee", "hr_staff"),
            ("finance_employee", "finance_staff"),
            ("rd_employee", "rd_staff"),
            ("service_001", "customer_service")
        ]

        for username, role in assignments:
            self.role_manager.add_user_to_role(username, role)

    def audit_all_permissions(self):
        """审计所有权限"""
        self.logger.info("\n=== 审计所有权限 ===\n")

        # 审计用户权限
        users = ["analyst_001", "data_manager", "ops_engineer", "hr_employee"]
        for user in users:
            try:
                self.auditor.audit_user_permissions(user)
            except Exception as e:
                self.logger.error(f"审计用户 {user} 失败：{e}")

        # 查找高权限用户
        self.auditor.find_over_privileged_users(users)


# ===== 6. SaaS 多租户 RBAC 系统 =====

class SaaSMultiTenantRBAC:
    """SaaS 多租户 RBAC 系统"""

    def __init__(self):
        self.role_manager = RoleManager()
        self.multi_tenant = MultiTenantRBAC(self.role_manager)
        self.logger = logging.getLogger("SaaSMultiTenantRBAC")

    def onboard_tenant(self, tenant_id: str, admin_user: str):
        """租户入驻"""
        self.logger.info(f"=== 租户 {tenant_id} 入驻 ===")

        # 1. 创建租户角色
        self.multi_tenant.create_tenant_role(tenant_id)

        # 2. 分配管理员用户
        self.multi_tenant.assign_user_to_tenant(admin_user, tenant_id)

        self.logger.info(f"✅ 租户 {tenant_id} 入驻完成")

    def add_tenant_user(self, user_id: str, tenant_id: str):
        """添加租户用户"""
        self.multi_tenant.assign_user_to_tenant(user_id, tenant_id)
        self.logger.info(f"✅ 用户 {user_id} 已加入租户 {tenant_id}")

    def remove_tenant_user(self, user_id: str, tenant_id: str):
        """移除租户用户"""
        self.multi_tenant.remove_user_from_tenant(user_id, tenant_id)
        self.logger.info(f"✅ 用户 {user_id} 已从租户 {tenant_id} 移除")


# ===== 7. 主程序 =====

def main():
    """主程序"""
    print("=" * 60)
    print("Milvus RBAC 权限管理示例")
    print("=" * 60)

    # 场景1：企业 RAG 系统
    print("\n【场景1：企业 RAG 系统】")
    enterprise_rbac = EnterpriseRAGRBAC()
    enterprise_rbac.setup_enterprise_roles()
    enterprise_rbac.assign_users_to_roles()
    enterprise_rbac.audit_all_permissions()

    # 场景2：SaaS 多租户系统
    print("\n\n【场景2：SaaS 多租户系统】")
    saas_rbac = SaaSMultiTenantRBAC()

    # 租户A入驻
    saas_rbac.onboard_tenant("tenant_a", "admin_a")
    saas_rbac.add_tenant_user("user_a1", "tenant_a")
    saas_rbac.add_tenant_user("user_a2", "tenant_a")

    # 租户B入驻
    saas_rbac.onboard_tenant("tenant_b", "admin_b")
    saas_rbac.add_tenant_user("user_b1", "tenant_b")

    print("\n" + "=" * 60)
    print("RBAC 配置完成")
    print("=" * 60)


# ===== 8. 使用示例 =====

def example_usage():
    """使用示例"""

    # 示例1：创建角色管理器
    role_manager = RoleManager()

    # 示例2：创建自定义角色
    role_manager.create_role("custom_role")
    role_manager.grant_privilege("custom_role", "Search", "my_collection")
    role_manager.add_user_to_role("my_user", "custom_role")

    # 示例3：使用模板创建角色
    RoleTemplates.create_readonly_role(role_manager, "viewer")

    # 示例4：多租户管理
    multi_tenant = MultiTenantRBAC(role_manager)
    multi_tenant.create_tenant_role("company_a")
    multi_tenant.assign_user_to_tenant("user_001", "company_a")

    # 示例5：权限审计
    auditor = PermissionAuditor(role_manager)
    auditor.audit_user_permissions("user_001")


if __name__ == "__main__":
    # 运行主程序
    main()

    # 或运行示例
    # example_usage()
```

---

## 运行输出示例

```
============================================================
Milvus RBAC 权限管理示例
============================================================

【场景1：企业 RAG 系统】
=== 设置企业角色 ===

1. 创建基础角色
2025-02-10 11:00:00 - RoleManager - INFO - ✅ 角色 readonly 已创建
2025-02-10 11:00:00 - RoleManager - INFO - ✅ 已授予角色 readonly 权限：Search on *
2025-02-10 11:00:00 - RoleManager - INFO - ✅ 已授予角色 readonly 权限：Query on *
2025-02-10 11:00:01 - __main__ - INFO - ✅ 只读角色 readonly 已创建

2025-02-10 11:00:01 - RoleManager - INFO - ✅ 角色 data_admin 已创建
2025-02-10 11:00:02 - __main__ - INFO - ✅ 数据管理员角色 data_admin 已创建

2025-02-10 11:00:02 - RoleManager - INFO - ✅ 角色 system_admin 已创建
2025-02-10 11:00:03 - __main__ - INFO - ✅ 系统管理员角色 system_admin 已创建

2. 创建部门角色
2025-02-10 11:00:03 - RoleManager - INFO - ✅ 角色 hr_staff 已创建
2025-02-10 11:00:03 - __main__ - INFO - ✅ 部门角色 hr_staff 已创建（只能访问 hr_docs）
2025-02-10 11:00:04 - __main__ - INFO - ✅ 部门角色 finance_staff 已创建（只能访问 finance_docs）
2025-02-10 11:00:04 - __main__ - INFO - ✅ 部门角色 rd_staff 已创建（只能访问 rd_docs）

3. 创建客服角色
2025-02-10 11:00:05 - RoleManager - INFO - ✅ 角色 customer_service 已创建
2025-02-10 11:00:05 - RoleManager - INFO - ✅ 已授予角色 customer_service 权限：Search on product_docs

=== 分配用户到角色 ===

2025-02-10 11:00:06 - RoleManager - INFO - ✅ 用户 analyst_001 已添加到角色 readonly
2025-02-10 11:00:06 - RoleManager - INFO - ✅ 用户 data_manager 已添加到角色 data_admin
2025-02-10 11:00:07 - RoleManager - INFO - ✅ 用户 ops_engineer 已添加到角色 system_admin
2025-02-10 11:00:07 - RoleManager - INFO - ✅ 用户 hr_employee 已添加到角色 hr_staff

=== 审计所有权限 ===

=== 审计用户 analyst_001 的权限 ===
2025-02-10 11:00:08 - PermissionAuditor - INFO - 角色：['readonly']

角色 readonly 的权限：
  - Search on Collection: *
  - Query on Collection: *
  - DescribeCollection on Collection: *

=== 审计用户 ops_engineer 的权限 ===
2025-02-10 11:00:09 - PermissionAuditor - INFO - 角色：['system_admin']
2025-02-10 11:00:09 - PermissionAuditor - WARNING - ⚠️ 发现 1 个高权限用户：['ops_engineer']


【场景2：SaaS 多租户系统】
=== 租户 tenant_a 入驻 ===
2025-02-10 11:00:10 - RoleManager - INFO - ✅ 角色 tenant_tenant_a 已创建
2025-02-10 11:00:10 - MultiTenantRBAC - INFO - ✅ 租户 tenant_a 的角色已创建
2025-02-10 11:00:10 - RoleManager - INFO - ✅ 用户 admin_a 已添加到角色 tenant_tenant_a
2025-02-10 11:00:10 - SaaSMultiTenantRBAC - INFO - ✅ 租户 tenant_a 入驻完成

2025-02-10 11:00:11 - SaaSMultiTenantRBAC - INFO - ✅ 用户 user_a1 已加入租户 tenant_a
2025-02-10 11:00:11 - SaaSMultiTenantRBAC - INFO - ✅ 用户 user_a2 已加入租户 tenant_a

=== 租户 tenant_b 入驻 ===
2025-02-10 11:00:12 - SaaSMultiTenantRBAC - INFO - ✅ 租户 tenant_b 入驻完成
2025-02-10 11:00:12 - SaaSMultiTenantRBAC - INFO - ✅ 用户 user_b1 已加入租户 tenant_b

============================================================
RBAC 配置完成
============================================================
```

---

## 关键特性

### 1. 角色模板

```python
# 预定义的角色模板，快速创建常用角色
RoleTemplates.create_readonly_role(role_manager)
RoleTemplates.create_data_admin_role(role_manager)
RoleTemplates.create_system_admin_role(role_manager)
```

### 2. 多租户隔离

```python
# 每个租户独立的角色和权限
multi_tenant.create_tenant_role("tenant_a")
# tenant_a 只能访问 tenant_a_docs
```

### 3. 权限审计

```python
# 审计用户权限
auditor.audit_user_permissions("user_001")

# 查找高权限用户
auditor.find_over_privileged_users(users)
```

### 4. 部门隔离

```python
# 每个部门独立的角色
RoleTemplates.create_department_role(role_manager, "hr")
# hr_staff 只能访问 hr_docs
```

---

## 生产环境建议

### 1. 最小权限原则

```python
# ❌ 错误：给所有用户管理员权限
role_manager.add_user_to_role("analyst", "admin")

# ✅ 正确：只给必需的权限
role_manager.add_user_to_role("analyst", "readonly")
```

### 2. 定期权限审查

```python
# 每月审查用户权限
def monthly_audit():
    users = utility.list_users()
    for user in users:
        auditor.audit_user_permissions(user)
```

### 3. 权限变更日志

```python
# 记录所有权限变更
logger.info(f"权限变更：{username} 添加到角色 {role_name}")
```

---

## 小结

**本示例展示了：**

1. ✅ 完整的角色管理系统
2. ✅ 预定义角色模板
3. ✅ 多租户权限隔离
4. ✅ 权限审计和监控
5. ✅ 企业和 SaaS 场景应用

**下一步：** 学习 TLS 加密配置的实战代码
