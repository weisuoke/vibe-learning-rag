# æœ€å°å¯ç”¨

> æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½å¼€å§‹ä½¿ç”¨ Docker éƒ¨ç½² Milvus

---

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 4.1 ç†è§£ Docker Compose çš„åŸºæœ¬ç»“æ„

**ä¸€å¥è¯**ï¼šDocker Compose ä½¿ç”¨ YAML æ–‡ä»¶å®šä¹‰å¤šå®¹å™¨åº”ç”¨

**æœ€å°é…ç½®ç¤ºä¾‹**ï¼š

```yaml
version: '3.8'

services:
  milvus:
    image: milvusdb/milvus:v2.4.0
    ports:
      - "19530:19530"
```

**å…³é”®è¦ç´ **ï¼š
- `version`: Docker Compose æ–‡ä»¶ç‰ˆæœ¬
- `services`: å®šä¹‰è¦è¿è¡Œçš„å®¹å™¨
- `image`: ä½¿ç”¨çš„ Docker é•œåƒ
- `ports`: ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰

---

### 4.2 å•æœºéƒ¨ç½² Milvusï¼ˆæœ€ç®€é…ç½®ï¼‰

**åœºæ™¯**ï¼šå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

**å®Œæ•´é…ç½®**ï¼š

```yaml
version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd_data:/etcd

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data

  milvus:
    image: milvusdb/milvus:v2.4.0
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - etcd
      - minio

volumes:
  etcd_data:
  minio_data:
  milvus_data:
```

**å¯åŠ¨å‘½ä»¤**ï¼š

```bash
# 1. ä¿å­˜ä¸Šé¢çš„é…ç½®ä¸º docker-compose.yml
# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹çŠ¶æ€
docker-compose ps

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f milvus
```

---

### 4.3 éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ

**Python éªŒè¯è„šæœ¬**ï¼š

```python
from pymilvus import connections, utility

# è¿æ¥åˆ° Milvus
connections.connect(
    alias="default",
    host="localhost",
    port="19530"
)

# æ£€æŸ¥è¿æ¥
print(f"Milvus ç‰ˆæœ¬: {utility.get_server_version()}")
print("è¿æ¥æˆåŠŸï¼âœ…")

# æ–­å¼€è¿æ¥
connections.disconnect("default")
```

**é¢„æœŸè¾“å‡º**ï¼š

```
Milvus ç‰ˆæœ¬: v2.4.0
è¿æ¥æˆåŠŸï¼âœ…
```

---

### 4.4 æ•°æ®æŒä¹…åŒ–ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šä½¿ç”¨ Docker volumes æŒä¹…åŒ–æ•°æ®

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼š
- å®¹å™¨åˆ é™¤åï¼Œå®¹å™¨å†…çš„æ•°æ®ä¼šä¸¢å¤±
- volumes å°†æ•°æ®å­˜å‚¨åœ¨å®¿ä¸»æœºä¸Šï¼Œå®¹å™¨é‡å¯åæ•°æ®ä»ç„¶å­˜åœ¨

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
services:
  milvus:
    volumes:
      - milvus_data:/var/lib/milvus  # æŒä¹…åŒ– Milvus æ•°æ®

volumes:
  milvus_data:  # å®šä¹‰ volume
```

**æŸ¥çœ‹ volume ä½ç½®**ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ volumes
docker volume ls

# æŸ¥çœ‹ volume è¯¦æƒ…
docker volume inspect <volume_name>
```

---

### 4.5 å¸¸ç”¨ç®¡ç†å‘½ä»¤

**å¯åŠ¨å’Œåœæ­¢**ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™ volumesï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œ volumesï¼ˆâš ï¸ æ•°æ®ä¼šä¸¢å¤±ï¼‰
docker-compose down -v
```

**æŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—**ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs milvus

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f milvus

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose logs --tail=100 milvus
```

**é‡å¯æœåŠ¡**ï¼š

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart milvus
```

**è¿›å…¥å®¹å™¨è°ƒè¯•**ï¼š

```bash
# è¿›å…¥ Milvus å®¹å™¨
docker-compose exec milvus bash

# æŸ¥çœ‹ Milvus é…ç½®
docker-compose exec milvus cat /milvus/configs/milvus.yaml
```

---

## æœ€å°å¯ç”¨çŸ¥è¯†æ€»ç»“

æŒæ¡ä»¥ä¸Š 5 ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œä½ å°±èƒ½ï¼š

âœ… **éƒ¨ç½²å•æœº Milvus**
- ä½¿ç”¨ Docker Compose ä¸€é”®å¯åŠ¨
- åŒ…å«æ‰€æœ‰å¿…éœ€çš„ä¾èµ–ï¼ˆetcdã€MinIOï¼‰

âœ… **éªŒè¯éƒ¨ç½²**
- ä½¿ç”¨ Python å®¢æˆ·ç«¯è¿æ¥
- æ£€æŸ¥æœåŠ¡çŠ¶æ€

âœ… **æ•°æ®æŒä¹…åŒ–**
- é…ç½® volumes é˜²æ­¢æ•°æ®ä¸¢å¤±
- ç†è§£å®¹å™¨å’Œ volume çš„å…³ç³»

âœ… **æ—¥å¸¸ç®¡ç†**
- å¯åŠ¨ã€åœæ­¢ã€é‡å¯æœåŠ¡
- æŸ¥çœ‹æ—¥å¿—å’ŒçŠ¶æ€
- è¿›å…¥å®¹å™¨è°ƒè¯•

âœ… **ä¸ºç”Ÿäº§éƒ¨ç½²æ‰“åŸºç¡€**
- ç†è§£ Docker Compose é…ç½®ç»“æ„
- æŒæ¡åŸºæœ¬çš„å®¹å™¨ç®¡ç†å‘½ä»¤

---

## å¿«é€Ÿä¸Šæ‰‹æµç¨‹

```
1. åˆ›å»º docker-compose.yml
   â†“
2. docker-compose up -d
   â†“
3. éªŒè¯è¿æ¥ï¼ˆPython è„šæœ¬ï¼‰
   â†“
4. å¼€å§‹ä½¿ç”¨ Milvus
```

**æ—¶é—´æŠ•å…¥**ï¼š15-20 åˆ†é’Ÿå³å¯å®Œæˆéƒ¨ç½²å’ŒéªŒè¯

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ€å°å¯ç”¨çŸ¥è¯†åï¼Œå»ºè®®å­¦ä¹ ï¼š

1. **æ ¸å¿ƒæ¦‚å¿µ** - æ·±å…¥ç†è§£ Docker Compose é…ç½®ã€Milvus æ¶æ„ã€æ•°æ®æŒä¹…åŒ–
2. **åŒé‡ç±»æ¯”** - é€šè¿‡ç±»æ¯”åŠ æ·±ç†è§£
3. **å®æˆ˜ä»£ç ** - å­¦ä¹ åˆ†å¸ƒå¼éƒ¨ç½²å’Œç”Ÿäº§ç¯å¢ƒé…ç½®
4. **åç›´è§‰ç‚¹** - é¿å…å¸¸è§è¯¯åŒº

---

## å¸¸è§é—®é¢˜

### Q1: ç«¯å£ 19530 è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

```yaml
services:
  milvus:
    ports:
      - "19531:19530"  # ä¿®æ”¹å®¿ä¸»æœºç«¯å£
```

### Q2: å¦‚ä½•æŸ¥çœ‹ Milvus å ç”¨çš„èµ„æºï¼Ÿ

```bash
docker stats milvus
```

### Q3: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

```bash
# å¤‡ä»½ volumes
docker run --rm -v milvus_data:/data -v $(pwd):/backup \
  ubuntu tar czf /backup/milvus_backup.tar.gz /data
```

### Q4: å¦‚ä½•å‡çº§ Milvus ç‰ˆæœ¬ï¼Ÿ

```yaml
services:
  milvus:
    image: milvusdb/milvus:v2.4.1  # ä¿®æ”¹ç‰ˆæœ¬å·
```

```bash
docker-compose pull  # æ‹‰å–æ–°é•œåƒ
docker-compose up -d  # é‡å¯æœåŠ¡
```

---

## åœ¨ RAG å¼€å‘ä¸­çš„åº”ç”¨

### åœºæ™¯ï¼šå¿«é€Ÿæ­å»ºæœ¬åœ° RAG å¼€å‘ç¯å¢ƒ

```bash
# 1. å¯åŠ¨ Milvus
docker-compose up -d

# 2. ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆçº¦ 30 ç§’ï¼‰
sleep 30

# 3. è¿è¡Œ RAG åº”ç”¨
python rag_app.py
```

**ä¼˜åŠ¿**ï¼š
- 5 åˆ†é’Ÿå†…å®Œæˆç¯å¢ƒæ­å»º
- æ— éœ€æ‰‹åŠ¨å®‰è£…ä¾èµ–
- å›¢é˜Ÿæˆå‘˜ç¯å¢ƒå®Œå…¨ä¸€è‡´

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ€å°å¯ç”¨çŸ¥è¯†å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£ Docker Compose çš„åŸºæœ¬ç»“æ„
- [ ] ç¼–å†™å•æœº Milvus çš„ docker-compose.yml
- [ ] ä½¿ç”¨ docker-compose å‘½ä»¤å¯åŠ¨å’Œç®¡ç†æœåŠ¡
- [ ] ä½¿ç”¨ Python éªŒè¯ Milvus è¿æ¥
- [ ] é…ç½® volumes å®ç°æ•°æ®æŒä¹…åŒ–
- [ ] æŸ¥çœ‹æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—
- [ ] å¤„ç†å¸¸è§çš„éƒ¨ç½²é—®é¢˜

å¦‚æœä»¥ä¸Šéƒ½èƒ½åšåˆ°ï¼Œæ­å–œä½ å·²ç»æŒæ¡äº† Docker éƒ¨ç½² Milvus çš„æ ¸å¿ƒçŸ¥è¯†ï¼ğŸ‰
