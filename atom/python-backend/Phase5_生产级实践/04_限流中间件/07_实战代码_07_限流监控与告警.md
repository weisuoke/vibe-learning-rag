# 实战代码7：限流监控与告警

> 使用 Prometheus 监控限流指标并设置告警

---

## Prometheus 指标

```python
"""限流监控指标"""
from prometheus_client import Counter, Histogram, Gauge
from fastapi import FastAPI, Request
import redis

app = FastAPI()
redis_client = redis.Redis()

# 定义指标
rate_limit_requests = Counter(
    'rate_limit_requests_total',
    'Total rate limit checks',
    ['user_tier', 'endpoint', 'result']
)

rate_limit_latency = Histogram(
    'rate_limit_check_duration_seconds',
    'Rate limit check latency',
    ['user_tier']
)

rate_limit_usage = Gauge(
    'rate_limit_usage_ratio',
    'Rate limit usage ratio',
    ['user_tier']
)

rate_limit_rejections = Counter(
    'rate_limit_rejections_total',
    'Total rejected requests',
    ['user_tier', 'endpoint', 'reason']
)
```

---

## 带监控的限流

```python
"""带监控的限流依赖"""

async def rate_limit_with_metrics(request: Request):
    user_id = request.headers.get("X-User-ID", "anonymous")
    user_tier = request.headers.get("X-User-Tier", "free")
    endpoint = request.url.path

    limiter = RedisTokenBucket(
        redis_client, f"user:{user_id}:rate_limit",
        rate=10, capacity=100
    )

    # 记录延迟
    with rate_limit_latency.labels(user_tier).time():
        try:
            if not limiter.acquire():
                # 记录被拒绝的请求
                rate_limit_requests.labels(user_tier, endpoint, 'rejected').inc()
                rate_limit_rejections.labels(user_tier, endpoint, 'quota_exceeded').inc()

                raise HTTPException(status_code=429, detail="Rate limit exceeded")

            # 记录通过的请求
            rate_limit_requests.labels(user_tier, endpoint, 'allowed').inc()

            # 更新使用率
            status = limiter.get_status()
            usage_ratio = (limiter.capacity - status["tokens"]) / limiter.capacity
            rate_limit_usage.labels(user_tier).set(usage_ratio)

            # 告警：使用率超过80%
            if usage_ratio > 0.8:
                logger.warning(
                    f"High rate limit usage",
                    extra={
                        "user_id": user_id,
                        "user_tier": user_tier,
                        "usage_ratio": usage_ratio
                    }
                )

        except Exception as e:
            rate_limit_rejections.labels(user_tier, endpoint, 'error').inc()
            raise

@app.post("/chat")
async def chat(message: str, _: None = Depends(rate_limit_with_metrics)):
    return {"response": f"Echo: {message}"}
```

---

## Prometheus 端点

```python
"""暴露 Prometheus 指标"""
from prometheus_client import generate_latest, CONTENT_TYPE_LATEST
from fastapi.responses import Response

@app.get("/metrics")
async def metrics():
    return Response(
        content=generate_latest(),
        media_type=CONTENT_TYPE_LATEST
    )
```

---

## Grafana Dashboard

```json
{
  "dashboard": {
    "title": "Rate Limiting Metrics",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(rate_limit_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Rejection Rate",
        "targets": [
          {
            "expr": "rate(rate_limit_rejections_total[5m])"
          }
        ]
      },
      {
        "title": "Usage Ratio",
        "targets": [
          {
            "expr": "rate_limit_usage_ratio"
          }
        ]
      },
      {
        "title": "Latency",
        "targets": [
          {
            "expr": "rate_limit_check_duration_seconds"
          }
        ]
      }
    ]
  }
}
```

---

## 告警规则

```yaml
# prometheus_alerts.yml
groups:
  - name: rate_limiting
    rules:
      - alert: HighRateLimitUsage
        expr: rate_limit_usage_ratio > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate limit usage for {{ $labels.user_tier }}"
          description: "Usage ratio is {{ $value }}"

      - alert: HighRejectionRate
        expr: rate(rate_limit_rejections_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High rejection rate for {{ $labels.user_tier }}"
          description: "Rejection rate is {{ $value }} req/s"
```

---

**记住：** 监控限流指标对于生产环境至关重要，可以及时发现问题并调整策略。
