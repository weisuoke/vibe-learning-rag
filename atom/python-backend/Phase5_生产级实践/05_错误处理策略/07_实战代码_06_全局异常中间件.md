# 实战代码6：全局异常中间件

**场景：** 实现 FastAPI 全局异常处理器和中间件

---

## 完整代码

```python
"""
全局异常中间件
统一错误响应格式、Request ID 追踪、环境感知错误详情
"""

import uuid
import traceback
import os
from datetime import datetime
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse
from starlette.middleware.base import BaseHTTPMiddleware
import structlog

logger = structlog.get_logger()

# ===== Request ID 中间件 =====
class RequestIDMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        request_id = request.headers.get("X-Request-ID", str(uuid.uuid4()))
        request.state.request_id = request_id

        response = await call_next(request)
        response.headers["X-Request-ID"] = request_id
        return response

# ===== 全局异常处理器 =====
app = FastAPI()
app.add_middleware(RequestIDMiddleware)

@app.exception_handler(Exception)
async def global_error_handler(request: Request, exc: Exception):
    request_id = getattr(request.state, "request_id", str(uuid.uuid4()))

    # 收集错误上下文
    error_context = {
        "request_id": request_id,
        "timestamp": datetime.utcnow().isoformat(),
        "path": request.url.path,
        "method": request.method,
        "error_type": type(exc).__name__,
        "error_message": str(exc),
    }

    # 记录错误日志
    logger.error("unhandled_exception", **error_context)

    # 开发环境：返回详细错误
    if os.getenv("ENVIRONMENT") == "development":
        return JSONResponse(
            status_code=500,
            content={
                "error": str(exc),
                "type": type(exc).__name__,
                "traceback": traceback.format_exc(),
                "request_id": request_id
            }
        )

    # 生产环境：返回友好提示
    return JSONResponse(
        status_code=500,
        content={
            "error": "服务器内部错误",
            "request_id": request_id
        }
    )

# ===== 使用示例 =====
@app.post("/chat")
async def chat(message: str):
    if len(message) > 2000:
        raise ValueError("文本过长")

    response = await call_llm(message)
    return {"response": response}
```

---

## 运行输出

```bash
# 开发环境
ENVIRONMENT=development uvicorn main:app

# 错误响应：
{
  "error": "文本过长",
  "type": "ValueError",
  "traceback": "Traceback...",
  "request_id": "abc-123"
}

# 生产环境
ENVIRONMENT=production uvicorn main:app

# 错误响应：
{
  "error": "服务器内部错误",
  "request_id": "abc-123"
}
```
