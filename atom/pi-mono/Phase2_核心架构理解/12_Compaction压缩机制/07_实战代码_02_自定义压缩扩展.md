# å®æˆ˜ä»£ç  02ï¼šè‡ªå®šä¹‰å‹ç¼©æ‰©å±•

> **ç›®æ ‡**ï¼šé€šè¿‡å®Œæ•´çš„ Extension ç¤ºä¾‹å­¦ä¹ å¦‚ä½•å®ç°è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å®Œæ•´å¯è¿è¡Œçš„è‡ªå®šä¹‰å‹ç¼©æ‰©å±•ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ï¼š
1. ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹ï¼ˆGemini Flashï¼‰é™ä½æˆæœ¬
2. è‡ªå®šä¹‰å‹ç¼©æç¤ºè¯
3. å®ç°ä»»åŠ¡å¯¼å‘çš„å‹ç¼©
4. å®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘

**å‰ç½®è¦æ±‚ï¼š**
- Pi-mono å·²å®‰è£…
- ç†è§£ Extension åŸºç¡€
- ç†è§£ Compaction æœºåˆ¶

---

## ç¤ºä¾‹ 1ï¼šæˆæœ¬ä¼˜åŒ–æ‰©å±•ï¼ˆGemini Flashï¼‰

### å®Œæ•´æ‰©å±•ä»£ç 

```typescript
/**
 * .pi/extensions/cost-optimized-compaction.ts
 * ä½¿ç”¨ Gemini Flash 2.0 è¿›è¡Œå‹ç¼©ï¼Œé™ä½æˆæœ¬ 99%
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const costOptimizedCompactionExtension: Extension = {
  name: 'cost-optimized-compaction',
  description: 'ä½¿ç”¨ Gemini Flash è¿›è¡Œå‹ç¼©ï¼Œå¤§å¹…é™ä½æˆæœ¬',

  async onLoad(context) {
    console.log('âœ… Cost-Optimized Compaction å·²åŠ è½½');
    console.log('ğŸ’° ä½¿ç”¨ Gemini Flash 2.0 è¿›è¡Œå‹ç¼©ï¼ˆèŠ‚çœ 99% æˆæœ¬ï¼‰');

    let compactionCount = 0;
    let totalSavings = 0;

    // ç›‘å¬å‹ç¼©å‰äº‹ä»¶
    context.session.on('session_before_compact', async (event) => {
      compactionCount++;

      console.log(`\nğŸ”„ ç¬¬ ${compactionCount} æ¬¡å‹ç¼©`);

      // è®¡ç®—ä½¿ç”¨ Claude Opus 4 çš„æˆæœ¬
      const opusCost = calculateCompactionCost('claude-opus-4', event.contextTokens);

      // ä½¿ç”¨ Gemini Flash 2.0
      event.customModel = 'gemini-flash-2.0';

      // è®¡ç®—ä½¿ç”¨ Gemini Flash çš„æˆæœ¬
      const flashCost = calculateCompactionCost('gemini-flash-2.0', event.contextTokens);

      // è®¡ç®—èŠ‚çœ
      const savings = opusCost - flashCost;
      totalSavings += savings;

      console.log(`ğŸ’° æˆæœ¬å¯¹æ¯”:`);
      console.log(`   Claude Opus 4: $${opusCost.toFixed(4)}`);
      console.log(`   Gemini Flash:  $${flashCost.toFixed(4)}`);
      console.log(`   èŠ‚çœ: $${savings.toFixed(4)} (${((savings / opusCost) * 100).toFixed(1)}%)`);
      console.log(`   ç´¯è®¡èŠ‚çœ: $${totalSavings.toFixed(4)}`);
    });
  },
};

/**
 * è®¡ç®—å‹ç¼©æˆæœ¬
 */
function calculateCompactionCost(model: string, contextTokens: number): number {
  // ä¼°ç®—å‹ç¼©è¾“å…¥å’Œè¾“å‡º tokens
  const inputTokens = contextTokens;
  const outputTokens = Math.floor(contextTokens * 0.05); // å‡è®¾å‹ç¼©åˆ° 5%

  // æ¨¡å‹å®šä»·ï¼ˆ$/1M tokensï¼‰
  const pricing: Record<string, { input: number; output: number }> = {
    'claude-opus-4': { input: 15, output: 75 },
    'claude-sonnet-4': { input: 3, output: 15 },
    'gemini-flash-2.0': { input: 0.075, output: 0.30 },
  };

  const modelPricing = pricing[model] || pricing['claude-opus-4'];

  const inputCost = (inputTokens / 1000000) * modelPricing.input;
  const outputCost = (outputTokens / 1000000) * modelPricing.output;

  return inputCost + outputCost;
}
```

### ä½¿ç”¨æ‰©å±•

```bash
# 1. åˆ›å»ºæ‰©å±•æ–‡ä»¶
mkdir -p .pi/extensions
cat > .pi/extensions/cost-optimized-compaction.ts << 'EOF'
[ä¸Šé¢çš„ä»£ç ]
EOF

# 2. é…ç½® Gemini API Key
export GOOGLE_API_KEY=your_gemini_api_key

# 3. é‡æ–°åŠ è½½æ‰©å±•
pi
/reload

# 4. è¿›è¡Œå¯¹è¯ï¼Œè§‚å¯Ÿå‹ç¼©æˆæœ¬
# æ¯æ¬¡å‹ç¼©ä¼šæ˜¾ç¤ºæˆæœ¬å¯¹æ¯”å’ŒèŠ‚çœé‡‘é¢
```

---

## ç¤ºä¾‹ 2ï¼šä»»åŠ¡å¯¼å‘å‹ç¼©æ‰©å±•

### å®Œæ•´æ‰©å±•ä»£ç 

```typescript
/**
 * .pi/extensions/task-oriented-compaction.ts
 * ä»»åŠ¡å¯¼å‘çš„å‹ç¼©ï¼Œå¼ºè°ƒä»»åŠ¡å®Œæˆæƒ…å†µ
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const taskOrientedCompactionExtension: Extension = {
  name: 'task-oriented-compaction',
  description: 'ä»»åŠ¡å¯¼å‘çš„å‹ç¼©ç­–ç•¥',

  async onLoad(context) {
    console.log('âœ… Task-Oriented Compaction å·²åŠ è½½');

    context.session.on('session_before_compact', async (event) => {
      console.log('\nğŸ“‹ ä½¿ç”¨ä»»åŠ¡å¯¼å‘å‹ç¼©ç­–ç•¥');

      // è‡ªå®šä¹‰æç¤ºè¯
      event.customPrompt = generateTaskOrientedPrompt();

      // ä½¿ç”¨ Claude Sonnet 4ï¼ˆå¹³è¡¡è´¨é‡å’Œæˆæœ¬ï¼‰
      event.customModel = 'claude-sonnet-4';
    });
  },
};

/**
 * ç”Ÿæˆä»»åŠ¡å¯¼å‘çš„å‹ç¼©æç¤ºè¯
 */
function generateTaskOrientedPrompt(): string {
  return `
è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯ï¼Œé‡‡ç”¨ä»»åŠ¡å¯¼å‘çš„æ ¼å¼ï¼š

## æŒ‡å¯¼åŸåˆ™
1. é‡ç‚¹å…³æ³¨**å·²å®Œæˆçš„ä»»åŠ¡**å’Œ**å¾…åŠäº‹é¡¹**
2. è®°å½•**æŠ€æœ¯å†³ç­–**åŠå…¶**åŸå› **
3. åˆ—å‡º**é‡åˆ°çš„é—®é¢˜**å’Œ**è§£å†³æ–¹æ¡ˆ**
4. è¿½è¸ª**æ–‡ä»¶æ“ä½œ**ï¼ˆè¯»å–å’Œä¿®æ”¹ï¼‰

## è¾“å‡ºæ ¼å¼

### Summary
[1-2 æ®µè¯çš„é«˜å±‚æ¬¡æ¦‚è¿°ï¼Œè¯´æ˜å¯¹è¯çš„ä¸»è¦ç›®æ ‡å’Œè¿›å±•]

### Completed Tasks
- âœ… [ä»»åŠ¡ 1]ï¼š[ç®€è¦è¯´æ˜]
- âœ… [ä»»åŠ¡ 2]ï¼š[ç®€è¦è¯´æ˜]
- âœ… [ä»»åŠ¡ 3]ï¼š[ç®€è¦è¯´æ˜]

### Technical Decisions
- **[å†³ç­– 1]**ï¼š[åŸå› å’Œå½±å“]
- **[å†³ç­– 2]**ï¼š[åŸå› å’Œå½±å“]

### Problems & Solutions
- **é—®é¢˜**ï¼š[é—®é¢˜æè¿°]
  - **è§£å†³æ–¹æ¡ˆ**ï¼š[å¦‚ä½•è§£å†³]
- **é—®é¢˜**ï¼š[é—®é¢˜æè¿°]
  - **è§£å†³æ–¹æ¡ˆ**ï¼š[å¦‚ä½•è§£å†³]

### Files
- **Read**: [æ–‡ä»¶åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”]
- **Modified**: [æ–‡ä»¶åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”]

### Next Steps
- [ ] [å¾…åŠäº‹é¡¹ 1]
- [ ] [å¾…åŠäº‹é¡¹ 2]
- [ ] [å¾…åŠäº‹é¡¹ 3]

## æ³¨æ„äº‹é¡¹
- ä½¿ç”¨æ¸…æ™°çš„ Markdown æ ¼å¼
- ä¿æŒç®€æ´ï¼Œé¿å…å†—é•¿æè¿°
- é‡ç‚¹å…³æ³¨å¯æ“ä½œçš„ä¿¡æ¯
  `;
}
```

---

## ç¤ºä¾‹ 3ï¼šæ™ºèƒ½æ¨¡å‹é€‰æ‹©æ‰©å±•

### å®Œæ•´æ‰©å±•ä»£ç 

```typescript
/**
 * .pi/extensions/smart-model-selection.ts
 * æ ¹æ®å¯¹è¯å¤æ‚åº¦æ™ºèƒ½é€‰æ‹©å‹ç¼©æ¨¡å‹
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const smartModelSelectionExtension: Extension = {
  name: 'smart-model-selection',
  description: 'æ ¹æ®å¯¹è¯å¤æ‚åº¦æ™ºèƒ½é€‰æ‹©å‹ç¼©æ¨¡å‹',

  async onLoad(context) {
    console.log('âœ… Smart Model Selection å·²åŠ è½½');

    context.session.on('session_before_compact', async (event) => {
      // åˆ†æå¯¹è¯å¤æ‚åº¦
      const complexity = analyzeComplexity(event.messages);

      // æ ¹æ®å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
      const selectedModel = selectModel(complexity);

      event.customModel = selectedModel.name;

      console.log(`\nğŸ§  æ™ºèƒ½æ¨¡å‹é€‰æ‹©`);
      console.log(`   å¤æ‚åº¦: ${(complexity * 100).toFixed(1)}%`);
      console.log(`   é€‰æ‹©æ¨¡å‹: ${selectedModel.name}`);
      console.log(`   åŸå› : ${selectedModel.reason}`);
    });
  },
};

/**
 * åˆ†æå¯¹è¯å¤æ‚åº¦
 */
function analyzeComplexity(messages: any[]): number {
  let complexity = 0;
  let totalScore = 0;
  let factors = 0;

  // å› ç´  1ï¼šä»£ç å—æ•°é‡
  let codeBlockCount = 0;
  for (const message of messages) {
    const content = message.content || '';
    const blocks = (content.match(/```/g) || []).length / 2;
    codeBlockCount += blocks;
  }
  const codeScore = Math.min(codeBlockCount / 20, 1.0); // 20+ ä»£ç å— = é«˜å¤æ‚åº¦
  totalScore += codeScore;
  factors++;

  // å› ç´  2ï¼šå·¥å…·è°ƒç”¨æ•°é‡
  let toolCallCount = 0;
  for (const message of messages) {
    if (message.tool_calls) {
      toolCallCount += message.tool_calls.length;
    }
  }
  const toolScore = Math.min(toolCallCount / 50, 1.0); // 50+ å·¥å…·è°ƒç”¨ = é«˜å¤æ‚åº¦
  totalScore += toolScore;
  factors++;

  // å› ç´  3ï¼šæ¶ˆæ¯é•¿åº¦
  let totalLength = 0;
  for (const message of messages) {
    totalLength += (message.content || '').length;
  }
  const lengthScore = Math.min(totalLength / 100000, 1.0); // 100K+ å­—ç¬¦ = é«˜å¤æ‚åº¦
  totalScore += lengthScore;
  factors++;

  // å› ç´  4ï¼šè®¨è®ºæ·±åº¦ï¼ˆå›åˆæ•°ï¼‰
  const turnCount = messages.filter(m => m.role === 'user').length;
  const turnScore = Math.min(turnCount / 50, 1.0); // 50+ å›åˆ = é«˜å¤æ‚åº¦
  totalScore += turnScore;
  factors++;

  // è®¡ç®—å¹³å‡å¤æ‚åº¦
  complexity = totalScore / factors;

  return complexity;
}

/**
 * æ ¹æ®å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
 */
function selectModel(complexity: number): { name: string; reason: string } {
  if (complexity > 0.7) {
    return {
      name: 'claude-opus-4',
      reason: 'é«˜å¤æ‚åº¦å¯¹è¯ï¼Œéœ€è¦æœ€ä½³ç†è§£èƒ½åŠ›',
    };
  } else if (complexity > 0.4) {
    return {
      name: 'claude-sonnet-4',
      reason: 'ä¸­ç­‰å¤æ‚åº¦ï¼Œå¹³è¡¡è´¨é‡å’Œæˆæœ¬',
    };
  } else {
    return {
      name: 'gemini-flash-2.0',
      reason: 'ä½å¤æ‚åº¦ï¼Œä¼˜å…ˆæˆæœ¬ä¼˜åŒ–',
    };
  }
}
```

---

## ç¤ºä¾‹ 4ï¼šä»£ç å®¡æŸ¥å‹ç¼©æ‰©å±•

### å®Œæ•´æ‰©å±•ä»£ç 

```typescript
/**
 * .pi/extensions/code-review-compaction.ts
 * ä»£ç å®¡æŸ¥åœºæ™¯çš„ä¸“ç”¨å‹ç¼©ç­–ç•¥
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const codeReviewCompactionExtension: Extension = {
  name: 'code-review-compaction',
  description: 'ä»£ç å®¡æŸ¥åœºæ™¯çš„ä¸“ç”¨å‹ç¼©',

  async onLoad(context) {
    console.log('âœ… Code Review Compaction å·²åŠ è½½');

    context.session.on('session_before_compact', async (event) => {
      // æ£€æµ‹æ˜¯å¦æ˜¯ä»£ç å®¡æŸ¥åœºæ™¯
      const isCodeReview = detectCodeReview(event.messages);

      if (isCodeReview) {
        console.log('\nğŸ” æ£€æµ‹åˆ°ä»£ç å®¡æŸ¥åœºæ™¯ï¼Œä½¿ç”¨ä¸“ç”¨å‹ç¼©ç­–ç•¥');

        event.customPrompt = generateCodeReviewPrompt();
        event.customModel = 'claude-sonnet-4';
      }
    });
  },
};

/**
 * æ£€æµ‹æ˜¯å¦æ˜¯ä»£ç å®¡æŸ¥åœºæ™¯
 */
function detectCodeReview(messages: any[]): boolean {
  const keywords = [
    'review',
    'code review',
    'ä»£ç å®¡æŸ¥',
    'pull request',
    'pr',
    'feedback',
    'suggestion',
    'improvement',
  ];

  // æ£€æŸ¥æœ€è¿‘ 10 æ¡æ¶ˆæ¯
  const recentMessages = messages.slice(-10);

  for (const message of recentMessages) {
    const content = (message.content || '').toLowerCase();
    if (keywords.some(keyword => content.includes(keyword))) {
      return true;
    }
  }

  return false;
}

/**
 * ç”Ÿæˆä»£ç å®¡æŸ¥å‹ç¼©æç¤ºè¯
 */
function generateCodeReviewPrompt(): string {
  return `
è¯·æ€»ç»“ä»¥ä¸‹ä»£ç å®¡æŸ¥å¯¹è¯ï¼š

## è¾“å‡ºæ ¼å¼

### Files Reviewed
[åˆ—å‡ºæ‰€æœ‰å®¡æŸ¥çš„æ–‡ä»¶]

### Issues Found

#### Critical (P0)
- **[æ–‡ä»¶:è¡Œå·]**: [é—®é¢˜æè¿°]
  - **Impact**: [å½±å“]
  - **Suggestion**: [ä¿®å¤å»ºè®®]

#### Major (P1)
- **[æ–‡ä»¶:è¡Œå·]**: [é—®é¢˜æè¿°]
  - **Impact**: [å½±å“]
  - **Suggestion**: [ä¿®å¤å»ºè®®]

#### Minor (P2)
- **[æ–‡ä»¶:è¡Œå·]**: [é—®é¢˜æè¿°]
  - **Suggestion**: [ä¿®å¤å»ºè®®]

### Positive Feedback
- [åšå¾—å¥½çš„åœ°æ–¹ 1]
- [åšå¾—å¥½çš„åœ°æ–¹ 2]

### Fixes Applied
- âœ… [å·²ä¿®å¤çš„é—®é¢˜ 1]
- âœ… [å·²ä¿®å¤çš„é—®é¢˜ 2]

### Pending Actions
- [ ] [å¾…å¤„ç†çš„é—®é¢˜ 1]
- [ ] [å¾…å¤„ç†çš„é—®é¢˜ 2]

## æ³¨æ„äº‹é¡¹
- æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»é—®é¢˜
- åŒ…å«å…·ä½“çš„æ–‡ä»¶å’Œè¡Œå·
- æä¾›å¯æ“ä½œçš„ä¿®å¤å»ºè®®
  `;
}
```

---

## ç¤ºä¾‹ 5ï¼šå®Œå…¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘

### å®Œæ•´æ‰©å±•ä»£ç 

```typescript
/**
 * .pi/extensions/custom-compression-logic.ts
 * å®Œå…¨è‡ªå®šä¹‰çš„å‹ç¼©é€»è¾‘ï¼ˆä¸ä½¿ç”¨ LLMï¼‰
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const customCompressionLogicExtension: Extension = {
  name: 'custom-compression-logic',
  description: 'å®Œå…¨è‡ªå®šä¹‰çš„å‹ç¼©é€»è¾‘',

  async onLoad(context) {
    console.log('âœ… Custom Compression Logic å·²åŠ è½½');

    context.session.on('session_before_compact', async (event) => {
      console.log('\nğŸ”§ ä½¿ç”¨è‡ªå®šä¹‰å‹ç¼©é€»è¾‘');

      // æå–å…³é”®ä¿¡æ¯
      const summary = extractKeyInformation(event.messages);

      // æ›¿æ¢é»˜è®¤å‹ç¼©ç»“æœ
      event.replacement = [
        {
          role: 'summary',
          content: summary,
        },
      ];

      console.log('âœ… è‡ªå®šä¹‰å‹ç¼©å®Œæˆ');
    });
  },
};

/**
 * æå–å…³é”®ä¿¡æ¯ï¼ˆè§„åˆ™basedï¼‰
 */
function extractKeyInformation(messages: any[]): string {
  const stats = {
    totalMessages: messages.length,
    userMessages: 0,
    assistantMessages: 0,
    toolCalls: 0,
    codeBlocks: 0,
    filesRead: new Set<string>(),
    filesModified: new Set<string>(),
    keyTopics: new Set<string>(),
  };

  // åˆ†ææ¶ˆæ¯
  for (const message of messages) {
    if (message.role === 'user') {
      stats.userMessages++;
    } else if (message.role === 'assistant') {
      stats.assistantMessages++;
    }

    if (message.tool_calls) {
      stats.toolCalls += message.tool_calls.length;

      // æå–æ–‡ä»¶æ“ä½œ
      for (const toolCall of message.tool_calls) {
        const args = JSON.parse(toolCall.function.arguments || '{}');

        if (toolCall.function.name === 'read_file') {
          stats.filesRead.add(args.file_path);
        } else if (toolCall.function.name === 'write_file' ||
                   toolCall.function.name === 'edit_file') {
          stats.filesModified.add(args.file_path);
        }
      }
    }

    // ç»Ÿè®¡ä»£ç å—
    const content = message.content || '';
    const blocks = (content.match(/```/g) || []).length / 2;
    stats.codeBlocks += blocks;

    // æå–å…³é”®ä¸»é¢˜ï¼ˆç®€å•å…³é”®è¯åŒ¹é…ï¼‰
    const keywords = [
      'implement', 'fix', 'refactor', 'test', 'debug',
      'optimize', 'review', 'deploy', 'configure',
    ];

    for (const keyword of keywords) {
      if (content.toLowerCase().includes(keyword)) {
        stats.keyTopics.add(keyword);
      }
    }
  }

  // ç”Ÿæˆæ‘˜è¦
  const summary = `
## Custom Summary (Rule-Based)

### Statistics
- Total Messages: ${stats.totalMessages}
- User Messages: ${stats.userMessages}
- Assistant Messages: ${stats.assistantMessages}
- Tool Calls: ${stats.toolCalls}
- Code Blocks: ${stats.codeBlocks}

### Key Topics
${Array.from(stats.keyTopics).map(topic => `- ${topic}`).join('\n')}

### Files
- **Read** (${stats.filesRead.size}): ${Array.from(stats.filesRead).join(', ') || 'None'}
- **Modified** (${stats.filesModified.size}): ${Array.from(stats.filesModified).join(', ') || 'None'}

### Summary
This conversation involved ${stats.userMessages} user requests and ${stats.assistantMessages} assistant responses, with ${stats.toolCalls} tool calls and ${stats.codeBlocks} code blocks. Key activities: ${Array.from(stats.keyTopics).join(', ')}.
  `.trim();

  return summary;
}
```

---

## ç¤ºä¾‹ 6ï¼šç»„åˆå¤šä¸ªæ‰©å±•

### æ‰©å±•ç®¡ç†å™¨

```typescript
/**
 * .pi/extensions/compaction-manager.ts
 * ç®¡ç†å¤šä¸ªå‹ç¼©æ‰©å±•ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©
 */

import { Extension } from '@mariozechner/pi-agent-core';

export const compactionManagerExtension: Extension = {
  name: 'compaction-manager',
  description: 'æ™ºèƒ½ç®¡ç†å¤šä¸ªå‹ç¼©ç­–ç•¥',

  async onLoad(context) {
    console.log('âœ… Compaction Manager å·²åŠ è½½');

    context.session.on('session_before_compact', async (event) => {
      // æ£€æµ‹åœºæ™¯
      const scenario = detectScenario(event.messages);

      console.log(`\nğŸ¯ æ£€æµ‹åˆ°åœºæ™¯: ${scenario.name}`);
      console.log(`   ç­–ç•¥: ${scenario.strategy}`);

      // æ ¹æ®åœºæ™¯åº”ç”¨ç­–ç•¥
      applyStrategy(scenario.strategy, event);
    });
  },
};

/**
 * æ£€æµ‹åœºæ™¯
 */
function detectScenario(messages: any[]): { name: string; strategy: string } {
  const recentContent = messages.slice(-10)
    .map(m => (m.content || '').toLowerCase())
    .join(' ');

  // ä»£ç å®¡æŸ¥
  if (recentContent.includes('review') || recentContent.includes('pr')) {
    return { name: 'Code Review', strategy: 'code-review' };
  }

  // è°ƒè¯•
  if (recentContent.includes('debug') || recentContent.includes('error')) {
    return { name: 'Debugging', strategy: 'debugging' };
  }

  // å®ç°åŠŸèƒ½
  if (recentContent.includes('implement') || recentContent.includes('feature')) {
    return { name: 'Feature Implementation', strategy: 'task-oriented' };
  }

  // é»˜è®¤
  return { name: 'General', strategy: 'cost-optimized' };
}

/**
 * åº”ç”¨ç­–ç•¥
 */
function applyStrategy(strategy: string, event: any) {
  switch (strategy) {
    case 'code-review':
      event.customModel = 'claude-sonnet-4';
      event.customPrompt = generateCodeReviewPrompt();
      break;

    case 'debugging':
      event.customModel = 'claude-opus-4'; // éœ€è¦æœ€ä½³ç†è§£èƒ½åŠ›
      event.customPrompt = generateDebuggingPrompt();
      break;

    case 'task-oriented':
      event.customModel = 'claude-sonnet-4';
      event.customPrompt = generateTaskOrientedPrompt();
      break;

    case 'cost-optimized':
    default:
      event.customModel = 'gemini-flash-2.0';
      // ä½¿ç”¨é»˜è®¤æç¤ºè¯
      break;
  }
}

function generateCodeReviewPrompt(): string {
  return `[ä»£ç å®¡æŸ¥æç¤ºè¯]`;
}

function generateDebuggingPrompt(): string {
  return `
è¯·æ€»ç»“ä»¥ä¸‹è°ƒè¯•å¯¹è¯ï¼š

## è¾“å‡ºæ ¼å¼

### Problem
[é—®é¢˜æè¿°]

### Investigation Steps
1. [æ­¥éª¤ 1]
2. [æ­¥éª¤ 2]

### Root Cause
[æ ¹æœ¬åŸå› ]

### Solution
[è§£å†³æ–¹æ¡ˆ]

### Files
- Read: [æ–‡ä»¶åˆ—è¡¨]
- Modified: [æ–‡ä»¶åˆ—è¡¨]
  `;
}

function generateTaskOrientedPrompt(): string {
  return `[ä»»åŠ¡å¯¼å‘æç¤ºè¯]`;
}
```

---

## ä½¿ç”¨å»ºè®®

### é€‰æ‹©åˆé€‚çš„æ‰©å±•

| åœºæ™¯ | æ¨èæ‰©å±• | åŸå›  |
|------|---------|------|
| **æˆæœ¬æ•æ„Ÿ** | cost-optimized-compaction | èŠ‚çœ 99% æˆæœ¬ |
| **ä»»åŠ¡ç®¡ç†** | task-oriented-compaction | æ¸…æ™°çš„ä»»åŠ¡è¿½è¸ª |
| **ä»£ç å®¡æŸ¥** | code-review-compaction | ä¸“é—¨çš„å®¡æŸ¥æ ¼å¼ |
| **å¤æ‚é¡¹ç›®** | smart-model-selection | è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹ |
| **è‡ªå®šä¹‰éœ€æ±‚** | custom-compression-logic | å®Œå…¨æ§åˆ¶ |
| **å¤šåœºæ™¯** | compaction-manager | æ™ºèƒ½åœºæ™¯è¯†åˆ« |

### ç»„åˆä½¿ç”¨

```bash
# åŒæ—¶åŠ è½½å¤šä¸ªæ‰©å±•
# .pi/extensions/index.ts

export { costOptimizedCompactionExtension } from './cost-optimized-compaction';
export { taskOrientedCompactionExtension } from './task-oriented-compaction';
export { smartModelSelectionExtension } from './smart-model-selection';

# Pi ä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰å¯¼å‡ºçš„æ‰©å±•
```

---

## æ€»ç»“

**æœ¬æ–‡æ¡£æä¾›çš„æ‰©å±•ç¤ºä¾‹ï¼š**

1. **æˆæœ¬ä¼˜åŒ–æ‰©å±•**ï¼šä½¿ç”¨ Gemini Flash é™ä½æˆæœ¬
2. **ä»»åŠ¡å¯¼å‘æ‰©å±•**ï¼šå¼ºè°ƒä»»åŠ¡å®Œæˆæƒ…å†µ
3. **æ™ºèƒ½æ¨¡å‹é€‰æ‹©**ï¼šæ ¹æ®å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
4. **ä»£ç å®¡æŸ¥æ‰©å±•**ï¼šä¸“é—¨çš„å®¡æŸ¥æ ¼å¼
5. **è‡ªå®šä¹‰é€»è¾‘**ï¼šå®Œå…¨è‡ªå®šä¹‰å‹ç¼©
6. **æ‰©å±•ç®¡ç†å™¨**ï¼šæ™ºèƒ½åœºæ™¯è¯†åˆ«

**å…³é”®è¦ç‚¹ï¼š**
- Extension æä¾›äº†å¼ºå¤§çš„å®šåˆ¶èƒ½åŠ›
- å¯ä»¥ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹å¤§å¹…é™ä½æˆæœ¬
- è‡ªå®šä¹‰æç¤ºè¯å¯ä»¥ä¼˜åŒ–æ‘˜è¦è´¨é‡
- å¯ä»¥æ ¹æ®åœºæ™¯é€‰æ‹©ä¸åŒç­–ç•¥

---

**ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š**
- **å®æˆ˜ä»£ç  03**ï¼šå‹ç¼©ç›‘æ§ä¸è°ƒè¯•ï¼ˆ07_å®æˆ˜ä»£ç _03_å‹ç¼©ç›‘æ§ä¸è°ƒè¯•.mdï¼‰
- **å®æˆ˜ä»£ç  04**ï¼šåˆ†æ”¯æ€»ç»“å®ç°ï¼ˆ07_å®æˆ˜ä»£ç _04_åˆ†æ”¯æ€»ç»“å®ç°.mdï¼‰

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-20
**ç»´æŠ¤è€…ï¼š** Claude Code
