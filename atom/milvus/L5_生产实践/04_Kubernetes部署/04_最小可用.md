# 最小可用

掌握以下内容，就能开始在Kubernetes上部署和管理Milvus集群：

## 4.1 安装Helm（包管理工具）

**Helm是Kubernetes的包管理器，类似npm之于Node.js**

```bash
# macOS安装
brew install helm

# Linux安装
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# 验证安装
helm version
# version.BuildInfo{Version:"v3.14.0", ...}
```

**为什么需要Helm？**
- 一条命令部署复杂应用（Milvus有8个组件）
- 配置模板化（不同环境复用配置）
- 版本管理（升级、回滚）

---

## 4.2 使用Helm部署Milvus（最快方式）

**3条命令完成部署：**

```bash
# 1. 添加Milvus Helm仓库
helm repo add milvus https://zilliztech.github.io/milvus-helm/
helm repo update

# 2. 部署Milvus（默认配置）
helm install my-milvus milvus/milvus

# 3. 等待所有Pod就绪（2-5分钟）
kubectl get pods -w
# NAME                                  READY   STATUS    RESTARTS   AGE
# my-milvus-proxy-xxx                   1/1     Running   0          2m
# my-milvus-rootcoord-xxx               1/1     Running   0          2m
# my-milvus-querynode-xxx               1/1     Running   0          2m
# ...
```

**验证部署：**

```bash
# 端口转发到本地
kubectl port-forward service/my-milvus 19530:19530

# Python连接测试
python3 << EOF
from pymilvus import connections
connections.connect(host='localhost', port='19530')
print("✅ 连接成功！")
EOF
```

**这个配置适合：**
- 开发环境测试
- 学习Kubernetes部署
- 快速验证功能

---

## 4.3 自定义配置（生产环境必备）

**创建配置文件 `values.yaml`：**

```yaml
# 最小生产配置
cluster:
  enabled: true  # 启用集群模式

# 资源配置
queryNode:
  replicas: 2  # 2个查询节点
  resources:
    requests:
      cpu: 2
      memory: 8Gi
    limits:
      cpu: 4
      memory: 16Gi

dataNode:
  replicas: 2  # 2个数据节点
  resources:
    requests:
      cpu: 1
      memory: 4Gi

# 持久化存储
persistence:
  enabled: true
  storageClass: "fast-ssd"  # 使用SSD存储类
  size: 100Gi

# 外部依赖（生产推荐）
externalEtcd:
  enabled: true
  endpoints:
    - etcd-0.etcd:2379
    - etcd-1.etcd:2379
    - etcd-2.etcd:2379

externalS3:
  enabled: true
  host: "minio.default.svc.cluster.local"
  port: 9000
  accessKey: "minioadmin"
  secretKey: "minioadmin"
  bucketName: "milvus-bucket"
```

**使用自定义配置部署：**

```bash
helm install my-milvus milvus/milvus -f values.yaml
```

**配置说明：**
- `replicas`：副本数（高可用至少2个）
- `resources`：资源限制（防止OOM）
- `persistence`：持久化存储（数据不丢失）
- `externalEtcd/S3`：外部依赖（生产推荐独立部署）

---

## 4.4 基本运维操作

### 查看集群状态

```bash
# 查看所有Pod
kubectl get pods

# 查看服务
kubectl get svc
# NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)
# my-milvus           ClusterIP   10.96.100.123   <none>        19530/TCP

# 查看详细信息
kubectl describe pod my-milvus-proxy-xxx

# 查看日志
kubectl logs -f my-milvus-proxy-xxx
```

### 扩缩容

```bash
# 扩容QueryNode到5个副本
kubectl scale deployment my-milvus-querynode --replicas=5

# 或修改values.yaml后升级
helm upgrade my-milvus milvus/milvus -f values.yaml
```

### 升级Milvus版本

```bash
# 查看可用版本
helm search repo milvus/milvus --versions

# 升级到新版本
helm upgrade my-milvus milvus/milvus --version 4.1.0

# 回滚到上一个版本
helm rollback my-milvus
```

### 删除集群

```bash
# 删除Milvus（保留PVC）
helm uninstall my-milvus

# 删除PVC（数据会丢失！）
kubectl delete pvc -l app.kubernetes.io/instance=my-milvus
```

---

## 4.5 暴露服务到外部

**方式1：NodePort（简单）**

```yaml
# values.yaml
service:
  type: NodePort
  port: 19530
  nodePort: 30530  # 外部访问端口
```

```bash
# 部署后访问
# http://<任意节点IP>:30530
```

**方式2：LoadBalancer（云环境推荐）**

```yaml
# values.yaml
service:
  type: LoadBalancer
  port: 19530
```

```bash
# 获取外部IP
kubectl get svc my-milvus
# NAME        TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)
# my-milvus   LoadBalancer   10.96.100.123  35.123.45.67     19530:30530/TCP

# 使用外部IP连接
# host='35.123.45.67', port=19530
```

**方式3：Ingress（域名访问）**

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: milvus-ingress
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
spec:
  rules:
  - host: milvus.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-milvus
            port:
              number: 19530
```

```bash
kubectl apply -f ingress.yaml

# 访问
# host='milvus.example.com', port=443
```

---

## 这些知识足以：

✅ **在Kubernetes上部署Milvus集群**
- 使用Helm一键部署
- 自定义资源配置
- 配置持久化存储

✅ **进行基本运维操作**
- 查看集群状态和日志
- 扩缩容组件
- 升级和回滚版本

✅ **暴露服务供外部访问**
- NodePort快速测试
- LoadBalancer生产使用
- Ingress域名访问

✅ **为RAG系统提供向量检索服务**
- 部署高可用集群
- 配置资源保证性能
- 持久化数据防止丢失

---

## 快速参考卡

| 操作 | 命令 |
|------|------|
| **部署** | `helm install my-milvus milvus/milvus` |
| **查看状态** | `kubectl get pods` |
| **查看日志** | `kubectl logs -f <pod-name>` |
| **扩容** | `kubectl scale deployment <name> --replicas=N` |
| **升级** | `helm upgrade my-milvus milvus/milvus` |
| **回滚** | `helm rollback my-milvus` |
| **删除** | `helm uninstall my-milvus` |
| **端口转发** | `kubectl port-forward svc/my-milvus 19530:19530` |

---

## 下一步学习

掌握了最小可用知识后，可以深入学习：

1. **核心概念**：理解Helm Charts、Operator、集群配置的原理
2. **实战代码**：完整的部署脚本和配置示例
3. **高级特性**：自动伸缩、故障恢复、多集群管理
4. **性能优化**：资源调优、网络优化、存储优化

**记住：先能用起来，再深入理解原理！**
