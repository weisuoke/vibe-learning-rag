# 最小可用知识

掌握以下内容，就能开始使用 Sub-Agents：

## 4.1 三种执行模式

**Sub-Agents 支持三种执行模式，覆盖不同的任务场景。**

### Single Mode（单代理模式）

**用途**：委托单个任务给一个专用代理。

```typescript
// 在 pi 中使用
"Use scout to find all authentication code"

// 工具调用参数
{
  agent: "scout",
  task: "Find all authentication-related code"
}
```

**适用场景**：
- 快速侦查代码库
- 单一明确的任务
- 需要专用工具集的任务

### Parallel Mode（并行模式）

**用途**：同时执行多个独立任务，提高效率。

```typescript
// 在 pi 中使用
"Run 3 scouts in parallel: find auth code, find database code, find API endpoints"

// 工具调用参数
{
  tasks: [
    { agent: "scout", task: "Find authentication code" },
    { agent: "scout", task: "Find database code" },
    { agent: "scout", task: "Find API endpoints" }
  ]
}
```

**限制**：
- 最多 8 个任务
- 最多 4 个并发执行
- 任务之间必须独立（无依赖）

**适用场景**：
- 信息收集
- 多个独立的分析任务
- 需要快速获取多个结果

### Chain Mode（链式模式）

**用途**：顺序执行多个任务，后续任务可以使用前面任务的输出。

```typescript
// 在 pi 中使用
"Use a chain: scout finds auth code, then planner creates refactoring plan"

// 工具调用参数
{
  chain: [
    {
      agent: "scout",
      task: "Find all authentication code"
    },
    {
      agent: "planner",
      task: "Based on {previous}, create a refactoring plan for OAuth support"
    }
  ]
}
```

**关键特性**：
- `{previous}` 占位符会被替换为上一步的输出
- 任何步骤失败会停止整个链
- 适合多步骤工作流

**适用场景**：
- 侦查 → 计划 → 实现
- 实现 → 审查 → 修复
- 任何需要上下文传递的工作流

---

## 4.2 Agent 定义格式

**Agent 是 Markdown 文件，使用 YAML frontmatter 配置。**

### 基本结构

```markdown
---
name: my-agent
description: What this agent does
tools: read, grep, find, ls
model: claude-haiku-4-5
---

System prompt for the agent goes here.
You are a specialized agent that...
```

### 字段说明

| 字段 | 必需 | 说明 | 示例 |
|------|------|------|------|
| `name` | ✅ | Agent 名称（唯一标识） | `scout`, `planner` |
| `description` | ✅ | Agent 功能描述 | `Fast codebase reconnaissance` |
| `tools` | ❌ | 可用工具列表（逗号分隔） | `read, grep, find, ls` |
| `model` | ❌ | 使用的模型 | `claude-haiku-4-5` |

### 示例：Scout Agent

```markdown
---
name: scout
description: Fast codebase reconnaissance
tools: read, grep, find, ls, bash
model: claude-haiku-4-5
---

You are a fast reconnaissance agent. Your job is to:
1. Quickly locate relevant files and code
2. Return compressed, actionable context
3. Use efficient search strategies

Keep your output concise and structured.
```

**保存位置**：
- `~/.pi/agent/agents/scout.md` - 用户级别（推荐）
- `.pi/agents/scout.md` - 项目级别（需要信任）

---

## 4.3 基本工具调用

**在 pi 中，直接用自然语言描述任务即可。**

### 方式1：自然语言（推荐）

```bash
# 单代理
"Use scout to find all error handling code"

# 并行
"Run 2 scouts: one for frontend, one for backend"

# 链式
"Chain: scout finds code, planner creates plan"
```

**pi 会自动识别并调用 subagent 工具。**

### 方式2：工作流 Prompts

```bash
# 使用预定义的工作流
/implement add Redis caching
/scout-and-plan refactor authentication
/implement-and-review add input validation
```

**工作流 Prompts 位置**：
- `~/.pi/agent/prompts/*.md`
- `.pi/prompts/*.md`

### 方式3：Extension 中调用

```typescript
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.registerTool({
    name: "my-tool",
    async execute(toolCallId, params, signal, onUpdate, ctx) {
      // 调用 subagent 工具
      const result = await ctx.callTool("subagent", {
        agent: "scout",
        task: "Find authentication code"
      });

      return result;
    }
  });
}
```

---

## 4.4 Agent 发现机制

**pi 会自动发现两个位置的 Agent 定义。**

### 用户级别（默认）

```bash
~/.pi/agent/agents/
├── scout.md
├── planner.md
├── reviewer.md
└── worker.md
```

**特点**：
- 始终加载
- 跨项目共享
- 安全可信

### 项目级别（可选）

```bash
.pi/agents/
├── custom-agent.md
└── project-specific.md
```

**特点**：
- 需要显式启用：`agentScope: "both"` 或 `"project"`
- 项目特定
- 需要用户确认（安全考虑）

### Agent Scope 控制

```typescript
// 只使用用户级别 agents（默认）
{ agent: "scout", task: "...", agentScope: "user" }

// 只使用项目级别 agents
{ agent: "scout", task: "...", agentScope: "project" }

// 使用两者（项目 agent 优先）
{ agent: "scout", task: "...", agentScope: "both" }
```

**安全提示**：项目级别的 agents 是仓库控制的，只在信任的仓库中使用。

---

## 4.5 安全模型

**Sub-Agents 的安全模型基于信任边界。**

### 用户 vs 项目 Agents

| 维度 | 用户 Agents | 项目 Agents |
|------|------------|------------|
| **位置** | `~/.pi/agent/agents/` | `.pi/agents/` |
| **信任** | 完全信任（你创建的） | 需要审查（仓库控制） |
| **默认** | 始终加载 | 需要显式启用 |
| **确认** | 无需确认 | 默认需要确认 |

### 确认提示

当使用项目 agents 时，pi 会显示确认对话框：

```
Run project-local agents?
Agents: custom-agent
Source: /path/to/project/.pi/agents

Project agents are repo-controlled. Only continue for trusted repositories.

[Yes] [No]
```

**禁用确认**（仅在完全信任仓库时）：
```typescript
{
  agent: "custom-agent",
  task: "...",
  agentScope: "both",
  confirmProjectAgents: false  // 跳过确认
}
```

### 安全最佳实践

1. **审查项目 agents**：在启用前，检查 `.pi/agents/*.md` 的内容
2. **限制工具集**：项目 agents 只给必要的工具
3. **使用用户 agents**：通用 agents 放在用户级别
4. **定期审计**：检查哪些 agents 被使用

---

## 这些知识足以：

✅ **立即开始使用 Sub-Agents**
- 使用三种模式委托任务
- 创建自定义 Agent 定义
- 理解安全模型

✅ **处理常见场景**
- 代码侦查（scout）
- 计划生成（planner）
- 代码审查（reviewer）
- 通用实现（worker）

✅ **为后续学习打基础**
- 理解 Agent 的基本概念
- 掌握工具调用方式
- 了解安全考虑

---

## 快速上手检查清单

- [ ] 理解三种执行模式（Single, Parallel, Chain）
- [ ] 知道 Agent 定义的 YAML frontmatter 格式
- [ ] 能够用自然语言调用 Sub-Agents
- [ ] 了解 Agent 发现的两个位置
- [ ] 理解用户 vs 项目 agents 的安全区别
- [ ] 能够创建一个简单的自定义 Agent

**下一步**：深入学习核心概念，了解 Sub-Agents 的内部机制和高级用法。
