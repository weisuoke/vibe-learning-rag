# 30字核心：链式调试与日志

## 核心定义

**通过事件流、回调处理器和监控工具，实时追踪LCEL链的执行过程，快速定位问题并优化性能。**

---

## 三个关键能力

### 1. 实时调试 (Real-time Debugging)

使用 `astream_events()` v2 查看链执行的每个步骤：

```python
async for event in chain.astream_events(input, version="v2"):
    print(f"{event['event']}: {event['name']}")
```

**核心价值**：像看电影慢镜头一样，逐帧查看链的执行过程。

---

### 2. 自定义日志 (Custom Logging)

通过回调处理器记录关键信息：

```python
from langchain_core.callbacks import BaseCallbackHandler

class MyLogHandler(BaseCallbackHandler):
    def on_chain_start(self, serialized, inputs, **kwargs):
        print(f"Chain started: {inputs}")

chain.invoke(input, config={"callbacks": [MyLogHandler()]})
```

**核心价值**：按需记录，灵活控制日志内容和格式。

---

### 3. 生产监控 (Production Monitoring)

集成 OpenTelemetry 或 LangSmith 进行全链路追踪：

```python
import os
os.environ["LANGCHAIN_TRACING_V2"] = "true"
os.environ["LANGCHAIN_API_KEY"] = "your_key"

# 自动追踪所有链执行
result = chain.invoke(input)
```

**核心价值**：生产环境可观测性，实时监控性能和成本。

---

## 最简代码示例

### 场景：调试一个简单的RAG链

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from dotenv import load_dotenv
import asyncio

load_dotenv()

# 构建链
prompt = ChatPromptTemplate.from_template("回答问题: {question}")
model = ChatOpenAI(model="gpt-4o-mini")
chain = prompt | model | StrOutputParser()

# 方法1: 使用 astream_events 调试
async def debug_with_events():
    async for event in chain.astream_events(
        {"question": "什么是LCEL?"},
        version="v2"
    ):
        kind = event["event"]
        if kind == "on_chat_model_stream":
            print(event["data"]["chunk"].content, end="", flush=True)

asyncio.run(debug_with_events())
```

**输出示例**：
```
LCEL（LangChain Expression Language）是一种声明式的链构建语言...
```

---

## 三种调试方式对比

| 方式 | 适用场景 | 优点 | 缺点 |
|------|----------|------|------|
| **astream_events** | 开发调试 | 实时、详细、灵活 | 有性能开销 |
| **Callback Handlers** | 自定义日志 | 可控、可扩展 | 需要编码 |
| **LangSmith/OpenTelemetry** | 生产监控 | 全链路、可视化 | 需要配置 |

---

## 核心记忆点

1. **开发阶段**：用 `astream_events()` 看清每一步
2. **集成阶段**：用 `BaseCallbackHandler` 记录关键信息
3. **生产阶段**：用 LangSmith/OpenTelemetry 监控全局

---

## 一句话总结

**调试看事件流，日志用回调，生产靠监控。**

---

**版本信息**
- LangChain: v0.3+ (2025-2026)
- Python: 3.13+
- 最后更新: 2026-02-20
