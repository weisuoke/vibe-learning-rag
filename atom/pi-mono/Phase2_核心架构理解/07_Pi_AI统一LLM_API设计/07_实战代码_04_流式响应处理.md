# å®æˆ˜ä»£ç 4ï¼šæµå¼å“åº”å¤„ç†

> å®ç°ç»Ÿä¸€çš„æµå¼å“åº”å¤„ç†

---

## ç›®æ ‡

å®ç°æµå¼å“åº”çš„äº‹ä»¶å¤„ç†ï¼Œæ”¯æŒå®æ—¶æ‰“å­—æœºæ•ˆæœã€‚

---

## å®Œæ•´ä»£ç 

```typescript
/**
 * æµå¼å“åº”å¤„ç†
 * æ¼”ç¤ºï¼šstart/delta/end äº‹ä»¶æµå¤„ç†
 */

// ===== 1. äº‹ä»¶ç±»å‹å®šä¹‰ =====

type StreamEvent =
  | { type: 'start'; model: string; timestamp: number }
  | { type: 'delta'; content: string }
  | { type: 'end'; usage: { totalTokens: number }; timestamp: number }
  | { type: 'error'; error: string; timestamp: number };

// ===== 2. æµå¼äº‹ä»¶ç”Ÿæˆå™¨ï¼ˆæ¨¡æ‹Ÿï¼‰ =====

async function* mockStreamGenerator(): AsyncGenerator<StreamEvent> {
  // å¼€å§‹äº‹ä»¶
  yield {
    type: 'start',
    model: 'gpt-4o-mini',
    timestamp: Date.now()
  };

  // æ¨¡æ‹Ÿé€å­—è¾“å‡º
  const text = 'TypeScript is a statically typed superset of JavaScript.';
  const words = text.split(' ');

  for (const word of words) {
    await new Promise(resolve => setTimeout(resolve, 100));
    yield {
      type: 'delta',
      content: word + ' '
    };
  }

  // ç»“æŸäº‹ä»¶
  yield {
    type: 'end',
    usage: { totalTokens: 15 },
    timestamp: Date.now()
  };
}

// ===== 3. æµå¼äº‹ä»¶å¤„ç†å™¨ =====

class StreamHandler {
  private content = '';
  private startTime = 0;

  async handle(stream: AsyncGenerator<StreamEvent>): Promise<string> {
    for await (const event of stream) {
      switch (event.type) {
        case 'start':
          this.startTime = event.timestamp;
          console.log(`ğŸš€ Stream started (model: ${event.model})`);
          break;

        case 'delta':
          this.content += event.content;
          process.stdout.write(event.content);
          break;

        case 'end':
          const duration = event.timestamp - this.startTime;
          console.log(`\nâœ… Stream ended (${event.usage.totalTokens} tokens, ${duration}ms)`);
          break;

        case 'error':
          console.error(`\nâŒ Error: ${event.error}`);
          break;
      }
    }

    return this.content;
  }
}

// ===== 4. æµå¼ç´¯ç§¯å™¨ =====

class StreamAccumulator {
  private chunks: string[] = [];

  async accumulate(stream: AsyncGenerator<StreamEvent>): Promise<{
    content: string;
    tokens: number;
    duration: number;
  }> {
    let startTime = 0;
    let endTime = 0;
    let tokens = 0;

    for await (const event of stream) {
      if (event.type === 'start') {
        startTime = event.timestamp;
      } else if (event.type === 'delta') {
        this.chunks.push(event.content);
      } else if (event.type === 'end') {
        endTime = event.timestamp;
        tokens = event.usage.totalTokens;
      }
    }

    return {
      content: this.chunks.join(''),
      tokens,
      duration: endTime - startTime
    };
  }
}

// ===== 5. ä½¿ç”¨ç¤ºä¾‹ =====

async function main() {
  console.log('=== ç¤ºä¾‹1ï¼šå®æ—¶æ‰“å­—æœºæ•ˆæœ ===\n');

  const handler = new StreamHandler();
  const content1 = await handler.handle(mockStreamGenerator());

  console.log('\n\n=== ç¤ºä¾‹2ï¼šç´¯ç§¯å®Œæ•´å†…å®¹ ===\n');

  const accumulator = new StreamAccumulator();
  const result = await accumulator.accumulate(mockStreamGenerator());

  console.log('å®Œæ•´å†…å®¹:', result.content);
  console.log('Token æ•°:', result.tokens);
  console.log('è€—æ—¶:', result.duration, 'ms');
}

main().catch(console.error);
```

---

## è¿è¡Œè¾“å‡º

```
=== ç¤ºä¾‹1ï¼šå®æ—¶æ‰“å­—æœºæ•ˆæœ ===

ğŸš€ Stream started (model: gpt-4o-mini)
TypeScript is a statically typed superset of JavaScript.
âœ… Stream ended (15 tokens, 800ms)


=== ç¤ºä¾‹2ï¼šç´¯ç§¯å®Œæ•´å†…å®¹ ===

å®Œæ•´å†…å®¹: TypeScript is a statically typed superset of JavaScript.
Token æ•°: 15
è€—æ—¶: 800 ms
```

---

## å…³é”®ç‚¹

### 1. AsyncGenerator
ä½¿ç”¨ `for await...of` å¤„ç†å¼‚æ­¥æµã€‚

### 2. äº‹ä»¶é©±åŠ¨
é€šè¿‡äº‹ä»¶ç±»å‹åˆ†å‘ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚

### 3. å®æ—¶è¾“å‡º
ä½¿ç”¨ `process.stdout.write()` å®ç°æ‰“å­—æœºæ•ˆæœã€‚

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-19
