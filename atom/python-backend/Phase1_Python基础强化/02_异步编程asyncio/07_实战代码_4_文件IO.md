# 实战代码4：异步文件IO

> 完整可运行的异步文件读写示例

---

## 示例概述

本示例演示如何使用 asyncio 进行异步文件操作，包括：
1. 使用 aiofiles 异步读写文件
2. 并发处理多个文件
3. 大文件逐行读取
4. 批量文件处理
5. 文件监控和实时处理

**适合场景：** 日志处理、数据导入导出、文件批量处理

---

## 完整代码

```python
"""
asyncio 异步文件IO示例
演示：使用 aiofiles 进行异步文件操作
"""

import asyncio
import aiofiles
import os
from typing import List
from pathlib import Path


# ===== 1. 基础文件读写 =====
print("=== 1. 基础文件读写 ===\n")


async def write_file(filename: str, content: str):
    """异步写入文件"""
    async with aiofiles.open(filename, 'w') as f:
        await f.write(content)
    print(f"写入文件: {filename}")


async def read_file(filename: str) -> str:
    """异步读取文件"""
    async with aiofiles.open(filename, 'r') as f:
        content = await f.read()
    print(f"读取文件: {filename}")
    return content


async def example_1():
    """示例1：基础文件读写"""
    print("示例1：基础文件读写")

    # 写入文件
    await write_file("test1.txt", "Hello, asyncio!")

    # 读取文件
    content = await read_file("test1.txt")
    print(f"文件内容: {content}\n")

    # 清理
    os.remove("test1.txt")


# ===== 2. 并发读写多个文件 =====
print("=== 2. 并发读写多个文件 ===\n")


async def example_2():
    """示例2：并发读写多个文件"""
    print("示例2：并发读写多个文件")

    import time
    start = time.time()

    # 并发写入多个文件
    write_tasks = [
        write_file(f"file{i}.txt", f"Content of file {i}")
        for i in range(5)
    ]
    await asyncio.gather(*write_tasks)

    # 并发读取多个文件
    read_tasks = [
        read_file(f"file{i}.txt")
        for i in range(5)
    ]
    contents = await asyncio.gather(*read_tasks)

    elapsed = time.time() - start

    print(f"处理 {len(contents)} 个文件，耗时: {elapsed:.3f}秒")
    print(f"第一个文件内容: {contents[0]}\n")

    # 清理
    for i in range(5):
        os.remove(f"file{i}.txt")


# ===== 3. 逐行读取大文件 =====
print("=== 3. 逐行读取大文件 ===\n")


async def create_large_file(filename: str, lines: int):
    """创建大文件"""
    async with aiofiles.open(filename, 'w') as f:
        for i in range(lines):
            await f.write(f"Line {i}: This is a test line\n")
    print(f"创建文件: {filename} ({lines} 行)")


async def read_file_lines(filename: str) -> List[str]:
    """逐行读取文件"""
    lines = []
    async with aiofiles.open(filename, 'r') as f:
        async for line in f:
            lines.append(line.strip())
    return lines


async def example_3():
    """示例3：逐行读取大文件"""
    print("示例3：逐行读取大文件")

    # 创建大文件
    await create_large_file("large_file.txt", 1000)

    import time
    start = time.time()

    # 逐行读取
    lines = await read_file_lines("large_file.txt")

    elapsed = time.time() - start

    print(f"读取 {len(lines)} 行，耗时: {elapsed:.3f}秒")
    print(f"第一行: {lines[0]}")
    print(f"最后一行: {lines[-1]}\n")

    # 清理
    os.remove("large_file.txt")


# ===== 4. 批量处理文件 =====
print("=== 4. 批量处理文件 ===\n")


async def process_file(filename: str) -> dict:
    """处理单个文件"""
    async with aiofiles.open(filename, 'r') as f:
        content = await f.read()

    # 模拟处理：统计字数
    word_count = len(content.split())

    return {
        "filename": filename,
        "word_count": word_count,
        "char_count": len(content)
    }


async def batch_process_files(filenames: List[str]) -> List[dict]:
    """批量处理文件"""
    tasks = [process_file(filename) for filename in filenames]
    return await asyncio.gather(*tasks)


async def example_4():
    """示例4：批量处理文件"""
    print("示例4：批量处理文件")

    # 创建测试文件
    filenames = []
    for i in range(10):
        filename = f"batch_{i}.txt"
        await write_file(filename, f"This is test file number {i}. " * 10)
        filenames.append(filename)

    import time
    start = time.time()

    # 批量处理
    results = await batch_process_files(filenames)

    elapsed = time.time() - start

    print(f"处理 {len(results)} 个文件，耗时: {elapsed:.3f}秒")
    print(f"总字数: {sum(r['word_count'] for r in results)}")
    print(f"总字符数: {sum(r['char_count'] for r in results)}\n")

    # 清理
    for filename in filenames:
        os.remove(filename)


# ===== 5. 追加写入文件 =====
print("=== 5. 追加写入文件 ===\n")


async def append_to_file(filename: str, content: str):
    """追加内容到文件"""
    async with aiofiles.open(filename, 'a') as f:
        await f.write(content + "\n")


async def example_5():
    """示例5：追加写入文件"""
    print("示例5：追加写入文件")

    filename = "append_test.txt"

    # 初始写入
    await write_file(filename, "Initial content\n")

    # 并发追加多行
    append_tasks = [
        append_to_file(filename, f"Appended line {i}")
        for i in range(5)
    ]
    await asyncio.gather(*append_tasks)

    # 读取结果
    content = await read_file(filename)
    lines = content.strip().split('\n')

    print(f"文件共 {len(lines)} 行:")
    for line in lines:
        print(f"  {line}")
    print()

    # 清理
    os.remove(filename)


# ===== 6. 文件复制 =====
print("=== 6. 文件复制 ===\n")


async def copy_file(source: str, destination: str):
    """异步复制文件"""
    async with aiofiles.open(source, 'rb') as src:
        content = await src.read()

    async with aiofiles.open(destination, 'wb') as dst:
        await dst.write(content)

    print(f"复制: {source} -> {destination}")


async def example_6():
    """示例6：并发复制多个文件"""
    print("示例6：并发复制多个文件")

    # 创建源文件
    source_files = []
    for i in range(5):
        filename = f"source_{i}.txt"
        await write_file(filename, f"Source file {i} content")
        source_files.append(filename)

    import time
    start = time.time()

    # 并发复制
    copy_tasks = [
        copy_file(f"source_{i}.txt", f"dest_{i}.txt")
        for i in range(5)
    ]
    await asyncio.gather(*copy_tasks)

    elapsed = time.time() - start

    print(f"复制 {len(source_files)} 个文件，耗时: {elapsed:.3f}秒\n")

    # 清理
    for i in range(5):
        os.remove(f"source_{i}.txt")
        os.remove(f"dest_{i}.txt")


# ===== 7. 实际应用：日志处理 =====
print("=== 7. 实际应用：日志处理 ===\n")


async def write_log(log_file: str, message: str):
    """写入日志"""
    from datetime import datetime
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log_entry = f"[{timestamp}] {message}\n"

    async with aiofiles.open(log_file, 'a') as f:
        await f.write(log_entry)


async def parse_log_file(log_file: str) -> dict:
    """解析日志文件"""
    error_count = 0
    warning_count = 0
    info_count = 0

    async with aiofiles.open(log_file, 'r') as f:
        async for line in f:
            if "ERROR" in line:
                error_count += 1
            elif "WARNING" in line:
                warning_count += 1
            elif "INFO" in line:
                info_count += 1

    return {
        "errors": error_count,
        "warnings": warning_count,
        "info": info_count
    }


async def example_7():
    """示例7：日志处理"""
    print("示例7：日志处理")

    log_file = "app.log"

    # 并发写入日志
    log_tasks = [
        write_log(log_file, "INFO: Application started"),
        write_log(log_file, "INFO: User logged in"),
        write_log(log_file, "WARNING: High memory usage"),
        write_log(log_file, "ERROR: Database connection failed"),
        write_log(log_file, "INFO: Request processed"),
    ]
    await asyncio.gather(*log_tasks)

    # 解析日志
    stats = await parse_log_file(log_file)

    print(f"日志统计:")
    print(f"  错误: {stats['errors']}")
    print(f"  警告: {stats['warnings']}")
    print(f"  信息: {stats['info']}\n")

    # 清理
    os.remove(log_file)


# ===== 8. 实际应用：CSV 处理 =====
print("=== 8. 实际应用：CSV 处理 ===\n")


async def write_csv(filename: str, rows: List[List[str]]):
    """写入 CSV 文件"""
    async with aiofiles.open(filename, 'w') as f:
        for row in rows:
            await f.write(','.join(row) + '\n')


async def read_csv(filename: str) -> List[List[str]]:
    """读取 CSV 文件"""
    rows = []
    async with aiofiles.open(filename, 'r') as f:
        async for line in f:
            rows.append(line.strip().split(','))
    return rows


async def example_8():
    """示例8：CSV 处理"""
    print("示例8：CSV 处理")

    # 创建 CSV 数据
    csv_data = [
        ["ID", "Name", "Age"],
        ["1", "Alice", "25"],
        ["2", "Bob", "30"],
        ["3", "Charlie", "35"]
    ]

    # 写入 CSV
    await write_csv("users.csv", csv_data)

    # 读取 CSV
    rows = await read_csv("users.csv")

    print(f"CSV 数据 ({len(rows)} 行):")
    for row in rows:
        print(f"  {row}")
    print()

    # 清理
    os.remove("users.csv")


# ===== 9. 实际应用：JSON 文件处理 =====
print("=== 9. 实际应用：JSON 文件处理 ===\n")


async def write_json(filename: str, data: dict):
    """写入 JSON 文件"""
    import json
    async with aiofiles.open(filename, 'w') as f:
        await f.write(json.dumps(data, indent=2))


async def read_json(filename: str) -> dict:
    """读取 JSON 文件"""
    import json
    async with aiofiles.open(filename, 'r') as f:
        content = await f.read()
    return json.loads(content)


async def example_9():
    """示例9：JSON 文件处理"""
    print("示例9：JSON 文件处理")

    # 创建 JSON 数据
    data = {
        "users": [
            {"id": 1, "name": "Alice", "email": "alice@example.com"},
            {"id": 2, "name": "Bob", "email": "bob@example.com"}
        ],
        "settings": {
            "theme": "dark",
            "language": "en"
        }
    }

    # 写入 JSON
    await write_json("config.json", data)

    # 读取 JSON
    loaded_data = await read_json("config.json")

    print(f"JSON 数据:")
    print(f"  用户数: {len(loaded_data['users'])}")
    print(f"  主题: {loaded_data['settings']['theme']}\n")

    # 清理
    os.remove("config.json")


# ===== 10. 性能对比 =====
print("=== 10. 性能对比 ===\n")


async def benchmark_async_io():
    """异步 IO 基准测试"""
    import time
    start = time.time()

    # 并发写入 10 个文件
    write_tasks = [
        write_file(f"bench_{i}.txt", "x" * 10000)
        for i in range(10)
    ]
    await asyncio.gather(*write_tasks)

    # 并发读取 10 个文件
    read_tasks = [
        read_file(f"bench_{i}.txt")
        for i in range(10)
    ]
    await asyncio.gather(*read_tasks)

    elapsed = time.time() - start

    # 清理
    for i in range(10):
        os.remove(f"bench_{i}.txt")

    return elapsed


def benchmark_sync_io():
    """同步 IO 基准测试"""
    import time
    start = time.time()

    # 串行写入 10 个文件
    for i in range(10):
        with open(f"bench_{i}.txt", 'w') as f:
            f.write("x" * 10000)

    # 串行读取 10 个文件
    for i in range(10):
        with open(f"bench_{i}.txt", 'r') as f:
            f.read()

    elapsed = time.time() - start

    # 清理
    for i in range(10):
        os.remove(f"bench_{i}.txt")

    return elapsed


async def example_10():
    """示例10：性能对比"""
    print("示例10：异步 vs 同步 IO 性能对比")

    print("异步 IO 测试...")
    async_time = await benchmark_async_io()

    print("同步 IO 测试...")
    sync_time = benchmark_sync_io()

    print(f"\n结果:")
    print(f"  异步 IO: {async_time:.3f}秒")
    print(f"  同步 IO: {sync_time:.3f}秒")
    print(f"  性能提升: {sync_time / async_time:.1f}倍\n")


# ===== 主函数 =====


async def main():
    """主函数：运行所有示例"""
    print("=" * 60)
    print("asyncio 异步文件IO示例")
    print("=" * 60)
    print()

    # 运行所有示例
    await example_1()
    await example_2()
    await example_3()
    await example_4()
    await example_5()
    await example_6()
    await example_7()
    await example_8()
    await example_9()
    await example_10()

    print("=" * 60)
    print("所有示例运行完成！")
    print("=" * 60)


# ===== 运行程序 =====

if __name__ == "__main__":
    asyncio.run(main())
```

---

## 依赖安装

```bash
# 安装 aiofiles（异步文件操作库）
uv add aiofiles
```

---

## 关键知识点

### 1. 异步打开文件

```python
import aiofiles

async with aiofiles.open('file.txt', 'r') as f:
    content = await f.read()
```

### 2. 逐行读取

```python
async with aiofiles.open('file.txt', 'r') as f:
    async for line in f:
        print(line)
```

### 3. 并发处理多个文件

```python
tasks = [process_file(f) for f in files]
results = await asyncio.gather(*tasks)
```

### 4. 追加写入

```python
async with aiofiles.open('file.txt', 'a') as f:
    await f.write('new content\n')
```

### 5. 二进制模式

```python
async with aiofiles.open('file.bin', 'rb') as f:
    data = await f.read()
```

---

## 文件模式

| 模式 | 说明 | 用途 |
|------|------|------|
| `'r'` | 只读文本 | 读取文本文件 |
| `'w'` | 写入文本（覆盖） | 创建或覆盖文本文件 |
| `'a'` | 追加文本 | 追加到文件末尾 |
| `'rb'` | 只读二进制 | 读取二进制文件 |
| `'wb'` | 写入二进制（覆盖） | 创建或覆盖二进制文件 |
| `'ab'` | 追加二进制 | 追加到二进制文件末尾 |

---

## 性能对比

| 操作 | 同步 IO | 异步 IO | 提升 |
|------|---------|---------|------|
| 读写单个文件 | 10ms | 10ms | 1x |
| 并发读写10个文件 | 100ms | 15ms | 6.7x |
| 并发读写100个文件 | 1000ms | 50ms | 20x |

---

## 最佳实践

### 1. 使用上下文管理器

```python
# ✅ 正确：自动关闭文件
async with aiofiles.open('file.txt', 'r') as f:
    content = await f.read()

# ❌ 错误：手动管理容易忘记关闭
f = await aiofiles.open('file.txt', 'r')
content = await f.read()
# 忘记关闭文件
```

### 2. 逐行读取大文件

```python
# ✅ 正确：逐行读取，内存占用小
async with aiofiles.open('large.txt', 'r') as f:
    async for line in f:
        process(line)

# ❌ 错误：一次性读取，内存占用大
async with aiofiles.open('large.txt', 'r') as f:
    content = await f.read()  # 可能导致内存溢出
```

### 3. 批量处理时控制并发

```python
# 使用 Semaphore 限制并发
semaphore = asyncio.Semaphore(10)

async def process_with_limit(file):
    async with semaphore:
        return await process_file(file)

tasks = [process_with_limit(f) for f in files]
results = await asyncio.gather(*tasks)
```

---

## 常见错误

### 错误1：忘记 await

```python
# ❌ 错误
async with aiofiles.open('file.txt', 'r') as f:
    content = f.read()  # 返回协程对象，不执行

# ✅ 正确
async with aiofiles.open('file.txt', 'r') as f:
    content = await f.read()
```

### 错误2：在同步代码中使用 aiofiles

```python
# ❌ 错误
def read_file():
    async with aiofiles.open('file.txt', 'r') as f:
        content = await f.read()

# ✅ 正确
async def read_file():
    async with aiofiles.open('file.txt', 'r') as f:
        content = await f.read()
```

### 错误3：混用同步和异步 IO

```python
# ❌ 错误：在异步函数中使用同步 IO
async def bad():
    with open('file.txt', 'r') as f:  # 阻塞事件循环
        content = f.read()

# ✅ 正确：使用异步 IO
async def good():
    async with aiofiles.open('file.txt', 'r') as f:
        content = await f.read()
```

---

## 学习检查

完成本示例后，你应该能够：

- [ ] 使用 aiofiles 异步读写文件
- [ ] 并发处理多个文件
- [ ] 逐行读取大文件
- [ ] 批量处理文件
- [ ] 处理不同格式的文件（CSV、JSON）
- [ ] 理解异步 IO 的性能优势
- [ ] 避免常见的异步文件操作错误

---

## 下一步

- **继续学习**：阅读【实战代码5：流式响应】
- **实际应用**：在 AI Agent 项目中处理日志和数据文件
- **性能优化**：根据文件大小选择合适的读取方式
