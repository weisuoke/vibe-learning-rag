# 后台任务 - 概览

> 掌握 FastAPI 的后台任务机制，让 API 快速响应的同时异步处理耗时操作

---

## 本知识点概述

**后台任务（BackgroundTasks）** 是 FastAPI 内置的轻量级异步任务处理机制，允许你在返回 HTTP 响应后继续执行耗时操作，类似于 Express 中在响应后执行的异步操作，但更加优雅和类型安全。

### 为什么需要后台任务？

在 AI Agent 开发中，很多操作需要时间：
- 📧 发送邮件通知
- 📄 解析上传的文档
- 🔢 生成文本的 Embedding
- 📊 记录详细日志
- 🗄️ 更新缓存

如果这些操作在响应前执行，用户需要等待很久。后台任务让你可以：
1. ✅ 立即返回响应（用户体验好）
2. ✅ 在后台异步处理（不阻塞）
3. ✅ 保持代码简洁（无需额外服务）

---

## 学习目标

完成本知识点后，你将能够：

- [ ] 理解后台任务的工作原理和适用场景
- [ ] 使用 BackgroundTasks 处理简单异步操作
- [ ] 区分 BackgroundTasks 和任务队列（Celery/RQ）的使用场景
- [ ] 实现生产级的后台任务（错误处理、监控、重试）
- [ ] 在 AI Agent 项目中应用后台任务优化用户体验

---

## 内容结构

### 基础理解
1. **30字核心** - 快速理解后台任务的本质
2. **第一性原理** - 从根本理解为什么需要后台任务
3. **最小可用** - 20%核心知识解决80%问题

### 核心概念（3个）
1. **BackgroundTasks 基础机制** - API 使用、执行时机、生命周期
2. **任务队列对比** - BackgroundTasks vs Celery/RQ，如何选择
3. **生产环境最佳实践** - 错误处理、监控、性能优化

### 实战应用
1. **双重类比** - 用前端和日常生活理解后台任务
2. **反直觉点** - 避开常见误区
3. **实战代码** - 4个完整可运行的示例
4. **面试必问** - 高频面试题和出彩回答

### 深度掌握
1. **化骨绵掌** - 10个2分钟知识卡片
2. **一句话总结** - 精炼总结

---

## 与 AI Agent 开发的关系

| 场景 | 使用后台任务的价值 |
|------|-------------------|
| 📄 文档上传 | 立即返回上传成功，后台解析文档内容 |
| 🔢 Embedding 生成 | 快速响应用户，后台批量生成向量 |
| 💬 对话记录 | 不阻塞对话流程，异步保存到数据库 |
| 📧 通知发送 | API 快速返回，后台发送邮件/webhook |
| 📊 日志分析 | 实时响应请求，后台记录详细日志 |

---

## 前置知识

学习本知识点前，建议先掌握：

- ✅ Python 异步编程（async/await）
- ✅ FastAPI 路由与依赖注入
- ✅ 请求-响应生命周期
- ✅ Express 中间件概念（可选，帮助类比）

---

## 学习路径

```
后台任务基础
    ↓
BackgroundTasks API
    ↓
任务队列对比（何时用 Celery）
    ↓
生产环境最佳实践
    ↓
AI Agent 实战应用
```

---

## 快速预览

### 最简单的后台任务

```python
from fastapi import FastAPI, BackgroundTasks

app = FastAPI()

def send_email(email: str, message: str):
    """后台任务：发送邮件"""
    print(f"发送邮件到 {email}: {message}")
    # 实际的邮件发送逻辑

@app.post("/register")
async def register(email: str, background_tasks: BackgroundTasks):
    # 立即返回响应
    background_tasks.add_task(send_email, email, "欢迎注册！")
    return {"message": "注册成功"}
```

**关键点：**
- 响应立即返回
- 邮件在后台发送
- 用户无需等待

---

## 下一步

完成本知识点后，建议学习：

- → **流式响应**（实时输出 AI 生成内容）
- → **中间件系统**（请求拦截和日志记录）
- → **长任务处理**（Phase5 - 使用 Celery 处理长时间任务）

---

**版本：** v1.0
**最后更新：** 2026-02-11
