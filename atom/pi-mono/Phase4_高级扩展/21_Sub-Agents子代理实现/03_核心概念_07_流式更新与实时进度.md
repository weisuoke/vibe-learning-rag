# 核心概念 07：流式更新与实时进度

## 1. 流式更新机制

### 1.1 onUpdate 回调

**Sub-Agent 通过 `onUpdate` 回调提供实时进度。**

```typescript
async execute(toolCallId, params, signal, onUpdate, ctx) {
  // 定义更新函数
  const emitUpdate = () => {
    if (onUpdate) {
      onUpdate({
        content: [{ type: "text", text: currentOutput }],
        details: { mode: "single", results: [currentResult] }
      });
    }
  };

  // 在关键节点调用
  proc.stdout.on('data', () => {
    processEvent(event);
    emitUpdate();  // 实时更新
  });
}
```

### 1.2 更新时机

**何时触发更新**：
- `message_end` 事件：Assistant 消息完成
- `tool_result_end` 事件：工具调用结果
- 每个事件处理后立即更新

```typescript
if (event.type === "message_end") {
  currentResult.messages.push(event.message);
  currentResult.usage.turns++;
  emitUpdate();  // 立即更新
}
```

---

## 2. 进度显示

### 2.1 Single Mode 进度

```typescript
// 初始状态
"(running...)"

// 有输出后
"Found authentication code in src/auth.ts..."

// 完成后
"Found authentication code in src/auth.ts
- Functions: login(), verify(), refresh()
- Technology: JWT tokens"
```

### 2.2 Parallel Mode 进度

```typescript
// 运行中
"Parallel: 2/3 done, 1 running..."

// 完成后
"Parallel: 3/3 succeeded

[scout] completed: Found frontend code...
[scout] completed: Found backend code...
[scout] completed: Found database code..."
```

### 2.3 Chain Mode 进度

```typescript
// Step 1 运行中
"Chain: Step 1/3 (scout) running..."

// Step 1 完成，Step 2 运行中
"Chain: Step 2/3 (planner) running..."

// 全部完成
"Chain: 3/3 steps completed"
```

---

## 3. Usage 追踪

### 3.1 实时 Usage 更新

```typescript
// 每个 message_end 事件更新 usage
if (msg.role === "assistant") {
  currentResult.usage.turns++;
  currentResult.usage.input += usage.input || 0;
  currentResult.usage.output += usage.output || 0;
  currentResult.usage.cacheRead += usage.cacheRead || 0;
  currentResult.usage.cacheWrite += usage.cacheWrite || 0;
  currentResult.usage.cost += usage.cost?.total || 0;
  currentResult.usage.contextTokens = usage.totalTokens || 0;
}
```

### 3.2 Usage 格式化

```typescript
function formatUsageStats(usage, model) {
  const parts = [];
  if (usage.turns) parts.push(`${usage.turns} turn${usage.turns > 1 ? "s" : ""}`);
  if (usage.input) parts.push(`↑${formatTokens(usage.input)}`);
  if (usage.output) parts.push(`↓${formatTokens(usage.output)}`);
  if (usage.cacheRead) parts.push(`R${formatTokens(usage.cacheRead)}`);
  if (usage.cacheWrite) parts.push(`W${formatTokens(usage.cacheWrite)}`);
  if (usage.cost) parts.push(`$${usage.cost.toFixed(4)}`);
  if (model) parts.push(model);
  return parts.join(" ");
}

// 输出示例
"3 turns ↑5.2k ↓1.8k R10k W2k $0.0234 claude-sonnet-4"
```

---

## 4. Tool Call 格式化

### 4.1 工具调用显示

```typescript
// bash
"$ grep -r 'auth' src/"

// read
"read ~/project/src/auth.ts:10-50"

// write
"write ~/project/src/new.ts (45 lines)"

// grep
"grep /pattern/ in ~/project/src"
```

### 4.2 路径缩短

```typescript
function shortenPath(p: string) {
  const home = os.homedir();
  return p.startsWith(home) ? `~${p.slice(home.length)}` : p;
}

// /Users/username/project/src/auth.ts
// → ~/project/src/auth.ts
```

---

## 5. UI 渲染模式

### 5.1 Collapsed View（默认）

**显示最后 10 个项目**：

```typescript
const COLLAPSED_ITEM_COUNT = 10;

// 如果项目 > 10
if (items.length > COLLAPSED_ITEM_COUNT) {
  const toShow = items.slice(-COLLAPSED_ITEM_COUNT);
  const skipped = items.length - COLLAPSED_ITEM_COUNT;
  text += `... ${skipped} earlier items\n`;
  // 显示最后 10 个
}
```

**输出示例**：
```
✓ scout (user)
... 5 earlier items
→ read src/auth.ts
→ grep /login/ in src/
Found authentication code...
(Ctrl+O to expand)
3 turns ↑5k ↓2k $0.01 claude-haiku-4-5
```

### 5.2 Expanded View（Ctrl+O）

**显示所有项目**：

```typescript
// 完整任务描述
"─── Task ───"
"Find all authentication code in src/"

// 所有工具调用
"→ grep /auth/ in src/"
"→ read src/auth.ts"
"→ read src/token.ts"

// 完整输出（Markdown 渲染）
"─── Output ───"
[Markdown rendered output]

// Usage 统计
"3 turns ↑5k ↓2k $0.01 claude-haiku-4-5"
```

---

## 6. Parallel Mode 流式更新

### 6.1 并发更新

**所有任务同时流式更新**：

```typescript
// 初始化占位符
const allResults = new Array(tasks.length);
for (let i = 0; i < tasks.length; i++) {
  allResults[i] = {
    agent: tasks[i].agent,
    exitCode: -1,  // -1 = 运行中
    messages: [],
    usage: { ... }
  };
}

// 每个任务更新时
const emitParallelUpdate = () => {
  const running = allResults.filter(r => r.exitCode === -1).length;
  const done = allResults.filter(r => r.exitCode !== -1).length;
  onUpdate({
    content: [{ type: "text", text: `Parallel: ${done}/${total} done, ${running} running...` }],
    details: { mode: "parallel", results: [...allResults] }
  });
};
```

### 6.2 状态图标

```typescript
// 运行中
"⏳ scout (running...)"

// 完成
"✓ scout (completed)"

// 失败
"✗ scout (failed)"
```

---

## 7. Chain Mode 流式更新

### 7.1 步骤进度

```typescript
// 当前步骤更新
const chainUpdate = (partial) => {
  const currentResult = partial.details?.results[0];
  if (currentResult) {
    const allResults = [...completedResults, currentResult];
    onUpdate({
      content: partial.content,
      details: { mode: "chain", results: allResults }
    });
  }
};
```

### 7.2 步骤显示

```
─── Step 1: scout ✓
Task: Find authentication code
→ grep /auth/ in src/
Found auth code in src/auth.ts

─── Step 2: planner ⏳
Task: Based on Found auth code..., create plan
(running...)
```

---

## 8. 性能考虑

### 8.1 更新频率

```typescript
// 每个事件都更新（高频）
proc.stdout.on('data', () => {
  processEvent(event);
  emitUpdate();  // 每次都更新
});

// 优化：节流更新（未来）
let lastUpdate = 0;
const throttle = 100;  // 100ms

const emitUpdate = () => {
  const now = Date.now();
  if (now - lastUpdate > throttle) {
    onUpdate(...);
    lastUpdate = now;
  }
};
```

### 8.2 数据量控制

```typescript
// Collapsed view：限制显示项目
const COLLAPSED_ITEM_COUNT = 10;

// 避免传递过多数据
const displayItems = getDisplayItems(messages).slice(-10);
```

---

## 9. 错误状态显示

### 9.1 错误图标

```typescript
// 成功
"✓ scout (user)"

// 失败
"✗ scout (user) [error]"
"Error: API rate limit exceeded"
```

### 9.2 停止原因

```typescript
if (stopReason === "error") {
  text += ` ${theme.fg("error", "[error]")}`;
}
if (stopReason === "aborted") {
  text += ` ${theme.fg("warning", "[aborted]")}`;
}
```

---

## 10. 最佳实践

### 10.1 提供有意义的进度

```typescript
// ✅ 好：具体的进度信息
"Found 5 files, analyzing..."
"Processing file 3/5..."
"Generating plan..."

// ❌ 不好：无意义的进度
"Working..."
"Please wait..."
```

### 10.2 及时更新

```typescript
// ✅ 好：每个关键事件都更新
proc.stdout.on('data', () => {
  processEvent(event);
  emitUpdate();  // 立即更新
});

// ❌ 不好：只在最后更新
// 用户看不到进度
```

### 10.3 清晰的状态指示

```typescript
// ✅ 好：清晰的状态
"Parallel: 2/3 done, 1 running..."
"Chain: Step 2/3 (planner) running..."

// ❌ 不好：模糊的状态
"Processing..."
```

---

## 11. 总结

### 核心要点

1. **onUpdate 回调**：实时进度更新
2. **事件驱动**：每个事件触发更新
3. **Usage 追踪**：实时显示 tokens 和成本
4. **Tool Call 格式化**：清晰显示工具调用
5. **两种视图**：Collapsed（默认）和 Expanded

### 关键洞察

- **实时 = 体验**：流式更新提升用户体验
- **格式化 = 可读**：清晰的格式化提高可读性
- **状态 = 透明**：清晰的状态指示增加透明度
- **性能 = 平衡**：更新频率与性能的平衡

---

**参考资源**：
- [Pi-mono Extension API 文档](https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent/docs/extensions.md)
- [Pi-tui 渲染系统](https://github.com/badlogic/pi-mono/tree/main/packages/pi-tui)
