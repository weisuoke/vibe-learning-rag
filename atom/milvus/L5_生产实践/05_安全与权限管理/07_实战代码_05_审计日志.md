# 实战代码5：审计日志

**完整的审计日志系统，记录和追踪所有安全相关操作。**

---

## 场景说明

**目标：** 实现完整的审计日志系统：
- 记录所有认证和授权事件
- 追踪数据访问操作
- 异常行为检测
- 合规审计报告

**适用场景：**
- 金融/医疗等合规行业
- 安全事件调查
- 用户行为分析

---

## 完整代码

```python
"""
审计日志系统
演示：完整的安全审计和监控实现
"""

import os
import json
import logging
from typing import List, Dict, Optional
from datetime import datetime, timedelta
from pymilvus import connections, utility, Collection
from dotenv import load_dotenv

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


# ===== 1. 审计日志记录器 =====

class AuditLogger:
    """审计日志记录器"""

    def __init__(self, log_file: str = "milvus_audit.log"):
        self.log_file = log_file
        self.logger = logging.getLogger("AuditLogger")

        # 配置文件日志
        file_handler = logging.FileHandler(log_file)
        file_handler.setFormatter(
            logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
        )
        self.logger.addHandler(file_handler)

    def log_authentication(self, username: str, success: bool, ip: str = "unknown"):
        """记录认证事件"""
        event = {
            "event_type": "AUTHENTICATION",
            "timestamp": datetime.now().isoformat(),
            "username": username,
            "success": success,
            "ip_address": ip
        }
        self.logger.info(json.dumps(event))

    def log_authorization(self, username: str, action: str, resource: str, success: bool):
        """记录授权事件"""
        event = {
            "event_type": "AUTHORIZATION",
            "timestamp": datetime.now().isoformat(),
            "username": username,
            "action": action,
            "resource": resource,
            "success": success
        }
        self.logger.info(json.dumps(event))

    def log_data_access(self, username: str, operation: str, collection: str, count: int):
        """记录数据访问"""
        event = {
            "event_type": "DATA_ACCESS",
            "timestamp": datetime.now().isoformat(),
            "username": username,
            "operation": operation,
            "collection": collection,
            "record_count": count
        }
        self.logger.info(json.dumps(event))

    def log_security_event(self, event_type: str, details: Dict):
        """记录安全事件"""
        event = {
            "event_type": event_type,
            "timestamp": datetime.now().isoformat(),
            **details
        }
        self.logger.warning(json.dumps(event))


# ===== 2. 审计日志分析器 =====

class AuditAnalyzer:
    """审计日志分析器"""

    def __init__(self, log_file: str = "milvus_audit.log"):
        self.log_file = log_file
        self.logger = logging.getLogger("AuditAnalyzer")

    def parse_logs(self) -> List[Dict]:
        """解析日志文件"""
        events = []
        try:
            with open(self.log_file, 'r') as f:
                for line in f:
                    try:
                        # 提取 JSON 部分
                        json_start = line.find('{')
                        if json_start != -1:
                            event = json.loads(line[json_start:])
                            events.append(event)
                    except json.JSONDecodeError:
                        continue
        except FileNotFoundError:
            self.logger.warning(f"日志文件不存在：{self.log_file}")

        return events

    def detect_failed_logins(self, threshold: int = 5, window_minutes: int = 10) -> List[Dict]:
        """检测失败登录攻击"""
        events = self.parse_logs()
        failed_logins = {}

        for event in events:
            if event.get("event_type") == "AUTHENTICATION" and not event.get("success"):
                username = event["username"]
                timestamp = datetime.fromisoformat(event["timestamp"])

                if username not in failed_logins:
                    failed_logins[username] = []

                failed_logins[username].append(timestamp)

        # 检测异常
        alerts = []
        for username, timestamps in failed_logins.items():
            # 检查时间窗口内的失败次数
            recent = [t for t in timestamps if datetime.now() - t < timedelta(minutes=window_minutes)]
            if len(recent) >= threshold:
                alerts.append({
                    "alert_type": "BRUTE_FORCE_ATTACK",
                    "username": username,
                    "failed_attempts": len(recent),
                    "time_window": f"{window_minutes} minutes"
                })

        return alerts

    def detect_unusual_access(self) -> List[Dict]:
        """检测异常访问模式"""
        events = self.parse_logs()
        alerts = []

        # 检测深夜访问
        for event in events:
            if event.get("event_type") == "DATA_ACCESS":
                timestamp = datetime.fromisoformat(event["timestamp"])
                hour = timestamp.hour

                # 深夜访问（0-6点）
                if 0 <= hour < 6:
                    alerts.append({
                        "alert_type": "UNUSUAL_TIME_ACCESS",
                        "username": event["username"],
                        "time": timestamp.isoformat(),
                        "operation": event["operation"]
                    })

        return alerts

    def generate_report(self, start_date: datetime, end_date: datetime) -> Dict:
        """生成审计报告"""
        events = self.parse_logs()

        # 过滤时间范围
        filtered = [
            e for e in events
            if start_date <= datetime.fromisoformat(e["timestamp"]) <= end_date
        ]

        # 统计
        report = {
            "period": {
                "start": start_date.isoformat(),
                "end": end_date.isoformat()
            },
            "total_events": len(filtered),
            "authentication": {
                "total": 0,
                "success": 0,
                "failed": 0
            },
            "data_access": {
                "total": 0,
                "by_operation": {}
            },
            "top_users": {}
        }

        for event in filtered:
            event_type = event.get("event_type")

            if event_type == "AUTHENTICATION":
                report["authentication"]["total"] += 1
                if event.get("success"):
                    report["authentication"]["success"] += 1
                else:
                    report["authentication"]["failed"] += 1

            elif event_type == "DATA_ACCESS":
                report["data_access"]["total"] += 1
                operation = event.get("operation", "unknown")
                report["data_access"]["by_operation"][operation] = \
                    report["data_access"]["by_operation"].get(operation, 0) + 1

                # 统计用户活动
                username = event.get("username")
                report["top_users"][username] = report["top_users"].get(username, 0) + 1

        return report


# ===== 3. 带审计的 RAG 系统 =====

class AuditedRAGSystem:
    """带审计的 RAG 系统"""

    def __init__(self, username: str, password: str):
        self.username = username
        self.audit_logger = AuditLogger()
        self.logger = logging.getLogger("AuditedRAG")

        # 连接并记录
        try:
            connections.connect(
                alias="default",
                host=os.getenv("MILVUS_HOST", "localhost"),
                port=os.getenv("MILVUS_PORT", "19530"),
                user=username,
                password=password
            )
            self.audit_logger.log_authentication(username, True)
            self.logger.info(f"✅ 用户 {username} 登录成功")

        except Exception as e:
            self.audit_logger.log_authentication(username, False)
            self.logger.error(f"❌ 用户 {username} 登录失败：{e}")
            raise

    def search(self, collection_name: str, query_vector: List[float], limit: int = 10):
        """搜索（带审计）"""
        try:
            # 记录授权检查
            self.audit_logger.log_authorization(
                self.username, "SEARCH", collection_name, True
            )

            # 执行搜索
            collection = Collection(collection_name)
            collection.load()

            results = collection.search(
                data=[query_vector],
                anns_field="embedding",
                param={"metric_type": "L2", "params": {"nprobe": 10}},
                limit=limit
            )

            # 记录数据访问
            self.audit_logger.log_data_access(
                self.username, "SEARCH", collection_name, len(results[0])
            )

            self.logger.info(f"✅ 搜索完成，返回 {len(results[0])} 条结果")
            return results[0]

        except Exception as e:
            # 记录失败
            self.audit_logger.log_authorization(
                self.username, "SEARCH", collection_name, False
            )
            self.logger.error(f"❌ 搜索失败：{e}")
            return []

    def insert(self, collection_name: str, data: List):
        """插入（带审计）"""
        try:
            self.audit_logger.log_authorization(
                self.username, "INSERT", collection_name, True
            )

            collection = Collection(collection_name)
            collection.insert(data)

            self.audit_logger.log_data_access(
                self.username, "INSERT", collection_name, len(data[0])
            )

            self.logger.info(f"✅ 插入 {len(data[0])} 条数据")

        except Exception as e:
            self.audit_logger.log_authorization(
                self.username, "INSERT", collection_name, False
            )
            self.logger.error(f"❌ 插入失败：{e}")


# ===== 4. 主程序 =====

def main():
    """主程序"""
    print("=" * 60)
    print("审计日志系统示例")
    print("=" * 60)

    load_dotenv()

    # 场景1：记录操作
    print("\n【场景1：记录操作】")
    audit_logger = AuditLogger()

    # 模拟一些事件
    audit_logger.log_authentication("user1", True, "192.168.1.100")
    audit_logger.log_authentication("user2", False, "203.0.113.1")
    audit_logger.log_data_access("user1", "SEARCH", "docs", 10)

    # 场景2：分析日志
    print("\n【场景2：分析日志】")
    analyzer = AuditAnalyzer()

    # 检测失败登录
    alerts = analyzer.detect_failed_logins(threshold=3)
    if alerts:
        print(f"⚠️ 检测到 {len(alerts)} 个暴力破解攻击")
        for alert in alerts:
            print(f"  - 用户：{alert['username']}, 失败次数：{alert['failed_attempts']}")

    # 检测异常访问
    unusual = analyzer.detect_unusual_access()
    if unusual:
        print(f"⚠️ 检测到 {len(unusual)} 个异常访问")

    # 场景3：生成报告
    print("\n【场景3：生成审计报告】")
    report = analyzer.generate_report(
        start_date=datetime.now() - timedelta(days=7),
        end_date=datetime.now()
    )

    print(f"总事件数：{report['total_events']}")
    print(f"认证成功：{report['authentication']['success']}")
    print(f"认证失败：{report['authentication']['failed']}")
    print(f"数据访问：{report['data_access']['total']}")

    print("\n" + "=" * 60)
    print("审计日志系统演示完成")
    print("=" * 60)


if __name__ == "__main__":
    main()
```

---

## 运行输出示例

```
============================================================
审计日志系统示例
============================================================

【场景1：记录操作】
2025-02-10 14:00:00 - INFO - {"event_type": "AUTHENTICATION", "timestamp": "2025-02-10T14:00:00", "username": "user1", "success": true, "ip_address": "192.168.1.100"}
2025-02-10 14:00:01 - INFO - {"event_type": "AUTHENTICATION", "timestamp": "2025-02-10T14:00:01", "username": "user2", "success": false, "ip_address": "203.0.113.1"}
2025-02-10 14:00:02 - INFO - {"event_type": "DATA_ACCESS", "timestamp": "2025-02-10T14:00:02", "username": "user1", "operation": "SEARCH", "collection": "docs", "record_count": 10}

【场景2：分析日志】
⚠️ 检测到 1 个暴力破解攻击
  - 用户：hacker, 失败次数：5

【场景3：生成审计报告】
总事件数：156
认证成功：142
认证失败：14
数据访问：98

============================================================
审计日志系统演示完成
============================================================
```

---

## 关键特性

### 1. 完整的事件记录

```python
# 记录所有安全相关事件
audit_logger.log_authentication(username, success, ip)
audit_logger.log_authorization(username, action, resource, success)
audit_logger.log_data_access(username, operation, collection, count)
```

### 2. 异常检测

```python
# 检测暴力破解攻击
alerts = analyzer.detect_failed_logins(threshold=5)

# 检测异常访问模式
unusual = analyzer.detect_unusual_access()
```

### 3. 审计报告

```python
# 生成合规审计报告
report = analyzer.generate_report(start_date, end_date)
```

---

## 小结

**本示例展示了：**

1. ✅ 完整的审计日志系统
2. ✅ 异常行为检测
3. ✅ 审计报告生成
4. ✅ 与 RAG 系统集成

**下一步：** 生成概览文档
