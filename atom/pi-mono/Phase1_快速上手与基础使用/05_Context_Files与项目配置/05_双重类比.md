# 双重类比

> 通过 TypeScript/Node.js 开发类比 + 日常生活类比，深入理解 Context Files 的工作原理

---

## 类比一：AGENTS.md = package.json + README.md

### TypeScript/Node.js 类比

```typescript
// AGENTS.md 就像 package.json 的 "scripts" 和 README 的结合体

// package.json - 定义项目元数据和命令
{
  "name": "my-project",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "test": "vitest"
  }
}

// README.md - 说明项目规范和约定
# 项目规范
- 使用 TypeScript
- 组件放在 src/components/
- 遵循 ESLint 规则

// AGENTS.md = package.json scripts + README 规范
// Pi Agent 读取 AGENTS.md 就像开发者读取 README
```

**相似点：**
- 都是项目的"说明书"
- 都告诉使用者"如何正确使用这个项目"
- 都是纯文本，易于版本控制

**不同点：**
- package.json 是机器可执行的（npm run）
- AGENTS.md 是给 AI 读的"自然语言说明书"

### 日常生活类比

**AGENTS.md = 新员工入职手册**

```
入职手册内容：
- 公司规章制度（代码规范）
- 部门工作流程（开发流程）
- 常用工具和系统（命令和工具）
- 注意事项（禁止操作）

新员工（Pi Agent）读完手册后：
✓ 知道如何正确工作
✓ 了解团队约定
✓ 避免常见错误
```

---

## 类比二：settings.json = tsconfig.json + .vscode/settings.json

### TypeScript/Node.js 类比

```typescript
// tsconfig.json - TypeScript 编译器配置
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "strict": true
  }
}

// .vscode/settings.json - VS Code 编辑器配置
{
  "editor.formatOnSave": true,
  "editor.tabSize": 2,
  "typescript.preferences.importModuleSpecifier": "relative"
}

// .pi/settings.json - Pi Agent 配置
{
  "defaultModel": "claude-opus-4",  // 类似 tsconfig 的 target
  "theme": "dark",                   // 类似 VS Code 的 editor 配置
  "compaction.enabled": true         // 类似编译器优化选项
}
```

**配置覆盖机制类比：**

```typescript
// TypeScript 配置继承
// tsconfig.base.json (全局)
{
  "compilerOptions": {
    "strict": true,
    "target": "ES2020"
  }
}

// tsconfig.json (项目级，继承并覆盖)
{
  "extends": "./tsconfig.base.json",
  "compilerOptions": {
    "target": "ES2022"  // 覆盖全局的 ES2020
  }
}

// Pi Agent 配置继承
// ~/.pi/agent/settings.json (全局)
{
  "defaultModel": "claude-sonnet-4",
  "theme": "dark"
}

// .pi/settings.json (项目级，覆盖全局)
{
  "defaultModel": "claude-opus-4"  // 覆盖全局的 sonnet
  // theme 继承全局的 "dark"
}
```

### 日常生活类比

**settings.json = 手机的"设置"应用**

```
全局设置（~/.pi/agent/settings.json）：
- 系统级设置（所有 App 生效）
- 例如：深色模式、字体大小、语言

项目设置（.pi/settings.json）：
- App 级设置（只在当前 App 生效）
- 例如：微信的聊天背景、抖音的推荐偏好

覆盖规则：
App 设置 > 系统设置
项目配置 > 全局配置
```

---

## 类比三：SYSTEM.md = ESLint 规则 + 代码审查标准

### TypeScript/Node.js 类比

```typescript
// .eslintrc.json - 定义代码风格和规则
{
  "rules": {
    "no-console": "error",           // 禁止 console.log
    "prefer-const": "warn",          // 优先使用 const
    "@typescript-eslint/no-explicit-any": "error"  // 禁止 any
  }
}

// SYSTEM.md - 定义 AI 的工作风格和规则
# 代码风格
- 禁止使用 any 类型
- 优先使用函数式编程
- 所有函数必须有类型注解

# 工作准则
- 代码优先，少说多做
- 遵循 SOLID 原则
```

**相似点：**
- 都是"行为约束"
- 都定义"什么可以做，什么不能做"
- 都影响输出的质量和风格

### 日常生活类比

**SYSTEM.md = 厨师的"菜谱风格"**

```
默认厨师（无 SYSTEM.md）：
- 中规中矩，按标准菜谱做菜
- 适合大多数场景

自定义厨师（有 SYSTEM.md）：
- 川菜厨师：重辣、重油、重麻
- 粤菜厨师：清淡、原味、精致
- 西餐厨师：黄油、奶油、烤制

SYSTEM.md 就是告诉 AI：
"你是一个什么风格的开发者？"
```

---

## 类比四：配置加载顺序 = Node.js 模块解析

### TypeScript/Node.js 类比

```typescript
// Node.js 模块解析顺序（require('lodash')）
1. 当前目录的 node_modules/lodash
2. 父目录的 node_modules/lodash
3. 祖父目录的 node_modules/lodash
4. ... 一直到根目录
5. 全局 node_modules

// Pi Agent 配置加载顺序
1. 当前目录的 AGENTS.md
2. 父目录的 AGENTS.md
3. 祖父目录的 AGENTS.md
4. ... 一直到根目录
5. 全局 ~/.pi/agent/AGENTS.md

// 关键区别：
// Node.js: 找到第一个就停止（覆盖）
// Pi Agent: 找到所有文件并合并（累加）
```

**代码示例：**

```typescript
// 模拟 Pi Agent 的配置加载
function loadAgentsFiles(currentDir: string): string[] {
  const files: string[] = [];
  let dir = currentDir;

  // 从当前目录向上查找
  while (dir !== '/') {
    const agentsPath = path.join(dir, 'AGENTS.md');
    if (fs.existsSync(agentsPath)) {
      files.unshift(agentsPath);  // 添加到开头（父目录优先）
    }
    dir = path.dirname(dir);
  }

  // 添加全局配置
  const globalAgents = path.join(os.homedir(), '.pi/agent/AGENTS.md');
  if (fs.existsSync(globalAgents)) {
    files.unshift(globalAgents);
  }

  return files;
}

// 使用示例
const agentsFiles = loadAgentsFiles('/home/user/projects/my-app/src');
// 返回: [
//   '/home/user/.pi/agent/AGENTS.md',      // 全局
//   '/home/user/projects/AGENTS.md',       // 项目根
//   '/home/user/projects/my-app/AGENTS.md' // 子项目
// ]

// Pi Agent 会按顺序读取并合并所有文件
const mergedContent = agentsFiles.map(f => fs.readFileSync(f, 'utf-8')).join('\n\n');
```

### 日常生活类比

**配置加载 = 穿衣服的顺序**

```
全局配置（内衣）：
- 最底层，所有场景都需要
- ~/.pi/agent/AGENTS.md

父目录配置（衬衫）：
- 中间层，项目通用规范
- /projects/AGENTS.md

当前目录配置（外套）：
- 最外层，特定场景规则
- /projects/my-app/AGENTS.md

最终效果：
内衣 + 衬衫 + 外套 = 完整的配置
（所有层级的配置都生效，不是覆盖）
```

---

## 类比五：Context Files 生态 = npm 包管理

### TypeScript/Node.js 类比

```typescript
// npm 包管理生态
package.json          → 项目依赖声明
node_modules/         → 安装的包
.npmrc                → npm 配置
package-lock.json     → 锁定版本

// Pi Agent 配置生态
AGENTS.md             → 项目规范声明
.pi/settings.json     → Pi 配置
SYSTEM.md             → AI 行为定义
.pi/skills/           → 自定义技能（类似 npm 包）
```

**依赖管理类比：**

```typescript
// package.json - 声明依赖
{
  "dependencies": {
    "react": "^18.0.0",
    "lodash": "^4.17.21"
  }
}

// AGENTS.md - 声明项目依赖和规范
# 技术栈
- React 18
- TypeScript 5
- Vite 5

# 依赖的工具
- ESLint
- Prettier
- Vitest
```

### 日常生活类比

**Context Files = 装修房子的"设计方案"**

```
AGENTS.md = 装修需求清单
- 风格：现代简约
- 功能：三室两厅
- 材料：环保材料

settings.json = 装修配置
- 预算：50万
- 工期：3个月
- 施工队：A队

SYSTEM.md = 设计师风格
- 设计理念：极简主义
- 色彩偏好：黑白灰
- 材质偏好：木质 + 金属

最终效果：
需求 + 配置 + 风格 = 完美的家
```

---

## 类比六：热重载机制 = Vite HMR

### TypeScript/Node.js 类比

```typescript
// Vite HMR (Hot Module Replacement)
// 修改代码后，浏览器自动更新，无需刷新

// 1. 修改组件
// src/App.tsx
export function App() {
  return <div>Hello World</div>;  // 修改这里
}

// 2. Vite 检测到变化
// 3. 浏览器自动更新（无需 F5）

// Pi Agent 热重载
// 1. 修改 AGENTS.md
echo "新规则" >> AGENTS.md

// 2. 在 Pi 中执行
/reload

// 3. Pi Agent 重新加载配置（无需重启）
```

**对比：**

| 特性 | Vite HMR | Pi Agent /reload |
|------|----------|------------------|
| 触发方式 | 自动检测文件变化 | 手动执行 /reload |
| 重载速度 | 毫秒级 | 秒级 |
| 保留状态 | 保留组件状态 | 保留对话历史 |
| 使用场景 | 开发时实时预览 | 调试配置文件 |

### 日常生活类比

**热重载 = 换衣服**

```
冷重载（重启 Pi）：
- 脱光所有衣服
- 重新穿一套
- 耗时长，体验差

热重载（/reload）：
- 只换外套（AGENTS.md）
- 内衣和衬衫不动（对话历史）
- 快速，体验好
```

---

## 总结对照表

| Context Files | TypeScript/Node.js 类比 | 日常生活类比 |
|---------------|-------------------------|--------------|
| **AGENTS.md** | package.json + README | 新员工入职手册 |
| **settings.json** | tsconfig.json + .vscode/settings.json | 手机设置应用 |
| **SYSTEM.md** | .eslintrc.json | 厨师的菜谱风格 |
| **配置加载** | Node.js 模块解析 | 穿衣服的顺序 |
| **配置生态** | npm 包管理 | 装修设计方案 |
| **热重载** | Vite HMR | 换衣服 |

---

**记住：** Context Files 就像给 Pi Agent 配置"开发环境"，让它像一个熟悉项目的老员工一样工作！
