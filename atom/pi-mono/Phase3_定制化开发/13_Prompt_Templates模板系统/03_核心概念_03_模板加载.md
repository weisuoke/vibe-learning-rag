# 核心概念 03: 模板加载

## 概述

模板加载是 Pi-mono Prompt Templates 系统的核心机制。Pi-mono 采用基于文件系统的多源加载机制，支持全局模板和项目模板，具有明确的优先级顺序。

---

## 文件系统加载机制

### 加载路径

Pi-mono 从以下位置加载模板：

1. **项目模板**：`./.pi/prompts/` （优先级：高）
2. **全局模板**：`~/.pi/agent/prompts/` （优先级：中）
3. **显式路径**：通过 CLI 或配置指定（优先级：低）

### 加载顺序

```
调用 /template-name
    ↓
1. 搜索 ./.pi/prompts/template-name.md
    ↓ 未找到
2. 搜索 ~/.pi/agent/prompts/template-name.md
    ↓ 未找到
3. 搜索显式路径（如果指定）
    ↓ 未找到
4. 返回错误：模板不存在
```

---

## 源码实现分析

根据 pi-mono 源码（`packages/coding-agent/src/core/prompt-templates.ts`）：

```typescript
async function loadPromptTemplates(options: LoadOptions): Promise<PromptTemplate[]> {
  const templates: PromptTemplate[] = [];

  // 1. 加载项目模板
  const projectDir = path.join(process.cwd(), '.pi', 'prompts');
  if (fs.existsSync(projectDir)) {
    templates.push(...await loadFromDirectory(projectDir, 'project'));
  }

  // 2. 加载全局模板
  const globalDir = path.join(os.homedir(), '.pi', 'agent', 'prompts');
  if (fs.existsSync(globalDir)) {
    templates.push(...await loadFromDirectory(globalDir, 'global'));
  }

  // 3. 去重（项目模板优先）
  return deduplicateTemplates(templates);
}

function deduplicateTemplates(templates: PromptTemplate[]): PromptTemplate[] {
  const seen = new Set<string>();
  return templates.filter(t => {
    if (seen.has(t.name)) return false;
    seen.add(t.name);
    return true;
  });
}
```

**关键点：**
1. 先加载项目模板，再加载全局模板
2. 通过去重确保项目模板优先
3. 模板名称 = 文件名（不含 `.md` 扩展名）

---

## 模板发现机制

### 文件扫描

```typescript
async function loadFromDirectory(dir: string, source: string): Promise<PromptTemplate[]> {
  const files = fs.readdirSync(dir);
  const templates: PromptTemplate[] = [];

  for (const file of files) {
    // 只处理 .md 文件
    if (!file.endsWith('.md')) continue;

    const filePath = path.join(dir, file);
    const content = fs.readFileSync(filePath, 'utf-8');

    // 解析 frontmatter
    const { frontmatter, body } = parseFrontmatter(content);

    // 创建模板对象
    templates.push({
      name: file.replace(/\.md$/, ''),
      description: frontmatter.description || '',
      content: body,
      source,
      filePath
    });
  }

  return templates;
}
```

**特点：**
- 非递归扫描（不支持子目录）
- 只处理 `.md` 文件
- 自动解析 YAML frontmatter

---

## 实际应用场景

### 场景 1: 个人使用（全局模板）

```bash
# 创建全局模板
mkdir -p ~/.pi/agent/prompts
cat > ~/.pi/agent/prompts/review.md << 'EOF'
---
description: Code review template
---
Review code: $1
EOF

# 在任何项目中使用
cd ~/projects/project-a
pi
/review src/utils.ts

cd ~/projects/project-b
pi
/review src/services.ts
```

---

### 场景 2: 团队协作（项目模板）

```bash
# 在项目中创建团队模板
cd ~/projects/team-project
mkdir -p .pi/prompts
cat > .pi/prompts/team-review.md << 'EOF'
---
description: Team code review with standards
---
Review code following team standards: $1
EOF

# 提交到 Git
git add .pi/prompts/
git commit -m "Add team review template"
git push

# 团队成员拉取后直接使用
git pull
pi
/team-review src/feature.ts
```

---

### 场景 3: 模板覆盖

```bash
# 全局模板
cat > ~/.pi/agent/prompts/test.md << 'EOF'
Global template
EOF

# 项目模板（同名）
cat > .pi/prompts/test.md << 'EOF'
Project template (overrides global)
EOF

# 使用模板
pi
/test
# 输出: "Project template (overrides global)"
```

---

## 最佳实践

### 1. 全局模板用于通用场景

```bash
~/.pi/agent/prompts/
├── review.md          # 通用代码审查
├── test.md            # 通用测试生成
├── docs.md            # 通用文档生成
└── refactor.md        # 通用重构建议
```

### 2. 项目模板用于特定场景

```bash
.pi/prompts/
├── team-review.md     # 团队代码审查标准
├── api-test.md        # API 测试规范
├── component-docs.md  # 组件文档格式
└── migration.md       # 项目迁移指南
```

### 3. 使用命名约定避免冲突

```bash
# 全局模板：通用名称
review.md
test.md

# 项目模板：带前缀
team-review.md
project-test.md
```

---

## 2025-2026 年最佳实践

根据社区实践：

### 1. 使用 Git 管理模板

**来源：** [GitHub: Awesome AI System Prompts](https://github.com/dontriskit/awesome-ai-system-prompts)

```bash
# 全局模板仓库
cd ~/.pi/agent/prompts
git init
git remote add origin https://github.com/user/pi-templates.git
git push -u origin main

# 团队成员克隆
git clone https://github.com/user/pi-templates.git ~/.pi/agent/prompts
```

### 2. 项目模板版本控制

**来源：** [Reddit: 生产环境演化提示模板管理](https://www.reddit.com/r/PromptEngineering/comments/1nwynw5/how_do_you_manage_dozens_of_evolving_prompts_in/)

```bash
# 项目模板纳入版本控制
git add .pi/prompts/
git commit -m "Update team templates"
```

---

## 总结

**模板加载的核心价值：**

1. **零配置** - 放文件就能用
2. **多源支持** - 全局 + 项目
3. **明确优先级** - 项目 > 全局
4. **版本控制友好** - 易于使用 Git 管理

---

**版本：** v1.0
**最后更新：** 2026-02-20
**维护者：** Claude Code
