# 核心概念4：负载均衡器集成

> Nginx、HAProxy、云服务负载均衡器的健康检查集成

---

## 概述

负载均衡器通过健康检查来决定是否将流量发送到后端服务。本文介绍如何与不同类型的负载均衡器集成。

---

## 1. 负载均衡器健康检查机制

### 1.1 工作原理

```
用户请求
  ↓
负载均衡器
  ↓ (定期健康检查)
  ├─→ 服务A (/health → 200) ✅ 发送流量
  ├─→ 服务B (/health → 503) ❌ 停止流量
  └─→ 服务C (/health → 超时) ❌ 停止流量
```

**关键特性：**
- **主动检查**：负载均衡器主动调用健康检查端点
- **定期轮询**：每隔几秒检查一次
- **自动切换**：健康检查失败 → 停止流量，恢复 → 恢复流量

### 1.2 健康检查参数

| 参数 | 说明 | 典型值 |
|------|------|--------|
| interval | 检查间隔 | 5-10秒 |
| timeout | 超时时间 | 3-5秒 |
| rise | 连续成功多少次标记为健康 | 2-3次 |
| fall | 连续失败多少次标记为不健康 | 2-3次 |

---

## 2. Nginx 集成

### 2.1 基础配置

**upstream 配置：**

```nginx
upstream ai_agent_api {
    # 后端服务列表
    server api1.example.com:8000;
    server api2.example.com:8000;
    server api3.example.com:8000;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://ai_agent_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 2.2 Nginx Plus 健康检查

**Nginx Plus（商业版）支持主动健康检查：**

```nginx
upstream ai_agent_api {
    zone ai_agent_api 64k;

    server api1.example.com:8000;
    server api2.example.com:8000;
    server api3.example.com:8000;
}

server {
    listen 80;

    location / {
        proxy_pass http://ai_agent_api;

        # 健康检查配置
        health_check uri=/health
                     interval=5s
                     fails=3
                     passes=2
                     match=health_ok;
    }
}

# 定义健康检查匹配条件
match health_ok {
    status 200;
    header Content-Type = "application/json";
    body ~ "\"status\":\"healthy\"";
}
```

### 2.3 Nginx 开源版被动健康检查

**Nginx 开源版只支持被动健康检查（通过实际请求判断）：**

```nginx
upstream ai_agent_api {
    server api1.example.com:8000 max_fails=3 fail_timeout=30s;
    server api2.example.com:8000 max_fails=3 fail_timeout=30s;
    server api3.example.com:8000 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;

    location / {
        proxy_pass http://ai_agent_api;

        # 超时配置
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 错误处理
        proxy_next_upstream error timeout http_500 http_502 http_503;
    }
}
```

**参数说明：**
- `max_fails=3`：连续失败 3 次标记为不健康
- `fail_timeout=30s`：标记为不健康后 30 秒内不发送流量
- `proxy_next_upstream`：遇到错误时尝试下一个服务器

### 2.4 使用第三方模块

**nginx-upstream-check-module（第三方模块）：**

```nginx
upstream ai_agent_api {
    server api1.example.com:8000;
    server api2.example.com:8000;
    server api3.example.com:8000;

    # 健康检查配置
    check interval=5000 rise=2 fall=3 timeout=3000 type=http;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx;
}

server {
    listen 80;

    # 健康检查状态页面
    location /nginx_status {
        check_status;
        access_log off;
    }

    location / {
        proxy_pass http://ai_agent_api;
    }
}
```

---

## 3. HAProxy 集成

### 3.1 基础配置

```haproxy
global
    log /dev/log local0
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http_front
    bind *:80
    default_backend ai_agent_api

backend ai_agent_api
    balance roundrobin

    # 健康检查配置
    option httpchk GET /health
    http-check expect status 200

    # 后端服务
    server api1 api1.example.com:8000 check inter 5s rise 2 fall 3
    server api2 api2.example.com:8000 check inter 5s rise 2 fall 3
    server api3 api3.example.com:8000 check inter 5s rise 2 fall 3
```

**参数说明：**
- `check`：启用健康检查
- `inter 5s`：每 5 秒检查一次
- `rise 2`：连续成功 2 次标记为健康
- `fall 3`：连续失败 3 次标记为不健康

### 3.2 高级健康检查

**检查响应内容：**

```haproxy
backend ai_agent_api
    balance roundrobin

    # 健康检查配置
    option httpchk GET /health
    http-check expect string "healthy"

    # 或者检查 JSON 响应
    http-check expect rstring "\"status\":\"healthy\""

    server api1 api1.example.com:8000 check inter 5s
    server api2 api2.example.com:8000 check inter 5s
    server api3 api3.example.com:8000 check inter 5s
```

**多步骤健康检查：**

```haproxy
backend ai_agent_api
    balance roundrobin

    # 多步骤健康检查
    option httpchk
    http-check send meth GET uri /health ver HTTP/1.1 hdr Host api.example.com
    http-check expect status 200
    http-check expect string "healthy"

    server api1 api1.example.com:8000 check inter 5s
    server api2 api2.example.com:8000 check inter 5s
    server api3 api3.example.com:8000 check inter 5s
```

### 3.3 健康检查状态页面

```haproxy
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
```

访问 `http://localhost:8404/stats` 查看健康检查状态。

---

## 4. 云服务负载均衡器

### 4.1 AWS Application Load Balancer (ALB)

**健康检查配置：**

```yaml
# Terraform 配置
resource "aws_lb_target_group" "ai_agent_api" {
  name     = "ai-agent-api"
  port     = 8000
  protocol = "HTTP"
  vpc_id   = aws_vpc.main.id

  health_check {
    enabled             = true
    path                = "/health"
    protocol            = "HTTP"
    port                = "traffic-port"
    healthy_threshold   = 2
    unhealthy_threshold = 3
    timeout             = 5
    interval            = 10
    matcher             = "200"
  }
}
```

**参数说明：**
- `path`：健康检查路径
- `healthy_threshold`：连续成功 2 次标记为健康
- `unhealthy_threshold`：连续失败 3 次标记为不健康
- `timeout`：超时时间 5 秒
- `interval`：检查间隔 10 秒
- `matcher`：期望的 HTTP 状态码

### 4.2 Google Cloud Load Balancer

**健康检查配置：**

```yaml
# gcloud 命令
gcloud compute health-checks create http ai-agent-health-check \
    --port=8000 \
    --request-path=/health \
    --check-interval=10s \
    --timeout=5s \
    --healthy-threshold=2 \
    --unhealthy-threshold=3
```

### 4.3 Azure Load Balancer

**健康检查配置：**

```json
{
  "name": "ai-agent-health-probe",
  "properties": {
    "protocol": "Http",
    "port": 8000,
    "requestPath": "/health",
    "intervalInSeconds": 10,
    "numberOfProbes": 3
  }
}
```

---

## 5. HTTP 状态码约定

### 5.1 标准状态码

| 状态码 | 含义 | 负载均衡器行为 |
|--------|------|----------------|
| 200 OK | 健康 | 继续发送流量 |
| 503 Service Unavailable | 不健康 | 停止发送流量 |
| 429 Too Many Requests | 过载 | 停止发送流量 |
| 500 Internal Server Error | 错误 | 停止发送流量 |

### 5.2 实现示例

```python
from fastapi import FastAPI, HTTPException, status

app = FastAPI()

@app.get("/health")
async def health():
    """健康检查端点"""
    # 检查服务状态
    if not is_service_healthy():
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Service unhealthy"
        )

    return {"status": "healthy"}

@app.get("/ready")
async def ready():
    """就绪检查端点"""
    checks = await check_all_dependencies()

    if not checks["database"]:
        # 数据库不可用 → 503
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Database unavailable"
        )

    if not all(checks.values()):
        # 部分依赖不可用 → 200 但标记为降级
        return {
            "status": "degraded",
            "checks": checks
        }

    return {
        "status": "healthy",
        "checks": checks
    }
```

---

## 6. 健康检查端点设计

### 6.1 /health vs /ready

**推荐设计：**

```python
# /health：用于 Liveness Probe
@app.get("/health")
async def health():
    """只检查进程是否响应"""
    return {"status": "healthy"}

# /ready：用于 Readiness Probe 和负载均衡器
@app.get("/ready")
async def ready():
    """检查是否准备好接收流量"""
    checks = await check_all_dependencies()

    if not all(checks.values()):
        raise HTTPException(503)

    return {"status": "ready", "checks": checks}
```

**负载均衡器应该使用哪个端点？**

- **推荐使用 /ready**：检查依赖服务，确保服务真正可用
- **不推荐使用 /health**：只检查进程，可能漏报依赖服务故障

### 6.2 响应格式

**简单格式（推荐）：**

```json
{
  "status": "healthy"
}
```

**详细格式：**

```json
{
  "status": "healthy",
  "timestamp": "2026-02-13T01:00:00Z",
  "version": "1.0.0",
  "checks": {
    "database": true,
    "redis": true,
    "llm_api": true
  }
}
```

**负载均衡器通常只关心 HTTP 状态码，不解析响应体。**

---

## 7. 流量切换与灰度发布

### 7.1 蓝绿部署

**场景：** 部署新版本时，先部署到"绿"环境，测试通过后切换流量

```nginx
upstream blue_env {
    server api1-blue.example.com:8000;
    server api2-blue.example.com:8000;
}

upstream green_env {
    server api1-green.example.com:8000;
    server api2-green.example.com:8000;
}

server {
    listen 80;

    location / {
        # 切换流量：修改这里
        proxy_pass http://blue_env;  # 或 http://green_env
    }
}
```

**健康检查：**
- 绿环境部署完成后，健康检查通过
- 手动切换流量到绿环境
- 蓝环境保留一段时间，以便回滚

### 7.2 金丝雀发布（Canary Deployment）

**场景：** 新版本先发布到少量服务器，逐步增加流量

```nginx
upstream stable {
    server api1-stable.example.com:8000 weight=9;
    server api2-stable.example.com:8000 weight=9;
}

upstream canary {
    server api1-canary.example.com:8000 weight=1;
}

upstream ai_agent_api {
    server stable;
    server canary;
}

server {
    listen 80;

    location / {
        proxy_pass http://ai_agent_api;
    }
}
```

**流量分配：**
- 90% 流量 → 稳定版本
- 10% 流量 → 金丝雀版本
- 监控金丝雀版本的健康检查和错误率
- 逐步增加金丝雀流量（10% → 50% → 100%）

### 7.3 基于健康检查的自动切换

```python
from enum import Enum

class DeploymentStage(str, Enum):
    CANARY = "canary"
    STABLE = "stable"

# 全局变量
current_stage = DeploymentStage.STABLE

@app.get("/ready")
async def ready():
    """健康检查（支持金丝雀部署）"""
    checks = await check_all_dependencies()

    # 如果是金丝雀版本，额外检查
    if current_stage == DeploymentStage.CANARY:
        # 检查错误率
        error_rate = await get_error_rate()
        if error_rate > 0.05:  # 错误率超过 5%
            # 金丝雀版本有问题，标记为不健康
            raise HTTPException(503, "Canary version unhealthy")

    if not all(checks.values()):
        raise HTTPException(503)

    return {
        "status": "healthy",
        "stage": current_stage,
        "checks": checks
    }
```

---

## 8. 健康检查频率与超时配置

### 8.1 推荐配置

**生产环境：**

```yaml
# Kubernetes
livenessProbe:
  httpGet:
    path: /health
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 2
```

**负载均衡器：**

```nginx
# Nginx Plus
health_check uri=/ready
             interval=5s
             fails=3
             passes=2
             timeout=3s;
```

```haproxy
# HAProxy
server api1 api1.example.com:8000 check inter 5s rise 2 fall 3
```

### 8.2 配置权衡

| 参数 | 更频繁 | 更宽松 |
|------|--------|--------|
| interval | 更快检测故障 | 减少负载 |
| timeout | 更容易超时 | 更容忍慢响应 |
| failureThreshold | 更容易误报 | 更容忍短暂抖动 |

**推荐：**
- **interval**：5-10秒（平衡检测速度和负载）
- **timeout**：3-5秒（足够长，避免误判）
- **failureThreshold**：2-3次（避免短暂抖动导致切换）

---

## 9. 负载均衡器类型对比

### 9.1 对比表

| 负载均衡器 | 健康检查类型 | 配置复杂度 | 高级特性 | 成本 |
|-----------|-------------|-----------|---------|------|
| Nginx 开源版 | 被动 | 低 | 少 | 免费 |
| Nginx Plus | 主动 | 中 | 多 | 商业 |
| HAProxy | 主动 | 中 | 多 | 免费 |
| AWS ALB | 主动 | 低 | 多 | 按量付费 |
| GCP Load Balancer | 主动 | 低 | 多 | 按量付费 |
| Azure Load Balancer | 主动 | 低 | 多 | 按量付费 |

### 9.2 选择建议

**小型项目：**
- Nginx 开源版 + 被动健康检查
- 简单、免费、够用

**中型项目：**
- HAProxy + 主动健康检查
- 功能强大、免费、配置灵活

**大型项目：**
- 云服务负载均衡器（AWS ALB、GCP LB）
- 托管服务、自动扩展、高可用

---

## 10. 在 AI Agent 后端中的应用

### 10.1 完整配置示例

**FastAPI 应用：**

```python
from fastapi import FastAPI, HTTPException
import time

app = FastAPI()

# 健康检查缓存
health_cache = {"last_check": 0, "checks": {}}

@app.get("/health")
async def health():
    """Liveness：只检查进程是否响应"""
    return {"status": "healthy"}

@app.get("/ready")
async def ready():
    """Readiness：检查依赖服务（用于负载均衡器）"""
    now = time.time()

    # 缓存 30 秒
    if now - health_cache["last_check"] < 30:
        checks = health_cache["checks"]
    else:
        checks = {
            "database": await check_database(),
            "redis": await check_redis(),
            "llm_api": await check_llm_api(),
        }
        health_cache.update({
            "last_check": now,
            "checks": checks
        })

    # 核心依赖失败 → 503
    if not checks["database"]:
        raise HTTPException(503, "Database unavailable")

    # 可选依赖失败 → 200 但降级
    if not checks["llm_api"]:
        return {
            "status": "degraded",
            "message": "LLM API unavailable",
            "checks": checks
        }

    return {"status": "healthy", "checks": checks}
```

**HAProxy 配置：**

```haproxy
frontend http_front
    bind *:80
    default_backend ai_agent_api

backend ai_agent_api
    balance roundrobin

    # 健康检查配置
    option httpchk GET /ready
    http-check expect status 200

    # 后端服务
    server api1 10.0.1.10:8000 check inter 5s rise 2 fall 3
    server api2 10.0.1.11:8000 check inter 5s rise 2 fall 3
    server api3 10.0.1.12:8000 check inter 5s rise 2 fall 3
```

**Kubernetes Service：**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ai-agent-api
spec:
  selector:
    app: ai-agent-api
  ports:
  - port: 80
    targetPort: 8000
  type: LoadBalancer
```

---

## 总结

负载均衡器集成的关键要点：

1. **健康检查机制**：主动检查 vs 被动检查
2. **Nginx**：开源版被动检查，Plus 版主动检查
3. **HAProxy**：主动健康检查，功能强大
4. **云服务**：托管负载均衡器，配置简单
5. **状态码约定**：200 = 健康，503 = 不健康
6. **端点设计**：/health（Liveness），/ready（Readiness + 负载均衡器）
7. **流量切换**：蓝绿部署、金丝雀发布
8. **配置优化**：平衡检测速度和负载

在 AI Agent 后端中，负载均衡器通过健康检查实现：
- 自动故障检测和流量切换
- 支持蓝绿部署和金丝雀发布
- 提高系统可用性和可靠性
