# Extensions 扩展开发基础 - 实战代码 08：完整扩展实战

> 构建一个生产级的 Todo 管理扩展，整合所有核心功能

---

## 1. 场景介绍

### 1.1 项目目标

构建一个完整的 Todo 管理扩展，展示 Extensions 开发的最佳实践：

**核心功能：**
- ✅ 工具注册：todo 工具支持 list/add/toggle/clear 操作
- ✅ 命令注册：/todos 命令显示交互式 UI
- ✅ 状态持久化：通过 tool result details 保存状态
- ✅ 状态重建：从 session 历史重建状态
- ✅ UI 定制：自定义 TodoListComponent
- ✅ 事件处理：监听会话事件
- ✅ 自定义渲染：renderCall 和 renderResult

### 1.2 技术栈

- **TypeScript**：类型安全的扩展开发
- **pi-tui**：终端 UI 组件库
- **TypeBox**：参数 schema 定义
- **Session API**：状态持久化和重建

---

## 2. 完整实现

### 2.1 类型定义

```typescript
import { StringEnum } from "@mariozechner/pi-ai";
import type { ExtensionAPI, ExtensionContext, Theme } from "@mariozechner/pi-coding-agent";
import { matchesKey, Text, truncateToWidth } from "@mariozechner/pi-tui";
import { Type } from "@sinclair/typebox";

// Todo 数据结构
interface Todo {
  id: number;
  text: string;
  done: boolean;
}

// Tool result details 结构
interface TodoDetails {
  action: "list" | "add" | "toggle" | "clear";
  todos: Todo[];
  nextId: number;
  error?: string;
}

// 参数 schema
const TodoParams = Type.Object({
  action: StringEnum(["list", "add", "toggle", "clear"] as const),
  text: Type.Optional(Type.String({ description: "Todo text (for add)" })),
  id: Type.Optional(Type.Number({ description: "Todo ID (for toggle)" })),
});
```

### 2.2 UI 组件

```typescript
/**
 * Todo 列表 UI 组件
 */
class TodoListComponent {
  private todos: Todo[];
  private theme: Theme;
  private onClose: () => void;
  private cachedWidth?: number;
  private cachedLines?: string[];

  constructor(todos: Todo[], theme: Theme, onClose: () => void) {
    this.todos = todos;
    this.theme = theme;
    this.onClose = onClose;
  }

  /**
   * 处理键盘输入
   */
  handleInput(data: string): void {
    if (matchesKey(data, "escape") || matchesKey(data, "ctrl+c")) {
      this.onClose();
    }
  }

  /**
   * 渲染组件
   */
  render(width: number): string[] {
    // 使用缓存避免重复渲染
    if (this.cachedLines && this.cachedWidth === width) {
      return this.cachedLines;
    }

    const lines: string[] = [];
    const th = this.theme;

    // 标题
    lines.push("");
    const title = th.fg("accent", " Todos ");
    const headerLine =
      th.fg("borderMuted", "─".repeat(3)) +
      title +
      th.fg("borderMuted", "─".repeat(Math.max(0, width - 10)));
    lines.push(truncateToWidth(headerLine, width));
    lines.push("");

    // 内容
    if (this.todos.length === 0) {
      lines.push(
        truncateToWidth(
          `  ${th.fg("dim", "No todos yet. Ask the agent to add some!")}`,
          width
        )
      );
    } else {
      const done = this.todos.filter((t) => t.done).length;
      const total = this.todos.length;
      lines.push(
        truncateToWidth(`  ${th.fg("muted", `${done}/${total} completed`)}`, width)
      );
      lines.push("");

      for (const todo of this.todos) {
        const check = todo.done ? th.fg("success", "✓") : th.fg("dim", "○");
        const id = th.fg("accent", `#${todo.id}`);
        const text = todo.done
          ? th.fg("dim", todo.text)
          : th.fg("text", todo.text);
        lines.push(truncateToWidth(`  ${check} ${id} ${text}`, width));
      }
    }

    // 页脚
    lines.push("");
    lines.push(
      truncateToWidth(`  ${th.fg("dim", "Press Escape to close")}`, width)
    );
    lines.push("");

    // 缓存结果
    this.cachedWidth = width;
    this.cachedLines = lines;
    return lines;
  }

  /**
   * 使缓存失效
   */
  invalidate(): void {
    this.cachedWidth = undefined;
    this.cachedLines = undefined;
  }
}
```

### 2.3 主扩展逻辑

```typescript
export default function (pi: ExtensionAPI) {
  // 内存中的状态（从 session 重建）
  let todos: Todo[] = [];
  let nextId = 1;

  /**
   * 从 session 重建状态
   * 扫描 tool results 并按顺序应用
   */
  const reconstructState = (ctx: ExtensionContext) => {
    todos = [];
    nextId = 1;

    // 遍历当前分支的所有条目
    for (const entry of ctx.sessionManager.getBranch()) {
      if (entry.type !== "message") continue;
      const msg = entry.message;
      if (msg.role !== "toolResult" || msg.toolName !== "todo") continue;

      // 从 details 恢复状态
      const details = msg.details as TodoDetails | undefined;
      if (details) {
        todos = details.todos;
        nextId = details.nextId;
      }
    }
  };

  // === 事件处理：重建状态 ===

  pi.on("session_start", async (_event, ctx) => reconstructState(ctx));
  pi.on("session_switch", async (_event, ctx) => reconstructState(ctx));
  pi.on("session_fork", async (_event, ctx) => reconstructState(ctx));
  pi.on("session_tree", async (_event, ctx) => reconstructState(ctx));

  // === 工具注册 ===

  pi.registerTool({
    name: "todo",
    label: "Todo",
    description: "Manage a todo list. Actions: list, add (text), toggle (id), clear",
    parameters: TodoParams,

    async execute(_toolCallId, params, _signal, _onUpdate, _ctx) {
      switch (params.action) {
        case "list":
          return {
            content: [
              {
                type: "text",
                text: todos.length
                  ? todos.map((t) => `[${t.done ? "x" : " "}] #${t.id}: ${t.text}`).join("\n")
                  : "No todos",
              },
            ],
            details: { action: "list", todos: [...todos], nextId } as TodoDetails,
          };

        case "add": {
          if (!params.text) {
            return {
              content: [{ type: "text", text: "Error: text required for add" }],
              details: {
                action: "add",
                todos: [...todos],
                nextId,
                error: "text required",
              } as TodoDetails,
            };
          }
          const newTodo: Todo = { id: nextId++, text: params.text, done: false };
          todos.push(newTodo);
          return {
            content: [{ type: "text", text: `Added todo #${newTodo.id}: ${newTodo.text}` }],
            details: { action: "add", todos: [...todos], nextId } as TodoDetails,
          };
        }

        case "toggle": {
          if (params.id === undefined) {
            return {
              content: [{ type: "text", text: "Error: id required for toggle" }],
              details: {
                action: "toggle",
                todos: [...todos],
                nextId,
                error: "id required",
              } as TodoDetails,
            };
          }
          const todo = todos.find((t) => t.id === params.id);
          if (!todo) {
            return {
              content: [{ type: "text", text: `Todo #${params.id} not found` }],
              details: {
                action: "toggle",
                todos: [...todos],
                nextId,
                error: `#${params.id} not found`,
              } as TodoDetails,
            };
          }
          todo.done = !todo.done;
          return {
            content: [
              { type: "text", text: `Todo #${todo.id} ${todo.done ? "completed" : "uncompleted"}` }
            ],
            details: { action: "toggle", todos: [...todos], nextId } as TodoDetails,
          };
        }

        case "clear": {
          const count = todos.length;
          todos = [];
          nextId = 1;
          return {
            content: [{ type: "text", text: `Cleared ${count} todos` }],
            details: { action: "clear", todos: [], nextId: 1 } as TodoDetails,
          };
        }

        default:
          return {
            content: [{ type: "text", text: `Unknown action: ${params.action}` }],
            details: {
              action: "list",
              todos: [...todos],
              nextId,
              error: `unknown action: ${params.action}`,
            } as TodoDetails,
          };
      }
    },

    // === 自定义渲染 ===

    renderCall(args, theme) {
      let text = theme.fg("toolTitle", theme.bold("todo ")) + theme.fg("muted", args.action);
      if (args.text) text += ` ${theme.fg("dim", `"${args.text}"`)}`;
      if (args.id !== undefined) text += ` ${theme.fg("accent", `#${args.id}`)}`;
      return new Text(text, 0, 0);
    },

    renderResult(result, { expanded }, theme) {
      const details = result.details as TodoDetails | undefined;
      if (!details) {
        const text = result.content[0];
        return new Text(text?.type === "text" ? text.text : "", 0, 0);
      }

      if (details.error) {
        return new Text(theme.fg("error", `Error: ${details.error}`), 0, 0);
      }

      const todoList = details.todos;

      switch (details.action) {
        case "list": {
          if (todoList.length === 0) {
            return new Text(theme.fg("dim", "No todos"), 0, 0);
          }
          let listText = theme.fg("muted", `${todoList.length} todo(s):`);
          const display = expanded ? todoList : todoList.slice(0, 5);
          for (const t of display) {
            const check = t.done ? theme.fg("success", "✓") : theme.fg("dim", "○");
            const itemText = t.done ? theme.fg("dim", t.text) : theme.fg("muted", t.text);
            listText += `\n${check} ${theme.fg("accent", `#${t.id}`)} ${itemText}`;
          }
          if (!expanded && todoList.length > 5) {
            listText += `\n${theme.fg("dim", `... ${todoList.length - 5} more`)}`;
          }
          return new Text(listText, 0, 0);
        }

        case "add": {
          const added = todoList[todoList.length - 1];
          return new Text(
            theme.fg("success", "✓ Added ") +
              theme.fg("accent", `#${added.id}`) +
              " " +
              theme.fg("muted", added.text),
            0,
            0
          );
        }

        case "toggle": {
          const text = result.content[0];
          const msg = text?.type === "text" ? text.text : "";
          return new Text(theme.fg("success", "✓ ") + theme.fg("muted", msg), 0, 0);
        }

        case "clear":
          return new Text(theme.fg("success", "✓ ") + theme.fg("muted", "Cleared all todos"), 0, 0);
      }
    },
  });

  // === 命令注册 ===

  pi.registerCommand("todos", {
    description: "Show all todos on the current branch",
    handler: async (_args, ctx) => {
      if (!ctx.hasUI) {
        ctx.ui.notify("/todos requires interactive mode", "error");
        return;
      }

      // 显示自定义 UI 组件
      await ctx.ui.custom<void>((_tui, theme, _kb, done) => {
        return new TodoListComponent(todos, theme, () => done());
      });
    },
  });
}
```

---

## 3. 核心特性解析

### 3.1 状态持久化

**通过 details 字段保存状态：**
```typescript
return {
  content: [{ type: "text", text: "Result" }],
  details: {
    action: "add",
    todos: [...todos],  // 保存完整状态
    nextId: nextId,
  } as TodoDetails,
};
```

**为什么使用 details 而不是外部文件？**
- ✅ 分支安全：分支时状态自动正确
- ✅ 历史完整：状态变化记录在 session 中
- ✅ 无需清理：不会留下临时文件
- ✅ 可回溯：可以查看任意时间点的状态

### 3.2 状态重建

**从 session 历史重建状态：**
```typescript
const reconstructState = (ctx: ExtensionContext) => {
  todos = [];
  nextId = 1;

  // 遍历当前分支的所有条目
  for (const entry of ctx.sessionManager.getBranch()) {
    if (entry.type !== "message") continue;
    const msg = entry.message;
    if (msg.role !== "toolResult" || msg.toolName !== "todo") continue;

    // 从 details 恢复状态
    const details = msg.details as TodoDetails | undefined;
    if (details) {
      todos = details.todos;
      nextId = details.nextId;
    }
  }
};
```

**在所有会话事件中重建：**
```typescript
pi.on("session_start", async (_event, ctx) => reconstructState(ctx));
pi.on("session_switch", async (_event, ctx) => reconstructState(ctx));
pi.on("session_fork", async (_event, ctx) => reconstructState(ctx));
pi.on("session_tree", async (_event, ctx) => reconstructState(ctx));
```

### 3.3 自定义 UI 组件

**组件接口：**
```typescript
interface Component {
  handleInput(data: string): void;  // 处理键盘输入
  render(width: number): string[];  // 渲染组件
  invalidate?(): void;              // 使缓存失效
}
```

**性能优化：**
```typescript
render(width: number): string[] {
  // 使用缓存避免重复渲染
  if (this.cachedLines && this.cachedWidth === width) {
    return this.cachedLines;
  }

  // 渲染逻辑...
  const lines = this.doRender(width);

  // 缓存结果
  this.cachedWidth = width;
  this.cachedLines = lines;
  return lines;
}
```

### 3.4 自定义渲染

**renderCall：自定义工具调用显示**
```typescript
renderCall(args, theme) {
  let text = theme.fg("toolTitle", theme.bold("todo "));
  text += theme.fg("muted", args.action);
  if (args.text) text += ` ${theme.fg("dim", `"${args.text}"`)}`;
  if (args.id !== undefined) text += ` ${theme.fg("accent", `#${args.id}`)}`;
  return new Text(text, 0, 0);
}
```

**renderResult：自定义结果显示**
```typescript
renderResult(result, { expanded }, theme) {
  const details = result.details as TodoDetails | undefined;

  // 根据 action 类型定制显示
  switch (details.action) {
    case "list":
      // 列表显示，支持展开/折叠
      const display = expanded ? todoList : todoList.slice(0, 5);
      // ...
    case "add":
      // 添加成功提示
      // ...
  }
}
```

---

## 4. 最佳实践

### 4.1 类型安全

```typescript
// ✓ 好：使用 TypeScript 接口
interface Todo {
  id: number;
  text: string;
  done: boolean;
}

// ✗ 差：使用 any
const todos: any[] = [];
```

### 4.2 错误处理

```typescript
// ✓ 好：验证参数并返回错误
if (!params.text) {
  return {
    content: [{ type: "text", text: "Error: text required" }],
    details: { error: "text required" },
  };
}

// ✗ 差：抛出异常
if (!params.text) {
  throw new Error("text required");
}
```

### 4.3 状态管理

```typescript
// ✓ 好：通过 details 持久化
details: { todos: [...todos], nextId }

// ✗ 差：使用外部文件
fs.writeFileSync("/tmp/todos.json", JSON.stringify(todos));
```

### 4.4 UI 性能

```typescript
// ✓ 好：使用缓存
if (this.cachedLines && this.cachedWidth === width) {
  return this.cachedLines;
}

// ✗ 差：每次都重新渲染
return this.doRender(width);
```

---

## 5. 扩展方向

### 5.1 功能增强

- **优先级**：为 Todo 添加优先级（高/中/低）
- **截止日期**：添加截止日期和提醒
- **标签**：支持多标签分类
- **搜索**：按关键词搜索 Todo
- **统计**：显示完成率、趋势图

### 5.2 UI 增强

- **键盘导航**：上下箭头选择，空格切换完成状态
- **颜色编码**：根据优先级显示不同颜色
- **进度条**：显示整体完成进度
- **分组显示**：按状态、优先级、日期分组

### 5.3 集成增强

- **Git 集成**：提交时自动更新 Todo
- **日历集成**：同步到日历应用
- **通知**：截止日期提醒
- **导出**：导出为 Markdown、JSON

---

## 6. 总结

### 6.1 核心要点

1. **工具注册**：使用 registerTool 注册 todo 工具
2. **命令注册**：使用 registerCommand 注册 /todos 命令
3. **状态持久化**：通过 tool result details 保存状态
4. **状态重建**：从 sessionManager.getBranch() 重建状态
5. **UI 定制**：使用 ctx.ui.custom 创建自定义组件
6. **事件处理**：监听 session_start、session_switch 等事件
7. **自定义渲染**：实现 renderCall 和 renderResult

### 6.2 生产级特性

- ✅ **类型安全**：完整的 TypeScript 类型定义
- ✅ **错误处理**：参数验证和友好的错误消息
- ✅ **性能优化**：UI 渲染缓存
- ✅ **状态管理**：分支安全的状态持久化
- ✅ **用户体验**：交互式 UI 和自定义渲染
- ✅ **可维护性**：清晰的代码结构和注释

### 6.3 学习路径

1. **基础**：理解 ExtensionAPI 和基本概念
2. **工具**：学习 registerTool 和参数 schema
3. **命令**：学习 registerCommand 和 UI 交互
4. **状态**：掌握状态持久化和重建
5. **UI**：学习自定义组件和渲染
6. **集成**：整合所有功能构建完整扩展

---

**恭喜！** 你已经完成了 Extensions 扩展开发基础的所有实战代码学习。现在你可以：
- 构建自己的生产级扩展
- 集成多种功能（工具、命令、UI、状态）
- 优化性能和用户体验
- 发布和分享你的扩展

**下一步建议：**
- 阅读 pi-mono 官方文档和示例
- 研究社区扩展（awesome-pi-agent）
- 构建自己的扩展项目
- 参与社区讨论和贡献
