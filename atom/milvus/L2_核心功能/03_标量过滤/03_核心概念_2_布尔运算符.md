# 核心概念2：布尔运算符

> 掌握 AND、OR、NOT 运算符，构建复杂的过滤条件

---

## 什么是布尔运算符？

**布尔运算符用于组合多个条件，形成复杂的逻辑表达式。**

Milvus 支持三种布尔运算符：
- `and`：逻辑与（所有条件都必须为真）
- `or`：逻辑或（至少一个条件为真）
- `not`：逻辑非（条件取反）

---

## 1. AND 运算符

### 1.1 基础用法

**所有条件都必须同时满足**

```python
# 单个 and
expr = "year == 2024 and category == 'tech'"
# 含义：年份是2024 且 分类是tech

# 多个 and
expr = "year == 2024 and category == 'tech' and price < 100"
# 含义：年份是2024 且 分类是tech 且 价格小于100

# 更多条件
expr = """
    year == 2024
    and category == 'tech'
    and price >= 50
    and price <= 200
    and is_published == true
"""
# 含义：所有5个条件都必须满足
```

### 1.2 真值表

| 条件A | 条件B | A and B |
|-------|-------|---------|
| true  | true  | true ✅ |
| true  | false | false ❌ |
| false | true  | false ❌ |
| false | false | false ❌ |

**记忆技巧**：只有全部为真，结果才为真。

### 1.3 实际应用场景

```python
# 场景1：电商商品筛选
expr = """
    category == 'electronics'
    and price >= 100
    and price <= 500
    and in_stock == true
    and rating >= 4.0
"""
# 找到：电子产品、价格100-500、有货、评分4.0以上

# 场景2：内容管理系统
expr = """
    is_published == true
    and is_deleted == false
    and author_id == 12345
    and publish_time >= 1704067200
"""
# 找到：已发布、未删除、特定作者、2024年后发布的文章

# 场景3：多租户知识库
expr = """
    user_id == 12345
    and status == 'active'
    and category in ['tech', 'ai']
"""
# 找到：特定用户的、活跃的、科技或AI分类的文档
```

### 1.4 性能优化

**将选择性高的条件放在前面**

```python
# ✅ 推荐：高选择性条件在前
expr = "user_id == 12345 and category == 'tech' and year == 2024"
# user_id 选择性最高（可能只有几百条）
# category 选择性中等（可能有几千条）
# year 选择性低（可能有几万条）

# ❌ 不推荐：低选择性条件在前
expr = "year == 2024 and category == 'tech' and user_id == 12345"
# 虽然结果相同，但执行效率可能较低
```

**原因**：Milvus 可能会短路求值，先过滤掉大部分数据。

---

## 2. OR 运算符

### 2.1 基础用法

**至少一个条件满足即可**

```python
# 单个 or
expr = "category == 'tech' or category == 'ai'"
# 含义：分类是tech 或 分类是ai

# 多个 or
expr = "year == 2023 or year == 2024 or year == 2025"
# 含义：年份是2023、2024或2025中的任意一个

# 更好的写法：使用 in
expr = "year in [2023, 2024, 2025]"
# 等价于上面的表达式，但更简洁高效
```

### 2.2 真值表

| 条件A | 条件B | A or B |
|-------|-------|--------|
| true  | true  | true ✅ |
| true  | false | true ✅ |
| false | true  | true ✅ |
| false | false | false ❌ |

**记忆技巧**：只要有一个为真，结果就为真。

### 2.3 实际应用场景

```python
# 场景1：多分类查询
expr = "category == 'tech' or category == 'ai' or category == 'ml'"
# 更好的写法：
expr = "category in ['tech', 'ai', 'ml']"

# 场景2：状态筛选
expr = "status == 'draft' or status == 'pending'"
# 找到：草稿或待审核的文档

# 场景3：紧急程度
expr = "priority == 'high' or priority == 'urgent'"
# 找到：高优先级或紧急的任务

# 场景4：多条件匹配
expr = "is_featured == true or is_hot == true or is_new == true"
# 找到：精选、热门或新品中的任意一种
```

### 2.4 性能注意事项

**OR 比 AND 慢**

```python
# AND：快速过滤
expr = "year == 2024 and category == 'tech'"
# 执行：先过滤 year，再过滤 category，数据量逐步减少

# OR：需要合并结果
expr = "year == 2024 or category == 'tech'"
# 执行：分别过滤 year 和 category，然后合并结果（去重）
```

**优化建议**：
- 优先使用 `in` 代替多个 `or`
- 如果可能，将 OR 条件转换为 IN 条件

```python
# ❌ 不推荐：多个 or
expr = "category == 'tech' or category == 'ai' or category == 'ml' or category == 'data'"

# ✅ 推荐：使用 in
expr = "category in ['tech', 'ai', 'ml', 'data']"
```

---

## 3. NOT 运算符

### 3.1 基础用法

**条件取反**

```python
# 基础 not
expr = "not (category == 'spam')"
# 含义：分类不是spam

# 等价写法（更简洁）
expr = "category != 'spam'"

# not 与 in 结合
expr = "not (category in ['spam', 'deleted'])"
# 含义：分类不是spam也不是deleted

# Milvus 2.3+ 支持 not in（更简洁）
expr = "category not in ['spam', 'deleted']"
```

### 3.2 真值表

| 条件A | not A |
|-------|-------|
| true  | false |
| false | true  |

### 3.3 实际应用场景

```python
# 场景1：排除特定值
expr = "not (status == 'deleted')"
# 等价于：
expr = "status != 'deleted'"

# 场景2：排除多个值
expr = "not (category in ['spam', 'test', 'deleted'])"
# 等价于（Milvus 2.3+）：
expr = "category not in ['spam', 'test', 'deleted']"

# 场景3：复杂条件取反
expr = "not (year == 2023 and category == 'old')"
# 含义：不是（2023年且old分类）的文档
# 等价于：year != 2023 or category != 'old'（德摩根定律）

# 场景4：排除特定用户
expr = "not (user_id in [101, 102, 103])"
# 等价于：
expr = "user_id not in [101, 102, 103]"
```

### 3.4 德摩根定律

**NOT 与 AND/OR 的转换规则**

```python
# 规则1：not (A and B) = (not A) or (not B)
expr = "not (year == 2023 and category == 'old')"
# 等价于：
expr = "year != 2023 or category != 'old'"

# 规则2：not (A or B) = (not A) and (not B)
expr = "not (status == 'deleted' or status == 'spam')"
# 等价于：
expr = "status != 'deleted' and status != 'spam'"
# 或者：
expr = "status not in ['deleted', 'spam']"
```

---

## 4. 混合使用：AND、OR、NOT

### 4.1 运算符优先级

**优先级从高到低：**
1. `not`（最高）
2. `and`
3. `or`（最低）

```python
# 示例1：理解优先级
expr = "a == 1 or b == 2 and c == 3"
# 等价于：
expr = "a == 1 or (b == 2 and c == 3)"
# 不是：
expr = "(a == 1 or b == 2) and c == 3"

# 示例2：not 的优先级
expr = "not a == 1 and b == 2"
# 等价于：
expr = "(not (a == 1)) and b == 2"
# 不是：
expr = "not (a == 1 and b == 2)"
```

### 4.2 使用括号明确优先级

**强烈建议：使用括号避免歧义**

```python
# ❌ 不推荐：依赖默认优先级
expr = "a == 1 or b == 2 and c == 3"
# 难以理解，容易出错

# ✅ 推荐：使用括号明确意图
expr = "a == 1 or (b == 2 and c == 3)"
# 或者：
expr = "(a == 1 or b == 2) and c == 3"
# 清晰明确
```

### 4.3 复杂表达式示例

```python
# 示例1：电商高级筛选
expr = """
    (category in ['electronics', 'computers'])
    and (price >= 100 and price <= 500)
    and (brand == 'Apple' or brand == 'Samsung')
    and in_stock == true
"""
# 含义：
# - 分类是电子产品或电脑
# - 价格在100-500之间
# - 品牌是Apple或Samsung
# - 有货

# 示例2：内容管理系统
expr = """
    (is_published == true and is_deleted == false)
    and (author_id == 12345 or editor_id == 12345)
    and (category in ['tech', 'ai', 'ml'])
    and publish_time >= 1704067200
"""
# 含义：
# - 已发布且未删除
# - 作者或编辑是12345
# - 分类是tech、ai或ml
# - 2024年后发布

# 示例3：多租户权限控制
expr = """
    user_id == 12345
    and (
        (is_public == true)
        or (is_shared == true and shared_with_user_id == 12345)
        or (is_private == true and owner_id == 12345)
    )
    and status == 'active'
"""
# 含义：
# - 用户ID是12345
# - 满足以下任一条件：
#   - 公开文档
#   - 共享给该用户的文档
#   - 该用户拥有的私有文档
# - 状态是活跃
```

### 4.4 简化复杂表达式

**技巧1：提取公共条件**

```python
# ❌ 冗余：
expr = "(year == 2024 and category == 'tech') or (year == 2024 and category == 'ai')"

# ✅ 简化：
expr = "year == 2024 and (category == 'tech' or category == 'ai')"
# 或者：
expr = "year == 2024 and category in ['tech', 'ai']"
```

**技巧2：使用 IN 代替多个 OR**

```python
# ❌ 冗余：
expr = "category == 'tech' or category == 'ai' or category == 'ml' or category == 'data'"

# ✅ 简化：
expr = "category in ['tech', 'ai', 'ml', 'data']"
```

**技巧3：使用 NOT IN 代替多个 AND**

```python
# ❌ 冗余：
expr = "status != 'deleted' and status != 'spam' and status != 'test'"

# ✅ 简化：
expr = "status not in ['deleted', 'spam', 'test']"
```

---

## 5. 常见错误和陷阱

### 错误1：忘记括号导致优先级错误

```python
# ❌ 错误：没有括号
expr = "year == 2024 or year == 2023 and category == 'tech'"
# 实际含义：year == 2024 or (year == 2023 and category == 'tech')
# 期望含义：(year == 2024 or year == 2023) and category == 'tech'

# ✅ 正确：使用括号
expr = "(year == 2024 or year == 2023) and category == 'tech'"
```

### 错误2：过度使用 NOT

```python
# ❌ 不推荐：使用 not
expr = "not (category == 'spam')"

# ✅ 推荐：使用 !=
expr = "category != 'spam'"

# ❌ 不推荐：使用 not in
expr = "not (category in ['spam', 'deleted'])"

# ✅ 推荐：使用 not in（Milvus 2.3+）
expr = "category not in ['spam', 'deleted']"
```

### 错误3：AND/OR 大小写错误

```python
# ❌ 错误：大写
expr = "year == 2024 AND category == 'tech'"

# ✅ 正确：小写
expr = "year == 2024 and category == 'tech'"
```

### 错误4：使用 && 或 ||

```python
# ❌ 错误：使用 && 或 ||
expr = "year == 2024 && category == 'tech'"
expr = "year == 2024 || category == 'ai'"

# ✅ 正确：使用 and 或 or
expr = "year == 2024 and category == 'tech'"
expr = "year == 2024 or category == 'ai'"
```

---

## 6. 实战示例

### 示例1：构建动态过滤条件

```python
from pymilvus import Collection, connections

connections.connect("default", host="localhost", port="19530")
collection = Collection("documents")

# 用户输入的筛选条件
filters = {
    "year": 2024,
    "categories": ['tech', 'ai', 'ml'],
    "min_price": 50,
    "max_price": 200,
    "is_published": True
}

# 构建表达式
conditions = []
conditions.append(f"year == {filters['year']}")
conditions.append(f"category in {filters['categories']}")
conditions.append(f"price >= {filters['min_price']}")
conditions.append(f"price <= {filters['max_price']}")
conditions.append(f"is_published == {str(filters['is_published']).lower()}")

expr = " and ".join(conditions)
print(expr)
# 输出：year == 2024 and category in ['tech', 'ai', 'ml'] and price >= 50 and price <= 200 and is_published == true

# 执行查询
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr=expr
)
```

### 示例2：可选条件

```python
# 用户可能不提供所有条件
filters = {
    "year": 2024,
    "categories": ['tech', 'ai'],
    # min_price 和 max_price 未提供
}

# 动态构建表达式
conditions = []

if "year" in filters:
    conditions.append(f"year == {filters['year']}")

if "categories" in filters and filters["categories"]:
    conditions.append(f"category in {filters['categories']}")

if "min_price" in filters:
    conditions.append(f"price >= {filters['min_price']}")

if "max_price" in filters:
    conditions.append(f"price <= {filters['max_price']}")

# 用 and 连接所有条件
expr = " and ".join(conditions) if conditions else None
print(expr)
# 输出：year == 2024 and category in ['tech', 'ai']

# 执行查询
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    limit=10,
    expr=expr  # 如果 expr 为 None，则不应用过滤
)
```

---

## 核心要点总结

1. **AND**：所有条件都必须满足，用于缩小结果范围
2. **OR**：至少一个条件满足，用于扩大结果范围
3. **NOT**：条件取反，优先使用 `!=` 或 `not in`
4. **优先级**：not > and > or
5. **括号**：使用括号明确优先级，避免歧义
6. **简化**：使用 `in` 代替多个 `or`，使用 `not in` 代替多个 `and`
7. **性能**：AND 比 OR 快，高选择性条件放在前面

**记住**：复杂表达式要使用括号，简单表达式要使用 IN/NOT IN。
