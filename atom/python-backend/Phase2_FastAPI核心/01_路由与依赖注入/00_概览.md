# 路由与依赖注入 - 概览

> FastAPI 的核心设计：用装饰器定义 API，用 Depends() 管理依赖

---

## 本知识点包含什么？

### 核心内容

1. **路由系统** - 如何定义 API 端点
   - 路由装饰器（@app.get、@app.post 等）
   - 路径参数、查询参数、请求体
   - 路径操作函数的参数解析

2. **依赖注入** - 如何管理依赖关系
   - Depends() 机制
   - 依赖层级（依赖的依赖）
   - 依赖缓存与作用域

3. **响应模型** - 如何定义响应格式
   - response_model 参数
   - 状态码管理
   - 响应类型（JSON、文件、流式）

### 与 Express 的对比

| 概念 | Express | FastAPI |
|------|---------|---------|
| 定义路由 | `app.get('/users', handler)` | `@app.get("/users")` |
| 中间件 | `app.use(middleware)` | `Depends(dependency)` |
| 参数解析 | 手动 `req.params`、`req.query` | 自动解析到函数参数 |
| 数据验证 | express-validator | Pydantic 自动验证 |
| 依赖注入 | 手动传递或全局变量 | Depends() 自动注入 |

---

## 为什么重要？

### 在 AI Agent 后端开发中的应用

1. **API 端点定义** - 定义 Agent 的对话接口
   ```python
   @app.post("/chat")
   async def chat(message: ChatMessage, db: Session = Depends(get_db)):
       # 处理对话请求
   ```

2. **依赖管理** - 注入数据库连接、LLM 客户端
   ```python
   def get_llm_client():
       return OpenAI(api_key=settings.OPENAI_API_KEY)

   @app.post("/generate")
   async def generate(prompt: str, llm: OpenAI = Depends(get_llm_client)):
       # 使用注入的 LLM 客户端
   ```

3. **认证授权** - 保护 API 端点
   ```python
   @app.get("/profile")
   async def get_profile(user: User = Depends(get_current_user)):
       # 只有认证用户才能访问
   ```

---

## 学习路径

```
路由系统（基础）
    ↓
依赖注入（核心）
    ↓
响应模型（进阶）
    ↓
实战应用（AI Agent API）
```

---

## 前置知识

- ✅ Python 类型注解（Phase1）
- ✅ Pydantic 数据验证（Phase1）
- ✅ 装饰器原理（Phase1）
- ✅ 异步编程 async/await（Phase1）

---

## 学习目标

完成本知识点后，你将能够：

- [ ] 使用装饰器定义 GET/POST/PUT/DELETE 路由
- [ ] 理解路径参数、查询参数、请求体的区别
- [ ] 使用 Depends() 实现依赖注入
- [ ] 创建可复用的依赖函数（数据库连接、认证等）
- [ ] 使用 response_model 定义响应格式
- [ ] 构建模块化的 AI Agent API

---

## 文档结构

本知识点包含以下文档：

1. **基础理解**
   - 30字核心
   - 第一性原理
   - 最小可用知识

2. **核心概念**（3个技术深入讲解）
   - 路由系统
   - 依赖注入
   - 响应模型

3. **学习辅助**
   - 双重类比（前端 + 日常生活）
   - 反直觉点（常见误区）

4. **实战代码**（4个场景）
   - 基础路由示例
   - 依赖注入实战
   - 响应模型实战
   - 综合应用（AI Agent API）

5. **进阶内容**
   - 面试必问
   - 化骨绵掌（10个知识卡片）
   - 一句话总结

---

**建议学习时间：** 根据你的节奏安排，重点是理解概念并动手实践

**下一步：** 从 01_30字核心.md 开始，逐步深入
