# 最小可用

掌握以下内容，就能开始使用混合检索：

---

## 6.1 基础混合检索语法

**核心操作**：在向量检索中添加 `expr` 参数

```python
from pymilvus import connections, Collection

# 连接 Milvus
connections.connect("default", host="localhost", port="19530")

# 加载 Collection
collection = Collection("documents")
collection.load()

# 准备查询向量
query_vector = [0.1, 0.2, 0.3, ...]  # 768维向量

# 混合检索：向量检索 + 标量过滤
results = collection.search(
    data=[query_vector],           # 查询向量
    anns_field="embedding",        # 向量字段名
    param={"metric_type": "L2"},   # 距离度量
    limit=10,                      # 返回Top-10
    expr="age > 18"                # 标量过滤条件
)

# 输出结果
for hits in results:
    for hit in hits:
        print(f"ID: {hit.id}, Distance: {hit.distance:.4f}")
```

**这个知识足以**：

- ✅ 在向量检索中添加精确条件
- ✅ 实现基础的混合检索
- ✅ 理解混合检索的基本语法

---

## 6.2 常用过滤表达式

**5个最常用的表达式模式**

### 模式1：相等匹配

```python
# 单个值
expr = "city == 'Beijing'"
expr = "status == 'active'"
expr = "is_public == true"

# 多个值（IN）
expr = "city in ['Beijing', 'Shanghai', 'Shenzhen']"
expr = "category in ['tech', 'ai', 'ml']"
```

**应用场景**：

- 多租户数据隔离：`tenant_id == 'A'`
- 状态过滤：`status == 'approved'`
- 类别筛选：`category in ['tech', 'ai']`

---

### 模式2：范围过滤

```python
# 数值范围
expr = "age > 18"
expr = "price >= 100 and price <= 1000"
expr = "rating >= 4.0"

# 时间范围
expr = "timestamp >= 1704067200"  # 2024-01-01
```

**应用场景**：

- 年龄限制：`age > 18`
- 价格区间：`price >= 100 and price <= 1000`
- 时间范围：`timestamp >= start_time`

---

### 模式3：逻辑组合

```python
# AND（同时满足）
expr = "age > 18 and city == 'Beijing'"
expr = "status == 'active' and rating >= 4.0"

# OR（满足任一）
expr = "city == 'Beijing' or city == 'Shanghai'"

# 复杂组合
expr = "(city == 'Beijing' or city == 'Shanghai') and age > 18"
```

**应用场景**：

- 多条件筛选：`tenant_id == 'A' and year == 2024`
- 多地区查询：`city in ['Beijing', 'Shanghai']`

---

### 模式4：多租户隔离

```python
# 租户数据隔离（最常用）
expr = "tenant_id == 'A'"

# 组合其他条件
expr = "tenant_id == 'A' and status == 'active'"
```

**应用场景**：

- SaaS 平台：每个租户只能访问自己的数据
- 数据安全：在数据库层面强制隔离

---

### 模式5：时间过滤

```python
import time

# 最近N天
now = int(time.time())
days_30 = 30 * 24 * 3600
expr = f"timestamp >= {now - days_30}"

# 特定年份
expr = "year == 2024"

# 特定季度
expr = "year == 2024 and quarter == 'Q1'"
```

**应用场景**：

- 最近数据：`timestamp >= last_30_days`
- 历史数据：`year == 2023`

---

## 6.3 创建支持混合检索的 Collection

**完整示例**：

```python
from pymilvus import connections, FieldSchema, CollectionSchema, DataType, Collection

# 1. 连接 Milvus
connections.connect("default", host="localhost", port="19530")

# 2. 定义 Schema
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768),
    FieldSchema(name="title", dtype=DataType.VARCHAR, max_length=500),
    FieldSchema(name="year", dtype=DataType.INT64),        # 用于过滤
    FieldSchema(name="category", dtype=DataType.VARCHAR, max_length=100),  # 用于过滤
    FieldSchema(name="rating", dtype=DataType.FLOAT),      # 用于过滤
]

schema = CollectionSchema(fields=fields, description="Documents with metadata")

# 3. 创建 Collection
collection = Collection(name="documents", schema=schema)

# 4. 创建向量索引
index_params = {
    "index_type": "HNSW",
    "metric_type": "L2",
    "params": {"M": 16, "efConstruction": 200}
}
collection.create_index(field_name="embedding", index_params=index_params)

# 5. 创建标量索引（可选，但推荐）
collection.create_index(field_name="year")
collection.create_index(field_name="category")

# 6. 加载 Collection
collection.load()

print("Collection 创建成功，支持混合检索！")
```

**关键点**：

- ✅ 向量字段：`FLOAT_VECTOR`
- ✅ 标量字段：`INT64`, `VARCHAR`, `FLOAT`, `BOOL`
- ✅ 向量索引：HNSW（推荐）
- ✅ 标量索引：为常用过滤字段创建索引

---

## 6.4 插入数据

```python
# 准备数据
data = [
    {
        "embedding": [0.1, 0.2, ..., 0.768],  # 768维向量
        "title": "Python 入门教程",
        "year": 2024,
        "category": "tutorial",
        "rating": 4.5
    },
    {
        "embedding": [0.2, 0.3, ..., 0.768],
        "title": "机器学习实战",
        "year": 2024,
        "category": "ml",
        "rating": 4.8
    },
    # ... 更多数据
]

# 插入数据
collection.insert(data)
collection.flush()  # 确保数据持久化

print(f"插入 {len(data)} 条数据")
```

---

## 6.5 执行混合检索

```python
# 准备查询向量（实际应用中使用 Embedding 模型生成）
query_text = "Python 教程"
query_vector = embed(query_text)  # 假设已有 embed 函数

# 混合检索
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr="year == 2024 and rating >= 4.0",  # 标量过滤
    output_fields=["title", "year", "category", "rating"]
)

# 输出结果
print(f"找到 {len(results[0])} 条结果：\n")
for hit in results[0]:
    print(f"标题: {hit.entity.get('title')}")
    print(f"年份: {hit.entity.get('year')}")
    print(f"类别: {hit.entity.get('category')}")
    print(f"评分: {hit.entity.get('rating')}")
    print(f"距离: {hit.distance:.4f}")
    print("-" * 50)
```

---

## 6.6 性能优化（3个关键技巧）

### 技巧1：为高选择性字段创建索引

```python
# 为租户ID创建索引（高选择性字段）
collection.create_index(field_name="tenant_id")

# 效果：过滤性能提升 10-100 倍
```

---

### 技巧2：高选择性条件前置

```python
# ❌ 低效
expr = "age > 18 and tenant_id == 'A'"

# ✅ 高效（高选择性条件在前）
expr = "tenant_id == 'A' and age > 18"
```

---

### 技巧3：使用 IN 代替多个 OR

```python
# ❌ 低效
expr = "city == 'Beijing' or city == 'Shanghai' or city == 'Shenzhen'"

# ✅ 高效
expr = "city in ['Beijing', 'Shanghai', 'Shenzhen']"
```

---

## 6.7 完整工作流程

```python
from pymilvus import connections, Collection

# 1. 连接 Milvus
connections.connect("default", host="localhost", port="19530")

# 2. 加载 Collection
collection = Collection("documents")
collection.load()

# 3. 准备查询
query_text = "Python 机器学习教程"
query_vector = embed(query_text)  # 使用 Embedding 模型

# 4. 执行混合检索
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=10,
    expr="year == 2024 and category == 'ml' and rating >= 4.0",
    output_fields=["title", "year", "category", "rating"]
)

# 5. 处理结果
for hit in results[0]:
    print(f"标题: {hit.entity.get('title')}")
    print(f"相似度: {1 / (1 + hit.distance):.4f}")  # 转换为相似度
    print("-" * 50)
```

---

## 6.8 常见错误与解决

### 错误1：字段不存在

```python
# ❌ 错误
expr = "unknown_field == 'value'"

# ✅ 解决：检查 Schema
schema = collection.schema
for field in schema.fields:
    print(f"字段: {field.name}, 类型: {field.dtype}")
```

---

### 错误2：类型不匹配

```python
# ❌ 错误（age 是 INT64，不能与字符串比较）
expr = "age == '18'"

# ✅ 正确
expr = "age == 18"
```

---

### 错误3：Collection 未加载

```python
# ❌ 错误（Collection 未加载）
collection = Collection("documents")
results = collection.search(...)  # 报错

# ✅ 正确
collection = Collection("documents")
collection.load()  # 先加载
results = collection.search(...)
```

---

## 6.9 RAG 场景快速上手

**场景**：企业知识库问答

```python
from pymilvus import connections, Collection

# 1. 连接 Milvus
connections.connect("default", host="localhost", port="19530")

# 2. 加载 Collection
collection = Collection("knowledge_base")
collection.load()

# 3. 用户查询
user_query = "2024年Q1的销售报告"
query_vector = embed(user_query)

# 4. 混合检索（语义相似 + 时间范围）
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"ef": 64}},
    limit=5,
    expr="year == 2024 and quarter == 'Q1' and doc_type == 'report'",
    output_fields=["title", "content", "year", "quarter"]
)

# 5. 构建上下文
context = "\n\n".join([
    f"文档: {hit.entity.get('title')}\n内容: {hit.entity.get('content')}"
    for hit in results[0]
])

# 6. 调用 LLM 生成答案
from openai import OpenAI
client = OpenAI()

response = client.chat.completions.create(
    model="gpt-4",
    messages=[
        {"role": "system", "content": "你是一个企业知识库助手"},
        {"role": "user", "content": f"基于以下文档回答问题：\n\n{context}\n\n问题：{user_query}"}
    ]
)

print(response.choices[0].message.content)
```

---

## 总结

**这些知识足以**：

1. ✅ 创建支持混合检索的 Collection
2. ✅ 插入带标量字段的数据
3. ✅ 执行基础混合检索
4. ✅ 使用5种常用过滤表达式
5. ✅ 应用3个性能优化技巧
6. ✅ 在 RAG 系统中使用混合检索

**下一步学习**：

- 深入理解向量检索原理 → [03_核心概念_1_向量检索原理.md](./03_核心概念_1_向量检索原理.md)
- 掌握标量过滤机制 → [04_核心概念_2_标量过滤机制.md](./04_核心概念_2_标量过滤机制.md)
- 学习执行策略优化 → [05_核心概念_3_混合检索执行策略.md](./05_核心概念_3_混合检索执行策略.md)
