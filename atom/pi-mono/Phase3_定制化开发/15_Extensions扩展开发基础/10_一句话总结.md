# Extensions 扩展开发基础 - 一句话总结

**Extensions 是 pi-mono 基于控制反转和事件驱动的 TypeScript 插件系统，通过在运行时动态加载代码模块并提供类型安全的 ExtensionAPI（包括工具注册、事件监听、UI 定制、状态管理等能力），实现了在不修改源码的情况下扩展和定制 Agent 功能的能力，支持热重载、Session 分支、多扩展协作，广泛应用于安全防护、工作流自动化、团队工具集成、可观测性等场景，是构建自定义 AI Agent 的核心机制。**

---

## 核心要素拆解

### 1. 本质定义

**Extensions 是什么？**
- 基于控制反转和事件驱动的 TypeScript 插件系统
- 运行时动态加载的代码模块
- 提供类型安全的 ExtensionAPI

### 2. 核心特征

**Extensions 有哪些特征？**
- **工具注册**：registerTool - 添加自定义工具
- **事件监听**：on/off - 监听 30+ 事件类型
- **UI 定制**：setWidget, setFooter, setHeader - 定制界面
- **状态管理**：通过 tool result details - 支持 Session 分支
- **热重载**：/reload 命令 - 无需重启
- **多扩展协作**：事件系统 - 责任链模式

### 3. 实现方式

**Extensions 如何实现？**
- 在不修改源码的情况下扩展和定制 Agent 功能
- 支持热重载（开发体验）
- 支持 Session 分支（状态独立）
- 支持多扩展协作（事件驱动）

### 4. 应用价值

**Extensions 用在哪里？**
- **安全防护**：拦截危险命令，保护系统安全
- **工作流自动化**：自动创建 checkpoint、自动提交代码
- **团队工具集成**：注册项目特定的工具（部署、数据库、API）
- **可观测性**：日志记录、性能监控、追踪分析

### 5. 定位

**Extensions 在 pi-mono 中的定位？**
- 是构建自定义 AI Agent 的核心机制
- 是 pi-mono 最强大的定制化方式
- 是实现复杂系统集成的唯一选择

---

## 与其他概念的关系

### Extensions vs Prompt Templates vs Skills

```
定制化能力层次：
  ├── Prompt Templates（最简单）
  │   └── 提示词复用
  ├── Skills（中等）
  │   └── 功能封装
  └── Extensions（最强大）
      └── 完全控制
```

**选择建议：**
- 简单提示词复用 → Prompt Templates
- 可复用功能模块 → Skills
- 需要编程控制和状态管理 → Extensions

---

## 核心价值

### 1. 可扩展性

**不修改源码即可扩展功能**

```typescript
// 添加自定义工具
pi.registerTool({
  name: "custom_tool",
  description: "Project-specific tool",
  // ...
});
```

### 2. 可定制性

**定制工作流和行为**

```typescript
// 拦截危险操作
pi.on("tool_call", async (event, ctx) => {
  if (dangerous(event)) {
    return { block: true, reason: "Blocked" };
  }
});
```

### 3. 可组合性

**多个 Extensions 协作**

```
Extension 1: 安全检查
Extension 2: 日志记录
Extension 3: 性能监控
Extension 4: UI 定制
  ↓
通过事件系统协作
  ↓
形成强大的功能组合
```

---

## 设计哲学

### 1. 开放封闭原则

- **对扩展开放**：通过 Extensions 添加功能
- **对修改封闭**：核心代码保持稳定

### 2. 控制反转

- **框架调用用户代码**：而不是用户代码调用框架
- **事件驱动**：在关键节点触发事件，让扩展介入

### 3. 组合优于继承

- **多个 Extensions 组合**：而不是继承一个基类
- **独立工作**：每个 Extension 职责单一
- **事件协作**：通过事件系统通信

---

## 技术特点

### 1. TypeScript 优先

- **类型安全**：完整的类型定义
- **IDE 支持**：自动补全和类型检查
- **运行时加载**：使用 jiti 动态加载

### 2. 事件驱动

- **30+ 事件类型**：覆盖 Agent 生命周期
- **异步执行**：所有监听器都是异步的
- **责任链模式**：任何一个可以阻止事件

### 3. 状态管理

- **details 存储**：状态保存在 tool result details
- **Session 分支**：每个分支有独立状态
- **历史重建**：从历史记录重建状态

### 4. 热重载

- **无需重启**：/reload 命令即时生效
- **保持状态**：Session 状态不丢失
- **开发体验**：快速迭代

---

## 实际应用场景

### 1. 安全防护

```typescript
// 拦截危险的 bash 命令
pi.on("tool_call", async (event, ctx) => {
  if (event.toolName === "bash" && dangerous(event.input.command)) {
    const ok = await ctx.ui.confirm("Dangerous!", "Allow?");
    if (!ok) return { block: true, reason: "Blocked" };
  }
});
```

### 2. 工作流自动化

```typescript
// 自动创建 git checkpoint
pi.on("session_fork", async (event, ctx) => {
  await ctx.exec("git stash push -m 'checkpoint before fork'");
});
```

### 3. 团队工具集成

```typescript
// 注册部署工具
pi.registerTool({
  name: "deploy",
  description: "Deploy to staging/production",
  async execute(toolCallId, params, signal, onUpdate, ctx) {
    await ctx.exec(`./scripts/deploy.sh ${params.env}`);
    return { content: [...], details: {} };
  },
});
```

### 4. 可观测性

```typescript
// 记录所有工具调用
pi.on("tool_call", async (event, ctx) => {
  console.log(`[${new Date().toISOString()}] ${event.toolName}`);
});
```

---

## 学习路径

### 基础阶段

1. **理解概念**：Extensions 是什么，为什么需要
2. **最小示例**：编写 hello world Extension
3. **工具注册**：添加自定义工具
4. **事件监听**：监听和拦截事件

### 进阶阶段

5. **状态管理**：通过 details 存储状态
6. **UI 定制**：定制界面和交互
7. **多扩展协作**：事件系统和责任链
8. **热重载**：开发和调试技巧

### 实战阶段

9. **安全防护扩展**：实现完整的安全检查
10. **工作流扩展**：自动化 git 操作
11. **团队工具扩展**：集成项目特定工具
12. **Provider 扩展**：集成自定义 LLM API

---

## 关键技术点

### 1. ExtensionAPI

```typescript
interface ExtensionAPI {
  // 工具注册
  registerTool(definition: ToolDefinition): void;
  registerCommand(name: string, config: CommandConfig): void;
  registerShortcut(key: KeyId, handler: ShortcutHandler): void;

  // 事件监听
  on<E extends EventType>(event: E, handler: EventHandler<E>): void;
  off<E extends EventType>(event: E, handler: EventHandler<E>): void;

  // Provider 管理
  registerProvider(config: ProviderConfig): void;

  // 其他 API
  getCommands(): SlashCommandInfo[];
  events: EventEmitter;
}
```

### 2. 事件类型

```typescript
// Session 事件
"session_start" | "session_switch" | "session_fork" | "session_exit"

// Agent 事件
"agent_turn_start" | "agent_turn_end" | "agent_error"

// 工具事件
"tool_call" | "tool_result" | "tool_error"

// 用户事件
"input" | "user_message"

// 模型事件
"model_select" | "thinking_level_change"
```

### 3. 状态管理模式

```typescript
// 1. 内存状态
let state = {};

// 2. 重建函数
const reconstructState = (ctx: ExtensionContext) => {
  state = {};
  for (const entry of ctx.sessionManager.getBranch()) {
    if (entry.type === "message" && entry.message.toolName === "my_tool") {
      state = entry.message.details.state;
    }
  }
};

// 3. 监听 Session 事件
pi.on("session_start", async (_, ctx) => reconstructState(ctx));
pi.on("session_fork", async (_, ctx) => reconstructState(ctx));

// 4. 保存状态
return {
  content: [...],
  details: { state }, // 保存到 details
};
```

---

## 最佳实践

### 1. 设计原则

- **单一职责**：每个 Extension 只做一件事
- **独立工作**：不依赖其他 Extensions 的加载顺序
- **事件协作**：通过事件系统与其他 Extensions 通信
- **状态管理**：使用 details 存储，支持 Session 分支

### 2. 代码规范

- **TypeScript 优先**：利用类型系统
- **错误处理**：捕获并处理所有错误
- **异步支持**：使用 async/await
- **性能优化**：避免阻塞主线程

### 3. 开发流程

```bash
# 1. 创建扩展文件
touch ~/.pi/agent/extensions/my-extension.ts

# 2. 编写扩展代码
# (使用 VS Code 等编辑器，有完整类型提示)

# 3. 启动 pi（自动加载）
pi

# 4. 测试扩展功能
# (在 pi 会话中测试)

# 5. 修改代码后热重载
/reload

# 6. 继续测试
```

---

## 常见误区

### 误区 1：状态存储在外部文件

❌ **错误**：使用外部文件存储状态
✅ **正确**：使用 tool result details 存储状态

**原因**：Session 分支需要独立状态

### 误区 2：直接修改事件对象

❌ **错误**：`event.input.command = "modified"`
✅ **正确**：`return { transform: modifiedEvent }`

**原因**：事件对象是不可变的

### 误区 3：依赖加载顺序

❌ **错误**：期望 Extension 按文件名顺序加载
✅ **正确**：设计独立的 Extensions，不依赖顺序

**原因**：加载顺序不确定

---

## 延伸学习

### 核心概念

- TypeScript 扩展基础
- 事件监听与响应
- 工具与命令注册
- UI 定制与交互
- Provider 与模型管理
- 扩展加载与热重载
- 扩展开发模式

### 实战代码

- 安全防护扩展
- 工具增强扩展
- 命令与快捷键扩展
- UI 定制扩展
- 会话管理扩展
- Git 集成扩展
- Provider 定制扩展
- 完整扩展实战

### 高级主题

- 自定义 Provider 集成
- MCP Server 集成
- Sub-Agents 子代理实现
- 权限控制与沙箱
- 性能优化与调试

---

## 参考资源

- **官方文档**: https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent/docs/extensions.md
- **示例代码**: https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent/examples/extensions
- **类型定义**: `@mariozechner/pi-coding-agent` 包
- **社区扩展**: https://github.com/qualisero/awesome-pi-agent

---

## 总结

Extensions 是 pi-mono 最强大的定制化机制，它：

1. **提供完全的可编程性**：通过 TypeScript 和 ExtensionAPI
2. **支持深度定制**：工具注册、事件监听、UI 定制、状态管理
3. **保证开发体验**：热重载、类型安全、完整文档
4. **实现系统集成**：安全防护、工作流自动化、团队工具、可观测性

掌握 Extensions，就掌握了构建自定义 AI Agent 的核心能力。

---

**版本**: v1.0
**最后更新**: 2026-02-20
**适用于**: pi-mono 2025-2026 版本
