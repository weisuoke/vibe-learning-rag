# æµå¼æ›´æ–°é›†æˆ - å®æˆ˜ä»£ç 

> **çŸ¥è¯†ç‚¹**: Sub-Agents å­ä»£ç†å®ç° - æµå¼æ›´æ–°ä¸å®æ—¶è¿›åº¦
> **éš¾åº¦**: â­â­â­â­
> **å‰ç½®çŸ¥è¯†**: åŸºç¡€å•ä»£ç†æ‰§è¡Œã€äº‹ä»¶é©±åŠ¨ç¼–ç¨‹

---

## 1. åœºæ™¯æè¿°

æµå¼æ›´æ–°æ˜¯ Sub-Agents ç³»ç»Ÿçš„å…³é”®ç”¨æˆ·ä½“éªŒç‰¹æ€§,é€šè¿‡å®æ—¶æ¨é€ä»£ç†æ‰§è¡Œè¿›åº¦ã€å·¥å…·è°ƒç”¨å’Œä¸­é—´ç»“æœ,è®©ç”¨æˆ·å§‹ç»ˆäº†è§£ä»£ç†çš„å·¥ä½œçŠ¶æ€ã€‚è¿™é¿å…äº†é•¿æ—¶é—´ç­‰å¾…çš„é»‘ç›’ä½“éªŒ,æä¾›é€æ˜çš„æ‰§è¡Œå¯è§æ€§ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**:
- å®æ—¶æ˜¾ç¤ºä»£ç†æ‰§è¡Œæ­¥éª¤
- å·¥å…·è°ƒç”¨è¿›åº¦é€šçŸ¥
- ä¸­é—´ç»“æœé¢„è§ˆ
- é”™è¯¯å’Œè­¦å‘Šå³æ—¶åé¦ˆ

æ ¹æ® [SitePoint çš„ RSC æµå¼æ€§èƒ½ç ”ç©¶](https://www.sitepoint.com/react-server-components-streaming-performance-2026),ä¼˜åŒ–çš„æµå¼æ¶æ„å¯å°† TTFB ä» 450ms é™è‡³ 40-90ms,å®Œæ•´é¡µé¢åŠ è½½æ—¶é—´ <400msã€‚[assistant-ui](https://github.com/assistant-ui/assistant-ui) (8.6k stars) æä¾›ç”Ÿäº§å°±ç»ªçš„æµå¼ä¼ è¾“ã€è‡ªåŠ¨æ»šåŠ¨å’Œå®æ—¶æ›´æ–°ã€‚

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 onUpdate å›è°ƒæœºåˆ¶

```typescript
interface UpdateMessage {
  type: "progress" | "tool_call" | "result" | "error";
  content: string;
  metadata?: Record<string, any>;
}

type OnUpdateCallback = (message: UpdateMessage) => void;
```

### 2.2 æµå¼ä¼ è¾“æ¨¡å¼

| æ¨¡å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| Push | æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ | å®æ—¶è¿›åº¦æ›´æ–° |
| Pull | å®¢æˆ·ç«¯è½®è¯¢ | ç®€å•çŠ¶æ€æŸ¥è¯¢ |
| SSE | Server-Sent Events | å•å‘å®æ—¶æµ |
| WebSocket | åŒå‘é€šä¿¡ | äº¤äº’å¼ä»£ç† |

### 2.3 ä¸ RSC çš„å¯¹åº”

æ ¹æ® [SitePoint](https://www.sitepoint.com/react-server-components-streaming-performance-2026):

| Pi-mono æ¦‚å¿µ | RSC æ¨¡å¼ |
|-------------|---------|
| `onUpdate` | Suspense fallback |
| æµå¼æ›´æ–° | Flight protocol |
| å®æ—¶è¿›åº¦ | åµŒå¥— Suspense |

---

## 3. å®Œæ•´ä»£ç ç¤ºä¾‹

### 3.1 æµå¼æ›´æ–°ç®¡ç†å™¨

```typescript
import { ExtensionAPI } from "@pi-mono/extension-api";
import { EventEmitter } from "events";

interface StreamUpdate {
  type: "start" | "progress" | "tool_call" | "tool_result" | "complete" | "error";
  timestamp: Date;
  content: string;
  metadata?: {
    agent?: string;
    tool?: string;
    duration?: number;
    tokens?: { input: number; output: number };
  };
}

/**
 * æµå¼æ›´æ–°ç®¡ç†å™¨
 *
 * å‚è€ƒ:
 * - https://www.sitepoint.com/react-server-components-streaming-performance-2026 (RSC streaming)
 * - https://github.com/assistant-ui/assistant-ui (production streaming)
 */
export class StreamingUpdateManager extends EventEmitter {
  private updates: StreamUpdate[] = [];
  private startTime?: Date;

  /**
   * å¼€å§‹æµå¼ä¼šè¯
   */
  start(agent: string): void {
    this.startTime = new Date();
    this.updates = [];

    const update: StreamUpdate = {
      type: "start",
      timestamp: new Date(),
      content: `ğŸš€ Starting ${agent}...`,
      metadata: { agent },
    };

    this.addUpdate(update);
  }

  /**
   * å‘é€è¿›åº¦æ›´æ–°
   */
  progress(message: string, metadata?: Record<string, any>): void {
    const update: StreamUpdate = {
      type: "progress",
      timestamp: new Date(),
      content: message,
      metadata,
    };

    this.addUpdate(update);
  }

  /**
   * å‘é€å·¥å…·è°ƒç”¨é€šçŸ¥
   */
  toolCall(tool: string, args: Record<string, any>): void {
    const update: StreamUpdate = {
      type: "tool_call",
      timestamp: new Date(),
      content: `ğŸ”§ Calling ${tool}`,
      metadata: {
        tool,
        args: this.sanitizeArgs(args),
      },
    };

    this.addUpdate(update);
  }

  /**
   * å‘é€å·¥å…·ç»“æœ
   */
  toolResult(tool: string, result: any, duration: number): void {
    const update: StreamUpdate = {
      type: "tool_result",
      timestamp: new Date(),
      content: `âœ… ${tool} completed`,
      metadata: {
        tool,
        duration,
        result: this.sanitizeResult(result),
      },
    };

    this.addUpdate(update);
  }

  /**
   * å®Œæˆæµå¼ä¼šè¯
   */
  complete(summary: string, tokens?: { input: number; output: number }): void {
    const duration = this.startTime
      ? Date.now() - this.startTime.getTime()
      : 0;

    const update: StreamUpdate = {
      type: "complete",
      timestamp: new Date(),
      content: `âœ¨ ${summary}`,
      metadata: {
        duration,
        tokens,
      },
    };

    this.addUpdate(update);
  }

  /**
   * å‘é€é”™è¯¯
   */
  error(message: string, error?: Error): void {
    const update: StreamUpdate = {
      type: "error",
      timestamp: new Date(),
      content: `âŒ ${message}`,
      metadata: {
        error: error?.message,
        stack: error?.stack,
      },
    };

    this.addUpdate(update);
  }

  /**
   * æ·»åŠ æ›´æ–°å¹¶è§¦å‘äº‹ä»¶
   */
  private addUpdate(update: StreamUpdate): void {
    this.updates.push(update);
    this.emit("update", update);
  }

  /**
   * æ¸…ç†å‚æ•°(é¿å…æ•æ„Ÿä¿¡æ¯)
   */
  private sanitizeArgs(args: Record<string, any>): Record<string, any> {
    const sanitized: Record<string, any> = {};

    for (const [key, value] of Object.entries(args)) {
      if (typeof value === "string" && value.length > 100) {
        sanitized[key] = value.substring(0, 100) + "...";
      } else {
        sanitized[key] = value;
      }
    }

    return sanitized;
  }

  /**
   * æ¸…ç†ç»“æœ(é¿å…è¿‡å¤§è¾“å‡º)
   */
  private sanitizeResult(result: any): any {
    if (typeof result === "string" && result.length > 200) {
      return result.substring(0, 200) + "...";
    }
    return result;
  }

  /**
   * è·å–æ‰€æœ‰æ›´æ–°
   */
  getUpdates(): StreamUpdate[] {
    return [...this.updates];
  }

  /**
   * ç”Ÿæˆæ‘˜è¦
   */
  getSummary(): {
    totalUpdates: number;
    toolCalls: number;
    duration: number;
    updates: StreamUpdate[];
  } {
    const toolCalls = this.updates.filter(u => u.type === "tool_call").length;
    const duration = this.startTime
      ? Date.now() - this.startTime.getTime()
      : 0;

    return {
      totalUpdates: this.updates.length,
      toolCalls,
      duration,
      updates: this.updates,
    };
  }
}

/**
 * æµå¼æ‰§è¡ŒåŒ…è£…å™¨
 */
export class StreamingExecutor {
  private streamManager: StreamingUpdateManager;

  constructor(streamManager: StreamingUpdateManager) {
    this.streamManager = streamManager;
  }

  /**
   * æ‰§è¡Œå¸¦æµå¼æ›´æ–°çš„æ“ä½œ
   */
  async executeWithStreaming<T>(
    agent: string,
    operation: (onUpdate: (msg: string) => void) => Promise<T>
  ): Promise<T> {
    this.streamManager.start(agent);

    try {
      const result = await operation((msg: string) => {
        this.streamManager.progress(msg);
      });

      this.streamManager.complete("Operation completed successfully");

      return result;
    } catch (error: any) {
      this.streamManager.error("Operation failed", error);
      throw error;
    }
  }

  /**
   * æ‰§è¡Œå¸¦å·¥å…·è°ƒç”¨è·Ÿè¸ªçš„æ“ä½œ
   */
  async executeToolWithStreaming<T>(
    tool: string,
    args: Record<string, any>,
    executor: () => Promise<T>
  ): Promise<T> {
    this.streamManager.toolCall(tool, args);

    const startTime = Date.now();

    try {
      const result = await executor();
      const duration = Date.now() - startTime;

      this.streamManager.toolResult(tool, result, duration);

      return result;
    } catch (error: any) {
      const duration = Date.now() - startTime;
      this.streamManager.error(`Tool ${tool} failed after ${duration}ms`, error);
      throw error;
    }
  }
}

/**
 * å®æ—¶è¿›åº¦æ˜¾ç¤ºå™¨
 */
export class ProgressDisplay {
  private currentLine: string = "";

  /**
   * æ˜¾ç¤ºæ›´æ–°
   */
  display(update: StreamUpdate): void {
    const timestamp = this.formatTime(update.timestamp);
    const prefix = this.getPrefix(update.type);

    console.log(`[${timestamp}] ${prefix} ${update.content}`);

    if (update.metadata) {
      this.displayMetadata(update.metadata);
    }
  }

  /**
   * æ˜¾ç¤ºå…ƒæ•°æ®
   */
  private displayMetadata(metadata: Record<string, any>): void {
    for (const [key, value] of Object.entries(metadata)) {
      if (value !== undefined && value !== null) {
        console.log(`  ${key}: ${JSON.stringify(value)}`);
      }
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(date: Date): string {
    return date.toISOString().substring(11, 23);
  }

  /**
   * è·å–å‰ç¼€
   */
  private getPrefix(type: StreamUpdate["type"]): string {
    switch (type) {
      case "start": return "ğŸš€";
      case "progress": return "â³";
      case "tool_call": return "ğŸ”§";
      case "tool_result": return "âœ…";
      case "complete": return "âœ¨";
      case "error": return "âŒ";
    }
  }
}

/**
 * Extension æ³¨å†Œå‡½æ•°
 */
export default function (pi: ExtensionAPI) {
  const streamManager = new StreamingUpdateManager();
  const streamExecutor = new StreamingExecutor(streamManager);
  const progressDisplay = new ProgressDisplay();

  // ç›‘å¬æ›´æ–°å¹¶æ˜¾ç¤º
  streamManager.on("update", (update: StreamUpdate) => {
    progressDisplay.display(update);
  });

  pi.registerTool({
    name: "execute_with_streaming",
    description: "Execute operation with streaming updates",
    parameters: z.object({
      agent: z.string(),
      operation: z.string(),
    }),
    async execute(toolCallId, params, signal, onUpdate, ctx) {
      const result = await streamExecutor.executeWithStreaming(
        params.agent,
        async (updateFn) => {
          // æ¨¡æ‹Ÿæ“ä½œ
          updateFn("Step 1: Initializing...");
          await new Promise(resolve => setTimeout(resolve, 500));

          updateFn("Step 2: Processing...");
          await new Promise(resolve => setTimeout(resolve, 1000));

          updateFn("Step 3: Finalizing...");
          await new Promise(resolve => setTimeout(resolve, 500));

          return { success: true };
        }
      );

      const summary = streamManager.getSummary();

      return {
        result,
        summary,
      };
    },
  });
}
```

---

## 4. ä»£ç è§£æ

### 4.1 æ ¸å¿ƒè®¾è®¡å†³ç­–

**1. EventEmitter æ¨¡å¼**

```typescript
export class StreamingUpdateManager extends EventEmitter {
  private addUpdate(update: StreamUpdate): void {
    this.updates.push(update);
    this.emit("update", update);
  }
}
```

ä½¿ç”¨ Node.js EventEmitter å®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼,è§£è€¦æ›´æ–°ç”Ÿæˆå’Œæ˜¾ç¤ºã€‚

**2. ç±»å‹åŒ–æ›´æ–°æ¶ˆæ¯**

```typescript
interface StreamUpdate {
  type: "start" | "progress" | "tool_call" | "tool_result" | "complete" | "error";
  timestamp: Date;
  content: string;
  metadata?: Record<string, any>;
}
```

ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼,ä¾¿äºè§£æå’Œæ˜¾ç¤ºã€‚

**3. æ¸…ç†æ•æ„Ÿä¿¡æ¯**

```typescript
private sanitizeArgs(args: Record<string, any>): Record<string, any> {
  // æˆªæ–­é•¿å­—ç¬¦ä¸²,é¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯
}
```

ç¬¦åˆ [assistant-ui](https://github.com/assistant-ui/assistant-ui) çš„ç”Ÿäº§å®‰å…¨å®è·µã€‚

---

## 5. å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹ 1: SitePoint - RSC æµå¼æ€§èƒ½çªç ´

**æ¥æº**: [SitePoint](https://www.sitepoint.com/react-server-components-streaming-performance-2026)

**æ€§èƒ½å¯¹æ¯”**:
- **ä¼ ç»Ÿ SSR**: TTFB ~450ms
- **RSC Streaming**: TTFB ~45ms (æå‡ 90%)
- **å®Œæ•´é¡µé¢**: <400ms

**å…³é”®æŠ€æœ¯**:
- Partial Prerendering (PPR)
- åµŒå¥— Suspense ç¼–æ’
- é™æ€ Shell + åŠ¨æ€ Islands

**å¯ç¤º**: æµå¼ä¼ è¾“ä¸ä»…æ˜¯ç”¨æˆ·ä½“éªŒ,æ›´æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚

### æ¡ˆä¾‹ 2: assistant-ui - ç”Ÿäº§å°±ç»ªæµå¼åº“

**æ¥æº**: [GitHub - assistant-ui](https://github.com/assistant-ui/assistant-ui)

**æ ¸å¿ƒç‰¹æ€§**:
- 8.6k stars,ç”Ÿäº§éªŒè¯
- å¤„ç†æµå¼ä¼ è¾“ã€è‡ªåŠ¨æ»šåŠ¨ã€å¯è®¿é—®æ€§
- å®æ—¶æ›´æ–°
- å®Œå…¨å¯ç»„åˆçš„åŸè¯­

**æŠ€æœ¯æ ˆ**:
- TypeScript/React
- æ”¯æŒ AI SDK, LangGraph, Mastra
- å¹¿æ³›çš„æ¨¡å‹æ”¯æŒ

### æ¡ˆä¾‹ 3: AI SDK RSC - streamUI å‡½æ•°

**æ¥æº**: [AI SDK](https://ai-sdk.dev/docs/ai-sdk-rsc/streaming-react-components)

**ç”Ÿæˆå™¨å‡½æ•°æ¨¡å¼**:
```typescript
generate: async function* ({ location }) {
  yield <LoadingComponent />;
  const weather = await getWeather(location);
  return <WeatherComponent weather={weather} location={location} />;
}
```

**ä¼˜åŠ¿**:
- æ¸è¿›å¼æ¸²æŸ“
- åŠ è½½çŠ¶æ€ â†’ æœ€ç»ˆç»“æœ
- æ— ç¼ç”¨æˆ·ä½“éªŒ

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ›´æ–°é¢‘ç‡æ§åˆ¶

```typescript
// âœ… åˆç†çš„æ›´æ–°é¢‘ç‡
- å…³é”®æ­¥éª¤: ç«‹å³æ›´æ–°
- è¿›åº¦ç™¾åˆ†æ¯”: æ¯ 5% æ›´æ–°
- å·¥å…·è°ƒç”¨: å¼€å§‹å’Œç»“æŸæ—¶æ›´æ–°

// âŒ è¿‡åº¦æ›´æ–°
- æ¯ä¸ªå¾ªç¯è¿­ä»£éƒ½æ›´æ–°
- æ¯«ç§’çº§æ›´æ–°
- é‡å¤ç›¸åŒæ¶ˆæ¯
```

### 6.2 æ¶ˆæ¯æ¸…ç†

```typescript
// âœ… æ¸…ç†æ•æ„Ÿä¿¡æ¯
private sanitizeArgs(args: Record<string, any>): Record<string, any> {
  // æˆªæ–­é•¿å­—ç¬¦ä¸²
  // ç§»é™¤å¯†é’¥å’Œä»¤ç‰Œ
  // é™åˆ¶åµŒå¥—æ·±åº¦
}

// âŒ ç›´æ¥è¾“å‡º
// å¯èƒ½æ³„éœ² API å¯†é’¥ã€ç”¨æˆ·æ•°æ®
```

### 6.3 é”™è¯¯å¤„ç†

```typescript
// âœ… ä¼˜é›…çš„é”™è¯¯æµå¼
try {
  await operation();
} catch (error) {
  streamManager.error("Operation failed", error);
  // ç»§ç»­æµå¼ä¼šè¯,ä¸ä¸­æ–­
}

// âŒ ç›´æ¥æŠ›å‡º
// ä¸­æ–­æµå¼ä¼šè¯,ç”¨æˆ·ä½“éªŒå·®
```

---

## 7. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é¿å…æ›´æ–°è¿‡äºé¢‘ç¹?

**A**: ä½¿ç”¨èŠ‚æµ(throttle):

```typescript
import { throttle } from "lodash";

const throttledUpdate = throttle((msg: string) => {
  streamManager.progress(msg);
}, 100); // æœ€å¤šæ¯ 100ms æ›´æ–°ä¸€æ¬¡
```

### Q2: å¦‚ä½•å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œ?

**A**: ä½¿ç”¨å¿ƒè·³(heartbeat):

```typescript
const heartbeat = setInterval(() => {
  streamManager.progress("Still working...");
}, 5000); // æ¯ 5 ç§’å‘é€å¿ƒè·³

try {
  await longRunningOperation();
} finally {
  clearInterval(heartbeat);
}
```

### Q3: å¦‚ä½•å®ç°è¿›åº¦ç™¾åˆ†æ¯”?

**A**: è·Ÿè¸ªå®Œæˆæ­¥éª¤:

```typescript
const totalSteps = 10;
let completedSteps = 0;

for (const step of steps) {
  await executeStep(step);
  completedSteps++;
  const progress = Math.round((completedSteps / totalSteps) * 100);
  streamManager.progress(`Progress: ${progress}%`);
}
```

---

## 8. æ‰©å±•é˜…è¯»

### æ ¸å¿ƒèµ„æº

1. **[SitePoint - RSC Streaming](https://www.sitepoint.com/react-server-components-streaming-performance-2026)**
   - Sub-100ms TTFB æ¶æ„
   - Partial Prerendering

2. **[assistant-ui](https://github.com/assistant-ui/assistant-ui)**
   - ç”Ÿäº§å°±ç»ªæµå¼åº“
   - 8.6k stars

3. **[AI SDK RSC](https://ai-sdk.dev/docs/ai-sdk-rsc/streaming-react-components)**
   - streamUI å‡½æ•°
   - ç”Ÿæˆå™¨å‡½æ•°æ¨¡å¼

4. **[fastmcp](https://github.com/punkpeye/fastmcp)**
   - MCP æœåŠ¡å™¨æµå¼æ”¯æŒ
   - è¿›åº¦é€šçŸ¥

### ç›¸å…³çŸ¥è¯†ç‚¹

- `03_æ ¸å¿ƒæ¦‚å¿µ_07_æµå¼æ›´æ–°ä¸å®æ—¶è¿›åº¦.md` - æµå¼æ›´æ–°è¯¦è§£
- `07_å®æˆ˜ä»£ç _01_åŸºç¡€å•ä»£ç†æ‰§è¡Œ.md` - å•ä»£ç†æ‰§è¡ŒåŸºç¡€
- `07_å®æˆ˜ä»£ç _08_é”™è¯¯å¤„ç†ä¸æ¢å¤.md` - é”™è¯¯å¤„ç†ç­–ç•¥

---

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-21
**ä½œè€…**: Claude Code
**å®¡æ ¸**: åŸºäº 2025-2026 å¹´æœ€æ–°å®è·µ
