# 实战代码07：配置工厂模式

> **场景**: 演示配置工厂模式、可重用配置构建器、环境特定配置和特性标志

---

## 一、完整可运行代码

```python
"""
配置工厂模式示例
演示：配置工厂、构建器模式、环境配置、特性标志
"""

import os
from typing import Dict, Any, Optional, List
from enum import Enum
from dataclasses import dataclass
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.callbacks import BaseCallbackHandler

# 加载环境变量
load_dotenv()

# ============================================================================
# 第一部分：环境枚举
# ============================================================================

class Environment(Enum):
    """环境类型"""
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"


class UserTier(Enum):
    """用户层级"""
    FREE = "free"
    PRO = "pro"
    ENTERPRISE = "enterprise"


# ============================================================================
# 第二部分：配置工厂
# ============================================================================

class ConfigFactory:
    """配置工厂 - 创建标准化配置"""

    @staticmethod
    def create_base_config(
        environment: Environment,
        user_id: Optional[str] = None,
        session_id: Optional[str] = None
    ) -> Dict[str, Any]:
        """创建基础配置"""
        config = {
            "tags": [environment.value],
            "metadata": {
                "environment": environment.value,
                "created_at": "2026-02-21"
            }
        }

        if user_id:
            config["metadata"]["user_id"] = user_id
            config["tags"].append(f"user-{user_id}")

        if session_id:
            config["metadata"]["session_id"] = session_id

        return config

    @staticmethod
    def create_development_config(user_id: str = "dev-user") -> Dict[str, Any]:
        """创建开发环境配置"""
        return {
            "tags": ["development", "debug"],
            "metadata": {
                "environment": "development",
                "user_id": user_id,
                "debug": True
            },
            "max_concurrency": 2  # 开发环境限制并发
        }

    @staticmethod
    def create_production_config(
        user_id: str,
        user_tier: UserTier
    ) -> Dict[str, Any]:
        """创建生产环境配置"""
        # 根据用户层级设置并发
        concurrency_map = {
            UserTier.FREE: 2,
            UserTier.PRO: 10,
            UserTier.ENTERPRISE: 20
        }

        return {
            "tags": ["production", user_tier.value],
            "metadata": {
                "environment": "production",
                "user_id": user_id,
                "user_tier": user_tier.value,
                "debug": False
            },
            "max_concurrency": concurrency_map[user_tier]
        }


def example_1_config_factory():
    """示例1：使用配置工厂"""
    print("\n" + "="*80)
    print("示例1：配置工厂")
    print("="*80)

    # 创建链
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
    prompt = ChatPromptTemplate.from_template("Explain {concept}")
    chain = prompt | llm | StrOutputParser()

    # 使用工厂创建不同环境的配置
    print("\n1. 开发环境配置:")
    dev_config = ConfigFactory.create_development_config()
    print(f"配置: {dev_config}")
    result = chain.invoke({"concept": "Python"}, config=dev_config)
    print(f"结果: {result[:100]}...")

    print("\n2. 生产环境配置（免费用户）:")
    prod_config_free = ConfigFactory.create_production_config(
        user_id="user-123",
        user_tier=UserTier.FREE
    )
    print(f"配置: {prod_config_free}")

    print("\n3. 生产环境配置（企业用户）:")
    prod_config_enterprise = ConfigFactory.create_production_config(
        user_id="user-456",
        user_tier=UserTier.ENTERPRISE
    )
    print(f"配置: {prod_config_enterprise}")


# ============================================================================
# 第三部分：配置构建器
# ============================================================================

class ConfigBuilder:
    """配置构建器 - 流式API构建配置"""

    def __init__(self):
        self._config = {}

    def with_tags(self, *tags: str) -> 'ConfigBuilder':
        """添加tags"""
        if "tags" not in self._config:
            self._config["tags"] = []
        self._config["tags"].extend(tags)
        return self

    def with_metadata(self, **metadata: Any) -> 'ConfigBuilder':
        """添加metadata"""
        if "metadata" not in self._config:
            self._config["metadata"] = {}
        self._config["metadata"].update(metadata)
        return self

    def with_run_name(self, name: str) -> 'ConfigBuilder':
        """设置run_name"""
        self._config["run_name"] = name
        return self

    def with_max_concurrency(self, limit: int) -> 'ConfigBuilder':
        """设置max_concurrency"""
        self._config["max_concurrency"] = limit
        return self

    def with_callbacks(self, *callbacks: BaseCallbackHandler) -> 'ConfigBuilder':
        """添加callbacks"""
        if "callbacks" not in self._config:
            self._config["callbacks"] = []
        self._config["callbacks"].extend(callbacks)
        return self

    def build(self) -> Dict[str, Any]:
        """构建最终配置"""
        return self._config.copy()


def example_2_config_builder():
    """示例2：使用配置构建器"""
    print("\n" + "="*80)
    print("示例2：配置构建器")
    print("="*80)

    # 创建链
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
    prompt = ChatPromptTemplate.from_template("Summarize: {text}")
    chain = prompt | llm | StrOutputParser()

    # 使用构建器创建配置
    config = (
        ConfigBuilder()
        .with_tags("example", "builder-pattern")
        .with_metadata(user_id="user-789", feature="summarization")
        .with_run_name("summary_task")
        .with_max_concurrency(5)
        .build()
    )

    print(f"\n构建的配置: {config}")

    # 执行
    result = chain.invoke(
        {"text": "LangChain is a framework for building LLM applications."},
        config=config
    )

    print(f"\n结果: {result}")


# ============================================================================
# 第四部分：特性标志配置
# ============================================================================

@dataclass
class FeatureFlags:
    """特性标志"""
    enable_caching: bool = False
    enable_tracing: bool = False
    enable_retry: bool = False
    enable_streaming: bool = False


class FeatureFlagConfigFactory:
    """基于特性标志的配置工厂"""

    @staticmethod
    def create_config(
        base_config: Dict[str, Any],
        features: FeatureFlags
    ) -> Dict[str, Any]:
        """根据特性标志创建配置"""
        config = base_config.copy()

        # 添加特性标志到metadata
        if "metadata" not in config:
            config["metadata"] = {}

        config["metadata"]["features"] = {
            "caching": features.enable_caching,
            "tracing": features.enable_tracing,
            "retry": features.enable_retry,
            "streaming": features.enable_streaming
        }

        # 根据特性添加tags
        feature_tags = []
        if features.enable_caching:
            feature_tags.append("caching-enabled")
        if features.enable_tracing:
            feature_tags.append("tracing-enabled")
        if features.enable_retry:
            feature_tags.append("retry-enabled")
        if features.enable_streaming:
            feature_tags.append("streaming-enabled")

        if "tags" not in config:
            config["tags"] = []
        config["tags"].extend(feature_tags)

        return config


def example_3_feature_flags():
    """示例3：特性标志配置"""
    print("\n" + "="*80)
    print("示例3：特性标志配置")
    print("="*80)

    # 创建链
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
    prompt = ChatPromptTemplate.from_template("Translate '{text}' to {language}")
    chain = prompt | llm | StrOutputParser()

    # 基础配置
    base_config = {
        "tags": ["translation"],
        "metadata": {"service": "translator"}
    }

    # 测试不同特性组合
    feature_sets = [
        ("基础功能", FeatureFlags()),
        ("启用缓存", FeatureFlags(enable_caching=True)),
        ("启用追踪", FeatureFlags(enable_tracing=True)),
        ("全部启用", FeatureFlags(
            enable_caching=True,
            enable_tracing=True,
            enable_retry=True,
            enable_streaming=True
        ))
    ]

    for name, features in feature_sets:
        print(f"\n{name}:")
        config = FeatureFlagConfigFactory.create_config(base_config, features)
        print(f"配置: {config}")

        result = chain.invoke(
            {"text": "Hello", "language": "Spanish"},
            config=config
        )
        print(f"结果: {result}")


# ============================================================================
# 第五部分：用户特定配置工厂
# ============================================================================

class UserConfigFactory:
    """用户特定配置工厂"""

    def __init__(self, user_id: str, user_tier: UserTier):
        self.user_id = user_id
        self.user_tier = user_tier

    def create_config(
        self,
        task_type: str,
        additional_tags: Optional[List[str]] = None,
        additional_metadata: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """为特定用户创建配置"""
        # 基础配置
        config = {
            "tags": [self.user_tier.value, task_type],
            "metadata": {
                "user_id": self.user_id,
                "user_tier": self.user_tier.value,
                "task_type": task_type
            }
        }

        # 根据用户层级设置并发
        if self.user_tier == UserTier.FREE:
            config["max_concurrency"] = 2
        elif self.user_tier == UserTier.PRO:
            config["max_concurrency"] = 10
        else:  # ENTERPRISE
            config["max_concurrency"] = 20

        # 添加额外的tags
        if additional_tags:
            config["tags"].extend(additional_tags)

        # 添加额外的metadata
        if additional_metadata:
            config["metadata"].update(additional_metadata)

        return config


def example_4_user_specific_config():
    """示例4：用户特定配置"""
    print("\n" + "="*80)
    print("示例4：用户特定配置")
    print("="*80)

    # 创建链
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
    prompt = ChatPromptTemplate.from_template("Process: {input}")
    chain = prompt | llm | StrOutputParser()

    # 创建不同用户的配置工厂
    free_user_factory = UserConfigFactory("user-free-123", UserTier.FREE)
    pro_user_factory = UserConfigFactory("user-pro-456", UserTier.PRO)
    enterprise_user_factory = UserConfigFactory("user-ent-789", UserTier.ENTERPRISE)

    # 为不同用户创建配置
    users = [
        ("免费用户", free_user_factory),
        ("专业用户", pro_user_factory),
        ("企业用户", enterprise_user_factory)
    ]

    for user_name, factory in users:
        print(f"\n{user_name}:")
        config = factory.create_config(
            task_type="summarization",
            additional_tags=["priority-normal"],
            additional_metadata={"request_id": "req-123"}
        )
        print(f"配置: {config}")
        print(f"并发限制: {config['max_concurrency']}")


# ============================================================================
# 第六部分：配置模板
# ============================================================================

class ConfigTemplates:
    """预定义配置模板"""

    @staticmethod
    def quick_test() -> Dict[str, Any]:
        """快速测试配置"""
        return {
            "tags": ["test", "quick"],
            "metadata": {"purpose": "testing"},
            "max_concurrency": 1
        }

    @staticmethod
    def batch_processing() -> Dict[str, Any]:
        """批处理配置"""
        return {
            "tags": ["batch", "processing"],
            "metadata": {"purpose": "batch_processing"},
            "max_concurrency": 10
        }

    @staticmethod
    def real_time() -> Dict[str, Any]:
        """实时处理配置"""
        return {
            "tags": ["real-time", "low-latency"],
            "metadata": {"purpose": "real_time"},
            "max_concurrency": 5
        }

    @staticmethod
    def high_quality() -> Dict[str, Any]:
        """高质量配置"""
        return {
            "tags": ["high-quality", "production"],
            "metadata": {"purpose": "high_quality"},
            "max_concurrency": 3
        }


def example_5_config_templates():
    """示例5：配置模板"""
    print("\n" + "="*80)
    print("示例5：配置模板")
    print("="*80)

    # 创建链
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
    prompt = ChatPromptTemplate.from_template("Explain {topic}")
    chain = prompt | llm | StrOutputParser()

    # 使用不同模板
    templates = [
        ("快速测试", ConfigTemplates.quick_test()),
        ("批处理", ConfigTemplates.batch_processing()),
        ("实时处理", ConfigTemplates.real_time()),
        ("高质量", ConfigTemplates.high_quality())
    ]

    for name, config in templates:
        print(f"\n{name}:")
        print(f"配置: {config}")

        result = chain.invoke({"topic": "AI"}, config=config)
        print(f"结果: {result[:100]}...")


# ============================================================================
# 主函数
# ============================================================================

def main():
    """运行所有示例"""
    print("\n" + "="*80)
    print("配置工厂模式 - 完整示例")
    print("="*80)

    try:
        # 运行所有示例
        example_1_config_factory()
        example_2_config_builder()
        example_3_feature_flags()
        example_4_user_specific_config()
        example_5_config_templates()

        print("\n" + "="*80)
        print("所有示例执行完成！")
        print("="*80)

        print("\n关键要点总结：")
        print("1. 使用工厂模式创建标准化配置")
        print("2. 使用构建器模式提供流式API")
        print("3. 通过特性标志控制功能")
        print("4. 为不同用户层级创建专用配置")
        print("5. 使用模板提供常用配置")
        print("6. 配置工厂提高可维护性和一致性")

    except Exception as e:
        print(f"\n错误: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
```

---

## 二、代码说明

### 2.1 核心组件

**ConfigFactory**:
- 静态工厂方法
- 创建环境特定配置
- 标准化配置结构

**ConfigBuilder**:
- 流式API
- 链式调用
- 灵活配置构建

**FeatureFlags**:
- 特性开关
- 功能控制
- A/B测试支持

**5个示例场景**:
1. 配置工厂基础用法
2. 配置构建器模式
3. 特性标志配置
4. 用户特定配置
5. 配置模板

### 2.2 设计模式

**工厂模式**:
```python
config = ConfigFactory.create_production_config(
    user_id="user-123",
    user_tier=UserTier.PRO
)
```

**构建器模式**:
```python
config = (
    ConfigBuilder()
    .with_tags("tag1", "tag2")
    .with_metadata(key="value")
    .build()
)
```

---

## 三、运行环境

### 3.1 依赖安装

```bash
uv sync
source .venv/bin/activate
```

### 3.2 环境变量

```bash
# .env文件
OPENAI_API_KEY=your_key_here
```

### 3.3 运行代码

```bash
python 07_实战代码_07_配置工厂模式.py
```

---

## 四、学习要点

### 4.1 工厂模式优势

**一致性**:
- 统一配置结构
- 减少重复代码
- 易于维护

**灵活性**:
- 环境特定配置
- 用户层级配置
- 特性标志控制

**可测试性**:
- 易于模拟
- 配置隔离
- 单元测试友好

### 4.2 构建器模式优势

**可读性**:
```python
config = (
    ConfigBuilder()
    .with_tags("production")
    .with_metadata(user_id="123")
    .with_max_concurrency(10)
    .build()
)
```

**灵活性**:
- 可选参数
- 链式调用
- 清晰的API

### 4.3 最佳实践

1. **使用工厂创建配置**
2. **提供合理的默认值**
3. **支持环境特定配置**
4. **使用特性标志控制功能**
5. **为不同用户层级提供专用配置**
6. **使用模板简化常用场景**

---

## 五、常见问题

### Q1: 何时使用工厂模式？

**A**: 当需要创建复杂配置对象，且有多种变体时使用工厂模式。

### Q2: 构建器模式vs工厂模式？

**A**:
- 工厂模式：预定义配置，快速创建
- 构建器模式：灵活配置，自定义构建

### Q3: 如何管理配置版本？

**A**: 在metadata中添加版本信息：

```python
config["metadata"]["config_version"] = "2.0"
```

---

## 六、下一步

- 回顾配置传递: [实战代码01 - 基础配置传递](./07_实战代码_01_基础配置传递.md)
- 理解最佳实践: [核心概念09 - 配置最佳实践](./03_核心概念_09_配置最佳实践.md)
- 查看完整概览: [00_概览](./00_概览.md)

---

**版本**: v1.0
**创建日期**: 2026-02-21
**代码行数**: 约450行
**Python版本**: 3.13+
**测试状态**: ✓ 所有代码可运行
