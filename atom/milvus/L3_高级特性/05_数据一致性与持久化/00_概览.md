# 数据一致性与持久化

> 理解 WAL、Compaction、Segment 管理机制，掌握 Milvus 数据可靠性的核心技术

---

## 知识点概览

**核心主题：** 数据一致性与持久化是 Milvus 通过 WAL 记录操作日志、Compaction 合并优化数据、Segment 管理数据版本，确保分布式环境下数据可靠存储和一致性读取的完整机制。

**学习目标：**
- ✅ 理解 4 种一致性级别的区别和选择标准
- ✅ 掌握 WAL 的工作原理和崩溃恢复机制
- ✅ 理解 Compaction 的三种类型和触发策略
- ✅ 掌握 Segment 的生命周期和版本管理
- ✅ 在 RAG 系统中应用数据一致性与持久化机制

---

## 文档结构

### 基础维度

| 文件 | 内容 | 阅读时间 |
|------|------|---------|
| [01_30字核心](./01_30字核心.md) | 一句话说清知识点本质 | 1 分钟 |
| [10_一句话总结](./10_一句话总结.md) | 完整总结知识点 | 1 分钟 |

### 核心理论

| 文件 | 内容 | 阅读时间 |
|------|------|---------|
| [02_第一性原理](./02_第一性原理.md) | 从根本问题出发理解机制 | 15 分钟 |
| [03_核心概念_01_WAL机制](./03_核心概念_01_WAL机制.md) | WAL 的工作原理和实现 | 20 分钟 |
| [03_核心概念_02_Compaction机制](./03_核心概念_02_Compaction机制.md) | Compaction 的三种类型 | 20 分钟 |
| [03_核心概念_03_Segment管理](./03_核心概念_03_Segment管理.md) | Segment 生命周期和 MVCC | 20 分钟 |
| [04_最小可用](./04_最小可用.md) | 20% 核心知识解决 80% 问题 | 10 分钟 |

### 理解辅助

| 文件 | 内容 | 阅读时间 |
|------|------|---------|
| [05_双重类比](./05_双重类比.md) | 前端 + 日常生活类比 | 10 分钟 |
| [06_反直觉点](./06_反直觉点.md) | 5 个常见误区 | 10 分钟 |

### 实战应用

| 文件 | 内容 | 阅读时间 |
|------|------|---------|
| [07_实战代码_场景1_一致性级别选择](./07_实战代码_场景1_一致性级别选择.md) | 一致性级别选择与性能对比 | 15 分钟 |
| [07_实战代码_场景2_WAL崩溃恢复](./07_实战代码_场景2_WAL崩溃恢复.md) | WAL 崩溃恢复模拟 | 15 分钟 |
| [07_实战代码_场景3_Compaction优化](./07_实战代码_场景3_Compaction优化.md) | Compaction 优化与监控 | 15 分钟 |

### 面试与进阶

| 文件 | 内容 | 阅读时间 |
|------|------|---------|
| [08_面试必问](./08_面试必问.md) | 3 个高频面试问题 | 10 分钟 |
| [09_化骨绵掌](./09_化骨绵掌.md) | 10 个 2 分钟知识卡片 | 20 分钟 |

---

## 学习路径

### 快速入门（30 分钟）

适合快速了解核心概念：

```
01_30字核心 (1分钟)
    ↓
04_最小可用 (10分钟)
    ↓
05_双重类比 (10分钟)
    ↓
09_化骨绵掌 (20分钟)
```

### 完整学习（3 小时）

适合系统掌握所有知识：

```
01_30字核心 (1分钟)
    ↓
02_第一性原理 (15分钟)
    ↓
03_核心概念_01_WAL机制 (20分钟)
    ↓
03_核心概念_02_Compaction机制 (20分钟)
    ↓
03_核心概念_03_Segment管理 (20分钟)
    ↓
04_最小可用 (10分钟)
    ↓
05_双重类比 (10分钟)
    ↓
06_反直觉点 (10分钟)
    ↓
07_实战代码_场景1 (15分钟)
    ↓
07_实战代码_场景2 (15分钟)
    ↓
07_实战代码_场景3 (15分钟)
    ↓
08_面试必问 (10分钟)
    ↓
09_化骨绵掌 (20分钟)
    ↓
10_一句话总结 (1分钟)
```

### 实战导向（1.5 小时）

适合快速上手实战：

```
01_30字核心 (1分钟)
    ↓
04_最小可用 (10分钟)
    ↓
07_实战代码_场景1 (15分钟)
    ↓
07_实战代码_场景2 (15分钟)
    ↓
07_实战代码_场景3 (15分钟)
    ↓
06_反直觉点 (10分钟)
    ↓
09_化骨绵掌 (20分钟)
```

---

## 核心知识点

### 1. 一致性级别

**4 种一致性级别：**
- **Strong**：强一致性，必须看到最新数据（性能最低）
- **Bounded**：有界一致性，平衡性能和实时性（推荐）
- **Session**：会话一致性，保证同一会话内一致
- **Eventually**：最终一致性，性能最高（数据可能稍旧）

**性能对比：**
- Strong 比 Eventually 慢 3-5 倍
- 99% 的场景使用 Bounded 即可

### 2. WAL (Write-Ahead Log)

**工作原理：**
```
用户插入数据
    ↓
1. 写入 WAL（顺序写，持久化）
    ↓
2. 写入内存（快速响应）
    ↓
3. 异步刷新到磁盘（后台）
```

**核心价值：**
- 确保数据不丢失
- 崩溃后自动恢复
- 顺序写比随机写快 10 倍

### 3. Compaction

**三种类型：**
- **Minor**：合并小 Segment 为大 Segment
- **Major**：删除标记为删除的数据
- **Full**：重新组织所有数据，全量优化

**触发条件：**
- 小 Segment 数量 > 10 个 → Minor
- 删除数据比例 > 20% → Major
- 手动触发或定期运行 → Full

### 4. Segment 管理

**生命周期：**
```
Growing（可写）
    ↓
Sealed（已封闭）
    ↓
Flushed（已持久化）
    ↓
Indexed（已索引）
    ↓
Compacted（已合并）
```

**MVCC 机制：**
- 支持多版本并发控制
- 支持时间旅行查询
- 查询和 Compaction 可以并行

---

## 在 RAG 中的应用

### 场景1：实时客服知识库

```python
# 使用 Strong 一致性，确保看到最新更新
results = collection.search(
    data=[query_embedding],
    consistency_level="Strong"
)
```

### 场景2：历史文档检索

```python
# 使用 Eventually 一致性，性能优先
results = collection.search(
    data=[query_embedding],
    consistency_level="Eventually"
)
```

### 场景3：大规模数据导入

```python
# WAL 确保数据不丢失
for batch in batches:
    collection.insert(batch)  # 自动使用 WAL
    # 即使系统崩溃，已插入的数据也不会丢失
```

### 场景4：定期数据清理

```python
# 删除过期数据
collection.delete(expr="timestamp < cutoff")

# 运行 Compaction 回收空间
utility.do_compact(collection_name="knowledge_base")
```

---

## 常见问题

**Q1：如何选择一致性级别？**
A：实时场景用 Strong，历史场景用 Eventually，通用场景用 Bounded（推荐）。

**Q2：WAL 会占用多少磁盘空间？**
A：通常不超过数据的 10%，Milvus 会自动清理已刷新的 WAL。

**Q3：Compaction 会影响查询吗？**
A：不会！Compaction 使用 MVCC 机制，查询和 Compaction 可以并行运行。

**Q4：删除数据后空间为什么没释放？**
A：删除操作只是标记数据为"已删除"，需要运行 Compaction 才能物理删除。

**Q5：如何监控 Segment 状态？**
A：使用 `utility.get_query_segment_info()` 查看 Segment 信息。

---

## 最佳实践

### 1. 一致性级别选择

```python
# 决策树
if scenario == "realtime":
    consistency_level = "Strong"
elif scenario == "historical":
    consistency_level = "Eventually"
else:
    consistency_level = "Bounded"  # 推荐
```

### 2. 定期 Compaction

```python
import schedule

# 每天凌晨运行 Compaction
schedule.every().day.at("02:00").do(
    lambda: utility.do_compact("my_collection")
)

# 每周日运行 Full Compaction
schedule.every().sunday.at("03:00").do(
    lambda: utility.do_compact("my_collection", compaction_type="full")
)
```

### 3. 批量插入优化

```python
# 批量大小 1000-5000 性能最优
batch_size = 5000
for i in range(0, len(data), batch_size):
    batch = data[i:i+batch_size]
    collection.insert(batch)
```

### 4. 监控系统状态

```python
# 监控 Segment 状态
segments = utility.get_query_segment_info("my_collection")
print(f"Segment 数量: {len(segments)}")
print(f"总行数: {sum(s.num_rows for s in segments)}")

# 监控 Compaction 状态
state = utility.get_compaction_state(compaction_id)
print(f"Compaction 状态: {state.state}")
```

---

## 性能优化建议

1. **一致性级别**：大多数场景使用 Bounded，避免过度使用 Strong
2. **批量插入**：批量大小 1000-5000，减少 WAL 写入次数
3. **定期 Compaction**：每周运行一次 Full Compaction
4. **监控告警**：监控 Segment 数量、WAL 大小、Compaction 状态
5. **磁盘优化**：使用 SSD 提升 WAL 写入性能

---

## 进阶学习

### 相关知识点

- **L1_快速入门/04_Milvus架构概览**：理解 Milvus 的整体架构
- **L1_快速入门/05_数据一致性级别**：深入理解一致性级别
- **L4_性能优化/01_索引参数调优**：优化查询性能
- **L4_性能优化/02_查询优化**：优化查询策略

### 扩展阅读

- **分布式一致性**：研究 Raft、Paxos 等一致性协议
- **LSM-Tree**：理解 Compaction 的理论基础
- **MVCC**：深入理解多版本并发控制
- **WAL 实现**：研究 PostgreSQL、MySQL 的 WAL 实现

---

## 学习检查清单

完成以下检查，确保掌握核心知识：

- [ ] 能够解释 4 种一致性级别的区别
- [ ] 能够根据业务场景选择合适的一致性级别
- [ ] 理解 WAL 的工作原理和崩溃恢复流程
- [ ] 理解 Compaction 的三种类型和触发条件
- [ ] 理解 Segment 的生命周期和 MVCC 机制
- [ ] 能够手动触发 Compaction 并监控状态
- [ ] 能够查询 Segment 信息并分析状态
- [ ] 能够在 RAG 系统中应用一致性与持久化机制
- [ ] 能够优化批量插入性能
- [ ] 能够配置定期 Compaction 策略

---

## 总结

**核心要点：**
1. **一致性级别**：根据业务需求选择，Bounded 是最佳平衡
2. **WAL 机制**：确保数据不丢失，自动崩溃恢复
3. **Compaction**：定期运行，优化存储和性能
4. **Segment 管理**：理解生命周期，支持 MVCC 和时间旅行

**实战价值：**
- 在 RAG 系统中，数据一致性与持久化机制确保数据可靠性和查询正确性
- 合理配置一致性级别，平衡性能和实时性
- 定期运行 Compaction，确保长期稳定运行
- 监控系统状态，及时发现和解决问题

通过本知识点的学习，你已经掌握了 Milvus 数据一致性与持久化的核心机制，能够在 RAG 系统中应用这些知识，确保数据可靠性和系统稳定性！

---

**下一步学习：** [L3_高级特性/其他知识点](../k.md)
