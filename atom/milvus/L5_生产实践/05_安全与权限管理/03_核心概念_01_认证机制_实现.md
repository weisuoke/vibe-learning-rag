# 核心概念1：认证机制 - 实现篇

**本文档详细讲解如何在 Milvus 中配置和实现认证机制。**

---

## Milvus 认证配置

### 服务端配置

#### 1. 启用认证

```yaml
# milvus.yaml
common:
  security:
    authorizationEnabled: true  # 启用认证
```

**重启 Milvus 使配置生效：**

```bash
# Docker 部署
docker restart milvus-standalone

# Docker Compose 部署
docker-compose restart

# Kubernetes 部署
kubectl rollout restart deployment/milvus
```

#### 2. 验证认证是否启用

```python
from pymilvus import connections

# 尝试不带凭证连接
try:
    connections.connect(
        alias="test",
        host="localhost",
        port="19530"
    )
    print("❌ 认证未启用！")
except Exception as e:
    print("✅ 认证已启用")
    print(f"错误信息：{e}")
```

---

## 用户管理

### 默认用户

Milvus 启用认证后，会自动创建默认管理员用户：

```
用户名：root
密码：Milvus
```

**⚠️ 重要：生产环境必须立即修改默认密码！**

### 修改默认密码

```python
from pymilvus import connections, utility

# 1. 使用默认凭证连接
connections.connect(
    alias="default",
    host="localhost",
    port="19530",
    user="root",
    password="Milvus"  # 默认密码
)

# 2. 修改密码
utility.update_password(
    user="root",
    old_password="Milvus",
    new_password="NewSecurePassword123!"
)

print("✅ 密码已修改")

# 3. 断开连接
connections.disconnect("default")

# 4. 使用新密码重新连接
connections.connect(
    alias="default",
    host="localhost",
    port="19530",
    user="root",
    password="NewSecurePassword123!"
)
```

### 创建新用户

```python
from pymilvus import utility

# 创建用户
utility.create_user(
    user="analyst",
    password="AnalystPass123!"
)

print("✅ 用户 analyst 已创建")

# 验证用户是否创建成功
users = utility.list_users()
print(f"所有用户：{users}")
```

### 删除用户

```python
# 删除用户
utility.delete_user(user="analyst")

print("✅ 用户 analyst 已删除")
```

### 列出所有用户

```python
# 列出所有用户
users = utility.list_users()
print(f"当前用户列表：{users}")

# 输出示例：
# 当前用户列表：['root', 'admin', 'analyst', 'readonly_user']
```

---

## 客户端连接

### 基本连接

```python
from pymilvus import connections

# 连接到 Milvus
connections.connect(
    alias="default",
    host="localhost",
    port="19530",
    user="analyst",
    password="AnalystPass123!"
)

print("✅ 连接成功")
```

### 使用环境变量

```python
import os
from pymilvus import connections
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

# 从环境变量读取凭证
connections.connect(
    alias="default",
    host=os.getenv("MILVUS_HOST", "localhost"),
    port=os.getenv("MILVUS_PORT", "19530"),
    user=os.getenv("MILVUS_USER"),
    password=os.getenv("MILVUS_PASSWORD")
)

print("✅ 安全连接成功")
```

**.env 文件示例：**

```bash
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_USER=analyst
MILVUS_PASSWORD=AnalystPass123!
```

### 连接池管理

```python
from pymilvus import connections

class MilvusConnectionPool:
    def __init__(self, host, port, user, password):
        self.host = host
        self.port = port
        self.user = user
        self.password = password
        self.alias = "default"
        self._connected = False

    def connect(self):
        """建立连接"""
        if not self._connected:
            connections.connect(
                alias=self.alias,
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password
            )
            self._connected = True
            print("✅ 连接已建立")

    def disconnect(self):
        """断开连接"""
        if self._connected:
            connections.disconnect(self.alias)
            self._connected = False
            print("✅ 连接已断开")

    def __enter__(self):
        """上下文管理器：进入"""
        self.connect()
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """上下文管理器：退出"""
        self.disconnect()

# 使用上下文管理器
with MilvusConnectionPool(
    host="localhost",
    port="19530",
    user="analyst",
    password="AnalystPass123!"
) as pool:
    # 在这里执行 Milvus 操作
    from pymilvus import utility
    collections = utility.list_collections()
    print(f"Collections: {collections}")

# 自动断开连接
```

---

## 完整的用户管理系统

### 用户管理类

```python
from pymilvus import connections, utility
from typing import List, Dict
import logging

class MilvusUserManager:
    def __init__(self, admin_user: str, admin_password: str):
        """初始化用户管理器"""
        self.admin_user = admin_user
        self.admin_password = admin_password
        self.logger = logging.getLogger("milvus_user_manager")

        # 连接到 Milvus
        connections.connect(
            alias="admin",
            host="localhost",
            port="19530",
            user=admin_user,
            password=admin_password
        )

    def create_user(self, username: str, password: str) -> bool:
        """创建用户"""
        try:
            # 检查用户是否已存在
            if username in utility.list_users():
                self.logger.warning(f"用户 {username} 已存在")
                return False

            # 创建用户
            utility.create_user(user=username, password=password)
            self.logger.info(f"✅ 用户 {username} 已创建")
            return True

        except Exception as e:
            self.logger.error(f"❌ 创建用户失败：{e}")
            return False

    def delete_user(self, username: str) -> bool:
        """删除用户"""
        try:
            # 检查用户是否存在
            if username not in utility.list_users():
                self.logger.warning(f"用户 {username} 不存在")
                return False

            # 不能删除 root 用户
            if username == "root":
                self.logger.error("❌ 不能删除 root 用户")
                return False

            # 删除用户
            utility.delete_user(user=username)
            self.logger.info(f"✅ 用户 {username} 已删除")
            return True

        except Exception as e:
            self.logger.error(f"❌ 删除用户失败：{e}")
            return False

    def update_password(self, username: str, old_password: str, new_password: str) -> bool:
        """修改密码"""
        try:
            utility.update_password(
                user=username,
                old_password=old_password,
                new_password=new_password
            )
            self.logger.info(f"✅ 用户 {username} 的密码已修改")
            return True

        except Exception as e:
            self.logger.error(f"❌ 修改密码失败：{e}")
            return False

    def list_users(self) -> List[str]:
        """列出所有用户"""
        return utility.list_users()

    def user_exists(self, username: str) -> bool:
        """检查用户是否存在"""
        return username in utility.list_users()

# 使用示例
manager = MilvusUserManager(
    admin_user="root",
    admin_password="NewSecurePassword123!"
)

# 创建用户
manager.create_user("analyst", "AnalystPass123!")
manager.create_user("readonly_user", "ReadonlyPass123!")

# 列出所有用户
users = manager.list_users()
print(f"所有用户：{users}")

# 修改密码
manager.update_password(
    username="analyst",
    old_password="AnalystPass123!",
    new_password="NewAnalystPass456!"
)

# 删除用户
manager.delete_user("readonly_user")
```

---

## 认证失败处理

### 常见错误

#### 1. 用户名或密码错误

```python
from pymilvus import connections

try:
    connections.connect(
        alias="default",
        host="localhost",
        port="19530",
        user="analyst",
        password="WrongPassword"  # 错误的密码
    )
except Exception as e:
    print(f"❌ 认证失败：{e}")
    # 输出：❌ 认证失败：<RpcError of RPC that terminated with:
    #       status = StatusCode.UNAUTHENTICATED
    #       details = "authentication failed"
```

#### 2. 用户不存在

```python
try:
    connections.connect(
        alias="default",
        host="localhost",
        port="19530",
        user="nonexistent_user",  # 不存在的用户
        password="SomePassword"
    )
except Exception as e:
    print(f"❌ 用户不存在：{e}")
```

#### 3. 认证未启用

```python
# 如果服务器未启用认证，带凭证的连接也会成功
# 但这是不安全的！
connections.connect(
    alias="default",
    host="localhost",
    port="19530",
    user="any_user",
    password="any_password"
)
# ⚠️ 如果连接成功，说明认证未启用！
```

### 错误处理最佳实践

```python
from pymilvus import connections
import logging

logger = logging.getLogger("milvus_auth")

def safe_connect(host: str, port: str, user: str, password: str, max_retries: int = 3):
    """安全连接，带重试机制"""
    for attempt in range(max_retries):
        try:
            connections.connect(
                alias="default",
                host=host,
                port=port,
                user=user,
                password=password,
                timeout=10  # 10秒超时
            )
            logger.info(f"✅ 连接成功（尝试 {attempt + 1}/{max_retries}）")
            return True

        except Exception as e:
            logger.error(f"❌ 连接失败（尝试 {attempt + 1}/{max_retries}）：{e}")

            if "UNAUTHENTICATED" in str(e):
                # 认证失败，不重试
                logger.error("认证失败，请检查用户名和密码")
                return False

            if attempt < max_retries - 1:
                # 等待后重试
                import time
                time.sleep(2 ** attempt)  # 指数退避
            else:
                logger.error("达到最大重试次数")
                return False

    return False

# 使用
success = safe_connect(
    host="localhost",
    port="19530",
    user="analyst",
    password="AnalystPass123!"
)
```

---

## 生产环境配置

### 1. 密码管理

#### 使用密钥管理服务（KMS）

```python
import boto3
from pymilvus import connections

def get_password_from_kms(secret_name: str) -> str:
    """从 AWS Secrets Manager 获取密码"""
    client = boto3.client('secretsmanager', region_name='us-east-1')

    try:
        response = client.get_secret_value(SecretId=secret_name)
        return response['SecretString']
    except Exception as e:
        print(f"❌ 获取密码失败：{e}")
        raise

# 使用
password = get_password_from_kms("milvus/analyst/password")

connections.connect(
    host="milvus.example.com",
    user="analyst",
    password=password
)
```

#### 使用 HashiCorp Vault

```python
import hvac
from pymilvus import connections

def get_password_from_vault(path: str) -> str:
    """从 Vault 获取密码"""
    client = hvac.Client(url='http://vault.example.com:8200')

    # 使用 Token 认证
    client.token = os.getenv('VAULT_TOKEN')

    # 读取密码
    secret = client.secrets.kv.v2.read_secret_version(path=path)
    return secret['data']['data']['password']

# 使用
password = get_password_from_vault("milvus/analyst")

connections.connect(
    host="milvus.example.com",
    user="analyst",
    password=password
)
```

### 2. 连接配置类

```python
import os
from dataclasses import dataclass
from pymilvus import connections

@dataclass
class MilvusConfig:
    """Milvus 连接配置"""
    host: str
    port: str
    user: str
    password: str
    secure: bool = False
    server_pem_path: str = None

    @classmethod
    def from_env(cls):
        """从环境变量加载配置"""
        return cls(
            host=os.getenv("MILVUS_HOST", "localhost"),
            port=os.getenv("MILVUS_PORT", "19530"),
            user=os.getenv("MILVUS_USER"),
            password=os.getenv("MILVUS_PASSWORD"),
            secure=os.getenv("MILVUS_TLS_ENABLED", "false").lower() == "true",
            server_pem_path=os.getenv("MILVUS_TLS_CERT_PATH")
        )

    def connect(self, alias: str = "default"):
        """建立连接"""
        connections.connect(
            alias=alias,
            host=self.host,
            port=self.port,
            user=self.user,
            password=self.password,
            secure=self.secure,
            server_pem_path=self.server_pem_path
        )

# 使用
config = MilvusConfig.from_env()
config.connect()
```

### 3. 健康检查

```python
from pymilvus import connections, utility

def health_check() -> bool:
    """检查 Milvus 连接健康状态"""
    try:
        # 尝试连接
        connections.connect(
            alias="health_check",
            host="localhost",
            port="19530",
            user="health_check_user",
            password="HealthCheckPass123!",
            timeout=5
        )

        # 检查是否可以列出 Collection
        collections = utility.list_collections()

        # 断开连接
        connections.disconnect("health_check")

        print("✅ 健康检查通过")
        return True

    except Exception as e:
        print(f"❌ 健康检查失败：{e}")
        return False

# 定期执行健康检查
import time

while True:
    health_check()
    time.sleep(60)  # 每60秒检查一次
```

---

## 与 RAG 系统集成

### 场景1：Flask API 集成

```python
from flask import Flask, request, jsonify
from pymilvus import connections, Collection
import os

app = Flask(__name__)

# 应用启动时建立连接
@app.before_first_request
def init_milvus():
    connections.connect(
        alias="default",
        host=os.getenv("MILVUS_HOST"),
        port=os.getenv("MILVUS_PORT"),
        user=os.getenv("MILVUS_USER"),
        password=os.getenv("MILVUS_PASSWORD"),
        secure=True
    )
    print("✅ Milvus 连接已建立")

@app.route("/search", methods=["POST"])
def search():
    """搜索接口"""
    try:
        # 获取查询参数
        data = request.json
        query_vector = data["vector"]
        collection_name = data["collection"]

        # 执行搜索
        collection = Collection(collection_name)
        results = collection.search(
            data=[query_vector],
            anns_field="embedding",
            param={"metric_type": "L2", "params": {"nprobe": 10}},
            limit=10
        )

        return jsonify({
            "status": "success",
            "results": [
                {"id": hit.id, "distance": hit.distance}
                for hit in results[0]
            ]
        })

    except Exception as e:
        return jsonify({
            "status": "error",
            "message": str(e)
        }), 500

# 应用关闭时断开连接
@app.teardown_appcontext
def close_milvus(error):
    connections.disconnect("default")
    print("✅ Milvus 连接已断开")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
```

### 场景2：FastAPI 集成

```python
from fastapi import FastAPI, HTTPException, Depends
from pymilvus import connections, Collection
from pydantic import BaseModel
import os

app = FastAPI()

# 连接配置
class MilvusConnection:
    def __init__(self):
        self.connected = False

    def connect(self):
        if not self.connected:
            connections.connect(
                alias="default",
                host=os.getenv("MILVUS_HOST"),
                port=os.getenv("MILVUS_PORT"),
                user=os.getenv("MILVUS_USER"),
                password=os.getenv("MILVUS_PASSWORD"),
                secure=True
            )
            self.connected = True

    def disconnect(self):
        if self.connected:
            connections.disconnect("default")
            self.connected = False

milvus_conn = MilvusConnection()

@app.on_event("startup")
async def startup_event():
    """应用启动时连接 Milvus"""
    milvus_conn.connect()
    print("✅ Milvus 连接已建立")

@app.on_event("shutdown")
async def shutdown_event():
    """应用关闭时断开连接"""
    milvus_conn.disconnect()
    print("✅ Milvus 连接已断开")

class SearchRequest(BaseModel):
    vector: list[float]
    collection: str
    limit: int = 10

@app.post("/search")
async def search(request: SearchRequest):
    """搜索接口"""
    try:
        collection = Collection(request.collection)
        results = collection.search(
            data=[request.vector],
            anns_field="embedding",
            param={"metric_type": "L2", "params": {"nprobe": 10}},
            limit=request.limit
        )

        return {
            "status": "success",
            "results": [
                {"id": hit.id, "distance": hit.distance}
                for hit in results[0]
            ]
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

---

## 监控和审计

### 连接监控

```python
import logging
from datetime import datetime
from pymilvus import connections

class MilvusConnectionMonitor:
    def __init__(self):
        self.logger = logging.getLogger("milvus_connection_monitor")
        self.connection_count = 0
        self.failed_attempts = 0

    def connect_with_monitoring(self, host, port, user, password):
        """带监控的连接"""
        start_time = datetime.now()

        try:
            connections.connect(
                alias="default",
                host=host,
                port=port,
                user=user,
                password=password
            )

            # 记录成功
            duration = (datetime.now() - start_time).total_seconds()
            self.connection_count += 1

            self.logger.info({
                "event": "CONNECTION_SUCCESS",
                "user": user,
                "host": host,
                "duration_seconds": duration,
                "timestamp": datetime.now()
            })

            return True

        except Exception as e:
            # 记录失败
            self.failed_attempts += 1

            self.logger.error({
                "event": "CONNECTION_FAILED",
                "user": user,
                "host": host,
                "error": str(e),
                "timestamp": datetime.now()
            })

            return False

    def get_stats(self):
        """获取统计信息"""
        return {
            "total_connections": self.connection_count,
            "failed_attempts": self.failed_attempts,
            "success_rate": self.connection_count / (self.connection_count + self.failed_attempts)
                if (self.connection_count + self.failed_attempts) > 0 else 0
        }

# 使用
monitor = MilvusConnectionMonitor()

monitor.connect_with_monitoring(
    host="localhost",
    port="19530",
    user="analyst",
    password="AnalystPass123!"
)

# 查看统计
stats = monitor.get_stats()
print(f"连接统计：{stats}")
```

---

## 小结

**认证机制实现的关键点：**

1. **服务端配置**：启用 `authorizationEnabled: true`
2. **用户管理**：创建、删除、修改密码
3. **客户端连接**：使用用户名和密码连接
4. **密码安全**：使用环境变量或密钥管理服务
5. **错误处理**：处理认证失败、重试机制
6. **生产环境**：连接池、健康检查、监控审计
7. **RAG 集成**：Flask/FastAPI 集成示例

**下一步：** 学习授权机制（RBAC）的详细实现
