# 大模型API调用 - 最小可用

掌握以下 20% 的核心知识，就能解决 80% 的 RAG 开发需求。

---

## 4.1 安装 SDK

```bash
# OpenAI
pip install openai

# Anthropic
pip install anthropic
```

**就这两行，环境就准备好了。**

---

## 4.2 配置 API Key

```python
# 方式1：环境变量（推荐）
# 在终端设置：
# export OPENAI_API_KEY="sk-..."
# export ANTHROPIC_API_KEY="sk-ant-..."

from openai import OpenAI
client = OpenAI()  # 自动读取环境变量

# 方式2：代码中指定（不推荐用于生产）
client = OpenAI(api_key="sk-...")
```

**安全提醒：**
- ❌ 不要把 API Key 写在代码里
- ❌ 不要提交到 Git
- ✅ 使用环境变量或密钥管理服务

---

## 4.3 发送请求

```python
from openai import OpenAI

client = OpenAI()

response = client.chat.completions.create(
    model="gpt-4o",           # 模型名称
    messages=[                 # 消息列表
        {"role": "user", "content": "你好"}
    ]
)
```

**记住这个结构：**
```
client.chat.completions.create(
    model = "模型名",
    messages = [消息列表]
)
```

---

## 4.4 解析响应

```python
# 获取回复文本
answer = response.choices[0].message.content
print(answer)

# 响应结构
response.choices[0].message.content  # 回复内容
response.choices[0].finish_reason    # 结束原因：stop/length
response.usage.prompt_tokens         # 输入 token 数
response.usage.completion_tokens     # 输出 token 数
response.usage.total_tokens          # 总 token 数
```

**最常用的就是：** `response.choices[0].message.content`

---

## 4.5 错误处理

```python
from openai import OpenAI, APIError, RateLimitError, APIConnectionError

client = OpenAI()

try:
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": "你好"}]
    )
    print(response.choices[0].message.content)

except RateLimitError:
    print("请求太频繁，请稍后重试")

except APIConnectionError:
    print("网络连接失败")

except APIError as e:
    print(f"API 错误：{e}")
```

**三种最常见的错误：**
1. `RateLimitError` - 超过速率限制
2. `APIConnectionError` - 网络问题
3. `APIError` - 其他 API 错误

---

## 完整的最小可用代码

```python
"""
大模型 API 调用 - 最小可用模板
复制这段代码，改改就能用
"""
from openai import OpenAI, APIError, RateLimitError

# 1. 创建客户端（需要设置环境变量 OPENAI_API_KEY）
client = OpenAI()

# 2. 定义消息
messages = [
    {"role": "system", "content": "你是一个helpful助手"},
    {"role": "user", "content": "什么是RAG？"}
]

# 3. 发送请求
try:
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.1,  # RAG 场景用低温度
        max_tokens=500
    )

    # 4. 获取回复
    answer = response.choices[0].message.content
    print(answer)

    # 5. 查看 token 使用量（可选）
    print(f"\n使用 token: {response.usage.total_tokens}")

except RateLimitError:
    print("请求太频繁")
except APIError as e:
    print(f"API 错误: {e}")
```

---

## 这些知识足以：

- ✅ 调用 OpenAI/Anthropic API 生成文本
- ✅ 构建 RAG 系统的生成模块
- ✅ 处理常见错误情况
- ✅ 控制输出的随机性和长度
- ✅ 为后续学习 Prompt Engineering 打基础

---

## 速查卡片

| 任务 | 代码 |
|------|------|
| 创建客户端 | `client = OpenAI()` |
| 发送请求 | `client.chat.completions.create(model=..., messages=...)` |
| 获取回复 | `response.choices[0].message.content` |
| 流式输出 | `stream=True` + `for chunk in stream` |
| 低随机性 | `temperature=0` |
| 限制长度 | `max_tokens=500` |

---

**上一节：** [03_核心概念.md](./03_核心概念.md)
**下一节：** [05_双重类比.md](./05_双重类比.md) - 用熟悉的概念理解 API
