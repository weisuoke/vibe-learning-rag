# 实战代码 - 场景2：复合条件查询

> 掌握AND/OR/NOT运算符，构建复杂的过滤条件

---

## 场景描述

**目标**：演示如何使用布尔运算符（AND、OR、NOT）组合多个条件，构建复杂的过滤表达式。

**涉及知识点**：
- AND运算符（所有条件都必须满足）
- OR运算符（至少一个条件满足）
- NOT运算符（条件取反）
- 括号控制优先级
- 动态构建过滤表达式

---

## 完整代码

```python
"""
场景2：复合条件查询
演示：使用AND/OR/NOT构建复杂过滤条件
"""

from pymilvus import (
    connections,
    Collection,
    FieldSchema,
    CollectionSchema,
    DataType,
    utility
)
import numpy as np
from typing import List, Dict, Optional

# ===== 1. 连接到Milvus =====
print("=== 1. 连接到Milvus ===")
connections.connect(alias="default", host="localhost", port="19530")
print("✅ 连接成功")

# ===== 2. 创建Collection =====
print("\n=== 2. 创建Collection ===")

fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=128),
    FieldSchema(name="title", dtype=DataType.VARCHAR, max_length=500),
    FieldSchema(name="category", dtype=DataType.VARCHAR, max_length=100),
    FieldSchema(name="author", dtype=DataType.VARCHAR, max_length=200),
    FieldSchema(name="year", dtype=DataType.INT16),
    FieldSchema(name="price", dtype=DataType.FLOAT),
    FieldSchema(name="rating", dtype=DataType.DOUBLE),
    FieldSchema(name="is_published", dtype=DataType.BOOL),
    FieldSchema(name="is_featured", dtype=DataType.BOOL),
    FieldSchema(name="view_count", dtype=DataType.INT32),
]

schema = CollectionSchema(fields=fields, description="Complex filter demo")
collection_name = "complex_filter_demo"

if utility.has_collection(collection_name):
    utility.drop_collection(collection_name)

collection = Collection(name=collection_name, schema=schema)
print(f"✅ 创建Collection: {collection_name}")

# ===== 3. 插入测试数据 =====
print("\n=== 3. 插入测试数据 ===")

test_data = [
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "Python深度学习",
        "category": "ai",
        "author": "张三",
        "year": 2024,
        "price": 159.99,
        "rating": 4.8,
        "is_published": True,
        "is_featured": True,
        "view_count": 5000
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "Java编程艺术",
        "category": "tech",
        "author": "李四",
        "year": 2023,
        "price": 129.99,
        "rating": 4.5,
        "is_published": True,
        "is_featured": False,
        "view_count": 3000
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "机器学习实战",
        "category": "ml",
        "author": "王五",
        "year": 2024,
        "price": 139.99,
        "rating": 4.9,
        "is_published": True,
        "is_featured": True,
        "view_count": 8000
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "数据结构基础",
        "category": "tech",
        "author": "赵六",
        "year": 2022,
        "price": 89.99,
        "rating": 4.3,
        "is_published": False,
        "is_featured": False,
        "view_count": 1500
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "人工智能导论",
        "category": "ai",
        "author": "张三",
        "year": 2024,
        "price": 119.99,
        "rating": 4.6,
        "is_published": True,
        "is_featured": False,
        "view_count": 4000
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "Python数据分析",
        "category": "data",
        "author": "李四",
        "year": 2023,
        "price": 109.99,
        "rating": 4.4,
        "is_published": True,
        "is_featured": False,
        "view_count": 2500
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "深度学习进阶",
        "category": "ai",
        "author": "王五",
        "year": 2024,
        "price": 179.99,
        "rating": 4.7,
        "is_published": True,
        "is_featured": True,
        "view_count": 6000
    },
    {
        "embedding": np.random.rand(128).tolist(),
        "title": "算法设计与分析",
        "category": "tech",
        "author": "赵六",
        "year": 2023,
        "price": 149.99,
        "rating": 4.8,
        "is_published": True,
        "is_featured": False,
        "view_count": 3500
    },
]

data = {
    "embedding": [item["embedding"] for item in test_data],
    "title": [item["title"] for item in test_data],
    "category": [item["category"] for item in test_data],
    "author": [item["author"] for item in test_data],
    "year": [item["year"] for item in test_data],
    "price": [item["price"] for item in test_data],
    "rating": [item["rating"] for item in test_data],
    "is_published": [item["is_published"] for item in test_data],
    "is_featured": [item["is_featured"] for item in test_data],
    "view_count": [item["view_count"] for item in test_data],
}

collection.insert(data)
print(f"✅ 插入 {len(test_data)} 条数据")

# 创建索引并加载
index_params = {"index_type": "IVF_FLAT", "metric_type": "L2", "params": {"nlist": 128}}
collection.create_index(field_name="embedding", index_params=index_params)
collection.load()
print("✅ 创建索引并加载Collection")

# ===== 4. AND运算符示例 =====
print("\n=== 4. AND运算符示例 ===")

query_vector = np.random.rand(128).tolist()

# 示例1：两个条件
print("\n【示例1】两个AND条件")
print("查询条件: year == 2024 and category == 'ai'")
expr = "year == 2024 and category == 'ai'"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('year')}, {hit.entity.get('category')})")

# 示例2：多个AND条件
print("\n【示例2】多个AND条件")
print("查询条件: year == 2024 and category == 'ai' and price < 150")
expr = "year == 2024 and category == 'ai' and price < 150"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "price"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (¥{hit.entity.get('price')})")

# 示例3：范围查询 + 状态过滤
print("\n【示例3】范围查询 + 状态过滤")
print("查询条件: price >= 100 and price <= 150 and is_published == true")
expr = "price >= 100 and price <= 150 and is_published == true"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "price", "is_published"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (¥{hit.entity.get('price')})")

# ===== 5. OR运算符示例 =====
print("\n=== 5. OR运算符示例 ===")

# 示例4：两个OR条件
print("\n【示例4】两个OR条件")
print("查询条件: category == 'ai' or category == 'ml'")
expr = "category == 'ai' or category == 'ml'"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')})")

# 示例5：使用IN代替多个OR（推荐）
print("\n【示例5】使用IN代替多个OR（推荐）")
print("查询条件: category in ['ai', 'ml', 'data']")
expr = "category in ['ai', 'ml', 'data']"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')})")

# 示例6：多个特性标记
print("\n【示例6】多个特性标记（OR）")
print("查询条件: is_featured == true or rating >= 4.8")
expr = "is_featured == true or rating >= 4.8"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "is_featured", "rating"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (精选: {hit.entity.get('is_featured')}, 评分: {hit.entity.get('rating')})")

# ===== 6. AND + OR 混合使用 =====
print("\n=== 6. AND + OR 混合使用 ===")

# 示例7：理解优先级（and优先于or）
print("\n【示例7】理解优先级")
print("查询条件: year == 2024 or year == 2023 and category == 'tech'")
print("实际含义: year == 2024 or (year == 2023 and category == 'tech')")
expr = "year == 2024 or year == 2023 and category == 'tech'"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('year')}, {hit.entity.get('category')})")

# 示例8：使用括号明确优先级
print("\n【示例8】使用括号明确优先级")
print("查询条件: (year == 2024 or year == 2023) and category == 'tech'")
expr = "(year == 2024 or year == 2023) and category == 'tech'"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('year')}, {hit.entity.get('category')})")

# 示例9：复杂混合条件
print("\n【示例9】复杂混合条件")
print("查询条件: (category == 'ai' or category == 'ml') and year == 2024 and price < 160")
expr = "(category == 'ai' or category == 'ml') and year == 2024 and price < 160"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category", "year", "price"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')}, ¥{hit.entity.get('price')})")

# ===== 7. NOT运算符示例 =====
print("\n=== 7. NOT运算符示例 ===")

# 示例10：NOT基础用法
print("\n【示例10】NOT基础用法")
print("查询条件: not (category == 'tech')")
expr = "not (category == 'tech')"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')})")

# 示例11：使用!=更简洁
print("\n【示例11】使用!=更简洁（推荐）")
print("查询条件: category != 'tech'")
expr = "category != 'tech'"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')})")

# 示例12：NOT与AND/OR组合
print("\n【示例12】NOT与AND/OR组合")
print("查询条件: year == 2024 and not (is_featured == true)")
expr = "year == 2024 and not (is_featured == true)"
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "is_featured"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (精选: {hit.entity.get('is_featured')})")

# ===== 8. 动态构建过滤表达式 =====
print("\n=== 8. 动态构建过滤表达式 ===")

def build_filter_expression(filters: Dict) -> Optional[str]:
    """动态构建过滤表达式"""
    conditions = []

    # 年份过滤
    if "year" in filters:
        conditions.append(f"year == {filters['year']}")

    # 分类过滤（支持多个）
    if "categories" in filters and filters["categories"]:
        cats = [f"'{c}'" for c in filters["categories"]]
        conditions.append(f"category in [{', '.join(cats)}]")

    # 价格范围
    if "min_price" in filters:
        conditions.append(f"price >= {filters['min_price']}")
    if "max_price" in filters:
        conditions.append(f"price <= {filters['max_price']}")

    # 评分过滤
    if "min_rating" in filters:
        conditions.append(f"rating >= {filters['min_rating']}")

    # 状态过滤
    if "is_published" in filters:
        value = "true" if filters["is_published"] else "false"
        conditions.append(f"is_published == {value}")

    # 作者过滤
    if "author" in filters:
        author = filters["author"].replace("'", "\\'")
        conditions.append(f"author == '{author}'")

    # 浏览量过滤
    if "min_views" in filters:
        conditions.append(f"view_count >= {filters['min_views']}")

    return " and ".join(conditions) if conditions else None

# 示例13：动态过滤（场景1）
print("\n【示例13】动态过滤 - 场景1")
filters1 = {
    "year": 2024,
    "categories": ["ai", "ml"],
    "min_rating": 4.5
}
expr = build_filter_expression(filters1)
print(f"构建的表达式: {expr}")
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "year", "category", "rating"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} ({hit.entity.get('category')}, 评分: {hit.entity.get('rating')})")

# 示例14：动态过滤（场景2）
print("\n【示例14】动态过滤 - 场景2")
filters2 = {
    "min_price": 100,
    "max_price": 150,
    "is_published": True,
    "min_views": 3000
}
expr = build_filter_expression(filters2)
print(f"构建的表达式: {expr}")
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "price", "view_count"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (¥{hit.entity.get('price')}, 浏览: {hit.entity.get('view_count')})")

# 示例15：动态过滤（场景3 - 特定作者）
print("\n【示例15】动态过滤 - 场景3（特定作者）")
filters3 = {
    "author": "张三",
    "year": 2024,
    "is_published": True
}
expr = build_filter_expression(filters3)
print(f"构建的表达式: {expr}")
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "author", "year"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')} (作者: {hit.entity.get('author')})")

# ===== 9. 实际应用场景 =====
print("\n=== 9. 实际应用场景 ===")

# 场景1：电商高级筛选
print("\n【场景1】电商高级筛选")
print("需求: 2024年的AI或ML书籍，价格100-160，评分4.5以上，已发布")
expr = """
    year == 2024
    and (category == 'ai' or category == 'ml')
    and price >= 100 and price <= 160
    and rating >= 4.5
    and is_published == true
"""
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "category", "price", "rating"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')}")
    print(f"    分类: {hit.entity.get('category')}, 价格: ¥{hit.entity.get('price')}, 评分: {hit.entity.get('rating')}")

# 场景2：热门内容推荐
print("\n【场景2】热门内容推荐")
print("需求: 精选或高评分(>=4.8)或高浏览量(>=5000)的已发布内容")
expr = """
    (is_featured == true or rating >= 4.8 or view_count >= 5000)
    and is_published == true
"""
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param={"metric_type": "L2", "params": {"nprobe": 10}},
    limit=10,
    expr=expr,
    output_fields=["title", "is_featured", "rating", "view_count"]
)
print(f"找到 {len(results[0])} 条结果:")
for hit in results[0]:
    print(f"  - {hit.entity.get('title')}")
    print(f"    精选: {hit.entity.get('is_featured')}, 评分: {hit.entity.get('rating')}, 浏览: {hit.entity.get('view_count')}")

# ===== 10. 清理资源 =====
print("\n=== 10. 清理资源 ===")
collection.release()
connections.disconnect("default")
print("✅ 清理完成")

print("\n=== 示例完成 ===")
```

---

## 核心知识点总结

### 1. 运算符优先级

```
not > and > or
```

**示例**：
```python
# 没有括号
expr = "a == 1 or b == 2 and c == 3"
# 等价于
expr = "a == 1 or (b == 2 and c == 3)"

# 使用括号明确优先级
expr = "(a == 1 or b == 2) and c == 3"
```

### 2. AND运算符

**用途**：所有条件都必须满足

```python
# 基础用法
expr = "year == 2024 and category == 'ai'"

# 多个条件
expr = "year == 2024 and category == 'ai' and price < 150"

# 范围查询
expr = "price >= 100 and price <= 200"
```

### 3. OR运算符

**用途**：至少一个条件满足

```python
# 基础用法
expr = "category == 'ai' or category == 'ml'"

# 推荐：使用IN代替
expr = "category in ['ai', 'ml']"
```

### 4. NOT运算符

**用途**：条件取反

```python
# 基础用法
expr = "not (category == 'tech')"

# 推荐：使用!=
expr = "category != 'tech'"

# 复杂条件
expr = "not (year == 2023 and category == 'old')"
```

### 5. 动态构建表达式

```python
def build_filter_expression(filters: Dict) -> Optional[str]:
    conditions = []

    if "year" in filters:
        conditions.append(f"year == {filters['year']}")

    if "categories" in filters:
        cats = [f"'{c}'" for c in filters["categories"]]
        conditions.append(f"category in [{', '.join(cats)}]")

    return " and ".join(conditions) if conditions else None
```

---

## 最佳实践

### 1. 使用括号明确优先级

```python
# ❌ 不推荐：依赖默认优先级
expr = "a == 1 or b == 2 and c == 3"

# ✅ 推荐：使用括号
expr = "(a == 1 or b == 2) and c == 3"
```

### 2. 使用IN代替多个OR

```python
# ❌ 不推荐：多个OR
expr = "category == 'ai' or category == 'ml' or category == 'data'"

# ✅ 推荐：使用IN
expr = "category in ['ai', 'ml', 'data']"
```

### 3. 使用!=代替NOT

```python
# ❌ 不推荐：使用NOT
expr = "not (category == 'tech')"

# ✅ 推荐：使用!=
expr = "category != 'tech'"
```

### 4. 提取公共条件

```python
# ❌ 冗余
expr = "(year == 2024 and category == 'ai') or (year == 2024 and category == 'ml')"

# ✅ 简化
expr = "year == 2024 and (category == 'ai' or category == 'ml')"
# 或者
expr = "year == 2024 and category in ['ai', 'ml']"
```

---

## 下一步

- **场景3**：学习标量索引优化，提升查询性能
- **场景4**：应用到RAG混合检索系统
