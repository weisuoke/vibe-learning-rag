# 最小可用知识

掌握以下内容，就能开始使用消息队列与流式响应：

---

## 4.1 理解三种核心消息类型

**User Message**：用户输入
**Steering Message**：中断当前响应（Enter 键）
**Follow-up Message**：等待完成后追加（Alt+Enter 键）

```typescript
// 基础使用
queue.enqueue({ type: 'user', content: '你好' });
queue.enqueue({ type: 'steering', content: '停止' }); // 立即中断
queue.enqueue({ type: 'follow-up', content: '继续' }); // 等待完成
```

**实际应用**：在 pi coding agent 中，按 Enter 中断，按 Alt+Enter 追问。

---

## 4.2 实现基础消息队列

**核心操作**：enqueue（入队）、dequeue（出队）、peek（查看队首）

```typescript
class MessageQueue {
  private queue: Message[] = [];

  enqueue(message: Message): void {
    this.queue.push(message);
  }

  dequeue(): Message | null {
    return this.queue.shift() || null;
  }

  peek(): Message | null {
    return this.queue[0] || null;
  }
}
```

**实际应用**：管理用户输入、工具调用、LLM 响应的顺序。

---

## 4.3 使用 SSE 实现流式响应

**核心步骤**：设置响应头 → 发送事件 → 关闭连接

```typescript
// 服务端
app.get('/stream', (req, res) => {
  res.setHeader('Content-Type', 'text/event-stream');
  res.write(`data: ${JSON.stringify({ content: '你好' })}\n\n`);
  res.end();
});

// 客户端
const eventSource = new EventSource('/stream');
eventSource.onmessage = (event) => {
  console.log(JSON.parse(event.data).content);
};
```

**实际应用**：Agent 逐字显示响应内容。

---

## 4.4 设置消息优先级

**核心规则**：Steering (0) > User (1) > Tool results (2)

```typescript
enum MessagePriority {
  CRITICAL = 0,  // Steering
  HIGH = 1,      // User
  NORMAL = 2     // Tool results
}

// 自动分配优先级
function assignPriority(type: MessageType): MessagePriority {
  if (type === 'steering') return MessagePriority.CRITICAL;
  if (type === 'user') return MessagePriority.HIGH;
  return MessagePriority.NORMAL;
}
```

**实际应用**：确保 Steering 消息立即处理，中断当前响应。

---

## 4.5 处理流式事件

**核心事件**：start（开始）、delta（增量）、end（结束）

```typescript
async function handleStream(stream: AsyncIterable<StreamEvent>) {
  for await (const event of stream) {
    switch (event.type) {
      case 'start':
        console.log('开始生成');
        break;
      case 'delta':
        process.stdout.write(event.content); // 逐字显示
        break;
      case 'end':
        console.log('\n完成');
        break;
    }
  }
}
```

**实际应用**：处理 LLM 的流式响应，实时显示给用户。

---

## 这些知识足以：

- ✅ 理解 pi-mono 中的消息队列机制
- ✅ 实现基础的消息队列和流式响应
- ✅ 使用 Steering 和 Follow-up 消息
- ✅ 为后续学习高级优化打基础

---

**版本**: v1.0
**最后更新**: 2026-02-19
**维护者**: Claude Code
