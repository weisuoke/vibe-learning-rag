# 最小可用

掌握以下内容，就能开始使用事件系统与钩子：

---

## 4.1 监听生命周期事件（pi.on）

**核心概念：** 使用 `pi.on()` 监听 Agent 运行时的关键事件

**基础用法：**
```typescript
export default function myExtension(pi: ExtensionAPI) {
  // 监听 session 启动
  pi.on('session_start', (session) => {
    console.log('Session started:', session.id);
  });

  // 监听工具调用
  pi.on('tool_call', (tool, args) => {
    console.log('Tool called:', tool.name);
  });
}
```

**必须掌握的 5 个事件：**

1. **session_start** - 会话启动时
   ```typescript
   pi.on('session_start', (session) => {
     // 初始化会话状态
   });
   ```

2. **before_agent_start** - Agent 启动前（可修改消息）
   ```typescript
   pi.on('before_agent_start', (messages) => {
     messages.push({ role: 'system', content: 'Custom instruction' });
   });
   ```

3. **tool_call** - 工具调用时
   ```typescript
   pi.on('tool_call', (tool, args) => {
     // 记录工具调用
   });
   ```

4. **agent_end** - Agent 运行结束
   ```typescript
   pi.on('agent_end', (result) => {
     // 清理资源
   });
   ```

5. **session_shutdown** - 会话关闭时
   ```typescript
   pi.on('session_shutdown', (session) => {
     // 保存状态
   });
   ```

**实际应用：**
- 监控 Agent 运行状态
- 记录日志和统计
- 在关键时刻插入自定义逻辑

---

## 4.2 注入自定义指令（before_agent_start）

**核心概念：** 在 Agent 启动前注入系统指令或项目上下文

**基础用法：**
```typescript
export default function contextInjector(pi: ExtensionAPI) {
  pi.on('before_agent_start', (messages) => {
    // 注入项目上下文
    messages.push({
      role: 'system',
      content: 'You are working on a TypeScript project. Follow best practices.'
    });

    // 注入代码规范
    messages.push({
      role: 'system',
      content: 'Always use async/await instead of .then()'
    });
  });
}
```

**常见应用场景：**

1. **项目上下文注入**
   ```typescript
   pi.on('before_agent_start', (messages) => {
     const projectInfo = {
       name: 'my-project',
       framework: 'React',
       language: 'TypeScript'
     };

     messages.push({
       role: 'system',
       content: `Project: ${JSON.stringify(projectInfo)}`
     });
   });
   ```

2. **代码规范注入**
   ```typescript
   pi.on('before_agent_start', (messages) => {
     messages.push({
       role: 'system',
       content: 'Follow these coding standards:\n- Use ESLint\n- Write tests\n- Add comments'
     });
   });
   ```

3. **角色定制**
   ```typescript
   pi.on('before_agent_start', (messages) => {
     messages.push({
       role: 'system',
       content: 'You are a senior TypeScript developer with 10 years of experience.'
     });
   });
   ```

**实际应用：**
- 定制 Agent 行为
- 注入项目特定知识
- 统一团队开发规范

---

## 4.3 扩展间通信（pi.events）

**核心概念：** 使用 `pi.events` 实现扩展之间的松耦合通信

**基础用法：**
```typescript
// Extension A：发送事件
export default function extensionA(pi: ExtensionAPI) {
  pi.on('session_start', () => {
    pi.events.emit('data-ready', { data: [1, 2, 3] });
  });
}

// Extension B：接收事件
export default function extensionB(pi: ExtensionAPI) {
  pi.events.on('data-ready', ({ data }) => {
    console.log('Received data:', data);
  });
}
```

**3 种常用模式：**

1. **发布-订阅**
   ```typescript
   // 发布者
   pi.events.emit('task-completed', { taskId: '123' });

   // 订阅者
   pi.events.on('task-completed', ({ taskId }) => {
     console.log('Task completed:', taskId);
   });
   ```

2. **请求-响应**
   ```typescript
   // 请求者
   pi.events.emit('data-request', { query: 'user-info' });
   pi.events.once('data-response', (response) => {
     console.log('Response:', response);
   });

   // 响应者
   pi.events.on('data-request', ({ query }) => {
     const data = fetchData(query);
     pi.events.emit('data-response', { data });
   });
   ```

3. **广播通知**
   ```typescript
   // 广播者
   pi.events.emit('agent-completed', { timestamp: Date.now() });

   // 多个监听者
   pi.events.on('agent-completed', () => { /* 日志 */ });
   pi.events.on('agent-completed', () => { /* 监控 */ });
   pi.events.on('agent-completed', () => { /* 通知 */ });
   ```

**实际应用：**
- 模块化功能开发
- 插件协作
- 状态同步

---

## 4.4 命令拦截（Spawn Hooks）

**核心概念：** 使用 `registerSpawnHook` 拦截和修改 bash 命令

**基础用法：**
```typescript
export default function myExtension(pi: ExtensionAPI) {
  pi.registerSpawnHook((command, cwd, env) => {
    // 注入环境变量
    env.NODE_ENV = 'development';
    env.PROJECT_ROOT = cwd;

    // 必须返回所有参数
    return { command, cwd, env };
  });
}
```

**3 种常用场景：**

1. **环境变量注入**
   ```typescript
   pi.registerSpawnHook((command, cwd, env) => {
     env.NODE_ENV = 'development';
     env.DEBUG = '*';
     return { command, cwd, env };
   });
   ```

2. **命令包装**
   ```typescript
   pi.registerSpawnHook((command, cwd, env) => {
     // 为所有命令添加 time 前缀
     const wrappedCommand = `time ${command}`;
     return { command: wrappedCommand, cwd, env };
   });
   ```

3. **危险命令拦截**
   ```typescript
   pi.registerSpawnHook((command, cwd, env) => {
     if (command.includes('rm -rf /')) {
       console.error('⚠️  Dangerous command blocked!');
       return { command: 'echo "Blocked"', cwd, env };
     }
     return { command, cwd, env };
   });
   ```

**实际应用：**
- 开发环境配置
- 命令安全过滤
- 性能监控

---

## 4.5 错误处理与调试

**核心概念：** 在事件处理器中正确处理错误

**基础用法：**
```typescript
export default function myExtension(pi: ExtensionAPI) {
  // 同步处理器：自动捕获错误
  pi.on('tool_call', (tool, args) => {
    try {
      // 可能抛出错误的代码
      processToolCall(tool, args);
    } catch (error) {
      console.error('Error in tool_call handler:', error);
    }
  });

  // 异步处理器：手动捕获错误
  pi.on('session_start', async (session) => {
    try {
      await initializeSession(session);
    } catch (error) {
      console.error('Error initializing session:', error);
    }
  });
}
```

**调试技巧：**

1. **添加日志**
   ```typescript
   pi.on('tool_call', (tool, args) => {
     console.log('[DEBUG] Tool called:', tool.name);
     console.log('[DEBUG] Args:', JSON.stringify(args));
   });
   ```

2. **使用 once() 避免重复执行**
   ```typescript
   // 只执行一次
   pi.once('session_start', (session) => {
     console.log('First session:', session.id);
   });
   ```

3. **清理监听器**
   ```typescript
   const handler = (session) => { /* ... */ };

   pi.on('session_start', handler);

   // 在适当时机注销
   pi.on('session_shutdown', () => {
     pi.off('session_start', handler);
   });
   ```

**实际应用：**
- 防止错误中断 Agent 运行
- 调试扩展逻辑
- 资源清理

---

## 快速上手示例

### 完整的监控扩展

```typescript
import { ExtensionAPI } from '@mariozechner/pi-agent-core';

export default function monitoringExtension(pi: ExtensionAPI) {
  const stats = {
    sessions: 0,
    toolCalls: 0,
    errors: 0
  };

  // 1. 监听 session 启动
  pi.on('session_start', (session) => {
    stats.sessions++;
    console.log('=== Session Started ===');
    console.log('Session ID:', session.id);
    console.log('Total sessions:', stats.sessions);
  });

  // 2. 监听工具调用
  pi.on('tool_call', (tool, args) => {
    stats.toolCalls++;
    console.log('=== Tool Called ===');
    console.log('Tool:', tool.name);
    console.log('Total tool calls:', stats.toolCalls);
  });

  // 3. 监听 Agent 结束
  pi.on('agent_end', (result) => {
    console.log('=== Agent Ended ===');
    console.log('Stats:', stats);
  });

  // 4. 清理资源
  pi.on('session_shutdown', (session) => {
    console.log('=== Session Shutdown ===');
    console.log('Final stats:', stats);
  });
}
```

### 完整的上下文注入扩展

```typescript
export default function contextExtension(pi: ExtensionAPI) {
  // 1. 在 Agent 启动前注入上下文
  pi.on('before_agent_start', (messages) => {
    // 项目信息
    messages.push({
      role: 'system',
      content: 'Project: TypeScript + React + Node.js'
    });

    // 代码规范
    messages.push({
      role: 'system',
      content: 'Follow ESLint rules and write tests'
    });
  });

  // 2. 注入环境变量
  pi.registerSpawnHook((command, cwd, env) => {
    env.NODE_ENV = 'development';
    env.PROJECT_ROOT = cwd;
    return { command, cwd, env };
  });
}
```

### 完整的扩展间通信示例

```typescript
// Extension A：数据提供者
export default function dataProvider(pi: ExtensionAPI) {
  pi.on('session_start', async () => {
    const data = await loadData();
    pi.events.emit('data-ready', { data });
  });
}

// Extension B：数据消费者
export default function dataConsumer(pi: ExtensionAPI) {
  pi.events.on('data-ready', ({ data }) => {
    console.log('Received data:', data.length);
    processData(data);
  });
}
```

---

## 这些知识足以

掌握以上 5 个核心知识点，你就能：

✅ **监控 Agent 运行**
- 记录 session 启动和关闭
- 监控工具调用
- 统计运行数据

✅ **定制 Agent 行为**
- 注入项目上下文
- 添加自定义指令
- 修改 Agent 角色

✅ **实现扩展协作**
- 扩展间发送和接收消息
- 模块化功能开发
- 松耦合的插件系统

✅ **控制命令执行**
- 注入环境变量
- 包装和修改命令
- 拦截危险操作

✅ **调试和优化**
- 添加日志和监控
- 处理错误
- 清理资源

---

## 学习路径建议

### 第 1 步：基础监听（30 分钟）
- 创建一个简单的 Extension
- 监听 `session_start` 和 `tool_call`
- 输出日志

### 第 2 步：注入上下文（30 分钟）
- 使用 `before_agent_start` 注入消息
- 测试不同的系统指令
- 观察 Agent 行为变化

### 第 3 步：扩展通信（30 分钟）
- 创建两个 Extension
- 使用 `pi.events` 实现通信
- 测试发布-订阅模式

### 第 4 步：命令拦截（30 分钟）
- 使用 `registerSpawnHook` 注入环境变量
- 测试命令包装
- 实现简单的安全过滤

### 第 5 步：实战项目（1-2 小时）
- 构建一个完整的监控扩展
- 实现日志记录和统计
- 添加错误处理

---

## 常见问题速查

### Q: 如何监听多个事件？
```typescript
pi.on('session_start', handler1);
pi.on('tool_call', handler2);
pi.on('agent_end', handler3);
```

### Q: 如何在 Agent 启动前注入消息？
```typescript
pi.on('before_agent_start', (messages) => {
  messages.push({ role: 'system', content: 'Custom' });
});
```

### Q: 如何实现扩展间通信？
```typescript
// 发送
pi.events.emit('my-event', { data: 'value' });

// 接收
pi.events.on('my-event', ({ data }) => {
  console.log(data);
});
```

### Q: 如何注入环境变量？
```typescript
pi.registerSpawnHook((command, cwd, env) => {
  env.MY_VAR = 'value';
  return { command, cwd, env };
});
```

### Q: 如何处理错误？
```typescript
pi.on('tool_call', async (tool, args) => {
  try {
    await riskyOperation();
  } catch (error) {
    console.error('Error:', error);
  }
});
```

---

## 下一步学习

完成最小可用知识后，可以继续学习：

- **双重类比** - 理解事件系统的类比和比喻
- **反直觉点** - 避免常见误区
- **实战代码** - 完整的实战示例
- **化骨绵掌** - 10 个知识卡片深入理解

---

**版本：** v1.0
**最后更新：** 2026-02-21
**维护者：** Claude Code
