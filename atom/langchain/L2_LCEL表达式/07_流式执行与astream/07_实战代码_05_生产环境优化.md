# 实战代码 05：生产环境优化

生产环境的完整优化方案。

```python
import asyncio
import time
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

class ProductionStreamingApp:
    def __init__(self):
        self.model = ChatOpenAI(model="gpt-4o-mini")
        self.prompt = ChatPromptTemplate.from_template("{input}")
        self.chain = self.prompt | self.model

    async def stream_with_monitoring(self, user_input: str):
        """带监控的流式执行"""
        start_time = time.time()
        first_token_time = None
        token_count = 0

        try:
            async with asyncio.timeout(30):
                async for chunk in self.chain.astream({"input": user_input}):
                    if first_token_time is None:
                        first_token_time = time.time()

                    token_count += 1
                    print(chunk.content, end="", flush=True)

        except asyncio.TimeoutError:
            print("\n超时，降级到批量模式")
            result = self.chain.invoke({"input": user_input})
            print(result.content)
        except Exception as e:
            print(f"\n错误: {e}")

        total_time = time.time() - start_time
        ttfb = first_token_time - start_time if first_token_time else 0

        print(f"\n\n性能指标:")
        print(f"  TTFB: {ttfb:.3f}s")
        print(f"  总时间: {total_time:.3f}s")
        print(f"  Token数: {token_count}")

app = ProductionStreamingApp()
asyncio.run(app.stream_with_monitoring("介绍Python"))
```

**版本**: LangChain 0.3.x (2025-2026)
