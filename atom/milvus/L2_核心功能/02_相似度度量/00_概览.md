# 相似度度量 - 概览

## 本文档内容

本知识点详细讲解 Milvus 中的相似度度量方式，包括：

### 三种核心度量
- **L2距离（欧氏距离）**：测量向量间的直线距离
- **内积IP（Inner Product）**：测量方向一致性和幅度
- **余弦相似度COSINE**：测量纯方向一致性

### 学习目标
完成本知识点学习后，你将能够：
- ✅ 理解三种度量方式的数学原理和几何意义
- ✅ 根据Embedding模型特性选择合适的度量方式
- ✅ 掌握度量方式对检索结果的影响
- ✅ 在RAG项目中正确配置度量参数
- ✅ 手写实现三种度量算法
- ✅ 理解归一化对度量选择的影响

### 文档结构
本知识点按照原子化学习方法组织，包含 10 个维度：

1. **30字核心** - 快速理解度量本质
2. **第一性原理** - 从根本理解为什么需要度量
3. **核心概念** - 深入学习 L2/IP/COSINE（3个独立文件）
4. **最小可用** - 20% 核心知识解决 80% 问题
5. **双重类比** - 前端开发 + 日常生活类比
6. **反直觉点** - 避开常见误区
7. **实战代码** - 4个完整场景示例
8. **面试必问** - 高频面试题深度解析
9. **化骨绵掌** - 10个2分钟知识卡片
10. **一句话总结** - 精华提炼

### 推荐学习路径

**快速入门**（约30分钟）：
```
01_30字核心.md → 06_最小可用.md → 15_一句话总结.md
```

**深度学习**（约3小时）：
```
按顺序阅读所有文件 (01 → 02 → ... → 15)
```

**实战练习**（约2小时）：
```
运行 09-12 的代码示例，动手实践
```

**面试准备**（约1小时）：
```
13_面试必问.md → 14_化骨绵掌.md
```

### 前置知识
- ✅ 向量的基本概念
- ✅ Milvus Collection 管理（L1_快速入门/02_Collection管理）
- ✅ 向量索引类型（L2_核心功能/01_向量索引类型）
- ✅ Python 基础和 NumPy

### 后续学习
- 📚 L2_核心功能/03_标量过滤
- 📚 L2_核心功能/04_高级索引类型
- 📚 L4_性能优化/01_索引参数调优

---

## 文件列表

### 基础维度
- [01_30字核心.md](./01_30字核心.md) - 一句话理解度量
- [02_第一性原理.md](./02_第一性原理.md) - 从根本理解度量
- [06_最小可用.md](./06_最小可用.md) - 快速上手的核心知识
- [07_双重类比.md](./07_双重类比.md) - 前端+生活类比
- [08_反直觉点.md](./08_反直觉点.md) - 常见误区
- [15_一句话总结.md](./15_一句话总结.md) - 精华总结

### 核心概念（深度学习）
- [03_核心概念_L2距离.md](./03_核心概念_L2距离.md) - 欧氏距离详解
- [04_核心概念_内积IP.md](./04_核心概念_内积IP.md) - 内积详解
- [05_核心概念_余弦相似度COSINE.md](./05_核心概念_余弦相似度COSINE.md) - 余弦相似度详解

### 实战代码（动手实践）
- [09_实战代码_场景1_L2距离实战.md](./09_实战代码_场景1_L2距离实战.md) - L2在文档检索中的应用
- [10_实战代码_场景2_内积IP实战.md](./10_实战代码_场景2_内积IP实战.md) - IP在推荐系统中的应用
- [11_实战代码_场景3_余弦相似度实战.md](./11_实战代码_场景3_余弦相似度实战.md) - COSINE在语义搜索中的应用
- [12_实战代码_场景4_度量选型对比.md](./12_实战代码_场景4_度量选型对比.md) - 三种度量的对比与选型

### 进阶内容
- [13_面试必问.md](./13_面试必问.md) - 面试高频题
- [14_化骨绵掌.md](./14_化骨绵掌.md) - 10个知识卡片

---

## 快速参考

### 度量方式速查表

| 度量方式 | 计算公式 | 值域 | 相似性 | 适用场景 |
|---------|---------|------|--------|---------|
| **L2** | √[Σ(xᵢ-yᵢ)²] | [0, +∞) | 越小越相似 | 未归一化向量 |
| **IP** | Σ(xᵢ×yᵢ) | (-∞, +∞) | 越大越相似 | 推荐系统 |
| **COSINE** | (x·y)/(‖x‖‖y‖) | [-1, 1] | 越大越相似 | 语义搜索 |

### 选型决策速查

```
你的Embedding模型是否归一化？
├─ 是 → COSINE 或 IP（等价，IP更快）
└─ 否 → 根据业务场景
         ├─ 需要考虑向量幅度 → IP
         ├─ 只关注方向 → COSINE
         └─ 物理距离概念 → L2
```

### 常见Embedding模型推荐

| 模型 | 推荐度量 | 原因 |
|------|---------|------|
| OpenAI text-embedding-3 | COSINE | 归一化，语义搜索标准 |
| sentence-transformers | COSINE | 大多数模型归一化 |
| BGE系列 | COSINE | 专为语义搜索设计 |
| Word2Vec | L2/COSINE | 未归一化，看需求 |

### Milvus配置示例

```python
from pymilvus import Collection, FieldSchema, CollectionSchema, DataType

# 定义Schema
fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768)
]
schema = CollectionSchema(fields=fields)

# 创建Collection
collection = Collection(name="my_collection", schema=schema)

# 创建索引时指定度量方式
index_params = {
    "index_type": "IVF_FLAT",
    "metric_type": "COSINE",  # 或 "L2", "IP"
    "params": {"nlist": 128}
}
collection.create_index(field_name="embedding", index_params=index_params)

# 搜索时使用相同的度量方式
search_params = {"metric_type": "COSINE", "params": {"nprobe": 10}}
results = collection.search(
    data=[query_vector],
    anns_field="embedding",
    param=search_params,
    limit=10
)
```

---

## 核心要点

### 1. 度量方式决定"相似"的定义
不同的度量方式对"相似"有不同的数学定义：
- **L2**：两点在空间中的直线距离
- **IP**：两向量的投影长度（方向×幅度）
- **COSINE**：两向量的夹角（纯方向）

### 2. 归一化是关键
- 归一化向量：IP = COSINE（数学等价）
- 未归一化向量：IP ≠ COSINE（幅度影响结果）

### 3. 度量方式影响排序
同一个查询，不同度量方式可能返回完全不同的Top-K结果。

### 4. 性能差异
- **IP** 最快（只需乘法和加法）
- **COSINE** 次之（需要额外计算范数）
- **L2** 最慢（需要平方和开方）

### 5. 索引兼容性
不是所有索引都支持所有度量方式，需要查阅文档。

---

## 学习检查清单

完成本知识点学习后，你应该能够：

- [ ] 解释三种度量方式的数学原理
- [ ] 手写实现三种度量算法
- [ ] 根据Embedding模型选择度量方式
- [ ] 理解归一化对度量选择的影响
- [ ] 在Milvus中正确配置度量参数
- [ ] 解释度量方式对检索结果的影响
- [ ] 对比三种度量的性能差异
- [ ] 在RAG项目中应用合适的度量方式
- [ ] 调试度量选择错误导致的问题
- [ ] 回答相关面试问题

---

## 常见问题

### Q1: 为什么OpenAI推荐使用COSINE？
**A:** OpenAI的Embedding模型输出是归一化的向量，COSINE度量在语义搜索中更直观，且与人类对"相似"的理解一致。

### Q2: 可以在同一个Collection中混用不同度量吗？
**A:** 不可以。度量方式在创建索引时指定，一个Collection只能使用一种度量方式。

### Q3: 切换度量方式需要重建索引吗？
**A:** 是的。度量方式是索引的一部分，切换度量需要删除旧索引并重建。

### Q4: 为什么我的检索结果不准确？
**A:** 最常见的原因是度量方式选择错误。检查：
1. Embedding模型是否归一化
2. 度量方式是否与模型匹配
3. 搜索时的metric_type是否与索引一致

---

**开始学习：** [01_30字核心.md](./01_30字核心.md)
