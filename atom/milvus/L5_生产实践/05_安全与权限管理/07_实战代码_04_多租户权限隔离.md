# 实战代码4：多租户权限隔离

**完整的多租户权限隔离实现，确保不同租户的数据完全隔离。**

---

## 场景说明

**目标：** 实现 SaaS RAG 系统的多租户权限隔离：
- 每个租户独立的数据空间
- 基于 Collection 的物理隔离
- 自动权限管理
- 租户生命周期管理

**适用场景：**
- SaaS 知识库服务
- 多客户 RAG 平台
- 企业多部门系统

---

## 完整代码

```python
"""
多租户权限隔离实现
演示：SaaS RAG 系统的完整租户隔离方案
"""

import os
import logging
from typing import List, Dict, Optional
from datetime import datetime
from pymilvus import connections, utility, Collection, FieldSchema, CollectionSchema, DataType
from dotenv import load_dotenv

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


# ===== 1. 租户管理器 =====

class TenantManager:
    """租户管理器"""

    def __init__(self):
        self.logger = logging.getLogger("TenantManager")
        load_dotenv()

        connections.connect(
            alias="default",
            host=os.getenv("MILVUS_HOST", "localhost"),
            port=os.getenv("MILVUS_PORT", "19530"),
            user=os.getenv("MILVUS_ADMIN_USER", "root"),
            password=os.getenv("MILVUS_ADMIN_PASSWORD")
        )
        self.logger.info("✅ 管理员连接成功")

    def create_tenant(self, tenant_id: str, admin_user: str) -> bool:
        """创建租户"""
        try:
            self.logger.info(f"=== 创建租户 {tenant_id} ===")

            # 1. 创建租户专属 Collection
            collection_name = f"tenant_{tenant_id}_docs"
            if not self._create_tenant_collection(collection_name):
                return False

            # 2. 创建租户角色
            role_name = f"tenant_{tenant_id}_role"
            utility.create_role(role_name)

            # 3. 授予权限（只能访问自己的 Collection）
            privileges = ["Search", "Query", "Insert", "Delete", "Upsert", "Load", "Release"]
            for privilege in privileges:
                utility.grant_privilege(
                    role_name=role_name,
                    object_type="Collection",
                    privilege=privilege,
                    object_name=collection_name
                )

            # 4. 创建管理员用户并绑定角色
            utility.create_user(admin_user, self._generate_password())
            utility.add_user_to_role(admin_user, role_name)

            self.logger.info(f"✅ 租户 {tenant_id} 创建成功")
            return True

        except Exception as e:
            self.logger.error(f"❌ 创建租户失败：{e}")
            return False

    def delete_tenant(self, tenant_id: str) -> bool:
        """删除租户"""
        try:
            collection_name = f"tenant_{tenant_id}_docs"
            role_name = f"tenant_{tenant_id}_role"

            # 删除 Collection
            if collection_name in utility.list_collections():
                utility.drop_collection(collection_name)

            # 删除角色
            utility.drop_role(role_name)

            self.logger.info(f"✅ 租户 {tenant_id} 已删除")
            return True

        except Exception as e:
            self.logger.error(f"❌ 删除租户失败：{e}")
            return False

    def add_tenant_user(self, tenant_id: str, username: str) -> bool:
        """添加租户用户"""
        try:
            role_name = f"tenant_{tenant_id}_role"

            # 创建用户
            utility.create_user(username, self._generate_password())

            # 绑定到租户角色
            utility.add_user_to_role(username, role_name)

            self.logger.info(f"✅ 用户 {username} 已加入租户 {tenant_id}")
            return True

        except Exception as e:
            self.logger.error(f"❌ 添加用户失败：{e}")
            return False

    def _create_tenant_collection(self, collection_name: str) -> bool:
        """创建租户 Collection"""
        try:
            if collection_name in utility.list_collections():
                self.logger.warning(f"Collection {collection_name} 已存在")
                return True

            # 定义 Schema
            fields = [
                FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
                FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768),
                FieldSchema(name="text", dtype=DataType.VARCHAR, max_length=2000),
                FieldSchema(name="metadata", dtype=DataType.JSON)
            ]
            schema = CollectionSchema(fields, description=f"Tenant collection: {collection_name}")

            # 创建 Collection
            collection = Collection(collection_name, schema)

            # 创建索引
            index_params = {
                "metric_type": "L2",
                "index_type": "IVF_FLAT",
                "params": {"nlist": 128}
            }
            collection.create_index("embedding", index_params)

            self.logger.info(f"✅ Collection {collection_name} 已创建")
            return True

        except Exception as e:
            self.logger.error(f"❌ 创建 Collection 失败：{e}")
            return False

    def _generate_password(self) -> str:
        """生成随机密码"""
        import secrets
        import string
        chars = string.ascii_letters + string.digits + "!@#$%^&*()"
        return ''.join(secrets.choice(chars) for _ in range(16))


# ===== 2. 租户隔离验证器 =====

class TenantIsolationValidator:
    """租户隔离验证器"""

    def __init__(self):
        self.logger = logging.getLogger("TenantIsolationValidator")

    def validate_isolation(self, tenant_a_user: str, tenant_a_pass: str,
                          tenant_b_collection: str) -> bool:
        """验证租户隔离"""
        self.logger.info("\n=== 验证租户隔离 ===")

        try:
            # 租户A用户尝试访问租户B的 Collection
            connections.connect(
                alias="tenant_a",
                host="localhost",
                port="19530",
                user=tenant_a_user,
                password=tenant_a_pass
            )

            # 尝试访问租户B的数据
            collection = Collection(tenant_b_collection)
            collection.load()

            self.logger.error("❌ 隔离失败：租户A可以访问租户B的数据")
            return False

        except Exception as e:
            self.logger.info(f"✅ 隔离成功：{e}")
            return True


# ===== 3. SaaS RAG 系统 =====

class SaaSRAGSystem:
    """SaaS RAG 系统"""

    def __init__(self, tenant_id: str, user: str, password: str):
        self.tenant_id = tenant_id
        self.collection_name = f"tenant_{tenant_id}_docs"
        self.logger = logging.getLogger(f"SaaSRAG-{tenant_id}")

        # 连接到 Milvus
        connections.connect(
            alias=f"tenant_{tenant_id}",
            host=os.getenv("MILVUS_HOST", "localhost"),
            port=os.getenv("MILVUS_PORT", "19530"),
            user=user,
            password=password
        )
        self.logger.info(f"✅ 租户 {tenant_id} 连接成功")

    def insert_documents(self, texts: List[str], embeddings: List[List[float]]):
        """插入文档"""
        try:
            collection = Collection(self.collection_name)

            # 准备数据
            data = [
                embeddings,
                texts,
                [{"source": "api"} for _ in texts]
            ]

            # 插入
            collection.insert(data)
            collection.flush()

            self.logger.info(f"✅ 插入 {len(texts)} 条文档")

        except Exception as e:
            self.logger.error(f"❌ 插入失败：{e}")

    def search(self, query_embedding: List[float], limit: int = 10):
        """搜索文档"""
        try:
            collection = Collection(self.collection_name)
            collection.load()

            results = collection.search(
                data=[query_embedding],
                anns_field="embedding",
                param={"metric_type": "L2", "params": {"nprobe": 10}},
                limit=limit,
                output_fields=["text", "metadata"]
            )

            self.logger.info(f"✅ 搜索完成，返回 {len(results[0])} 条结果")
            return results[0]

        except Exception as e:
            self.logger.error(f"❌ 搜索失败：{e}")
            return []


# ===== 4. 主程序 =====

def main():
    """主程序"""
    print("=" * 60)
    print("多租户权限隔离示例")
    print("=" * 60)

    # 创建租户管理器
    tenant_mgr = TenantManager()

    # 场景1：创建两个租户
    print("\n【场景1：创建租户】")
    tenant_mgr.create_tenant("company_a", "admin_a")
    tenant_mgr.create_tenant("company_b", "admin_b")

    # 场景2：添加租户用户
    print("\n【场景2：添加用户】")
    tenant_mgr.add_tenant_user("company_a", "user_a1")
    tenant_mgr.add_tenant_user("company_b", "user_b1")

    # 场景3：验证隔离
    print("\n【场景3：验证隔离】")
    validator = TenantIsolationValidator()
    # validator.validate_isolation("user_a1", "password", "tenant_company_b_docs")

    print("\n" + "=" * 60)
    print("多租户配置完成")
    print("=" * 60)


if __name__ == "__main__":
    main()
```

---

## 运行输出示例

```
============================================================
多租户权限隔离示例
============================================================

【场景1：创建租户】
=== 创建租户 company_a ===
2025-02-10 13:00:00 - TenantManager - INFO - ✅ Collection tenant_company_a_docs 已创建
2025-02-10 13:00:01 - TenantManager - INFO - ✅ 租户 company_a 创建成功

=== 创建租户 company_b ===
2025-02-10 13:00:02 - TenantManager - INFO - ✅ 租户 company_b 创建成功

【场景2：添加用户】
2025-02-10 13:00:03 - TenantManager - INFO - ✅ 用户 user_a1 已加入租户 company_a
2025-02-10 13:00:04 - TenantManager - INFO - ✅ 用户 user_b1 已加入租户 company_b

【场景3：验证隔离】
=== 验证租户隔离 ===
2025-02-10 13:00:05 - TenantIsolationValidator - INFO - ✅ 隔离成功：permission denied

============================================================
多租户配置完成
============================================================
```

---

## 关键特性

### 1. 物理隔离

```python
# 每个租户独立的 Collection
tenant_a: tenant_company_a_docs
tenant_b: tenant_company_b_docs
```

### 2. 自动权限管理

```python
# 创建租户时自动配置权限
tenant_mgr.create_tenant("company_a", "admin_a")
# 自动创建角色、授权、绑定用户
```

### 3. 隔离验证

```python
# 验证租户A无法访问租户B的数据
validator.validate_isolation("user_a", "pass", "tenant_b_docs")
```

---

## 小结

**本示例展示了：**

1. ✅ 完整的租户管理系统
2. ✅ 基于 Collection 的物理隔离
3. ✅ 自动权限配置
4. ✅ 租户隔离验证
5. ✅ SaaS RAG 系统集成

**下一步：** 学习审计日志的实战代码
