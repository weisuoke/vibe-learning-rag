# 实战代码

本知识点的实战代码分为多个场景文件，每个场景提供完整的可运行代码和详细说明。

## 📚 场景列表

### 场景1：Helm快速部署（开发环境）
**文件：** [01_Helm快速部署_开发环境.md](./07_实战代码/01_Helm快速部署_开发环境.md)

**目标：** 在开发环境快速部署Milvus集群

**特点：**
- 单机模式或最小集群配置
- 不启用持久化（快速重建）
- 使用内置依赖
- 资源配置较低

**包含内容：**
- 完整部署脚本（Bash）
- 配置文件（YAML）
- Python验证脚本
- 常用运维操作
- 故障排查指南

**学习时间：** 30分钟

---

### 场景2：生产部署（高可用配置）
**文件：** [02_生产部署_高可用配置.md](./07_实战代码/02_生产部署_高可用配置.md)

**目标：** 在生产环境部署高可用Milvus集群

**特点：**
- 集群模式，多副本部署
- 启用持久化存储
- 使用外部依赖（etcd、S3、Pulsar）
- 配置Pod反亲和性
- 配置监控和备份

**包含内容：**
- 外部依赖部署脚本
- 生产级配置文件
- 高可用验证脚本
- 监控配置（Prometheus + Grafana）
- 备份策略和脚本

**学习时间：** 60分钟

---

### 场景3：Operator自动化部署
**文件：** [03_Operator自动化部署.md](./07_实战代码/03_Operator自动化部署.md)

**目标：** 使用Milvus Operator实现自动化运维

**特点：**
- 使用CRD声明式配置
- Operator自动配置最佳实践
- 自动故障恢复
- 简化的配置接口

**包含内容：**
- Operator安装脚本
- 基础和生产级集群配置
- 外部依赖配置
- Operator运维操作（扩缩容、升级、配置修改）
- Python验证脚本
- Operator高级功能（自动备份、监控、HPA）

**学习时间：** 45分钟

---

### 场景4：HPA自动扩缩容
**文件：** [04_HPA自动扩缩容.md](./07_实战代码/04_HPA自动扩缩容.md)

**目标：** 配置HPA实现基于负载的自动扩缩容

**特点：**
- 根据CPU/内存自动调整副本数
- 配置扩缩容策略
- 支持自定义指标
- 模拟流量测试

**包含内容：**
- 基于CPU的HPA配置
- 基于内存的HPA配置
- 多指标HPA配置
- Python压测工具
- 实时监控脚本
- 扩缩容场景测试（逐步增加负载、突发流量、周期性波动）
- 验证和分析脚本
- 优化建议

**学习时间：** 60分钟

---

## 学习路径

### 快速入门路径（1小时）
```
场景1：Helm快速部署（开发环境）
    ↓
实践：部署并验证
```

### 生产就绪路径（3小时）
```
场景1：开发环境 → 场景2：生产部署 → 场景4：HPA扩缩容
    ↓                  ↓                  ↓
  快速验证          高可用配置         自动扩缩容
```

### 完整学习路径（5小时）
```
场景1 → 场景2 → 场景3 → 场景4
  ↓       ↓       ↓       ↓
开发    生产    Operator  HPA
```

---

## 场景对比

| 场景 | 复杂度 | 适用环境 | 高可用 | 自动化 | 学习时间 |
|------|--------|---------|--------|--------|---------|
| **场景1** | 低 | 开发/测试 | ❌ | ❌ | 30分钟 |
| **场景2** | 高 | 生产 | ✅ | ❌ | 60分钟 |
| **场景3** | 中 | 生产 | ✅ | ✅ | 45分钟 |
| **场景4** | 中 | 生产 | ✅ | ✅ | 60分钟 |

---

## 技术栈

### 部署工具
- **Helm** - Kubernetes包管理器
- **Milvus Operator** - 自动化运维工具
- **kubectl** - Kubernetes命令行工具

### 编程语言
- **Bash** - 部署脚本
- **Python** - 验证和压测脚本
- **YAML** - 配置文件

### 依赖服务
- **etcd** - 元数据存储
- **MinIO/S3** - 对象存储
- **Pulsar/Kafka** - 消息队列
- **Prometheus** - 监控
- **Grafana** - 可视化

---

## 环境要求

### 最低配置（场景1）
- **Kubernetes集群**: 1个Master + 2个Worker
- **每个节点**: 2核CPU、8GB内存
- **存储**: 不需要持久化存储

### 推荐配置（场景2-4）
- **Kubernetes集群**: 1个Master + 3个Worker
- **每个节点**: 8核CPU、32GB内存
- **存储**: SSD存储类，至少500GB

### 云环境推荐
- **AWS**: EKS + EC2 (m5.2xlarge)
- **GCP**: GKE + n1-standard-8
- **Azure**: AKS + Standard_D8s_v3

---

## 使用说明

### 1. 准备环境

```bash
# 检查kubectl
kubectl version

# 检查Helm
helm version

# 检查集群连接
kubectl cluster-info
```

### 2. 选择场景

根据你的需求选择合适的场景：
- **学习Kubernetes部署** → 场景1
- **生产环境部署** → 场景2
- **需要自动化运维** → 场景3
- **需要自动扩缩容** → 场景4

### 3. 按步骤执行

每个场景文件都包含：
1. 场景描述和目标
2. 完整的配置文件
3. 部署脚本
4. 验证脚本
5. 运维操作
6. 故障排查

### 4. 验证部署

每个场景都提供Python验证脚本，确保部署成功。

---

## 常见问题

### Q1: 我应该从哪个场景开始？

**推荐顺序：**
1. **初学者**：场景1（开发环境）
2. **有经验**：场景2（生产部署）
3. **需要自动化**：场景3（Operator）
4. **需要弹性**：场景4（HPA）

### Q2: 场景之间有依赖关系吗？

**没有强依赖！** 每个场景都是独立的，可以单独学习。

**建议顺序：**
- 场景1 → 场景2：从简单到复杂
- 场景2 → 场景3：从手动到自动
- 场景3 → 场景4：增加弹性能力

### Q3: 代码可以直接运行吗？

**可以！** 所有代码都经过测试，可以直接运行。

**注意事项：**
- 替换配置中的占位符（如IP地址、密钥）
- 确保Kubernetes集群资源充足
- 检查网络连接和镜像拉取

### Q4: 如何在生产环境使用这些代码？

**建议步骤：**
1. 在开发环境测试（场景1）
2. 在测试环境验证（场景2）
3. 根据实际需求调整配置
4. 在生产环境部署
5. 配置监控和告警
6. 定期备份和演练

---

## 代码规范

### Bash脚本
- 使用 `set -e`（遇到错误立即退出）
- 添加详细的echo输出
- 检查前置条件
- 提供清理脚本

### Python脚本
- 使用类型提示
- 添加详细注释
- 异常处理
- 输出清晰的日志

### YAML配置
- 添加注释说明
- 合理的缩进
- 使用有意义的名称
- 包含资源限制

---

## 扩展学习

完成实战代码后，可以继续学习：

### 监控和告警
- Prometheus配置
- Grafana Dashboard
- 告警规则设置

### 安全加固
- RBAC权限控制
- Network Policy
- Pod Security Policy

### 性能优化
- 资源调优
- 网络优化
- 存储优化

### CI/CD集成
- GitOps工作流
- ArgoCD部署
- 自动化测试

---

## 获取帮助

### 问题排查
1. 查看Pod日志：`kubectl logs <pod-name>`
2. 查看Pod事件：`kubectl describe pod <pod-name>`
3. 查看HPA状态：`kubectl get hpa`
4. 查看资源使用：`kubectl top pods`

### 参考资源
- Kubernetes官方文档
- Helm官方文档
- Milvus官方文档
- Milvus Operator GitHub

---

**开始实践：** [01_Helm快速部署_开发环境.md](./07_实战代码/01_Helm快速部署_开发环境.md)
