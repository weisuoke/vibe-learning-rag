# docker-composeç¼–æ’ - å®æˆ˜ä»£ç ï¼šå¤šç¯å¢ƒé…ç½®

## æ¦‚è¿°

æœ¬æ–‡æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ docker-compose ç®¡ç†å¤šç¯å¢ƒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰ï¼Œå®ç°ç¯å¢ƒéš”ç¦»å’Œé…ç½®å¤ç”¨ã€‚

**ç›®æ ‡ï¼š**
- åŸºç¡€é…ç½® + ç¯å¢ƒè¦†ç›–
- ä½¿ç”¨ profiles æ¡ä»¶å¯åŠ¨
- ç¯å¢ƒå˜é‡ç®¡ç†
- å®Œæ•´å¯è¿è¡Œ

---

## 1. é¡¹ç›®ç»“æ„

```
multi-env/
â”œâ”€â”€ docker-compose.yml          # åŸºç¡€é…ç½®ï¼ˆæ‰€æœ‰ç¯å¢ƒé€šç”¨ï¼‰
â”œâ”€â”€ docker-compose.dev.yml      # å¼€å‘ç¯å¢ƒè¦†ç›–
â”œâ”€â”€ docker-compose.test.yml     # æµ‹è¯•ç¯å¢ƒè¦†ç›–
â”œâ”€â”€ docker-compose.prod.yml     # ç”Ÿäº§ç¯å¢ƒè¦†ç›–
â”œâ”€â”€ Dockerfile                  # API é•œåƒæ„å»º
â”œâ”€â”€ Dockerfile.prod             # ç”Ÿäº§ç¯å¢ƒé•œåƒ
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .env.dev                    # å¼€å‘ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.test                   # æµ‹è¯•ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.prod                   # ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼ˆä¸æäº¤ï¼‰
â”œâ”€â”€ .gitignore                 # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ app/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ main.py                # FastAPI åº”ç”¨
```

---

## 2. åŸºç¡€é…ç½®

### 2.1 docker-compose.ymlï¼ˆåŸºç¡€é…ç½®ï¼‰

```yaml
version: '3.8'

services:
  # FastAPI åº”ç”¨
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - APP_ENV=${APP_ENV:-development}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - app-network

  # PostgreSQL æ•°æ®åº“
  db:
    image: postgres:14-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - app-network

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - app-network

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

---

## 3. å¼€å‘ç¯å¢ƒé…ç½®

### 3.1 docker-compose.dev.yml

```yaml
version: '3.8'

services:
  # APIï¼šå¼€å‘ç¯å¢ƒé…ç½®
  api:
    container_name: dev-api
    volumes:
      - .:/app:delegated  # ä»£ç çƒ­é‡è½½
      - /app/.venv        # æ’é™¤è™šæ‹Ÿç¯å¢ƒ
    command: uvicorn app.main:app --host 0.0.0.0 --reload
    environment:
      - DEBUG=true
      - LOG_LEVEL=debug
    restart: "no"  # å¼€å‘ç¯å¢ƒä¸è‡ªåŠ¨é‡å¯

  # æ•°æ®åº“ï¼šå¼€å‘ç¯å¢ƒé…ç½®
  db:
    container_name: dev-db
    ports:
      - "5432:5432"  # æš´éœ²ç«¯å£ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
    restart: unless-stopped

  # Redisï¼šå¼€å‘ç¯å¢ƒé…ç½®
  redis:
    container_name: dev-redis
    ports:
      - "6379:6379"  # æš´éœ²ç«¯å£
    restart: unless-stopped

  # pgAdminï¼šåªåœ¨å¼€å‘ç¯å¢ƒå¯åŠ¨
  pgadmin:
    image: dpage/pgadmin4
    container_name: dev-pgadmin
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@example.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db
    networks:
      - app-network
    restart: unless-stopped

volumes:
  pgadmin_data:
```

### 3.2 .env.dev

```bash
# åº”ç”¨é…ç½®
APP_ENV=development
API_PORT=8000
DEBUG=true
LOG_LEVEL=debug

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:pass@db:5432/agent_dev
POSTGRES_USER=user
POSTGRES_PASSWORD=pass
POSTGRES_DB=agent_dev

# Redis é…ç½®
REDIS_URL=redis://redis:6379

# pgAdmin é…ç½®
PGADMIN_EMAIL=admin@example.com
PGADMIN_PASSWORD=admin
```

### 3.3 å¯åŠ¨å¼€å‘ç¯å¢ƒ

```bash
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡
cp .env.dev .env

# 2. å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# æˆ–è€…åå°è¿è¡Œ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f

# 4. åœæ­¢
docker-compose -f docker-compose.yml -f docker-compose.dev.yml down
```

---

## 4. æµ‹è¯•ç¯å¢ƒé…ç½®

### 4.1 docker-compose.test.yml

```yaml
version: '3.8'

services:
  # APIï¼šæµ‹è¯•ç¯å¢ƒé…ç½®
  api:
    container_name: test-api
    command: pytest
    environment:
      - DEBUG=false
      - LOG_LEVEL=info
    restart: on-failure

  # æ•°æ®åº“ï¼šæµ‹è¯•ç¯å¢ƒé…ç½®
  db:
    container_name: test-db
    # ä¸æš´éœ²ç«¯å£ï¼ˆå®‰å…¨ï¼‰
    restart: on-failure

  # Redisï¼šæµ‹è¯•ç¯å¢ƒé…ç½®
  redis:
    container_name: test-redis
    # ä¸æš´éœ²ç«¯å£
    restart: on-failure

  # æµ‹è¯•è¿è¡Œå™¨ï¼šåªåœ¨æµ‹è¯•ç¯å¢ƒå¯åŠ¨
  test-runner:
    build: .
    container_name: test-runner
    command: pytest --cov=app --cov-report=html
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - DEBUG=false
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - .:/app
      - ./htmlcov:/app/htmlcov
    networks:
      - app-network
```

### 4.2 .env.test

```bash
# åº”ç”¨é…ç½®
APP_ENV=test
API_PORT=8000
DEBUG=false
LOG_LEVEL=info

# æµ‹è¯•æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://test:test@db:5432/agent_test
POSTGRES_USER=test
POSTGRES_PASSWORD=test
POSTGRES_DB=agent_test

# Redis é…ç½®
REDIS_URL=redis://redis:6379
```

### 4.3 å¯åŠ¨æµ‹è¯•ç¯å¢ƒ

```bash
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡
cp .env.test .env

# 2. å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.test.yml up

# 3. è¿è¡Œæµ‹è¯•
docker-compose -f docker-compose.yml -f docker-compose.test.yml run test-runner

# 4. åœæ­¢å¹¶æ¸…ç†
docker-compose -f docker-compose.yml -f docker-compose.test.yml down -v
```

---

## 5. ç”Ÿäº§ç¯å¢ƒé…ç½®

### 5.1 docker-compose.prod.yml

```yaml
version: '3.8'

services:
  # APIï¼šç”Ÿäº§ç¯å¢ƒé…ç½®
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod
    image: my-api:${APP_VERSION:-latest}
    container_name: prod-api
    command: uvicorn app.main:app --host 0.0.0.0 --workers 4
    environment:
      - DEBUG=false
      - LOG_LEVEL=warning
    # ä¸æŒ‚è½½ä»£ç ï¼ˆä½¿ç”¨é•œåƒå†…çš„ä»£ç ï¼‰
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        compress: "true"

  # æ•°æ®åº“ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®
  db:
    container_name: prod-db
    # ä¸æš´éœ²ç«¯å£ï¼ˆå®‰å…¨ï¼‰
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Redisï¼šç”Ÿäº§ç¯å¢ƒé…ç½®
  redis:
    container_name: prod-redis
    # ä¸æš´éœ²ç«¯å£
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # Nginxï¼šåªåœ¨ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
  nginx:
    image: nginx:alpine
    container_name: prod-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    networks:
      - app-network
    restart: always

  # Prometheusï¼šç›‘æ§
  prometheus:
    image: prom/prometheus
    container_name: prod-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - app-network
    restart: always

volumes:
  prometheus_data:
```

### 5.2 Dockerfile.prod

```dockerfile
FROM python:3.13-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY app/ ./app/

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--workers", "4"]
```

### 5.3 .env.prod

```bash
# åº”ç”¨é…ç½®
APP_ENV=production
APP_VERSION=v1.0.0
API_PORT=8000
DEBUG=false
LOG_LEVEL=warning

# ç”Ÿäº§æ•°æ®åº“é…ç½®ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Œä¸æäº¤åˆ° Gitï¼‰
DATABASE_URL=postgresql://prod_user:prod_pass@db:5432/agent_prod
POSTGRES_USER=prod_user
POSTGRES_PASSWORD=prod_pass
POSTGRES_DB=agent_prod

# Redis é…ç½®
REDIS_URL=redis://redis:6379
```

### 5.4 å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡
cp .env.prod .env

# 2. æ„å»ºç”Ÿäº§é•œåƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

# 3. å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 4. æŸ¥çœ‹çŠ¶æ€
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# 6. åœæ­¢
docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
```

---

## 6. ä½¿ç”¨ profiles çš„æ›¿ä»£æ–¹æ¡ˆ

### 6.1 å•æ–‡ä»¶ + profiles

```yaml
version: '3.8'

services:
  # æ ¸å¿ƒæœåŠ¡ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
  api:
    build: .
    profiles: ["dev", "test", "prod"]

  db:
    image: postgres:14-alpine
    profiles: ["dev", "test", "prod"]

  redis:
    image: redis:7-alpine
    profiles: ["dev", "test", "prod"]

  # å¼€å‘å·¥å…·ï¼ˆåªåœ¨å¼€å‘ç¯å¢ƒï¼‰
  pgadmin:
    image: dpage/pgadmin4
    profiles: ["dev"]
    ports:
      - "5050:80"

  # æµ‹è¯•å·¥å…·ï¼ˆåªåœ¨æµ‹è¯•ç¯å¢ƒï¼‰
  test-runner:
    build: .
    profiles: ["test"]
    command: pytest

  # ç”Ÿäº§å·¥å…·ï¼ˆåªåœ¨ç”Ÿäº§ç¯å¢ƒï¼‰
  nginx:
    image: nginx:alpine
    profiles: ["prod"]
    ports:
      - "80:80"
```

**ä½¿ç”¨ï¼š**
```bash
# å¼€å‘ç¯å¢ƒ
docker-compose --profile dev up

# æµ‹è¯•ç¯å¢ƒ
docker-compose --profile test up

# ç”Ÿäº§ç¯å¢ƒ
docker-compose --profile prod up -d
```

---

## 7. ç¯å¢ƒåˆ‡æ¢è„šæœ¬

### 7.1 start.sh

```bash
#!/bin/bash

# ç¯å¢ƒåˆ‡æ¢è„šæœ¬

ENV=${1:-dev}

case $ENV in
  dev)
    echo "ğŸš€ Starting development environment..."
    cp .env.dev .env
    docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
    ;;
  test)
    echo "ğŸ§ª Starting test environment..."
    cp .env.test .env
    docker-compose -f docker-compose.yml -f docker-compose.test.yml up
    ;;
  prod)
    echo "ğŸ­ Starting production environment..."
    cp .env.prod .env
    docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
    ;;
  *)
    echo "Usage: ./start.sh [dev|test|prod]"
    exit 1
    ;;
esac
```

**ä½¿ç”¨ï¼š**
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x start.sh

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
./start.sh dev

# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
./start.sh test

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
./start.sh prod
```

### 7.2 stop.sh

```bash
#!/bin/bash

# åœæ­¢è„šæœ¬

ENV=${1:-dev}

case $ENV in
  dev)
    echo "ğŸ›‘ Stopping development environment..."
    docker-compose -f docker-compose.yml -f docker-compose.dev.yml down
    ;;
  test)
    echo "ğŸ›‘ Stopping test environment..."
    docker-compose -f docker-compose.yml -f docker-compose.test.yml down -v
    ;;
  prod)
    echo "ğŸ›‘ Stopping production environment..."
    docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
    ;;
  *)
    echo "Usage: ./stop.sh [dev|test|prod]"
    exit 1
    ;;
esac
```

---

## 8. ç¯å¢ƒå¯¹æ¯”

### 8.1 é…ç½®å¯¹æ¯”è¡¨

| ç‰¹æ€§ | å¼€å‘ç¯å¢ƒ | æµ‹è¯•ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|---------|
| **ä»£ç æŒ‚è½½** | âœ… çƒ­é‡è½½ | âœ… æµ‹è¯•ç”¨ | âŒ ä½¿ç”¨é•œåƒ |
| **ç«¯å£æš´éœ²** | âœ… å…¨éƒ¨æš´éœ² | âŒ ä¸æš´éœ² | âŒ åªæš´éœ² Nginx |
| **è°ƒè¯•æ¨¡å¼** | âœ… DEBUG=true | âŒ DEBUG=false | âŒ DEBUG=false |
| **æ—¥å¿—çº§åˆ«** | debug | info | warning |
| **é‡å¯ç­–ç•¥** | no | on-failure | always |
| **èµ„æºé™åˆ¶** | âŒ æ— é™åˆ¶ | âš ï¸ é€‚åº¦é™åˆ¶ | âœ… ä¸¥æ ¼é™åˆ¶ |
| **å¼€å‘å·¥å…·** | pgAdmin | test-runner | Nginx + ç›‘æ§ |
| **æ•°æ®æŒä¹…åŒ–** | âœ… å‘½åå· | âŒ ä¸´æ—¶ | âœ… å‘½åå· |

### 8.2 å¯åŠ¨å‘½ä»¤å¯¹æ¯”

```bash
# å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# æµ‹è¯•ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.test.yml up

# ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ç¯å¢ƒå˜é‡ç®¡ç†

```bash
# âœ… æ¨èï¼šæ¯ä¸ªç¯å¢ƒç‹¬ç«‹çš„ .env æ–‡ä»¶
.env.dev
.env.test
.env.prod

# âœ… æ¨èï¼šæä¾›æ¨¡æ¿æ–‡ä»¶
.env.example

# âœ… æ¨èï¼šä¸æäº¤æ•æ„Ÿä¿¡æ¯
# .gitignore
.env
.env.local
.env.*.local
.env.prod
```

### 9.2 é…ç½®å¤ç”¨

```yaml
# âœ… æ¨èï¼šåŸºç¡€é…ç½® + ç¯å¢ƒè¦†ç›–
docker-compose.yml          # åŸºç¡€é…ç½®
docker-compose.dev.yml      # å¼€å‘ç¯å¢ƒè¦†ç›–
docker-compose.prod.yml     # ç”Ÿäº§ç¯å¢ƒè¦†ç›–

# âŒ ä¸æ¨èï¼šæ¯ä¸ªç¯å¢ƒç‹¬ç«‹é…ç½®
docker-compose.dev.yml      # å®Œæ•´é…ç½®ï¼ˆé‡å¤ï¼‰
docker-compose.prod.yml     # å®Œæ•´é…ç½®ï¼ˆé‡å¤ï¼‰
```

### 9.3 å®‰å…¨é…ç½®

```yaml
# âœ… æ¨èï¼šç”Ÿäº§ç¯å¢ƒä¸æš´éœ²ç«¯å£
services:
  db:
    # ä¸è®¾ç½® ports

# âŒ ä¸æ¨èï¼šç”Ÿäº§ç¯å¢ƒæš´éœ²ç«¯å£
services:
  db:
    ports:
      - "5432:5432"  # å®‰å…¨é£é™©
```

### 9.4 èµ„æºé™åˆ¶

```yaml
# âœ… æ¨èï¼šç”Ÿäº§ç¯å¢ƒé™åˆ¶èµ„æº
services:
  api:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

# âŒ ä¸æ¨èï¼šç”Ÿäº§ç¯å¢ƒä¸é™åˆ¶èµ„æº
services:
  api:
    # æ²¡æœ‰èµ„æºé™åˆ¶
```

---

## 10. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¿«é€Ÿåˆ‡æ¢ç¯å¢ƒï¼Ÿ

**A:** ä½¿ç”¨è„šæœ¬æˆ–åˆ«å

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨è„šæœ¬
./start.sh dev
./start.sh prod

# æ–¹æ³•2ï¼šä½¿ç”¨åˆ«å
alias dc-dev='docker-compose -f docker-compose.yml -f docker-compose.dev.yml'
alias dc-prod='docker-compose -f docker-compose.yml -f docker-compose.prod.yml'

# ä½¿ç”¨
dc-dev up
dc-prod up -d
```

### Q2: å¦‚ä½•é¿å…ç¯å¢ƒå˜é‡å†²çªï¼Ÿ

**A:** ä½¿ç”¨ç¯å¢ƒå‰ç¼€

```bash
# .env.dev
DEV_DATABASE_URL=postgresql://...

# .env.prod
PROD_DATABASE_URL=postgresql://...

# docker-compose.yml
environment:
  - DATABASE_URL=${DEV_DATABASE_URL}  # å¼€å‘ç¯å¢ƒ
  - DATABASE_URL=${PROD_DATABASE_URL}  # ç”Ÿäº§ç¯å¢ƒ
```

### Q3: å¦‚ä½•åœ¨ CI/CD ä¸­ä½¿ç”¨ï¼Ÿ

**A:** ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥

```yaml
# GitHub Actions
- name: Deploy
  env:
    DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
  run: |
    echo "DATABASE_PASSWORD=$DATABASE_PASSWORD" >> .env
    docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### Q4: å¦‚ä½•éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ

**A:** ä½¿ç”¨ config å‘½ä»¤

```bash
# æŸ¥çœ‹åˆå¹¶åçš„é…ç½®
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config

# éªŒè¯é…ç½®
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config --quiet
```

### Q5: å¦‚ä½•å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼Ÿ

**A:** ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†

```bash
# ä»å¤–éƒ¨å¯†é’¥ç®¡ç†ç³»ç»Ÿè¯»å–
export DATABASE_PASSWORD=$(aws secretsmanager get-secret-value --secret-id db-password --query SecretString --output text)

# å¯åŠ¨
docker-compose up
```

---

## 11. å®Œæ•´ç¤ºä¾‹

### 11.1 app/main.py

```python
"""
å¤šç¯å¢ƒé…ç½®ç¤ºä¾‹
"""

from fastapi import FastAPI
import os

app = FastAPI()

# è¯»å–ç¯å¢ƒé…ç½®
APP_ENV = os.getenv("APP_ENV", "development")
DEBUG = os.getenv("DEBUG", "false").lower() == "true"
LOG_LEVEL = os.getenv("LOG_LEVEL", "info")

@app.get("/")
async def root():
    return {
        "message": "Multi-Environment Configuration",
        "environment": APP_ENV,
        "debug": DEBUG,
        "log_level": LOG_LEVEL
    }

@app.get("/health")
async def health():
    return {
        "status": "healthy",
        "environment": APP_ENV
    }
```

### 11.2 æµ‹è¯•ä¸åŒç¯å¢ƒ

```bash
# 1. å¯åŠ¨å¼€å‘ç¯å¢ƒ
./start.sh dev
curl http://localhost:8000/

# è¾“å‡º
{
  "message": "Multi-Environment Configuration",
  "environment": "development",
  "debug": true,
  "log_level": "debug"
}

# 2. å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
./start.sh prod
curl http://localhost:8000/

# è¾“å‡º
{
  "message": "Multi-Environment Configuration",
  "environment": "production",
  "debug": false,
  "log_level": "warning"
}
```

---

## 12. å­¦ä¹ è¦ç‚¹

### 12.1 æ ¸å¿ƒæ¦‚å¿µ

1. **åŸºç¡€é…ç½® + ç¯å¢ƒè¦†ç›–**ï¼šå¤ç”¨åŸºç¡€é…ç½®ï¼Œç¯å¢ƒç‰¹å®šé…ç½®è¦†ç›–
2. **ç¯å¢ƒå˜é‡ç®¡ç†**ï¼šæ¯ä¸ªç¯å¢ƒç‹¬ç«‹çš„ .env æ–‡ä»¶
3. **profiles**ï¼šæ¡ä»¶å¯åŠ¨æœåŠ¡
4. **é…ç½®éªŒè¯**ï¼šä½¿ç”¨ config å‘½ä»¤éªŒè¯

### 12.2 æœ€ä½³å®è·µ

1. âœ… åŸºç¡€é…ç½® + ç¯å¢ƒè¦†ç›–
2. âœ… æ¯ä¸ªç¯å¢ƒç‹¬ç«‹çš„ .env æ–‡ä»¶
3. âœ… æä¾› .env.example æ¨¡æ¿
4. âœ… ä¸æäº¤æ•æ„Ÿä¿¡æ¯åˆ° Git
5. âœ… ä½¿ç”¨è„šæœ¬ç®€åŒ–ç¯å¢ƒåˆ‡æ¢

### 12.3 å¸¸è§é”™è¯¯

1. âŒ æ¯ä¸ªç¯å¢ƒå®Œæ•´é…ç½®ï¼ˆé‡å¤ï¼‰
2. âŒ æ‰€æœ‰ç¯å¢ƒç”¨åŒä¸€ä¸ª .env æ–‡ä»¶
3. âŒ æäº¤ .env.prod åˆ° Git
4. âŒ ç”Ÿäº§ç¯å¢ƒæš´éœ²ä¸å¿…è¦çš„ç«¯å£
5. âŒ ç”Ÿäº§ç¯å¢ƒä¸é™åˆ¶èµ„æº

---

## 13. æ€»ç»“

**å¤šç¯å¢ƒé…ç½®çš„æ ¸å¿ƒï¼š**
1. **åŸºç¡€é…ç½®**ï¼šdocker-compose.ymlï¼ˆæ‰€æœ‰ç¯å¢ƒé€šç”¨ï¼‰
2. **ç¯å¢ƒè¦†ç›–**ï¼šdocker-compose.{env}.ymlï¼ˆç¯å¢ƒç‰¹å®šï¼‰
3. **ç¯å¢ƒå˜é‡**ï¼š.env.{env}ï¼ˆç¯å¢ƒé…ç½®ï¼‰
4. **å¯åŠ¨å‘½ä»¤**ï¼š`-f` å‚æ•°ç»„åˆå¤šä¸ªæ–‡ä»¶

**é€‚ç”¨åœºæ™¯ï¼š**
- å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- å›¢é˜Ÿåä½œ
- CI/CD é›†æˆ

**ä¸‹ä¸€æ­¥ï¼š**
- å­¦ä¹ ç”Ÿäº§çº§é…ç½®ï¼ˆç›‘æ§ã€æ—¥å¿—ã€å®‰å…¨ï¼‰
- å­¦ä¹  Kubernetes éƒ¨ç½²

---

**ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-02-12
**é¢„è®¡å­¦ä¹ æ—¶é—´ï¼š** 1-2 å°æ—¶
