# 化骨绵掌

> 10个2分钟知识卡片，快速掌握相似度度量

---

## 卡片1：度量的本质

**一句话：** 相似度度量是把两个向量映射到一个数字的函数，用于量化"相似程度"。

**举例：**
```python
# 度量函数的本质
f(x, y) → 数字

# L2距离
f([1,2], [3,4]) → 2.83  # 距离

# 内积IP
f([1,2], [3,4]) → 11  # 投影

# 余弦相似度
f([1,2], [3,4]) → 0.98  # 角度
```

**应用：** 在Milvus中，度量函数决定了检索结果的排序依据。

---

## 卡片2：L2距离的直觉

**一句话：** L2距离就是两点之间的直线距离，越小越相似。

**举例：**
```python
# 2D平面上的距离
A = (1, 2)
B = (4, 6)

# 勾股定理
L2 = √[(4-1)² + (6-2)²] = √[9 + 16] = 5
```

**应用：** 适合未归一化向量，如Word2Vec、图像特征等。

---

## 卡片3：内积IP的直觉

**一句话：** 内积测量两个向量的"投影长度"，同时考虑方向和幅度。

**举例：**
```python
# 物理意义：力在位移方向上的投影
力 = [3, 4]  # 力的大小和方向
位移 = [1, 0]  # 沿x轴移动

做功 = 力·位移 = 3×1 + 4×0 = 3
```

**应用：** 推荐系统中，IP能同时考虑匹配度和热度。

---

## 卡片4：余弦相似度的直觉

**一句话：** 余弦相似度只看方向，完全忽略向量长度。

**举例：**
```python
# 两个向量
x = [1, 0]
y = [100, 0]  # y是x的100倍

# 余弦相似度
COSINE(x, y) = 1.0  # 方向完全一致

# L2距离
L2(x, y) = 99  # 距离很大
```

**应用：** 语义搜索中，只关注语义方向，不关注向量长度。

---

## 卡片5：归一化的魔法

**一句话：** 归一化后，内积IP = 余弦相似度COSINE。

**举例：**
```python
# 归一化向量（长度=1）
x_norm = [0.6, 0.8]  # ‖x‖ = 1
y_norm = [0.8, 0.6]  # ‖y‖ = 1

# 内积
IP = 0.6×0.8 + 0.8×0.6 = 0.96

# 余弦相似度
COSINE = IP / (1×1) = 0.96

# 结论：IP = COSINE（当归一化时）
```

**应用：** 性能优化技巧：归一化 + IP = 最快的COSINE。

---

## 卡片6：度量选择的决策树

**一句话：** 选择度量方式 = 选择如何定义"相似"。

**举例：**
```
向量是否归一化？
├─ 是 → COSINE或IP
└─ 否 → 根据场景
    ├─ 语义搜索 → COSINE
    ├─ 推荐系统 → IP
    └─ 物理距离 → L2
```

**应用：** OpenAI Embedding（归一化）→ COSINE，推荐系统 → IP。

---

## 卡片7：三种度量的值域

**一句话：** 不同度量的值域和相似性方向不同。

**举例：**
| 度量 | 值域 | 相似性 | 完全相同 | 完全相反 |
|------|------|--------|---------|---------|
| L2 | [0, +∞) | 越小越相似 | 0 | +∞ |
| IP | (-∞, +∞) | 越大越相似 | 最大值 | 负值 |
| COSINE | [-1, 1] | 越大越相似 | 1 | -1 |

**应用：** 设置相似度阈值时，需要根据度量方式调整。

---

## 卡片8：Milvus配置要点

**一句话：** 索引和搜索必须使用相同的度量方式。

**举例：**
```python
# 创建索引
index_params = {
    "metric_type": "COSINE",  # 指定度量
    ...
}
collection.create_index(...)

# 搜索时必须一致
search_params = {
    "metric_type": "COSINE",  # 必须相同！
    ...
}
collection.search(...)
```

**应用：** 度量不一致会导致错误或结果不准确。

---

## 卡片9：常见误区

**一句话：** 度量方式不能随时切换，切换需要重建索引。

**举例：**
```python
# ❌ 错误：想切换度量
# 不能直接修改search_params的metric_type

# ✅ 正确：重建索引
collection.drop_index()
collection.create_index(new_index_params)
```

**应用：** 在开发阶段确定度量方式，避免生产环境频繁切换。

---

## 卡片10：性能对比

**一句话：** IP最快，COSINE次之，L2最慢。

**举例：**
```python
# 计算复杂度
IP: O(n)        # 只需乘法和加法
COSINE: O(n)    # 需要额外计算范数
L2: O(n)        # 需要平方、求和、开方

# 实际性能（相对）
IP: 1.0x
COSINE: 1.1-1.2x
L2: 1.2-1.5x
```

**应用：** 归一化向量用IP代替COSINE，性能提升10-20%。

---

## 知识卡片总结

### 核心概念卡片（1-5）
1. **度量本质**：函数映射
2. **L2直觉**：直线距离
3. **IP直觉**：投影长度
4. **COSINE直觉**：纯方向
5. **归一化魔法**：IP = COSINE

### 实践应用卡片（6-10）
6. **选择决策**：决策树
7. **值域理解**：阈值设置
8. **Milvus配置**：一致性
9. **常见误区**：不可切换
10. **性能对比**：IP最快

---

## 快速复习

### 2分钟速记

**三种度量：**
- L2 = 距离（越小越相似）
- IP = 投影（越大越相似）
- COSINE = 角度（越大越相似）

**选择原则：**
- 归一化 → COSINE/IP
- 语义搜索 → COSINE
- 推荐系统 → IP
- 物理距离 → L2

**关键技巧：**
- 归一化 + IP = 最快的COSINE
- 索引和搜索度量必须一致
- 切换度量需要重建索引

---

## 学习检查

完成10个卡片学习后，你应该能够：

- [ ] 解释三种度量的本质区别
- [ ] 根据场景选择合适的度量
- [ ] 理解归一化对度量的影响
- [ ] 在Milvus中正确配置度量
- [ ] 避免常见的度量误区
- [ ] 优化度量相关的性能

---

**恭喜！** 你已经掌握了相似度度量的核心知识。

**记住：** 度量方式是向量检索的灵魂，选对度量，事半功倍！
