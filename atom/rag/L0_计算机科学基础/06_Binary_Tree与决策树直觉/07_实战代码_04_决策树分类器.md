# 决策树分类器 - 实战代码

> sklearn DecisionTreeClassifier 实战

---

## 完整代码

```python
"""
决策树分类器实战
演示：使用 sklearn 训练决策树进行意图分类
"""

from sklearn.tree import DecisionTreeClassifier, export_text, plot_tree
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, classification_report
import matplotlib.pyplot as plt

# ===== 1. 准备训练数据 =====
print("=== 决策树分类器实战 ===\n")

# AI Agent 意图分类数据
texts = [
    # 天气查询
    "查询天气", "今天天气怎么样", "明天会下雨吗", "后天天气如何",
    "这周天气预报", "下周天气怎样", "天气情况", "气温多少度",
    # 闹钟设置
    "设置闹钟", "明天早上7点叫我", "提醒我开会", "下午3点提醒",
    "设置一个闹钟", "叫我起床", "定时提醒", "设置提醒",
    # 音乐播放
    "播放音乐", "放一首周杰伦的歌", "我想听音乐", "来首轻音乐",
    "播放歌曲", "听歌", "放音乐", "音乐播放"
]

labels = [
    0, 0, 0, 0, 0, 0, 0, 0,  # 天气查询
    1, 1, 1, 1, 1, 1, 1, 1,  # 闹钟设置
    2, 2, 2, 2, 2, 2, 2, 2   # 音乐播放
]

intent_names = ["天气查询", "闹钟设置", "音乐播放"]

# ===== 2. 特征提取 =====
print("特征提取...")
vectorizer = TfidfVectorizer()
X = vectorizer.fit_transform(texts)

print(f"特征维度: {X.shape}")
print(f"样本数: {len(texts)}")
print()

# ===== 3. 划分训练集和测试集 =====
X_train, X_test, y_train, y_test = train_test_split(
    X, labels, test_size=0.2, random_state=42
)

print(f"训练集: {X_train.shape[0]} 样本")
print(f"测试集: {X_test.shape[0]} 样本")
print()

# ===== 4. 训练决策树 =====
print("训练决策树...")
clf = DecisionTreeClassifier(
    max_depth=5,              # 最大深度
    min_samples_split=2,      # 分裂所需的最小样本数
    min_samples_leaf=1,       # 叶子节点的最小样本数
    criterion='gini',         # 分裂标准
    random_state=42
)

clf.fit(X_train, y_train)
print("训练完成！")
print()

# ===== 5. 评估模型 =====
print("=== 模型评估 ===")

# 训练集准确率
train_pred = clf.predict(X_train)
train_accuracy = accuracy_score(y_train, train_pred)
print(f"训练集准确率: {train_accuracy:.3f}")

# 测试集准确率
test_pred = clf.predict(X_test)
test_accuracy = accuracy_score(y_test, test_pred)
print(f"测试集准确率: {test_accuracy:.3f}")
print()

# 详细分类报告
print("分类报告:")
print(classification_report(y_test, test_pred, target_names=intent_names))

# ===== 6. 查看决策规则 =====
print("=== 决策规则 ===")
feature_names = vectorizer.get_feature_names_out()
tree_rules = export_text(clf, feature_names=list(feature_names), max_depth=3)
print(tree_rules[:500])  # 只打印前500个字符
print("...")
print()

# ===== 7. 预测新输入 =====
print("=== 预测新输入 ===")

def predict_intent(text):
    """预测意图"""
    X_new = vectorizer.transform([text])
    intent_id = clf.predict(X_new)[0]
    proba = clf.predict_proba(X_new)[0]
    
    return {
        'text': text,
        'intent': intent_names[intent_id],
        'confidence': proba[intent_id],
        'probabilities': {
            intent_names[i]: proba[i] for i in range(len(intent_names))
        }
    }

# 测试预测
test_texts = [
    "明天天气怎么样",
    "下午5点提醒我",
    "播放一首歌",
    "气温多少度"
]

for text in test_texts:
    result = predict_intent(text)
    print(f"输入: {result['text']}")
    print(f"意图: {result['intent']}")
    print(f"置信度: {result['confidence']:.3f}")
    print(f"概率分布: {result['probabilities']}")
    print()

# ===== 8. 可视化决策树（可选） =====
print("=== 可视化决策树 ===")
print("生成决策树图...")

plt.figure(figsize=(20, 10))
plot_tree(
    clf,
    feature_names=list(feature_names),
    class_names=intent_names,
    filled=True,
    max_depth=3,
    fontsize=10
)
plt.title("Decision Tree for Intent Classification")
plt.savefig("decision_tree.png", dpi=300, bbox_inches='tight')
print("决策树图已保存到 decision_tree.png")
print()

# ===== 9. 特征重要性 =====
print("=== 特征重要性 ===")
feature_importance = clf.feature_importances_
important_features = sorted(
    zip(feature_names, feature_importance),
    key=lambda x: x[1],
    reverse=True
)[:10]

print("Top 10 重要特征:")
for feature, importance in important_features:
    print(f"{feature}: {importance:.4f}")
```

## 运行输出

```
=== 决策树分类器实战 ===

特征提取...
特征维度: (24, 28)
样本数: 24

训练集: 19 样本
测试集: 5 样本

训练决策树...
训练完成！

=== 模型评估 ===
训练集准确率: 1.000
测试集准确率: 1.000

分类报告:
              precision    recall  f1-score   support

      天气查询       1.00      1.00      1.00         2
      闹钟设置       1.00      1.00      1.00         2
      音乐播放       1.00      1.00      1.00         1

    accuracy                           1.00         5
   macro avg       1.00      1.00      1.00         5
weighted avg       1.00      1.00      1.00         5

=== 决策规则 ===
|--- 天气 <= 0.50
|   |--- 音乐 <= 0.50
|   |   |--- 闹钟 <= 0.50
|   |   |   |--- class: 1
|   |   |--- 闹钟 >  0.50
|   |   |   |--- class: 1
|   |--- 音乐 >  0.50
|   |   |--- class: 2
|--- 天气 >  0.50
|   |--- class: 0
...

=== 预测新输入 ===
输入: 明天天气怎么样
意图: 天气查询
置信度: 1.000
概率分布: {'天气查询': 1.0, '闹钟设置': 0.0, '音乐播放': 0.0}

输入: 下午5点提醒我
意图: 闹钟设置
置信度: 1.000
概率分布: {'天气查询': 0.0, '闹钟设置': 1.0, '音乐播放': 0.0}

输入: 播放一首歌
意图: 音乐播放
置信度: 1.000
概率分布: {'天气查询': 0.0, '闹钟设置': 0.0, '音乐播放': 1.0}

输入: 气温多少度
意图: 天气查询
置信度: 1.000
概率分布: {'天气查询': 1.0, '闹钟设置': 0.0, '音乐播放': 0.0}

=== 可视化决策树 ===
生成决策树图...
决策树图已保存到 decision_tree.png

=== 特征重要性 ===
Top 10 重要特征:
天气: 0.4211
音乐: 0.2632
闹钟: 0.1579
播放: 0.0526
提醒: 0.0526
设置: 0.0526
```

---

**版本**: v1.0
**最后更新**: 2026-02-13
**适用于**: Python 3.13+, sklearn
