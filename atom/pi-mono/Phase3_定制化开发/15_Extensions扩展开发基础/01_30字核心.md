# Extensions 扩展开发基础 - 30字核心

**Extensions 是 pi-mono 的 TypeScript 插件系统，通过 ExtensionAPI 注册工具、命令、事件监听器，实现功能扩展和定制化。**

---

## 核心定义

Extensions 扩展开发基础是 pi-mono 提供的插件化扩展机制，允许开发者通过编写 TypeScript 模块来扩展 pi coding agent 的功能。

### 三个关键要素

1. **TypeScript 模块**：扩展以 `.ts` 文件形式存在，导出默认函数
2. **ExtensionAPI**：统一的 API 接口，提供注册和事件监听能力
3. **热重载**：通过 `/reload` 命令实现无需重启的扩展更新

---

## 为什么是 30 字？

这 30 字浓缩了 Extensions 的本质：

- **Extensions**：明确了是什么（扩展系统）
- **TypeScript 插件系统**：说明了技术栈和架构模式
- **ExtensionAPI**：指出了核心接口
- **注册工具、命令、事件监听器**：列举了三大核心能力
- **功能扩展和定制化**：阐明了价值和目标

---

## 与其他定制化方式的对比

| 定制化方式 | 复杂度 | 能力 | 适用场景 |
|-----------|--------|------|---------|
| **Prompt Templates** | 低 | 提示词复用 | 简单的提示词定制 |
| **Skills** | 中 | 功能封装 | 可复用的功能模块 |
| **Extensions** | 高 | 完全控制 | 深度定制、系统级功能 |

Extensions 是 pi-mono 最强大的定制化方式，提供了对 Agent 运行时的完全控制能力。

---

## 核心价值

### 1. 功能扩展

通过 Extensions 可以：
- 注册自定义工具（registerTool）
- 添加斜杠命令（registerCommand）
- 定制 UI 组件（setWidget, setFooter, setHeader）
- 集成外部服务（自定义 Provider）

### 2. 行为定制

通过事件监听可以：
- 拦截和修改工具调用（tool_call 事件）
- 控制会话生命周期（session_start, session_switch）
- 转换用户输入（input 事件）
- 自定义消息渲染（registerMessageRenderer）

### 3. 无缝集成

- **热重载**：`/reload` 命令即时生效，无需重启
- **类型安全**：完整的 TypeScript 类型定义
- **自动发现**：放在 `~/.pi/agent/extensions/` 或 `.pi/extensions/` 自动加载
- **依赖管理**：支持 npm 包和本地模块

---

## 快速理解

### TypeScript/Node.js 类比

```typescript
// Extensions 就像 Express 中间件
app.use((req, res, next) => {
  // 拦截请求，添加功能
  console.log(req.method, req.url);
  next();
});

// pi Extensions
export default function (pi: ExtensionAPI) {
  pi.on("tool_call", async (event, ctx) => {
    // 拦截工具调用，添加功能
    console.log(event.toolName, event.input);
  });
}
```

### 日常生活类比

Extensions 就像**浏览器扩展**：
- 浏览器提供扩展 API（chrome.tabs, chrome.storage）
- pi-mono 提供 ExtensionAPI（registerTool, on）
- 扩展可以修改浏览器行为
- Extensions 可以修改 Agent 行为
- 都支持热重载和自动更新

---

## 最小示例

```typescript
/**
 * hello.ts - 最简单的 Extension
 */
import { Type } from "@sinclair/typebox";
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  // 注册一个自定义工具
  pi.registerTool({
    name: "hello",
    label: "Hello",
    description: "A simple greeting tool",
    parameters: Type.Object({
      name: Type.String({ description: "Name to greet" }),
    }),

    async execute(_toolCallId, params, _signal, _onUpdate, _ctx) {
      const { name } = params as { name: string };
      return {
        content: [{ type: "text", text: `Hello, ${name}!` }],
        details: { greeted: name },
      };
    },
  });
}
```

**使用方式：**
```bash
# 1. 保存为 ~/.pi/agent/extensions/hello.ts
# 2. 启动 pi（自动加载）
pi

# 3. 或显式加载
pi --extension hello.ts

# 4. Agent 现在可以使用 hello 工具
> Ask the agent to greet "World"
```

---

## 核心概念速览

### 1. Extension 模块结构

```typescript
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

// 默认导出函数，接收 ExtensionAPI
export default function (pi: ExtensionAPI) {
  // 注册功能
  pi.registerTool({ ... });
  pi.registerCommand("cmd", { ... });

  // 监听事件
  pi.on("tool_call", async (event, ctx) => { ... });
  pi.on("session_start", async (event, ctx) => { ... });
}
```

### 2. ExtensionAPI 核心方法

| 方法 | 用途 | 示例 |
|------|------|------|
| `registerTool()` | 注册自定义工具 | 添加新的 Agent 能力 |
| `registerCommand()` | 注册斜杠命令 | 添加 `/todos` 命令 |
| `registerShortcut()` | 注册快捷键 | 绑定 Ctrl+T |
| `on()` / `off()` | 事件监听 | 拦截工具调用 |
| `getCommands()` | 获取命令列表 | 查询可用命令 |

### 3. 事件系统

Extensions 可以监听 30+ 事件类型：

```typescript
// 会话事件
pi.on("session_start", async (event, ctx) => { ... });
pi.on("session_switch", async (event, ctx) => { ... });
pi.on("session_fork", async (event, ctx) => { ... });

// 工具事件
pi.on("tool_call", async (event, ctx) => {
  // 可以阻止工具调用
  if (dangerous) return { block: true, reason: "Blocked" };
});

// 用户事件
pi.on("input", async (event, ctx) => {
  // 可以转换用户输入
  return { transform: modifiedInput };
});
```

---

## 实际应用场景

### 1. 安全防护

```typescript
// 拦截危险命令
pi.on("tool_call", async (event, ctx) => {
  if (event.toolName === "bash" && event.input.command?.includes("rm -rf")) {
    const ok = await ctx.ui.confirm("Dangerous!", "Allow rm -rf?");
    if (!ok) return { block: true, reason: "Blocked by user" };
  }
});
```

### 2. 工具增强

```typescript
// 添加自定义工具
pi.registerTool({
  name: "todo",
  description: "Manage todos",
  parameters: Type.Object({
    action: StringEnum(["list", "add", "toggle"] as const),
    text: Type.Optional(Type.String()),
  }),
  async execute(toolCallId, params, signal, onUpdate, ctx) {
    // 实现 todo 管理逻辑
    return { content: [...], details: { todos } };
  },
});
```

### 3. UI 定制

```typescript
// 自定义 footer
pi.on("agent_turn_start", async (event, ctx) => {
  ctx.ui.setFooter(() => {
    return `Turn ${event.turnNumber} | Model: ${event.model}`;
  });
});
```

### 4. Git 集成

```typescript
// 自动创建 checkpoint
pi.on("session_fork", async (event, ctx) => {
  await ctx.exec("git stash push -m 'checkpoint before fork'");
});
```

---

## 加载方式

### 1. 自动发现

```bash
# 全局扩展目录
~/.pi/agent/extensions/
  ├── hello.ts
  ├── todo.ts
  └── safety.ts

# 项目扩展目录
.pi/extensions/
  ├── project-specific.ts
  └── team-tools.ts
```

### 2. 显式加载

```bash
# 命令行参数
pi --extension ./my-extension.ts

# 多个扩展
pi --extension ext1.ts --extension ext2.ts
```

### 3. 热重载

```bash
# 在 pi 会话中
/reload

# 重新加载所有扩展，无需重启
```

---

## 开发工作流

```bash
# 1. 创建扩展文件
touch ~/.pi/agent/extensions/my-extension.ts

# 2. 编写扩展代码
# (使用 VS Code 等编辑器，有完整类型提示)

# 3. 启动 pi（自动加载）
pi

# 4. 测试扩展功能
# (在 pi 会话中测试)

# 5. 修改代码后热重载
/reload

# 6. 继续测试
```

---

## 与 Skills 的区别

| 特性 | Skills | Extensions |
|------|--------|-----------|
| **语言** | Markdown | TypeScript |
| **能力** | 提示词封装 | 完全编程控制 |
| **调用方式** | `/skill:name` | 自动集成 |
| **状态管理** | 无 | 完整支持 |
| **事件监听** | 无 | 30+ 事件 |
| **UI 定制** | 无 | 完全支持 |
| **适用场景** | 简单功能封装 | 复杂系统集成 |

**选择建议：**
- 简单的提示词复用 → Prompt Templates
- 可复用的功能模块 → Skills
- 需要编程控制和状态管理 → Extensions

---

## 学习路径

1. **基础理解**（本文档）
   - 理解 Extensions 的概念和价值
   - 掌握最小示例的结构

2. **核心概念**（后续文档）
   - TypeScript 扩展基础
   - 事件监听与响应
   - 工具与命令注册
   - UI 定制与交互
   - Provider 与模型管理
   - 扩展加载与热重载
   - 扩展开发模式

3. **实战代码**（后续文档）
   - 安全防护扩展
   - 工具增强扩展
   - 命令与快捷键扩展
   - UI 定制扩展
   - 会话管理扩展
   - Git 集成扩展
   - Provider 定制扩展
   - 完整扩展实战

---

## 参考资源

- **官方文档**: https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent/docs/extensions.md
- **示例代码**: https://github.com/badlogic/pi-mono/tree/main/packages/coding-agent/examples/extensions
- **类型定义**: `@mariozechner/pi-coding-agent` 包中的 TypeScript 类型
- **社区扩展**: https://github.com/qualisero/awesome-pi-agent

---

**版本**: v1.0
**最后更新**: 2026-02-20
**适用于**: pi-mono 2025-2026 版本
