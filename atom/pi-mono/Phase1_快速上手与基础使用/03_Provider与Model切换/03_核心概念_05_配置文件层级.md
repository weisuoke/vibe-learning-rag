# 核心概念 05：配置文件层级

> **理解配置优先级，实现灵活的多环境管理**

---

## 配置文件概览

Pi 使用分层配置系统，支持全局、项目、CLI 三个层级。

### 配置文件列表

| 文件 | 位置 | 作用域 | 优先级 |
|------|------|--------|--------|
| **models.json** | `~/.pi/agent/` | 全局模型定义 | 低 |
| **auth.json** | `~/.pi/agent/` | 全局认证信息 | 低 |
| **settings.json** | `~/.pi/agent/` | 全局用户设置 | 低 |
| **models.json** | `.pi/` | 项目模型定义 | 中 |
| **settings.json** | `.pi/` | 项目用户设置 | 中 |
| **CLI 参数** | 命令行 | 启动时指定 | 高 |
| **运行时命令** | `/model` 等 | 会话内切换 | 最高 |

---

## 全局配置

### 位置

```bash
~/.pi/agent/
├── models.json      # 模型定义
├── auth.json        # API 密钥
└── settings.json    # 用户设置
```

### models.json（全局模型定义）

**作用**：定义所有可用的 Provider 和模型

```json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "baseUrl": "https://api.anthropic.com",
      "models": {
        "claude-3-5-sonnet-20241022": {
          "id": "claude-3-5-sonnet-20241022",
          "name": "Claude 3.5 Sonnet",
          "contextWindow": 200000,
          "maxOutput": 8192,
          "cost": { "input": 3.0, "output": 15.0 }
        }
      }
    }
  }
}
```

### auth.json（全局认证）

**作用**：存储 API 密钥

```json
{
  "anthropic": {
    "apiKey": "sk-ant-api03-..."
  },
  "openai": {
    "apiKey": "sk-proj-..."
  }
}
```

**安全要求**：
- 文件权限必须是 `0600`（仅所有者可读写）
- 不要提交到版本控制
- 使用 `.gitignore` 排除

```bash
# 设置正确权限
chmod 600 ~/.pi/agent/auth.json
```

### settings.json（全局设置）

**作用**：用户偏好设置

```json
{
  "defaultModel": "claude-3-5-haiku-20241022",
  "scopedModels": [
    "claude-3-5-haiku-20241022",
    "claude-3-5-sonnet-20241022",
    "claude-opus-4-20250514"
  ],
  "maxTokens": 4096,
  "temperature": 0.7
}
```

---

## 项目配置

### 位置

```bash
project-root/
└── .pi/
    ├── models.json      # 项目特定模型（可选）
    ├── settings.json    # 项目特定设置
    ├── SYSTEM.md        # 系统提示词
    └── AGENTS.md        # 自定义 Agent
```

### .pi/models.json（项目模型）

**作用**：覆盖或扩展全局模型定义

```json
{
  "providers": {
    "ollama": {
      "apiType": "openai-compatible",
      "baseUrl": "http://localhost:11434",
      "models": {
        "llama3.1:8b": {
          "id": "llama3.1:8b",
          "name": "Llama 3.1 8B (Local)",
          "contextWindow": 131072,
          "maxOutput": 32768,
          "cost": { "input": 0.0, "output": 0.0 }
        }
      }
    }
  }
}
```

**使用场景**：
- 添加项目特定的本地模型
- 覆盖全局 Provider 的 baseUrl（如使用代理）
- 定义项目专用的模型配置

### .pi/settings.json（项目设置）

**作用**：项目特定的用户设置

```json
{
  "defaultModel": "llama3.1:8b",
  "scopedModels": [
    "llama3.1:8b",
    "claude-3-5-haiku-20241022",
    "claude-3-5-sonnet-20241022"
  ]
}
```

**使用场景**：
- 前端项目：优先使用多模态模型（gpt-4o）
- 后端项目：优先使用代码模型（claude-sonnet）
- 本地开发：优先使用本地模型（ollama）

---

## 配置优先级

### 优先级顺序

```
1. 运行时命令 (/model, /provider)
2. CLI 参数 (--model, --provider)
3. 项目配置 (.pi/settings.json)
4. 全局配置 (~/.pi/agent/settings.json)
5. 环境变量 (ANTHROPIC_MODEL)
6. 默认值
```

### 优先级示例

**场景 1：全局 vs 项目**

```bash
# 全局配置
~/.pi/agent/settings.json:
{
  "defaultModel": "claude-3-5-haiku-20241022"
}

# 项目配置
.pi/settings.json:
{
  "defaultModel": "claude-3-5-sonnet-20241022"
}

# 启动 Pi
pi

# 实际使用：claude-3-5-sonnet-20241022（项目配置优先）
```

**场景 2：项目 vs CLI**

```bash
# 项目配置
.pi/settings.json:
{
  "defaultModel": "claude-3-5-sonnet-20241022"
}

# CLI 参数
pi --model claude-opus-4-20250514

# 实际使用：claude-opus-4-20250514（CLI 参数优先）
```

**场景 3：CLI vs 运行时**

```bash
# CLI 参数
pi --model claude-3-5-sonnet-20241022

# 运行时切换
> /model
# 选择 claude-opus-4-20250514

# 实际使用：claude-opus-4-20250514（运行时命令优先）
```

---

## 配置合并策略

### 深度合并

项目配置会与全局配置深度合并，而非完全覆盖。

**示例**：

```json
// 全局配置：~/.pi/agent/models.json
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "models": {
        "claude-3-5-sonnet-20241022": { ... }
      }
    }
  }
}

// 项目配置：.pi/models.json
{
  "providers": {
    "ollama": {
      "apiType": "openai-compatible",
      "models": {
        "llama3.1:8b": { ... }
      }
    }
  }
}

// 合并结果
{
  "providers": {
    "anthropic": { ... },  // 保留全局配置
    "ollama": { ... }      // 添加项目配置
  }
}
```

### 覆盖规则

**完全覆盖**：

```json
// 全局配置
{
  "providers": {
    "anthropic": {
      "baseUrl": "https://api.anthropic.com"
    }
  }
}

// 项目配置（覆盖 baseUrl）
{
  "providers": {
    "anthropic": {
      "baseUrl": "https://corporate-proxy.com/anthropic"
    }
  }
}

// 结果：使用项目配置的 baseUrl
```

---

## 环境变量

### 支持的环境变量

```bash
# Provider API Keys
export ANTHROPIC_API_KEY="sk-ant-api03-..."
export OPENAI_API_KEY="sk-proj-..."
export XAI_API_KEY="xai-..."
export GOOGLE_API_KEY="AIza..."

# 默认模型
export ANTHROPIC_MODEL="claude-3-5-sonnet-20241022"
export OPENAI_MODEL="gpt-4o"

# 自定义端点
export ANTHROPIC_BASE_URL="https://your-proxy.com"
export OPENAI_BASE_URL="https://your-proxy.com"
```

### 优先级

环境变量优先级低于配置文件：

```
配置文件 > 环境变量 > 默认值
```

---

## 实战场景

### 场景 1：多项目管理

```bash
# 项目 A：前端开发
project-a/.pi/settings.json:
{
  "defaultModel": "gpt-4o",
  "scopedModels": ["gpt-4o", "claude-3-5-sonnet-20241022"]
}

# 项目 B：后端开发
project-b/.pi/settings.json:
{
  "defaultModel": "claude-3-5-sonnet-20241022",
  "scopedModels": ["claude-3-5-haiku-20241022", "claude-3-5-sonnet-20241022"]
}

# 项目 C：本地开发
project-c/.pi/settings.json:
{
  "defaultModel": "llama3.1:8b",
  "scopedModels": ["llama3.1:8b", "claude-3-5-haiku-20241022"]
}
```

### 场景 2：企业代理

```bash
# 全局配置：使用企业代理
~/.pi/agent/models.json:
{
  "providers": {
    "anthropic": {
      "baseUrl": "https://corporate-proxy.com/anthropic",
      "headers": {
        "X-Corporate-Auth": "${CORPORATE_TOKEN}"
      }
    }
  }
}

# 项目配置：开发环境直连
.pi/models.json:
{
  "providers": {
    "anthropic": {
      "baseUrl": "https://api.anthropic.com"
    }
  }
}
```

### 场景 3：成本控制

```bash
# 全局配置：默认使用便宜模型
~/.pi/agent/settings.json:
{
  "defaultModel": "claude-3-5-haiku-20241022"
}

# 重要项目：使用高质量模型
important-project/.pi/settings.json:
{
  "defaultModel": "claude-3-5-sonnet-20241022"
}
```

---

## 配置文件模板

### 最小配置

```bash
# 创建最小配置
mkdir -p ~/.pi/agent

cat > ~/.pi/agent/auth.json <<EOF
{
  "anthropic": {
    "apiKey": "$ANTHROPIC_API_KEY"
  }
}
EOF

chmod 600 ~/.pi/agent/auth.json
```

### 完整配置

```bash
# 创建完整配置
mkdir -p ~/.pi/agent

# models.json
cat > ~/.pi/agent/models.json <<EOF
{
  "providers": {
    "anthropic": {
      "apiType": "anthropic-messages",
      "models": {
        "claude-3-5-sonnet-20241022": {
          "id": "claude-3-5-sonnet-20241022",
          "name": "Claude 3.5 Sonnet",
          "contextWindow": 200000,
          "cost": { "input": 3.0, "output": 15.0 }
        }
      }
    }
  }
}
EOF

# auth.json
cat > ~/.pi/agent/auth.json <<EOF
{
  "anthropic": {
    "apiKey": "$ANTHROPIC_API_KEY"
  }
}
EOF

chmod 600 ~/.pi/agent/auth.json

# settings.json
cat > ~/.pi/agent/settings.json <<EOF
{
  "defaultModel": "claude-3-5-haiku-20241022",
  "scopedModels": [
    "claude-3-5-haiku-20241022",
    "claude-3-5-sonnet-20241022",
    "claude-opus-4-20250514"
  ]
}
EOF
```

---

## 常见问题

### Q1: 如何查看当前使用的配置？

**答**：使用 `/session` 命令查看当前模型和 Provider。

### Q2: 项目配置会覆盖全局配置吗？

**答**：部分覆盖。相同字段会覆盖，不同字段会合并。

### Q3: 如何临时使用不同配置？

**答**：使用 CLI 参数或运行时命令，不会修改配置文件。

### Q4: auth.json 可以放在项目目录吗？

**答**：不推荐。API 密钥应该全局管理，避免泄露到版本控制。

---

## 下一步

- **成本优化策略**：阅读 [03_核心概念_06_成本优化策略.md](./03_核心概念_06_成本优化策略.md)
- **实战配置**：阅读 [07_实战代码_01_基础Provider配置.md](./07_实战代码_01_基础Provider配置.md)

---

**记住**：配置分层是为了灵活性，理解优先级顺序能让你在不同场景下游刃有余。
